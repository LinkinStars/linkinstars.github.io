<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[Golang Mutex åˆ°åº•æ˜¯å¦åº”è¯¥ä½¿ç”¨æŒ‡é’ˆ]]></title>
    <url>%2F2020%2F07%2F18%2Fgolang%2Fbasic%2Fmutex-use-point-or-not%2F</url>
    <content type="text"><![CDATA[åœ¨å†™ go çš„æ—¶å€™ï¼Œä½ ä½¿ç”¨ Mutex çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯æŒ‡é’ˆè¿˜æ˜¯è¯´æ²¡æœ‰ä½¿ç”¨æŒ‡é’ˆï¼Œè¿˜æ˜¯éšæ„æ¥ï¼Ÿ å‰ä¸¤å¤©æˆ‘æ”¶åˆ°äº†ä¸‹é¢è¿™æ ·çš„ä¸€ä¸ª PRï¼Œæˆ‘çªç„¶å°±æƒ³åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼ŒäºŽæ˜¯å°±æœ‰äº†è¿™ç¯‡åšå®¢ã€‚ æˆ‘ä¸€å¼€å§‹çš„æƒ³æ³•å…¶å®žæˆ‘ä¸€å¼€å§‹çš„æƒ³æ³•å¾ˆç®€å•ï¼Œå› ä¸ºæˆ‘ä¸€ç›´æ²¡æœ‰ä½¿ç”¨æŒ‡é’ˆ åœ¨æˆ‘çš„æŸäº›å°è±¡ä¸­æˆ‘æ›¾ç»è®°å¾—ï¼Œä½¿ç”¨é”ä¸ç”³æ˜Žä¸ºæŒ‡é’ˆæ˜¯ä¸€ä¸ªä»£ç è§„èŒƒç±»ä¼¼çš„ä¸œè¥¿ å¤§å¤šæ•°çš„ï¼ˆæˆ‘çœ‹è¿‡çš„ä¸€äº›ï¼‰æºç ä¸­ï¼Œæ²¡æœ‰è§è¿‡å°†é”ç”³æ˜Žä¸ºæŒ‡é’ˆçš„ç”¨æ³• ä½†æ˜¯å½“æ—¶æˆ‘æ²¡æœ‰åŠžæ³•å›žç­”è¿™ä¸ª PRï¼Œä½ æ€»ä¸èƒ½è¯´æˆ‘æ˜¯ä¸€åŽ¢æƒ…æ„¿å§â€¦éœ€è¦ä¸€ä¸ªæ›´åŠ åˆç†çš„è§£é‡Š ä»”ç»†åˆ†æžä¸Šç½‘æœç´¢ä¸€ç•ªhttps://www.reddit.com/r/golang/comments/6uyf16/confusion_about_mutex_and_reference/ å¾ˆå¤šç±»ä¼¼çš„é—®é¢˜éƒ½åœ¨é—®ï¼ˆä½ ä¸ç”¨ç‚¹å¼€ï¼Œåªæ˜¯ä¸¾ä¸ªä¾‹å­ï¼‰ é—®é¢˜å…³é”®sync.Mutex è¿™ä¸ªä¸œè¥¿ä¸èƒ½è¢« copyï¼ï¼ˆè¿™ä¸ªæˆ‘ä¹‹å‰ä¹Ÿæ˜¯çŸ¥é“çš„ï¼Œæ¯•ç«Ÿéƒ½åˆ†æžè¿‡æºç äº†ï¼‰ åˆ¨æ ¹é—®åº•è™½ç„¶è¿™ä¸ªé”ä¸èƒ½è¢«æ‹·è´ï¼Œé‚£ä¹ˆå°±åº”è¯¥è¢«ç”³æ˜Žä¸ºæŒ‡é’ˆé˜²æ­¢æ‹·è´å‡ºçŽ°é—®é¢˜å—ï¼Ÿ åˆ«æ…Œï¼Œå…ˆå†™ä¸ªä¾‹å­æµ‹æµ‹çœ‹ 123456789101112131415161718192021222324252627282930313233package mainimport ( "fmt" "sync")type Config1 struct &#123; sync.Mutex Name string&#125;type Config2 struct &#123; *sync.Mutex Name string&#125;func main() &#123; c1 := Config1&#123;Name: "1"&#125; cc1 := c1 fmt.Println(cc1.Name) cc1.Lock() cc1.Unlock() c2 := Config2&#123; Mutex: &amp;sync.Mutex&#123;&#125;, Name: "2", &#125; cc2 := c2 fmt.Println(cc2.Name) cc2.Lock() cc2.Unlock()&#125; ä¸Šé¢è¿™ä¸ªè·‘èµ·æ¥æ²¡é—®é¢˜ï¼Œä½†æ˜¯è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æžœä½¿ç”¨æŒ‡é’ˆï¼Œä½ å°±å¿…é¡»å¯¹å®ƒåˆå§‹åŒ–ï¼Œå¦åˆ™ä¼šç©ºæŒ‡é’ˆã€‚ çœ‹èµ·æ¥å¥½åƒ copy æ²¡é—®é¢˜å•Šï¼Ÿéš¾é“ï¼Ÿè®©æˆ‘ vet çœ‹çœ‹ æžœç„¶æœ‰é—®é¢˜ï¼Œå› ä¸ºæœ‰æ‹·è´ã€‚ ä½†æ˜¯ç»“è®ºæˆ‘è®¤ä¸ºæ°æ°ç›¸åï¼ï¼ æˆ‘çš„ç»“è®ºå°±åº”è¯¥ä¸åº”è¯¥ç”³æ˜Žä¸ºæŒ‡é’ˆ åŽŸå›  1å‡è®¾ä½ ç”³æ˜Žä¸ºäº†æŒ‡é’ˆï¼Œgo vet å°±ä¸ä¼šæŠ¥é”™ï¼Œé‚£ä¹ˆå…¶å®žä½ åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œåœ¨ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹ä½ å°±ä¼šâ€œå¤åˆ¶â€è¿™ä¸ªé” åŽŸå›  2åœ¨ä»€ä¹ˆæ—¶å€™ä¼šä½¿ç”¨é”å‘¢ï¼Ÿä¸€èˆ¬æ˜¯ä¸æ˜¯æœ‰ä¸€ä¸ªå•ä¾‹å¯¹è±¡è¦æŽ§åˆ¶ï¼Œè¿™ä¸ªå¯¹è±¡æˆ–è€…æŸä¸ªæ“ä½œè¦æŽ§åˆ¶å¹¶å‘çš„æ—¶å€™ç”¨å¯¹å§ã€‚ é‚£ä»€ä¹ˆæ—¶å€™ä¼šå¤åˆ¶å¯¹è±¡å‘¢ï¼Ÿé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡ä¸€å®šå°±ä¸æ˜¯ä¸ªå•ä¾‹å¯¹ä¸å¯¹ï¼Ÿï¼ˆæ³¨æ„è¿™é‡Œæ˜¯å¤åˆ¶å¯¹è±¡ï¼Œè€Œä¸æ˜¯åˆ›å»ºæŒ‡é’ˆå¯¹è±¡ä»Žè€Œå¤åˆ¶æŒ‡é’ˆï¼‰ 12345c2 := Config2&#123; Mutex: &amp;sync.Mutex&#123;&#125;, Name: "2",&#125;cc2 := c2 è¿™ä¸ªå†™æ³•å°±å·²ç»å¾ˆå¤æ€ªäº†ï¼Œä½ å¤åˆ¶äº†è¿™ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”ç”¨äº†åŒä¸€æŠŠé”ï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼š ä½ çš„æƒ³æ³•ç©¶ç«Ÿæ˜¯ cc2 é”çš„æ—¶å€™ c2 ä¹Ÿè¦è¢«é”ä½ï¼Ÿ=&gt; å¦‚æžœæ˜¯è¿™ä¸€ç§ï¼Œé‚£ä¹ˆå°±ä¸åº”è¯¥å°†é”ç”³æ˜Žåœ¨å¯¹è±¡å†…éƒ¨ã€‚ è¿˜æ˜¯ cc2 é”çš„æ—¶å€™ c2 ä¸è¦è¢«é”ä½ï¼Ÿ=&gt; å¦‚æžœæ˜¯è¿™ä¸€ç§ï¼Œæ—¢ä¸èƒ½å°†é”ç”³æ˜Žä¸ºæŒ‡é’ˆï¼Œä¹Ÿèƒ½è¿›è¡Œæ‹·è´ï¼Œè€Œåº”è¯¥é‡æ–°ç”³æ˜Žä¸€ä¸ªå¯¹è±¡ï¼Œè¿›è¡Œå¯¹è±¡å…¶ä»–å€¼çš„èµ‹å€¼æ“ä½œã€‚ ç»“è®ºæ‰€ä»¥æˆ‘çš„ç»“è®ºå¾ˆæ˜Žæ˜¾ï¼Œä¸åº”è¯¥ç”³æ˜Žä¸ºæŒ‡é’ˆï¼Œç”³æ˜ŽæŒ‡é’ˆå®¹æ˜“åœ¨ä¸ç»æ„é—´å¯¼è‡´æ„å¤–ã€‚ å¦‚æžœæ‹…å¿ƒæ‹·è´é”çš„é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨ go vet è¿›è¡Œåˆ†æžï¼ŒçŽ°åœ¨å¾ˆå¤š go çš„ä»£ç é™æ€åˆ†æžå·¥å…·ä¹Ÿéƒ½æä¾›äº†è¿™ä¸ªåŠŸèƒ½çš„ï¼Œå…¶ä»–çš„ä¹Ÿå¯ä»¥ã€‚ å½“ç„¶è¿™æ˜¯æˆ‘çš„ä¸ªäººè§‚ç‚¹ï¼Œå› ä¸ºè¯­æ³•æœ¬èº«æ²¡æœ‰é”™ï¼Œå¯èƒ½ä¼šåœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹çœŸçš„æœ‰ç”¨åˆ°è¿™æ ·çš„å†™æ³•~å¦‚æžœæˆ‘ æ„Ÿè°¢åœ¨æˆ‘ç–‘æƒ‘è‡ªå·±çš„æƒ³æ³•çš„æ—¶å€™æ„Ÿè°¢ç¾¤é‡Œå¤§ä½¬çš„è‚¯å®šå’ŒæŒ‡ç‚¹ã€‚ åŒæ—¶ä¹Ÿæ„Ÿè°¢æå‡ºè¿™ä¸ª PR çš„åŒå­¦ï¼Œè®©æˆ‘æ›´åŠ æ·±åˆ»çš„å­¦ä¼šäº†è¿™ä¸ªçŸ¥è¯†ç‚¹ã€‚ ä½ ä»¬é‡åˆ°é—®é¢˜ä¹Ÿè¦åˆ¨æ ¹é—®åº•å“¦ï¼ä¸è¦æ”¾è¿‡ä»»ä½•ä¸€ä¸ªå°é—®é¢˜ï¼]]></content>
      <categories>
        <category>golangåŸºç¡€</category>
      </categories>
      <tags>
        <tag>Mutex</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Linux å›¾å½¢åŒ–ç›‘æŽ§å·¥å…·]]></title>
    <url>%2F2020%2F07%2F11%2Flinux%2Flinux-monitor%2F</url>
    <content type="text"><![CDATA[æœ€è¿‘åœ¨åˆ†æžçº¿ä¸Šé—®é¢˜ï¼Œéœ€è¦ç›‘æŽ§ Linux ç›¸å…³æŒ‡æ ‡ï¼Œå¦‚æžœåªæ˜¯ç”¨å‘½ä»¤ï¼Œæ€»æ˜¯åªèƒ½çŸ¥é“å½“å‰çš„å€¼ï¼Œæ— æ³•è®°å½•è¿‡ç¨‹ã€‚è€Œè®¾å¤‡ä¸æ˜¯äº‘åŽ‚å•†çš„è®¾å¤‡ï¼Œæ‰€ä»¥æ²¡æœ‰ç›¸å…³ç›‘æŽ§ï¼Œzabbix æœ‰ï¼Œä½†æ˜¯æ²¡æœ‰ç›¸å…³æƒé™å¯ä»¥çœ‹åˆ°ã€‚æ‰€ä»¥æ‰¾åˆ°ä¸€äº›å¥½ç”¨çš„ç›‘æŽ§å°æ–¹æ¡ˆã€‚ nmonå®‰è£…yum install nmon ä½¿ç”¨ æ€»ç»“ å®‰è£…æ–¹ä¾¿ï¼Œä½¿ç”¨ç®€å•ï¼Œæœ€å¿«é€Ÿåº¦èƒ½æžå®šï¼Œæ— éœ€è¿‡å¤šä¾èµ–ï¼ŒæŽ§åˆ¶å°å±•ç¤º å½“ç„¶å®ƒè¿˜æœ‰å…¶ä»–å†…å­˜ç­‰ç›¸å…³ä¿¡æ¯çš„å±•ç¤º ä¸æ˜¯ç‰¹åˆ«å¥½çœ‹ï¼ˆæ¯•ç«Ÿæ˜¯æŽ§åˆ¶å°è¦æ±‚ä¹Ÿä¸èƒ½å¤ªé«˜ï¼‰ï¼Œç²¾åº¦ç›¸å¯¹ä½Žï¼Œåªèƒ½æœ‰ä¸ªå¤§æ¦‚å³°å€¼ bottomå®‰è£…å› ä¸ºæ˜¯ rust æžçš„ï¼Œæ‰€ä»¥å¯èƒ½æœ‰ç›¸å…³ä¾èµ–ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç† 12345678910111213141516wget https://github.com/ClementTsang/bottom/releases/download/0.4.5/bottom_x86_64-unknown-linux-gnu.tar.gztar xvf bottom_x86_64-unknown-linux-gnu.tar.gz./btm# å¦‚æžœå‡ºçŽ°ä»¥ä¸‹é”™è¯¯éœ€è¦å®‰è£… glibc # /btm: /lib64/libc.so.6: version `GLIBC_2.18' not found (required by ./btm)curl -O http://ftp.gnu.org/gnu/glibc/glibc-2.18.tar.gztar zxf glibc-2.18.tar.gzcd glibc-2.18/mkdir buildcd build/../configure --prefix=/usrmake -j2make install./btm ä½¿ç”¨ æ€»ç»“ ä¸é”™ï¼Œä¹Ÿè¿˜æŒºå¥½çœ‹çš„ï¼Œå› ä¸ºç”¨ç‚¹ç»˜åˆ¶ï¼Œæ‰€ä»¥æ›´åŠ å¥½çœ‹ä¸€ä¸¢ä¸¢ å®‰è£…å¯èƒ½æœ‰ä¾èµ–ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç† netdataå®‰è£…12345# make sure you run `bash` for your shellbash# install Netdata directly from GitHub sourcebash &lt;(curl -Ss https://my-netdata.io/kickstart.sh) æˆ–è€…ç›´æŽ¥ docker 12345678910111213docker run -d --name=netdata \ -p 19999:19999 \ -v netdatalib:/var/lib/netdata \ -v netdatacache:/var/cache/netdata \ -v /etc/passwd:/host/etc/passwd:ro \ -v /etc/group:/host/etc/group:ro \ -v /proc:/host/proc:ro \ -v /sys:/host/sys:ro \ -v /etc/os-release:/host/etc/os-release:ro \ --restart unless-stopped \ --cap-add SYS_PTRACE \ --security-opt apparmor=unconfined \ netdata/netdata ä½¿ç”¨ æ€»ç»“ å¦‚æžœæ‰‹åŠ¨å®‰è£…çš„è¯ï¼Œä¾èµ–å¾ˆå¤šï¼Œè™½ç„¶å®˜æ–¹æä¾›äº†ä¸€é”®å®‰è£…ï¼Œæ•´ä½“å®‰è£…è¿‡ç¨‹è¿˜æ˜¯æ¯”è¾ƒé•¿çš„ docker ç›´æŽ¥å¯ä¸€ä¸ªå€’æ˜¯å¾ˆå¿«ï¼Œæ‹‰ä¸ªé•œåƒä¸€è·‘èµ·æ¥å°±å¥½äº† å¥½çœ‹ï¼ŒçœŸçš„ä¸é”™ï¼Œå„ç±»æŒ‡æ ‡éƒ½ä¸€åº”ä¿±å…¨ï¼Œè€Œä¸” UI ä¹Ÿå¾ˆå¥½çœ‹ï¼ˆCPUï¼Œå†…å­˜ï¼Œç½‘ç»œï¼Œä¸­æ–­ç­‰ç­‰éƒ½æœ‰ï¼ŒçœŸçš„å¾ˆå…¨ï¼‰ ç½‘ä¸Šè¯´å®‰è£…åŽä¼šå½±å“æœåŠ¡å™¨è¿è¡Œé€Ÿåº¦ï¼Œè¿™ä¸ªç›‘æŽ§æŒ‡æ ‡å¾ˆå¤šï¼Œç¡®å®žæ‰€ä»¥æœ¬èº«ä¼šå ç”¨ä¸€å®šæœåŠ¡å™¨èµ„æºï¼Œéœ€è¦æ³¨æ„ grafana + influxdb + telegrafå®‰è£… æˆ‘è¿™è¾¹å› ä¸ºçº¿ä¸Šæœ¬èº«å°±æœ‰å‰ä¸¤ä¸ªçš„çŽ¯å¢ƒï¼Œæ‰€ä»¥åªéœ€è¦è£…ä¸ª telegraf å°±èƒ½æžå®šï¼Œå¦‚æžœä½ æ²¡æœ‰ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨è£…ä¸ªï¼Œå…·ä½“æ­¥éª¤å¯ä»¥å‚è€ƒ https://www.jianshu.com/p/2fd3e9252a41 å…¶å®žåŽŸæœ¬æƒ³ç”¨ Prometheus + Grafana çš„ï¼Œä½†æ˜¯çº¿ä¸Šæš‚æ—¶æ²¡æœ‰ Prometheus ä¹‹å‰ä¹Ÿç”¨è¿‡ï¼Œè¿™é‡Œå°±ä¸åšå±•ç¤ºäº†ï¼Œå…¶å®žä¹Ÿå¾ˆæ–¹ä¾¿ https://www.jianshu.com/p/8d2c020313f0 ä½¿ç”¨ ä¸€ä¸ªå­—ï¼Œå¥½çœ‹ï¼ æ€»ç»“ ç›¸å…³ç›‘æŽ§ä¿¡æ¯ä¸€åº”ä¿±å…¨ï¼Œæ•´ä½“å¥½çœ‹ï¼Œgrafana ç¡®å®žæœ‰ä¸€æ‰‹ ç›¸å¯¹çŽ¯å¢ƒå¦‚æžœç”¨ docker éƒ¨ç½²ä¼šå®¹æ˜“å¾ˆå¤šï¼Œæœ¬èº«ä¹Ÿä¸å¤æ‚ï¼Œé…ç½®ç®€å•ï¼ŒæŽ¨è ç›¸å¯¹æ¥è¯´è¿˜å¯ä»¥ç›´æŽ¥ç”¨ æ€»ç»“å½“å‰æˆ‘ç”¨æœ€åŽä¸€ç§åœ¨çº¿ä¸Šå…ˆè·‘ç€ï¼Œçœ‹çœ‹æƒ…å†µã€‚ ä¸Šé¢çš„ç›‘æŽ§æœ‰ç®€å•çš„ï¼Œæœ‰å¤æ‚çš„ï¼Œä½ å–œæ¬¢å“ªä¸€ç§å‘¢ï¼Ÿæˆ–è€…è¯´ä½ è¿˜æœ‰ä»€ä¹ˆæ›´å¥½çš„æ–¹æ¡ˆä¹Ÿæ¬¢è¿Žåœ¨ä¸‹é¢è¯„è®ºã€‚]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>monitor</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä½ çš„ç½‘ç»œè¿˜å¥½å—]]></title>
    <url>%2F2020%2F07%2F04%2Flinux%2Fnetwork%2F</url>
    <content type="text"><![CDATA[ä¹‹å‰è¯´äº† CPUã€å†…å­˜ ã€IO åœ¨æŽ’æŸ¥è¿‡ç¨‹ä¸­å¯èƒ½å‡ºçŽ°çš„é—®é¢˜ä»¥åŠå‡ºçŽ°é—®é¢˜ä¼šå½±å“çš„æŒ‡æ ‡ï¼Œè¿™æ¬¡å°±æ¥çœ‹çœ‹åœ¨ linux ä¸­ç½‘ç»œçš„é—®é¢˜ã€‚ åœ¨å®žé™…ä¸­æˆ‘ä»¬é‡åˆ°çš„æœ€å¤šçš„ç½‘ç»œé—®é¢˜å°±æ˜¯ï¼šä¸é€šï¼ï¼ï¼æ— è®ºæ˜¯ ping ä¸é€šï¼Œç‰©ç†é“¾è·¯ä¸é€šï¼Œè¿˜æ˜¯ dns è§£æžæœ‰é—®é¢˜å¯¼è‡´çš„ä¸é€šï¼Œè¿˜æ˜¯å®¹å™¨é—´ç½‘ç»œè®¿é—®ç½‘ç»œéš”ç¦»é€ æˆçš„ä¸é€šï¼Œç­‰ç­‰ï¼Œè¿™ä¸ªé—®é¢˜æ€»æ˜¯ç”±äºŽéƒ¨ç½²ä¸Šçš„çŽ¯å¢ƒå¯¼è‡´çš„ã€‚è¿˜æœ‰ä¸€ç±»æ¯”è¾ƒçƒ¦çš„é—®é¢˜å°±æ˜¯ç½‘ç»œå¸¦å®½æœ¬æ¥å°±ä¸é«˜çš„æƒ…å†µä¸‹ï¼Œå¤§é‡çš„è¯·æ±‚å¯¼è‡´ç½‘ç»œçš„æ‹¥å¡žï¼Œæœ€æ˜Žæ˜¾çš„æ„Ÿå—å°±æ˜¯æŽ¥å£è¯·æ±‚è¶…æ—¶ï¼Œå„ç§è¶…æ—¶ï¼Œnginx è¶…æ—¶ï¼Œè¯·æ±‚æœ¬èº«è¶…æ—¶ç­‰ç­‰ã€‚å¯¹äºŽè¿™äº›é—®é¢˜å¦‚ä½•è¿›è¡ŒæŽ’æŸ¥å‘¢ï¼Ÿ è¯Šæ–­æŒ‡æ ‡sarå‘½ä»¤sar -n DEV 1 12345678910[root@Linkin ~]# sar -n DEV 1Linux 3.10.0-1062.9.1.el7.x86_64 (Linkin) 07/04/2020 _x86_64_ (2 CPU)03:03:40 PM IFACE rxpck/s txpck/s rxkB/s txkB/s rxcmp/s txcmp/s rxmcst/s03:03:41 PM br-22dd849a79f5 0.00 0.00 0.00 0.00 0.00 0.00 0.0003:03:41 PM br-dac186ab0c70 0.00 0.00 0.00 0.00 0.00 0.00 0.0003:03:41 PM veth860c89a 0.00 0.00 0.00 0.00 0.00 0.00 0.0003:03:41 PM eth0 5.00 4.00 0.30 2.43 0.00 0.00 0.0003:03:41 PM lo 0.00 0.00 0.00 0.00 0.00 0.00 0.0003:03:41 PM docker0 0.00 0.00 0.00 0.00 0.00 0.00 0.00 æŒ‡æ ‡è¿™ä¸ªå‘½ä»¤å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°æ•´ä½“çš„ç½‘ç»œåžåæƒ…å†µ rxpck/sã€ txpck/s æŽ¥æ”¶å’Œå‘é€çš„ PPS åŒ… / ç§’ rxkB/sã€txkB/s æŽ¥æ”¶å’Œå‘é€çš„åžåé‡ KB/ ç§’ iperf3å‘½ä»¤ç”¨äºŽæµ‹è¯•ç½‘é€Ÿã€å¸¦å®½ 12345678# -s è¡¨ç¤ºå¯åŠ¨æœåŠ¡ç«¯ï¼Œ-i è¡¨ç¤ºæ±‡æŠ¥é—´éš”ï¼Œ-p è¡¨ç¤ºç›‘å¬ç«¯å£$ iperf3 -s -i 1 -p 10000# -c è¡¨ç¤ºå¯åŠ¨å®¢æˆ·ç«¯ï¼Œ192.168.10.30 ä¸ºç›®æ ‡æœåŠ¡å™¨çš„ IP# -b è¡¨ç¤ºç›®æ ‡å¸¦å®½ (å•ä½æ˜¯ bits/s)# -t è¡¨ç¤ºæµ‹è¯•æ—¶é—´# -P è¡¨ç¤ºå¹¶å‘æ•°ï¼Œ-p è¡¨ç¤ºç›®æ ‡æœåŠ¡å™¨ç›‘å¬ç«¯å£$ iperf3 -c 192.168.10.30 -b 1G -t 15 -P 2 -p 10000 nslookup &amp; digå‘½ä»¤åƒä¸‡ä¸è¦å°çœ‹ DNS çš„é—®é¢˜ï¼Œå¾ˆå¤šæ—¶å€™ DNS è§£æžä¼šå‡ºçŽ°å¾ˆå¤šé—®é¢˜ï¼Œç‰¹åˆ«æ˜¯æœ‰ DNS ç¼“å­˜çš„æ—¶å€™ 12345678910# å®‰è£…yum install bind-utils# ä½¿ç”¨nslookup www.baidu.com# +trace è¡¨ç¤ºå¼€å¯è·Ÿè¸ªæŸ¥è¯¢# +nodnssec è¡¨ç¤ºç¦æ­¢ DNS å®‰å…¨æ‰©å±•dig +trace +nodnssec www.baidu.comdig linkinstar.com @localhost tcpdumpè¿™ä¸ªæŠ“åŒ…å·¥å…·å¯å¤ªå¼ºå¤§äº†ï¼Œå‘½ä»¤å‚æ•°ä¹Ÿå¾ˆå¤šï¼Œä¸¾ä¾‹å¸¸ç”¨çš„ï¼š 1234# -i eth0 æŒ‡å®šç½‘å¡# -nn host 10.0.2.1 ä¸»æœºè¿‡æ»¤# -nn tcp åè®®è¿‡æ»¤# -nn dst port 80 ç«¯å£è¿‡æ»¤ å†…æ ¸å‚æ•°ä¿®æ”¹æåŠå…¶å®žå¾ˆå¤šç½‘ç»œä¼˜åŒ–çš„å‚æ•°éƒ½æ˜¯å¯ä»¥é€šè¿‡ä¿®æ”¹ linux å†…æ ¸å‚æ•°è¿›è¡Œè°ƒä¼˜ vi /etc/sysctl.conf ä½†æ˜¯è¿™é‡Œçš„è°ƒæ•´å¯å¤ªè®²ç©¶äº†ï¼Œæ¶‰åŠçš„çŸ¥è¯†ç‚¹å¤ªå¤šï¼Œç¼“å†²åŒºæœ€å¤§å€¼ã€é˜Ÿåˆ—é•¿åº¦ç­‰ç­‰ï¼Œå…¶å®žæˆ‘çš„å»ºè®®æ˜¯ï¼Œè¦ä¸å°±ç›´æŽ¥ä¸åŠ¨ï¼Œç­‰åˆ°æœ‰é—®é¢˜å†è¯´ï¼Œè¦ä¸å°±ç›´æŽ¥äº¤ç»™æœ‰ç»éªŒçš„è¿ç»´æžå®šï¼Œç›´æŽ¥å¤åˆ¶ç½‘ä¸Šçš„é…ç½®æ–‡ä»¶è¦†ç›–ä¸å¤ªå¯å–ï¼Œä¸‡ä¸€å‡ºçŽ°é—®é¢˜ä¸çŸ¥é“å¦‚ä½•è¿›è¡Œå¤„ç†ã€‚ æŽ’æŸ¥æ­¥éª¤ ä¿è¯ç½‘ç»œé€šï¼Œé‚£è‚¯å®šä¸€ä¸Šæ¥æœ€é è°±çš„å°±æ˜¯ ping äº†ï¼Œç½‘ç»œè¦æ˜¯éƒ½ä¸é€šçš„è¯ï¼Œé‚£å°±æ²¡å•¥å¥½è¯´çš„äº† æŸ¥çœ‹ç½‘ç»œè¯·æ±‚æƒ…å†µï¼Œå°±æ˜¯çœ‹ï¼ŒçŽ°åœ¨ç½‘ç»œæ˜¯å¦ç¡®å®žè¯·æ±‚é‡å¾ˆå¤§ï¼Œæˆ–è€…è¯´è¯·æ±‚æ•°é‡å¾ˆå¤šï¼Œæˆ–è€…å¸¦å®½èµ„æºä¸è¶³ç­‰æƒ…å†µ æŸ¥çœ‹ç½‘ç»œèµ„æºçŠ¶æ€ï¼ŒæŸ¥çœ‹å½“å‰æœ‰å¤šå°‘è¿žæŽ¥æ•°ï¼Œå„ä¸ª TCP\UDP è¿žæŽ¥çŠ¶æ€æ˜¯å¦æ­£å¸¸ï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šå°±èƒ½åæ˜ å‡ºé—®é¢˜ æŽ’æŸ¥åŽŸå› å…¶å®žç½‘ç»œå¯¼è‡´çš„é—®é¢˜å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼š ä¸é€š å¡äº† ä½†æ˜¯å¯¼è‡´è¿™ä¸¤ç§æƒ…å†µå‡ºçŽ°çš„åŽŸå› çº·ç¹å¤æ‚ï¼Œå¤ªå¤šæ— åŽ˜å¤´çš„é—®é¢˜å‡ºçŽ°äº†ï¼Œå¯¼è‡´ç½‘ç»œä¸€ç›´æ˜¯ linux é‡Œé¢çš„ä¸€åº§å¤§å±±ã€‚ ä¸‹é¢ä¸¾ä¾‹è¯´å‡ ç§çŽ°å®žä¸­å‡ºçŽ°è¿‡çš„æƒ…å†µã€‚ é˜²ç«å¢™å‡ ä¹Žæ‰€æœ‰çš„äººéƒ½ä¼šè¢«è¿™ä¸ªçŽ©æ„å‘è¿‡ä¸€æ¬¡ï¼Œé•¿è®°æ€§ä¹‹åŽåˆä¼šè¢«å‘ç¬¬äºŒæ¬¡ã€‚ ç¬¬ä¸€æ¬¡çŽ© linux æœåŠ¡å™¨çš„æ—¶å€™å°±è¢«è¿™ä¸ªçŽ©æ„å‘äº†ä¸€å¤©ï¼Œæ‰€æœ‰ä¸œè¥¿æŸ¥åˆ°æœ€åŽï¼Œå‘çŽ°é˜²ç«å¢™æ²¡å…³ï¼Œæˆ–è€…ç«¯å£æ²¡å¼€æ”¾ï¼Œå¯¼è‡´æ— æ³•è®¿é—®ã€‚ ç¬¬äºŒæ¬¡æ˜¯äº‘æœåŠ¡å™¨å‘äº†ä¸€æ³¢ï¼ŒæœåŠ¡å™¨çš„é˜²ç«å¢™æ˜¯å…³äº†ï¼Œä½†æ˜¯äº‘åŽ‚å•†æœ‰ç€è‡ªå·±çš„å®‰å…¨ç­–ç•¥è§„åˆ™ï¼Œä½ å¿…é¡»æ‰‹åŠ¨åŽ»ç½‘é¡µä¸Šå¼€æ”¾è¿›è¡Œè®¾ç½®ã€‚ DNS è§£æžé—®é¢˜è¿™é‡Œåˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯å¤–ç½‘çš„ DNS è§£æžï¼Œè¿™ç§è¦ä¸å°±æ˜¯ DNS æœåŠ¡å™¨æ²¡é…ç½®ï¼Œè¦ä¸å°±æ˜¯ DNS è§£æžæœåŠ¡å™¨ç¡®å®žæœ‰é—®é¢˜ã€‚ ä¸€ç§æ˜¯å†…ç½‘çš„ DNS è§£æžï¼Œå› ä¸ºå†…ç½‘é‡Œé¢ä¹Ÿä¼šä½¿ç”¨ DNS è¿›è¡Œè®¿é—®å’Œè¯·æ±‚ï¼Œè¿™ä¸ªæ—¶å€™å¾ˆå¤šæ—¶å€™å°±ä¼šå‡ºçŽ°é—®é¢˜ï¼Œä¸€èˆ¬å°±æ˜¯ ping ä¸é€šï¼Œç„¶åŽå°±ç”¨ dig è¿›è¡ŒæŸ¥ã€‚ è¿˜æœ‰å°±æ˜¯å‰é¢çš„ LB å±‚ï¼Œä¹Ÿå°±æ˜¯å¦‚ NGINX è¿™æ ·çš„è´Ÿè½½å‡è¡¡ä¸Šç¼“å­˜äº† DNS è§£æžï¼Œå½“åŽé¢çš„ IP æ›´æ¢å¯¼è‡´è´Ÿè½½å‡ºçŽ°é—®é¢˜ã€‚ å¤§é‡ TIME_WAITå‡ºçŽ°åŽŸå› æ˜¯ç¨‹åº bugï¼Œå¤§é‡å®¢æˆ·ç«¯è¯·æ±‚åŽå¼‚å¸¸å…³é—­ï¼Œè¯´ TCP çš„æ—¶å€™è¿™ä¸ªçŠ¶æ€ä¹‹å‰è¯´è¿‡ï¼Œè¿™é‡Œå°±ä¸å†è¯¦è¿°äº†ã€‚ å¤§é‡ SYN_RECVå¯èƒ½ç”±äºŽ SYN FLOOD æ”»å‡»å¯¼è‡´ï¼Œé‚£è¿™ä¸ªè°ƒå†…æ ¸å‚æ•°å¯ä»¥ç¼“è§£ï¼Œä½†æ˜¯å¦‚æžœçœŸçš„æ˜¯å¤–ç½‘éƒ¨ç½²é‡åˆ°è¿™æ ·çš„æƒ…å†µï¼Œå¦‚æžœå‡ºçŽ°é¢‘ç¹ï¼Œä¼˜å…ˆè€ƒè™‘å° IPï¼Œäº‘åŽ‚å•†çš„æœåŠ¡æˆ–è€… CDN å®¹å™¨é—´ç½‘ç»œä¸é€šè™½ç„¶çŽ°åœ¨åˆ K8S è¿™æ ·çš„å®¹å™¨ç¼–æŽ’ï¼Œä½†åœ¨è¿™ä¹‹å‰å®¹å™¨é—´çš„ç½‘ç»œæ€»æ˜¯æœ‰ç€å„ç§é—®é¢˜ï¼Œæ— è®ºæ˜¯ä½¿ç”¨ host ç½‘ç»œï¼Œè¿˜æ˜¯ç½‘æ¡¥ï¼Œæ€»ä¹‹ç½‘ç»œä¸é€šæœåŠ¡æ— æ³•è®¿é—®ï¼Œæ€»æ˜¯å­˜åœ¨ï¼Œè¿™ä¸ªæ—¶å€™æŠ“åŒ…å¾€å¾€å°±æˆäº†æœ€é è°±çš„è§£å†³æ–¹æ¡ˆã€‚pingï¼Œç„¶åŽç›´æŽ¥æŠ“ icmp åŒ…ï¼Œä¸€ä¸ªä¸ªæŠ“è¿‡æ¥ï¼Œeth0ï¼Œdocker0ï¼Œflannel0â€¦ è¯·æ±‚è¿‡å¤šå…¶å®žå¾ˆå¤šæ—¶å€™ï¼Œç½‘ç»œä¸Šçš„é—®é¢˜å°±æ˜¯è¯·æ±‚å‘è¿‡åŽ»ç›¸åº”æ—¶é—´è¿‡é•¿äº†ï¼Œå¯¼è‡´ç”¨æˆ·æ„Ÿå—å°±æ˜¯å¡ï¼Œè€Œå¡åœ¨ç½‘ç»œæƒ…å†µä¸å¥½çš„æ—¶å€™åæ˜ å°¤ä¸ºæ˜Žæ˜¾ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœ‰çš„æ—¶å€™å¸¦å®½èµ„æºå æ»¡ï¼Œä½ å¯èƒ½è¿žæœåŠ¡å™¨éƒ½æ— æ³•è¿›è¡Œç™»å½•äº†ã€‚ è¿™ä¸ªæ—¶å€™ä½ éœ€è¦åšçš„å°±æ˜¯åˆ†æžå‡ºçŽ°è¿™æ ·æƒ…å†µçš„åŽŸå› ï¼Œå¤šæ•°æƒ…å†µä¸‹éƒ½æ˜¯ç”±äºŽæœ€åº•å±‚çš„æ•°æ®æŸ¥è¯¢æœ‰é—®é¢˜ï¼Œå¯¼è‡´ IO ç“¶é¢ˆç­‰ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢æ—¶é—´å¾€å¾€æˆä¸ºäº†è§£å†³é—®é¢˜çš„å…³é”®ã€‚å…¶æ¬¡å°±æ˜¯ç¼“å­˜ï¼Œè¿™ä¸ªå¾€å¾€é©¬ä¸Šå°±èƒ½çž¬é—´æå‡æ€§èƒ½ã€‚æœ€åŽå°±æ˜¯ï¼Œè¦åšå¥½å®‰å…¨å’Œé™æµå·¥ä½œï¼Œå†æ€Žä¹ˆè¯´æœåŠ¡å™¨æ€»æ˜¯æœ‰ç“¶é¢ˆçš„ï¼Œå¦‚æžœç”¨æˆ·ä¹‹é—´åŽ‹ä½ çš„æœåŠ¡ï¼Œå°±æ˜¯æƒ³æŠŠä½ å¸¦å®½å æ»¡ï¼Œå¦‚æžœæ²¡æœ‰åšå¥½åˆç†çš„å®‰å…¨ç­–ç•¥å’Œé™æµå·¥ä½œï¼Œææ€•å¾ˆå¿«å°±å‡‰äº†ã€‚ æ€»ç»“ç½‘ç»œå°±æ˜¯åˆ¶å®šäº†å„ç§åè®®ï¼Œå°†æ•°æ®å°è£…æˆå„ç§æ ·å­ï¼Œä»¥ä¾¿èƒ½ç¨³å®šçš„åœ¨ç½‘ç»œä¸­ä¼ è¾“ã€‚æˆ‘ä»¬å­¦ä¹ ç½‘ç»œåè®®å’ŒåŽŸç†çš„ç›®çš„æ˜¯ä¸ºäº†åœ¨å‡ºçŽ°é—®é¢˜çš„æ—¶å€™å°½å¿«èƒ½å®šä½åˆ°é—®é¢˜ï¼Œé¿å…é—®é¢˜çš„å‘ç”Ÿã€‚ ä¸Šå­¦çš„æ—¶å€™ï¼Œè€å¸ˆæ›¾ç»å°±å’Œæˆ‘ä»¬è¯´è¿‡ï¼Œä¸€ä¸ªç½‘ç»œå·¥ç¨‹å¸ˆåŽ»çŽ°åœºï¼Œå°±æ˜¯åŽŸæ¥æ˜¯ ping ä¸é€šçš„ï¼Œä½†æ˜¯æžä¸€æžï¼Œæœ€åŽé€šäº†ï¼Œå·¥ä½œå°±å®Œæˆäº†ã€‚ä½†çœ‹ä¼¼ç®€å•çš„èƒŒåŽï¼Œå…¶å®žè—ç€å„ç§å„æ ·çš„å¤æ‚é—®é¢˜ï¼Œç«¯å£ï¼Œåè®®ï¼Œdnså…¶ä¸­çš„ä»»ä½•ä¸€ä¸ªæ­¥éª¤éƒ½ä¼šå¯¼è‡´é—®é¢˜ã€‚ æ‰€ä»¥åœ¨é‡åˆ°ç½‘ç»œé—®é¢˜çš„æ—¶å€™ä¹Ÿä¸è¦æ…Œå¼ ï¼Œä¸€æ­¥æ­¥æ¥ï¼Œä»Žå¤´èµ°åˆ°å°¾ï¼Œæ€»èƒ½å‘çŽ°æœ€åŽçš„é—®é¢˜ã€‚]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>network</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä½ çš„ IO è¿˜å¥½å—]]></title>
    <url>%2F2020%2F06%2F27%2Flinux%2Fio%2F</url>
    <content type="text"><![CDATA[åœ¨ CPU çœ‹æ¥å†…å­˜å¥½æ…¢å•Šï¼Œçœ‹æˆ‘è·‘çš„å¤šå¿«ï¼›åœ¨å†…å­˜çœ‹æ¥ç£ç›˜ä½ å¥½æ…¢å•Šï¼Œçœ‹æˆ‘æ¯”ä½ è¿˜å¿«ç‚¹ï¼›ç£ç›˜â€¦ IO é—®é¢˜å¹¶éžç‰¹åˆ«å¸¸è§ï¼Œä½†æ˜¯å› ä¸ºæœ€ç»ˆè¦è½åˆ°ç£ç›˜ä¸Šï¼Œå½“å®ƒæˆä¸ºç“¶é¢ˆæ—¶ï¼Œå¾€å¾€ä¼šæ‹–æ…¢ä½ çš„è„šæœ¬ï¼Œä»Šå¤©æˆ‘ä»¬æ¥åˆ†æžä¸‹åœ¨ linux ä¸­çš„ IO é—®é¢˜ æŒ‡æ ‡çœ‹ IO å¹¶ä¸åªæ˜¯çœ‹ IOï¼Œè®°ä½è¿™å¥è¯ï¼Œå› ä¸ºå¾ˆå¤šæ—¶å€™ï¼ŒIO é—®é¢˜æ€»ä¼šä¼´éšç€åˆ«çš„é—®é¢˜ä¸€èµ·å‡ºçŽ°ï¼Œè€Œä¼šå¯¼è‡´è¯¯åˆ¤çš„ï¼Œä»Žè€Œé—æ¼äº†é—®é¢˜çš„å…³é”®ã€‚ IO é—®é¢˜çš„æŒ‡æ ‡æ¥æºäºŽä¸¤å—ï¼š æ–‡ä»¶ç³»ç»Ÿ ç£ç›˜ iowaitå‘½ä»¤top iostat %iowait è¡¨ç¤ºåœ¨ä¸€ä¸ªé‡‡æ ·å‘¨æœŸå†…æœ‰ç™¾åˆ†ä¹‹å‡ çš„æ—¶é—´å±žäºŽä»¥ä¸‹æƒ…å†µï¼šCPUç©ºé—²ã€å¹¶ä¸”æœ‰ä»æœªå®Œæˆçš„I/Oè¯·æ±‚ã€‚ æŒ‡æ ‡iowait å‡é«˜æˆ–è€…å±…é«˜ä¸ä¸‹ï¼Œå¯ä»¥è€ƒè™‘å­˜åœ¨ IO ç“¶é¢ˆæˆ–åŽ‹åŠ› rs / wså‘½ä»¤iostat -x -d 1 123Device: rrqm/s wrqm/s r/s w/s rkB/s wkB/s avgrq-sz avgqu-sz await r_await w_await svctm %utilvda 0.00 13.00 0.00 4.00 0.00 68.00 34.00 0.00 1.00 0.00 1.00 0.25 0.10dm-0 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00 0.00 æŒ‡æ ‡ r/s: æ¯ç§’å®Œæˆçš„è¯» I/O è®¾å¤‡æ¬¡æ•°ã€‚å³ rio/s w/s: æ¯ç§’å®Œæˆçš„å†™ I/O è®¾å¤‡æ¬¡æ•°ã€‚å³ wio/s rkB/s: æ¯ç§’è¯»Kå­—èŠ‚æ•°ã€‚æ˜¯ rsect/s çš„ä¸€åŠï¼Œå› ä¸ºæ¯æ‰‡åŒºå¤§å°ä¸º512å­—èŠ‚ã€‚ wkB/s: æ¯ç§’å†™Kå­—èŠ‚æ•°ã€‚æ˜¯ wsect/s çš„ä¸€åŠã€‚ ä»Žè¿™é‡Œå¯ä»¥ç¡®å®šæ˜¯è¯»æˆ–è€…å†™å­˜åœ¨åŽ‹åŠ› %utilæŒ‡æ ‡ä¸€ç§’ä¸­æœ‰ç™¾åˆ†ä¹‹å¤šå°‘çš„æ—¶é—´ç”¨äºŽ I/O æ“ä½œï¼Œå³è¢«ioæ¶ˆè€—çš„cpuç™¾åˆ†æ¯” å¦‚æžœ %util æŽ¥è¿‘ 100%ï¼Œè¯´æ˜Žäº§ç”Ÿçš„I/Oè¯·æ±‚å¤ªå¤šï¼ŒI/Oç³»ç»Ÿå·²ç»æ»¡è´Ÿè·ï¼Œè¯¥ç£ç›˜å¯èƒ½å­˜åœ¨ç“¶é¢ˆ waitæŒ‡æ ‡ await: å¹³å‡æ¯æ¬¡è®¾å¤‡I/Oæ“ä½œçš„ç­‰å¾…æ—¶é—´ (æ¯«ç§’)ã€‚ svctm: å¹³å‡æ¯æ¬¡è®¾å¤‡I/Oæ“ä½œçš„æœåŠ¡æ—¶é—´ (æ¯«ç§’)ã€‚ å¦‚æžœ svctm æ¯”è¾ƒæŽ¥è¿‘ awaitï¼Œè¯´æ˜Ž I/O å‡ ä¹Žæ²¡æœ‰ç­‰å¾…æ—¶é—´ï¼›å¦‚æžœ await è¿œå¤§äºŽ svctmï¼Œè¯´æ˜ŽI/O é˜Ÿåˆ—å¤ªé•¿ï¼Œioå“åº”å¤ªæ…¢ï¼Œåˆ™éœ€è¦è¿›è¡Œå¿…è¦ä¼˜åŒ– æŽ’æŸ¥æ­¥éª¤å¯¹äºŽ IO é—®é¢˜ï¼Œå…¶å®žä¸ªäººé‡åˆ°çš„æ¯”è¾ƒå°‘ï¼Œå› ä¸ºå…¶å®žçŽ°åœ¨å¤§å¤šéƒ½æ˜¯ web ç±»åž‹çš„æœåŠ¡åº”ç”¨å’Œä¸€äº›æ•°æ®å¤„ç†æœåŠ¡ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯ç´¯åž® cpu å’Œå†…å­˜çš„ï¼Œä½†æ˜¯å¹¶ä¸ä»£è¡¨ IO é—®é¢˜å°±æ²¡æœ‰ï¼Œå½“å‡ºçŽ°é—®é¢˜çš„æ—¶å€™å°±å¾ˆå®¹æ˜“è¢«å¿½è§†ã€‚ï¼ˆè¿™é‡Œæš‚æ—¶ä¸è®¨è®ºç½‘ç»œçš„ IO é—®é¢˜ï¼Œå…³æ³¨äºŽç£ç›˜ï¼‰ ç¡®å®šå½“å‰åº”ç”¨å­˜åœ¨ IO æ“ä½œï¼šæœ‰å¾ˆå¤šæ—¶å€™ä½ è‡ªå·±éƒ½ä¸çŸ¥é“ä½ çš„åº”ç”¨å­˜åœ¨ IO æ“ä½œï¼Œå¦‚ï¼šæ—¥å¿—æ“ä½œï¼Œä¸´æ—¶æ–‡ä»¶â€¦ ç¡®å®š iowait ï¼šè¿™ä¸ªæŒ‡æ ‡å¾ˆå…³é”®ï¼Œè™½ç„¶å®ƒé«˜ä¸ä¸€å®š 100% æœ‰é—®é¢˜ï¼Œä½†æ˜¯èƒ½è¯æ˜Žå­˜åœ¨äº†å¤§é‡çš„ IO æ“ä½œ ä½¿ç”¨ iostat çœ‹ï¼šå¦‚æžœç¡®å®šäº†å‰ä¸¤é¡¹ï¼Œé‚£ä¹ˆå°±å¯ä»¥è€ƒè™‘ IO å¯èƒ½å­˜åœ¨ç“¶é¢ˆï¼Œå°±å¯ä»¥çœ‹ä¸€ä¸‹è¯»å†™å¤§ä¸å¤§æ˜¯å¦æ­£å¸¸ ä½¿ç”¨ pidstat -d çœ‹ï¼šç¡®å®šæ˜¯å¦æ˜¯è‡ªå·±è¿›ç¨‹å¯¼è‡´ï¼Œè¿˜æ˜¯åˆ«çš„åº”ç”¨æˆ–è€…æ˜¯ä¸­é—´ä»¶å¯¼è‡´ æœ€åŽçœ‹åˆ°åº•æ˜¯è°åœ¨æ“ä½œå¹¶ä¸”æ“ä½œäº†ä»€ä¹ˆæ–‡ä»¶ï¼šstrace + lsof åŸºæœ¬å°±èƒ½åˆ†æžå‡ºæœ€ç»ˆçš„ä¸€ä¸ªæ–‡ä»¶æ“ä½œäº† é—®é¢˜åŽŸå› æ—¥å¿—æ‰“å°è¿™ä¸ªæ˜¯æœ€å¸¸è§çš„ä¸€ä¸ªé—®é¢˜ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ—¥å¿—çš„æ‰“å°åŸºæœ¬éƒ½æ˜¯å¼‚æ­¥çš„ä¸€ä¸ªæ“ä½œï¼Œå¹¶ä¸”æ—¥å¿—å¤§å¤šæ•°æƒ…å†µä¸‹ä¹Ÿæ¯”è¾ƒå°ã€‚ä½†ä»£ç æ˜¯äººå†™çš„ï¼Œæ‰€ä»¥å°±ä¼šå‡ºçŽ°é—®é¢˜ã€‚ æœ€å¸¸è§çš„æ˜¯ï¼Œå°†è¿”å›žå€¼ç›´æŽ¥è¾“å‡ºåˆ°æ—¥å¿—ï¼Œæœ‰çš„æ—¶å€™ï¼Œä¸€äº›å‘½ä»¤çš„è°ƒç”¨æˆ–è€…æ˜¯ä¸€äº›è¯·æ±‚çš„è¿”å›žï¼Œå½“å‡ºçŽ°å¼‚å¸¸æ—¶é”™è¯¯è¾“å‡ºå¯èƒ½ä¼šå¾ˆå¤§ï¼Œè€Œç›´æŽ¥è¾“å‡ºåˆ°æ—¥å¿—é‚£ä¹ˆåŠ¿å¿…ä¼šå¢žåŠ  IO è´Ÿæ‹…ã€‚è€Œå½“å‡ºçŽ°é”™è¯¯ç¨‹åºå‘˜å¿…ç„¶ä¼šå°†é”™è¯¯æ‰“å°æ—¥å¿—ã€‚è€Œå‡ºçŽ°é”™è¯¯å¿…ç„¶ä¼šå¯¼è‡´ç”¨æˆ·é‡è¯•ã€‚ ç”¨æˆ·é‡è¯• -&gt; å‘½ä»¤å‡ºé”™ -&gt; æ‰“å°é”™è¯¯æ—¥å¿— -&gt; ç”¨æˆ·é‡è¯• ä¸€æ–¹é¢æˆ‘è§è¿‡ç›´æŽ¥æ—¥å¿—æŠŠç£ç›˜åƒæ»¡çš„æƒ…å†µï¼Œä¸€æ–¹é¢è¿˜æœ‰å› ä¸ºæ—¥å¿—å¼€å¯äº† debug å¯¼è‡´å…¶ä»– IO ç­‰å¾…çš„é—®é¢˜ ä¸´æ—¶æ–‡ä»¶æˆ‘ä»¬åœ¨æ‰§è¡Œå‘½ä»¤æˆ–è€…æ˜¯åˆ©ç”¨ç£ç›˜åšç¼“å­˜ï¼Œæˆ–è€…æ˜¯æ–‡ä»¶ä¸Šä¼ ï¼Œéƒ½ä¼šäº§ç”Ÿä¸€äº›ä¸´æ—¶æ–‡ä»¶ï¼Œè€Œè¿™äº›ä¸´æ—¶æ–‡ä»¶çš„æ“ä½œä¹Ÿæœ‰å¯èƒ½å¯¼è‡´ IO é—®é¢˜ ä¸­é—´ä»¶mysql ã€mongoã€redisç­‰ç­‰ä¸€ä¸‹å¸¸è§çš„ç»„ä»¶éƒ½ä¼šå¯¹ç£ç›˜è¿›è¡Œæ“ä½œï¼Œå°¤å…¶æ˜¯æ•°æ®åº“è¿™ç§ï¼Œå­˜å‚¨æ•°æ®é‡å¾ˆå¤§çš„æƒ…å†µã€‚æ³¨æ„ IO é—®é¢˜å¹¶ä¸ä¸€å®šæ˜¯å†™ï¼Œæœ‰å¯èƒ½æ˜¯è¯»ï¼ å› ä¸ºä½ æ•°æ®å­˜ç£ç›˜ä¸Šï¼Œä½ è¦è¿›è¡Œè¯»å–ï¼Œç£ç›˜çš„ç£å¤´ä¹Ÿå°±æ‰«é‚£ä¹ˆå¿«ï¼Œè¦ä¸ä½ å°± SSDï¼Œå¦åˆ™å½“è¯»å–é‡å¾ˆå¤§çš„æ—¶å€™ï¼Œé‚£ä¹Ÿæœ‰å¯èƒ½å¯¼è‡´ç“¶é¢ˆ directæœ‰çš„æ—¶å€™ä¹Ÿå’Œæˆ‘ä»¬æ“ä½œ IO çš„æ–¹å¼æœ‰å…³ï¼Œå¦‚æžœæˆ‘ä»¬ä¹‹é—´è·³è¿‡ç³»ç»Ÿç¼“å­˜ç›´æŽ¥æ“ä½œç£ç›˜ã€‚è¿˜æœ‰éšæœºå†™ï¼ŒåŒæ­¥å¼‚æ­¥ä¹Ÿä¼šç›´æŽ¥å½±å“ IO çš„é€Ÿåº¦ ç¡¬ä»¶è™½ç„¶è¿™ä¸ªå¾ˆä¸å¸¸è§ï¼Œå¯¹äºŽæˆ‘ä»¬æ¥è¯´è¿˜æ˜¯å¾ˆå°‘çœ‹åˆ°ï¼Œä½†ä¸å¾—ä¸æä¸€ä¸‹ï¼Œå‡¡æ˜¯æœ‰ä¸‡ä¸€å˜›ã€‚ æœ€ç›´æŽ¥çš„å°±æ˜¯ç£ç›˜æ¢ ssdï¼Œä½¿ç”¨ RAIDâ€¦. å¦‚æžœç¡¬ä»¶å‡ºçŽ°é—®é¢˜ï¼Œé‚£ä¹ˆå¯ä»¥å°è¯•çœ‹çœ‹ dmsg çœ‹çœ‹æ˜¯å¦æœ‰å‡ºçŽ°ä¸€äº›å¥‡æ€ªçš„æŠ¥é”™ä¿¡æ¯ã€‚ æ€»ç»“å°±æƒ³ä¸€å¼€å§‹è¯´çš„ï¼ŒI/O å¾€å¾€æ˜¯ä¸€ä¸ªç³»ç»Ÿä¸­è·‘çš„æœ€æ…¢çš„ï¼Œå¦‚æžœå®ƒå‡ºçŽ°ç“¶é¢ˆï¼Œé‚£ä¹ˆåŠ¿å¿…å¸¦æ¥çš„é—®é¢˜å°±å¾ˆæ˜Žæ˜¾ã€‚ åŒæ ·çš„ï¼Œä¹Ÿå°±æ˜¯å› ä¸ºæ˜¯æœ€åŽä¸€ä¸ªä½ç½®ï¼Œåœ¨è¿™ä¹‹å‰éƒ½å¯ä»¥é€šè¿‡CPUã€å†…å­˜ã€ç¼“å­˜ç­‰ç­‰åœ¨è¿™ä¹‹å‰æžå®šå®ƒã€‚ å¦‚æžœä½ çš„æ•°æ®æœ€åŽè½åº“ï¼Œé‚£ä¹ˆæ•°æ®åº“ä¸Šçš„ I/O é—®é¢˜ä¹Ÿæ˜¯éœ€è¦è¢«è€ƒè™‘åœ¨å†…çš„ã€‚]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>io</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å¿«é€Ÿä¸Šæ‰‹ dubbo-go]]></title>
    <url>%2F2020%2F06%2F20%2Fgolang%2Fopen-source-component%2Fdubbo-go%2F</url>
    <content type="text"><![CDATA[æ¯æ¬¡æŠ€æœ¯è°ƒç ”æ€»ä¼šå‘çŽ°è‡ªå·±å­¦ä¸åŠ¨äº†æ€Žä¹ˆåŠžï¼Ÿç”¨å·²æœ‰çš„çŸ¥è¯†æ¥æ‹“å±•è¦å­¦ä¹ çš„æ–°çŸ¥è¯†å°±å¥½äº†~ by LinkinStaræœ€è¿‘éœ€è¦è°ƒç ”ä½¿ç”¨ dubboï¼Œä¹‹å‰å®Œå…¨æ˜¯ 0 åŸºç¡€ï¼Œå¯¹äºŽ dubbo åªå­˜åœ¨äºŽå¬è¯´ï¼Œä»Šå¤©ä¸Šæ‰‹å®žæˆ˜ä¸€æŠŠï¼Œå‘Šè¯‰ä½ å¦‚ä½•å¿«é€Ÿç”¨ go ä¸Šæ‰‹ dubboPSï¼šä»¥ä¸‹çš„å­¦ä¹ æ–¹å¼é€‚ç”¨äºŽå¾ˆå¤šæ–°æŠ€æœ¯ åŸºæœ¬æ¦‚å¿µé¦–å…ˆå­¦ä¹ ä¸€ä¸ªæŠ€æœ¯é¦–å…ˆè¦çœ‹çœ‹å®ƒçš„æ•´ä½“æž¶æž„å’ŒåŸºæœ¬æ¦‚å¿µï¼Œæ¯ä¸ªæŠ€æœ¯éƒ½æœ‰ç€è‡ªå·±çš„åè¯è§£é‡Šå’Œå®žçŽ°æ–¹å¼ï¼Œå¦‚æžœæ–‡æ¡£é½å…¨å°±ç®€å•å¾ˆå¤šã€‚ http://dubbo.apache.org/zh-cn/docs/user/preface/background.html å¤§è‡´æµè§ˆäº†èƒŒæ™¯ã€éœ€æ±‚ã€æž¶æž„ä¹‹åŽåŸºæœ¬ä¸Šæœ‰ä¸€ä¸ªå¤§è‡´æ¦‚å¿µ å…¶å®žæ•´ä½“æž¶æž„å’Œå¾ˆå¤šå¾®æœåŠ¡çš„æž¶æž„éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œå°±æ˜¯æœ‰ä¸€ä¸ªæ³¨å†Œä¸­å¿ƒç®¡ç†æ‰€æœ‰çš„æœåŠ¡åˆ—è¡¨ï¼ŒæœåŠ¡æä¾›æ–¹å…ˆå‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œï¼Œè€Œæ¶ˆè´¹æ–¹å‘æ³¨å†Œä¸­å¿ƒè¯·æ±‚æœåŠ¡åˆ—è¡¨ï¼Œé€šè¿‡æœåŠ¡åˆ—è¡¨è°ƒç”¨æœ€ç»ˆçš„æœåŠ¡ã€‚æ€»çš„æ¥è¯´ dubbo å°†æ•´ä¸ªè¿‡ç¨‹å°è£…åœ¨äº†é‡Œé¢ï¼Œè€Œä½œä¸ºä½¿ç”¨è€…çš„æˆ‘ä»¬æ¥è¯´æ›´åŠ å…³å¿ƒä¸šåŠ¡å®žçŽ°ï¼Œå®ƒå¸®æˆ‘ä»¬åšå¥½äº†æ²»ç†çš„å·¥ä½œã€‚ ç„¶åŽæˆ‘æŠ“ä½äº†å‡ ä¸ªæˆ‘æƒ³è¦çŸ¥é“çš„é‡ç‚¹ï¼š æ³¨å†Œä¸­å¿ƒå¯æ›¿æ¢ï¼Œå®˜æ–¹æŽ¨èçš„æ˜¯ zk å¦‚æžœæœ‰å˜æ›´ï¼Œæ³¨å†Œä¸­å¿ƒå°†åŸºäºŽé•¿è¿žæŽ¥æŽ¨é€å˜æ›´æ•°æ®ç»™æ¶ˆè´¹è€…ï¼Œæ³¨å†Œä¸­å¿ƒï¼ŒæœåŠ¡æä¾›è€…ï¼ŒæœåŠ¡æ¶ˆè´¹è€…ä¸‰è€…ä¹‹é—´å‡ä¸ºé•¿è¿žæŽ¥ åŸºäºŽè½¯è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œé€‰ä¸€å°æä¾›è€…è¿›è¡Œè°ƒç”¨ï¼Œå¦‚æžœè°ƒç”¨å¤±è´¥ï¼Œå†é€‰å¦ä¸€å°è°ƒç”¨ æ¶ˆè´¹è€…åœ¨æœ¬åœ°ç¼“å­˜äº†æä¾›è€…åˆ—è¡¨ å®žé™…ä¸Šæ‰‹å®˜ç½‘æ–‡æ¡£ä¸­ä¹Ÿç»™å‡ºå¦‚æžœä½¿ç”¨ golang å¼€å‘ï¼Œé‚£ä¹ˆæœ‰ https://github.com/apache/dubbo-go å¯ä»¥ç”¨ï¼Œé‚£ä¹ˆåºŸè¯ä¸å¤šè¯´ï¼Œä¸Šæ‰‹å®žè·µä¸€æŠŠå…ˆã€‚å› ä¸ºä½ çœ‹å†å¤šï¼Œéƒ½æ¯”ä¸ä¸Šå®žè·µä¸€æŠŠæ¥å­¦çš„å¿«ã€‚ çŽ¯å¢ƒæ­å»ºå¤§å¤šæ•°æ•™ç¨‹å°±ä¼šè·Ÿä½ è¯´ï¼Œä¸€ä¸ª helloWorld éœ€è¦ zookeeper çŽ¯å¢ƒï¼Œä½†æ˜¯ä¸å‘Šè¯‰ä½ å¦‚ä½•æ­å»ºï¼Œå› ä¸ºè¿™å¯¹äºŽä»–ä»¬æ¥è¯´å¤ªç®€å•äº†ï¼Œè€Œæˆ‘ä¸ä¸€æ ·ï¼Œæˆ‘æ˜¯ 0 åŸºç¡€ï¼Œé‚£å¦‚ä½•å¿«é€Ÿæ­å»ºä¸€ä¸ªéœ€è¦è°ƒç ”é¡¹ç›®çš„çŽ¯å¢ƒå‘¢ï¼Ÿæœ€å¥½çš„æ–¹å¼å°±æ˜¯ dockerã€‚ 12345678910111213141516version: '3'services: zookeeper: image: zookeeper ports: - 2181:2181 admin: image: apache/dubbo-admin depends_on: - zookeeper ports: - 8080:8080 environment: - admin.registry.address=zookeeper://zookeeper:2181 - admin.config-center=zookeeper://zookeeper:2181 - admin.metadata-report.address=zookeeper://zookeeper:2181 12345678910111213141516version: '3'services: zookeeper: image: zookeeper ports: - 2181:2181 admin: image: chenchuxin/dubbo-admin depends_on: - zookeeper ports: - 8080:8080 environment: - dubbo.registry.address=zookeeper://zookeeper:2181 - dubbo.admin.root.password=root - dubbo.admin.guest.password=guest ä¸Šé¢ä¸¤ä¸ª docker-compose æ–‡ä»¶ä¸€ä¸ªæ˜¯å®˜æ–¹æä¾›çš„ç®¡ç†å·¥å…·ï¼Œä¸€ä¸ªåŒ…å«çš„æ˜¯ä¸ªäººä¿®æ”¹ä¹‹åŽçš„ç®¡ç†å·¥å…·ï¼Œè®°ä½è¿™é‡Œæœ‰ä¸ªç”¨æˆ·åå¯†ç æ˜¯ root-rootï¼Œçœ‹ä½ å–œæ¬¢ åºŸè¯ä¸å¤šè¯´ï¼Œç›´æŽ¥åˆ›å»º docker-compose.yaml ç„¶åŽ docker-compose up ä½ å°±å¾—åˆ°äº†ä¸€ä¸ªçŽ¯å¢ƒï¼Œæ£’ðŸ‘ æ ·ä¾‹ä¸‹è½½æœ‰çš„æŠ€æœ¯ä¼šç»™å‡ºå®˜æ–¹çš„å®žéªŒæ ·ä¾‹ï¼Œdubbo-go ä¹Ÿä¸ä¾‹å¤– https://github.com/apache/dubbo-samples é‡Œé¢åŒ…å«äº† go å’Œ java çš„æ ·ä¾‹ï¼Œæœ‰äº†å®ƒä½ å°±èƒ½å¿«é€Ÿä¸Šæ‰‹äº†ï¼ŒæŠŠå®ƒä¸‹è½½åˆ°æœ¬åœ° æ ·ä¾‹è¿è¡Œé¦–å…ˆè¦åšçš„ç¬¬ä¸€æ­¥å°±æ˜¯æŠŠ helloworld ç»™è·‘èµ·æ¥ï¼Œè¿›å…¥ golang ç›®å½•ï¼Œé‡Œé¢æœ‰ä¸ª README.md çœ‹ä¸€ä¸‹ã€‚ç„¶åŽå¼€æžã€‚ æ‰“å¼€ä¸€ä¸ªç»ˆç«¯è¿è¡ŒæœåŠ¡æ–¹ 123456export ARCH=macexport ENV=devcd helloworld/dubbo/go-serversh ./assembly/$ARCH/$ENV.shcd ./target/linux/user_info_server-0.3.1-20190517-0930-releasesh ./bin/load.sh start æ‰“å¼€å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œå®¢æˆ·ç«¯ 123456export ARCH=macexport ENV=devcd helloworld/dubbo/go-clientsh ./assembly/$ARCH/$ENV.shcd ./target/linux/user_info_client-0.3.1-20190517-0921-releasesh ./bin/load_user_info_client.sh start å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šå‡ºçŽ°ä¸€äº›è­¦å‘Šï¼Œé—®é¢˜ä¸å¤§ï¼Œå¦‚æžœæˆåŠŸï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯ä¼šæœ‰ä¸€ä¸ªè°ƒç”¨æœåŠ¡ç«¯çš„è¯·æ±‚ï¼Œå¹¶åœ¨æŽ§åˆ¶å°ä¸­ä»¥ç™½è‰²åº•è‰²è¿›è¡Œæ‰“å° java çš„æœåŠ¡ä¹Ÿæœ‰ç›¸å¯¹åº”çš„å¯åŠ¨æ–¹å¼ï¼ŒæŒ‰ç…§ README ä¸­æ‰€è¯´æ˜Žçš„ä¹Ÿå¯ä»¥è¿›è¡Œæ³¨å†Œå’Œè°ƒç”¨ï¼Œå¹¶ä¸” java å’Œ go ä¹‹é—´æ˜¯å¯ä»¥äº’ç›¸è°ƒç”¨çš„ æŸ¥çœ‹æœåŠ¡å› ä¸ºæˆ‘ä»¬éƒ¨ç½²çš„æ—¶å€™æœ‰ä¸€ä¸ª dubbo-admin ç”¨äºŽç®¡ç† zk ä¸Šæ³¨å†Œçš„æœåŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥è®¿é—®æœ¬åœ°çš„ 8080 ç«¯å£çœ‹åˆ°å¯¹åº”çš„æœåŠ¡æƒ…å†µ è‡³æ­¤ä½ åº”è¯¥å·²ç»å¯¹äºŽæ•´ä½“çš„é“¾è·¯è°ƒç”¨æœ‰ä¸€ä¸ªå¤§è‡´çš„è®¤è¯†ï¼Œç»“åˆä¹‹å‰å®˜ç½‘æ–‡æ¡£çš„ä¸­çš„æž¶æž„å›¾ï¼Œåº”è¯¥ä¹Ÿæ¸…æ™°äº†ã€‚ å¦‚ä½•ä½¿ç”¨é‚£ä¹ˆçŽ°åœ¨ä½ å·²ç»è¿è¡Œèµ·æ¥äº†ï¼Œé‚£ä¹ˆåŠ¿å¿…å°±è¦æ¥çœ‹çœ‹å…·ä½“æ˜¯å¦‚ä½•è¿›è¡Œä½¿ç”¨çš„äº†ã€‚ æœåŠ¡ç«¯æœåŠ¡ç«¯ï¼Œä¹Ÿå°±æ˜¯æœåŠ¡æä¾›è€…ï¼› ä½ç½®åœ¨ï¼šdubbo-samples/golang/helloworld/dubbo/go-server/app 1234// å°†æœåŠ¡è¿›è¡Œæ³¨å†Œconfig.SetProviderService(new(UserProvider))// æ³¨å†Œå¯¹è±¡çš„hessianåºåˆ—åŒ–hessian.RegisterPOJO(&amp;User&#123;&#125;) æ˜¯ä¸æ˜¯çœ‹èµ·æ¥å…¶å®žå¾ˆç®€å•ï¼Œå…¶å®žé‡ç‚¹å°±æ˜¯ä¸Šé¢ä¸¤å¥ä»£ç äº† å¯¹äºŽæœåŠ¡æœ¬èº«æ¥è¯´ 12345678910111213type UserProvider struct &#123;&#125;func (u *UserProvider) GetUser(ctx context.Context, req []interface&#123;&#125;) (*User, error) &#123; println("req:%#v", req) rsp := User&#123;"A001", "Alex Stocks", 18, time.Now()&#125; println("rsp:%#v", rsp) return &amp;rsp, nil&#125;func (u *UserProvider) Reference() string &#123; return "UserProvider"&#125; å…¶å®žå°±æ˜¯éœ€è¦å®žçŽ°ä¸‹é¢é‚£ä¸ªæŽ¥å£å°±å¯ä»¥äº† 1234// rpc service interfacetype RPCService interface &#123; Reference() string // rpc service id or reference id&#125; å…¶ä¸­æœ‰ä¸€æ­¥éª¤ä¸è¦å¿˜è®°äº†æ˜¯config.Load()ï¼Œä¼šåŠ è½½é…ç½®æ–‡ä»¶çš„ç›¸å…³é…ç½®ï¼Œä¸ç„¶ä½ ä»¥ä¸ºæ³¨å†Œä¸­å¿ƒçš„åœ°å€ç­‰ç­‰æ˜¯åœ¨å“ªé‡Œé…ç½®çš„å‘¢ï¼Ÿ å®¢æˆ·ç«¯çœ‹äº†æœåŠ¡ç«¯ï¼Œå…¶å®žå®¢æˆ·ç«¯ä¹Ÿå°±å¾ˆç®€å•äº† 12config.SetConsumerService(userProvider)hessian.RegisterPOJO(&amp;User&#123;&#125;) å…¶å®žä¹Ÿæ˜¯å·®ä¸å¤šçš„ï¼Œä¹Ÿéœ€è¦æ³¨å†Œä¸€ä¸ªæ¶ˆè´¹æœåŠ¡ï¼Œå¹¶å°†åºåˆ—åŒ–æ–¹å¼ç»™æ³¨å†Œä¸ŠåŽ» 12user := &amp;User&#123;&#125;err := userProvider.GetUser(context.TODO(), []interface&#123;&#125;&#123;"A001"&#125;, user) ä½¿ç”¨ä¹Ÿå°±å¾ˆç®€å•äº†ï¼ŒåŒæ ·çš„ä¹Ÿéœ€è¦å®žçŽ° Reference æŽ¥å£ 1234567type UserProvider struct &#123; GetUser func(ctx context.Context, req []interface&#123;&#125;, rsp *User) error&#125;func (u *UserProvider) Reference() string &#123; return "UserProvider"&#125; å›žå¤´æƒ³æƒ³å½“æˆ‘ä»¬çœ‹å®Œäº†ä»£ç çš„ä¸Šçš„ä½¿ç”¨ï¼Œå†å›žå¤´æƒ³æƒ³ dubbo çš„ä½œç”¨ï¼Œä½ å°±ä¼šå‘çŽ°å…¶å®ž dubbo å¸®ä½ åšçš„äº‹æƒ…çœŸçš„å±è”½äº†å¾ˆå¤šã€‚ ä½ ä¸éœ€è¦å…³å¿ƒæœåŠ¡æ˜¯æ€Žä¹ˆæ³¨å†Œçš„ ä½ ä¸éœ€è¦å…³å¿ƒæœåŠ¡æ˜¯æ€Žä¹ˆèŽ·å–çš„ ä½ ä¸éœ€è¦å…³ç³»æœåŠ¡æ˜¯æ€Žä¹ˆè°ƒç”¨çš„ ç”šè‡³åºåˆ—åŒ–çš„è¿‡ç¨‹éƒ½æ˜¯åŸºæœ¬é€æ˜Žçš„ æƒ³å¯¹æ¯”æ¥è¯´ï¼Œå¦‚æžœè®©ä½ è‡ªå·±åŽ»æ˜¯å®žçŽ°å¾®æœåŠ¡ï¼Œé‚£æ˜¯ä¸æ˜¯è¯´ï¼Œä½ éœ€è¦å®žçŽ°æœåŠ¡çš„æ‹‰å–ï¼ŒæœåŠ¡çš„è´Ÿè½½å‡è¡¡ï¼ŒæœåŠ¡çš„å‘çŽ°ï¼Œåºåˆ—åŒ–â€¦.. è¿™ä¸‹ä½ åº”è¯¥æ˜Žç™½äº† dubbo æ˜¯åšä»€ä¹ˆçš„ä¹Ÿå°±æ˜Žç™½äº†å®ƒä¸ºä»€ä¹ˆä¼šå‡ºçŽ°äº† å…¶ä»–èƒ½åŠ›å½“ä½ å­¦ä¹ äº†ä¸€ä¸ªæŠ€æœ¯çš„åŸºæœ¬ä½¿ç”¨ä¹‹åŽï¼Œè¦å­¦ä¹ å…¶ä»–çš„èƒ½åŠ›ï¼Œä»¥ä¾¿åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ä¸ä¼šå‡ºçŽ°è‡ªå·±é‡å¤é€ è½®å­æˆ–è€…è¯´æœ‰è½®å­æ²¡ç”¨åˆ°çš„æƒ…å†µï¼Œhttps://github.com/apache/dubbo-samples ä¸æ­¢æœ‰ helloworld è¿˜è¦å¾ˆå¤šåˆ«çš„æ¡ˆä¾‹ä¾›ä½ å‚è€ƒï¼Œä½ å¯ä»¥ç»§ç»­çœ‹çœ‹å¹¶è¿›è¡Œè¯•éªŒã€‚ æ”¯æŒæ‰©å±•https://github.com/apache/dubbo-go åœ¨ Feature list ä¸­åˆ—ä¸¾äº† dubbo-go æ‰€æ”¯æŒçš„ç›¸å…³åŠŸèƒ½ï¼Œæ¯”å¦‚åºåˆ—åŒ–ï¼Œæ¯”å¦‚æ³¨å†Œä¸­å¿ƒï¼Œåœ¨æ¯”å¦‚è¿‡æ»¤å™¨ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä½¿ç”¨ dubbo-go çš„æ—¶å€™ç›¸å…³åŠŸèƒ½éƒ½æ˜¯æ’ä»¶åŒ–çš„ï¼Œæƒ³ç”¨ä»€ä¹ˆå°±çœ‹ä½ è‡ªå·±äº†ï¼Œæ¯”å¦‚æ³¨å†Œä¸­å¿ƒæˆ‘æƒ³ç”¨ etcdï¼Œæ¯”å¦‚è°ƒç”¨çš„åè®®æˆ‘æƒ³æ¢æˆ grpc éƒ½å¯ä»¥ã€‚ ç›¸å…³é—®é¢˜å¯¹äºŽä¸€ä¸ªæŠ€æœ¯è°ƒç ”ï¼Œé‚£ä¹ˆè‚¯å®šä¼šæœ‰ç›¸å…³é—®é¢˜ç­‰ç€ä½ åŽ»å‘çŽ°åŽ»è€ƒè™‘ã€‚ ä¸‹é¢æ˜¯æˆ‘èƒ½æƒ³åˆ°çš„ä¸€äº›é—®é¢˜ï¼š å½“å‰ dubbo-go çš„ç‰ˆæœ¬æœ€é«˜åœ¨ 1.4ï¼Œæ‰€å¯¹åº”çš„ dubbo ç‰ˆæœ¬åº”è¯¥æ˜¯ 2.6.xï¼Œå¦‚æžœè°ƒç”¨æ›´é«˜ç‰ˆæœ¬çš„æœåŠ¡æ˜¯å¦ä¼šæœ‰é—®é¢˜ java å’Œ go ä¹‹é—´äº’ç›¸è°ƒç”¨ï¼Œå„ç§ç±»åž‹è½¬æ¢ä¹‹é—´æ˜¯å¦å­˜åœ¨é—®é¢˜ï¼Œæ˜¯å¦å®¹æ˜“å‡ºçŽ°æ— æ³•æ­£ç¡®ååºåˆ—åŒ–çš„é—®é¢˜ â€¦. åŽç»­å­¦ä¹ é‚£ä¹ˆä¸Šé¢åªæ˜¯è¯´èƒ½è®©ä½ ä¸Šæ‰‹ dubbo-goï¼Œä½†æ˜¯å®žé™…ä½¿ç”¨å¯èƒ½å­˜åœ¨è·ç¦»ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿå¦‚æžœä½ åœ¨ä¸åŠ¨é‡Œé¢ä»»ä½•çš„åŽŸç†æƒ…å†µä¸‹ï¼Œé‚£ä¹ˆå¦‚æžœé‡åˆ°é—®é¢˜ï¼Œä½ å¾ˆå¯èƒ½å°±æŸæ‰‹æ— ç­–äº†ã€‚æ¯”å¦‚å¦‚æžœçº¿ä¸ŠæœåŠ¡æ— æ³•æ­£å¸¸å‘çŽ°ï¼Œä½ åº”è¯¥å¦‚ä½•æŽ’æŸ¥ï¼Ÿè°ƒç”¨è¿‡ç¨‹ä¸­å‡ºçŽ°é—®é¢˜å¦‚ä½•å®šä½ï¼Ÿ æ‰€ä»¥åŽç»­ä½ éœ€è¦åšçš„æ˜¯ï¼š çœ‹çœ‹æ•´ä½“è®¾è®¡æž¶æž„å’Œæ€è·¯ï¼Œæ˜Žç™½æ•´æ¡é“¾è·¯è°ƒç”¨è¿‡ç¨‹å’Œè§„åˆ™ å­¦ä¹ å®ƒçš„æŽ¥å£è®¾è®¡ï¼Œä¸ºä»€ä¹ˆåˆ«äººè®¾è®¡çš„æŽ¥å£èƒ½å…¼å®¹é‚£ä¹ˆå¤šçš„æ³¨å†Œä¸­å¿ƒï¼Ÿå¦‚æžœè®©ä½ æ¥è®¾è®¡ä½ æ€Žä¹ˆè®¾è®¡å‘¢ï¼Ÿ æ€§èƒ½ä¹Ÿå¾ˆé‡è¦ï¼Œç½‘ä¸Šè¯´æ€§èƒ½å¾ˆä¸é”™ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿä»€ä¹ˆåœ°æ–¹åšäº†ä¼˜åŒ–ï¼Œè´Ÿè½½å‡è¡¡çš„ç®—æ³•æ˜¯æ€Žä¹ˆæ ·çš„ï¼Œä½ èƒ½è‡ªå®šä¹‰å—ï¼Ÿ æ€»ç»“æ€»çš„æ¥è¯´ï¼Œå¯¹äºŽ dubbo-go æ•´ä½“çš„ä½¿ç”¨ä¸Šè¿˜æ˜¯éžå¸¸å¥½ä¸Šæ‰‹çš„ï¼Œè‡ªå·±æƒ³äº†ä¸€ä¸‹ï¼Œå¦‚æžœå½“å‰é¡¹ç›®æƒ³è¦æŽ¥å…¥çš„è¯ï¼Œä¸»è¦æ˜¯æœåŠ¡çš„æš´éœ²ã€åºåˆ—åŒ–æ–¹å¼ã€é‰´æƒè°ƒæ•´ç­‰å­˜åœ¨å¼€å‘å·¥ä½œã€‚ ä¸Šé¢ç –å¤´ä¹ŸæŠ›çš„å·®ä¸å¤šäº†ï¼Œå¯¹äºŽä½ å¿«é€Ÿä¸Šæ‰‹åº”è¯¥æ²¡æœ‰é—®é¢˜äº†ï¼Œå‰©ä¸‹çš„å°±è¦é ä½ è‡ªå·±äº†ã€‚]]></content>
      <categories>
        <category>dubbo-go</category>
      </categories>
      <tags>
        <tag>dubbo-go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä½ çš„å†…å­˜è¿˜å¥½å—]]></title>
    <url>%2F2020%2F06%2F14%2Flinux%2Fmemory%2F</url>
    <content type="text"><![CDATA[å†…å­˜é—®é¢˜å¾€å¾€æ˜¯çº¿ä¸ŠçŽ¯å¢ƒæœ€å®¹æ˜“å¯¼è‡´çš„é—®é¢˜ï¼Œå› ä¸ºå…¶å®žå¯¹äºŽç¨‹åºæ¥è¯´ï¼Œå†…å­˜æ€»æ˜¯ä¸å¤Ÿç”¨çš„ã€‚è€Œå¤§å¤šæ•°æˆ‘ä»¬åœ¨çº¿ä¸Šé‡åˆ°çš„é—®é¢˜æ€»æ˜¯ä¸€ä¸ªå« OOM çš„ï¼Œå¯¼è‡´è¿™ä¸ªé—®é¢˜çš„åŽŸå› ä¹Ÿæœ‰å¾ˆå¤šï¼Œä»Šå¤©æˆ‘ä»¬å°±æ¥çœ‹çœ‹ï¼Œå¦‚ä½•åœ¨çº¿ä¸Šå®šä½æˆ–è€…æŽ’æŸ¥è¿™æ ·çš„é—®é¢˜ã€‚ è¯Šæ–­æŒ‡æ ‡freeå‘½ä»¤free -h 1234[root@Linkin /]# free -htotal used free shared buff/cache availableMem: 7.6G 326M 6.2G 480K 1.1G 7.0GSwap: 0B 0B 0B æŒ‡æ ‡è¿™ä¸ªå‘½ä»¤å¯ä»¥çœ‹åˆ°å½“å‰è®¾å¤‡çš„å†…å­˜æ€»ä½“ä½¿ç”¨æƒ…å†µï¼Œä»¥åŠå¾ˆæ¸…æ¥šçš„çœ‹åˆ°äº¤æ¢åŒºçš„å†…å­˜ä½¿ç”¨æƒ…å†µ totalï¼šæ€»å†…å­˜ used: å·²ä½¿ç”¨å†…å­˜ï¼ŒåŒ…å«å…±äº«å†…å­˜ free: æœªä½¿ç”¨å†…å­˜ shared: å…±äº«å†…å­˜ buff/cache ç¼“å­˜å’Œç¼“å†²åŒº available æ–°è¿›ç¨‹å¯ç”¨å†…å­˜ topå‘½ä»¤top + M æŒ‡æ ‡123456789101112top - 20:29:20 up 10 min, 1 user, load average: 0.00, 0.09, 0.10Tasks: 92 total, 1 running, 91 sleeping, 0 stopped, 0 zombie%Cpu(s): 0.2 us, 0.2 sy, 0.0 ni, 99.5 id, 0.2 wa, 0.0 hi, 0.0 si, 0.0 stKiB Mem : 7.6/8009024 [|||||||| ]KiB Swap: 0.0/0 [ ] PID USER PR NI VIRT RES SHR S %CPU %MEM TIME+ COMMAND 1001 influxdb 20 0 566444 81360 16180 S 0.3 1.0 0:11.26 influxd 1025 root 20 0 799412 73760 27816 S 0.0 0.9 0:00.76 dockerd 1023 root 20 0 509024 40648 14164 S 0.0 0.5 0:00.37 containerd 1009 root 20 0 574204 17504 6128 S 0.0 0.2 0:00.32 tuned 746 polkitd 20 0 612344 12260 4772 S 0.0 0.2 0:00.03 polkitd top æ€»æ˜¯èƒ½å‘çŽ°ç»å¤§å¤šæ•°çš„é—®é¢˜ï¼ŒæŒ‰ M ä¹‹åŽä¼šæŒ‰ç…§å†…å­˜çš„ä½¿ç”¨æƒ…å†µè¿›è¡ŒæŽ’åºï¼Œä½ å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°å†…å­˜å ç”¨æœ€å¤šçš„è¿›ç¨‹æ˜¯ä»€ä¹ˆã€‚ VIRT è¿›ç¨‹è™šæ‹Ÿå†…å­˜å¤§å° RES å¸¸é©»å†…å­˜ï¼Œå°±æ˜¯å®žé™…ä½¿ç”¨çš„ç‰©ç†å†…å­˜ï¼Œä½†æ˜¯ä¸åŒ…å« Swap å’Œå…±äº«çš„ SHR å…±äº«å†…å­˜ %MEM å†…å­˜ä½¿ç”¨ç™¾åˆ†æ¯” vmstatå‘½ä»¤vmstat -a 5 5 æŒ‡æ ‡12345[root@Linkin ~]# vmstat -a 5 5procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu----- r b swpd free inact active si so bi bo in cs us sy id wa st 1 0 0 5970260 487444 1006228 0 0 1 3 4 8 0 0 100 0 0 0 0 0 5970260 487448 1006336 0 0 0 30 588 1132 0 0 100 0 0 si: æ¯ç§’ä»Žäº¤æ¢åŒºå†™åˆ°å†…å­˜çš„å¤§å° so: æ¯ç§’å†™å…¥äº¤æ¢åŒºçš„å†…å­˜å¤§å° inact: éžæ´»è·ƒå†…å­˜å¤§å° active: æ´»è·ƒçš„å†…å­˜å¤§å° è¿™ä¸ªå‘½ä»¤å¯ä»¥æ¸…æ¥šçœ‹åˆ°å½“å‰æ˜¯å¦æœ‰äº¤æ¢åŒºçš„æ¢å…¥å’Œæ¢å‡ºï¼Œå¹¶ä¸”èƒ½è®°å½•ä¸‹å˜åŒ–è¿‡ç¨‹ï¼Œè¿˜æœ‰æ´»è·ƒå’Œéžæ´»è·ƒçš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼›åŒæ—¶èƒ½çœ‹åˆ° CPU å’Œ IO çš„æƒ…å†µï¼Œé¡ºä¾¿çœ‹çœ‹æ˜¯å¦ç”±å…¶ä»–é—®é¢˜å¯¼è‡´ã€‚ æŽ’æŸ¥æ­¥éª¤å…¶å®žå†…å­˜é—®é¢˜çš„æŽ’æŸ¥å¹¶æ²¡æœ‰ç‰¹åˆ«å¤æ‚ï¼Œæˆ‘ä»¬æ‰€è¦åšçš„å°±æ˜¯å®šä½ï¼š ç¡®å®šæ˜¯å¦æœ‰å†…å­˜ä¸æ­£å¸¸ä½¿ç”¨çš„é—®é¢˜ ç¡®å®šæ˜¯ä»€ä¹ˆè¿›ç¨‹æˆ–åº”ç”¨å ç”¨äº†è¿‡å¤šçš„å†…å­˜ï¼Œèƒ½å¦ä¼˜åŒ– é‚£ä¸‹é¢å°±è¯´è¯´æˆ‘ä¸€èˆ¬åœ¨çº¿ä¸ŠæŽ’æŸ¥é—®é¢˜å¸¸ç”¨çš„æ­¥éª¤ï¼Œä»…ä¾›å‚è€ƒ æ³¨æ„é¦–å…ˆè‚¯å®šæ˜¯ç›‘æŽ§ï¼å†…å­˜é—®é¢˜å’Œåˆ«çš„é—®é¢˜ä¸ä¸€æ ·ï¼Œå†…å­˜ä½¿ç”¨è¿‡å¤šä¼šç›´æŽ¥å¯¼è‡´ä¸¥é‡çš„é—®é¢˜ï¼Œåº”ç”¨å¯èƒ½ä¼šç›´æŽ¥æŒ‚ï¼Œæˆ–è€…å½±å“åˆ«çš„åŒæ—¶éƒ¨ç½²çš„åº”ç”¨ï¼Œæ‰€ä»¥åšå¥½ç›‘æŽ§æ˜¯éžå¸¸æœ‰å¿…è¦çš„ã€‚ï¼ˆè¯´ç™½äº†ï¼Œä½ ä¸å¯èƒ½ä¸€ç›´ç›¯ç€å±å¹•çœ‹ï¼Œæœ‰æ—¶å€™ä¸€ä¸ªå³°å€¼å°±æŒç»­ 1 åˆ†é’Ÿå°±è¿‡åŽ»äº†ï¼‰ ç›‘æŽ§å¿™æ—¶å³°å€¼å’Œå¹³å‡å³°å€¼ï¼Œå½“åº”ç”¨æœåŠ¡è¢«é¢‘ç¹è®¿é—®æ—¶å¾€å¾€ä¼šå‡ºçŽ°é—®é¢˜ ç›‘æŽ§é—²æ—¶çš„æ³¢å³°ï¼Œå¦‚æžœåº”ç”¨è®¿é—®ä¸é¢‘ç¹ï¼Œä½†æ˜¯çªç„¶åˆæ³¢å³°å¹¶ä¸”å¾ˆå¤§ï¼Œéœ€è¦æ³¨æ„ä¸‹ ç›‘æŽ§æŒç»­ä¸Šæ¶¨æƒ…å†µï¼Œæœ‰çš„åº”ç”¨éƒ¨ç½²æ—¶é—´é•¿äº†æ‰ä¼šæ³¨æ„åˆ°æœ‰å†…å­˜æ³„éœ²çš„é—®é¢˜ ä¸ŠåŽ»å°±æ˜¯ freeï¼Œå¦‚æžœå‡ºçŽ°é—®é¢˜ä¸ŠåŽ»ç¬¬ä¸€æ­¥æˆ‘å°±ä¼šæ•²è¿™ä¸ªï¼Œç¡®å®šå½“å‰å†…å­˜ä½¿ç”¨æƒ…å†µ ç„¶åŽå°±æ˜¯ top çœ‹æ˜¯ä¸æ˜¯æˆ‘è‡ªå·±æœåŠ¡å¯¼è‡´çš„ï¼Œæˆ–è€…æ˜¯ç”±äºŽåˆ«çš„ç»„ä»¶å¯¼è‡´çš„ ç”¨ vmstat åšä¸ª30 ç§’çœ‹çœ‹æƒ…å†µï¼Œæ˜¯å¦è¿˜æœ‰ç»§ç»­ä¸Šæ¶¨çš„è¶‹åŠ¿ å¦‚æžœåº”ç”¨å´©æºƒäº†æ€Žä¹ˆåŠžï¼Ÿæœ‰çš„æ—¶å€™å´©æºƒä¹‹åŽåº”ç”¨æœ¬èº«æ—¥å¿—æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œçœ‹èµ·æ¥åƒæ˜¯æ­£å¸¸é€€å‡ºä¸€æ · çœ‹åº”ç”¨æœ¬èº«æ—¥å¿—æ˜¯å¦æ˜¾ç¤º OOM çœ‹ dmesg æ˜¯å¦æ˜¾ç¤º OOM çœ‹ var/log/message æ˜¯å¦æ˜¾ç¤ºäº†é—®é¢˜ çœ‹å´©æºƒå‰åŽçš„è°ƒç”¨æœåŠ¡æ—¥å¿—ï¼Œçœ‹æ˜¯å¦ç”±äºŽå¯¹åº”æœåŠ¡ä¸šåŠ¡é—®é¢˜å¯¼è‡´ å¦‚æžœæ˜¯è‡ªèº«æœåŠ¡å¯¼è‡´ï¼Œæ ¹æ®å…·ä½“ä¸šåŠ¡åˆ†æž æŽ’æŸ¥åŽŸå› å†…å­˜çš„å‡ºçŽ°é—®é¢˜çš„åŽŸå› æœ‰å¾ˆå¤šï¼Œå¤§å¤šæ•°éƒ½å’Œå…·ä½“ä¸šåŠ¡ç›¸å…³ï¼Œè¿™é‡Œä¹Ÿæ²¡æœ‰åŠžæ³•è¿›è¡Œç½—åˆ—ï¼Œä¸¾å‡ ä¸ªæœ€å¸¸è§çš„æ¡ˆä¾‹ çªç„¶è¿‡å¤§ä¸€èˆ¬æ˜¯ç”±äºŽæ•°æ®é‡è¿‡å¤§ï¼Œæ¯”å¦‚æŸ¥è¯¢æ•°æ®æ—¶æ²¡æœ‰çº¦æŸæœ€å¤§å€¼å¯¼è‡´å°†æ•°æ®åº“å…¨éƒ¨æ•°æ®éƒ½æŸ¥è¯¢å‡ºæ¥ï¼› æˆ–è€…æ˜¯ç”±äºŽä¼ é€’å‚æ•°é—®é¢˜ï¼Œæ¯”å¦‚ä¼ é€’äº†ä¸€ä¸ª 10000000 è¿™æ ·çš„å€¼ï¼Œç„¶åŽç”¨è¿™ä¸ªé•¿åº¦ç›´æŽ¥åŽ»åˆ›å»ºäº†æ•°ç»„æˆ–è€…åˆ«çš„ç±»åž‹ï¼Œè€Œå®žé™…å¹¶æ²¡æœ‰é‚£ä¹ˆå¤šæ•°æ®ï¼Œç»å¸¸å‡ºçŽ°äºŽä¸‰æ–¹è°ƒç”¨æŽ¥å£æ—¶å¯¼è‡´ æ…¢æ…¢å˜å¤§å¦‚æžœæ˜¯ä½¿ç”¨ java æˆ–è€… go è¿™æ ·å¸¦æœ‰ gc çš„è¯­è¨€ä¼šå¥½å¾ˆå¤šï¼Œä½ ä¸ç”¨ä¸»åŠ¨åŽ» free ä½ ä½¿ç”¨çš„å†…å­˜ï¼›ä½†æ˜¯åˆ«å¦„æƒ³ç€æ²¡é—®é¢˜ï¼Œå®žé™…ä¸­å¾ˆå¤šæ—¶å€™ç”¨äºŽæŒ‡é’ˆçš„ä½¿ç”¨ï¼Œæˆ–è€…æ˜¯çº¿ç¨‹çš„ä¸æ–­åˆ›å»ºï¼Œç­‰ç­‰åŽŸå› å¯¼è‡´å¯¹è±¡æ— æ³•è¢« gc ä»Žè€Œä¹Ÿä¼šäº§ç”Ÿå†…å­˜æ³„éœ²ã€‚ è¿˜æœ‰è¿žæŽ¥æ± æ²¡æœ‰è®¾ç½®æœ€å¤§ä¸Šé™ï¼Œä¹Ÿä¼šæœ‰å¯èƒ½æ…¢æ…¢å˜å¤§ã€‚ å†…å­˜ç¼“å­˜æœ‰æ—¶å€™åº”ç”¨ä¼šç¼“å­˜ä¸€äº›æ•°æ®åˆ°å†…å­˜ä¸­ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¼šç¼“å­˜å¾ˆå¤§çš„æ•°æ®ï¼Œå¯èƒ½å°±æ˜¯ä¸€äº›çƒ­ç‚¹æ•°æ®ç­‰ï¼Œå¤§å¤šæ—¶å€™ç¼“å­˜å¤§æ•°æ®é‡çš„æ—¶å€™ä¹Ÿä¼šè€ƒè™‘ä½¿ç”¨ redisï¼Œä½†è¿˜æ˜¯ä¼šå‡ºçŽ°ä½¿ç”¨å†…å­˜ç¼“å­˜ä¸€äº› map çš„æ—¶å€™ç”±äºŽç”¨æˆ·é‡çªç„¶ä¸Šæ¥ï¼Œå¯¼è‡´å†…å­˜å ç”¨è¿‡å¤šçš„æƒ…å†µå‘ç”Ÿã€‚ å®šæ—¶ä»»åŠ¡æœ‰æ—¶å€™ä¸€äº›åº”ç”¨è®¿é—®å¹¶ä¸å¤šï¼Œä½†æ˜¯å†…å­˜å ç”¨å¾€å¾€åœ¨ä¸€æ®µæ—¶é—´ä¹‹åŽå°±ä¼šå˜å¤§ä¸”æ— æ³•é‡Šæ”¾ï¼Œæœ‰äº›æ—¶å€™å°±æ˜¯ç”±äºŽå†…éƒ¨çš„ä¸€äº›å®šæ—¶ä»»åŠ¡æˆ–è€…å®šæ—¶å™¨å¯¼è‡´å†…å­˜ä½¿ç”¨åŽæ²¡è¿˜å¯¼è‡´çš„ã€‚å¤šè§äºŽä¸€äº›éœ€è¦è®¾å®šè¶…æ—¶æ—¶é—´ï¼Œä½†æ˜¯è¶…æ—¶æ—¶é—´åˆæ²¡æœ‰è®¾å®šé»˜è®¤å€¼çš„æƒ…å†µã€‚ ä½¿ç”¨ swapæœ‰æ—¶å†…å­˜çªç„¶çš„ä¸Šå‡ä¼šå¯¼è‡´å†…æ ¸è¢«è¿«å¼€å§‹ä½¿ç”¨ swapï¼Œé‚£ä¹ˆä½¿ç”¨ swap å…¶å®žå°±å·²ç»æ„å‘³ç€ä½ æ­£åœ¨å±é™©çš„è¾¹ç¼˜å¾˜å¾Šäº†ï¼Œè€Œä¸”ä½¿ç”¨ swap å¾€å¾€æ€»ä¼´éšä¸€äº› IO é—®é¢˜ã€‚é™„èµ ä¸€ä¸ªå‘½ä»¤swapoff -a &amp;&amp; swapon -a è™šæ‹Ÿå†…å­˜å’Œç¼“å­˜è¿™ä¸ªä¸æ˜¯ä¸ªé—®é¢˜ï¼Œä½†æ˜¯éœ€è¦æä¸€å¥ï¼Œæœ‰çš„æ—¶å€™æœ‰äººä¼šçœ‹åˆ° VIRT å ç”¨å¾ˆå¤šï¼Œæˆ–è€…ç¼“å­˜å’Œç¼“å†²å ç”¨å¾ˆå¤šï¼Œå…¶å®žè¿™ä¸ªé—®é¢˜éƒ½ä¸å¤§ã€‚è™šæ‹Ÿå†…å­˜ä½ å äº†ä½†æ˜¯å¹¶æ²¡æœ‰å®žé™…åˆ†é…ï¼Œç¼“å­˜å’Œç¼“å†²å¾€å¾€éƒ½æ˜¯å†…æ ¸ä¸ºäº†åŠ å¿«è®¿é—®è€Œåšçš„ï¼Œå½“å†…å­˜ä¸å¤Ÿæ—¶ä¼šä¸»åŠ¨è¿›è¡Œé‡Šæ”¾ä¸ç”¨æ‹…å¿ƒã€‚ æ€»ç»“å†…å­˜é—®é¢˜ä¸€èˆ¬å°±ä¸¤ç§ï¼š ä¸€ç§ä½ æ˜¯å¹²çš„ï¼ˆæˆ‘å°±è¦éœ€è¦é‚£ä¹ˆå¤šå†…å­˜ä½†å…¶å®žä½ æ²¡æœ‰ï¼‰ ä¸€ç§ä½ æ— æ„è¯†å¹²çš„ï¼ˆæˆ‘ä¸ç”¨é‚£ä¹ˆå¤šä½†æ˜¯å®žé™…ç”¨äº†æ²¡è¿˜ï¼‰ å½“å‡ºçŽ°å†…å­˜é—®é¢˜æ—¶è¿˜æ˜¯è¦å¤šåŠ æ³¨æ„ï¼Œé’ˆå¯¹ä¸åŒçš„è¯­è¨€ä¹Ÿæœ‰ä¸åŒçš„å¤„ç†æ€è·¯ï¼Œjava çœ‹çœ‹è™šæ‹Ÿæœºï¼Œgo çœ‹çœ‹ pprof ç­‰ç­‰ã€‚]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>å†…å­˜</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Golang ç›‘æŽ§å…¨å±€å˜é‡]]></title>
    <url>%2F2020%2F06%2F13%2Fgolang%2Fbasic%2Fvars%2F</url>
    <content type="text"><![CDATA[ä½ æ˜¯å¦æ›¾ç»é‡åˆ°è¿‡è¿™æ ·çš„æƒ…å†µï¼Œåœ¨å¼€å‘çŽ¯å¢ƒæŽ’æŸ¥é—®é¢˜ï¼Œå› ä¸ºä¸€äº›æ•°æ®ä¿å­˜åœ¨äº†ä¸€äº›å…¨å±€å˜é‡ä¸­ï¼Œè¿™äº›å˜é‡å¾€å¾€æ˜¯ä¸€ä¸ª map æˆ–è€…æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæƒ³çœ‹çœ‹åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œè¿™é‡Œé¢ç©¶ç«Ÿå­˜æ”¾äº†ä»€ä¹ˆæ•°æ®ï¼Œæœ‰æ—¶ä¸å¾—ä¸åœ¨è¿è¡Œçš„æ—¶å€™å°†å®ƒè¾“å‡ºåˆ°æ—¥å¿—ä¸­ï¼Œé‚£ä¹ˆå¦‚æžœæˆ‘æƒ³å®žæ—¶çœ‹åˆ°è¿™äº›æ•°æ®çš„æƒ…å†µåˆæ€Žä¹ˆåŠžå‘¢ï¼Ÿ å…¶å®ž golang ä¸­å·²ç»å­˜åœ¨è¿™æ ·çš„åº“ï¼Œå°±æ˜¯æ¥åšè¿™ä¸ªäº‹æƒ…çš„ expvar ä½¿ç”¨æ¡ˆä¾‹åºŸè¯ä¸å¤šæ•°ï¼Œç›´æŽ¥ä¸Šæ¡ˆä¾‹ 1234567891011121314151617181920212223242526272829303132333435363738package mainimport ( "expvar" "net/http")var ( s map[string]string user User)type User struct &#123; Name string `json:"name"` Age int `json:"age"`&#125;func showMap() interface&#123;&#125; &#123; return s&#125;func showUser() interface&#123;&#125; &#123; return user&#125;func main() &#123; user.Name = "tom" user.Age = 18 s = make(map[string]string, 10) s["1"] = "111" s["2"] = "222" expvar.Publish("a_map", expvar.Func(showMap)) expvar.Publish("b_user", expvar.Func(showUser)) http.HandleFunc("/test", func(writer http.ResponseWriter, request *http.Request) &#123; s["3"] = "333" &#125;) http.ListenAndServe(":8080", nil)&#125; ç›‘æŽ§å˜é‡ç›´æŽ¥è®¿é—® http://127.0.0.1:8080/debug/vars ä½ å°±èƒ½çœ‹åˆ°ä¸€ä¸ª json æ ¼å¼çš„è¿”å›žæ•°æ®ï¼Œæ•°æ®å¦‚ä¸‹æ‰€ç¤ºï¼š 12345678910111213141516171819202122232425262728293031323334353637383940&#123; "a_map": &#123; "1": "111", "2": "222" &#125;, "b_user": &#123; "name": "tom", "age": 18 &#125;, "cmdline": [ "/private/var/folders/37/qpz6_ndd1w72bhrg2sgg042r0000gn/T/___go_build_go_demo_vars" ], "memstats": &#123; "Alloc": 188992, "TotalAlloc": 188992, "Sys": 70453248, "Lookups": 0, "Mallocs": 818, "Frees": 21, "HeapAlloc": 188992, "HeapSys": 66650112, "HeapIdle": 65716224, "HeapInuse": 933888, "HeapReleased": 65683456, "HeapObjects": 797, "StackInuse": 458752, "StackSys": 458752, "MSpanInuse": 15776, "MSpanSys": 16384, "MCacheInuse": 6944, "MCacheSys": 16384, "BuckHashSys": 2638, "GCSys": 2240512, "OtherSys": 1068466, "NextGC": 4473924, "LastGC": 0, "PauseTotalNs": 0, ...... &#125;&#125; è¿™é‡Œé¢ä¸€æ–¹é¢å°†ä½ çš„åœ¨ä»£ç ä¸­å…¨å±€å˜é‡æ˜¾ç¤ºäº†å‡ºæ¥è¿˜æœ‰ä¸ª cmdline å’Œ memstats è¿™ä¸ªæˆ‘ä»¬åŽé¢å†è¯´ è¿™æ˜¯ä½ å¯ä»¥è®¿é—®ä¸€æ¬¡ http://127.0.0.1:8080/test ç„¶åŽå†å›žæ¥çœ‹çœ‹ï¼Œå°±ä¼šå‘çŽ°å˜é‡çš„å€¼ä»¥åŠæ”¹å˜ï¼Œè¯´æ˜Žè¿™ä¸ªå˜é‡æ˜¾ç¤ºçš„æ˜¯å®žæ—¶çš„ ç›‘æŽ§åŽŸç†å…¶å®žåŽŸç†éžå¸¸ç®€å•ï¼Œä½ è‡ªå·±éƒ½èƒ½å†™ï¼Œä¸‹é¢å°±æ˜¯æºç ä¸­çš„ä¸€éƒ¨åˆ† 12345678910111213141516171819202122// Handler returns the expvar HTTP Handler.//// This is only needed to install the handler in a non-standard location.func Handler() http.Handler &#123; return http.HandlerFunc(expvarHandler)&#125;func cmdline() interface&#123;&#125; &#123; return os.Args&#125;func memstats() interface&#123;&#125; &#123; stats := new(runtime.MemStats) runtime.ReadMemStats(stats) return *stats&#125;func init() &#123; http.HandleFunc("/debug/vars", expvarHandler) Publish("cmdline", Func(cmdline)) Publish("memstats", Func(memstats))&#125; å…¶å®žå°±æ˜¯åœ¨ init çš„æ—¶å€™æ³¨å†Œäº†å¯¹åº”çš„è·¯ç”±ï¼Œè¿˜æ³¨å†Œäº† cmdline å’Œ memstats ä¸¤ä¸ªå€¼ï¼Œè¿™ä¸¤ä¸ªå€¼å¾ˆæœ‰ç”¨ï¼š cmdline å±•ç¤ºäº†å½“å‰å¯åŠ¨æ—¶é€šè¿‡å‘½ä»¤è¡Œä¼ é€’çš„å‚æ•°æ˜¯ä»€ä¹ˆ memstats å±•ç¤ºäº†å½“å‰è¿è¡Œæ—¶å†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œè¿˜æœ‰ gc çš„éƒ¨åˆ†ä¿¡æ¯ç­‰ç­‰ å…¶ä»–æ–¹æ³•https://golang.org/pkg/expvar/ å½“ç„¶è¿™ä¸ªåŒ…ä¸æ­¢æœ‰ Publish æ–¹æ³•ï¼Œè¿˜æœ‰ Addã€Set ç­‰ç­‰ï¼Œä¸ªäººæœ€å¸¸ç”¨çš„è¿˜æ˜¯ Publish ç›‘æŽ§å†…å­˜å¹¶å±•ç¤ºæ—¢ç„¶ expvar æš´éœ²äº†å†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œé‚£æˆ‘ä»¬å½“ç„¶èƒ½åˆ©ç”¨è¿™ä¸ªä¿¡æ¯æ¥ä½œå›¾äº†ï¼Œæ‰€ä»¥å°±æŽ¨èä¸€ä¸ªå¾ˆå¥½ç”¨çš„åº“ https://github.com/rs/jplot å®‰è£…ä¹‹åŽï¼Œå°±å¯ä»¥ç”¨å‘½ä»¤é€šè¿‡ä¹‹å‰çš„æŽ¥å£æ¥ç›‘æŽ§å†…å­˜ç­‰ä½¿ç”¨æƒ…å†µå’¯ 12345jplot --url http://127.0.0.1:8080/debug/vars \ memstats.HeapSys+memstats.HeapAlloc+memstats.HeapIdle+marker,counter:memstats.NumGC \ counter:memstats.TotalAlloc \ memstats.HeapObjects \ memstats.StackSys+memstats.StackInuse æˆ‘è§‰å¾—è¿™æ ·çš„ä½¿ç”¨æ–¹å¼åœ¨æœ¬åœ°å’Œå¼€å‘çŽ¯å¢ƒçš„æ—¶å€™æµ‹è¯•æ›´åŠ è½»é‡ï¼Œä¸ç”¨éƒ¨ç½²ä¸€äº›ç›‘æŽ§è½¯ä»¶ï¼Œå³å¼€å³æµ‹ï¼›å½“ç„¶çº¿ä¸ŠçŽ¯å¢ƒè‚¯å®šä¼šæœ‰ prometheus + grafana è¿™æ ·çš„ç›‘æŽ§ç¥žå™¨ï¼Œè¿™é‡Œä¹Ÿåªæ˜¯æŠ›ä¸ªç –å¤´ã€‚ æ€»ç»“å¦‚æžœçº¿ä¸Šéœ€è¦ç›‘æŽ§ä¸€äº›å…¨å±€å˜é‡çš„ä½¿ç”¨æƒ…å†µå¯ä»¥è€ƒè™‘ä½¿ç”¨ expvar è¿›è¡Œç›‘æŽ§å’ŒæŸ¥çœ‹ï¼Œæˆ–è€…ç”¨å®ƒæ¥ç›‘æŽ§ä½ çš„é…ç½®æ–‡ä»¶æˆ–è€…ä¸€äº›ä»»åŠ¡æ•°é‡ç­‰ç­‰ä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚]]></content>
      <categories>
        <category>golangåŸºç¡€</category>
      </categories>
      <tags>
        <tag>vars</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä½ çš„ CPU è¿˜å¥½å—]]></title>
    <url>%2F2020%2F06%2F06%2Flinux%2Fcpu%2F</url>
    <content type="text"><![CDATA[æœ€è¿‘ç»å¸¸åœ¨çº¿ä¸ŠæŽ’æŸ¥ä¸€äº›é—®é¢˜ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œéƒ½æ˜¯ä»£ç å†™çš„ä¸šåŠ¡é€»è¾‘æœ‰é—®é¢˜ï¼›è¿˜æœ‰ä¸€äº›æƒ…å†µæ˜¯å†…å­˜ä¸Šå¯¼è‡´çš„é—®é¢˜ï¼Œå¦‚ OOM æˆ–è€…ç”±äºŽæ•°æ®é‡å¤§å¯¼è‡´çš„ä¸€äº›é—®é¢˜ï¼›ä½†æ˜¯å¾ˆå°‘ä¼šå…³æ³¨ï¼Œä½†å¸¸å¸¸åˆä¼šçžŸä¸€çœ¼çš„ï¼Œè¿™ä¸ªå…³æ³¨ç‚¹å°±æ˜¯ CPUã€‚ åœ¨è¯´åˆ° CPU çš„æ—¶å€™å¾€å¾€é™¤äº† top çœ‹ä¸€ä¸‹ CPU ä½¿ç”¨çŽ‡ä¹‹å¤–ï¼Œä½ è¿˜ä¼šå…³æ³¨åˆ«çš„ä»€ä¹ˆå—ï¼Ÿå¥½åƒä¹Ÿä¸ä¼šã€‚ ä½†æ˜¯å…¶å®žå½“çœŸæ­£å‡ºçŽ°é—®é¢˜çš„æ—¶å€™ï¼Œå¾ˆå¤š CPU ç›¸å…³çš„æŒ‡æ ‡éƒ½ä¼šåæ˜ å‡ºä¸€äº›é—®é¢˜ï¼Œç»è¿‡ä¹‹å‰çš„å­¦ä¹ ä»Šå¤©å°±æ¥æ€»ç»“è®°å½•ä¸€ä¸‹ã€‚ è¯Šæ–­æŒ‡æ ‡å¹³å‡è´Ÿè½½å®šä¹‰ç³»ç»Ÿå¤„äºŽå¯è¿è¡ŒçŠ¶æ€å’Œä¸å¯ä¸­æ–­çŠ¶æ€çš„å¹³å‡è¿›ç¨‹æ•°ï¼Œä¹Ÿå°±æ˜¯å¹³å‡æ´»è·ƒè¿›ç¨‹æ•°ï¼ˆå•ä½æ—¶é—´å†…æ´»è·ƒè¿›ç¨‹æ•°ï¼‰ æŸ¥çœ‹ uptime top æŒ‡æ ‡å½“å¹³å‡è´Ÿè½½é«˜äºŽ CPU æ•°é‡çš„ 70% å¯èƒ½å°±æœ‰é—®é¢˜äº†ï¼ˆåœ¨å®žé™…ä¸­å¦‚æžœä½ çœ‹åˆ°å¹³å‡è´Ÿè½½çªç„¶å‡é«˜ï¼Œä¹Ÿå°±æ˜¯ä¸‰ä¸ªå€¼å‘ˆçŽ°é€’å‡çš„è¶‹åŠ¿ï¼Œå°±éœ€è¦è€ƒè™‘ CPU é—®é¢˜äº†ï¼‰ CPU ä½¿ç”¨çŽ‡å®šä¹‰é™¤äº†ç©ºé—²æ—¶é—´å¤–çš„å…¶ä»–æ—¶é—´å æ€» CPU æ—¶é—´çš„ç™¾åˆ†æ¯” æŸ¥çœ‹ top ps mpstat -P ALL 5 pidstat æŒ‡æ ‡è¿™ä¸ªå…¶å®žä¸ç”¨è¯´ä½ å°±æœ‰æ„Ÿè§‰çš„ï¼Œå¦‚æžœä½ çœ‹åˆ°ä½ çš„ç¨‹åºå ç”¨äº† 30%CPU ä½¿ç”¨çŽ‡ï¼Œè€Œåˆ«äººéƒ½æ²¡å¾—ç”¨ï¼Œé‚£å°±è‚¯å®šå¥‡æ€ªäº† ä¸Šä¸‹æ–‡åˆ‡æ¢å®šä¹‰å°†å‰ä¸€ä¸ªä»»åŠ¡çš„ CPU ä¸Šä¸‹æ–‡ä¿å­˜èµ·æ¥ï¼Œç„¶åŽåŠ è½½åˆ«çš„ä»»åŠ¡çš„ä¸Šä¸‹æ–‡å¹¶æ‰§è¡Œ æŸ¥çœ‹ vmstat 5 pidstat -w cat /proc/interrupts æŒ‡æ ‡ä¸Šä¸‹æ–‡åˆ‡æ¢å®¹æ˜“è¢«å¿½ç•¥ï¼Œå¾ˆå¤šæ—¶å€™å¹¶ä¸ä¼šçœ‹è¿™ä¸ªï¼›ä¸€èˆ¬å½“ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°è¶…è¿‡ä¸€ä¸‡æ¬¡ï¼Œæˆ–è€…åˆ‡æ¢æ¬¡æ•°å‡ºçŽ°æ•°é‡çº§çš„å¢žé•¿æ—¶ï¼Œå¾ˆå¯èƒ½å°±å­˜åœ¨é—®é¢˜äº†ã€‚ å¦‚æžœæ˜¯è‡ªæ„¿ä¸Šä¸‹æ–‡åˆ‡æ¢å¤šï¼Œé‚£ä¹ˆè€ƒè™‘ I/O ã€å†…å­˜ç­‰èµ„æºä¸å¤Ÿå¯¼è‡´ï¼›å¦‚æžœæ˜¯éžè‡ªæ„¿åˆ‡æ¢å¤šï¼Œé‚£ä¹ˆè€ƒè™‘ CPU æ€§èƒ½ç“¶é¢ˆ æŽ’æŸ¥æ­¥éª¤çœ‹äº†é‚£ä¹ˆå¤šæŒ‡æ ‡ï¼Œæˆ‘æƒ³ä½ ä¹Ÿè‚¯å®šå¤´æ™•ï¼Œæˆ‘æ€»ä¸èƒ½æ¯æ¬¡åˆ°æœåŠ¡å™¨ä¸Šæƒ³çœ‹çœ‹æœ‰æ²¡æœ‰é—®é¢˜ï¼Œå°±æŠŠæ‰€æœ‰å‘½ä»¤å…¨éƒ¨ä¸€è‚¡è„‘æ•²ä¸€éå§ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬ä¸€èˆ¬é‡åˆ° CPU çš„é—®é¢˜æ¯”è¾ƒå°‘ï¼Œå…¶æ¬¡æˆ‘ä¸‹é¢ä»Žä¸€ä¸ªå¼€å‘çš„è§†è§’ï¼ˆè¿ç»´è‚¯å®šä¼šæ›´ä¸“ä¸šï¼‰ï¼Œæ¥è¯´ä¸‹æˆ‘ä¸€èˆ¬çš„æŽ’æŸ¥æ­¥éª¤ï¼Œä»…ä¾›å‚è€ƒã€‚ ç›‘æŽ§å‘Šè­¦ï¼Œä¸€èˆ¬å¤§å…¬å¸æˆ–è€…äº‘åŽ‚å•†éƒ½æœ‰æœåŠ¡å™¨ç›‘æŽ§ï¼Œç›‘æŽ§é¡¹è‚¯å®šåŒ…å« CPUï¼Œå¦‚æžœæœ‰è‚¯å®šæ˜¯è¦å…ˆçœ‹ä¸‹ç›‘æŽ§æ•°æ® çœ‹æœåŠ¡å™¨å¡ä¸å¡ï¼Œä½ è¦æ˜¯æ•²ä¸ªå‘½ä»¤å“åº”åŠå¤©ï¼ŒæŽ’é™¤ä½ ç½‘ç»œå¡çš„åŽŸå› ï¼Œé‚£ä¹ˆå¤šåŠæ˜¯æœåŠ¡å™¨è¦ä¸è¡Œäº† ç¡®å®šå½“å‰åŽ‹åŠ›ï¼Œå½“å‰ç”¨æˆ·è®¿é—®é¢‘ç¹ï¼ˆæœ¬èº«åŽ‹åŠ›å°±å¾ˆå¤§ï¼‰æˆ–è€…è¯´å½“å‰åªæœ‰å‡ åä¸ªç”¨æˆ·è®¿é—®ï¼ˆå¹³å³°çŠ¶æ€ï¼‰ uptimeï¼Œtop çœ‹å¹³å‡è´Ÿè½½å’Œä½¿ç”¨çŽ‡ï¼Œå¦‚æžœæ²¡é—®é¢˜ï¼Œä¸€èˆ¬å°±å¯ä»¥å…ˆè€ƒè™‘åˆ«çš„å› ç´ äº† å¦‚æžœç¡®å®žåœ¨æ²¡ä»€ä¹ˆç”¨æˆ·è®¿é—®çš„æƒ…å†µä¸‹ä½¿ç”¨çŽ‡é«˜ï¼Œpidstat çœ‹ä¸€çœ¼ä¸­æ–­ï¼Œçœ‹ä¸€çœ¼åˆ‡æ¢ å¦‚æžœè®¤ä¸ºç¡®å®žæœ‰é—®é¢˜çœ‹ä¸€çœ¼ psï¼Œçœ‹ä¸€çœ¼ç½‘ç»œï¼Œçœ‹ä¸€çœ¼ç³»ç»Ÿè°ƒç”¨ï¼ŒåŸºæœ¬å°±èƒ½ç¡®å®šå¤§è‡´é—®é¢˜äº† é—®é¢˜åŽŸå› é‚£ä¹ˆç©¶å…¶æ ¹æœ¬è‚¯å®šæ˜¯ä½ ä»£ç å†™çš„æœ‰é—®é¢˜~ å¾ˆå°‘è¯´æœåŠ¡å™¨ CPU åäº†å¯¼è‡´é—®é¢˜å§ï¼Œè‡³å°‘æˆ‘æ˜¯è¿˜æ²¡è§åˆ°è¿‡ã€‚ æ‰€ä»¥ä¸‹é¢åˆ—å‡ºå½“ CPU å‡ºçŽ°é—®é¢˜æ—¶å¯èƒ½çš„åŽŸå› ï¼ˆåŽŸå› æœ‰å¾ˆå¤šï¼Œè¿™é‡Œåˆ—ä¸¾æˆ‘æ›¾ç»è§è¿‡çš„ï¼‰ æ­»å¾ªçŽ¯è¿™ä¸ªæ˜¯æœ€å¸¸è§çš„ï¼Œä¹Ÿæ˜¯æœ€å®¹æ˜“çŠ¯çš„ï¼Œå¦‚æžœé‚£ä¸ªåœ°æ–¹å·å·ç»™ä½ æŒ–ä¸ªå‘ï¼ŒCPU ç«‹é©¬å°±æœæœçš„ä¸ŠåŽ»äº†ã€‚ ç½‘ç»œè¯·æ±‚å¤§é‡ç½‘ç»œè¯·æ±‚å¯¼è‡´è§¦å‘äº†å¾ˆå¤šä¸­æ–­ï¼Œå°±æ˜¯å¸¸è¯´çš„å°åŒ…é—®é¢˜ï¼Œæˆ–è€…å¸¸è§çš„ SYN FLOOD å®šæ—¶å™¨å¾ˆå¤šç¨‹åºä¸­å®šæ—¶å™¨çš„ä½¿ç”¨ä¹Ÿä¼šé€ æˆ CPU ä½¿ç”¨çŽ‡é«˜ï¼Œè™½ç„¶å¯èƒ½åªæœ‰ 3% è¿™æ ·ã€‚å¸¸è§çš„æƒ…æ™¯æœ‰ï¼šå¤§é‡çš„ä»»åŠ¡æ‰§è¡Œï¼Œæ¯ä¸ªä»»åŠ¡éƒ½æœ‰ä¸€ä¸ªè¶…æ—¶çš„å®šæ—¶å™¨åŽ»è·Ÿè¸ªä»»åŠ¡çš„è¶…æ—¶ã€‚ é¢‘ç¹çš„é”™è¯¯ç³»ç»Ÿè°ƒç”¨æœ‰æ—¶å¯èƒ½ä½ çœ‹åˆ°å¹³å‡è´Ÿè½½é«˜ï¼Œä½†æ˜¯æ‰¾ä¸åˆ°è¿›ç¨‹ã€‚å¯èƒ½ç”±äºŽä½ æ‰§è¡Œä¸€ä¸ªä»€ä¹ˆå‘½ä»¤ï¼Œä½†æ˜¯å‘½ä»¤æ‰§è¡Œå¤±è´¥äº†ï¼Œç„¶åŽä¸åœçš„é‡è¯•å¯¼è‡´ã€‚å…¶ä¸­è§¦å‘çš„é¢‘ç¹çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¯¼è‡´ä¸Šä¸‹æ–‡åˆ‡æ¢é¢‘ç¹ï¼Œä»Žè€Œå‡ºçŽ°é—®é¢˜ã€‚ è¿‡å¤šçš„çº¿ç¨‹æˆ–åç¨‹ä¹Ÿæ›¾é‡åˆ°è¿‡åˆ›å»ºè¿‡å¤šçš„çº¿ç¨‹æˆ–åç¨‹å¯¼è‡´åˆ‡æ¢ä¸è¿‡æ¥çš„æƒ…å†µï¼Œå¹¶ä¸”å‰é¢çš„ä»»åŠ¡åšä¸å®Œï¼ŒåŽé¢çš„ä»»åŠ¡åˆå †ä¸Šæ¥ï¼Œè¶Šæ»šè¶Šå¤§ã€‚è¿™ä¸ªå®¹æ˜“è§£å†³çš„ï¼Œåªè¦æžä¸ªçº¿ç¨‹æ± ï¼Œé™åˆ¶ä¸€ä¸‹æœ€å¤§åŸºæœ¬éƒ½èƒ½è§£å†³ã€‚ I/O æ“ä½œç»•è¿‡ç¼“å­˜ï¼Œç›´æŽ¥è¯»ç£ç›˜ I/Oï¼Œiowait åæ˜ ä¼šå¾ˆæ˜Žæ˜¾ã€‚çŽ°åœ¨å¾ˆå¤šè¯­è¨€éƒ½æœ‰å°è£…åº“ï¼Œæ‰€ä»¥å¹¶ä¸å¸¸è§ã€‚ åƒµå°¸è¿›ç¨‹è¿›ç¨‹å·²ç»ç»“æŸï¼Œä½†æ˜¯çˆ¶è¿›ç¨‹æ²¡æœ‰å›žæ”¶æè¿°ç¬¦ pid ç­‰èµ„æºï¼Œä¸€ç›´ wait ä¸‹åŽ»ã€‚çŽ°åœ¨å¾ˆå¤šè¯­è¨€ä¹Ÿå¾ˆå°‘æœ‰ç›´æŽ¥æ“ä½œ fork çš„çŽ©æ³•ï¼Œå¤šæ•°æƒ…å†µä¸‹æ˜¯çº¿ç¨‹æˆ–åç¨‹æžå®šï¼Œæ‰€ä»¥ Z çŠ¶æ€ä¹Ÿå°‘è§ï¼Œå®žé™…ä¸­å¤šçœ‹çœ‹ D çŠ¶æ€å­˜åœ¨æ—¶é—´å¯èƒ½ä¼šæ‰¾åˆ°é—®é¢˜å…³é”®ã€‚ æ€»ç»“æ€»ç»“ä¸€ä¸‹ï¼Œå¯èƒ½æ€§æ¯”è¾ƒé«˜çš„ CPU é—®é¢˜æƒ…å†µå¤§è‡´å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼š å¼‚æ­¥ä»»åŠ¡çš„ä¸æ­£å¸¸å¤„ç†ï¼ˆè®¿é—®ä¸é¢‘ç¹ä½† CPU é«˜ï¼‰ ç³»ç»Ÿè°ƒç”¨æˆ–ç½‘ç»œè¯·æ±‚çš„ä¸æ­£å¸¸å¤„ç†ï¼ˆé¢‘ç¹è¯·æ±‚å˜å¾—å¾ˆå¡ï¼‰ ä»¥ä¸Šå°±æ˜¯ç›¸å…³ CPU é—®é¢˜çš„æ€»ç»“å’ŒæŽ’æŸ¥æ–¹å¼ï¼Œè™½ç„¶å…·ä½“æƒ…å†µå…·ä½“åˆ†æžï¼Œä½†å¾ˆå¤šæ—¶å€™é‡åˆ°å…·ä½“æƒ…å†µä½ åº”è¯¥çŸ¥é“æ€Žä¹ˆåˆ†æžã€‚]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>cpu</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[python åŸºç¡€è¯­æ³•ç¬”è®°]]></title>
    <url>%2F2020%2F05%2F09%2Fpython%2Fbasic%2Fbasic-grammar%2F</url>
    <content type="text"><![CDATA[è®°å½•pythonçš„ä¸€äº›åŸºç¡€è¯­æ³•ï¼Œç”¨äºŽæŸ¥é˜… åˆ—è¡¨å’Œå…ƒç»„ åˆ—è¡¨å’Œå…ƒç»„éƒ½æ˜¯æœ‰åºçš„ï¼Œå¯ä»¥å­˜å‚¨ä»»æ„æ•°æ®ç±»åž‹çš„é›†åˆ åˆ—è¡¨æ˜¯åŠ¨æ€çš„ï¼Œé•¿åº¦å¯å˜ï¼Œå­˜å‚¨ç©ºé—´å’Œæ€§èƒ½ç•¥é€Šä¸Žå…ƒç»„ å…ƒç»„æ˜¯é™æ€çš„ï¼Œé•¿åº¦å¤§å°å›ºå®šï¼Œä¸èƒ½å¢žåŠ ä¿®æ”¹ åˆ›å»ºä¸€ä¸ªåˆ—è¡¨ä½¿ç”¨ empty_list = [] ç›¸æ¯”äºŽ list() æ›´å¥½ï¼Œå› ä¸º [] åº•å±‚èµ°çš„cï¼Œè€Œ list() æ˜¯å‡½æ•°ï¼Œæ›´åŠ è´µ 1234567891011121314151617181920l = [1, 2, 3, 4]tup = (1, 2, 3, 4)list((1, 2, 3))[1, 2, 3]l.count(3)l.index(7)l.reverse()l.sort()l.append(4)# extendä¼šå°†é‡Œé¢çš„å…ƒç´ æ·»åŠ è¿›åŽ»ï¼Œè€Œappendä¼šç›´æŽ¥å°†[1,2]ä½œä¸ºä¸€ä¸ªå…ƒç´ åŠ å…¥l.extend([1,2])tuple([1, 2, 3])(1, 2, 3)tup.count(3)tup.index(7)list(reversed(tup))sorted(tup) å­—å…¸å’Œé›†åˆæœ¬è´¨å°±æ˜¯hashè¡¨ åˆ é™¤ä¼šèµ‹å€¼ä¸ºç‰¹æ®Šå€¼å¹¶åœ¨rehashè°ƒæ•´å¤§å°çš„æ—¶å€™è¿›è¡Œå¤„ç† ä¼šä¿ç•™1/3çš„å¤§å°ï¼Œå°äºŽæ—¶æ‰©å®¹å¹¶rehash å¯å˜å…ƒç´ ä¸èƒ½ä½œä¸ºkey 1234567891011121314151617181920212223242526272829303132333435363738# åˆå§‹åŒ–d1 = &#123;'name': 'jason', 'age': 20, 'gender': 'male'&#125;d2 = dict(&#123;'name': 'jason', 'age': 20, 'gender': 'male'&#125;)d3 = dict([('name', 'jason'), ('age', 20), ('gender', 'male')])d4 = dict(name='jason', age=20, gender='male') d1 == d2 == d3 == d4True# èµ‹å€¼d['name']= 'xiaoming'# èŽ·å–å€¼d['name']d.get('name')d.get('name', 'null')# åˆ é™¤d.pop('name')# æ˜¯å¦å­˜åœ¨'name' in dTrue# æŽ’åºd = &#123;'b': 1, 'a': 2, 'c': 10&#125;d_sorted_by_key = sorted(d.items(), key=lambda x: x[0]) # æ ¹æ®å­—å…¸é”®çš„å‡åºæŽ’åºd_sorted_by_value = sorted(d.items(), key=lambda x: x[1]) # æ ¹æ®å­—å…¸å€¼çš„å‡åºæŽ’åºd_sorted_by_key# åˆå§‹åŒ–s1 = &#123;1, 2, 3&#125;s2 = set([1, 2, 3])s1 == s2True# åŸºæ“s.add(4)s.remove(1)sorted(s) å­—ç¬¦ä¸² ä¸‰ä¸ªå¼•å·ç”¨äºŽå¤šè¡Œ å­—ç¬¦ä¸²ä¸ºä¸å¯å˜çš„ 1234567891011121314151617181920212223242526272829303132333435363738# ä¸€æ ·çš„'123'"123""""123"""name = 'jack'name[0]name[1:3]# éåŽ†for char in name print(char)# æ›¿æ¢s.replace('h', 'n')# è¿žæŽ¥s += 'a''-'.join(['aaa','bbb'])# åˆ†ç¦»'1-1-1-1-2'.split('-')# åŽ»æŽ‰å¼€å¤´ç»“å°¾string.strip(str)string.ltrip(str)string.rtrip(str)# ä»Žå¼€å§‹åˆ°ç»“å°¾è¿›è¡ŒæŸ¥æ‰¾string.find(sub, start, end)# æ•°å­—åˆ°å­—ç¬¦ä¸²ï¼Œå­—ç¬¦ä¸²åˆ°æ•°å­—str(1)int('1')# æ ¼å¼åŒ–&gt;&gt;&gt; print('id: &#123;&#125;, name: &#123;&#125;'.format("1", "xiaowang"))id: 1, name: xiaowang è¾“å…¥è¾“å‡º ä½¿ç”¨withä¼šè‡ªåŠ¨å…³é—­æ‰“å¼€çš„æ–‡ä»¶ 1234567name = input('your name:')with open('in.txt', 'r') as fin: text = fin.read()with open('out.txt', 'w') as fout: fout.write('123') jsonæ“ä½œ12345# åºåˆ—åŒ–å¯¹è±¡ä¸ºjsonå­—ç¬¦ä¸²json.dumps(params)# ååºåˆ—åŒ–jsonå­—ç¬¦ä¸²json.loads(params_str) æ¡ä»¶ ä½¿ç”¨elif åŽé¢è¦æœ‰å†’å· æ¡ä»¶å†…ä¸ºç©ºçš„å‡ä¸ºfalse 123456if id == 0: print('red')elif id == 1: print('yellow')else: print('green') å¾ªçŽ¯1234567891011121314151617181920212223242526272829303132333435l = [1, 2, 3, 4]# éåŽ†å…ƒç´ for item in l: print(item)# éåŽ†ä¸‹æ ‡for index in range(0, len(l)): if index &lt; 5: print(l[index])# ä¸‹æ ‡å’Œå…ƒç´ åŒæ—¶éœ€è¦ï¼Œä½¿ç”¨enumeratefor index, item in enumerate(l): if index &lt; 5: print(item)# whileå½“ç„¶ä¹Ÿå¯ä»¥while index &lt; len(l): print(l[index]) index += 1# å•è¡Œæ“ä½œï¼Œå¾ˆç®€æ´expression1 if condition else expression2 for item in iterablefor item in iterable: if condition: expression1 else: expression2expression1 for item in iterable if conditionfor item in iterable: if condition: expression1 å¼‚å¸¸å¤„ç† jsonååºåˆ—åŒ–çš„æ—¶å€™éœ€è¦å¼‚å¸¸å¤„ç† æ–‡ä»¶éœ€è¦å¼‚å¸¸å¤„ç† å¿…è¦çš„æ—¶å€™æ‰è¿›è¡Œå¼‚å¸¸å¤„ç† 1234567891011121314151617181920212223242526272829303132333435try: s = input('please enter two numbers separated by comma: ') num1 = int(s.split(',')[0].strip()) num2 = int(s.split(',')[1].strip()) ... except ValueError as err: print('Value Error: &#123;&#125;'.format(err))finally: print('finally')print('continue')...except (ValueError, IndexError) as err:# ORexcept ValueError as err: print('Value Error: &#123;&#125;'.format(err))except IndexError as err: print('Index Error: &#123;&#125;'.format(err))except: print('Other error')# è‡ªå®šä¹‰å¼‚å¸¸class MyInputError(Exception): """Exception raised when there're errors in input""" def __init__(self, value): # è‡ªå®šä¹‰å¼‚å¸¸ç±»åž‹çš„åˆå§‹åŒ– self.value = value def __str__(self): # è‡ªå®šä¹‰å¼‚å¸¸ç±»åž‹çš„ string è¡¨è¾¾å½¢å¼ return ("&#123;&#125; is invalid input".format(repr(self.value))) try: raise MyInputError(1) # æŠ›å‡º MyInputError è¿™ä¸ªå¼‚å¸¸except MyInputError as err: print('error: &#123;&#125;'.format(err)) å‡½æ•° è¦å…ˆå®šä¹‰åœ¨ä¸Šé¢ ä½¿ç”¨çš„æ—¶å€™æ‰ä¼šåˆ›å»º å†…éƒ¨å˜é‡ä½œç”¨åŸŸåªåœ¨å‡½æ•°å†…éƒ¨ ä¸èƒ½åœ¨å‡½æ•°å†…éƒ¨éšæ„æ”¹å˜å…¨å±€å˜é‡çš„å€¼ å¯¹äºŽåµŒå¥—å‡½æ•°æ¥è¯´ï¼Œå†…éƒ¨å‡½æ•°å¯ä»¥è®¿é—®å¤–éƒ¨å‡½æ•°å®šä¹‰çš„å˜é‡ï¼Œä½†æ˜¯æ— æ³•ä¿®æ”¹ï¼Œè‹¥è¦ä¿®æ”¹ï¼Œå¿…é¡»åŠ ä¸Š nonlocal è¿™ä¸ªå…³é”®å­— 123456789101112131415161718192021222324252627282930313233343536# ä¸éœ€è¦ç”³æ˜Žç±»åž‹def my_sum(a, b): return a + b# è®¾ç½®é»˜è®¤å€¼def func(param = 0):# å‡½æ•°å®šä¹‰åµŒå¥—ï¼Œå†…éƒ¨å‡½æ•°æ— æ³•è¢«å¤–éƒ¨ç›´æŽ¥è°ƒç”¨def f1(): print('hello') def f2(): print('world') f2()f1()def outer(): x = "local" def inner(): nonlocal x # nonlocal å…³é”®å­—è¡¨ç¤ºè¿™é‡Œçš„ x å°±æ˜¯å¤–éƒ¨å‡½æ•° outer å®šä¹‰çš„å˜é‡ x x = 'nonlocal' print("inner:", x) inner() print("outer:", x)outer()# è¾“å‡ºinner: nonlocalouter: nonlocal# é—­åŒ…ï¼Œå°±æ˜¯è¿”å›žä¸€ä¸ªå‡½æ•°è€Œå·²def nth_power(exponent): def exponent_of(base): return base ** exponent return exponent_of # è¿”å›žå€¼æ˜¯ exponent_of å‡½æ•° square = nth_power(2) # è®¡ç®—ä¸€ä¸ªæ•°çš„å¹³æ–¹cube = nth_power(3) # è®¡ç®—ä¸€ä¸ªæ•°çš„ç«‹æ–¹ åŒ¿åå‡½æ•° lambda æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼ˆexpressionï¼‰ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªè¯­å¥ï¼ˆstatementï¼‰ lambda çš„ä¸»ä½“æ˜¯åªæœ‰ä¸€è¡Œçš„ç®€å•è¡¨è¾¾å¼ï¼Œå¹¶ä¸èƒ½æ‰©å±•æˆä¸€ä¸ªå¤šè¡Œçš„ä»£ç å— 1234lambda argument1, argument2,... argumentN : expressionsquare = lambda x: x**2square(3) å¸¸ç”¨å‡½æ•°1234567891011# mapå‡½æ•°ï¼Œå¯¹äºŽé›†åˆå†…æ¯ä¸ªå…ƒç´ éƒ½åšä¸€æ¬¡funcl = [1, 2, 3, 4, 5]new_list = map(lambda x: x * 2, l) # [2ï¼Œ 4ï¼Œ 6ï¼Œ 8ï¼Œ 10]# filterå‡½æ•°ï¼Œå¯¹äºŽé›†åˆå†…æ¯ä¸ªå…ƒç´ éƒ½åšä¸€æ¬¡funcï¼Œå¹¶è¿”å›žtrueæˆ–è€…falseï¼Œç»“æžœè¿”å›žä¸ºtrueçš„é›†åˆl = [1, 2, 3, 4, 5]new_list = filter(lambda x: x % 2 == 0, l) # [2, 4]# reduceå‡½æ•°ï¼Œé›†åˆå†…æ¯ä¸ªå…ƒç´ éƒ½åšä¸€æ¬¡funcï¼Œæœ€åŽå°†ç»“æžœç»„åˆl = [1, 2, 3, 4, 5]product = reduce(lambda x, y: x * y, l) # 1*2*3*4*5 = 120 ç±»123456789101112131415161718192021222324252627282930313233343536class Document(): WELCOME_STR = 'Welcome! The context for this book is &#123;&#125;.' def __init__(self, title, author, context): print('init function called') self.title = title self.author = author self.__context = context # ç±»å‡½æ•° @classmethod def create_empty_book(cls, title, author): return cls(title=title, author=author, context='nothing') # æˆå‘˜å‡½æ•° def get_context_length(self): return len(self.__context) # é™æ€å‡½æ•° @staticmethod def get_welcome(context): return Document.WELCOME_STR.format(context) empty_book = Document.create_empty_book('What Every Man Thinks About Apart from Sex', 'Professor Sheridan Simove') print(empty_book.get_context_length())print(empty_book.get_welcome('indeed nothing')) ########## è¾“å‡º ########## init function called7Welcome! The context for this book is indeed nothing. æ¨¡å—åŒ– å·§ç”¨if name == â€˜mainâ€˜æ¥é¿å¼€ import æ—¶æ‰§è¡Œ 12345678# å¼•å…¥utilsåŒ…ä¸‹çš„utilæ–‡ä»¶çš„get_sumæ–¹æ³•from utils.utils import get_sum# ç›´æŽ¥ä»Žé¡¹ç›®æ ¹ç›®å½•ä¸­å¯¼å…¥ï¼Œå¹¶ä¾æ¬¡å‘ä¸‹å¯¼å…¥æ¨¡å— mat.py ä¸­çš„ Matrixfrom proto.mat import Matriximport module_namefrom module_name import *]]></content>
      <categories>
        <category>python</category>
      </categories>
      <tags>
        <tag>basic</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Golangç”¨300è¡Œä»£ç å®žçŽ°å†…ç½‘ç©¿é€]]></title>
    <url>%2F2020%2F04%2F25%2Fnetwork%2Fnat%2F</url>
    <content type="text"><![CDATA[æˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚ä½•å°†æœ¬æœºçš„æœåŠ¡æš´éœ²åˆ°å…¬ç½‘ä¸Šï¼Œè®©åˆ«äººä¹Ÿå¯ä»¥è®¿é—®ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨å®¶ä¸Šç½‘çš„æ—¶å€™æˆ‘ä»¬æœ‰ä¸€ä¸ª IP åœ°å€ï¼Œä½†æ˜¯è¿™ä¸ª IP åœ°å€å¹¶ä¸æ˜¯ä¸€ä¸ªå…¬ç½‘çš„ IP åœ°å€ï¼Œåˆ«äººæ— æ³•é€šè¿‡ä¸€ä¸ª IP åœ°å€è®¿é—®åˆ°ä½ çš„æœåŠ¡ï¼Œæ‰€ä»¥åœ¨ä¾‹å¦‚ï¼šå¾®ä¿¡æŽ¥å£è°ƒè¯•ã€ä¸‰æ–¹å¯¹æŽ¥çš„æ—¶å€™ï¼Œä½ å¿…é¡»å°†ä½ çš„æœåŠ¡éƒ¨ç½²åˆ°ä¸€ä¸ªå…¬ç½‘çš„ç³»ç»Ÿä¸­åŽ»ï¼Œè¿™æ ·å¤ªç´¯äº†ã€‚ è¿™ä¸ªæ—¶å€™ï¼Œå†…ç½‘ç©¿é€å°±å‡ºçŽ°äº†ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯å³ä½¿ä½ åœ¨å®¶çš„æœåŠ¡ï¼Œä¹Ÿèƒ½è¢«å…¶äººè®¿é—®åˆ°ã€‚ ä»Šå¤©è®©æˆ‘ä»¬æ¥ç”¨ä¸€ä¸ªæœ€ç®€å•çš„æ¡ˆä¾‹å­¦ä¹ ä¸€ä¸‹å¦‚ä½•ç”¨ go æ¥åšä¸€ä¸ªæœ€ç®€å•çš„å†…ç½‘ç©¿é€å·¥å…·ã€‚ æ•´ä½“ç»“æž„é¦–å…ˆæˆ‘ä»¬ç”¨å‡ å¼ å›¾æ¥è¯´æ˜Žä¸€ä¸‹æˆ‘ä»¬æ˜¯å¦‚ä½•å®žçŽ°çš„ï¼Œè¯´æ¸…æ¥šä¹‹åŽå†æ¥ç”¨ä»£ç å®žçŽ°ä¸€ä¸‹ã€‚ å½“å‰ç½‘ç»œæƒ…å†µ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç”»å®žçº¿çš„æ˜¯æˆ‘ä»¬å½“å‰å¯ä»¥è®¿é—®çš„ï¼Œç”»è™šçº¿çš„æ˜¯æˆ‘ä»¬å½“å‰æ— æ³•è¿›è¡Œç›´æŽ¥è®¿é—®çš„ã€‚ æˆ‘ä»¬çŽ°åœ¨æœ‰çš„è·¯æ˜¯ï¼š ç”¨æˆ·ä¸»åŠ¨è®¿é—®å…¬ç½‘æœåŠ¡å™¨æ˜¯å¯ä»¥çš„ å†…ç½‘ä¸»åŠ¨è®¿é—®å…¬ç½‘æœåŠ¡ä¹Ÿæ˜¯å¯ä»¥çš„ å½“å‰æˆ‘ä»¬è¦åšçš„æ˜¯æƒ³åŠžæ³•èƒ½è®©ç”¨æˆ·è®¿é—®åˆ°å†…ç½‘æœåŠ¡ï¼Œæ‰€ä»¥å¦‚æžœèƒ½åšåˆ°å…¬ç½‘æœåŠ¡è®¿é—®åˆ°å†…ç½‘æœåŠ¡ï¼Œé‚£ä¹ˆç”¨æˆ·å°±èƒ½é—´æŽ¥è®¿é—®åˆ°å†…ç½‘æœåŠ¡äº†ã€‚ æƒ³æ˜¯è¿™ä¹ˆæƒ³çš„ï¼Œä½†æ˜¯å®žé™…æ€Žä¹ˆåšå‘¢ï¼Ÿç”¨æˆ·è®¿é—®ä¸åˆ°å†…ç½‘æœåŠ¡ï¼Œé‚£æˆ‘å…¬ç½‘æœåŠ¡å™¨åŒæ ·è®¿é—®ä¸åˆ°å§ã€‚æ‰€ä»¥æˆ‘ä»¬å°±éœ€è¦åˆ©ç”¨çŽ°æœ‰çš„é“¾è·¯æ¥å®Œæˆè¿™ä»¶äº‹ã€‚ åŸºæœ¬æž¶æž„ å†…ç½‘ï¼Œå®¢æˆ·ç«¯ï¼ˆæˆ‘ä»¬è¦æžä¸€ä¸ªï¼‰ å¤–ç½‘ï¼ŒæœåŠ¡ç«¯ï¼ˆæˆ‘ä»¬ä¹Ÿè¦æžä¸€ä¸ªï¼‰ è®¿é—®è€…ï¼Œç”¨æˆ· é¦–å…ˆæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæŽ§åˆ¶é€šé“æ¥ä¼ é€’æ¶ˆæ¯ï¼Œå› ä¸ºåªæœ‰å†…ç½‘å¯ä»¥è®¿é—®å…¬ç½‘ï¼Œå…¬ç½‘ä¸çŸ¥é“å†…ç½‘åœ¨å“ªé‡Œï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡è‚¯å®šéœ€è¦å®¢æˆ·ç«¯ä¸»åŠ¨å‘Šè¯‰æœåŠ¡ç«¯æˆ‘åœ¨å“ª æœåŠ¡ç«¯é€šè¿‡ 8007 ç«¯å£ç›‘å¬ç”¨æˆ·æ¥çš„è¯·æ±‚ å½“ç”¨æˆ·å‘æ¥è¯·æ±‚æ—¶ï¼ŒæœåŠ¡ç«¯éœ€è¦é€šè¿‡æŽ§åˆ¶ä¿¡é“å‘Šè¯‰å®¢æˆ·ç«¯ï¼Œæœ‰ç”¨æˆ·æ¥äº† å®¢æˆ·ç«¯æ”¶åˆ°æ¶ˆæ¯ä¹‹åŽå»ºç«‹éš§é“é€šé“ï¼Œä¸»åŠ¨è®¿é—®æœåŠ¡ç«¯çš„ 8008 æ¥å»ºç«‹ TCP è¿žæŽ¥ æ­¤æ—¶å®¢æˆ·ç«¯éœ€è¦åŒæ—¶ä¸Žæœ¬åœ°éœ€è¦æš´éœ²çš„æœåŠ¡ 127.0.0.1:8080 å»ºç«‹è¿žæŽ¥ è¿žæŽ¥å®ŒæˆåŽï¼ŒæœåŠ¡ç«¯éœ€è¦å°† 8007 çš„è¯·æ±‚è½¬å‘åˆ°éš§é“ç«¯å£ 8008 ä¸­ å®¢æˆ·ç«¯ä»Žéš§é“ä¸­èŽ·å¾—ç”¨æˆ·è¯·æ±‚ï¼Œè½¬å‘ç»™å†…ç½‘æœåŠ¡ï¼ŒåŒæ—¶å°†å†…ç½‘æœåŠ¡çš„è¿”å›žä¿¡æ¯æ”¾å…¥éš§é“ æœ€ç»ˆè¯·æ±‚æµå‘æ˜¯ï¼Œå¦‚å›¾ä¸­çš„ç´«è‰²ç®­å¤´èµ°å‘ï¼Œè¯·æ±‚è¿”å›žæ˜¯å¦‚å›¾ä¸­çº¢è‰²ç®­å¤´èµ°å‘ã€‚ éœ€è¦ç†è§£çš„æ˜¯ï¼ŒTCP ä¸€æ—¦å»ºç«‹äº†è¿žæŽ¥ï¼ŒåŒæ–¹å°±éƒ½å¯ä»¥å‘å¯¹æ–¹å‘é€ä¿¡æ¯äº†ï¼Œæ‰€ä»¥å…¶å®žåŽŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯åˆ©ç”¨å·²æœ‰çš„å•å‘è·¯å»ºç«‹ TCP è¿žæŽ¥ï¼Œä»Žè€ŒçŸ¥é“å¯¹æ–¹çš„ä½ç½®ä¿¡æ¯ï¼Œç„¶åŽå°†è¯·æ±‚è¿›è¡Œè½¬å‘å³å¯ã€‚ ä»£ç å®žçŽ°å·¥å…·æ–¹æ³•é¦–å…ˆæˆ‘ä»¬å…ˆå®šä¹‰ä¸‰ä¸ªéœ€è¦ä½¿ç”¨çš„å·¥å…·æ–¹æ³•ï¼Œè¿˜éœ€è¦å®šä¹‰ä¸¤ä¸ªæ¶ˆæ¯ç¼–ç å¸¸é‡ï¼ŒåŽé¢ä¼šç”¨åˆ° ç›‘å¬ä¸€ä¸ªåœ°å€å¯¹åº”çš„ TCP è¯·æ±‚ CreateTCPListener è¿žæŽ¥ä¸€ä¸ª TCP åœ°å€ CreateTCPConn å°†ä¸€ä¸ª TCP-A è¿žæŽ¥çš„æ•°æ®å†™å…¥å¦ä¸€ä¸ª TCP-B è¿žæŽ¥ï¼Œå°† TCP-B è¿žæŽ¥è¿”å›žçš„æ•°æ®å†™å…¥ TCP-A çš„è¿žæŽ¥ä¸­ Join2Conn ï¼ˆåˆ«çœ‹è¿™çŸ­çŸ­ 10 å‡ è¡Œä»£ç ï¼Œè¿™å°±æ˜¯æ ¸å¿ƒäº†ï¼‰ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051package networkimport ( "io" "log" "net")const ( KeepAlive = "KEEP_ALIVE" NewConnection = "NEW_CONNECTION")func CreateTCPListener(addr string) (*net.TCPListener, error) &#123; tcpAddr, err := net.ResolveTCPAddr("tcp", addr) if err != nil &#123; return nil, err &#125; tcpListener, err := net.ListenTCP("tcp", tcpAddr) if err != nil &#123; return nil, err &#125; return tcpListener, nil&#125;func CreateTCPConn(addr string) (*net.TCPConn, error) &#123; tcpAddr, err := net.ResolveTCPAddr("tcp", addr) if err != nil &#123; return nil, err &#125; tcpListener, err := net.DialTCP("tcp",nil, tcpAddr) if err != nil &#123; return nil, err &#125; return tcpListener, nil&#125;func Join2Conn(local *net.TCPConn, remote *net.TCPConn) &#123; go joinConn(local, remote) go joinConn(remote, local)&#125;func joinConn(local *net.TCPConn, remote *net.TCPConn) &#123; defer local.Close() defer remote.Close() _, err := io.Copy(local, remote) if err != nil &#123; log.Println("copy failed ", err.Error()) return &#125;&#125; å®¢æˆ·ç«¯æˆ‘ä»¬å…ˆæ¥å®žçŽ°ç›¸å¯¹ç®€å•çš„å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯ä¸»è¦åšçš„äº‹æƒ…æ˜¯ 3 ä»¶ï¼š è¿žæŽ¥æœåŠ¡ç«¯çš„æŽ§åˆ¶é€šé“ ç­‰å¾…æœåŠ¡ç«¯ä»ŽæŽ§åˆ¶é€šé“ä¸­å‘æ¥å»ºç«‹è¿žæŽ¥çš„æ¶ˆæ¯ æ”¶åˆ°å»ºç«‹è¿žæŽ¥çš„æ¶ˆæ¯æ—¶ï¼Œå°†æœ¬åœ°æœåŠ¡å’Œè¿œç«¯éš§é“å»ºç«‹è¿žæŽ¥ï¼ˆè¿™é‡Œå°±è¦ç”¨åˆ°æˆ‘ä»¬çš„å·¥å…·æ–¹æ³•äº†ï¼‰ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677package mainimport ( "bufio" "io" "log" "net" "nat-proxy/cmd/network")var ( // æœ¬åœ°éœ€è¦æš´éœ²çš„æœåŠ¡ç«¯å£ localServerAddr = "127.0.0.1:32768" remoteIP = "111.111.111.111" // è¿œç«¯çš„æœåŠ¡æŽ§åˆ¶é€šé“ï¼Œç”¨æ¥ä¼ é€’æŽ§åˆ¶ä¿¡æ¯ï¼Œå¦‚å‡ºçŽ°æ–°è¿žæŽ¥å’Œå¿ƒè·³ remoteControlAddr = remoteIP + ":8009" // è¿œç«¯æœåŠ¡ç«¯å£ï¼Œç”¨æ¥å»ºç«‹éš§é“ remoteServerAddr = remoteIP + ":8008")func main() &#123; tcpConn, err := network.CreateTCPConn(remoteControlAddr) if err != nil &#123; log.Println("[è¿žæŽ¥å¤±è´¥]" + remoteControlAddr + err.Error()) return &#125; log.Println("[å·²è¿žæŽ¥]" + remoteControlAddr) reader := bufio.NewReader(tcpConn) for &#123; s, err := reader.ReadString('\n') if err != nil || err == io.EOF &#123; break &#125; // å½“æœ‰æ–°è¿žæŽ¥ä¿¡å·å‡ºçŽ°æ—¶ï¼Œæ–°å»ºä¸€ä¸ªtcpè¿žæŽ¥ if s == network.NewConnection+"\n" &#123; go connectLocalAndRemote() &#125; &#125; log.Println("[å·²æ–­å¼€]" + remoteControlAddr)&#125;func connectLocalAndRemote() &#123; local := connectLocal() remote := connectRemote() if local != nil &amp;&amp; remote != nil &#123; network.Join2Conn(local, remote) &#125; else &#123; if local != nil &#123; _ = local.Close() &#125; if remote != nil &#123; _ = remote.Close() &#125; &#125;&#125;func connectLocal() *net.TCPConn &#123; conn, err := network.CreateTCPConn(localServerAddr) if err != nil &#123; log.Println("[è¿žæŽ¥æœ¬åœ°æœåŠ¡å¤±è´¥]" + err.Error()) &#125; return conn&#125;func connectRemote() *net.TCPConn &#123; conn, err := network.CreateTCPConn(remoteServerAddr) if err != nil &#123; log.Println("[è¿žæŽ¥è¿œç«¯æœåŠ¡å¤±è´¥]" + err.Error()) &#125; return conn&#125; æœåŠ¡ç«¯æœåŠ¡ç«¯çš„å®žçŽ°å°±ç›¸å¯¹å¤æ‚ä¸€äº›äº†ï¼š ç›‘å¬æŽ§åˆ¶é€šé“ï¼ŒæŽ¥æ”¶å®¢æˆ·ç«¯çš„è¿žæŽ¥è¯·æ±‚ ç›‘å¬è®¿é—®ç«¯å£ï¼ŒæŽ¥æ”¶æ¥è‡ªç”¨æˆ·çš„ http è¯·æ±‚ ç¬¬äºŒæ­¥æŽ¥æ”¶åˆ°è¯·æ±‚ä¹‹åŽéœ€è¦å­˜æ”¾ä¸€ä¸‹è¿™ä¸ªè¿žæŽ¥å¹¶åŒæ—¶å‘æ¶ˆæ¯ç»™å®¢æˆ·ç«¯ï¼Œå‘Šè¯‰å®¢æˆ·ç«¯æœ‰ç”¨æˆ·è®¿é—®äº†ï¼Œèµ¶ç´§å»ºç«‹éš§é“è¿›è¡Œé€šä¿¡ ç›‘å¬éš§é“é€šé“ï¼ŒæŽ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„è¿žæŽ¥è¯·æ±‚ï¼Œå°†å®¢æˆ·ç«¯çš„è¿žæŽ¥ä¸Žç”¨æˆ·çš„è¿žæŽ¥å»ºç«‹èµ·æ¥ï¼ˆä¹Ÿæ˜¯ç”¨å·¥å…·æ–¹æ³•ï¼‰ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164package mainimport ( "log" "net" "strconv" "sync" "time" "nat-proxy/cmd/network")const ( controlAddr = "0.0.0.0:8009" tunnelAddr = "0.0.0.0:8008" visitAddr = "0.0.0.0:8007")var ( clientConn *net.TCPConn connectionPool map[string]*ConnMatch connectionPoolLock sync.Mutex)type ConnMatch struct &#123; addTime time.Time accept *net.TCPConn&#125;func main() &#123; connectionPool = make(map[string]*ConnMatch, 32) go createControlChannel() go acceptUserRequest() go acceptClientRequest() cleanConnectionPool()&#125;// åˆ›å»ºä¸€ä¸ªæŽ§åˆ¶é€šé“ï¼Œç”¨äºŽä¼ é€’æŽ§åˆ¶æ¶ˆæ¯ï¼Œå¦‚ï¼šå¿ƒè·³ï¼Œåˆ›å»ºæ–°è¿žæŽ¥func createControlChannel() &#123; tcpListener, err := network.CreateTCPListener(controlAddr) if err != nil &#123; panic(err) &#125; log.Println("[å·²ç›‘å¬]" + controlAddr) for &#123; tcpConn, err := tcpListener.AcceptTCP() if err != nil &#123; log.Println(err) continue &#125; log.Println("[æ–°è¿žæŽ¥]" + tcpConn.RemoteAddr().String()) // å¦‚æžœå½“å‰å·²ç»æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯å­˜åœ¨ï¼Œåˆ™ä¸¢å¼ƒè¿™ä¸ªé“¾æŽ¥ if clientConn != nil &#123; _ = tcpConn.Close() &#125; else &#123; clientConn = tcpConn go keepAlive() &#125; &#125;&#125;// å’Œå®¢æˆ·ç«¯ä¿æŒä¸€ä¸ªå¿ƒè·³é“¾æŽ¥func keepAlive() &#123; go func() &#123; for &#123; if clientConn == nil &#123; return &#125; _, err := clientConn.Write(([]byte)(network.KeepAlive + "\n")) if err != nil &#123; log.Println("[å·²æ–­å¼€å®¢æˆ·ç«¯è¿žæŽ¥]", clientConn.RemoteAddr()) clientConn = nil return &#125; time.Sleep(time.Second * 3) &#125; &#125;()&#125;// ç›‘å¬æ¥è‡ªç”¨æˆ·çš„è¯·æ±‚func acceptUserRequest() &#123; tcpListener, err := network.CreateTCPListener(visitAddr) if err != nil &#123; panic(err) &#125; defer tcpListener.Close() for &#123; tcpConn, err := tcpListener.AcceptTCP() if err != nil &#123; continue &#125; addConn2Pool(tcpConn) sendMessage(network.NewConnection + "\n") &#125;&#125;// å°†ç”¨æˆ·æ¥çš„è¿žæŽ¥æ”¾å…¥è¿žæŽ¥æ± ä¸­func addConn2Pool(accept *net.TCPConn) &#123; connectionPoolLock.Lock() defer connectionPoolLock.Unlock() now := time.Now() connectionPool[strconv.FormatInt(now.UnixNano(), 10)] = &amp;ConnMatch&#123;now, accept,&#125;&#125;// å‘é€ç»™å®¢æˆ·ç«¯æ–°æ¶ˆæ¯func sendMessage(message string) &#123; if clientConn == nil &#123; log.Println("[æ— å·²è¿žæŽ¥çš„å®¢æˆ·ç«¯]") return &#125; _, err := clientConn.Write([]byte(message)) if err != nil &#123; log.Println("[å‘é€æ¶ˆæ¯å¼‚å¸¸]: message: ", message) &#125;&#125;// æŽ¥æ”¶å®¢æˆ·ç«¯æ¥çš„è¯·æ±‚å¹¶å»ºç«‹éš§é“func acceptClientRequest() &#123; tcpListener, err := network.CreateTCPListener(tunnelAddr) if err != nil &#123; panic(err) &#125; defer tcpListener.Close() for &#123; tcpConn, err := tcpListener.AcceptTCP() if err != nil &#123; continue &#125; go establishTunnel(tcpConn) &#125;&#125;func establishTunnel(tunnel *net.TCPConn) &#123; connectionPoolLock.Lock() defer connectionPoolLock.Unlock() for key, connMatch := range connectionPool &#123; if connMatch.accept != nil &#123; go network.Join2Conn(connMatch.accept, tunnel) delete(connectionPool, key) return &#125; &#125; _ = tunnel.Close()&#125;func cleanConnectionPool() &#123; for &#123; connectionPoolLock.Lock() for key, connMatch := range connectionPool &#123; if time.Now().Sub(connMatch.addTime) &gt; time.Second*10 &#123; _ = connMatch.accept.Close() delete(connectionPool, key) &#125; &#125; connectionPoolLock.Unlock() time.Sleep(5 * time.Second) &#125;&#125; å…¶ä»– å…¶ä¸­æˆ‘åŠ å…¥äº† keepalive çš„æ¶ˆæ¯ï¼Œç”¨äºŽä¿æŒå®¢æˆ·ç«¯ä¸ŽæœåŠ¡ç«¯çš„ä¸€ç›´æ­£å¸¸è¿žæŽ¥ æˆ‘ä»¬è¿˜éœ€è¦å®šæœŸæ¸…ç†ä¸€ä¸‹æœåŠ¡ç«¯ map ä¸­æ²¡æœ‰å»ºç«‹æˆåŠŸçš„è¿žæŽ¥ å®žéªŒä¸€ä¸‹é¦–å…ˆåœ¨æœ¬æœºç”¨ dokcer éƒ¨ç½²ä¸€ä¸ª nginx æœåŠ¡ï¼ˆä½ å¯ä»¥å¯åŠ¨ä¸€ä¸ª tomcat éƒ½å¯ä»¥çš„ï¼‰ï¼Œå¹¶ä¿®æ”¹å®¢æˆ·ç›‘å¬ç«¯å£localServerAddrä¸º127.0.0.1:32768ï¼Œå¹¶ä¿®æ”¹remoteIP ä¸ºæœåŠ¡ç«¯ IP åœ°å€ã€‚ç„¶åŽè®¿é—®ä»¥ä¸‹ï¼Œçœ‹åˆ°æ˜¯å¯ä»¥æ­£å¸¸è®¿é—®çš„ã€‚ ç„¶åŽç¼–è¯‘æ‰“åŒ…æœåŠ¡ç«¯æ‰”åˆ°æœåŠ¡å™¨ä¸Šå¯åŠ¨ã€å®¢æˆ·ç«¯æœ¬åœ°å¯åŠ¨ï¼Œå¦‚æžœæŽ§åˆ¶å°è¾“å‡ºè¿žæŽ¥æˆåŠŸï¼Œå°±å®Œæˆå‡†å¤‡äº† çŽ°åœ¨é€šè¿‡è®¿é—®æœåŠ¡ç«¯çš„ 8007 ç«¯å£å°±å¯ä»¥è®¿é—®æˆ‘ä»¬å†…ç½‘çš„æœåŠ¡äº†ã€‚ é—ç•™é—®é¢˜ä¸Šè¿°çš„å®žçŽ°æ˜¯ä¸€ä¸ªæœ€å°çš„å®žçŽ°ï¼Œä¹Ÿåªæ˜¯ä¸ºäº†å®ŒæˆåŸºæœ¬åŠŸèƒ½ï¼Œè¿˜æœ‰ä¸€äº›é—ç•™çš„é—®é¢˜ç­‰å¾…ä½ çš„å¤„ç†ï¼š çŽ°åœ¨ä¸€ä¸ªå®¢æˆ·ç«¯è¿žæŽ¥ä¸Šäº†å°±ä¸èƒ½è¿žæŽ¥ç¬¬äºŒä¸ªäº†ï¼Œé‚£æ€Žä¹ˆåšå¤šä¸ªå®¢æˆ·ç«¯çš„è¿žæŽ¥å‘¢ï¼Ÿ å½“å‰è¿™ä¸ª map çš„ä½¿ç”¨å…¶å®žæ˜¯æœ‰é£Žé™©çš„ï¼Œå¦‚ä½•åšå¥½è¿žæŽ¥æ± çš„ç®¡ç†ï¼Ÿ TCP è¿žæŽ¥çš„å¼€é”€æ˜¯å¾ˆå¤§çš„ï¼Œå¦‚ä½•åšå¥½è¿žæŽ¥çš„å¤ç”¨ï¼Ÿ å½“å‰æ˜¯ TCP çš„è¿žæŽ¥ï¼Œé‚£ä¹ˆå¦‚æžœæ˜¯ UDP å¦‚ä½•å®žçŽ°å‘¢ï¼Ÿ å½“å‰è¿žæŽ¥éƒ½æ˜¯ä¸åŠ å¯†çš„ï¼Œå¦‚ä½•è¿›è¡ŒåŠ å¯†å‘¢ï¼Ÿ å½“å‰çš„ keepalive å®žçŽ°å¾ˆç®€å•ï¼Œæœ‰æ²¡æœ‰æ›´ä¼˜é›…çš„å®žçŽ°æ–¹å¼å‘¢ï¼Ÿ è¿™äº›å°±äº¤ç»™èªæ˜Žçš„ä½ æ¥å®Œæˆäº† æ€»ç»“å…¶å®žæœ€åŽå›žå¤´çœ‹çœ‹å®žçŽ°èµ·æ¥å¹¶ä¸å¤æ‚ï¼Œç”¨ go æ¥å®žçŽ°å·²ç»æ˜¯éžå¸¸ç®€å•äº†ï¼Œæ‰€ä»¥ github ä¸Šé¢æœ‰å¾ˆå¤šåˆ©ç”¨ go æ¥å®žçŽ°ä»£ç†æˆ–è€…ç©¿é€çš„å·¥å…·ï¼Œæˆ‘ä¹Ÿæ˜¯å‚è€ƒå®ƒä»¬æŠ½ç¦»äº†å…¶ä¸­çš„æ ¸å¿ƒï¼Œæœ€é‡è¦çš„å°±æ˜¯å·¥å…·æ–¹æ³•ä¸­çš„ç¬¬ä¸‰ä¸ª copy äº†ï¼Œä¸è¿‡å…¶å®žè¿˜æœ‰å¾ˆå¤šç»†èŠ‚ç‚¹éœ€è¦è€ƒè™‘çš„ã€‚ä½ å¯ä»¥å‚è€ƒä¸‹é¢çš„æºç ç»§ç»­æ·±å…¥æŽ¢ç´¢ä¸€ä¸‹ã€‚ https://github.com/fatedier/frp https://github.com/snail007/goproxy]]></content>
      <categories>
        <category>network</category>
      </categories>
      <tags>
        <tag>nat</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å°†ç‰ˆæœ¬ä¿¡æ¯æ‰“åŒ…åˆ°goçš„äºŒè¿›åˆ¶ä¸­]]></title>
    <url>%2F2020%2F04%2F18%2Fgolang%2Fbasic%2Fgobuild-x%2F</url>
    <content type="text"><![CDATA[å¾ˆå¤šæ—¶å€™å¯¹äºŽgoæ‰“åŒ…åŽçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæˆ‘ä»¬æ˜¯æ— æ³•çŸ¥é“è¿™ä¸ªäºŒè¿›åˆ¶æ˜¯ä»€ä¹ˆå½“å‰ä»€ä¹ˆç‰ˆæœ¬ã€ä»€ä¹ˆæ—¶å€™æ‰“åŒ…çš„ï¼Œè€Œå¾ˆå¤šè½¯ä»¶çš„å‘½ä»¤è¡Œéƒ½ä¼šæœ‰ä¸€ä¸ª -version çš„é€‰é¡¹æ¥æ‰“å°å‡ºå½“å‰ç¨‹åºçš„ç‰ˆæœ¬å·ï¼Œå½“ç„¶ä½ å¯ä»¥ç›´æŽ¥åœ¨ç¨‹åºé‡Œé¢å†™æ­»è¿™ä¸ªç‰ˆæœ¬å·ï¼Œä½†æ˜¯è¿˜æœ‰æ›´åŠ ä¼˜é›…çš„è§£å†³æ–¹å¼ã€‚ å®žçŽ°å…¶å®žå¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨ build çš„æ—¶å€™é€šè¿‡ -X å‚æ•°åŽ»æŒ‡å®šå˜é‡å€¼å°±å¯ä»¥äº† 1234567891011121314package mainimport "fmt"var ( Tag = "v0.0.0" CommitID = "" Branch = "" DATE = "")func main() &#123; fmt.Println("tag:", Tag, "branch:", Branch, "commitID:", CommitID, "DATE:", DATE)&#125; 123456789101112131415#!/bin/sh# èŽ·å–å½“å‰commitå·CommitID=$(git rev-parse HEAD)# èŽ·å–å½“å‰åˆ†æ”¯åç§°Branch=$(git rev-parse --abbrev-ref HEAD)# èŽ·å–æœ€è¿‘çš„tagTag=$(git describe --abbrev=0 --tags)# æ‰“åŒ…æ—¶é—´DATE=$(date +'%Y-%m-%dT%H:%M:%m+08:00') go build -ldflags "-X 'main.Tag=$Tag' -X 'main.Branch=$Branch' -X 'main.CommitID=$CommitID' -X 'main.DATE=$DATE'" å…¶ä¸­éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”¨å•å¼•å·çš„åŽŸå› æ˜¯é˜²æ­¢å˜é‡ä¸­å¸¦æœ‰ç©ºæ ¼ï¼Œmainæ ‡è¯†åŒ…ï¼Œä½ å¯ä»¥æ›¿æ¢æˆç¨‹åºä¸­å¯¹åº”çš„åŒ…å°±å¯ä»¥ã€‚ æ€»ç»“è¿™æ ·ï¼Œå½“æˆ‘ä»¬åœ¨å®žé™…ç”Ÿäº§çŽ¯å¢ƒä½¿ç”¨çš„æ—¶å€™ï¼Œå°±å¯ä»¥é€šè¿‡è¿™äº›æ‰“åŒ…æ—¶æºå¸¦çš„ä¿¡æ¯æ¥åˆ†æžè¿™ä¸ªåŒ…æ˜¯ä»€ä¹ˆæ—¶å€™çš„ï¼Œæ˜¯å¦ä¸ºæœ€æ–°ç‰ˆæœ¬ç­‰ã€‚]]></content>
      <categories>
        <category>golangåŸºç¡€</category>
      </categories>
      <tags>
        <tag>gobuild</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å›žé¦–ç½‘ç»œçŸ¥è¯†ä¹‹ TCP åè®®]]></title>
    <url>%2F2020%2F04%2F11%2Fnetwork%2Ftcp%2F</url>
    <content type="text"><![CDATA[ä¹‹å‰æˆ‘ä»¬è¯´äº† UDP åè®®ï¼Œä¹Ÿè¯´åˆ°äº† UDP åè®®å’Œ TCP åè®®çš„å¯¹æ¯”ï¼ŒçŸ¥é“äº† TCP åè®®æœ‰é‚£ä¹ˆä¸€äº›å¤æ‚ï¼Œæ‰€ä»¥è¿™æ¬¡å°±æ¥ä»”ç»†è¯´è¯´è¿™ä¸ªå¤æ‚çš„ TCP å‰è¨€æåˆ° TCP ä½ ç¬¬ä¸€æƒ³åˆ°çš„åº”è¯¥å°±æ˜¯ä¸¤ä¸ªå­— â€œé è°±â€~ å› ä¸ºå®ƒçš„æ‰€æœ‰è®¾è®¡éƒ½æ˜¯å›´ç»•ç€è¿™ä¸ªä»»åŠ¡å±•å¼€çš„ã€‚ æŠ¥æ–‡æ ¼å¼ å¾ˆå¤šäººä¸€çœ‹åˆ°è¿™ä¸ªå°±å¤´ç–¼äº†ï¼Œå› ä¸ºæ ¼å¼å¥½å¤æ‚å•Šï¼Œå’Œ UDP å¯¹æ¯”èµ·æ¥ï¼Œæ€Žä¹ˆå¤šäº†é‚£ä¹ˆå¤šä¸œè¥¿å‘¢ï¼Ÿ åˆ«æ€¥ï¼Œå…¶å®žå¹¶ä¸æ˜¯å¾ˆå¤šï¼Œè€Œä¸”åªè¦ä½ æƒ³ç€ä¸ºä»€ä¹ˆï¼Œä½ å°±çŸ¥é“ä¼šæœ‰ä»€ä¹ˆã€‚ é¦–å…ˆæ˜¯ä¸¤ä¸ªç«¯å£ï¼Œè¿™ä¸ªå’Œ UDP ä¸€æ ·ï¼Œè‚¯å®šéœ€è¦ç«¯å£ï¼Œä¸ç„¶çš„è¯ä¸çŸ¥é“æ˜¯å‘ç»™è°çš„ ç„¶åŽæ˜¯åºå·å’Œç¡®è®¤åºå·ï¼Œåºå·æ˜¯ä¸ºäº†è§£å†³ä¹±åºçš„é—®é¢˜ï¼Œå¦‚æžœæ²¡æœ‰åºå·ï¼Œé‚£ä¹ˆæˆ‘æ˜¯ä¸çŸ¥é“é‚£ä¸ªå…ˆé‚£ä¸ªåŽï¼ŒåŒæ—¶æˆ‘è¿˜è¦å‘Šè¯‰å¯¹æ–¹æˆ‘æ”¶åˆ°äº†è¿™ä¸ªåºå·çš„ä¿¡æ¯ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªç¡®è®¤åºå·ï¼Œç¡®è®¤çš„æ–¹å¼æ˜¯å‘Šè¯‰ä½ æˆ‘è¦çš„ä¸‹ä¸€ä¸ªåºå·æ˜¯å¤šå°‘ é¦–éƒ¨é•¿åº¦ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œå‘Šè¯‰ä½ é¦–éƒ¨æœ‰å¤šé•¿ï¼Œä½ å°±çŸ¥é“å‰é¢æœ‰å¤šé•¿ï¼Œä½ æ‰çŸ¥é“æ•°æ®ä»Žå“ªé‡Œå¼€å§‹ ä¸­é—´é‚£å‡ ä¸ªæ ‡è¯†ä½éœ€è¦çŸ¥é“çš„æ˜¯ï¼š SYNï¼šå»ºç«‹è¿žæŽ¥æ—¶ç”¨çš„ï¼Œå»ºç«‹è¿žæŽ¥ä¼šæ ‡è¯†ä¸º 1 ACKï¼šå›žå¤ä½ å»ºç«‹è¿žæŽ¥ï¼Œå»ºç«‹è¿žæŽ¥ä¹‹åŽæ ‡è¯†ä¸º 1 RSTï¼šé‡æ–°è¿žæŽ¥ FINï¼šç»“æŸè¿žæŽ¥ çª—å£å¤§å°ï¼ŒæŽ¥æ”¶æ–¹å‘Šè¯‰å‘é€æ–¹åˆ«å‘å¤ªå¿«äº†æˆ–è€…å¤ªæ…¢äº†ï¼Œç”¨äºŽæµé‡æŽ§åˆ¶ ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹è¿™ä¸ªé—®é¢˜å·²ç»åœ¨é¢è¯•çš„æ—¶å€™è¢«é—®çƒ‚äº†ï¼Œæ€»æ˜¯æœ‰é¢è¯•å®˜å–œæ¬¢é—®ç½‘ç»œï¼Œè€Œä½œä¸ºç¬¬ä¸€ä¸ªå¼€å¤´ç‚®ï¼Œä¸‰æ¬¡æ¡æ‰‹æ€»æ˜¯è¢«æåŠã€‚ ä¸­é—´çš„æ ‡è¯†ä½ï¼Œå¯èƒ½å°±æœ‰äººä»Žæ¥å°±æ²¡å¼„æ‡‚ï¼Œå¯èƒ½å³ä½¿æ‡‚äº†ï¼Œä¹Ÿæ˜¯é æ­»è®°ç¡¬èƒŒçš„ï¼Œä¸å¤ä¹ è‚¯å®šå¿˜è®°ã€‚ å…¶å®žæ²¡æœ‰é‚£ä¹ˆçŽ„ä¹Žå•¦ã€‚åˆ†ä¸¤ä¸ªéƒ¨åˆ†æ¥çœ‹ï¼š å¤§å†™çš„ SYN å’Œ ACK å…¶å®žä¸Šé¢éƒ½å·²ç»è¯´äº†ï¼Œå°±æ˜¯å»ºç«‹è¿žæŽ¥çš„æ—¶å€™ï¼Œç¬¬ä¸€ä¸ªç»™ä½ çš„æŠ¥æ–‡é‡Œé¢ SYN æ ‡è¯†ä½ä¸º 1 å‘Šè¯‰ä½ å¼€å§‹å»ºç«‹è¿žæŽ¥äº†ï¼Œå¦åˆ™ä½ æ€Žä¹ˆçŸ¥é“è¿™æ¬¡æ˜¯å»ºç«‹è¿žæŽ¥å‘¢ï¼Ÿè€Œ ACK å°±æ˜¯å‘Šè¯‰ä½ æˆ‘æ”¶åˆ°äº†ï¼Œå¯ä»¥å»ºç«‹è¿žæŽ¥äº† è€Œå°å†™çš„ seq å’Œ ack å°±æ›´ç®€å•äº†ï¼Œä»–ä»¬è¡¨ç¤ºçš„å°±æ˜¯ä¸Šé¢è¯´çš„åºå·ï¼Œç¡®è®¤å· ack ä¸ºæ”¶åˆ°çš„ seq åºå· + 1 éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåºå·æ¯æ¬¡éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œå®ƒæ˜¯ä¸€ä¸ª 32 ä½çš„æ¯ 4ms é€’å¢žçš„ä¸€ä¸ªå€¼ï¼Œä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡å‘¢ï¼Ÿæ˜¯å› ä¸ºå¦‚æžœæ¯æ¬¡åºå·éƒ½ä»Ž 1 å¼€å§‹ï¼Œé‚£ä¹ˆåŠ¿å¿…åœ¨å¤šæ¬¡å‘é€æˆ–è€…é‡è¿žä¹‹åŽå¯¼è‡´åºå·é‡å¤ï¼Œè¯¯ä»¥ä¸ºæ”¶åˆ°çš„æ–°çš„æ•°æ®ï¼Œå…¶å®žæ˜¯æ—§æ•°æ®ï¼Œåªä¸è¿‡åºå·ç›¸åŒã€‚ ä¸ºä»€ä¹ˆè¦ä¸‰æ¬¡ç­‰ä½ æè¿°çš„ä¸æ¸…ä¸æ¥šçš„æ—¶å€™ï¼Œé¢è¯•å®˜ä¸‹ä¸€ä¸ªé—®é¢˜å°±æ¥äº†ï¼Œä¸ºä»€ä¹ˆè¦åšä¸‰æ¬¡æ¡æ‰‹å‘¢ï¼Ÿ å…¶å®žè¿™ä¸ªé—®é¢˜ä¹Ÿä¸å¤æ‚ï¼Œä½ æ—¶åˆ»è¦è®°ä½ç½‘ç»œå…¶å®žå¾ˆä¸ç¨³å®šçš„ï¼Œä¸æ˜¯ä¸¤æ ¹ç½‘çº¿è¿žæŽ¥ä¸¤è¾¹å°±å¥½äº†ï¼Œä¸­é—´å¯èƒ½éš”äº†ä¸€ä¸ªå¤ªå¹³æ´‹ã€‚æ‰€ä»¥ä¸¢åŒ…å¤ªå¸¸è§äº†ã€‚ è€Œä½œä¸ºå¯é çš„ TCPï¼Œä¸‰æ¬¡æ¡æ‰‹èƒ½ä¿è¯æ¯ä¸ªäººéƒ½èƒ½æœ‰è‡³å°‘ä¸€æ¬¡æ­£åé¦ˆï¼Œå¯¹äºŽå‘é€æ–¹æ¥è¯´è‚¯å®šæœ‰ä¸€é—®ä¸€ç­”ï¼Œå¯¹äºŽæŽ¥æ”¶æ–¹æ¥è¯´ä¹Ÿæœ‰ä¸€é—®ä¸€ç­”ï¼Œå¦åˆ™éƒ½å±žäºŽå‘äº†æ²¡åé¦ˆã€‚ è¿˜æœ‰ä¸€ä¸ªé‡è¦åŽŸå› å°±æ˜¯é‡è¯•ï¼Œå¦‚æžœç”±äºŽç½‘ç»œåŽŸå› ï¼Œç¬¬ä¸€æ¬¡å»ºç«‹è¿žæŽ¥è¿Ÿè¿Ÿæ”¶ä¸åˆ°åé¦ˆï¼Œå°±ä¼šå‘ç¬¬äºŒä¸ªï¼Œè€Œå¯¹äºŽæŽ¥æ”¶æ–¹æ¥è¯´ï¼Œå¾ˆæœ‰å¯èƒ½å°±ä¼šæ”¶åˆ°å¤šä¸ªä¸€æ¨¡ä¸€æ ·çš„å»ºç«‹è¿žæŽ¥çš„è¯·æ±‚ï¼Œå¦‚æžœåªæ˜¯ä¸€æ¬¡æˆ–è€…ä¸¤æ¬¡ï¼Œé‚£ä¹ˆ å°±ä¼šå»ºç«‹å¾ˆå¤šæ— ç”¨çš„è¿žæŽ¥ å ç”¨èµ„æºã€‚ å››æ¬¡æŒ¥æ‰‹è¿‡ç¨‹ å…¶å®žå½“ä½ æŠŠä¸‰æ¬¡æ¡æ‰‹æƒ³æ¸…æ¥šäº†ï¼Œå››æ¬¡æŒ¥æ‰‹ä¹Ÿå°±ä¸è¶³ä¸ºå¥‡ã€‚å¯¹äºŽå››æ¬¡æŒ¥æ‰‹æ¥è¯´ï¼Œå…¶å®žå°±æ˜¯ä»Ž SYN è¡¨ç¤ºä½æ”¹åˆ°äº† FIN æ ‡è¯†ä½ï¼Œå¯¹äºŽæ•°æ®çš„åºå·è¿˜æ˜¯ä¸€æ ·çš„è§„åˆ™ã€‚åªä¸è¿‡ç¡®å®žæœ‰å‡ ä¸ªè¦ç‚¹éœ€è¦æ³¨æ„ã€‚ B æ”¶åˆ° FIN=1 çš„æ—¶å€™ï¼Œæ­¤æ—¶ TCP å±žäºŽå¹¶å…³é—­çŠ¶æ€äº†ï¼Œä½†æ˜¯å¾ˆæœ‰å¯èƒ½ B è¿˜æœ‰æ•°æ®éœ€è¦å‘é€ï¼Œä½†æ˜¯ A æ”¶ä¸æ”¶å°±æ˜¯ A è‡ªå·±å†³å®šäº†ã€‚ A æ”¶åˆ° FIN=1 å›žå¤äº†ä¹‹åŽï¼Œè¿˜æœ‰ä¸€ä¸ª 2MSLï¼ˆæœ€å¤§æŠ¥æ–‡å­˜æ´»æ—¶é—´ï¼‰çš„ TIME-WAIT çŠ¶æ€ ä¸ºä»€ä¹ˆè¦å››æ¬¡å…¶å®žå’Œå»ºç«‹è¿žæŽ¥æ—¶çš„åŽŸå› ä¸€æ ·ï¼šæ¯ä¸ªäººéƒ½æ”¶åˆ°äº†ä¸€é—®ä¸€ç­”ï¼Œè€Œå»ºç«‹è¿žæŽ¥æ—¶è¿˜æ²¡æœ‰æ­£åœ¨å‘é€çš„æ•°æ®ï¼Œæ‰€ä»¥ä¸­é—´é‚£æ¬¡å¯ä»¥å¤ç”¨ï¼Œæ‰€ä»¥å°±ä¸‰æ¬¡äº†ï¼Œè€Œæ–­å¼€è¿žæŽ¥æ˜¾ç„¶æ˜¯ä¸€æ–¹ä¸»åŠ¨å‘èµ·çš„ï¼Œè€Œå¦ä¸€æ–¹æ˜¯æ¯«æ— å‡†å¤‡çš„ï¼Œå°±å¦‚åŒä½ å…³é—­æ˜¾ç¤ºå™¨ï¼ŒæœåŠ¡å™¨æ˜¯æ¯«æ— å‡†å¤‡çš„ã€‚ è¿˜æœ‰åŽŸå› å°±æ˜¯å¦‚æžœ A å‘Šè¯‰ B ä¹‹åŽç›´æŽ¥èµ°äº†ï¼Œä¸ç®¡äº†ï¼Œé‚£ä¹ˆ B å°±æ‡µé€¼äº†ï¼Œè¿™ä¸ªæ—¶å€™å¯èƒ½ B è¿˜åœ¨å‘æ•°æ®ï¼ŒB å°±ç®—å‘èµ·ç»“æŸï¼Œä¹Ÿæ²¡äººå›žåº”äº†ï¼ŒB å°±åªèƒ½å‚»ç­‰ç€ï¼›å¦‚æžœ A å‘Šè¯‰ Bï¼ŒB ä¸ç®¡äº†ï¼Œé‚£ä¹ˆä¹Ÿæœ‰é—®é¢˜äº†ï¼ŒA ä¸çŸ¥é“ B æ”¶åˆ°æ²¡æœ‰ï¼ŒB å¦‚æžœæ²¡æ”¶åˆ° A è¿˜è¦ç»§ç»­å‘â€¦ ä¸ºä»€ä¹ˆéœ€è¦ TIME-WAITè¿™ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„é—®é¢˜ï¼Œæ˜Žæ˜Žéƒ½å·²ç»æ–­å¼€è¿žæŽ¥äº†ï¼Œä¸€ç›´ä¿æŒè¿™ä¸ªçŠ¶æ€ç­‰ç€å¹²å•¥ï¼Ÿ åŽŸå›  1ï¼šå¦‚æžœè¿™ä¸ªæ—¶å€™ä¸ç­‰äº†ï¼Œç›´æŽ¥æ–­å¼€è¿žæŽ¥ï¼Œé‚£æœ€åŽä¸€ä¸ªæŒ¥æ‰‹å¯èƒ½å°±åˆ°ä¸äº†äº† åŽŸå›  2ï¼šå¦‚æžœç­‰çš„æ—¶é—´çŸ­ï¼Œç›´æŽ¥å…³é—­ï¼Œå› ä¸ºå…³é—­äº†ï¼Œé‚£ä¹ˆå°±å¯ä»¥å’Œåˆ«äººå»ºç«‹æ–°çš„è¿žæŽ¥ï¼Œé‚£ä¹ˆå¾ˆæœ‰å¯èƒ½è¿˜åœ¨ç½‘ç»œä¸Šçš„è€æ•°æ®ä¼šè·‘åˆ°æ–°çš„è¿žæŽ¥é‡Œé¢æ£ä¹±äº† ä¸ºäº†å¯é ä½ ç©¶ç«Ÿåšäº†ä»€ä¹ˆTCP ä¸ºäº†åšä¸€ä¸ªå¯é çš„äººï¼Œä»˜å‡ºäº†å¾ˆå¤šä½ çœ‹ä¸è§çš„åŠªåŠ› é‡ä¼  å¦‚æžœä¸€ä¸ªå‘é€çš„æŠ¥æ–‡åœ¨è¶…æ—¶æ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°ç¡®è®¤ï¼Œé‚£ä¹ˆå°±ä¼šé‡æ–°å‘é€ï¼Œè¶…æ—¶æ—¶é—´å¹¶ä¸æ˜¯å›ºå®šçš„ï¼Œå› ä¸ºç½‘ç»œçš„çŽ¯å¢ƒä¸åŒï¼Œæ‰€ä»¥åˆ©ç”¨äº†ä¸€ä¸ª è‡ªé€‚åº”é‡ä¼ ç®—æ³•ï¼Œä¼šæ ¹æ®å½“å‰çš„å¾€è¿”æ—¶é—´è¿›è¡ŒåŠ æƒå¹³å‡è¿›è¡Œè®¡ç®—ã€‚ å½“ç„¶è¿™æ ·è¿˜æ˜¯ä¸å¤Ÿçš„ï¼Œå› ä¸ºè§¦å‘çš„å‘¨æœŸè¿˜æ˜¯å¤ªé•¿ï¼ŒäºŽæ˜¯è¿˜æœ‰ä¸€ä¸ªæœºåˆ¶å« å¿«é€Ÿé‡ä¼ ï¼Œå½“æŽ¥æ”¶æ–¹æ”¶åˆ°åºå· 5ï¼Œä½†æ˜¯çŽ°åœ¨è¿˜æ˜¯è¦åºå· 3 çš„æ—¶å€™ï¼Œé‚£ä¹ˆä¼šå‘é€å‡ ä¸ªå†—ä½™çš„è¯·æ±‚æ¥è¦ä¸­é—´ä¸¢çš„æŠ¥æ–‡ã€‚ æ»‘åŠ¨çª—å£çª—å£åœ¨å¾ˆå¤šç½‘ç»œåè®®ä¸­éƒ½æœ‰è¢«è®¾è®¡æ¥æŽ§åˆ¶æµé‡ï¼Œæˆ‘ä»¬çŸ¥é“å¦‚æžœå‘çš„å¤ªçŒ›ä¸ç®¡å®¢æˆ·ç«¯æ­»æ´»ï¼Œæˆ–è€…å‘çš„å¤ªæ…¢ï¼Œè®©å®¢æˆ·ç«¯é¥¿æ­»éƒ½æ˜¯ä¸å¥½çš„ã€‚æ‰€ä»¥çª—å£çš„å­˜åœ¨ï¼Œå°±æ˜¯ç»´æŒä¸€ä¸ªè¿”å›žï¼Œè®©ä½ çŸ¥é“åŽé¢è¯¥ä¸è¯¥å¾€ä¸‹å‘äº†ï¼Œåªæœ‰ä¸€å®¶å‘é€å¹¶å¾—åˆ°ä¸€ä¸ªç¡®è®¤ï¼Œçª—å£æ‰ä¼šç§»åŠ¨æˆ–æ”¹å˜å¤§å°ã€‚ æœ€é‡è¦çš„æ˜¯ï¼Œå½“çª—å£è¢«è®¾ç½®ä¸º 0 æ—¶ï¼Œåˆ™å‘é€ç«¯å°±ä¸èƒ½å†å‘é€æ•°æ®äº†ã€‚ æ‹¥å¡žæŽ§åˆ¶æµé‡æŽ§åˆ¶æ˜¯ä¸ºäº†æŽ§åˆ¶å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„å¤„ç†å’Œå‘é€é€Ÿåº¦ï¼Œä¸è‡³äºŽåŽ‹åž®å¯¹æ–¹ã€‚è€Œæ‹¥å¡žæŽ§åˆ¶åˆ™æ˜¯é¿å…åŽ»åŽ‹åž®ç½‘ç»œã€‚è¯´ç™½äº†ï¼Œå¯èƒ½ä½ å®¢æˆ·ç«¯å¤„ç†èƒ½åŠ›å¾ˆå¼ºï¼Œä¸€æ”¶åˆ°å¤„ç†ï¼Œä½ æ€Žä¹ˆå‘éƒ½å¯ä»¥ï¼Œä½†æ˜¯ç½‘ç»œå¸¦å®½ä¸å…è®¸ä½ è¿™ä¹ˆå¹²ã€‚ è¿™ä¸ªå›¾æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Ÿæ²¡é”™ï¼Œåªè¦ä½ å¤§å­¦é‡Œé¢å­¦è¿‡è®¡ç®—æœºç½‘ç»œï¼Œè¿™ä¸ªå›¾å¤ªç»å…¸äº†ï¼Œå¯èƒ½å½“æ—¶ä½ éƒ½ä¸ç†è§£å®ƒä¸ºä»€ä¹ˆè¦è¿™ä¹ˆè®¾è®¡ï¼Œä¸€å¼€å§‹æ…¢æ…¢å‘ï¼Œç„¶åŽè¶Šæ¥è¶Šå¿«ï¼Œç„¶åŽè¿›è¡Œæ‹¥å¡žæŽ§åˆ¶ï¼Œç„¶åŽåˆ°è¶…æ—¶ï¼Œå†æ…¢å¼€å§‹ã€‚ æ…¢å¼€å§‹ã€æ‹¥å¡žé¿å…ã€å¿«é‡ä¼ ã€å¿«æ¢å¤å°±æ˜¯æ‹¥å¡žæŽ§åˆ¶æ‰€åšçš„äº‹æƒ…äº†ã€‚ æ³¨æ„çš„æ˜¯ï¼Œå›¾ä¸­çš„ç¬¬ 4 ä¸ªç‚¹å°±æ˜¯ä¸Šé¢è¯´çš„å¿«é€Ÿé‡ä¼  3 ä¸ªå†—ä½™ ACK æ¥æ‰¾åˆ°ä¸¢çš„æŠ¥æ–‡ï¼Œå¹¶ä¸”æ˜¯ä»Ž 5 å¼€å§‹çš„ï¼Œå¹¶ä¸æ˜¯å†æ…¢å¼€å§‹ã€‚ æœ‰ä¸ªæ¯”å–»å¾ˆå½¢è±¡è¿™é‡Œçš„æŽ§åˆ¶ï¼Œå°±åƒå¾€ä¸€ä¸ªç®¡å­é‡Œé¢å€’æ°´ï¼Œä½ ä¸çŸ¥é“ç®¡å­ä¸­é—´å¤šç²—ï¼Œæ€»æ˜¯å…ˆå€’çš„å¾ˆå¿«ï¼›ç­‰æ°´æ»¡å‡ºæ¥äº†ï¼Œå“¦ï¼ŒçŸ¥é“äº†ï¼Œå€’å¤ªå¿«äº†ï¼Œå°±æ…¢ä¸€ç‚¹ï¼Œç­‰æ°´ä¸‹åŽ»ä¸€ç‚¹ç„¶åŽå†å¼€å§‹å€’ã€‚ æ€»ç»“å…¶å®žå›žå¤´çœ‹çœ‹ï¼Œæ˜¯ä¸æ˜¯ TCP å¹¶æ²¡æœ‰æƒ³è±¡ä¸­çš„é‚£ä¹ˆå¤æ‚ã€‚æ‰€ä»¥å®ƒçš„è´Ÿè´£ï¼Œå®ƒçš„æ‰€ä½œæ‰€ä¸ºéƒ½æ˜¯ä¸ºäº†æˆä¸ºä¸€ä¸ªå¯é çš„äººï¼Œé¢å¯¹çŽ°åœ¨å¤æ‚çš„ç¤¾ä¼šç½‘ç»œçŽ¯å¢ƒï¼Œå®ƒä¸å¾—ä¸åšä¸€ä¸ªå¯é çš„äººï¼Œå¦‚æžœæ²¡æœ‰å®ƒå¯é çš„è´Ÿè´£ï¼Œå¯èƒ½æˆ‘ä»¬èŠå¤©èŠåˆ°ä¸€åŠæ¶ˆæ¯ä¸è§äº†ï¼Œä¹Ÿä¸æ˜¯ä¸å¯èƒ½çš„ã€‚]]></content>
      <categories>
        <category>network</category>
      </categories>
      <tags>
        <tag>TCP</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Golang ä¹‹ WaitGroup æºç è§£æž]]></title>
    <url>%2F2020%2F03%2F15%2Fgolang%2Fsource-code%2Fsync-waitgroup-source-code%2F</url>
    <content type="text"><![CDATA[å¦‚æžœæˆ‘ä»¬æœ‰ä¸€ä¸ªå¤§çš„ä»»åŠ¡è¦åšï¼Œæˆ‘ä»¬ä¼šå°è¯•å°†è¿™ä¸ªä»»åŠ¡åˆ†è§£ï¼Œåˆ†è§£å®Œæˆä¹‹åŽå¹¶å‘äº¤ç”± goroutine åŽ»åšï¼Œå¹¶ä¸”æˆ‘éœ€è¦å½“å…¨éƒ¨çš„ä»»åŠ¡å®Œæˆä¹‹åŽå†è¿›è¡Œä¸‹é¢çš„æ­¥éª¤ï¼Œåœ¨ sync åŒ…ä¸‹ï¼Œå°±æœ‰è¿™æ ·ä¸€ä¸ªä¸œè¥¿é€‚åˆä¸Šè¿°æƒ…å†µï¼ŒWaitGroupï¼Œä»Šå¤©æˆ‘ä»¬æ¥çœ‹çœ‹å…·ä½“å®ƒæ˜¯æ€Žä¹ˆå®žçŽ°çš„ã€‚ PSï¼šåœ¨ä¸‹é¢æˆ‘ç»Ÿä¸€ç”¨ wg æ¥ç®€ç§° WaitGroup ä½¿ç”¨å®ƒçš„ä½¿ç”¨éžå¸¸ç®€å•ï¼Œå¦‚ä¸‹: 12345678910111213func main () &#123; wg := sync.WaitGroup &#123;&#125; for i := 0; i &lt; 10; i++ &#123; wg.Add (1) go func (job int) &#123; defer wg.Done () //do something fmt.Printf ("job % d done\n", job) &#125;(i) &#125; wg.Wait () fmt.Println ("all done")&#125; è¾“å‡ºï¼š 1234567891011job 9 donejob 1 donejob 0 donejob 8 donejob 7 donejob 3 donejob 6 donejob 2 donejob 4 donejob 5 doneall done æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨éžå¸¸ç®€å•ï¼Œæ¯æ¬¡æœ‰ä¸€ä¸ªä»»åŠ¡å°±ä½¿ç”¨ Add æ–¹æ³•åŠ ä¸€ä¸ªï¼Œæ¯æ¬¡åšå®Œä»»åŠ¡å°±ä½¿ç”¨ Done æ–¹æ³•å‘Šè¯‰å®ƒå·²ç»å®Œæˆäº†ï¼Œè€Œ Wait å°±æ˜¯ç­‰ç€æ‰€æœ‰çš„ä»»åŠ¡å®Œæˆã€‚ æ€è€ƒé—®é¢˜åœ¨çœ‹ wg çš„å®žçŽ°ä¹‹å‰ï¼Œé¦–å…ˆæ¥é—®å‡ ä¸ªé—®é¢˜ï¼Œæ¥è€ƒè€ƒè‡ªå·±ã€‚ Wait æ–¹æ³•èƒ½å¦è¢«å¤šæ¬¡è°ƒç”¨ï¼Œæ¯”å¦‚å†å¼€ä¸€ä¸ª goroutine åŽ» wait Wait æ–¹æ³•è°ƒç”¨åŽæ˜¯å¦è¿˜èƒ½å†ç»§ç»­è°ƒç”¨ Add æ·»åŠ ä»»åŠ¡ æ¯æ¬¡åªèƒ½ Done ä¸€ä¸ªä»»åŠ¡ï¼Œèƒ½å¦ä¸€æ¬¡æ€§ Done å¤šä¸ªä»»åŠ¡å‘¢ wg èƒ½å¦è¢«æ‹·è´æˆ–ä½œä¸ºå‚æ•°ä¼ é€’ å¦‚æžœè®©ä½ è‡ªå·±å®žçŽ°ä¸€ä¸ªï¼Œä½ ä¼šå¦‚ä½•å®žçŽ° å‰å‡ ä¸ªé—®é¢˜ï¼Œå¦‚æžœä½ éƒ½èƒ½å¾ˆæ¸…æ¥šçš„å›žç­”ï¼Œé‚£ä¹ˆä½ å¯¹ wg çš„äº†è§£å¯ä»¥è¯´å·²ç»éžå¸¸ç†Ÿæ‚‰äº†ã€‚é¦–é€‰æˆ‘æ¥è¯´ä¸€ä¸‹å¯¹äºŽæœ€åŽçš„ä¸€ä¸ªé—®é¢˜çš„å›žç­”ï¼Œå› ä¸ºåœ¨çœ‹æºç ä¹‹å‰æˆ‘éƒ½ä¼šæƒ³æƒ³å¦‚æžœæ˜¯æˆ‘ï¼Œæˆ‘ä¼šå¦‚ä½•åŽ»å®žçŽ°ï¼Œé‚£ä¹ˆæˆ‘æƒ³çš„ä¹Ÿå¾ˆç®€å•ã€‚ ä½¿ç”¨ä¸€ä¸ªå˜é‡è¿›è¡Œè®¡æ•° æ¯æ¬¡ä»»åŠ¡æ•°é‡å˜æ›´æ—¶ä½¿ç”¨ atom åŽŸå­æ“ä½œ + 1 æˆ–è€… - 1 -1 æ—¶åˆ¤æ–­ä»»åŠ¡æ•°é‡æ˜¯å¦å·²ç»ä¸º 0 å¦‚æžœä¸º 0 å‘ä¸€ä¸ª channel é‡Œé¢å‘é€æ¶ˆæ¯ æ‰€æœ‰ wait çš„åœ°æ–¹ç›‘å¬ channel çš„æ¶ˆæ¯ï¼Œæ”¶åˆ°æ¶ˆæ¯åˆ™è¯æ˜Žä»»åŠ¡å…¨éƒ¨å®Œæˆ æºç åˆ†æžç»“æž„123456789type WaitGroup struct &#123; noCopy noCopy // 64-bit value: high 32 bits are counter, low 32 bits are waiter count. // 64-bit atomic operations require 64-bit alignment, but 32-bit //compilers do not ensure it. So we allocate 12 bytes and then use //the aligned 8 bytes in them as state, and the other 4 as storage //for the sema. state1 [3] uint32&#125; ç»“æž„éžå¸¸ç®€å•ï¼Œå°±åªæœ‰ä¸¤ä¸ªç†Ÿæ‚‰ï¼Œä¸€ä¸ª noCopy è¿˜æœ‰ä¸€ä¸ª state1ï¼ˆæˆ‘ä¹Ÿå¾ˆå¥½å¥‡ä¸ºä»€ä¹ˆè¦ç”¨ 1 æ¥ç»“å°¾å‘½åï¼Œå¤§ä½¬çš„æƒ³æ³•æ€»æ˜¯å¾ˆå¥‡å¦™ï¼‰ noCopyï¼š sync åŒ…ä¸‹çš„ä¸€ä¸ªç‰¹æ®Šæ ‡è®°å§ï¼Œvet æ£€æŸ¥ï¼Œå¦‚æžœæœ‰æ‹·è´çš„å˜é‡åˆ™ä¼šæŠ¥é”™ 12345func main () &#123; wg := sync.WaitGroup &#123;&#125; w := wg fmt.Println (w, wg)&#125; ä½  run è‚¯å®šæ²¡é—®é¢˜çš„ï¼Œä½†æ˜¯å¦‚æžœä½ ä½¿ç”¨ go vet åšä¸ªæ£€æŸ¥å°±æœ‰è­¦å‘Šäº† 12345âžœ go vet main.go# command-line-arguments./main.go:10:10: assignment copies lock value to w: sync.WaitGroup contains sync.noCopy./main.go:11:17: call of fmt.Println copies lock value: sync.WaitGroup contains sync.noCopy./main.go:11:20: call of fmt.Println copies lock value: sync.WaitGroup contains sync.noCopy state1ï¼šæ˜¯ç”¨æ¥å­˜æ”¾ä»»åŠ¡è®¡æ•°å™¨å’Œç­‰å¾…è€…è®¡æ•°å™¨çš„ï¼ˆæˆ‘ä¸€çœ‹åˆ°è¿™ä¸ªç»“æž„å°±æ˜Žç™½è‚¯å®šåŽé¢åˆæ˜¯ä½æ“ä½œè¿™æ ·çš„é«˜ç«¯æ“ä½œäº†ï¼‰ state [0] state [1] state [2] 64 ä½ waiter counter sema 32 ä½ sema waiter counter å…¶ä¸­ waiter æ˜¯ç­‰å¾…è€…è®¡æ•°ï¼Œcounter æ˜¯ä»»åŠ¡è®¡æ•°ï¼Œsema æ˜¯ä¿¡å·é‡ å¥‡æ€ªçš„æ˜¯åœ¨ 64 ä½è¿˜ 32 ä½æ“ä½œç³»ç»Ÿä¸Šæ˜¯ä¸ä¸€æ ·çš„ï¼Œå…·ä½“åŽŸå› ä»¥åŠå¯¹äºŽå®ƒæ“ä½œè¯·ç»§ç»­çœ‹ä¸‹åŽ» state12345678//state returns pointers to the state and sema fields stored within wg.state1.func (wg *WaitGroup) state () (statep *uint64, semap *uint32) &#123; if uintptr (unsafe.Pointer (&amp;wg.state1))%8 == 0 &#123; return (*uint64)(unsafe.Pointer (&amp;wg.state1)), &amp;wg.state1 [2] &#125; else &#123; return (*uint64)(unsafe.Pointer (&amp;wg.state1 [1])), &amp;wg.state1 [0] &#125;&#125; è¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªå†…éƒ¨æ–¹æ³•ï¼Œå°±æ˜¯å°† state1 ä¸­å­˜å‚¨çš„çŠ¶æ€å–å‡ºæ¥ï¼Œè¿”å›žå€¼ statep å°±æ˜¯è®¡æ•°å™¨çš„çŠ¶æ€ï¼Œsemap æ˜¯ä¿¡å·é‡ Done123func (wg *WaitGroup) Done () &#123; wg.Add (-1)&#125; æ²¡æƒ³åˆ°å§ï½žå±…ç„¶ Done å°±æ˜¯è°ƒç”¨ Add å¹¶ä¼ é€’ä¸€ä¸ª - 1 æ‰€ä»¥å…¶å®žæˆ‘ä»¬å®Œå…¨å¯ä»¥å†å¤–éƒ¨è°ƒç”¨ Add ä¼ é€’ä¸€ä¸ª - 3 ä¸€æ¬¡æ€§ç»“æŸ 3 ä¸ªä»»åŠ¡ Add12345678910111213141516171819202122232425262728293031323334func (wg *WaitGroup) Add (delta int) &#123; // é¦–å…ˆèŽ·å–çŠ¶æ€å€¼ statep, semap := wg.state () // å¯¹äºŽ statep ä¸­ counter + delta state := atomic.AddUint64 (statep, uint64 (delta)&lt;&lt;32) // èŽ·å–ä»»åŠ¡è®¡æ•°å™¨çš„å€¼ v := int32 (state &gt;&gt; 32) // èŽ·å–ç­‰å¾…è€…è®¡æ•°å™¨çš„å€¼ w := uint32 (state) // ä»»åŠ¡è®¡æ•°å™¨ä¸èƒ½ä¸ºè´Ÿæ•° if v &lt; 0 &#123; panic ("sync: negative WaitGroup counter") &#125; // å·²ç»æœ‰äººåœ¨ç­‰å¾…ï¼Œä½†æ˜¯è¿˜åœ¨æ·»åŠ ä»»åŠ¡ if w != 0 &amp;&amp; delta &gt; 0 &amp;&amp; v == int32 (delta) &#123; panic ("sync: WaitGroup misuse: Add called concurrently with Wait") &#125; // æ²¡æœ‰ç­‰å¾…è€…æˆ–è€…ä»»åŠ¡è¿˜æœ‰æ²¡åšå®Œçš„ if v &gt; 0 || w == 0 &#123; return &#125; // æœ‰ç­‰å¾…è€…ï¼Œä½†æ˜¯åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ•°æ®è¿˜åœ¨å˜åŠ¨ if *statep != state &#123; panic ("sync: WaitGroup misuse: Add called concurrently with Wait") &#125; // Reset waiters count to 0. // é‡ç½®çŠ¶æ€ï¼Œå¹¶ç”¨å‘å‡ºç­‰åŒäºŽç­‰å¾…è€…æ•°é‡çš„ä¿¡å·é‡ï¼Œå‘Šè¯‰æ‰€æœ‰ç­‰å¾…è€…ä»»åŠ¡å·²ç»å®Œæˆ *statep = 0 for ; w != 0; w-- &#123; runtime_Semrelease (semap, false, 0) &#125;&#125; è¿™é‡Œæœ‰å‡ ä¸ªè¦ç‚¹æˆ‘ä»¬å…¶å®žå·²ç»çœ‹åˆ°äº†ï¼š Wait çš„ è¿‡ç¨‹ä¸­ æ˜¯ä¸èƒ½ Add çš„ï¼Œä¸ç„¶å°±ä¼š panicï¼Œè¦æ³¨æ„ è™½ç„¶æˆ‘ä»¬å¯ä»¥å€ŸåŠ© Add ä¸€ä¸ªè´Ÿæ•°æ¥ä¸€æ¬¡æ€§ç»“æŸå¤šä¸ªä»»åŠ¡ï¼Œä½†æ˜¯å¦‚æžœä»»åŠ¡æ•°é‡æŽ§åˆ¶çš„ä¸å¥½ï¼Œå˜æˆè´Ÿæ•°ä¹Ÿä¼š panicï¼ŒDone æ¬¡æ•°å¤šäº†ä¹Ÿä¸€æ · wg æ˜¯é€šè¿‡ä¿¡å·é‡æ¥é€šçŸ¥çš„ï¼Œå½“ç„¶å¯ä»¥æœ‰å¾ˆå¤šäººåœ¨ç­‰ï¼Œwg å®ƒéƒ½ä¼šä¸€ä¸€é€šçŸ¥åˆ°ä½çš„ Wait12345678910111213141516171819202122232425262728func (wg *WaitGroup) Wait () &#123; // å…ˆèŽ·å–çŠ¶æ€ statep, semap := wg.state () for &#123; // è¿™é‡Œæ³¨æ„è¦ç”¨ atomic çš„ Load æ¥ä¿è¯ä¸€ä¸‹å†™æ“ä½œå·²ç»å®Œæˆ state := atomic.LoadUint64 (statep) // åŒæ ·çš„ï¼Œè¿™é‡Œæ˜¯ä»»åŠ¡è®¡æ•° v := int32 (state &gt;&gt; 32) // è¿™é‡Œæ˜¯ç­‰å¾…è€…è®¡æ•° w := uint32 (state) // å¦‚æžœæ²¡æœ‰ä»»åŠ¡ï¼Œé‚£ä¹ˆç›´æŽ¥ç»“æŸï¼Œä¸ç”¨ç­‰å¾…äº† if v == 0 &#123; return &#125; // ä½¿ç”¨ cas æ“ä½œï¼Œå¦‚æžœä¸ç›¸ç­‰ï¼Œè¯æ˜Žä¸­é—´å·²ç»è¢«å…¶ä»–äººä¿®æ”¹äº†çŠ¶æ€ï¼Œé‡æ–°èµ° for å¾ªçŽ¯ // æ³¨æ„è¿™é‡Œ if è¿›åŽ»ä¹‹åŽç­‰å¾…è€…çš„æ•°é‡å°± +1 äº† if atomic.CompareAndSwapUint64 (statep, state, state+1) &#123; // ç­‰å¾…ä¿¡å·é‡ runtime_Semacquire (semap) // å¦‚æžœä¿¡å·é‡æ¥äº†ï¼Œä½†æ˜¯çŠ¶æ€è¿˜ä¸æ˜¯ 0ï¼Œåˆ™è¯æ˜Ž wait ä¹‹åŽè¿˜æ˜¯åœ¨äººåœ¨ addï¼Œè¯æ˜Žæœ‰äººæƒ³å……åˆ†åˆ©ç”¨ wg ä½†æ˜¯æ—¶æœºä¸å¯¹ if *statep != 0 &#123; panic ("sync: WaitGroup is reused before previous Wait has returned") &#125; return &#125; &#125;&#125; å…¶å®ž wait è™½ç„¶ç®€å•ï¼Œä¹Ÿæœ‰è¦ç‚¹ é€šè¿‡ load å’Œ cas æ“ä½œ + å¾ªçŽ¯æ¥é¿å…äº†é”ï¼Œå…¶å®žè¿™ä¸ªæ“ä½œå¯ä»¥å­¦ä¸€ä¸‹ å…¶å®žè¿™é‡Œä¹Ÿè¯´æ˜Žæ˜Žç™½äº†ï¼Œwg å¯ä»¥é‡ç”¨ï¼Œä½†æ˜¯ä½ å¿…é¡»ç­‰åˆ° wait å…¨éƒ¨å®Œæˆä¹‹åŽå†è¯´ å…¶ä»–æ³¨æ„ç‚¹12345678910111213141516func main () &#123; wg := sync.WaitGroup &#123;&#125; for i := 0; i &lt; 10; i++ &#123; wg.Add (1) go func (job int) &#123; doJob (job, wg) &#125;(i) &#125; wg.Wait () fmt.Println ("all done")&#125;func doJob (job int, wg sync.WaitGroup) &#123; fmt.Printf ("job % d done\n", job) wg.Done ()&#125; ä¸Šé¢çš„ä»£ç æœ‰é—®é¢˜å—ï¼Ÿé—®é¢˜åœ¨å“ªå‘¢ï¼Ÿ å…¶å®žå¾ˆç®€å•ï¼Œwg ä½œä¸ºä¸€ä¸ªå‚æ•°ä¼ é€’çš„æ—¶å€™ï¼Œwg è¿˜æ˜¯ä¸€ä¸ªæ™®é€šçš„ç»“æž„ä½“ï¼Œæˆ‘ä»¬åœ¨å‡½æ•°ä¸­æ“ä½œçš„æ—¶å€™è¿˜æ˜¯æ“ä½œçš„ä¸€ä¸ªæ‹·è´çš„å˜é‡è€Œå·²ï¼Œå¯¹äºŽåŽŸæ¥çš„ wg æ˜¯ä¸ä¼šæ”¹å˜çš„ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦ä¼ é€’æŒ‡é’ˆæ‰æ˜¯æ­£ç¡®çš„ 12345678910111213141516func main () &#123; wg := &amp;sync.WaitGroup &#123;&#125; for i := 0; i &lt; 10; i++ &#123; wg.Add (1) go func (job int) &#123; doJob (job, wg) &#125;(i) &#125; wg.Wait () fmt.Println ("all done")&#125;func doJob (job int, wg *sync.WaitGroup) &#123; fmt.Printf ("job % d done\n", job) wg.Done ()&#125; ä½†æ˜¯å…¶å®žå¹¶ä¸æŽ¨èè¿™æ ·åŽ»ä¼ é€’ wgï¼Œå› ä¸ºè¿™æ ·å¾ˆå®¹æ˜“å‡ºçŽ°é—®é¢˜ï¼Œä¸€ä¸ªä¸å¥½å°±å‡ºé—®é¢˜äº†ï¼Œä¸ªäººè¿˜æ˜¯å»ºè®®ç›´æŽ¥åœ¨ä½¿ç”¨ goroutine ä¹‹åŽé©¬ä¸ŠæŽ¥ä¸€ä¸ª defer wg.Done () æ¥çš„æ›´åŠ é è°±ä¸€äº› æ€»ç»“å›žè¿‡å¤´æ¥çœ‹çœ‹ï¼Œä¹‹å‰çš„é—®é¢˜ä¹Ÿéƒ½æœ‰äº†ç­”æ¡ˆï¼š Wait å¯ä»¥è¢«è°ƒç”¨å¤šæ¬¡ï¼Œå¹¶ä¸”æ¯ä¸ªéƒ½ä¼šæ”¶åˆ°å®Œæˆçš„é€šçŸ¥ Wait ä¹‹åŽï¼Œå¦‚æžœå† Wait çš„è¿‡ç¨‹ä¸­ä¸èƒ½åœ¨ Addï¼Œå¦åˆ™ä¼š panicï¼Œä½†æ˜¯ Wait ç»“æŸä¹‹åŽå¯ä»¥ç»§ç»­ä½¿ç”¨ Add è¿›è¡Œé‡ç”¨ å¯ä»¥ä½¿ç”¨ Add ä¼ é€’è´Ÿæ•°çš„æ–¹å¼ä¸€æ¬¡æ€§ç»“æŸå¤šä¸ªä»»åŠ¡ï¼Œä½†æ˜¯éœ€è¦ä¿è¯ä»»åŠ¡è®¡æ•°å™¨éžè´Ÿï¼Œå¦åˆ™ä¼š panic wgä½œä¸ºå‚æ•°ä¼ é€’çš„æ—¶å€™éœ€è¦æ³¨æ„ä¼ é€’æŒ‡é’ˆï¼Œæˆ–è€…å°½é‡é¿å…ä¼ é€’ å®˜æ–¹åˆ©ç”¨ä½æ“ä½œèŠ‚çº¦äº†ç©ºé—´ï¼Œå­˜åœ¨åœ¨åŒä¸€ä¸ªåœ°æ–¹ï¼›åˆ©ç”¨ä¿¡å·é‡æ¥å®žçŽ°ä»»åŠ¡ç»“æŸçš„é€šçŸ¥â€¦. æ€»çš„æ¥è¯´ wg çš„å®žçŽ°è¿˜æ˜¯éžå¸¸ç®€å•çš„ï¼Œéœ€è¦æ³¨æ„çš„å°±æ˜¯å‡ ä¸ªä½¿ç”¨ä¸Šçš„ç‚¹ä¸è¦å‡ºçŽ°æ„å¤–å³å¯ã€‚]]></content>
      <categories>
        <category>golangæºç è§£æž</category>
      </categories>
      <tags>
        <tag>sync.WaitGroup</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å›žé¦–ç½‘ç»œçŸ¥è¯†ä¹‹ UDP åè®®]]></title>
    <url>%2F2020%2F03%2F14%2Fnetwork%2Fudp%2F</url>
    <content type="text"><![CDATA[æœ€è¿‘å¼€å§‹åœ¨æ¶è¡¥ç½‘ç»œçŸ¥è¯†ï¼Œç®—æ˜¯ä¸€ä¸ªå¤ä¹ ï¼Œåœ¨å­¦ä¹ äº†å¾ˆå¤šä¸Šå±‚å»ºç­‘ä¹‹åŽå›žæ¥çœ‹çœ‹ä¹‹å‰çš„åŸºç¡€ç¡®å®žåˆæœ‰ä¸€ä¸ªæ–°çš„è®¤è¯†ã€‚ä¸€å¼€å§‹å‡†å¤‡çœ‹å®Œä¹‹åŽåšä¸€ä¸ªæ•´ä½“çš„æ€»ç»“ï¼Œä½†æ˜¯å‘çŽ°çŸ¥è¯†ç‚¹å¤ªå¤šæ‰€ä»¥åˆ†äº†å‡ æœŸæ¥å†™ï¼Œæ¯æœŸéƒ½ä¼šçŸ­ä¸€ç‚¹ï¼Œè¿™æœŸæˆ‘ä»¬å…ˆæ¥ç®€å•äº†è§£ä¸€ä¸‹ UDP å‰è¨€ä¼ è¾“å±‚ä¸­é‡è¦çš„ä¸¤ä¸ªåè®® UDP å’Œ TCP ï¼Œåœ¨å¹³æ—¶çš„æ—¶å€™ï¼Œä½ è™½ç„¶ä¸€ç›´ç”¨ç€ä»–ä»¬ï¼Œä½†æ˜¯å¾€å¾€æ„Ÿå—ä¸åˆ°ä»–ä»¬çš„å­˜åœ¨ï¼Œä»–ä»¬ä¸¤ä¸ªå¾€å¾€ç»å¸¸ä¼šåœ¨é¢è¯•çš„æ—¶å€™å‡ºçŽ°ï¼Œæ‰“ä½ ä¸€ä¸ªæŽªæ‰‹ä¸åŠã€‚ åœ¨å­¦ä¹ å®ƒä¹‹å‰ï¼Œä½ é¦–å…ˆè¦æœ‰ä¸€ä¸ªæ¦‚å¿µï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ UDP æˆ–è€… TCP è¿™æ ·çš„åè®®ï¼Œå®ƒåˆ°åº•æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™ï¼Œä»€ä¹ˆåœ°æ–¹ï¼Œå¸®æˆ‘ä»¬å®Œæˆäº†ä»€ä¹ˆæ ·çš„äº‹æƒ…ï¼Ÿ åœ¨ç½‘ç»œï¼Œæˆ‘ä»¬ç ”ç©¶çš„å¾€å¾€éƒ½æ˜¯å¦‚ä½•ä»¥ä¸€ç§åˆç†çš„æ–¹å¼ä¼ é€’æ•°æ® è€Œä¸”åè®®åˆ™æŒ‡å®šäº†è¿™æ ·çš„è§„å®šï¼Œå½“åŒæ–¹éƒ½éµå®ˆè¿™æ ·çš„è§„å®šï¼Œæ‰èƒ½çœ‹æ‡‚äº’ç›¸è¯´çš„è¯ï¼Œæ‰èƒ½è¾¾åˆ°åˆç†ä¼ é€’æ•°æ®çš„ç›®çš„ã€‚ UDP æ€Žä¹ˆæ · UDP æ ¼å¼ç®€å•ï¼Œæ²¡æœ‰èŠ±é‡Œèƒ¡å“¨çš„ä¸œè¥¿ UDP ä¸ä¼šå…ˆæŽ¢è·¯ï¼Œè€Œæ˜¯ç›´æŽ¥å°±å‘ä¸Šäº† UDP ä¸ä¼šç®¡ä½ å¡ä¸å¡ï¼Œå‘ç»™ä½ æˆ‘å°±ä¸ç®¡äº† æŠ¥æ–‡æ ¼å¼ æºç«¯å£å·ï¼ˆ16 ä½ï¼Œ2 å­—èŠ‚ï¼‰ ç›®çš„ç«¯å£ï¼ˆ16 ä½ï¼Œ2 å­—èŠ‚ï¼‰ UDP é•¿åº¦ï¼ˆ16 ä½ï¼Œ2 å­—èŠ‚ï¼‰ UDP æ ¡éªŒå’Œï¼ˆ16 ä½ï¼Œ2 å­—èŠ‚ï¼‰ æ•°æ® æ•°æ® æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒUDP çš„æŠ¥æ–‡çœŸçš„æ˜¯å¾ˆç®€å•ï¼Œé™¤äº†ç®€å•çš„å¯¹äºŽæ•°æ®åšäº†æ ¡éªŒï¼Œå°±æ˜¯å¿…è¦çš„ç«¯å£å·ï¼Œæ²¡äº†ã€‚ UDP å¯¹æ¯” TCPå…¶å®žè¿™ä¸¤è€…åŒºåˆ«å·¨å¤§ï¼Œä½†æ˜¯ä½ è¦æ˜Žç™½çš„æ˜¯ä¸ºä»€ä¹ˆä¼šæœ‰è¿™æ ·çš„åŒºåˆ«ã€‚ è¿žæŽ¥å¦‚æžœæœ‰äººé—®ï¼ŒTCP å’Œ UDP çš„åŒºåˆ«ï¼Ÿ å¾ˆå¤šæ—¶å€™ä¼šå¾—åˆ°çš„ç¬¬ä¸€ä¸ªç­”æ¡ˆå°±æ˜¯å‘Šè¯‰ä½ ï¼ŒTCP æ˜¯é¢å‘è¿žæŽ¥çš„ï¼Œè€Œ UDP æ˜¯é¢å‘æ— è¿žæŽ¥çš„ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œæ˜¯è¯´ UDP ä¸éœ€è¦ç½‘ç»œè¿žæŽ¥å—ï¼Ÿé‚£ UDP çš„åŒ…ä¸é€šè¿‡ç½‘ç»œè¿žæŽ¥æ€Žä¹ˆå‘é€çš„å‘¢ï¼Ÿ å…¶å®žï¼Œè¿™é‡Œæ‰€è°“çš„è¿žæŽ¥æ˜¯æŒ‡ï¼Œ å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ˜¯å¦æœ‰åœ¨ç»´æŠ¤åŒæ–¹é€šä¿¡çš„çŠ¶æ€ ï¼Œå¦‚æžœç»´æŠ¤äº†è¿™æ ·çš„çŠ¶æ€ï¼Œé‚£ä¹ˆå¯¹äºŽæœåŠ¡ç«¯æ¥è¯´æˆ‘å¾ˆæ¸…æ¥šçŽ°åœ¨çš„å±€åŠ¿çŠ¶å†µï¼Œå®¢æˆ·ç«¯å‘äº†å¤šå°‘æ•°æ®äº†ï¼Œæ˜¯å¦éœ€è¦æ–­å¼€äº†ï¼Œæ˜¯å¦æœ‰ä¸¢æ•°æ®äº†ç­‰ç­‰ã€‚ å¯é TCP ä¸ºä»€ä¹ˆè¯´å®ƒå¯é ï¼Œè€Œ UDP ä¸å¯é å‘¢ï¼Ÿ ä¹Ÿå¾ˆç®€å•ï¼Œä½ çœ‹æŠ¥æ–‡æ ¼å¼å°±å¾ˆæ¸…æ¥šï¼ŒUDP æ²¡æœ‰åšè¿‡å¤šçš„æ ¡éªŒï¼Œå¯¹äºŽ UDP çš„åŒ…æ¥è¯´ï¼Œé‡å¤äº†ï¼Œæ²¡æ”¶åˆ°éƒ½æ˜¯è¿™æ ·çš„äº‹æƒ…å‡ºçŽ°éƒ½æ˜¯å®Œå…¨ä¸æ¸…æ¥šçš„ã€‚ è€Œ TCP å°±å¯é å¾ˆå¤šäº†ï¼Œå®ƒçš„æŠ¥æ–‡æ ¼å¼ææ€•è¦ä½ èƒŒï¼Œä½ å¯èƒ½å°±è¦æƒ³æƒ³äº†å§ï¼Œå®ƒéœ€è¦å¾ˆå¤šä¸œè¥¿åŽ»æŽ§åˆ¶ï¼ŒåŽ»ä¿è¯æœ‰åºã€æ— å·®é”™ã€ä¸ä¸¢å¤±ã€ä¸é‡å¤ã€‚ å­—èŠ‚æµ å’Œ æ•°æ®æŠ¥TCP æ˜¯é¢å‘å­—èŠ‚æµçš„ï¼Œå‘é€çš„æ—¶å€™ä¸€ä¸ªæµå°±è¿‡æ¥äº†ï¼Œè€Œ UDP æ˜¯æ•°æ®æŠ¥çš„ï¼Œä¸€ä¸ªä¸ªæ¥çš„ æ‹¥å¡žæŽ§åˆ¶è¿™ä¸ªä¹Ÿå¾ˆå¥½ç†è§£ï¼ŒTCP å› ä¸ºä»–çŸ¥é“çš„å¤šï¼Œä»–å¾ˆæ¸…æ¥šå½“å‰å±€åŠ¿ï¼Œç½‘ç»œçŠ¶å†µï¼Œä»Žè€Œä¼šä¸»åŠ¨æŽ§åˆ¶å‘é€çš„é¢‘çŽ‡ï¼Œè€Œ UDP å®ƒå•¥ä¹Ÿä¸çŸ¥é“ï¼Œæ²¡åŠžæ³•æŽ§åˆ¶å‘é€é¢‘çŽ‡ï¼Œå®ƒéƒ½ä¸çŸ¥é“åˆ«äººæ”¶åˆ°äº†æ²¡æœ‰ï¼Œåªç®¡å‘å°±å®Œäº‹äº†ã€‚ åº”ç”¨åœºæ™¯é‚£ä¹ˆ UDP é‚£ä¹ˆä¸é è°±ï¼Œé‚£ä»€ä¹ˆæƒ…å†µä¸‹ä¼šç”¨åˆ°è¿™ä¸ªåè®®å‘¢ï¼Ÿä¹‹å‰éƒ½ä¸€ç›´åœ¨è¯´ UDP å’Œ TCP æ¯”æœ‰ä»€ä¹ˆä¸å¥½çš„åœ°æ–¹ï¼Œä½†æ˜¯å®ƒæœ‰ç€åˆ«äººæ— æ³•ç›¸æ¯”çš„ä¼˜ç‚¹ï¼Œé‚£å°±æ˜¯å¿«ã€‚ å†…ç½‘çŽ¯å¢ƒå¾ˆå¤šæ—¶å€™åœ¨å†…ç½‘çŽ¯å¢ƒï¼Œç½‘ç»œæ¡ä»¶æ˜¯å¾ˆå¥½çš„ï¼Œåˆèƒ½ä¸¤ä¸ªè®¾å¤‡ä¹‹é—´å°±ç»è¿‡äº†ä¸€ä¸ªè·¯ç”±å™¨è€Œå·²ï¼Œç›¸æ¯”äºŽäº’è”ç½‘ä¸­çº·ç¹å¤æ‚çš„ä¸–ç•Œï¼Œè¿™ä¸ªæ—¶å€™ä¸¢åŒ…çš„å¯èƒ½æ€§å°±å¾ˆå°äº†ã€‚é‚£ä¹ˆè¿™ä¸ªæ—¶å€™ä¸ºäº†é€Ÿåº¦ï¼Œä½¿ç”¨ UDP å°±æ˜¯å¾ˆå¥½çš„é€‰æ‹© DHCP åŠ¨æ€ä¸»æœºé…ç½®åè®®ï¼Œåœ¨åˆ†é… IP åœ°å€çš„æ—¶å€™æ˜¾ç„¶è‚¯å®šæ˜¯å†…ç½‘ï¼Œç”¨ UDP å†å¥½ä¸è¿‡äº† TFTP ç®€å•æ–‡ä»¶ä¼ è¾“åè®®ï¼Œå½“ä½¿ç”¨ PXE æ–¹å¼å®‰è£…æ“ä½œç³»ç»Ÿæ—¶ï¼Œå½“ DHCP è¿”å›ž PXE æœåŠ¡å™¨åœ°å€ï¼Œç„¶åŽè¦åšçš„å°±æ˜¯ä¸‹è½½é•œåƒäº†ï¼Œè€Œé•œåƒä¸€èˆ¬éƒ½æŒºå¤§çš„ï¼Œè€Œè¿™ä¸ªæ—¶å€™ä½¿ç”¨ UDP å¾ˆåˆé€‚ SNMP ç®€å•ç½‘ç»œç®¡ç†åè®®ï¼Œç”¨å®ƒå¯ä»¥ç®¡ç†ç½‘ç»œä¸­çš„å¾ˆå¤šè®¾å¤‡ï¼ŒèŽ·å–è¿™äº›è®¾å¤‡çš„çŠ¶æ€ï¼Œå½“ç„¶è¿™äº›ç½‘ç»œè®¾å¤‡éƒ½æ˜¯åœ¨å†…ç½‘çš„ä¸€ä¸ªå®‰å…¨çŽ¯å¢ƒä¸‹ é€Ÿåº¦ &amp; å®žæ—¶æ€§å¾ˆå¤šæ—¶å€™æˆ‘ä»¬å¯¹äºŽé€Ÿåº¦å’Œå®žæ—¶æ€§æœ‰è¦æ±‚ï¼Œè€Œåˆå¯¹ä¸¢å¤±ä¸€ä¸¤ä¸ªæ•°æ®å¹¶ä¸åœ¨æ„çš„æ—¶å€™å°±ä¼šç”¨åˆ° UDPï¼Œä½ å¯èƒ½ä¼šå¥½å¥‡æœ‰è¿™æ ·çš„åœºæ™¯å—ï¼Ÿæœ‰çš„ ç›´æ’­ï¼Œå¦‚æžœä¸¢äº†å…¶ä¸­æŸä¸€å¸§çš„ç”»é¢å¹¶ä¸å½±å“ç”¨æˆ·æ•´ä½“è§‚çœ‹ï¼Œè€Œå¦‚æžœæˆ‘éžè¦ç­‰åˆ°è¿™ä¸€å¸§çš„æ•°æ®é‡ä¼ ç»™æˆ‘ï¼Œé‚£è‚¯å®šå°±å¡äº†ã€‚ FPS æ¸¸æˆï¼Œå¯¹äºŽå®žæ—¶æ€§è¦æ±‚è¦çš„æ¸¸æˆï¼Œå¾ˆå¤šæ—¶å€™éƒ½ä¼šåœ¨åè®®ä¸Šå¥½å¥½çš„åšæ–‡ç« ï¼Œå› ä¸ºä¼šéžå¸¸å½±å“ç”¨æˆ·ä½“éªŒï¼ŒåŒæ ·çš„ï¼Œå¦‚æžœä¸­é—´æœ‰æ•°æ®ä¸¢äº†ï¼Œä¸èƒ½ç­‰ç€è¿™ä¸ªæ•°æ®é‡å‘ç»™æˆ‘ï¼Œå¦åˆ™ç­‰æ•°æ®å›žæ¥æ—©å°±è¢«åˆ«äººæ‰“æ­»äº†ã€‚ æ‰©å±•å› ä¸º UDP å‡ ä¹Žä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œæ‰€ä»¥å®ƒå°±èƒ½è¢«æ”¹æˆä½ æƒ³è¦çš„æ ·å­ï¼Œå¦‚æžœä½ è§‰å¾—å½“å‰å¯é æ€§ä¸å¤Ÿï¼Œä½ å¯ä»¥è‡ªå·±åœ¨ä¸Šå±‚ç»§ç»­å®žçŽ°å¦‚ï¼šé‡ä¼ ã€æ‹¥å¡žæŽ§åˆ¶ç­‰åŠŸèƒ½æ¥æ‰©å±•ã€‚ QUIC å¿«é€Ÿ UDP äº’è”ç½‘è¿žæŽ¥ï¼Œgoogle æå‡ºçš„ä½¿ç”¨ UDP è¿›è¡Œå¤šè·¯å¹¶å‘ä¼ è¾“çš„åè®®ï¼ŒåŸºäºŽ UDP çš„ä¸€ä¸ªåè®®ï¼Œæœ‰ TLSï¼Œæœ‰ HTTP2ï¼Œåˆ©ç”¨ç¼“å­˜å‡å°‘è¿žæŽ¥æ—¶é—´ç­‰ç­‰ ä¸åªæ˜¯ UDPå½“ç„¶åº”ç”¨å±‚çš„å…¶å®žæœ‰çš„åè®®å¹¶ä¸åªæ˜¯ä½¿ç”¨ç®€å•çš„ä¸€ä¸ª UDP æˆ–è€… TCP æ¥å®žçŽ°ï¼Œæœ‰çš„æ—¶å€™ä¸¤è€…éƒ½ä¼šä½¿ç”¨ Socketè¿™ä¸ªæ˜¯æˆ‘ä»¬æœ€å¸¸è§çš„åœ¨åº”ç”¨å±‚çš„ä¸€ä¸ªåè®®äº†ï¼Œæˆ‘ä»¬çŸ¥é“åœ¨ä½¿ç”¨çš„æ—¶å€™å¯ä»¥é€šè¿‡æŒ‡å®šå‚æ•°æ¥ç¡®å®žä½¿ç”¨ UDP æˆ–è€… TCP éƒ½å¯ä»¥ã€‚ int socket (int domain, int type, int protocol); å…¶ä¸­ domain è¡¨ç¤º IP å±‚ä½¿ç”¨ä»€ä¹ˆåè®®æ˜¯ IPv4 è¿˜æ˜¯ IPv6 type è¡¨ç¤º socket ç±»åž‹ï¼ŒSOCK_STREAM è¡¨ç¤º TCP é¢å‘æµï¼ŒSOCK_DGRAM å°±æ˜¯ UDP é¢å‘æ•°æ®æŠ¥çš„ï¼ŒSOCK_RAW ç›´æŽ¥æ“ä½œ IP å±‚æˆ–è€…å…¶ä»–åè®®å¦‚ ICMP protocol è¡¨ç¤ºçš„åè®®ï¼ŒIPPROTO_TCP æˆ–è€… IPPTOTO_UDP DNSå½“æˆ‘ä»¬æƒ³é€šè¿‡ä¸€ä¸ªåŸŸåè®¿é—®ä¸€ä¸ªç½‘ç«™æ—¶ï¼Œç¬¬ä¸€æ­¥æ“ä½œå°±æ˜¯åŽ»æ‰¾è¿™ä¸ªåŸŸåæ‰€å¯¹åº”çš„ IP åœ°å€ï¼Œè€Œ DNS å°±æ˜¯è¿™ä¸ªåŠŸèƒ½ã€‚ ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒDNS æœåŠ¡éƒ½æ˜¯ç”¨çš„ UDP æ¥åšçš„ï¼Œå› ä¸ºå¿«å˜›ï¼Œè€Œä¸”æœ¬èº«ä¼ é€’çš„æ¶ˆæ¯ä¹Ÿä¸å¤šã€‚ ä½†æ˜¯ï¼Œå› ä¸º DNS æœåŠ¡å™¨ä¹‹é—´æ˜¯éœ€è¦è¿›è¡Œæ•°æ®çš„ä¸€ä¸ªåŒæ­¥æˆ–è€…è¿ç§»æ“ä½œçš„ï¼Œè¾…åŠ© DNS æœåŠ¡å™¨ä¼šå®šæ—¶å‘ä¸»åŸŸåæœåŠ¡å™¨åŒæ­¥å˜åŠ¨ï¼Œå«åšåŒºåŸŸä¼ é€ï¼Œè€Œè¿™ä¸ªæ—¶å€™æ•°æ®é‡æ˜¯æœ‰å¯èƒ½å¾ˆå¤§çš„ï¼Œè€Œä¸”ä¸ºäº†ç¡®ä¿ä¿¡æ¯ä¸ä¸¢å¤±ï¼Œä½¿ç”¨ TCP æ¥ä¿è¯æ‰æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚ æ€»ç»“æ€»çš„æ¥è¯´ï¼ŒUDP è¿˜æ˜¯éžå¸¸ç®€å•çš„ä¸€ä¸ªåè®®ï¼Œæ²¡æœ‰è¿‡å¤šçš„çº¦æŸï¼Œä»Žè€Œåœ¨ä¸€äº›ç‰¹å®šçš„æƒ…å†µä¸‹æ»¡è¶³ç”¨æˆ·çš„éœ€æ±‚ã€‚è¿™é‡Œä¹Ÿä½“çŽ°äº† trade-off ï¼Œé€Ÿåº¦è¿˜æ˜¯å¯é ï¼Œè¦å®‰å…¨è¿˜æ˜¯è¦æ€§èƒ½ï¼Œå¾€å¾€éƒ½æ˜¯åœ¨æƒè¡¡ï¼Œä¹Ÿå¾€å¾€éœ€è¦é’ˆå¯¹åœºæ™¯åŽ»é€‰æ‹©ã€‚]]></content>
      <categories>
        <category>network</category>
      </categories>
      <tags>
        <tag>UDP</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å®žçŽ°åˆ†å¸ƒå¼é”ï¼Œä½ èƒ½æƒ³åˆ°ä»€ä¹ˆï¼Ÿ]]></title>
    <url>%2F2020%2F03%2F08%2Fgolang%2Farchitecture%2Fdistribute-lock%2F</url>
    <content type="text"><![CDATA[æ‰€è°“åˆ†å¸ƒå¼é”ï¼Œå³åœ¨å¤šä¸ªç›¸åŒæœåŠ¡æ°´å¹³æ‰©å±•æ—¶ï¼Œå¯¹äºŽåŒä¸€èµ„æºï¼Œèƒ½ç¨³å®šä¿è¯æœ‰ä¸”åªæœ‰ä¸€ä¸ªæœåŠ¡èŽ·å¾—è¯¥èµ„æº â€” by LinkinStar å…¶å®žå¯¹äºŽåˆ†å¸ƒå¼é”ï¼Œä¹Ÿæ˜¯å±žäºŽé‚£ç§çœ‹ä¼¼ç®€å•ï¼Œå®žåˆ™æœ‰å¾ˆå¤šç»†èŠ‚çš„é—®é¢˜ã€‚å¾ˆå¤šäººåœ¨è¢«é—®åˆ°è¿™ä¸ªé—®é¢˜çš„æ—¶å€™ï¼Œä¸€ä¸Šæ¥å°±ä¼šè¯´ç”¨rediså˜›ï¼Œsetnxå˜›ï¼Œæˆ‘çŸ¥é“æˆ‘çŸ¥é“ã€‚ä½†ä»…ä»…æ˜¯è¿™æ ·å°±èƒ½æžå®šäº†å—ï¼Ÿé‚£ä¹ˆå½“æˆ‘ä»¬åœ¨å®žçŽ°ä¸€ä¸ªåˆ†å¸ƒå¼é”çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç©¶ç«Ÿéœ€è¦è€ƒè™‘äº›ä»€ä¹ˆå‘¢ï¼Ÿ å¿…è€ƒç‚¹é¦–å…ˆä½œä¸ºä¸€ä¸ªåˆ†å¸ƒå¼é”ï¼Œä½ ä¸€å®šè¦ä¿è¯çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ ä¸èƒ½æœ‰ä¸¤ä¸ªæœåŠ¡åŒæ—¶èŽ·å–åˆ°ä¸€æŠŠé”ï¼ˆèµ„æºï¼‰ ä¸èƒ½å‡ºçŽ°æœ‰ä¸€ä¸ªèµ„æºä¸€ç›´è¢«é”ä½ï¼ˆé”ä¸€ç›´è¢«æŒæœ‰ï¼‰ æˆ‘è®¤ä¸ºä¸Šé¢ä¸¤ç‚¹æ˜¯å¿…é¡»è¦ä¿è¯çš„ï¼Œå…¶ä»–çš„ç‚¹ï¼Œæ¯”å¦‚é”çš„èŽ·å–æ˜¯å¦é«˜æ•ˆï¼Œé”èŽ·å–çš„éžé˜»å¡žç­‰ç­‰æ˜¯è¯„ä»·ä¸€ä¸ªé”æ˜¯å¦å¥½ç”¨çš„ç‚¹ï¼ˆå½“ç„¶ä¹Ÿä¸æ˜¯è¯´ä¸é‡è¦ï¼‰ ä¸‹é¢æˆ‘ä»¬ä¸€ä¸ªä¸ªå®žçŽ°æ–¹æ¡ˆæ¥è¯´ï¼Œæ¥çœ‹çœ‹ç©¶ç«Ÿæœ‰å¤šå°‘ç»†èŠ‚æ˜¯æˆ‘ä»¬éœ€è¦è€ƒè™‘çš„ã€‚ rediså®žçŽ°å…ˆä»Žæœ€æ™®éçš„å®žçŽ°æ–¹æ¡ˆå¼€å§‹è¯´èµ·ï¼Œredisã€‚åˆ©ç”¨redisçš„ç‰¹æ€§ï¼Œnxï¼Œèµ„æºä¸å­˜åœ¨æ—¶æ‰èƒ½å¤ŸæˆåŠŸæ‰§è¡Œ set æ“ä½œï¼ŒåŒæ—¶è®¾ç½®è¿‡æœŸæ—¶é—´ç”¨äºŽé˜²æ­¢æ­»é” åŠ é”SET resource_key random_value NX PX lock-time è§£é”DEL resource_key é¢è¯•è€…å¾€å¾€èƒ½ç»™å‡ºè¿™æ ·çš„æ–¹æ¡ˆï¼Œé‚£ä¹ˆè¿™æ ·çš„å®žçŽ°è¶³å¤Ÿäº†å—ï¼Ÿ é—®é¢˜1 è§£é”æ–¹å¼é è°±å—ï¼Ÿä¸Šé¢çš„è§£é”æ–¹å¼æ˜¯é€šè¿‡åˆ é™¤å¯¹åº”çš„keyå®žçŽ°çš„ã€‚é‚£ä¹ˆä¼šæœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿå¦‚æžœç¨‹åºæ˜¯æˆ‘ä»¬è‡ªå·±å†™çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸€å®šèƒ½ä¿è¯ï¼Œå¦‚æžœéœ€è¦ä¸»åŠ¨é‡Šæ”¾é”çš„è¯ï¼Œå¿…é¡»è¦å…ˆè¦èŽ·å–åˆ°é”ã€‚ï¼ˆæˆ‘ä»¬å¯ä»¥è¿™æ ·å¼ºåˆ¶ç¼–ç ï¼‰é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå…¶å®žè¿™ä¸ªä»»ä½•äººéƒ½å¯èƒ½ä¸»åŠ¨è°ƒç”¨è§£é”ï¼Œåªè¦çŸ¥é“keyå°±å¯ä»¥äº†ï¼Œè€Œkeyæ˜¯è‚¯å®šçŸ¥é“çš„ã€‚é‚£ä¹ˆï¼Œå¦‚æžœæˆ‘ä¸»åŠ¨æ£ä¹±ï¼Œæˆ‘å¯ä»¥è¯´ç›´æŽ¥æ‰‹åŠ¨å…ˆåˆ é™¤è¿™ä¸ªkeyç„¶åŽæˆ‘å°±ä¸€å®šèƒ½é‡æ–°æ‹¿åˆ°è¿™ä¸ªé”äº†ï¼Œè¿™æ˜¾ç„¶æœ‰æ¼æ´žäº†ã€‚å…¶å®žä¸åªæ˜¯è¿™æ ·çš„åœºæ™¯ï¼Œæœ‰ä¸€äº›åœºæ™¯ä¸‹ï¼ŒèŽ·å–é”å’Œé‡Šæ”¾é”çš„äººç¡®å®žä¸æ˜¯ä¸€ä¸ªï¼Œé‚£ä¹ˆå°±ä¼šå­˜åœ¨é—®é¢˜ã€‚ é—®é¢˜1 è§£å†³æ–¹å¼1ï¼šå¼ºåˆ¶è§„å®šåªèƒ½ä½¿ç”¨è¿‡æœŸè§£é”æ–¹å¼2ï¼šéªŒè¯å­˜æ”¾çš„valueæ˜¯å¦ä¸ºå­˜æ”¾çš„æ—¶å€™çš„å€¼æ¥ä¿è¯æ˜¯åŒä¸€äººçš„è¡Œä¸ºæ–¹å¼3ï¼šé€šè¿‡luaè„šæœ¬è¿›ä¸€æ­¥ä¿è¯éªŒè¯å’Œæ˜¯å¦ä¸ºåŽŸå­æ“ä½œ1234if redis.get(&quot;resource_key&quot;) == &quot;random_value&quot; return redis.del(&quot;resource_key&quot;)else return 0 é—®é¢˜2 redisæŒ‚äº†â€¦redisä¸‡ä¸€æŒ‚äº†ï¼Œé‚£ä¹ˆå¯¹å¤–æ¥è¯´ï¼Œæ²¡æœ‰äººèƒ½èŽ·å–åˆ°é”ï¼Œé‚£ä¹ˆä¸šåŠ¡è‚¯å®šä¼šæœ‰é—®é¢˜ã€‚è¿™ä¸ªæ—¶å€™å°æ˜Žé©¬ä¸Šä¼šè¯´äº†ï¼Œé‚£å°±redisé›†ç¾¤ï¼Œä¸»ä»Žï¼Œå“¨å…µâ€¦é‚£ä¹ˆç›¸å¯¹åº”çš„é—®é¢˜å°±æ¥äº†ï¼Œå¦‚æžœåœ¨å¤åˆ¶çš„è¿‡ç¨‹ä¸­æŒ‚äº†ï¼Œæ˜¯å¦å°±æœ‰å¯èƒ½å‡ºçŽ°è™½ç„¶èŽ·å–åˆ°äº†é”ä½†æ˜¯é”ä¸¢å¤±äº†çš„æƒ…å†µå‘¢ï¼Ÿ é—®é¢˜2 è§£å†³æ–¹æ¡ˆé‚£ä¹ˆredisæ—©å°±æƒ³åˆ°äº†è§£å†³æ–¹æ¡ˆï¼ŒRedlockï¼ˆçº¢é”ï¼‰å¦‚æžœä½ æ˜¯ç¬¬ä¸€æ¬¡å¬åˆ°è¿™ä¸ªåå­—å¯èƒ½ä¼šè§‰å¾—å®ƒæœ‰ç‚¹ç‹¬ç‰¹å’Œé«˜çº§ï¼Œå…¶å®žå¹¶æ²¡æœ‰ã€‚ã€‚ã€‚å®ƒåˆ©ç”¨çš„å°±æ˜¯æŠ½å±‰åŽŸç†ï¼Œæˆ–è€…ç§°ä¸ºå¤§å¤šæ•°åŽŸç†ï¼Œå°±æ˜¯å½“ä½ è¦èŽ·å–é”çš„æ—¶å€™ï¼Œå¦‚æžœæœ‰5ä¸ªèŠ‚ç‚¹ï¼Œä½ å¿…é¡»è¦æ‹¿åˆ°å…¶ä¸­3ä¸ªæ‰å¯ä»¥ã€‚å¹¶ä¸”èŽ·å–é”çš„æ—¶é—´å…±è®¡æ—¶é—´è¦å°äºŽé”çš„è¶…æ—¶æ—¶é—´ã€‚æ›´åŠ è¯¦ç»†çš„å¯ä»¥å‚è€ƒå®˜ç½‘ï¼šhttps://redis.io/topics/distlockè¿™æ ·èƒ½ä¿è¯åœ¨æœ€å¤šæŒ‚æŽ‰2ä¸ªèŠ‚ç‚¹çš„æƒ…å†µä¸‹ï¼Œä¾æ—§èƒ½æ­£å¸¸çš„æ—¶å€™ï¼ˆåŽŸæ¥æ˜¯5ä¸ªï¼‰ é—®é¢˜3 è¶…æ—¶æ—¶é—´è®¾å®šå¤šä¹…è¿™ä¸ªé—®é¢˜å…¶å®žå°±å¾ˆéš¾äº†ï¼Œæ— è®ºæ˜¯ä¸€å¼€å§‹çš„æ–¹æ¡ˆè¿˜æ˜¯è¯´å¯¹è¶…æ—¶æ—¶é—´è¦æ±‚æ›´é«˜çš„redlockï¼Œè¶…æ—¶æ—¶é—´çš„è®¾å®šä¸€ç›´æ˜¯ä¸€ä¸ªéš¾é¢˜ï¼›è®¾å®šå¤ªé•¿ï¼Œå¯èƒ½åœ¨æ„å¤–æƒ…å†µä¸‹ä¼šå¯¼è‡´é”è¿Ÿè¿Ÿå¾—ä¸åˆ°é‡Šæ”¾ï¼›è®¾å®šå¤ªçŸ­ï¼Œäº‹æƒ…è¿˜æ²¡åšå¥½ï¼Œé”å°±è¢«é‡Šæ”¾äº†ï¼›æ›´æœ‰ç”šè€…æå‡ºï¼Œè®¾å®šæ—¶é—´å³ä½¿åˆé€‚ï¼Œé‚£ä¹ˆç”±äºŽç½‘ç»œã€GCã€ç­‰ç­‰ä¸ç¨³å®šå› ç´ ä¹Ÿä¼šå¯¼è‡´æ„å¤–æƒ…å†µå‘ç”Ÿã€‚ é—®é¢˜3 è§£å†³å…¶å®žé—®é¢˜åœ¨ä¸å¥½è§£å†³ï¼Œå› ä¸ºé—®é¢˜æœ¬èº«å­˜åœ¨ä¸ç¡®å®šå› ç´ ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ä»Žé—®é¢˜æœ¬èº«å‡ºå‘ï¼Œé‚£ä¹ˆå°±å°è¯•ä»Žä¸šåŠ¡å‡ºå‘è§£å†³ã€‚ï¼ˆæˆ‘æ€»ä¸èƒ½å‘Šè¯‰ä½ è¯´â€™è®¾å®š5åˆ†é’Ÿï¼Œè¿™æ ·æ˜¯æœ€å¥½çš„â€™è¿™æ ·ç±»ä¼¼çš„è¯å§ï¼‰æ–¹æ¡ˆæ˜¯è¯´ï¼šå½“æˆ‘ä»¬èŽ·å–é”ä¹‹åŽèŽ·å¾—ä¸€ä¸ªç±»ä¼¼ä¹è§‚é”çš„æ ‡è®°tokenï¼ˆæˆ–è€…è¯´versionï¼‰æ¯”å¦‚å½“å‰æ˜¯33ï¼Œå½“æˆ‘ä»¬åšå®Œäº‹æƒ…ä¹‹åŽï¼Œéœ€è¦ä¸»åŠ¨æ›´æ–°æ•°æ®æ—¶ï¼Œå¦‚æžœå‘çŽ°å½“å‰å½“å‰çš„versionå·²ç»ä¸º34ï¼ˆå·²ç»å‡ºçŽ°äº†åˆ«äººèŽ·å–åˆ°é”å¹¶ä¸”æ›´æ–°äº†æ•°æ®ï¼‰ï¼Œé‚£ä¹ˆæ­¤æ¬¡æ“ä½œå°†ä¸è¿›è¡Œã€‚è™½ç„¶è¿™æ ·çœ‹æ¥ç›´æŽ¥ç”¨ä¹è§‚é”ä¸å°±å¥½äº†å—ï¼ŸåŽé¢æˆ‘ä»¬ä¼šæåˆ°ã€‚ mysqlå®žçŽ°è¯´å®Œäº† redis çš„å®žçŽ°ï¼Œé‚£è®©æˆ‘ä»¬æ¥çœ‹çœ‹ mysql çš„å®žçŽ°å§ã€‚mysqlçš„å®žçŽ°æ–¹å¼å°±äº”èŠ±å…«é—¨äº†ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸ªæ¥çœ‹çœ‹ã€‚ mysqlå®žçŽ°çš„ä¼˜ç‚¹æˆ‘å…ˆæ¥è¯´è¯´ mysql å®žçŽ°çš„ä¼˜ç‚¹å§ï¼Œå› ä¸ºé©¬ä¸Šå¯èƒ½å°±ä¼šæœ‰äººé—®ï¼Œä¸ºä»€ä¹ˆè¦ç”¨ mysql åŽ»å®žçŽ°å‘¢ï¼Ÿrediså®ƒä¸é¦™å—ï¼Ÿä¸»è¦åŽŸå› æˆ‘æƒ³äº†ä¸€ä¸‹ï¼š å¦‚æžœæ²¡æœ‰redisï¼ˆå½“å‰é¡¹ç›®ä¸­æœªä½¿ç”¨ï¼‰å¦‚æžœå¤šå¼•å…¥ä¸€ä¸ªä¸­é—´ä»¶åŠ¿å¿…å¸¦æ¥ç»´æŠ¤æˆæœ¬ å®žçŽ°å’Œä½¿ç”¨ç®€å•ï¼ˆå› ä¸ºåªéœ€è¦æ“ä½œmysqlï¼‰ å¦‚æžœå‡ºçŽ°æ„å¤–ä¸ç”¨æ…Œå¼ ï¼ˆmysql éƒ½æŒ‚äº†ï¼Œä½ çš„ä¸šåŠ¡ç³»ç»Ÿä¹Ÿå°±å‡‰äº†ï¼Œèƒ½ä¸èƒ½æ‹¿åˆ°é”å·²ç»æ˜¯æ¬¡è¦çš„äº†ï¼Œåæ­£å°±æ˜¯è¦æ­»ä¸€èµ·æ­»ï¼‰ æ–¹æ¡ˆ1 ä¸»é”®é”è¿™ä¸ªæ˜¯æœ€å®¹æ˜“æƒ³åˆ°çš„ï¼Œåˆ©ç”¨ä¸»é”®çš„å”¯ä¸€æ€§ã€‚ èŽ·å–é”å°±æ˜¯æ’å…¥ä¸€æ¡è®°å½•ï¼ˆç›¸åŒçš„ä¸»é”®æ’å…¥ä¸è¿›åŽ»ï¼‰ é‡Šæ”¾é”å°±æ˜¯åˆ é™¤ä¸€æ¡è®°å½• æ–¹æ¡ˆ1 ä¸»é”®é” é—®é¢˜é—®é¢˜å…¶å®žä¹Ÿæ˜¯æ˜¾è€Œæ˜“è§çš„ æ²¡æœ‰è¶…æ—¶æ—¶é—´ï¼Œå¯èƒ½ä¸€ç›´æ— æ³•é‡Šæ”¾ï¼Œè¿™é—®é¢˜å¾ˆå¤§ ä¼šä¸€ç›´é€ æˆ mysql æŠ¥é”™ï¼Œå¹¶å‘ä¸‹æ€§èƒ½å ªå¿§ æ–¹æ¡ˆ1 ä¸»é”®é” è§£å†³ å¯ä»¥è®¾å®šä¸€ä¸ªå…¥è¡¨æ—¶é—´ï¼Œç„¶åŽå¦å¤–å»ºç«‹ä¸€ä¸ªå®šæ—¶ä»»åŠ¡åŽ»æ¸…ç†è¿‡æœŸçš„è®°å½• å¯ä»¥åœ¨ç¨‹åºä¸­è®°å½•ä¸€ä¸‹å½“å‰çš„idæœ€å¤§å€¼ï¼Œæ¥å‡å°‘å†²çªå‘ç”Ÿçš„æƒ…å†µ æ€»ä¹‹è¿™æ ·çš„æ–¹å¼å®žçŽ°åªèƒ½è¯´åœ¨å¹¶å‘é‡ä¸é«˜ï¼Œåªæ˜¯ç®€å•è¦ä¿è¯å®žçŽ°çš„åŸºç¡€åšæ˜¯å¯ä»¥çš„ æ–¹æ¡ˆ2 ä¹è§‚é”æœ‰å…³ä¹è§‚é”å°±ç®€å•è§£é‡Šä¸€ä¸‹å¥½äº†ï¼Œå°±æ˜¯æ·»åŠ ä¸€ä¸ª version çš„å­—æ®µï¼Œéœ€è¦æ›´æ–°æ“ä½œçš„æ—¶å€™ï¼Œå¿…é¡»æ»¡è¶³å½“å‰å–å‡ºæ—¶çš„ç‰ˆæœ¬å·ã€‚ä¸¾ä¸ªä¾‹å­ï¼šæˆ‘å–å‡ºæ—¶çš„ç‰ˆæœ¬å·æ˜¯3ï¼Œå½“æˆ‘æ›´æ–°æ—¶é‚£ä¹ˆå°±å¿…é¡»å†™ç€ updateâ€¦â€¦ where version = 3 å› ä¸º mysql çš„ mvcc çš„æŽ§åˆ¶èƒ½ä¿è¯æ²¡æœ‰é—®é¢˜ æ–¹æ¡ˆ2 ä¹è§‚é” é—®é¢˜å…¶å®žä¹è§‚é”çš„é—®é¢˜å°±åœ¨éœ€è¦ç»™ä¸šåŠ¡æ·»åŠ  version å­—æ®µï¼Œè¿™ä¸ªå¯¹äºŽä¸šåŠ¡æ˜¯å…¥ä¾µçš„ã€‚å…¶æ¬¡åœ¨å¹¶å‘æƒ…å†µä¸‹ä¼šå¢žåŠ å¤§é‡çš„æ•°æ®åº“æ— ç”¨æ“ä½œï¼Œå¦‚æžœæ•°æ®é‡å¤§çš„è¯ä¹ŸæŒºéš¾é¡¶çš„ã€‚ï¼ˆè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¸Šé¢åœ¨rediså®žçŽ°ä¸­åŠ å…¥ç±»ä¼¼versionæŽ§åˆ¶ï¼Œè€Œä¸ç›´æŽ¥ä½¿ç”¨ä¹è§‚é”æŽ§åˆ¶çš„åŽŸå› ï¼‰ æ–¹æ¡ˆ2 ä¹è§‚é” è§£å†³ä¹è§‚é”å…¶å®žæŒºä¹è§‚çš„ï¼Œå®ƒå°±æ˜¯ç”¨äºŽå“ªäº›ä¹è§‚çš„ä¸ä¼šå‘ç”Ÿå¾ˆå¤§ç¨‹åº¦å¹¶å‘çš„æƒ…å†µï¼Œæ‰€ä»¥å®ƒçš„ä½¿ç”¨å°±çœ‹ä½ çš„ä¸šåŠ¡éœ€æ±‚å³å¯ï¼Œæœ‰æ—¶å³ä½¿æ²¡æœ‰ version å­—æ®µï¼Œä¹Ÿä¼šåˆç†ä½¿ç”¨ã€‚ æ–¹æ¡ˆ3 æ‚²è§‚é”ç½‘ä¸Šæœä¸€åœˆä½ å°±ä¼šå‘çŽ°å¦‚ä¸‹çš„åˆ†å¸ƒå¼é”çš„å®žçŽ°ï¼šhttps://www.jianshu.com/p/b76f409b2db2 å¼€å§‹äº‹åŠ¡ ä½¿ç”¨ for update è¿›è¡ŒæŸ¥è¯¢ï¼ˆå¦‚æžœèƒ½æŸ¥è¯¢å°±è¡¨ç¤ºèƒ½èŽ·å–åˆ°é”ï¼‰ åšéœ€è¦åšçš„ä»»åŠ¡ æäº¤äº‹åŠ¡ï¼ˆè§£é”ï¼‰ æ–¹æ¡ˆ3 æ‚²è§‚é” é—®é¢˜äºŽæ˜¯ä½ å°±ä¼šå‘çŽ°è¿™ä¸ªæ–¹æ¡ˆè™½ç„¶å¯è¡Œï¼Œä½†æ˜¯å­˜åœ¨å¾ˆå¤šé—®é¢˜ é€šè¿‡æäº¤æ¥è§£é”ï¼Œé‚£ä¹ˆæ•´ä¸ªäº‹åŠ¡æŒç»­æ—¶é—´ä¼šå¾ˆé•¿ï¼ˆæœ‰å¯èƒ½ï¼Œæ ¹æ®ä½ åšçš„ä»»åŠ¡æœ‰å…³ï¼‰ èŽ·å–ä¸åˆ°é”çš„ä¼šä¸€ç›´åœ¨ç­‰å¾…ï¼Œå› ä¸ºå‰ä¸€ä¸ªé—®é¢˜å¯¼è‡´ æ²¡æœ‰è¶…æ—¶æ—¶é—´ï¼Œå­˜åœ¨é”ä¸€ç›´ä¸é‡Šæ”¾çš„æƒ…å†µï¼Œå¹¶ä¸”æœ‰å¯èƒ½å¯¼è‡´äº‹åŠ¡ä¸€ç›´è¢«å¼€å¯ é«˜å¹¶å‘ä¸‹ mysql è¿žæŽ¥ä¼šå¾ˆå¤š â€¦ æ‰€ä»¥å°æ˜Žæƒ³è¦æ”¹åŠ¨ä¸€ä¸‹çœ‹çœ‹èƒ½ä¸èƒ½åšçš„æ›´å¥½ï¼ŒäºŽæ˜¯æœ‰äº†ä¸‹é¢çš„æ”¹åŠ¨æ–¹æ¡ˆ æ–¹æ¡ˆ3 æ‚²è§‚é” æ”¹åŠ¨ä¹‹æ—…å°æ˜Žæƒ³åˆ°çš„ç¬¬ä¸€ä¸ªæ”¹åŠ¨æ–¹æ¡ˆæ˜¯ï¼Œæˆ‘è¦é”çš„ key æ˜¯ xxx BEGIN; SELECT * FROM lock_tab WHERE key = â€˜xxxâ€™ FOR UPDATE; INSERT xxxâ€¦.; COMMIT; å½“ç¬¬äºŒä¸ªæ­¥éª¤æŸ¥è¯¢åˆ°äº†ä¹‹åŽï¼š å¦‚æžœæ²¡æœ‰æ•°æ®ï¼Œè¯æ˜ŽæœåŠ¡æ­£åœ¨æŒæœ‰é”ï¼Œé‚£ä¹ˆæ­¤æ—¶è¿›è¡Œæ–°å¢žå°±å¯ä»¥äº†ï¼Œç”±äºŽæ‚²è§‚é”çš„å­˜åœ¨ï¼Œåˆ«çš„æœåŠ¡æ˜¯æ²¡æœ‰åŠžæ³•åŒæ—¶è¿›è¡Œæ’å…¥æ“ä½œçš„ï¼› å¦‚æžœæœ‰æ•°æ®ï¼Œè¯æ˜Žå·²ç»æœ‰æœåŠ¡åœ¨æŒæœ‰é”ï¼Œé‚£ä¹ˆå°±ç›´æŽ¥æ”¾å¼ƒï¼› é‡Šæ”¾é”é€šè¿‡åˆ é™¤è¿™æ¡è®°å½•åŽ»é‡Šæ”¾ é‚£ä¹ˆï¼Œä½ æƒ³æƒ³ï¼Œè¿™æ ·æœ‰é—®é¢˜å—ï¼Ÿ æœ‰ï¼Œé—®é¢˜å°±åœ¨é‡Šæ”¾é”çš„æ—¶å€™ï¼Œè¿™ä¸ªåˆ é™¤æ“ä½œæœ‰å¯èƒ½æ— æ³•æˆåŠŸï¼Œå› ä¸ºæœ‰åˆ«çš„æœåŠ¡å¯èƒ½ä¼šæŒæœ‰æ‚²è§‚é”ï¼Œç‰¹åˆ«æ˜¯åœ¨å¹¶å‘é‡å¤§ï¼Œä¸”é‡è¯•è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œéžå¸¸å®¹æ˜“å‡ºçŽ°é”æ— æ³•é‡Šæ”¾çš„æƒ…å†µã€‚ é‚£å†æ”¹æ”¹å‘—ï¼Œæ‰‹åŠ¨åˆ é™¤è¿™ä¸ªæ“ä½œè‚¯å®šæ˜¯ä¸è¡Œçš„ï¼Œè¿™æ¬¡å°æ˜Žæƒ³åˆ°è¶…æ—¶æœºåˆ¶ï¼ŒäºŽæ˜¯å°è¯•åŠ å…¥å­—æ®µè¿‡æœŸæ—¶é—´ï¼ŒæŸ¥è¯¢ä¹‹åŽé€šè¿‡æ—¶é—´åŽ»åˆ¤æ–­æ˜¯å¦è¶…æ—¶ï¼Œå¦‚æžœå·²ç»è¶…æ—¶ï¼Œä¹ŸåŒæ—¶è¯æ˜Žæ²¡æœ‰æœåŠ¡æ­£åœ¨æŒæœ‰è¿™æŠŠé”ã€‚é‚£è¿™æ ·ä¼šæœ‰é—®é¢˜å—ï¼Ÿæœ‰ï¼Œå½“å‰è¿™æ ·æŸ¥è¯¢æ˜¯ç›´æŽ¥åŠ çš„è¡¨é”ã€‚ï¼ˆå½“å‰è¡¨è®¾è®¡ä¸Šæ²¡æœ‰ç´¢å¼•ï¼‰å½“æˆ‘ä»¬è¦é”èµ„æºçš„æ—¶å€™æˆ‘ä»¬è‚¯å®šæƒ³çš„æ˜¯æœ€å¥½åŽ»é”ä¸€è¡Œæ•°æ®ï¼Œè€Œä¸è¦åŽ»é”æ•´å¼ è¡¨ï¼Œè¿™æ ·ä¸ä¼šå½±å“åˆ°å…¶ä»–èµ„æºçš„æŠ¢é”ï¼ŒäºŽæ˜¯å°æ˜Žç»™è¡¨çš„keyï¼ˆèµ„æºåç§°ï¼‰å­—æ®µåŠ äº†ç´¢å¼•ã€‚æµ‹è¯•äº†ä¸€ä¸‹ã€‚ å½“å‰è¡¨æ ¼ä¸­çš„æ•°æ®id key val1 aa a22 bb b33 cc c4 T1 BEGIN; SELECT * FROM lock_tab WHERE key=â€™aaâ€™ FOR UPDATE; T2 BEGIN; SELECT * FROM lock_tab WHERE key=â€™bbâ€™ FOR UPDATE;ï¼ˆæ­£å¸¸ï¼‰ COMMIT; BEGIN; SELECT * FROM lock_tab WHERE key=â€™aaâ€™ FOR UPDATE;ï¼ˆå¡ä¸»ï¼‰ å‘çŽ°T2æŸ¥è¯¢bbå¯ä»¥æ­£å¸¸æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸¤ä¸ªä¸åŒçš„èµ„æºä¸ä¼šäº’ç›¸å¹²æ‰°äº†ï¼ˆå¦‚æžœé”è¡¨çš„æƒ…å†µä¸‹ï¼ŒT2æŸ¥è¯¢bbå°±ä¼šå¡ä¸»ï¼‰ è¿˜æœ‰é—®é¢˜å—ï¼Ÿæ˜¾ç„¶è¿˜æœ‰é—®é¢˜ã€‚å½“å‰ç¡®å®žæ˜¯è¡Œé”æ²¡é”™äº†ï¼Œä½†æ˜¯å¦‚æžœè¿™ä¸ªèµ„æºæœ¬èº«åœ¨è¡¨é‡Œé¢ä¸å­˜åœ¨ä¼šæ€Žä¹ˆæ ·ï¼ŸT1 BEGIN; SELECT * FROM lock_tab WHERE key=â€™zzâ€™ FOR UPDATE; T2 BEGIN; SELECT * FROM lock_tab WHERE key=â€™zzâ€™ FOR UPDATE;ï¼ˆæ­£å¸¸???ï¼‰ æ²¡é”™è¿™å°±æ˜¯é—®é¢˜ï¼Œå½“èµ„æºæœ¬èº«åœ¨è¡¨æ ¼ä¸­ä¸å­˜åœ¨çš„æ—¶å€™æ˜¯èƒ½æŸ¥è¯¢åˆ°çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å¯èƒ½é€ æˆæœ‰ä¸¤ä¸ªæœåŠ¡åŒæ—¶èŽ·å–åˆ°é”ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸º mysql å½“æŸ¥è¯¢ä¸»é”®æˆ–ç´¢å¼•æ— è®°å½•çš„å¹¶ä¸ä¼šè§¦å‘é”æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ²¡ä¸œè¥¿é”ï¼Œè¿™ä¸ªæ—¶å€™ mysql æ˜¯ä¸ä¼šå°† è¡Œé”é€€åŒ–æˆè¡¨é”çš„ã€‚ æ˜¾ç„¶è¿™æ ·çš„æ–¹æ¡ˆä¸å¯è¡Œï¼Œé‚£ä¹ˆå¦‚ä½•è§£å†³å‘¢ï¼Ÿçœ‹èµ·æ¥è§£å†³çš„æ–¹å¼ä¹Ÿåªæœ‰é”è¡¨äº†ï¼Œä¸ç„¶çš„è¯å°±æ˜¯å¿…é¡»åœ¨è¡¨ä¸­ä¼˜å…ˆåˆ›å»ºèµ„æºæ‰€å ç”¨çš„æ•°æ®ï¼Œè¿™æ ·æˆ–è®¸ä¹Ÿå°±åªèƒ½é’ˆå¯¹ç‰¹å®šçš„åœºæ™¯é”è¿›è¡Œäº†ã€‚ æ–¹æ¡ˆ3 æ‚²è§‚é” æ€»ç»“é‚£æ€»çš„æ¥è¯´ï¼Œå¯¹äºŽæ‚²è§‚é”çš„å®žçŽ°ï¼Œæ€»ç»“ä¸€ä¸‹ï¼š å¦‚æžœåªæ˜¯å•çº¯å¯¹äºŽä¸€ä¸ªä¸šåŠ¡çš„æŸä¸ªåœºæ™¯ï¼Œå¹¶ä¸”è¿™ä¸ªåœºæ™¯ä¸‹æŒæœ‰é”çš„æ—¶é—´å¾ˆçŸ­æš‚ï¼Œé‚£ä¹ˆé€‰æ‹©ç¬¬ä¸€ç§ï¼Œç›´æŽ¥å¼€å¯äº‹åŠ¡ï¼Œå¹¶åœ¨äº‹åŠ¡ä¸­èŽ·å¾—é”ï¼Œé€šè¿‡æäº¤äº‹åŠ¡æ¥é‡Šæ”¾é”ã€‚ å¦‚æžœå¯¹äºŽé”çš„ä¸šåŠ¡ä¸å®šï¼Œå¹¶ä¸”é”æŒæœ‰çš„æ—¶é—´è¾ƒé•¿ï¼Œé‚£ä¹ˆä½¿ç”¨ç¬¬äºŒç§ï¼Œæ¯æ¬¡èŽ·å–é”é€šè¿‡for updateå…ˆé”è¡¨ï¼Œç„¶åŽé€šè¿‡æ’å…¥æ•°æ®æ¥å®ŒæˆæŒæœ‰é”çš„æ“ä½œï¼Œä»…åˆ©ç”¨è¿‡æœŸæ—¶é—´è¿™ä¸€æ¡ä»¶æ¥é‡Šæ”¾é”ï¼Œè¿™æ ·èƒ½æœ€å¤§ç¨‹åº¦çš„æ›´å¿«æäº¤äº‹åŠ¡ï¼Œä¸å¿…å ç”¨è¿‡å¤šèµ„æºä¹Ÿä¸ä¼šé€ æˆä¸å¿…è¦çš„ç­‰å¾…æ—¶é—´ã€‚ å¦‚æžœé¢å¯¹å·²çŸ¥æ•°é‡çš„ä¸šåŠ¡åœºæ™¯ï¼Œå¯ä»¥æ˜Žç¡®æå‰ç»™å‡ºé”çš„å¯¹è±¡ï¼Œé‚£ä¹ˆä½¿ç”¨ç¬¬ä¸‰ç§ï¼Œåœ¨ç¬¬äºŒç§æ–¹å¼çš„åŸºç¡€ä¸Šï¼Œåœ¨è¡¨ä¸­åŠ å…¥æå‰åˆ›å»ºé”çš„å¯¹è±¡ï¼Œå¹¶å»ºç«‹ç´¢å¼•æ¥å®Œæˆå¯¹äºŽè¡Œçš„é”å®šï¼Œä»Žè€Œä¸ä¼šå½±å“å…¶ä»–èµ„æºçš„é”å®šã€‚æœ€å¤§é™åº¦ä¿è¯é”çš„ç»†ç²’åº¦ã€‚ ETCDå®žçŽ°è¯´äº†redisã€è¯´äº†mysqlã€å¯èƒ½å¾ˆå¤šäººè®¤ä¸ºä¸‹é¢æåˆ°çš„åº”è¯¥æ˜¯zkäº†ã€‚å…¶å®žzkä¹Ÿå¹¶ä¸å¤±ä¸ºä¸€ç§å¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯ç”±äºŽç¯‡å¹…ä¸æƒ³æ‹‰çš„è¿‡é•¿ï¼Œæˆ‘æ›´æƒ³ä»‹ç»ä¸€ä¸‹ETCDçš„å®žçŽ°ã€‚ ETCD åœ¨ K8S ç«äº†ä¹‹åŽä¹Ÿå°±è‡ªç„¶è¢«å¸¦ç«äº†ï¼Œå¤šçš„æˆ‘å°±ä¸ä»‹ç»äº†ï¼Œå¯¹äºŽå¾ˆå¤šåˆ†å¸ƒå¼åœºæ™¯å­˜å‚¨çš„å®žçŽ°æ€»ä¼šæåˆ°å®ƒï¼ŒçŽ°åœ¨æˆ‘ä»¬å…³æ³¨ä¸€ä¸‹å¦‚ä½•ç”¨å®ƒæ¥å®žçŽ°åˆ†å¸ƒå¼é”å‘¢ï¼Ÿ å®žçŽ°æ–¹æ¡ˆå…¶å®ž ETCD çš„å®žçŽ°åˆ†å¸ƒå¼é”æ€è·¯å’Œ Redis ç±»ä¼¼ï¼Œåªä¸è¿‡ ETCD æœ¬èº«æ²¡æœ‰ä¸€ä¸ªæ“ä½œå«åšSET NXæˆ–ç±»ä¼¼æ“ä½œï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ ETCD çš„äº‹åŠ¡æ¥å¸®åŠ©å®žçŽ°è¿™ä¸ªæ“ä½œï¼Œä»Žè€Œå®žçŽ°å¦‚æžœæŸ¥è¯¢åˆ°æ²¡æœ‰å°±setè¿™æ ·ä¸€ä¸ªåŽŸå­æ“ä½œã€‚ä¸‹é¢æ˜¯goå®žçŽ°ä¸­çš„éƒ¨åˆ†ä»£ç ç‰‡æ®µã€‚ 123456789101112131415 kv := clientv3.NewKV(client) txn := kv.Txn(context.TODO())txn.If(clientv3.Compare(clientv3.CreateRevision("/lock-key/uuid"), "=", 0)). Then(clientv3.OpPut("/lock-key/uuid", "xxx", clientv3.WithLease(leaseId))). Else(clientv3.OpGet("/lock-key/uuid"))txnResp, err := txn.Commit()if err != nil &#123; fmt.Println(err) return&#125;if !txnResp.Succeeded &#123; fmt.Println("é”è¢«å ç”¨:", string(txnResp.Responses[0].GetResponseRange().Kvs[0].Value)) return&#125; å¦‚æžœä»…ä»…åªæ˜¯è¿™æ ·ï¼Œé‚£æˆ‘ä¹Ÿä¸ä¼šå•ç‹¬æ‹¿å‡ºæ¥é‡ç‚¹è¯´äº†ï¼Œå®ƒå¯å¹¶ä¸åªæ˜¯è¿™æ ·ã€‚ ETCD æœ‰ç€ç§Ÿçº¦æœºåˆ¶ï¼Œä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå½“ä½ ç”³è¯·èŽ·å¾—ä¸€ä¸ªç§Ÿçº¦ä¹‹åŽï¼Œå®ƒæœ‰ä¸€å®šçš„æ—¶é—´ï¼Œåœ¨è¿™ä¸ªæ—¶é—´ä¹‹å†… key éƒ½æ˜¯æœ‰æ•ˆçš„ï¼Œä½†æ˜¯ç§Ÿçº¦åˆ°æœŸäº†ä¹‹åŽï¼Œkey å°±ä¼šè¢«è‡ªåŠ¨åˆ é™¤äº†ã€‚æœ‰ç‚¹ç±»ä¼¼ redis çš„è¿‡æœŸï¼Œä½†æ˜¯å®ƒæœ‰ç»­ç§Ÿçš„æ¦‚å¿µï¼Œè¿‡ä¸€æ®µæ—¶é—´å¯ä»¥ä¸»åŠ¨è¿›è¡Œç»­ç§Ÿï¼Œè¿™æ ·ä½ åˆèƒ½èŽ·å¾—ä¸€æ®µæ—¶é—´çš„ç§Ÿçº¦ã€‚ é‚£ä¹ˆåˆ©ç”¨è¿™ä¸ªç§Ÿçº¦æœºåˆ¶ï¼Œæˆ‘ä»¬æ˜¯å¯ä»¥å®žçŽ°å‡ºä¸€ç§é€»è¾‘ï¼Œå°±æ˜¯å½“ä»»åŠ¡åœ¨è¿›è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¸æ–­çš„åŽ»æ›´æ–°æˆ‘ä»¬çš„ç§Ÿçº¦ï¼Œèƒ½ä¿è¯æˆ‘ä»¬åœ¨åšä»»åŠ¡çš„é˜¶æ®µä¸€å®šæ˜¯æŒæœ‰é”çš„ï¼Œä¸ä¼šå‡ºçŽ°ä»»åŠ¡è¿˜åœ¨è¿›è¡Œä¸­ï¼Œä½†æ˜¯é”å·²ç»å¤±æ•ˆçš„æƒ…å†µã€‚å¹¶ä¸”å¯ä»¥ä½¿ç”¨åœ¨ä»»åŠ¡æ—¶é•¿æ— æ³•æŽ§åˆ¶çš„æƒ…å†µä¸‹ï¼Œå¦‚ï¼šå½“å‰ä»»åŠ¡éœ€è¦è·‘1åˆ†é’Ÿï¼Œå¯èƒ½ä¸‹ä¸€æ¬¡åŒä¸€ä¸ªä»»åŠ¡éœ€è¦è·‘1å°æ—¶ï¼Œæ— æ³•ç¡®å®šåˆç†çš„é”è¿‡æœŸæ—¶é—´ã€‚ ä¸‹é¢æ˜¯åœ¨goä¸­ï¼Œä½¿ç”¨lease.KeepAliveè‡ªåŠ¨ç»­ç§Ÿï¼Œè€Œç”¨ context çš„ cancelFunc æ¥å–æ¶ˆè‡ªåŠ¨ç»­ç§Ÿã€‚ 12345678910111213141516lease = clientv3.NewLease(client)leaseGrantResp, err := lease.Grant(context.TODO(), 5);if err != nil &#123; return&#125;leaseId = leaseGrantResp.IDctx, cancelFunc = context.WithCancel(context.TODO())defer cancelFunc()defer lease.Revoke(context.TODO(), leaseId)keepRespChan, err = lease.KeepAlive(ctx, leaseId)if err != nil &#123; return&#125; ä»…ä»…æ˜¯è¿™æ ·å—ï¼Ÿetcdè¿˜æœ‰ä¸€ä¸ªå·§å¦™çš„ watch æœºåˆ¶ï¼Œèƒ½ç›‘å¬ä¸€ä¸ª key çš„å˜åŒ–ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘æ²¡æœ‰èŽ·å–åˆ°é”çš„æ—¶å€™ï¼Œä½†æ˜¯æˆ‘åˆä¸æƒ³ä¸€ç›´å¾ªçŽ¯åŽ»è°ƒç”¨ get æ–¹æ³•è¿›è¡ŒæŸ¥è¯¢ï¼Œé‚£ä¹ˆè®© watch é€šçŸ¥ä½ å¯èƒ½ä¸å¤±ä¸ºä¸€ç§å·§å¦™çš„è§£å†³æ–¹å¼ï¼ˆé€‚ç”¨äºŽä¸€äº›ç‰¹æ®Šçš„ç­‰å¾…åœºæ™¯ï¼Œè¿™é‡Œå°±ä¸åˆ—ä¸¾ä»£ç äº†ï¼‰ å®žçŽ°æ€»ç»“ETCD æœ¬èº«å°±æ˜¯æ”¯æŒåˆ†å¸ƒå¼çš„ï¼Œæ‰€ä»¥åœ¨åˆ†å¸ƒå¼é”çš„å®žçŽ°ä¸Šæ²¡æœ‰å‰ä¸¤è€…å¯èƒ½å¸¦æ¥çš„å•ç‚¹é—®é¢˜ï¼Œè€Œæœ¬èº«åŸºäºŽ raft å®žçŽ°çš„å®ƒï¼Œä¹ŸåŒæ—¶é¿å…äº† redis ä¸»ä»Žæˆ–é›†ç¾¤ä¸‹å¤åˆ¶å¯èƒ½å‡ºçŽ°çš„å°´å°¬é—®é¢˜ã€‚è¦è¯´æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œé‚£ä¹ˆå°±æ˜¯æˆæœ¬äº†ï¼ŒETCD åœ¨å®žé™…çš„ä¸šåŠ¡ä½¿ç”¨åœºæ™¯ä¸­å¹¶ä¸æ˜¯éžå¸¸å¸¸è§çš„ï¼Œæ‰€ä»¥å¦‚æžœè¦å•ç‹¬ä¸ºå®ƒè¿›è¡Œéƒ¨ç½²ç»´æŠ¤è¿˜æ˜¯éœ€è¦æˆæœ¬çš„ã€‚ å…¶ä»–å®žçŽ°æ–¹å¼ Consul æ˜¯ Go å®žçŽ°çš„ä¸€ä¸ªè½»é‡çº§ æœåŠ¡å‘çŽ° ã€KVå­˜å‚¨ çš„å·¥å…·å¯¹äºŽå®ƒï¼ŒçŸ¥é“çš„äººå¯èƒ½å°±ä¸å¤šäº†ï¼Œå®ƒä¹Ÿèƒ½å®žçŽ°åˆ†å¸ƒå¼é”ï¼Œè€Œä¸”å®žçŽ°èµ·æ¥ä¹Ÿå¾ˆç®€å•ï¼Œåªéœ€è¦å®žä¾‹ä¸€ä¸ªsessionï¼Œç”¨è¿™ä¸ªsessionåŽ»èŽ·å–é”å’Œé‡Šæ”¾é”å°±å¯ä»¥äº†ã€‚å¦‚æžœä½ æ­£å¥½åœ¨ç”¨ Consul é‚£ç”¨å®ƒæ¥å®žçŽ°ä½ éœ€è¦çš„åˆ†å¸ƒå¼é”ï¼Œä¹Ÿå¯ä»¥ä½œä¸ºä½ çš„ä¸€ç§é€‰æ‹©å§ æ€»ç»“å…¶å®žï¼Œå›žè¿‡å¤´ä½ ä¼šå‘çŽ°ï¼Œæˆ‘ä»¬å®žçŽ°åˆ†å¸ƒå¼é”ï¼Œå…¶å®žè¦è€ƒè™‘çš„åœ°æ–¹éžå¸¸å¤šï¼Œéœ€è¦æ³¨æ„çš„é—®é¢˜ä¹Ÿå¾ˆå¤šï¼Œå¹¶ä¸æ˜¯å¾ˆå¤šæ—¶å€™æˆ‘ä»¬ä¹Ÿåœ¨æƒè¡¡è€ƒè™‘ã€‚ä¸ºäº†ä¿è¯ä¸€ä¸ªåˆ†å¸ƒå¼çŽ¯å¢ƒä¸­çš„åŽŸå­æ“ä½œï¼Œå…¶å®žè¯´èµ·æ¥å®¹æ˜“ï¼Œåšèµ·æ¥çœŸçš„æœ‰ç‚¹éš¾ã€‚ æŽ¨èä¸‹é¢å‡ ç¯‡åšå®¢ä¾›ä½ è¿›ä¸€æ­¥å­¦ä¹ ï¼šhttps://dbaplus.cn/news-159-2469-1.htmlï¼ˆZKå®žçŽ°åˆ†å¸ƒå¼é”ï¼Œä»¥åŠåˆ†å¸ƒå¼é”å°±å¤Ÿäº†å—ï¼Ÿå¦‚ä½•èƒ½åšåˆ°é«˜å¹¶å‘ä¸‹ä¹Ÿèƒ½å¥½ç”¨å‘¢ï¼Ÿï¼‰https://zhuanlan.zhihu.com/p/42056183https://mp.weixin.qq.com/s/1bPLk_VZhZ0QYNZS8LkviAï¼ˆåŸºäºŽRedisçš„åˆ†å¸ƒå¼é”çœŸçš„å®‰å…¨å—ï¼Ÿï¼‰https://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.htmlï¼ˆå¤§ä½¬è¯´è¯´åˆ†å¸ƒå¼é”ï¼‰]]></content>
      <categories>
        <category>architecture</category>
      </categories>
      <tags>
        <tag>distributed-lock</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ç»†è¯´kubernetes - åˆè¯†deployment]]></title>
    <url>%2F2020%2F03%2F01%2Fgolang%2Fopen-source-component%2Fk8s-dis-deployment%2F</url>
    <content type="text"><![CDATA[å½“æˆ‘ä»¬è®¤è¯†çš„k8sçš„æ—¶å€™ï¼Œæˆ‘ä»¬ç¬¬ä¸€ä¸ªè®¤è¯†çš„æ˜¯podï¼Œé‚£ä¹ˆæˆ‘è§‰å¾—ç¬¬äºŒä¸ªè®¤è¯†çš„åº”è¯¥å°±æ˜¯Deploymentäº†ã€‚ä½œä¸ºk8sä¸­ä¸€ä¸ªéžå¸¸å¸¸è§çš„å¯¹è±¡ï¼Œä»Šå¤©æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„å®žçŽ°åŽŸç†å’Œè®¾è®¡æ€æƒ³ã€‚ PS: æœ¬æ–‡éœ€è¦ä½ å¯¹podçš„å®šä¹‰å’Œç†è§£æœ‰ä¸€å®šçš„åŸºç¡€ å®šä¹‰åœ¨k8sä¸­ï¼Œå¯¹è±¡å¸¸å¸¸éƒ½æ˜¯ä»¥ä¸€ä¸ªyamlæ ¼å¼çš„æ–‡ä»¶æ¥å®šä¹‰çš„ï¼Œdeploymentä¹Ÿä¸ä¾‹å¤–ã€‚å¦‚æžœä½ å¯¹k8sè¿˜ä¸æ˜¯ç‰¹åˆ«äº†è§£ï¼Œä½ å¤§å¯ä»¥å°†ä¸€ä¸ªæ–‡ä»¶çœ‹åšæ˜¯ä¸€ä¸ªå¯¹è±¡çš„æ‰€æœ‰å±žæ€§ï¼Œæ¯ä¸ªå±žæ€§éƒ½æœ‰å¯¹åº”çš„å€¼ï¼Œå…¶å®žä¹Ÿå¹¶ä¸å¤æ‚ã€‚deploymentçš„å®šä¹‰å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526# å®šä¹‰ç‰ˆæœ¬apiVersion: apps/v1# å®šä¹‰ç±»åž‹kind: Deployment# å®šä¹‰åç§°å’Œæ ‡ç­¾metadata: name: nginx-deployment labels: app: nginx# å®šä¹‰è§„æ ¼spec: replicas: 2 selector: matchLabels: app: nginx # å®šä¹‰æ¨¡æ¿ template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.7.9 ports: - containerPort: 80 æˆ‘ä¹Ÿä¸çŸ¥é“ç½‘ä¸Šä¸ºä»€ä¹ˆéƒ½ç”¨nginxæ¥å†™è¿™ä¸ªä¾‹å­ï¼Œæ€»ä¹‹æˆ‘æ‹¿æ¥åŠ ä¸Šäº†ä¸€äº›æ³¨é‡Šï¼Œä½ å°±å¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹åˆ°å®ƒåˆ°åº•åœ¨å®šä¹‰äº›ä»€ä¹ˆä¸œè¥¿äº†ã€‚ï¼ˆå…¶å®žæ•´ä¸ªdeploymentä¹Ÿå¹¶ä¸å¤æ‚ï¼‰ é™¤äº†åå­—å’Œæ ‡ç­¾ç±»åž‹æ˜¯å¯¹äºŽdeploymentçš„å®šä¹‰å¤–ï¼Œä¸‹é¢çš„è§„æ ¼å°±æ˜¯deploymenté•¿å¾—æ ·å­ã€‚è€Œè¿™é‡Œçš„æ¨¡æ¿æ˜¯ä¸€ä¸ªpodçš„æ¨¡æ¿ï¼Œå®šä¹‰äº†podçš„æ ·å­ã€‚ è¦ç‚¹1ï¼šä»Žå®šä¹‰ä¸Šæˆ‘ä»¬å¯ä»¥æ˜Žæ˜¾çš„çœ‹å‡º deployment å¹¶ä¸æ˜¯ç›´æŽ¥æŽ§åˆ¶çš„ pod ï¼Œå…¶ä¸­åœ¨è§„æ ¼ä¸­çš„å®šä¹‰æ˜¯ replicas ï¼Œæ‰€ä»¥æŽ§åˆ¶å…¶å®žæ˜¯ ReplicaSetï¼Œç”± ReplicaSet åŽ»æŽ§åˆ¶ pod ä½¿ç”¨ é€šè¿‡ kubectl create -f deploy-nginx.yml å‘½ä»¤å¯ä»¥åˆ›å»ºè¿™ä¸ª Deployment é€šè¿‡ kubectl get rs å‘½ä»¤æŸ¥çœ‹ ReplicaSet çš„æƒ…å†µ é€šè¿‡ kubectl get pods å‘½ä»¤æŸ¥çœ‹ Pod çš„æƒ…å†µ 123456NAME DESIRED CURRENT READY AGEnginx-deployment-54f57cf6bf 2 2 2 75sNAME READY STATUS RESTARTS AGEnginx-deployment-54f57cf6bf-mjqw9 1/1 Running 0 4snginx-deployment-54f57cf6bf-pvtkq 1/1 Running 0 4s ç‰¹ç‚¹çœ‹å®Œäº†å®šä¹‰å’Œä½¿ç”¨ï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹å®ƒæœ‰ä»€ä¹ˆç‰¹ç‚¹ åˆ é™¤podæˆ‘ä»¬å¯ä»¥é€šè¿‡ kubectl delete pod nginx-deployment-54f57cf6bf-mjqw9 å‘½ä»¤åˆ é™¤ä¸€ä¸ª pod ç„¶åŽæˆ‘ä»¬å†åŽ»æŸ¥çœ‹å½“å‰ pod çš„æƒ…å†µ123NAME READY STATUS RESTARTS AGEnginx-deployment-54f57cf6bf-4scrb 1/1 Running 0 43snginx-deployment-54f57cf6bf-pvtkq 1/1 Running 0 5m æˆ‘ä»¬ä¼šæƒŠå¥‡çš„å‘çŽ°ï¼Œå®ƒåˆé‡æ–°åˆ›å»ºäº†ä¸€ä¸ªpod è¦ç‚¹2ï¼šDeployment ä¼šç»´æŠ¤podçš„æ•°é‡ï¼Œä¸€æ—¦ä¸æ»¡è¶³æ•°é‡çš„å®šä¹‰éœ€æ±‚ï¼Œå°±ä¼šè¿›è¡Œåˆ›å»º åˆ é™¤rsæˆ‘ä»¬å¯ä»¥é€šè¿‡ kubectl delete rs nginx-deployment-54f57cf6bf å‘½ä»¤åˆ é™¤ä¸€ä¸ª rs ç„¶åŽæˆ‘ä»¬åŽ»çœ‹ rs å’Œ podï¼Œä½ å°±ä¼šå‘çŽ°å®ƒåˆé‡æ–°å¸®ä½ åˆ›å»ºäº† è¦ç‚¹3ï¼šDeployment ä¼šç»´æŠ¤ ReplicaSet æ‰©å®¹è¯´å®Œäº†åˆ é™¤ï¼Œé‚£æˆ‘ä»¬æƒ³è¦æ‰©å®¹æ€Žä¹ˆåŠžå‘¢ï¼Ÿæˆ‘çŽ°åœ¨è¦æŠŠpodå˜æˆ3ä¸ª æ–¹å¼1 ä¿®æ”¹ymlæ–‡ä»¶ï¼Œå°†2æ”¹ä¸º3ï¼›ç„¶åŽä½¿ç”¨ kubectl apply -f deploy-nginx.yml æ–¹å¼2 ç›´æŽ¥ä½¿ç”¨å‘½ä»¤ kubectl scale deploy nginx-deployment --replicas=3 æ–¹å¼3 ç›´æŽ¥ä½¿ç”¨å‘½ä»¤ kubectl edit deploy nginx-deployment ä¿®æ”¹ replicas: 3 è¦ç‚¹4ï¼šè¿™äº›æ–¹å¼éƒ½å¯ä»¥å®Œæˆæ‰©å®¹ç¼©å®¹çš„æ•ˆæžœï¼ŒåŒæ—¶è¿˜å¯ä»¥ä¿®æ”¹åˆ«çš„å±žæ€§ï¼Œå¦‚nginxç‰ˆæœ¬ç­‰ è®¾è®¡æ¨¡å¼è¯´å®Œäº†å®šä¹‰å’Œç‰¹ç‚¹ï¼Œæ¥è¯´è¯´deploymentçš„è®¾è®¡ æŽ§åˆ¶å™¨æ¨¡å¼è¿™ä¸ªè®¾è®¡æ¨¡å¼å…¶å®žåœ¨k8sä¸­å¾ˆå¸¸è§ï¼Œç”±AæŽ§åˆ¶Bï¼Œç”±BæŽ§åˆ¶Cï¼Œk8sæ²¡æœ‰è®©æˆ‘ä»¬ç›´æŽ¥åŽ»æŽ§åˆ¶podï¼Œè€Œæ˜¯é€šè¿‡ deployment åŽ»æŽ§åˆ¶ï¼Œè€Œ deployment å…¶å®žä¹Ÿä¸æ˜¯å®žé™…å¹²æ´»çš„ï¼Œå…¶å®žå®žé™…å¹²æ´»çš„æ˜¯ ReplicaSetï¼Œæœ‰è¿™æ ·çš„æŽ§åˆ¶é“¾è·¯ç»„æˆçš„æŽ§åˆ¶å™¨æ¨¡å¼ã€‚1234graph LR; Deployment--&gt;ReplicaSet; ReplicaSet--&gt;Pod1; ReplicaSet--&gt;Pod2; è¿™æ ·ä¸€å±‚å±‚çš„æŽ§åˆ¶èƒ½è®©æˆ‘ä»¬æ›´æ¸…æ™°çš„åŽ»æŽ§åˆ¶æˆ‘ä»¬çš„æœ€ç»ˆè¦çš„ç»“æžœï¼ŒåŒæ—¶è®©æœ€ç»ˆç»“æžœçš„æŽ§åˆ¶å˜å¾—ç®€å•ã€‚ æ»šåŠ¨æ›´æ–°æ¨¡å¼åœ¨ä½¿ç”¨ä¸­æˆ‘ä»¬è§‰å¾—éžå¸¸å¥½ç”¨çš„åŽŸå› æ˜¯ï¼Œæˆ‘ä»¬åªè¦ä¿®æ”¹å‚æ•°ï¼Œå°±èƒ½èŽ·å¾—æ°´å¹³æ‰©å®¹ç¼©å®¹çš„æ•ˆæžœï¼Œéžå¸¸ç®€å•ï¼Œè€Œè¿™å¯¹äºŽéœ€è¦æ°´å¹³æ‰©å±•çš„æœåŠ¡æ¥è¯´è¿™æ— ç–‘æ˜¯éžå¸¸é‡è¦çš„ã€‚ å¦‚æžœåœ¨ä»¥å‰ï¼Œä½ éœ€è¦æ°´å¹³æ‰©å±•ä½ çš„åº”ç”¨ï¼Œä½ å°±éœ€è¦å¤åˆ¶ä¸€ä¸ªä½ åº”ç”¨ï¼Œæˆ–è€…è¯´å¤åˆ¶ä¸€ä¸ªtomcatï¼Œç„¶åŽä¿®æ”¹å„ç§é…ç½®é¿å…å†²çªï¼Œå¦‚æžœæœåŠ¡æŒ‚äº†ä½ éœ€è¦æ‰‹åŠ¨åŽ»é‡æ–°å¯åŠ¨â€¦. è€Œk8sè®¾è®¡åœ¨äºŽï¼Œä½ åªéœ€è¦æè¿°ç›®æ ‡çŠ¶æ€æ˜¯ä»€ä¹ˆï¼Œå°±èƒ½å¸®ä½ ç»´æŠ¤ç›®æ ‡çŠ¶æ€çš„æ ·å­ï¼Œä¸å¯¹äº†æˆ‘ä¼šè‡ªåŠ¨å¸®ä½ è¿›è¡Œè°ƒæ•´ã€‚ä½ çš„ä»»ä½•æ›´æ–°éƒ½ä¼šåŠæ—¶è¢«åæ˜ åˆ°çŠ¶æ€ä¸­åŽ»ã€‚ 123456789for &#123; å®žé™…çŠ¶æ€ := èŽ·å–é›†ç¾¤ä¸­å¯¹è±¡ X çš„å®žé™…çŠ¶æ€(Actual State) æœŸæœ›çŠ¶æ€ := èŽ·å–é›†ç¾¤ä¸­å¯¹è±¡ X çš„æœŸæœ›çŠ¶æ€(Desired State) if å®žé™…çŠ¶æ€ == æœŸæœ›çŠ¶æ€&#123; ä»€ä¹ˆéƒ½ä¸åš &#125; else &#123; æ‰§è¡Œç¼–æŽ’åŠ¨ä½œï¼Œå°†å®žé™…çŠ¶æ€è°ƒæ•´ä¸ºæœŸæœ›çŠ¶æ€ &#125;&#125; åŽŸç†https://draveness.me/kubernetes-deployment]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ç»†è¯´kubernetes - ä¸ºä»€ä¹ˆæ˜¯pod]]></title>
    <url>%2F2020%2F01%2F11%2Fgolang%2Fopen-source-component%2Fk8s-dis-pod%2F</url>
    <content type="text"><![CDATA[k8sä½œä¸ºçŽ°åœ¨æœ€ç«çš„å®¹å™¨ç¼–æŽ’è°ƒåº¦å¹³å°ï¼Œå¥½ç”¨æˆ‘ä¹Ÿå°±ä¸å¿…å¤šè¯´äº†ã€‚å½“æˆ‘ä»¬åˆè¯†k8sçš„æ—¶å€™ä¸€ä¸ªæ–°çš„æ¦‚å¿µå°±åˆ°äº†æˆ‘ä»¬çœ¼å‰ï¼Œé‚£å°±æ˜¯podã€‚æˆ‘ä»¬åœ¨ä½¿ç”¨äº†ä¹‹åŽä¹Ÿå°±æ¸æ¸çš„æŽ¥å—äº†podè¿™ä¸ªä¸œè¥¿ï¼Œä½†æ˜¯ä½ æœ‰æ²¡æœ‰æƒ³è¿‡ï¼Œä¸ºä»€ä¹ˆæ˜¯podï¼Ÿk8sä¸ºä»€ä¹ˆä¼šæœ‰è¿™æ ·çš„è®¾è®¡ï¼Ÿä»Šå¤©æˆ‘ä»¬å°±æ¥ç»†ç»†è¯´è¯´è¿™ä¸ªpod æž¶æž„å›¾é¦–å…ˆæˆ‘ä»¬æ¥å›žå¿†çœ‹çœ‹k8sçš„æž¶æž„å›¾æ˜¯ä»€ä¹ˆæ ·å­çš„è¿™ä¸ªæ˜¯æ¥æºäºŽ https://www.kubernetes.org.cn/ ä¸­æ–‡å®˜ç½‘çš„ä¸€ä¸ªæž¶æž„å›¾ ä»Žæž¶æž„å›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ªk8sçš„è®¾è®¡æž¶æž„æœ‰ä»¥ä¸‹å‡ ä¸ªè¦ç‚¹ï¼š masterã€nodeæž¶æž„ï¼›masterå°±æ˜¯å¤§è„‘å……å½“ç€ç®¡ç†è€…çš„è§’è‰² masterä¸­æä¾›äº†api-serverã€controller-managerã€schedulerã€etcdç”¨äºŽç®¡ç†nodeå¹¶å‘å¤–æä¾›æœåŠ¡ nodeå°±æ˜¯å®žé™…å¹²æ´»çš„ï¼Œæä¾›äº†kubeletã€proxyç”¨äºŽå‘masteræ±‡æŠ¥æƒ…å†µï¼Œå¹¶ç®¡ç†podçš„ç½‘ç»œ è€Œpodæ˜¯k8sä¸­æœ€å°çš„è°ƒåº¦å•ä½ï¼ŒPodå°±æ˜¯æœ€å°çš„ï¼Œç®¡ç†ï¼Œåˆ›å»ºï¼Œè®¡åˆ’çš„æœ€å°å•å…ƒ. å½“ç„¶å…¶ä»–ç»„ä»¶éƒ½éžå¸¸é‡è¦ï¼Œè¿™ä¸ªæˆ‘ä»¬ä»¥åŽå†è¯´ï¼Œæˆ‘ä»¬ä»Šå¤©å°±æ¥çœ‹çœ‹ä¸»è§’â€œpodâ€ ä¸ºä»€ä¹ˆæ˜¯podï¼Ÿä¸€å¼€å§‹ç”¨çš„æ—¶å€™æˆ‘å°±å¥½å¥‡ä¸ºä»€ä¹ˆk8sè¦å¼„å‡ºä¸€ä¸ªpodï¼Œå› ä¸ºæˆ‘ä»¬ä¸€å¼€å§‹ä½¿ç”¨çš„æ˜¯dockerï¼Œæ“ä½œçš„æ˜¯dockerå®¹å™¨ï¼Œæž„å»ºçš„ä¹Ÿæ˜¯dockeré•œåƒï¼Œä¸ºä»€ä¹ˆä¸ç›´æŽ¥è°ƒåº¦dockerå®¹å™¨å°±å¥½äº†ï¼Œè¿™æ ·ç²’åº¦ä¸æ˜¯æ›´åŠ ç»†è‡´ï¼Œè°ƒåº¦ä¹Ÿä¼šæ›´åŠ æ–¹ä¾¿å—ï¼Ÿæˆ‘ä»¬åœ¨ä½¿ç”¨k8sä¹‹å‰ä¹Ÿä½¿ç”¨è¿‡docker-composeï¼Œä»Žå¦ä¸€ä¸ªè§’åº¦è¯´ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ç§å®¹å™¨çš„ç®¡ç†ï¼Œçœ‹èµ·æ¥ä¹ŸæŒºå¥½çš„ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥è¯´è¯´pod podæ‰®æ¼”çš„æ˜¯ä»€ä¹ˆè§’è‰² ä»Žä¸€å¼€å§‹æˆ‘ä»¬çš„æœåŠ¡å¾€å¾€æ˜¯è¿è¡Œåœ¨æœåŠ¡å™¨ä¸Šçš„ï¼Œä¸€ä¸ªåº”ç”¨å°±å ç”¨äº†ä¸€ä¸ªæœåŠ¡å™¨ï¼Œä½†æ˜¯ä¸€ä¸ªå¤§çš„æœåŠ¡å™¨ä¸Šå¾€å¾€ä¸ä¼šåªæœ‰ä¸€ä¸ªåº”ç”¨ã€‚ åŽæ¥æŠ€æœ¯çš„å‘å±•å‡ºçŽ°äº†è™šæ‹ŸåŒ–ï¼Œå°†ä¸€ä¸ªå¤§çš„æœåŠ¡å™¨ï¼Œè™šæ‹ŸåŒ–æˆå‡ ä¸ªå°çš„æœåŠ¡å™¨ï¼Œæ¥ä½¿ç”¨ï¼Œä»Ž èŠ‚çœèµ„æºä¹Ÿåšåˆ°äº†æœåŠ¡ä¸ŽæœåŠ¡ä¹‹é—´çš„éš”ç¦»ï¼Œä»Žè€Œé¿å…ä¸€ä¸ªæœåŠ¡çš„é—®é¢˜å¯¼è‡´æ•´ä¸ªæœåŠ¡å™¨å®•æœºã€‚åŽæ¥å‡ºçŽ°äº†dockerï¼ŒäºŽæ˜¯æˆ‘ä»¬åœ¨ä¸€ä¸ªæœåŠ¡å™¨ä¸Šé¢è¿è¡Œå¤šä¸ªå®¹å™¨ã€‚ k8sçš„podâ€¦ ä»Žä¸Šé¢çš„å›¾ä½ å¤§æ¦‚å¯ä»¥æ„Ÿå—åˆ°podåœ¨k8sä¸­å…¶å®žæ˜¯ä¸€ä¸ªä»€ä¹ˆæ ·çš„è§’è‰²ã€‚æˆ‘ä»¬å¦‚æžœä½¿ç”¨è™šæ‹Ÿæœºï¼Œé‚£ä¹ˆä¸Šé¢å°±ä¼šæœ‰ä¸€ç³»åˆ—çš„æœåŠ¡è¿™äº›æœåŠ¡å¯èƒ½ä¼šæœ‰ä¸€äº›ä¾èµ–ï¼Œè€Œè¿™æ ·çš„ä¾èµ–å°±å¥½åƒåœ¨æœåŠ¡å™¨ä¸­è¿è¡Œçš„ä¸€ä¸ªä¸ªè¿›ç¨‹ç»„ï¼Œå¾€å¾€å…¶ä¸­ä¹Ÿæœ‰ç€ç›¸å…³çš„ä¾èµ–ï¼Œè€Œpodä¸­çš„å®¹å™¨ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ï¼Œå…¶ä¸­ä¹Ÿä¼šæœ‰ç±»ä¼¼è¿™æ ·çš„ä¾èµ–ï¼Œä¸ºäº†æ›´å¥½çš„æè¿°å’Œç®¡ç†è¿™æ ·çš„ä¾èµ–ï¼ŒäºŽæ˜¯å°±æœ‰äº†podã€‚å…¶å®žè¿™æ ·çš„ç†å¿µå¾€å¾€å¯ä»¥ç±»æ¯”å‡ºå¾ˆå¤šè¿™æ ·çš„è®¾è®¡ã€‚ Podä¸­å®¹å™¨çš„å…³ç³»ä¸€å®šä¼šæœ‰è¿™æ ·çš„å…³ç³»å—ï¼Ÿæˆ‘çš„æ„Ÿè§‰æ˜¯ï¼Œåœ¨çŽ°ä»£æŠ€æœ¯æœåŠ¡çš„å¼€å‘çš„è¿‡ç¨‹ä¸­ï¼Œè¿™æ ·çš„å…³ç³»æ˜¯ä¸å¯é¿å…çš„ã€‚æˆ‘ä¸‹é¢æ¥ä¸¾å‡ ä¸ªä¾‹å­ã€‚ è¿è¡Œæ—¶å®¹å™¨å’Œé¡¹ç›®åŒ…æˆ‘ä»¬çŸ¥é“ java çš„ web åº”ç”¨å¾€å¾€éœ€è¦éƒ¨ç½²åœ¨tomcatè¿™æ ·çš„å®¹å™¨ä¹‹ä¸­ï¼Œåœ¨ springboot è¿˜æ²¡æœ‰å‡ºçŽ°ä»¥å‰ï¼Œéœ€è¦è‡ªå·±å¯åŠ¨ä¸€ä¸ª tomcat å®¹å™¨ï¼Œç„¶åŽå°†éœ€è¦éƒ¨ç½²çš„åº”ç”¨æ‰“åŒ…éƒ¨ç½²åˆ°å®¹å™¨ä¸­åŽ»ã€‚ åœ¨ä»¥å‰ä½ å¯èƒ½ä¼šæƒ³ç€ï¼Œå°† javaweb æ‰“åŒ…ä¸€ä¸ªwarï¼Œç„¶åŽç¼–å†™ä¸€ä¸ª dockerfile å°† war åŒ…cpåˆ° tomcat ä¸­çš„ webapp ç›®å½•ä¸­ã€‚ä½†æ˜¯è¿™æ ·å¸¦æ¥çš„å°±æ˜¯æ¯æ¬¡æ›´æ–°å‘å¸ƒçš„æ—¶å€™ï¼Œé•œåƒä¼šå¾ˆå¤§ï¼Œå› ä¸ºæ¯æ¬¡æž„å»ºéƒ½ä¼šæœ‰ä¸€ä¸ªåŸºç¡€çš„tomcaté•œåƒã€‚ è€Œåœ¨k8sä½¿ç”¨çš„æ—¶å€™ï¼Œä¼šæœ‰çš„è®¾è®¡çš„æ˜¯ï¼Œå°†tomcatä½œä¸ºä¸€ä¸ªä¸å˜çš„é•œåƒï¼ˆå®ƒä¹Ÿä¸åº”è¯¥æ”¹å˜ï¼‰è€ŒæŠŠ war åŒ…ä½œä¸ºå¦å¤–ä¸€ä¸ªå®¹å™¨ï¼Œè€Œè¿™æ ·ä¸ªå®¹å™¨åŒæ—¶æŒ‚è½½åŒä¸€ä¸ªç›®å½•ï¼Œå°† webapp æŒ‚è½½çš„ç›®å½•ä¸Ž waråŒ…æŒ‚è½½çš„ç›®å½•ç›¸åŒæ¥è¾¾åˆ°ç›®çš„ï¼Œç„¶åŽå°†ä»–ä»¬æ”¾åˆ°åŒä¸€ä¸ª pod ä¸­ã€‚ ç±»ä¼¼çš„æ“ä½œè¿˜æœ‰ï¼š https://kubernetes.io/zh/docs/tasks/access-application-cluster/communicate-containers-same-pod-shared-volume/ é‡Œé¢è¯´çš„å°±æ˜¯å‰ç«¯é™æ€é¡µé¢å’Œ nginx çš„å…³ç³»ã€‚ ä¸‹é¢å¼•ç”¨å®˜ç½‘è®¾è®¡ç†å¿µä¸­çš„ä¸€å¥è¯ï¼šâ€œæ¯”å¦‚ä½ è¿è¡Œä¸€ä¸ªæ“ä½œç³»ç»Ÿå‘è¡Œç‰ˆçš„è½¯ä»¶ä»“åº“ï¼Œä¸€ä¸ªNginxå®¹å™¨ç”¨æ¥å‘å¸ƒè½¯ä»¶ï¼Œå¦ä¸€ä¸ªå®¹å™¨ä¸“é—¨ç”¨æ¥ä»Žæºä»“åº“åšåŒæ­¥ï¼Œè¿™ä¸¤ä¸ªå®¹å™¨çš„é•œåƒä¸å¤ªå¯èƒ½æ˜¯ä¸€ä¸ªå›¢é˜Ÿå¼€å‘çš„ï¼Œä½†æ˜¯ä»–ä»¬ä¸€å—å„¿å·¥ä½œæ‰èƒ½æä¾›ä¸€ä¸ªå¾®æœåŠ¡ï¼›è¿™ç§æƒ…å†µä¸‹ï¼Œä¸åŒçš„å›¢é˜Ÿå„è‡ªå¼€å‘æž„å»ºè‡ªå·±çš„å®¹å™¨é•œåƒï¼Œåœ¨éƒ¨ç½²çš„æ—¶å€™ç»„åˆæˆä¸€ä¸ªå¾®æœåŠ¡å¯¹å¤–æä¾›æœåŠ¡ã€‚â€ æ—¥å¿—æž¶æž„åœ¨ä½¿ç”¨ docker éƒ¨ç½²é¡¹ç›®çš„æ—¶å€™ä¼šé‡åˆ°ä¸€ä¸ªé—®é¢˜å°±æ˜¯æ—¥å¿—æŒä¹…åŒ–çš„é—®é¢˜ï¼Œå› ä¸º docker å®¹å™¨å¦‚æžœè¢«åˆ é™¤çš„è¯ï¼Œå…¶ä¸­çš„æ–‡ä»¶ä¹Ÿä¼šè¢«åˆ é™¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„æ—¥å¿—æ–‡ä»¶åŒæ—¶ä¹Ÿä¼šè¢«åˆ é™¤ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¿…é¡»è¦å°†æ—¥å¿—æŒä¹…åŒ–ã€‚ æœ€å¸¸è§çš„æ–¹å¼æ˜¯ï¼Œå°†æ—¥å¿—å­˜å‚¨çš„ç›®å½•æŒ‚è½½åˆ°å®¿ä¸»æœºä¸Šï¼Œè¿™æ ·å®¹å™¨è¢«åˆ é™¤çš„æ—¶å€™æ—¥å¿—ä¸ä¼šè¢«åˆ é™¤ã€‚è€Œåœ¨k8sä¸­å¸¸è§çš„æ—¥å¿—å¤„ç†æž¶æž„æ˜¯æ€Žä¹ˆæ ·çš„å‘¢ï¼Ÿ https://kubernetes.io/zh/docs/concepts/cluster-administration/logging/ ä½¿ç”¨çš„æ˜¯ sidecarï¼Œè¿™ä¸ªæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå…¶å®žå°±æ˜¯ä¸€ä¸ªè¾…åŠ©æ€§è´¨çš„å®¹å™¨ï¼ŒåŒæ—¶ä¸Žä¸»å®¹å™¨æ”¾åœ¨åŒä¸€ä¸ª pod ä¸­ï¼Œè¯»å–ä¸»å®¹å™¨æŒ‚è½½å‡ºæ¥çš„æ—¥å¿—ç›®å½•ã€‚å…¶å®žåŽç»­è¿˜å¯ä»¥åšæ›´å¤šçš„æ“ä½œï¼Œæ¯”å¦‚æ—¥å¿—å‘é€esç­‰ç­‰ã€‚ æ€»ä¹‹æ€»ä¹‹æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ä¸€ä¸ªpodä¸­çš„å®¹å™¨å…³ç³»æ˜¯éžå¸¸å¯†åˆ‡çš„ï¼Œä»–ä»¬å¯ä»¥æ‹¥æœ‰åŒä¸€ä¸ªç›®å½•ï¼Œç”šè‡³å¯ä»¥æ‹¥æœ‰åŒä¸€ä¸ªç½‘ç»œï¼Œå¯ä»¥æ‹¥æœ‰ç›¸äº’çš„æœåŠ¡ï¼Œè¿™æ ·çš„å…³ç³»æˆ‘å¬è¿‡çš„åè¯å«åšâ€œè¶…äº²å¯†å…³ç³»â€ã€‚å°±ç±»ä¼¼ä¸€å¯¹å¤«å¦»ä¹‹é—´çš„å…³ç³»äº†ã€‚ å› ä¸ºåœ¨çŽ°åœ¨çš„å¤šè¯´åº”ç”¨ä¸­ï¼Œå·²ç»å‡ ä¹Žåšä¸åˆ°ä¸€ä¸ªäººé¡¶å¤©ç«‹åœ°äº†ï¼Œæ€»æ˜¯ä¼šæœ‰å„ç§å„æ ·çš„ä¾èµ–ï¼Œä¾èµ–ä¸€äº›ç»„ä»¶ï¼Œä¾èµ–ä¸€äº›å·¥å…·ï¼Œä¾èµ–ä¸€äº›ç½‘ç»œæœåŠ¡ç­‰ç­‰ï¼Œä¸€ä¸ªè¿›ç¨‹ç»„æœ‰å¾ˆå¤šçš„è¿›ç¨‹äº’ç›¸å¸®åŠ©æ¥æœ€ç»ˆå®žçŽ°åŠŸèƒ½ä¸€æ ·ã€‚ è¿™æ ·çš„å…³ç³»å¤ªè¿‡å¸¸è§ï¼ŒäºŽæ˜¯k8så°±å°†å®ƒè®¾è®¡ä¸ºäº†podã€‚ podçš„å®žçŽ°åŽŸç†å¦‚æžœä½ å·²ç»å¯¹dockerçš„å®žçŽ°æ¯”è¾ƒç†Ÿæ‚‰ï¼Œå…¶å®žpodçš„å®žçŽ°å¹¶ä¸å¤æ‚ã€‚ï¼ˆå¦‚æžœå¯¹dockerå®žçŽ°ä¸ç†Ÿæ‚‰å¯ä»¥ç¿»çœ‹ä¹‹å‰çš„åšå®¢ï¼‰å…¶å®žpodæ˜¯ä¸€ä¸ªé€»è¾‘ä¸Šçš„æ¦‚å¿µï¼Œå…¶å®žpodåšçš„äº‹æƒ…å¾ˆç®€å•ï¼š podä¸­çš„æ‰€æœ‰å®¹å™¨å…±äº«ä¸€ä¸ªNetwork Namespace podä¸­çš„åŒæœŸå¯ä»¥å£°æ˜Žäº’ç›¸å…±äº«Volume å¦‚ä½•å®žçŽ°çš„å…¶å®žk8såšçš„å°±æ˜¯åˆå§‹åŒ–ä¸€ä¸ªinfraçš„å®¹å™¨ï¼ˆè¿™æ˜¯ä¸€ä¸ªå¾ˆå°çš„å®¹å™¨ï¼‰ï¼Œåˆ©ç”¨è¿™ä¸ªå®¹å™¨åŽ»æŠ¢å…ˆå ç”¨éœ€è¦ä½¿ç”¨çš„ Namespace ï¼Œç„¶åŽåœ¨å°†ç”¨æˆ·æŒ‡å®šçš„å®¹å™¨åŠ è½½è¿›æ¥ï¼ŒåŒæ—¶ä½¿ç”¨çš„å°±æ˜¯ç›¸åŒçš„ Namespace äº†ã€‚ï¼ˆå¦‚æžœæœ‰ InitContainer ä¼šä¼˜å…ˆæŒ‰é¡ºåºåˆå§‹åŒ–å®ƒï¼Œå›¾ä¸Šå°±ä¸åšè¯´æ˜Žäº†ï¼‰ è¿™æ ·å…±äº«ç½‘ç»œåº”è¯¥æ˜¯æ²¡æœ‰é—®é¢˜äº†ï¼Œé‚£ä¹ˆè¦å…±äº«Volumeä¹Ÿå¾ˆç®€å•ã€‚pod åªéœ€è¦å°† Volume ç›®å½•æŒ‚è½½åˆ°å®¿ä¸»æœºï¼Œè®©å†…éƒ¨çš„å®¹å™¨æŒ‚è½½è¿™ä¸ªç›®å½•å°±å¯ä»¥äº†ã€‚ è¿˜æœ‰å“ªäº›å…±äº« PID å‘½åç©ºé—´ï¼ˆåŒä¸€ä¸ªPodä¸­åº”ç”¨å¯ä»¥çœ‹åˆ°å…¶å®ƒè¿›ç¨‹ï¼‰ ç½‘ç»œ å‘½åç©ºé—´ï¼ˆåŒä¸€ä¸ªPodçš„ä¸­çš„åº”ç”¨å¯¹ç›¸åŒçš„IPåœ°å€å’Œç«¯å£æœ‰æƒé™ï¼‰ IPC å‘½åç©ºé—´ï¼ˆåŒä¸€ä¸ªPodä¸­çš„åº”ç”¨å¯ä»¥é€šè¿‡VPCæˆ–è€…POSIXè¿›è¡Œé€šä¿¡ï¼‰ UTS å‘½åç©ºé—´ï¼ˆåŒä¸€ä¸ªPodä¸­çš„åº”ç”¨å…±äº«ä¸€ä¸ªä¸»æœºåç§°ï¼‰ podè¿˜æœ‰è¿˜æœ‰å“ªäº›åŠŸèƒ½å†æ¥è¯´è¯´podè¿˜æœ‰å“ªäº›åŠŸèƒ½ï¼Œè¿™äº›åŠŸèƒ½ä¹Ÿæ˜¯k8sä¸ºä»€ä¹ˆè®¾è®¡podçš„åŽŸå› ä¹‹ä¸€ å¥åº·æ£€æŸ¥é€šè¿‡Probeï¼šLivenessProbeæˆ–è€…ReadinessProbeï¼Œå¯ä»¥æŽ¢æµ‹åº”ç”¨æ˜¯å¦å¤„äºŽå¥åº·çŠ¶æ€ï¼Œå¦‚æžœä¸å¥åº·åšå‡ºç›¸å…³çš„ååº”ã€‚è¿™å°±å¥½æ¯”k8så¯ä»¥å®šæœŸçš„å¸®ä½ ç›‘æŽ§ã€ç»´æŒä¸€æ•´ä¸ªåº”ç”¨çš„å¥åº·ã€‚å…¶å®žåœ¨æˆ‘ä»¬çœ‹æ¥ï¼Œå¾ˆå¤šæ—¶å€™æœåŠ¡æŒ‚äº†ï¼Œéœ€è¦é‡å¯ï¼Œéœ€è¦åšé«˜å¯ç”¨ï¼Œé‚£ä¹ˆnginxå‘¢ï¼Ÿtomcatå‘¢ï¼Ÿä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚æ‰€ä»¥podçš„å¥åº·èƒ½ä¿è¯æ•´ä¸ªæœåŠ¡çš„å…¨éƒ¨å¥åº·ä½¿ç”¨ã€‚ é™åˆ¶ç½‘ç»œå¸¦å®½æˆ‘ä»¬å¯ä»¥é€šè¿‡ç»™Podå¢žåŠ kubernetes.io/ingress-bandwidthå’Œkubernetes.io/egress-bandwidthè¿™ä¸¤ä¸ªannotationæ¥é™åˆ¶Podçš„ç½‘ç»œå¸¦å®½ã€‚ä¸ºä»€ä¹ˆæˆ‘æåˆ°äº†è¿™ä¸ªåŠŸèƒ½å‘¢ï¼Ÿå› ä¸ºåœ¨å®žé™…çš„ä¸šåŠ¡å¼€å‘è¿‡ç¨‹ä¸­ç»å¸¸ä¼šä½¿ç”¨ä¸€äº›ç½‘ç»œæ’ä»¶ï¼Œè¿™äº›ç½‘ç»œæ’ä»¶åœ¨æµé‡çš„æŽ§åˆ¶ä¸Šéžå¸¸æœ‰ç”¨ï¼Œæœ‰çš„æ—¶å€™æˆ‘ä»¬ä¼šæ ¹æ®ç½‘ç»œæµé‡æ¥åšä¸€ç³»åˆ—çš„æ“ä½œï¼Œç”¨æˆ·çš„çªç„¶å¢žé•¿å¯¼è‡´çš„æµé‡å‰§å¢žæ˜¯å¦è¦æ‰©å®¹ç­‰ç­‰â€¦è€Œè¿™æ ·çš„ç›‘æŽ§å’Œé™åˆ¶å¯¹äºŽpodæ¥è¯´æ— ç–‘ä¼šæ›´åŠ æ–¹ä¾¿ï¼Œè€Œä¸éœ€è¦ç®¡podå†…éƒ¨çš„å®¹å™¨çš„æµé‡ã€‚ RestartPoliyé‡å¯çš„ç­–ç•¥ï¼Œè¿™ä¸ªä¹Ÿç®—æ˜¯ä¸€ä¸ªåŠŸèƒ½å§ Alwaysï¼šåªè¦é€€å‡ºå°±é‡å¯ OnFailureï¼šå¤±è´¥é€€å‡ºï¼ˆexit codeä¸ç­‰äºŽ0ï¼‰æ—¶é‡å¯ Neverï¼šåªè¦é€€å‡ºå°±ä¸å†é‡å¯è¯´æ˜Ž k8s ç®¡ç† pod çš„ç”Ÿå‘½å‘¨æœŸæ›´åŠ å®¹æ˜“ï¼Œè¿˜æœ‰è°ƒåº¦ç­‰ç­‰è¿™é‡Œå°±ä¸å†å±•å¼€äº†ã€‚ æ€»ç»“å®˜ç½‘ï¼šä¸€ä¸ªPodï¼ˆå°±åƒä¸€ç¾¤é²¸é±¼ï¼Œæˆ–è€…ä¸€ä¸ªè±Œè±†å¤¹ï¼‰ã€‚ æˆ‘è§‰å¾— Pod æ›´è¯æ˜Žäº†ä¸€ç§è®¾è®¡æ¨¡å¼â€œç»„åˆâ€ï¼Œåœ¨æœ‰çš„æ—¶å€™ä¼šï¼Œç»„åˆçš„åˆç†ï¼Œå°±ä¼šæ–¹ä¾¿å¾ˆå¤šä¸œè¥¿ï¼Œæ¯”å¦‚è®¾è®¡äº†ä¸€å †ç»„ä»¶ï¼Œç»„åˆåœ¨ä¸€èµ·ï¼›psç”»å›¾çš„æ—¶å€™æ–¹å—æ›´åœ†ç»„åˆåœ¨ä¸€èµ·ï¼Œå°±å¯ä»¥ä¸€èµ·å¤šå¤åˆ¶å‡ ä¸ªç»„åˆã€‚ å½“ç„¶æˆ‘ä»¬åœ¨è®¤è¯†åˆ°ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡ Pod çš„åŒæ—¶éœ€è¦æ„è¯†åˆ°ï¼Œæˆ‘ä»¬åº”è¯¥å°†ä»€ä¹ˆæ ·çš„å®¹å™¨ç»„åˆæ”¾ç½®åœ¨åŒä¸€ä¸ª Pod ä¹‹ä¸­æ‰æ¯”è¾ƒåˆé€‚ã€‚éµå¾ªä¸€å®šçš„â€œå®¹å™¨è®¾è®¡æ¨¡å¼â€è¿›è¡Œç¼–æŽ’ï¼Œè°ƒåº¦çš„æ—¶å€™æ‰ä¼šæ›´åŠ å¾—å¿ƒåº”æ‰‹ã€‚]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ç»†è¯´docker - å®¹å™¨æŠ€æœ¯]]></title>
    <url>%2F2020%2F01%2F04%2Fgolang%2Fopen-source-component%2Fdocker-dis%2F</url>
    <content type="text"><![CDATA[dockerå¯¹äºŽçŽ°åœ¨çš„æˆ‘ä»¬æ¥è¯´ï¼Œå·²ç»æ˜¯ä¸€ä¸ªéžå¸¸ç†Ÿæ‚‰çš„ä¸œè¥¿äº†ï¼Œdockeræ— è®ºæ˜¯åœ¨éƒ¨ç½²æ‰“åŒ…ï¼Œè‡ªåŠ¨åŒ–ï¼Œç­‰æ–¹æ–¹é¢é¢éƒ½èµ·ç€é‡è¦çš„ä½œç”¨ï¼Œä½†æ˜¯ä½ æ˜¯å¦æœ‰ç–‘é—®ï¼Œdockerç©¶ç«Ÿæ˜¯å¦‚ä½•å¸®æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä¸ªéš”ç¦»çš„çŽ¯å¢ƒçš„å‘¢ï¼Ÿä»Šå¤©æˆ‘ä»¬å°±æ¥çœ‹çœ‹ï¼Œä»”ç»†è¯´è¯´docker PS: ä»¥ä¸‹çš„è®¨è®ºéƒ½é™å®šåœ¨linuxçŽ¯å¢ƒä¸‹ï¼Œåœ¨windowså’Œmacosä¸‹å®¹å™¨æŠ€æœ¯å®žçŽ°ä¸ç›¸åŒï¼Œä¸åœ¨è®¨è®ºèŒƒå›´å†…ã€‚ å¤§æ–¹å‘ä¸ºä»€ä¹ˆå…ˆè¦æåˆ°è¿™ä¸ªè¯å‘¢ï¼Ÿå› ä¸ºæ‰€æœ‰åœ¨æ“ä½œç³»ç»Ÿä¸Šè¿è¡Œçš„ç¨‹åºéƒ½å«åšè¿›ç¨‹ã€‚dockerä¹Ÿä¸ä¾‹å¤–ï¼Œä»Žå¤§çš„æ–¹å‘æ¥è®²ï¼Œdockerå°±æ˜¯å¸®ä½ åˆ›å»ºäº†ä¸€ä¸ªè¿›ç¨‹è€Œå·²ã€‚è€Œä¸ä¸€æ ·çš„æ˜¯ï¼Œdockeré€šè¿‡é™åˆ¶äº†å„ç§çŽ¯å¢ƒï¼Œå°±åƒç»™è¿™ä¸ªè¿›ç¨‹ç”»äº†ä¸€ä¸ªåœˆï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªè¿›ç¨‹æœ¬èº«çœ‹æ¥ï¼Œå®ƒè‡ªå·±å¥½åƒè¢«éš”ç¦»äº†ä¸€èˆ¬ã€‚ dockerå®¹å™¨æŠ€æœ¯çš„æ ¸å¿ƒï¼Œå°±æ˜¯é€šè¿‡çº¦æŸå’Œä¿®æ”¹è¿›ç¨‹çš„åŠ¨æ€è¡¨çŽ°ï¼Œä»Žè€Œä¸ºå…¶åˆ›é€ å‡ºä¸€ä¸ªâ€œè¾¹ç•Œâ€ é™åˆ¶æ¡ä»¶é‚£ä¹ˆæˆ‘ä»¬æœ‰äº†å¤§æ–¹å‘ï¼Œé‚£ä¹ˆæ¥ç»†ç»†çœ‹çœ‹ï¼Œé¦–å…ˆçš„ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ¥äº†ï¼Œdockeræ˜¯é€šè¿‡ä»€ä¹ˆæ–¹æ³•å¯¹è¿™ä¸ªè¿›ç¨‹è¿›è¡Œé™åˆ¶çš„å‘¢ï¼Ÿ Namespaceå‘½åç©ºé—´ï¼Œæ²¡é”™å°±æ˜¯å®ƒï¼Œæ˜¯å®ƒé™åˆ¶äº†dockerå®¹å™¨çš„çŽ¯å¢ƒã€‚å…¶å®žè¿™æ˜¯linuxçš„ä¸€ä¸ªåŠŸèƒ½è€Œå·²ï¼Œåªä¸è¿‡æ²¡äººæƒ³åˆ°dockerä¼šé‚£å®ƒæ¥åšè¿™ä¸ªäº‹æƒ…ã€‚ä¸‹é¢çœ‹ä¸ªä¾‹å­ï¼Œä¸€ä¸‹æ˜¯æˆ‘åœ¨ä¸€ä¸ªnginxå®¹å™¨ä¸­åˆ©ç”¨pså‘½ä»¤æŸ¥çœ‹çš„è¿›ç¨‹æ ·å­1234567/ # ps -efPID USER COMMAND 1 root sh /start.sh 8 root nginx: master process /usr/sbin/nginx 9 nobody nginx: worker process 18 root /bin/sh 25 root ps -ef æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒPIDæ˜¯ä»Ž1å¼€å§‹çš„ï¼Œå½“å‰å®¿ä¸»æœºè‚¯å®šä¹Ÿæœ‰PIDä¸º1çš„è¿›ç¨‹ï¼Œè¿™è¯´æ˜Žå®¹å™¨ä¸­æ‰€æœ‰çš„è¿›ç¨‹çœ‹èµ·æ¥å¥½åƒå’Œå®¿ä¸»æœºéš”ç¦»äº†ã€‚å…¶å®žè¿™å°±æ˜¯åˆ©ç”¨äº† CLONE_NEWPID æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨linuxä¸‹å¯ä»¥åˆ©ç”¨clone(main_function, stack_size, SIGCHLD, NULL);æ–¹æ³•åˆ›å»ºè¿›ç¨‹ï¼Œå¦‚æžœåŒæ—¶ä½ å†å‚æ•°ä¸­è®¾å®šå‚æ•°CLONE_NEWPIDclone(main_function, stack_size, CLONE_NEWPID | SIGCHLD, NULL); é‚£ä¹ˆæ–°åˆ›å»ºçš„è¿›ç¨‹å°±ä¼šåœ¨ä¸€ä¸ªæ–°çš„ç©ºé—´ä¸‹ï¼Œåœ¨è¿™ä¸ªç©ºé—´ä¸­å®ƒè‡ªå·±çš„pidå°±æ˜¯1ï¼›è€Œå…¶å®žåœ¨ä¸»æœºæœ¬èº«çœ‹æ¥è¿™ä¸ªè¿›ç¨‹çš„pidè¿˜æ˜¯ä¸€ä¸ªåˆ«çš„æ•°å­—ã€‚ç”±äºŽæ–°çš„è¿›ç¨‹åœ¨å®ƒè‡ªå·±çš„ç©ºé—´ä¸­è®¤ä¸ºè‡ªå·±æ˜¯1å·è¿›ç¨‹ï¼Œæ‰€ä»¥çœ‹èµ·æ¥å¥½åƒå°±å’Œä¸»æœºæœ¬èº«è¿›ç¨‹éš”ç¦»çš„ä¸€æ ·ï¼Œ è€Œå…¶å®žåªæ˜¯å®ƒçœ‹ä¸åˆ°åˆ«äººç½¢äº†ã€‚è¿™å°±æ˜¯Namespaceçš„ä½œç”¨ã€‚ åŒæ ·çš„ CLONE_NEWCGROUPã€CLONE_NEWIPCã€CLONE_NEWNETã€CLONE_NEWNSã€CLONE_NEWPIDã€CLONE_NEWUSER å’Œ CLONE_NEWUTSï¼Œé€šè¿‡è¿™äº›é€‰é¡¹æˆ‘ä»¬å°±èƒ½åˆ›å»ºå‡ºä¸€äº›éš”ç¦»äºŽå®¿ä¸»æœºçš„ç½‘ç»œï¼ŒæŒ‚è½½ç‚¹ç­‰ç­‰ï¼Œä»Žè€Œå®žçŽ°äº†çŽ¯å¢ƒä¸Šçš„é™åˆ¶ã€‚ CGroupså½“æˆ‘ä»¬åˆ©ç”¨Namespaceæžäº†ä¸€ä¸ªç›¸å¯¹éš”ç¦»çš„çŽ¯å¢ƒï¼Œä½†æ˜¯æœ‰äº›ä¸œè¥¿Namespaceæ²¡æœ‰åŠžæ³•æžï¼Œæ¯”å¦‚CPUå’Œå†…å­˜ã€‚ æˆ‘ä»¬çŸ¥é“å¦‚æžœä½¿ç”¨vmç­‰ä¸€äº›è™šæ‹ŸåŒ–è½¯ä»¶è¿›è¡Œè™šæ‹Ÿæœºçš„åˆ›å»ºä½ æ˜¯å¯ä»¥ç»™è™šæ‹Ÿæœºè®¾å®šcpuä½¿ç”¨çš„æ ¸å¿ƒæ•°è¿˜æœ‰å†…å­˜çš„ä½¿ç”¨é‡ï¼Œæ¥ä¿è¯è™šæ‹Ÿæœºä¸ä¼šè¶…è¿‡ä½¿ç”¨çš„é‡è€Œå¯¼è‡´åˆ«çš„è™šæ‹Ÿæœºæ— æ³•ä½¿ç”¨ã€‚ è€Œåœ¨dockerå®¹å™¨ä¸­å¥½åƒæˆ‘ä»¬çœ‹ä¼¼æ²¡æœ‰ä»€ä¹ˆé™åˆ¶æ¡ä»¶æ¥çº¦æŸä¸€ä¸ªå®¹å™¨çš„cpuå’Œå†…å­˜ï¼Œå¦‚æžœæ²¡æœ‰çº¦æŸé‚£ä¹ˆå¾ˆå®¹æ˜“å‡ºçŽ°çš„é—®é¢˜å°±æ˜¯ï¼Œä¸€ä¸ªå®¹å™¨çš„è¿è¡ŒåƒæŽ‰äº†å…¨éƒ¨çš„cpuèµ„æºæˆ–è€…æ˜¯ä¸€ä¸ªå®¹æ˜“çš„å†…å­˜æ³„æ¼å¯¼è‡´åƒæŽ‰äº†æ•´ä¸ªæœåŠ¡å™¨çš„å†…å­˜èµ„æºï¼Œè¿™æ˜¯æˆ‘ä»¬ä¸å¸Œæœ›çœ‹åˆ°çš„ã€‚ äºŽæ˜¯CGroupsæŠ€æœ¯å°±æ˜¯å¹²è¿™ä¸ªäº‹æƒ…çš„ã€‚CGroupså…¶å®žå«åšLinux Control Groupï¼Œå°±æ˜¯ç”¨æ¥é™åˆ¶ä¸€ä¸ªè¿›ç¨‹çš„ä½¿ç”¨ä¸ªèµ„æºä¸Šé™çš„ï¼ŒåŒ…æ‹¬ CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œå¸¦å®½ç­‰ç­‰ã€‚ æˆ‘ä»¬å¯ä»¥è¿›å…¥/sys/fs/cgroupè¿™ä¸ªç›®å½•ä¸‹å°±èƒ½çœ‹åˆ°CGroupsæ‰€æœ‰çš„é™åˆ¶éƒ½åœ¨é‡Œé¢äº†ã€‚ æ¯ä¸€ä¸ª CGroup ä¸‹é¢éƒ½æœ‰ä¸€ä¸ª tasks æ–‡ä»¶ï¼Œå…¶ä¸­å­˜å‚¨ç€å±žäºŽå½“å‰æŽ§åˆ¶ç»„çš„æ‰€æœ‰è¿›ç¨‹çš„ pidï¼Œä½œä¸ºè´Ÿè´£ cpu çš„å­ç³»ç»Ÿï¼Œcpu.cfs_quota_us æ–‡ä»¶ä¸­çš„å†…å®¹èƒ½å¤Ÿå¯¹ CPU çš„ä½¿ç”¨ä½œå‡ºé™åˆ¶ï¼Œå¦‚æžœå½“å‰æ–‡ä»¶çš„å†…å®¹ä¸º 50000ï¼Œé‚£ä¹ˆå½“å‰æŽ§åˆ¶ç»„ä¸­çš„å…¨éƒ¨è¿›ç¨‹çš„ CPU å ç”¨çŽ‡ä¸èƒ½è¶…è¿‡ 50%ã€‚ è¿™é‡Œå¯¹äºŽCGroupså°±ä¸ç»†è¯´äº†ï¼Œåªè¦çŸ¥é“å®ƒèƒ½å¸®åŠ©æˆ‘ä»¬é™åˆ¶è¿™äº›å°±è¶³å¤Ÿäº†ã€‚ chrootåœ¨namespaceå’Œcgroupçš„éš”ç¦»ä¹‹åŽï¼Œdockerè¿˜æœ‰ä¸€ä¸ªæ­¥éª¤éœ€è¦åšçš„æ˜¯ï¼Œå¦‚ä½•åŽ»éš”ç¦»æ–‡ä»¶ç³»ç»Ÿã€‚ å› ä¸ºå³ä½¿å¼€å¯äº†Mount Namespace ä½†æ˜¯å®¹å™¨è¿›ç¨‹ä¹Ÿèƒ½çœ‹åˆ°å®¿ä¸»æœºçš„æ–‡ä»¶ç³»ç»Ÿï¼Œå› ä¸ºMount Namespaceä¿®æ”¹çš„æ˜¯å®¹å™¨è¿›ç¨‹å¯¹æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹çš„è®¤çŸ¥ï¼Œä½†æ˜¯å¦‚æžœæ²¡æœ‰æ‰§è¡Œmountå‘½ä»¤ï¼Œé‚£ä¹ˆå½“å‰è¿˜æ˜¯ä½¿ç”¨çš„å®¿ä¸»æœºçš„æ–‡ä»¶ç³»ç»Ÿï¼Œä½†è¿™è‚¯å®šä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚ è€Œåœ¨linuxä¸‹æœ‰ä¸€ä¸ªå‘½ä»¤å¾ˆå¥½çš„è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯chrootã€‚è¿™ä¸ªå‘½ä»¤æ˜¯ change root directory çš„ç¼©å†™ï¼Œæ„æ€å°±æ˜¯åˆ‡æ¢å½“å‰ç³»ç»Ÿçš„rootç›®å½•ã€‚æˆ‘ä»¬çŸ¥é“åœ¨linuxç³»ç»Ÿä¸­æ ¹è·¯å¾„å°±æ˜¯â€œ/â€ï¼Œä½¿ç”¨è¿™ä¸ªå‘½ä»¤å°±å¯ä»¥åˆ‡æ¢æˆ‘ä»¬çš„æ ¹è·¯å¾„å˜æˆåˆ«çš„è·¯å¾„ã€‚ dockerå°±æ˜¯ä½¿ç”¨chrootæ¥å®žçŽ°è¯´è®©dockerå®¹å™¨æ‰€æœ‰åœ¨çš„ç›®å½•çš„æ ¹ç›®å½•è¿›è¡Œä¿®æ”¹ï¼Œä»Žè€Œåœ¨å®¹å™¨è§’åº¦çœ‹æ¥æ˜¯çœ‹ä¸åˆ°å®¿ä¸»æœºçš„ç›®å½•ï¼Œå› ä¸ºå®ƒä¼šè®¤ä¸ºè‡ªå·±è¿™é‡Œå°±æ˜¯æ ¹ç›®å½•äº†ã€‚ å¯¹äºŽchrootè¯¦ç»†çš„ä»‹ç»è¿™é‡Œå°±ä¸å±•å¼€äº†ï¼Œæ„Ÿå…´è¶£å¯ä»¥æŸ¥çœ‹ï¼šhttps://www.ibm.com/developerworks/cn/linux/l-cn-chroot/index.html é•œåƒä»Žä¸Šé¢æˆ‘ä»¬å·²ç»å¯ä»¥çŸ¥é“ï¼Œdockeré€šè¿‡ namespaceã€cgroupã€chroot æŠ€æœ¯å¸®æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ‹¥æœ‰é™åˆ¶æ¡ä»¶å’Œéš”ç¦»çŽ¯å¢ƒçš„è¿›ç¨‹ï¼Œä»Žè€Œå®žçŽ°äº†ä¸€ä¸ªå®¹å™¨ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„æŠ€æœ¯åœ¨dockerä¸­ä¹Ÿæ˜¯è‡³å…³é‡è¦çš„ï¼Œé‚£å°±æ˜¯é•œåƒã€‚åœ¨ä½¿ç”¨dockerçš„æ—¶å€™ï¼Œæœ€æ–¹ä¾¿çš„èŽ«è¿‡äºŽä½ å¯ä»¥é€šè¿‡docker buildå‘½ä»¤è¿›è¡Œé•œåƒçš„åˆ¶ä½œï¼Œç„¶åŽå°†é•œåƒæŽ¨é€åˆ°è¿œç«¯çš„ä»“åº“ä¸­åŽ»ï¼Œä»»ä½•æœºå™¨åªéœ€è¦è¿žæŽ¥ä»“åº“æ‹‰å–é•œåƒå°±å¯ä»¥æž„å»ºå‡ºä¸€æ¨¡ä¸€æ ·çš„å®¹å™¨ï¼Œé‚£ä¹ˆé•œåƒé‡Œé¢ç©¶ç«Ÿæ”¾äº†ä»€ä¹ˆä¸œè¥¿å‘¢ï¼Ÿ é•œåƒçš„æœ¬è´¨å…¶å®ž docker é•œåƒæœ¬èº«å°±æ˜¯ä¸€ä¸ªåŽ‹ç¼©åŒ…ï¼Œå®ƒå°†æˆ‘ä»¬åˆ¶ä½œå¥½çš„æ–‡ä»¶ç³»ç»Ÿæ‰“åŒ…å¥½äº†ã€‚æˆ‘ä»¬å¯ä»¥ç”¨ docker export å¯¹é•œåƒæ–‡ä»¶è¿›è¡Œå¯¼å‡ºã€‚æˆ‘ä»¬ä¼šå‘çŽ°å…¶å®žé•œåƒä¸­çš„ç›®å½•ç»“æž„å’Œlinuxä¸€æ ·ï¼Œå…¶å®žå°±æ˜¯ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿã€‚ é•œåƒåˆ†å±‚æŠ€æœ¯ä½†æ˜¯å¦‚æžœä»…ä»…æ˜¯åšä¸€ä¸ªç®€å•çš„æ–‡ä»¶æ‰“åŒ…çš„å·¥ä½œï¼Œé‚£ä¹ˆä½ å°±å¤ªå°çœ‹dockeré•œåƒæœ¬èº«äº†ã€‚ é‚£è¯´åˆ°å®žçŽ°ï¼Œé¦–å…ˆè¦è¯´è¯´ UnionFSï¼ˆUnion File Systemï¼‰å®ƒçš„åŠŸèƒ½éžå¸¸ç®€å•ï¼Œå°±æ˜¯å°†å¤šä¸ªä¸åŒä½ç½®çš„ç›®å½•è”åˆæŒ‚è½½åˆ°åŒä¸€ä¸ªç›®å½•ä¸‹ï¼Œå¹¶ä¸”å¦‚æžœç›®å½•ä¸‹å…·æœ‰ç›¸åŒçš„æ–‡ä»¶ä¼šè¢«åˆå¹¶ã€‚å°±æ˜¯è¿™ä¸ªåŠŸèƒ½è®©dockerå®žçŽ°äº†é•œåƒè¿™ä¸ªä¸œè¥¿ã€‚ å½“å‰æˆ‘ä»¬åœ¨åˆ¶ä½œé•œåƒçš„æ—¶å€™ï¼Œåœ¨ docker-file ä¸­æ¯ä¸€æ¡ docker æŒ‡ä»¤éƒ½ä¼šæž„å»ºä¸€ä¸ª layï¼Œæ¯ä¸ª lay å…¶å®žéƒ½æ˜¯å¯¹å·²æœ‰çš„æ–‡ä»¶ç³»ç»Ÿåšä¸€ä¸ªæ“ä½œï¼Œæœ€ç»ˆdockerä¼šæŠŠæ‰€æœ‰çš„ lay é€šè¿‡ UnionFS æŒ‚è½½åˆ°åŒä¸€ä¸ªç›®å½•ä¸‹é¢ï¼Œä»Žè€Œå°±å®žçŽ°äº†é•œåƒåˆ†å±‚åŽæœ€ç»ˆè¿˜æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“å‰æˆ‘ä»¬åœ¨ä½¿ç”¨é•œåƒçš„æ—¶å€™ï¼Œæˆ‘ä»¬åœ¨ run ä¸€ä¸ª docker ä¹‹åŽé‡Œé¢çš„ä¸€äº›åº”ç”¨å¾€å¾€ä¼šå¯¹æ–°åˆ›å»ºçš„æ–‡ä»¶ç³»ç»Ÿåšå‡ºä¿®æ”¹ï¼Œå¦‚ï¼šåˆ›å»ºæ—¥å¿—æ–‡ä»¶ã€‚ä½†æ˜¯å½“æˆ‘ä»¬åˆ é™¤è¿™ä¸ªå®¹å™¨çš„æ—¶å€™ä¼šå‘çŽ°ï¼Œå…¶å®žè¿™ä¸ªäº›åˆ›å»ºçš„æ–‡ä»¶æ˜¯ä¸ä¼šè¢«å†™å…¥åˆ°é•œåƒä¸­åŽ»çš„ã€‚è¿™æ˜¯å› ä¸ºï¼Œdockerä¸­çš„å±‚æ˜¯ä¸ä¸€æ ·çš„ï¼Œæœ‰åªè¯»å±‚ï¼Œå¯è¯»å†™å±‚ï¼Œinitå±‚ã€‚å½“é•œåƒè¢« docker run å‘½ä»¤åˆ›å»ºæ—¶å°±ä¼šåœ¨é•œåƒçš„æœ€ä¸Šå±‚æ·»åŠ ä¸€ä¸ªå¯è¯»å†™å±‚ï¼Œä¹Ÿå°±æ˜¯å®¹å™¨å±‚ï¼Œæ‰€æœ‰å¯¹äºŽè¿è¡Œæ—¶å®¹å™¨çš„ä¿®æ”¹å…¶å®žéƒ½æ˜¯å¯¹è¿™ä¸ªå®¹å™¨è¯»å†™å±‚çš„ä¿®æ”¹ã€‚å®¹å™¨å’Œé•œåƒçš„åŒºåˆ«å°±åœ¨äºŽï¼Œæ‰€æœ‰çš„é•œåƒéƒ½æ˜¯åªè¯»å±‚çš„ï¼Œè€Œæ¯ä¸€ä¸ªå®¹å™¨å…¶å®žç­‰äºŽé•œåƒåŠ ä¸Šä¸€ä¸ªå¯è¯»å†™çš„å±‚ã€‚è¿™æ˜¯æˆ‘é€šè¿‡ dive å·¥å…·æŸ¥çœ‹javaè¿™ä¸ªdockeré•œåƒæ‰€ç¤ºçš„ä¸œè¥¿ï¼Œå¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°å®ƒçš„åˆ†å±‚æƒ…å†µï¼Œæ˜¯é€šè¿‡ä¸€å±‚å±‚å åŠ è€Œæ¥ï¼Œè€Œå³è¾¹å°±æ˜¯å®ƒçš„æ–‡ä»¶ç³»ç»Ÿé‡Œé¢çš„æ ·å­äº†ã€‚ æ€»ç»“Docker ä½¿ç”¨namespaceã€cgroupsã€chrootç”»äº†ä¸€ä¸ªåœˆï¼Œåœˆå‡ºäº†ä¸€ä¸ªè¿‘ä¹Žç‹¬ç«‹çš„çŽ¯å¢ƒï¼Œè€Œå…¶æœ¬è´¨è¿˜æ˜¯ä¸€ä¸ªè¿›ç¨‹ã€‚ä½¿ç”¨UnionFSæ¥å®žçŽ°äº†é•œåƒåˆ†å±‚çš„æ•´åˆï¼Œä»Žè€Œè®©dockeré•œåƒå®žçŽ°äº†åˆ†å±‚æž„å»ºã€‚æ€»çš„æ¥è¯´ï¼Œå…¶å®ždockerçœ‹èµ·æ¥éžå¸¸åŽ‰å®³ï¼Œå¯åŠ¨ä¸€ä¸ªå®¹å™¨é£žå¿«æ¯”ä¼ ç»Ÿçš„è™šæ‹Ÿæœºå¥½ç”¨äº†å¤ªå¤šï¼Œåœ¨ä¸çŸ¥é“å®žçŽ°åŽŸç†çš„æƒ…å†µä¸‹ï¼Œæ„Ÿè§‰å¾ˆç¥žå¥‡ã€‚ä½†æ˜¯äº†è§£ä¹‹åŽä½ ä¼šå‘çŽ°ï¼Œå…¶å®ždockerè¿ç”¨çš„æŠ€æœ¯å¹¶ä¸å¤æ‚ï¼Œå®ƒåªæ˜¯å°†ä¸€äº›å·²æœ‰çš„æŠ€æœ¯åšäº†ä¸€ä¸ªæ•´åˆï¼Œè¿™äº›æŠ€æœ¯ä¹Ÿå¹¶éždockeråŽ»åˆ›é€ çš„ï¼Œnamespaceã€cgroupséƒ½æ˜¯linuxæä¾›çš„åŠŸèƒ½ç½¢äº†ã€‚ä½†æ˜¯åœ¨dockerå‡ºçŽ°ä»¥å‰ï¼Œè°èƒ½æƒ³åˆ°è¿™äº›ä¸œè¥¿ç»„åˆåœ¨ä¸€èµ·å°±èƒ½ç¢°æ’žå‡ºä¸ä¸€æ ·çš„ç«èŠ±å‘¢ï¼Ÿ]]></content>
      <categories>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å†çœ‹golangåžƒåœ¾å›žæ”¶]]></title>
    <url>%2F2019%2F12%2F12%2Fgolang%2Fbasic%2Fgc-easy-dis%2F</url>
    <content type="text"><![CDATA[é¦–å…ˆè¦è¯´ä¸€äº›åºŸè¯ï¼šä¹‹å‰æˆ‘å·²ç»æœ‰åšå®¢å†™è¿‡golangçš„åžƒåœ¾å›žæ”¶ç›¸å…³çš„å†…å®¹ï¼Œè™½ç„¶å¾ˆç®€ç•¥ï¼Œä½†æ˜¯æ¶µç›–äº†æ•´ä½“çš„æµç¨‹ï¼ŒçŽ°åœ¨ä¸ºå•¥åˆæ¥å†™ä¸€éå‘¢ï¼Ÿä¸€æ–¹é¢æœ‰ä¸€äº›æ”¿æ²»ï¼ˆä½ æ‡‚å¾—ï¼‰å› ç´ åœ¨é‡Œé¢ï¼Œä¸€æ–¹é¢æœ€è¿‘åˆå†ç ”ç©¶ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œé‚£ä¹ˆå¤šåšå®¢å·²ç»å†™è¿‡äº†å®ƒï¼Œæˆ‘æ€Žä¹ˆæŠŠå®ƒè®²å‡ºèŠ±æ¥å‘¢ï¼Ÿæˆ‘æ€å‰æƒ³åŽï¼ŒäºŽæ˜¯æƒ³å‡ºäº†å‡ ä¸ªç‹¬ç‰¹çš„è§’åº¦æ¥é‡æ–°è¯ é‡Šä¸€ä¸‹golangçš„åžƒåœ¾å›žæ”¶ã€‚ é‚£é¦–å…ˆå¦‚æžœå†æŠŠæ•´ä¸ªgcè¿‡ç¨‹ç®€å•è¯´ä¸€éï¼Œå¯èƒ½å°±æ²¡æœ‰äººæ„¿æ„å¬äº†ï¼Œä½†æ˜¯golangçš„gcè¯´ç®€å•ä¹Ÿç®€å•è¯´å¤æ‚å…¶å®žä¹Ÿæœ‰å¾ˆå¤šç»†èŠ‚ï¼Œå¦‚ä½•åšåˆ°æœ‰è‡ªå·±çš„æƒ³æ³•å‘¢ï¼ŸäºŽæ˜¯æˆ‘å°±å¼ºè¡Œä¸¾ä¾‹äº†å‡ ä¸ªé—®é¢˜ã€‚ é—®é¢˜&amp;è§’åº¦åœ¨ç ”ç©¶golangåžƒåœ¾å›žæ”¶çš„æ—¶å€™ï¼Œä½ æœ‰æ²¡æœ‰æƒ³è¿‡ä¸‹é¢å‡ ä¸ªé—®é¢˜ golangå¦‚æžœæœ‰ä¸¤ä¸ªå¯¹è±¡å¾ªçŽ¯äº’ç›¸å¼•ç”¨ï¼Œæ˜¯å¦ä¼šå‡ºçŽ°æ°¸è¿œå›žæ”¶ä¸äº†çš„å¯¹è±¡? golangçš„gcæ ‡è®°æ–¹å¼ä¸ºä»€ä¹ˆç”¨bfsè€Œä¸æ˜¯dfs? æ˜¯å¦æœ‰å¯èƒ½æ°¸è¿œä¸è§¦å‘gcï¼Ÿ ä¸ºä»€ä¹ˆgolangçš„gcä¸æ•´ç†ã€ä¸åˆ†ä»£ï¼Ÿ ä¸ªäººç†è§£é¦–å…ˆè¯´æ˜Žä¸€ä¸‹ï¼Œè¿™äº›é—®é¢˜éƒ½æ˜¯æˆ‘è‡ªå·±æƒ³çš„ï¼Œä¹Ÿæ²¡æœ‰ä»€ä¹ˆæ‰€è°“çš„æ­£ç¡®ç­”æ¡ˆï¼Œæ‰€ä»¥ä¸‹é¢ä¹Ÿæ˜¯æˆ‘çš„ä¸ªäººç†è§£ï¼Œå¦‚æžœæœ‰é—®é¢˜å¯ä»¥åœ¨ä¸‹æ–¹ç•™è¨€è¿›è¡Œè®¨è®ºã€‚ é—®é¢˜1 golangå¦‚æžœæœ‰ä¸¤ä¸ªå¯¹è±¡å¾ªçŽ¯äº’ç›¸å¼•ç”¨ï¼Œæ˜¯å¦ä¼šå‡ºçŽ°æ°¸è¿œå›žæ”¶ä¸äº†çš„å¯¹è±¡? ä¸ºä»€ä¹ˆä¼šæƒ³åˆ°æœ‰è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿå› ä¸ºæœ‰äººæ›¾ç»é—®è¿‡ï¼Œä¸ºä»€ä¹ˆgolangé‡Œé¢ä¸èƒ½æœ‰åŒ…çš„å¾ªçŽ¯å¼•ç”¨ï¼Ÿå…¶å®žè¿™ä¸¤ä¸ªé—®é¢˜å¹¶æ²¡æœ‰ç›¸å…³æ€§ã€‚ã€‚ã€‚åŒ…çš„å¾ªçŽ¯å¼•ç”¨å’Œå¯¹è±¡çš„å¾ªçŽ¯å¼•ç”¨æ˜¯ä¸ä¸€æ ·çš„ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ä¸‹é¢çš„ä»£ç ã€‚ 123456789101112131415161718192021222324package maintype User struct &#123; Name string Info *UserInfo&#125;type UserInfo struct &#123; Age int U *User&#125;func main() &#123; go func() &#123; user := &amp;User&#123; Name: "LinkinStar", &#125; userInfo := &amp;UserInfo&#123; Age: 24, &#125; user.Info = userInfo userInfo.U = user &#125;()&#125; é¦–å…ˆè¿™æ ·çš„ä»£ç è‚¯å®šæ˜¯å¯ä»¥ç¼–è¯‘é€šè¿‡çš„ï¼Œè€Œä¸”æ˜Žæ˜¾ä¸¤ä¸ªå¯¹è±¡å°±æœ‰äº’ç›¸å¼•ç”¨ï¼Œä½†æ˜¯è¿™æ ·ä¼šå¯¼è‡´gcæ— æ³•å›žæ”¶è¿™ä¸¤ä¸ªå¯¹è±¡å—ï¼Ÿ æ˜Žæ˜¾ä¸å¯èƒ½ã€‚ã€‚ã€‚ å› ä¸ºgolangçš„gcä¸æ˜¯ä½¿ç”¨å¼•ç”¨è®¡æ•°æ¥å®Œæˆçš„æ ‡è®°ï¼Œå¹¶ä¸æ˜¯é€šè¿‡è®¡ç®—ä¸€ä¸ªå¯¹è±¡çš„å¼•ç”¨æ•°æ¥è®¡ç®—ä¸€ä¸ªå¯¹è±¡æ˜¯å¦ä¼šè¢«å›žæ”¶ï¼Œè€Œæ˜¯ä»Žrootå¼€å§‹æ¥è¿›è¡Œå¯»æ‰¾æ ‡è®°çš„ã€‚æˆ‘ä»¬çœ‹ä¸‹é¢è¿™ä¸ªå›¾å°±å¾ˆæ˜Žç¡®äº†ã€‚ å…¶ä¸­Aå’ŒDæ˜Žæ˜¾æ˜¯ç›¸äº’å¼•ç”¨çš„ï¼Œåªè¦Aä¸ç”¨äº†ï¼Œé‚£ä¹ˆä¸¤è€…å°±ä¼šè¢«å›žæ”¶ã€‚ é—®é¢˜2 golangçš„gcæ ‡è®°æ–¹å¼ä¸ºä»€ä¹ˆç”¨bfsè€Œä¸æ˜¯dfs? é¦–å…ˆbfsæ˜¯å¹¿åº¦ä¼˜å…ˆæœç´¢ï¼Œdfsæ˜¯æ·±åº¦ä¼˜å…ˆæœç´¢ï¼Œæˆ‘ä»¬çŸ¥é“æˆ‘ä»¬çš„ä¸‰è‰²æ ‡è®°æ˜¯ä¸€å±‚å±‚å¾€ä¸‹èµ°çš„ï¼Œé‚£ä¸ºä»€ä¹ˆä¼šè¿™æ ·è®¾è®¡å‘¢ï¼Ÿ è¿™ä¸ªé—®é¢˜æ²¡æœ‰æ˜Žç¡®çš„ç­”æ¡ˆï¼Œæˆ‘è¯´ä¸€ä¸‹æˆ‘ä¸ªäººçš„ç†è§£ã€‚ é’ˆå¯¹gcæ¥è¯´ï¼Œå…¶å®žå¯¹è±¡æ˜¯å¾ˆå¤šçš„ï¼Œè€Œå¯¹è±¡ç›´æŽ¥çš„å¼•ç”¨å±‚çº§å…¶å®žæ˜¯ä¸æ·±çš„ï¼Œè¯´ç™½äº†ï¼Œå¦‚æžœæŠŠæ•´ä¸ªå¯¹è±¡çš„å¼•ç”¨æ¯”ä½œä¸€é¢—æ ‘çš„è¯ï¼Œé‚£ä¹ˆæ ‘çš„é«˜åº¦æˆ–è€…è¯´æ·±åº¦æ˜¯ä¸ä¼šå¾ˆé«˜çš„ï¼Œè€Œrootä¼šå¾ˆå¤šã€‚ åŽæœŸå¼•ç”¨çš„å˜åŠ¨å¾€å¾€éƒ½å‘ç”Ÿåœ¨æœ€åº•å±‚ï¼Œå¦‚æžœä½¿ç”¨dfsé‚£ä¹ˆå¾ˆæœ‰å¯èƒ½å·²ç»è¢«æ ‡è®°è¿‡çš„å¯¹è±¡å‘ç”Ÿäº†å¼•ç”¨å˜åŠ¨ï¼Œå¯èƒ½ä¼šå½±å“éƒ¨åˆ†æ€§èƒ½ã€‚ dfséœ€è¦é€’å½’å®žçŽ°ï¼Œé‚£ä¹ˆå‡½æ•°çš„è°ƒç”¨å¿…ç„¶ä¼šæœ‰å…¥æ ˆå‡ºæ ˆï¼Œæ‰€ä»¥ä¸å¤ªåˆé€‚ã€‚ é—®é¢˜3 æ˜¯å¦æœ‰å¯èƒ½æ°¸è¿œä¸è§¦å‘gcï¼Ÿ æˆ‘ä»¬çŸ¥é“è§¦å‘gcçš„æ¡ä»¶æœ‰å‡ ä¸ªï¼š è¾¾åˆ°GCç™¾åˆ†æ¯”ä¸Šé™ è¾¾åˆ°ä¸€å®šçš„æ—¶é—´2åˆ†é’Ÿï¼ˆsysmonï¼‰ ä½¿ç”¨runtime.GC() é‚£ä¹ˆæ˜¯å¦æœ‰åŠžæ³•å®žçŽ°æ°¸è¿œä¸è§¦å‘gcå‘¢ï¼Ÿæœ‰çš„ï¼æ¥çœ‹çœ‹ä¸‹é¢è¿™ä¸ªä»£ç ï¼š 12345678910111213141516171819202122232425262728package mainimport ( "runtime" "time")func main() &#123; go func() &#123; i := 0 for i &lt; 10 &#123; i-- i++ &#125; &#125;() go func() &#123; array := make([]int, 1000) for &#123; array = make([]int, 1000) array = append(array, 1) time.Sleep(time.Millisecond * 10) &#125; &#125;() runtime.GC() time.Sleep(time.Second * 60)&#125; å¦‚æžœæˆ‘ä»¬ä½¿ç”¨GODEBUG=&quot;gctrace=1&quot;æ‰“å°å‡ºgcæ—¥å¿—ä¼šå‘çŽ°ï¼Œæ²¡æœ‰ä»»ä½•çš„è¾“å‡ºã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ1234567 go func() &#123; i := 0 for i &lt; 10 &#123; i-- i++ &#125;&#125;() åŽŸå› å°±åœ¨è¿™ä¸ªåœ°æ–¹ï¼Œå› ä¸ºgolangåœ¨æƒ³è¦gcçš„æ—¶å€™ï¼Œéœ€è¦ä¿è¯æ‰€æœ‰çš„åç¨‹èµ°åˆ°ä¸€ä¸ªå®‰å…¨ç‚¹ï¼Œæ‰€è°“çš„å®‰å…¨ç‚¹æ˜¯éœ€è¦ä½ æœ‰ä»»ä½•çš„å‡½æ•°è°ƒç”¨éƒ½å¯ä»¥ã€‚è€Œè¿™é‡Œæ˜¯æ²¡æœ‰ä»»ä½•å‡½æ•°è°ƒç”¨çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æ²¡æœ‰å®‰å…¨ç‚¹ã€‚æ‰€ä»¥golangæ²¡æœ‰åŠžæ³•è§¦å‘gcï¼Œå½“æˆ‘ä»¬åœ¨å…¶ä¸­åŠ å…¥ä»»æ„æ–¹æ³•ä¹‹åŽï¼Œå°±å¯ä»¥è§¦å‘gcäº†ã€‚ æ‰€ä»¥è¿™ä¹Ÿè®©æˆ‘ä»¬åœ¨å†™ç¨‹åºçš„æ—¶å€™è¦æ³¨æ„ï¼Œåƒä¸‡ä¸èƒ½æœ‰æ­»å¾ªçŽ¯ï¼Œå¹¶ä¸”å½“ä¸­æ²¡æœ‰ä»»ä½•å‡½æ•°è°ƒç”¨ï¼ˆè™½ç„¶åœ¨å®žé™…ä¸­å¾ˆå°‘å­˜åœ¨ï¼‰ é—®é¢˜4 ä¸ºä»€ä¹ˆgolangçš„gcä¸æ•´ç†ã€ä¸åˆ†ä»£ï¼Ÿ ä¸‹é¢æ˜¯æ¥è‡ªæºç ä¸­çš„ä¸€æ®µï¼š The GC runs concurrently with mutator threads, is type accurate (aka precise), allows multiple GC thread to run in parallel. It is a concurrent mark and sweep that uses a write barrier. It is non-generational and non-compacting. Allocation is done using size segregated per P allocation areas to minimize fragmentation while eliminating locks in the common case. å…¶ä¸­æ˜Žç¡®è¯´æ˜Žäº†æ˜¯éžåˆ†ä»£å’Œéžæ•´åˆçš„ç®—æ³•ã€‚ å¯¹äºŽè¿™ä¸ªé—®é¢˜ï¼Œé¦–å…ˆæˆ‘ä¸å¾—ä¸è¯´çš„æ˜¯ï¼Œåˆ†ä»£ç¡®å®žèƒ½å¾ˆå¥½çš„æé«˜gcçš„æ•ˆçŽ‡ï¼Œå› ä¸ºå¤§å¤šæ•°å¯¹è±¡ä½¿ç”¨çš„æ—¶é—´æ˜¯å¾ˆçŸ­çš„ï¼Œè€Œé•¿æ—¶é—´å ç”¨çš„å¯¹è±¡æ˜¯å¾ˆå°‘çš„ï¼Œè¿™ä¹Ÿæ˜¯javaä¸­åˆ†ä»£çš„åŽŸå› ã€‚è€Œå¯¹äºŽæ•´ç†ï¼Œæ•´ç†çš„è¯æœ‰åˆ©äºŽå†…å­˜çš„ç®¡ç†å’Œå›žæ”¶ï¼Œå½“å¯¹è±¡è¢«å›žæ”¶ä¹‹åŽï¼Œä¼šå‡ºçŽ°å¾ˆå¤šçš„å†…å­˜ç¢Žç‰‡ï¼Œè€Œæ•´ç†å¯ä»¥å¾ˆå¥½çš„é‡æ–°è§„èŒƒå†…å­˜ï¼Œå›žæ”¶é‚£äº›ä¸éœ€è¦çš„é¡µã€‚ é‚£ä¹ˆgolangä¸ºå•¥ä¸åšå‘¢ï¼Ÿé¦–å…ˆæ˜¯å¤æ‚ï¼Œæˆ‘ä»¬çœ‹javaåˆ†ä»£å›žæ”¶çš„å®žçŽ°å°±éžå¸¸çš„å¤æ‚ï¼Œå®žçŽ°èµ·æ¥éœ€è¦å¾ˆå¤§çš„åŠ›æ°”ï¼Œè€Œå½“å‰çš„golangçš„gcæ•ˆçŽ‡å·²ç»å¯èƒ½å·²ç»æ»¡è¶³éœ€æ±‚äº†ã€‚ç„¶æ˜¯å°±æ˜¯æ•´ç†ï¼Œå…¶å®žæ•´ç†è¿™å—æ˜¯ç”±å†…å­˜ç®¡ç†æ¨¡å—æ¥ç®¡ç†çš„ï¼Œè€Œgolangä¸­çš„å†…å­˜ç®¡ç†åœ¨åˆ†é…çš„é˜¶æ®µå·²ç»åˆ©ç”¨äº†æœ€å°åŒ–çš„åŽŸåˆ™ï¼Œæ¯æ¬¡ç»™åˆ°çš„éƒ½æ˜¯åˆé€‚çš„å¤§å°ï¼Œæ‰€ä»¥æ•´ç†è¿™å—å°±äº¤ç”±ä»–ä»¬è¿›è¡Œæ¥ç®¡äº†ï¼Œgcè¿™å—åªè´Ÿè´£å›žæ”¶å°±å¯ä»¥äº†ã€‚ æœ€åŽæ¥ä¸ªtoolæœ€åŽè¡¥å……ä¸€ä¸ªtoolä¹‹å‰åšå®¢ä¸­åªæ˜¯è¯´ç”¨gctraceæ¥è¾“å‡ºgcæ—¥å¿—ï¼Œè€Œæ²¡æœ‰å¯è§†åŒ–çš„å±•ç¤ºï¼Œè€Œå…¶å®žæœ‰è¿™æ ·çš„å·¥å…·å¯ä»¥æ»¡è¶³è¿™æ ·çš„è¦æ±‚ã€‚ 1234567891011121314151617181920package mainimport ( "os" "runtime/trace")func main() &#123; f, err := os.Create("trace.out") if err != nil &#123; panic(err) &#125; defer f.Close() err = trace.Start(f) if err != nil &#123; panic(err) &#125; defer trace.Stop() // Your program here&#125; åœ¨ä½ çš„é¡¹ç›®ä¸­æ·»åŠ å¦‚ä¸‹çš„ä»£ç ï¼Œç„¶åŽåœ¨è¿è¡Œä¸€æ®µæ—¶é—´ä¹‹åŽå°±å¯ä»¥é€šè¿‡go tool trace trace.outå‘½ä»¤æ¥åœ¨é¡µé¢ä¸ŠæŸ¥çœ‹æ•´ä¸ªé¡¹ç›®gcçš„æƒ…å†µäº†ã€‚]]></content>
      <categories>
        <category>golangåŸºç¡€</category>
      </categories>
      <tags>
        <tag>gc</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å¿«é€Ÿä¸Šæ‰‹kubernetesâ€”â€”minikubeæœ€å°å®žçŽ°]]></title>
    <url>%2F2019%2F11%2F23%2Fgolang%2Fopen-source-component%2Fk8s-minikube-started%2F</url>
    <content type="text"><![CDATA[æœ€è¿‘åœ¨ç ”ç©¶k8sï¼Œå°±æ¥å†™ä¸€ä¸ªå…³äºŽk8så¿«é€Ÿä¸Šæ‰‹ï¼Œå¹¶è®°å½•é‡‡å‘çš„ç‚¹ã€‚éœ€è¦çš„å‰ç½®çŸ¥è¯†ç‚¹ï¼šdockerã€k8sçš„ä¸€äº›åŸºæœ¬æ¦‚å¿µï¼Œä¸‹é¢è¿™ä¸ªå¯èƒ½å¯¹ä½ æœ‰å¸®åŠ©ã€‚https://juejin.im/post/5d1b2a656fb9a07edc0b7058 ä»€ä¹ˆæ˜¯k8sæˆ‘ä»¬çŸ¥é“ï¼Œæˆ‘ä»¬å¯ä»¥å°†é¡¹ç›®åˆ¶ä½œæˆdockeré•œåƒï¼Œç„¶åŽåˆ©ç”¨dockeråŽ»éƒ¨ç½²æˆ‘ä»¬çš„é¡¹ç›®ï¼Œè¿™æ ·å¯ä»¥è§£å†³å¾ˆå¤šæœåŠ¡å™¨çŽ¯å¢ƒæ‰€å¸¦æ¥çš„é—®é¢˜ï¼›ä½†æ˜¯å®¹å™¨å¤šäº†ï¼Œå®¹å™¨ä¸Žå®¹å™¨ä¹‹é—´å°±éœ€è¦è®¿é—®ï¼Œä¹‹é—´å°±éœ€è¦ç½‘ç»œé…ç½®ç­‰ç­‰ï¼Œä»Žè€Œå°±æœ‰äº†docker-composeï¼›ä½†æ˜¯å½“æˆ‘ä»¬çš„æœåŠ¡è¿›è¡Œå‡çº§ï¼Œæˆ–è€…æœåŠ¡éœ€è¦è¿›è¡Œè°ƒåº¦ï¼Œæ‰©å®¹ç­‰ç­‰ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ä¸€ä¸ªå¤§ç®¡å®¶æ¥ç®¡æ‰€æœ‰çš„ä¸œè¥¿ï¼›è¿™ä¸ªå¤§ç®¡å®¶å°±æ˜¯ - Kubernetes åˆå­¦ä¼šé‡åˆ°çš„é—®é¢˜å› ä¸ºk8sçš„ä¸œè¥¿å¤ªå¤šäº†ï¼Œæ‰€ä»¥å­¦ä¹ æˆæœ¬çŽ°åœ¨è¶Šæ¥è¶Šé«˜ï¼Œå¥½åœ¨k8så·²ç»å¾ˆå¤šæ•™ç¨‹ã€‚æˆ‘è¯´ä¸€ä¸‹çŽ°åœ¨å­¦çš„æ—¶å€™è‚¯å®šä¼šé‡åˆ°çš„å¤§é—®é¢˜ï¼š å›½å†…çš„é—®é¢˜ï¼ˆå›½å†…çŽ¯å¢ƒå¾ˆå¤šé•œåƒæ‹‰ä¸åˆ°ï¼‰ æœ¬åœ°æ­å»ºçŽ¯å¢ƒï¼ˆåŽŸæ¥æ­å»ºk8séœ€è¦ä¸€äº›æœåŠ¡å™¨ï¼‰ ç”µè„‘çŽ¯å¢ƒçš„é—®é¢˜ï¼ˆwindowså’Œmacéƒ½æœ‰å‘ç‚¹ï¼‰ æœ€å°å®žçŽ°çŽ°åœ¨æˆ‘ä»¬å°±æ¥åœ¨æœ¬æœºå®žçŽ°ä¸€ä¸ªæœ€å°çš„k8sçš„å®žçŽ°ï¼Œç»™å‡ºä¸€ä¸ªhello-worldk8sæä¾›äº†minikubeï¼Œè¿™ä¸ªä¸œè¥¿å¯ä»¥è®©ä½ æœ¬æœºä¸€å°æœºå™¨å°±å¯ä»¥æ­å»ºèµ·è¿™ä¸ªçŽ¯å¢ƒã€‚æ‹¥æœ‰å’Œçº¿ä¸Šä¸€æ ·çš„å‘½ä»¤è¡Œæ“ä½œå’Œæ¨¡å¼ï¼Œä½†æ˜¯ä¸éœ€è¦ä½ å†åŽ»åˆ›å»ºå¾ˆå¤šè™šæ‹Ÿæœºæ¥æžäº‹æƒ…äº†ã€‚è¶…çº§æ–¹ä¾¿ä¹Ÿã€‚https://minikube.sigs.k8s.io/æˆ‘ä»¬å°±åˆ©ç”¨è¿™ä¸ªæ¥å®žçŽ°ï¼Œä¸‹é¢æ¥è¯´è¯´æ­¥éª¤ï¼šæˆ‘çš„æœ¬æœºçŽ¯å¢ƒï¼š macOS minikube version: v1.5.2 Docker version 18.03.1-ce å®‰è£…çŽ¯å¢ƒå¤§è‡´æ­¥éª¤ï¼šhttps://minikube.sigs.k8s.io/docs/start/macos/ brew install minikubebrew install docker-machine-driver-vmwareminikube start --vm-driver=vmware --image-repository=registry.cn-hangzhou.aliyuncs.com/google_containers æˆåŠŸä¹‹åŽï¼šminikube status æŸ¥çœ‹minikubeçš„çŠ¶æ€minikube ip æŸ¥çœ‹minikubeçš„ipminikube dashboard æ‰“å¼€dashboardå±•ç¤ºk8sçš„çŠ¶æ€ å®‰è£…å‘ç‚¹ HyperKitæœ€æ–°ç‰ˆæœ¬å¯èƒ½å­˜åœ¨é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä½¿ç”¨VMware Fusionå®žçŽ°è™šæ‹ŸåŒ–çš„ä¾èµ– å›½å†…k8s.gcr.ioçš„ç›¸å…³é•œåƒå›½å†…æ‹‰å–ä¸åˆ°ï¼Œä½¿ç”¨mirrorgooglecontainersä¹Ÿæ— æ³•æ‹‰å–åˆ°ï¼Œæ‰€ä»¥ä½¿ç”¨é˜¿é‡Œäº‘çš„ä»“åº“ https://github.com/kubernetes/minikube/issues/3860 å¦‚æžœä¹‹å‰å·²ç»ä½¿ç”¨è¿‡minikube startå‘½ä»¤ï¼Œå»ºè®®å…ˆminikube deleteï¼Œå¹¶åˆ é™¤rm -rf ~/.minikube/ï¼Œç„¶åŽé‡æ–°start è¿›è¡Œéƒ¨ç½²é¦–å…ˆæè¿°ä¸€ä¸‹éƒ¨ç½²è¦åšçš„äº‹æƒ…ï¼šlinkinstar/mini-go:v1.0 æ˜¯æˆ‘å·²ç»ä¸Šä¼ åˆ° docker-hub é‡Œé¢çš„ä¸€ä¸ªå·²ç»åšå¥½çš„æœ€ç®€å•çš„é¡¹ç›®ï¼Œä¼šæš´éœ²ä¸€ä¸ª8080ç«¯å£çš„webæœåŠ¡ï¼›æœ€ç»ˆçš„ç›®æ ‡ï¼Œåœ¨k8såˆ›å»ºä¸€ä¸ªpodï¼Œpodä¸­è¿è¡Œä¸€ä¸ªæˆ‘ä»¬çš„å®¹å™¨ï¼Œæœ€ç»ˆæˆ‘ä»¬åœ¨å¤–éƒ¨å¯ä»¥è®¿é—®åˆ°è¿™ä¸ªæœåŠ¡ é¦–å…ˆåˆ›å»ºä¸¤ä¸ªæ–‡ä»¶12345678910111213141516171819202122# deploy.yamlapiVersion: apps/v1kind: Deploymentmetadata: name: mini-go labels: app: mini-gospec: replicas: 1 selector: matchLabels: app: mini-go template: metadata: labels: app: mini-go spec: containers: - name: mini-go image: linkinstar/mini-go:v1.0 ports: - containerPort: 8080 1234567891011121314# service.yamlapiVersion: v1kind: Servicemetadata: name: mini-go-servicespec: selector: app: mini-go type: NodePort ports: - protocol: TCP port: 80 targetPort: 8080 nodePort: 30008 æ‰§è¡Œ kubectl create -f service.yaml kubectl create -f deploy.yaml æŸ¥çœ‹æ‰§è¡ŒæˆåŠŸå¯ä»¥å†dashboardä¸­æŸ¥çœ‹æ‰§è¡ŒçŠ¶æ€ æœ€ç»ˆè®¿é—®åœ°å€æŸ¥çœ‹åˆ°æœåŠ¡æ˜¯å¦æ­£å¸¸ï¼šhttp://192.168.231.146:30008/å…¶ä¸­çš„ipæ˜¯é€šè¿‡ minikube ip å‘½ä»¤æŸ¥çœ‹çš„ æœåŠ¡æ“ä½œæ°´å¹³ä¼¸ç¼©åœ¨çŽ°å®žçš„ä¸šåŠ¡çŽ¯å¢ƒä¸­ï¼Œå½“ç”¨æˆ·çš„è®¿é—®å¢žå¤šï¼Œæˆ‘ä»¬éœ€è¦æ‰©å±•æˆ‘ä»¬çš„åº”ç”¨ï¼Œä¹Ÿå°±æ˜¯æ°´å¹³çš„åŽ»å¤šéƒ¨ç½²å‡ ä¸ªå®¹å™¨ï¼Œæœ‰äº†k8sä¹‹åŽè¿™ä»¶äº‹å°±å˜å¾—éžå¸¸çš„å®¹æ˜“äº†ã€‚ ä¿®æ”¹ deploy.yaml æ–‡ä»¶ä¸­çš„ replicas: 2 æ”¹æˆ2ä¸ª ä½¿ç”¨å‘½ä»¤ï¼škubectl apply -f deploy.yaml ä½¿é…ç½®ç”Ÿæ•ˆ ç„¶åŽæˆ‘ä»¬å°±å¯ä»¥çœ‹åˆ°ï¼ŒåŽŸæ¥çš„ä¸€ä¸ªpodå˜æˆäº†ä¸¤ä¸ªï¼Œè€Œk8sä¼šå°†æˆ‘ä»¬çš„è¯·æ±‚è´Ÿè½½å‡è¡¡åˆ°æ¯ä¸ªpodä¸­ã€‚æ•´ä¸ªè¿‡ç¨‹å¯ä»¥è¯´æ˜¯éžå¸¸çš„ä¼˜é›…äº†ã€‚ åŒæ ·çš„ï¼Œå½“æˆ‘ä»¬éœ€è¦å‡å°‘æœåŠ¡çš„æ•°é‡æ—¶ä¹Ÿæ˜¯ç›¸åŒçš„é“ç† ç‰ˆæœ¬å‡çº§å¯¹äºŽåº”ç”¨çš„ç‰ˆæœ¬å‡çº§ä¹Ÿæ˜¯åŒæ ·çš„é“ç† ä¿®æ”¹ deploy.yaml æ–‡ä»¶ä¸­çš„ image: linkinstar/mini-go:v2.0 æ”¹æˆ2.0 ä½¿ç”¨å‘½ä»¤ï¼škubectl apply -f deploy.yaml ä½¿é…ç½®ç”Ÿæ•ˆ ç‰ˆæœ¬å›žé€€å½“æˆ‘ä»¬å‘çŽ°å‘å¸ƒçš„æœåŠ¡é—®é¢˜ï¼Œæƒ³è¦è¿›è¡Œç‰ˆæœ¬å›žé€€çš„æ—¶å€™ï¼Œå°±å¯ä»¥ä½¿ç”¨kubectl rollout undo deployments/mini-goè¿›è¡Œç‰ˆæœ¬å›žé€€ï¼Œä¸‹é¢æ˜¯ç‰ˆæœ¬å›žé€€è¿‡ç¨‹ä¸­ æ€»ç»“ ä½¿ç”¨minikubeå¯ä»¥å¿«é€Ÿè®©æ–°æ‰‹æ„Ÿå—åˆ°k8såˆ°åº•æ˜¯å¦‚ä½•ä½¿ç”¨çš„ çŽ¯å¢ƒé…ç½®è¿‡ç¨‹ä¸­ä¼šæœ‰å¾ˆå¤šé—®é¢˜ï¼Œéœ€è¦ä½ è€å¿ƒè§£å†³ k8såœ¨æœåŠ¡ç¼–æŽ’ä¸Šé¢é™¤äº†ä»¥ä¸Šæåˆ°çš„ç”¨æ³•ä»¥å¤–è¿˜æœ‰å¾ˆå¤šç‰›é€¼çš„åŠŸèƒ½ç­‰ç€ä½ åŽ»å‘çŽ° å­¦ä¹ è¿‡ç¨‹ä¸­éœ€è¦ä¿æŒä¸€ä¸ªåŽŸåˆ™ï¼Œå…ˆç”¨ç€çœ‹çœ‹ -&gt; æžæ¸…æ¥šæž¶æž„ -&gt; å°è¯•å„ç§åŠŸèƒ½ -&gt; å­¦ä¹ å„ä¸ªæ¨¡å—çš„å®žçŽ° -&gt; æœ€ç»ˆå®žè·µ]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å¿«é€Ÿä¸Šæ‰‹terraform â€”â€” é˜¿é‡Œäº‘OSSå’ŒECSçš„åˆ›å»º]]></title>
    <url>%2F2019%2F11%2F10%2Fgolang%2Fopen-source-component%2Fterraform-aliyun-oss-ecs-test%2F</url>
    <content type="text"><![CDATA[æœ€è¿‘åœ¨ç ”ç©¶terraformï¼Œé‡‡äº†ä¸€åœˆå‘ï¼Œè®°å½•ä¸€ä¸‹ã€‚ ä»€ä¹ˆæ˜¯terraformï¼Ÿterraform é€šè¿‡ä»£ç é…ç½®å®žçŽ°ç‰©ç†æœºç­‰ä¸€äº›èµ„æºçš„åˆ†é…ã€‚ç®€å•è¯´å°±æ˜¯ï¼Œå†™ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨ï¼Œå°±èƒ½å¸®ä½ è´­ä¹°ä¸€å°äº‘çš„æœºå™¨ï¼Œæˆ–è€…è¯´ç”³è¯·åˆ°ossçš„èµ„æºï¼Œæˆ–è€…æ˜¯åˆ«çš„ä»€ä¹ˆã€‚å…·ä½“åŠŸèƒ½è§å®˜ç½‘ã€‚ https://www.terraform.io/docs/index.html åè¯è§£é‡Šï¼šproviderä½ å¯ä»¥æŠŠå®ƒçœ‹åšå„ä¸ªåŽ‚å•†å¯¹terraformæä¾›çš„æ’ä»¶ï¼Œterraformå¯ä»¥è°ƒç”¨è¿™äº›æ’ä»¶ä»Žè€Œå®žçŽ°å¯¹èµ„æºçš„æ“ä½œç®¡ç†ã€‚terraformæµç¨‹ï¼šinit -&gt; plan -&gt; apply -&gt; destroyå¯¹åº”ä¸ºï¼šåˆå§‹åŒ–ï¼Œè®¡åˆ’éªŒè¯ï¼Œå®žé™…åº”ç”¨ï¼Œé”€æ¯ æœ€å°demoæˆ‘å°†ç”¨ä¸€ä¸ªæœ€å°çš„demoæ¥æ¼”ç¤ºå®ƒæ€Žä¹ˆå¹²æ´»çš„ï¼šé€šè¿‡terraformæ¥åˆ›å»ºä¸€ä¸ªé˜¿é‡Œäº‘çš„ossï¼ˆä»¥ä¸‹æ²¡æœ‰åˆ©ç›Šç›¸å…³ï¼‰åªæ˜¯å› ä¸ºé˜¿é‡Œäº‘æˆ‘æœ‰è´¦å·è€Œå·²ï¼Œå…¶ä»–ä¾›åº”å•†ä¹Ÿæœ‰ã€‚ æˆ‘çš„æœ¬åœ°çŽ¯å¢ƒï¼šmacOS æ­¥éª¤1 ä¸‹è½½ç›¸å…³èµ„æºä¸‹è½½å¯¹åº”çš„å®¢æˆ·ç«¯ï¼šhttps://www.terraform.io/downloads.htmlä¸‹è½½è§£åŽ‹åŽå¾—åˆ°ï¼šterraformçš„å®¢æˆ·ç«¯ï¼Œå°†å®ƒå¤åˆ¶åˆ° /usr/local/bin ç›®å½•ä¸‹12$ terraform -versionTerraform v0.12.13 éªŒè¯ä¸€ä¸‹ï¼Œè¾“å‡ºç‰ˆæœ¬æ­£å¸¸çš„è¯å°±å¥½äº† ä¸‹è½½é˜¿é‡Œäº‘å¯¹åº”providerï¼šhttps://releases.hashicorp.com/terraform-provider-alicloud/1.60.0/æˆ‘ä¸‹è½½çš„ç‰ˆæœ¬ä¸ºï¼šterraform-provider-alicloud_1.60.0_darwin_amd64.zip æ”¾ç½®åˆ°ä¸€ä¸ªä½ å–œæ¬¢çš„ç›®å½•ä¸‹ï¼Œæˆ‘è¿™è¾¹ä¸º/Users/LinkinStar/Documents/tf-plugin æ­¥éª¤2 ç”³è¯·é˜¿é‡Œäº‘ç›¸å…³èµ„æºåˆ›å»ºä½ çš„é˜¿é‡Œäº‘è´¦å·ï¼Œè¿™ä¸ªä¸å¤šè¯´äº†ã€‚ç„¶åŽéœ€è¦åˆ›å»ºä¸€ä¸ªramç”¨æˆ·https://ram.console.aliyun.com/ç”¨æˆ·ç®¡ç† -&gt; æ–°å»ºç”¨æˆ· -&gt; ä¿å­˜å¥½AccessKeyå’ŒSecret æ³¨æ„ï¼è¿™é‡Œè¿˜éœ€è¦å¯¹ç”¨æˆ·è¿›è¡ŒæŽˆæƒï¼Œç‚¹å‡»æŽˆæƒç»™åˆ°ç›¸å…³æƒé™å°±è¡Œï¼Œæˆ‘ç»™äº†å…¨éƒ¨ï¼Œæ–¹ä¾¿æµ‹è¯• æ­¥éª¤3 ç¼–å†™æ–‡ä»¶éšä¾¿åˆ›å»ºä¸€ä¸ªå·¥ä½œç›®å½•ï¼Œç„¶åŽåˆ›å»ºä¸€ä¸ªtfæ–‡ä»¶main.tf1234567891011# Configure the Alicloud Providerprovider &quot;alicloud&quot; &#123; access_key = &quot;LTAIaskjfhadsklfhklasdjfhdsakjlfhdask&quot; secret_key = &quot;6GPashfjksladfhdjskafhdsklajfdhaljfhajfl&quot; region = &quot;cn-beijing&quot;&#125;resource &quot;alicloud_oss_bucket&quot; &quot;bucket-acl&quot; &#123; bucket = &quot;bucket-123456654321-acl&quot; acl = &quot;private&quot;&#125; å…¶ä¸­ access_key å’Œ secret_key ä¸ºä½ åˆšæ‰ç”³è¯·ramçš„ä¿¡æ¯bucket çš„åç§°ä½ éšä¾¿å–ä¸€ä¸ª æ­¥éª¤4 è¿è¡Œå‘½ä»¤initä»¥ä¸‹å‘½ä»¤å‡åœ¨tfæ–‡ä»¶å½“å‰ç›®å½•ä¸‹è¿è¡Œ1terraform init -plugin-dir=/Users/LinkinStar/Documents/tf-plugin æ³¨æ„åŽé¢çš„ç›®å½•æ˜¯æˆ‘ä»¬åˆšæ‰ä¸‹è½½çš„providerçš„ç›®å½•å‡ºçŽ° Terraform has been successfully initialized! ä¸ºæˆåŠŸ planç„¶åŽä½¿ç”¨å‘½ä»¤ terraform plan å‡ºçŽ°ä»¥ä¸‹ä¿¡æ¯123456789101112131415 # alicloud_oss_bucket.bucket-acl will be created + resource &quot;alicloud_oss_bucket&quot; &quot;bucket-acl&quot; &#123; + acl = &quot;private&quot; + bucket = &quot;bucket-123456654321-acl&quot; + creation_date = (known after apply) + extranet_endpoint = (known after apply) + force_destroy = false + id = (known after apply) + intranet_endpoint = (known after apply) + location = (known after apply) + owner = (known after apply) + storage_class = &quot;Standard&quot; &#125;Plan: 1 to add, 0 to change, 0 to destroy. applyè¿è¡Œå‘½ä»¤ terraform apply è¿‡ç¨‹ä¸­éœ€è¦è¾“å‡ºyesç¡®è®¤å‡ºçŽ°ä»¥ä¸‹ä¿¡æ¯å°±è¯æ˜ŽæˆåŠŸäº†ï¼šApply complete! Resources: 1 added, 0 changed, 0 destroyed. ä½ å¯ä»¥åˆ°ï¼šhttps://oss.console.aliyun.com/overviewæŸ¥çœ‹OSSæ˜¯å¦å·²ç»è¢«åˆ›å»º destroyæœ€åŽè¿è¡Œå‘½ä»¤ terraform destroy è¿‡ç¨‹ä¸­éœ€è¦è¾“å‡ºyesç¡®è®¤åˆšæ‰åˆ›å»ºçš„OSSèµ„æºå°±ä¼šè¢«é”€æ¯ï¼Œä½ å¯ä»¥å†åœ¨ç½‘ä¸Šåˆ·æ–°ä¸€ä¸‹æŸ¥çœ‹ ä»¥ä¸Šå°±æ˜¯é€šè¿‡terraformè¿›è¡Œçš„èµ„æºæ“ä½œï¼ŒåŒæ ·çš„ï¼Œä½ å¯ä»¥ä¿®æ”¹tfæ–‡ä»¶è¿›è¡Œæ›´å¤šèµ„æºçš„æ“ä½œ å¯¹ECSè¿›è¡Œæ“ä½œ1234567891011121314151617181920212223242526272829303132333435# Configure the Alicloud Providerprovider &quot;alicloud&quot; &#123; access_key = &quot;LTAIaskjfhadsklfhklasdjfhdsakjlfhdask&quot; secret_key = &quot;6GPashfjksladfhdjskafhdsklajfdhaljfhajfl&quot; region = &quot;cn-hangzhou&quot;&#125;# Create a new ECS instance for a VPCresource &quot;alicloud_security_group&quot; &quot;group&quot; &#123; name = &quot;tf_test_foo&quot; description = &quot;foo&quot; vpc_id = &quot;$&#123;alicloud_vpc.vpc.id&#125;&quot;&#125;resource &quot;alicloud_vpc&quot; &quot;vpc&quot; &#123; name = &quot;tf_test_foo&quot; cidr_block = &quot;172.16.0.0/12&quot;&#125;resource &quot;alicloud_vswitch&quot; &quot;vswitch&quot; &#123; vpc_id = &quot;$&#123;alicloud_vpc.vpc.id&#125;&quot; cidr_block = &quot;172.16.0.0/21&quot; availability_zone = &quot;cn-hangzhou-i&quot;&#125; resource &quot;alicloud_instance&quot; &quot;instance&quot; &#123; availability_zone = &quot;cn-hangzhou-i&quot; security_groups = &quot;$&#123;alicloud_security_group.group.*.id&#125;&quot; instance_type = &quot;ecs.t6-c2m1.large&quot; system_disk_category = &quot;cloud_efficiency&quot; image_id = &quot;ubuntu_18_04_64_20G_alibase_20190624.vhd&quot; instance_name = &quot;test_foo&quot; vswitch_id = &quot;$&#123;alicloud_vswitch.vswitch.id&#125;&quot; internet_max_bandwidth_out = 0&#125; éœ€è¦æ³¨æ„çš„æ˜¯ä½ çš„è´¦æˆ·ä½™é¢å¿…é¡»&gt;100å—ï¼Œå¦åˆ™ä¼šæç¤ºä½™é¢ä¸è¶³ï¼Œæˆ‘è¿™è¾¹tfé‡Œé¢å†™çš„æ˜¯éžå¸¸ä¾¿å®œå‡ åˆ†é’±ä¸€ä¸ªå°æ—¶çš„æœºå™¨ï¼Œæ‰€ä»¥é—®é¢˜ä¸å¤§ï¼Œä½ è¦æ˜¯å®³æ€•ä½ å¯ä»¥ä¸æµ‹ï¼ˆå†è¯´ä¸€éæœ¬æ–‡æ²¡æœ‰åˆ©ç›Šç›¸å…³ï¼‰ ç›¸å…³èµ„æºæ€»ç»“providerä¸‹è½½åœ°å€ï¼šhttps://releases.hashicorp.com/providerç›¸å…³æ–‡æ¡£ï¼šhttps://www.terraform.io/docs/providers/index.html å‘ç‚¹ å›½å†…çš„å¢™å¯¼è‡´ç›´æŽ¥æ‰§è¡Œinitæ˜¯ä¸å¯ä»¥çš„ï¼Œå®ƒä¼šåŽ»å®˜æ–¹æ‹‰å–providerä½†æ˜¯ä¼šæŠ¥é”™ï¼Œå¿…é¡»æ‰‹åŠ¨ä¸‹è½½providerå¹¶æŒ‡å®š-plugin-dirï¼Œå‘¼å¸ä¸åˆ°å¤–é¢çš„æ–°é²œç©ºæ°”æœ‰ç‚¹éš¾å—ã€‚ terraformçš„æ–‡æ¡£éƒ½æ˜¯è‹±æ–‡çš„å¹¶ä¸”providerç»™åˆ°çš„å‚æ•°é€‰é¡¹ä¸å…¨ï¼Œä¸çŸ¥é“è¯¥å¡«ä»€ä¹ˆã€‚ é˜¿é‡Œäº‘åˆ›å»ºçš„ramç”¨æˆ·é»˜è®¤æ²¡æœ‰æƒé™ã€‚ é˜¿é‡Œäº‘éœ€è¦100å—ï¼Ÿï¼æˆ‘å……10å—é’±ä¸è¡Œå—ï¼Ÿæˆ‘åˆèŠ±ä¸äº†é‚£ä¹ˆå¤šï¼Œå¼„å¾—æˆ‘æ™šé¥­éƒ½åƒä¸èµ·äº†ã€‚ é˜¿é‡Œäº‘å¾ˆå¤šåœ°åŒºæ˜¯æ²¡æœ‰ä¾¿å®œçš„æœºå™¨å–çš„ï¼Œä¸€ç›´æç¤ºæˆ‘æœºå™¨æ²¡æœ‰ï¼Œå¾ˆéš¾å—ã€‚ PS: ä»¥ä¸ŠTFæ–‡ä»¶å‡ç”¨æ¥æµ‹è¯•ï¼Œæ‰€ä»¥ä¸€äº›å˜é‡æ²¡æœ‰åšæŠ½ç¦»ï¼Œå®žé™…ä½¿ç”¨ä¸€äº›å˜é‡å¦‚keyç­‰ä¼šæŠ½ç¦»æˆåˆ«çš„æ–‡ä»¶ç»Ÿä¸€ç®¡ç†ï¼Œåˆ«è¢«æˆ‘å¸¦è·‘åäº†ã€‚ æ€»ç»“æ€»çš„æ¥è¯´ä½¿ç”¨tfå¯¹äºŽèµ„æºçš„ç”³è¯·è¿˜æ˜¯éžå¸¸æ–¹ä¾¿çš„ï¼Œä¸€ä¸ªæ–‡ä»¶å°±å¯ä»¥æžå®šï¼Œå¯ä»¥åšåˆ°éšæ—¶ä½¿ç”¨éšæ—¶é”€æ¯ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒå¤šæ¬¡applyå¯¹èµ„æºè¿›è¡Œæ›´æ–°å’Œæ“ä½œã€‚å®ƒä¸ä»…å¯ä»¥å¯¹æœåŠ¡å™¨è¿›è¡Œæ“ä½œï¼Œè¿˜æœ‰å¾ˆå¤šå…¬æœ‰äº‘çš„èµ„æºå¦‚dnsç­‰è¿›è¡Œæ“ä½œï¼Œå¹¶ä¸”çŽ°åœ¨provideræ”¯æŒçš„åŽ‚å•†å¾ˆå¤šã€‚ åŽŸç†ç›¸å…³çš„åšå®¢åŽç»­æœ‰æœºä¼šè¡¥å……ï¼Œå¸Œæœ›ä¸ä¼šé¸½ã€‚]]></content>
      <categories>
        <category>terraform</category>
      </categories>
      <tags>
        <tag>terraform</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[golangä¸­ç¥žå¥‡çš„sync.Pool]]></title>
    <url>%2F2019%2F11%2F09%2Fgolang%2Fsource-code%2Fsync-pool-source-code%2F</url>
    <content type="text"><![CDATA[åœ¨ golang ä¸­æœ‰ä¸€ä¸ªæ± ï¼Œå®ƒç‰¹åˆ«ç¥žå¥‡ï¼Œä½ åªè¦å’Œå®ƒæœ‰ä¸ªçº¦å®šï¼Œä½ è¦ä»€ä¹ˆå®ƒå°±ç»™ä»€ä¹ˆï¼Œä½ ç”¨å®Œäº†è¿˜å¯ä»¥è¿˜å›žåŽ»ï¼Œä½†æ˜¯ä¸‹æ¬¡æ‹¿çš„æ—¶å€™å‘¢ï¼Œç¡®ä¸ä¸€å®šæ˜¯ä½ ä¸Šæ¬¡å­˜çš„é‚£ä¸ªï¼Œè¿™ä¸ªæ± å°±æ˜¯ sync.Pool è¯´å®žè¯ç¬¬ä¸€æ¬¡çœ‹åˆ°è¿™ä¸ªä¸œè¥¿çš„æ—¶å€™ï¼ŒçœŸçš„æƒ³ä¸åˆ°è¿™ä¸ªä¸œè¥¿æœ‰å•¥ç”¨å•Šï¼Œä¸ºä»€ä¹ˆè¦æœ‰è¿™ä¸ªä¸œè¥¿å‘¢ï¼Ÿç­‰æˆ‘çœ‹å®Œä¹‹åŽï¼Œå—¯ï¼Œè¿˜æœ‰æœ‰ç‚¹ç”¨çš„ï¼›ç­‰åˆ°æœ‰ä¸€æ¬¡ä¼˜åŒ–ç»åŽ†çš„æ—¶å€™ï¼Œå—¯ï¼Œè¿™ä¸ªæœ‰ç‚¹æ„æ€äº†ã€‚ä»Šå¤©æˆ‘ä»¬å°±æ¥çœ‹çœ‹è¿™ä¸ªç¥žå¥‡çš„ sync.Pool ç®€å•æ¡ˆä¾‹é¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ª sync.Pool æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼Œå…¶å®žéžå¸¸çš„ç®€å•ã€‚å®ƒä¸€å…±åªæœ‰ä¸‰ä¸ªæ–¹æ³•æˆ‘ä»¬éœ€è¦çŸ¥é“çš„ï¼šNewã€Putã€Get 12345678910111213141516171819package mainimport ( "fmt" "sync")var strPool = sync.Pool&#123; New: func() interface&#123;&#125; &#123; return "test str" &#125;,&#125;func main() &#123; str := strPool.Get() fmt.Println(str) strPool.Put(str)&#125; é€šè¿‡NewåŽ»å®šä¹‰ä½ è¿™ä¸ªæ± å­é‡Œé¢æ”¾çš„ç©¶ç«Ÿæ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Œåœ¨è¿™ä¸ªæ± å­é‡Œé¢ä½ åªèƒ½æ”¾ä¸€ç§ç±»åž‹çš„ä¸œè¥¿ã€‚æ¯”å¦‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­æˆ‘å°±åœ¨æ± å­é‡Œé¢æ”¾äº†å­—ç¬¦ä¸²ã€‚ æˆ‘ä»¬éšæ—¶å¯ä»¥é€šè¿‡Getæ–¹æ³•ä»Žæ± å­é‡Œé¢èŽ·å–æˆ‘ä»¬ä¹‹å‰åœ¨Newé‡Œé¢å®šä¹‰ç±»åž‹çš„æ•°æ®ã€‚ å½“æˆ‘ä»¬ç”¨å®Œäº†ä¹‹åŽå¯ä»¥é€šè¿‡Putæ–¹æ³•æ”¾å›žåŽ»ï¼Œæˆ–è€…æ”¾åˆ«çš„åŒç±»åž‹çš„æ•°æ®è¿›åŽ»ã€‚ ç›®çš„é‚£ä¹ˆè¿™ä¸ªæ± å­çš„ç›®çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå…¶å®žä¸€å¥è¯å°±å¯ä»¥è¯´æ˜Žç™½ï¼Œå°±æ˜¯ä¸ºäº†å¤ç”¨å·²ç»ä½¿ç”¨è¿‡çš„å¯¹è±¡ï¼Œæ¥è¾¾åˆ°ä¼˜åŒ–å†…å­˜ä½¿ç”¨å’Œå›žæ”¶çš„ç›®çš„ã€‚è¯´ç™½äº†ï¼Œä¸€å¼€å§‹è¿™ä¸ªæ± å­ä¼šåˆå§‹åŒ–ä¸€äº›å¯¹è±¡ä¾›ä½ ä½¿ç”¨ï¼Œå¦‚æžœä¸å¤Ÿäº†å‘¢ï¼Œè‡ªå·±ä¼šé€šè¿‡newäº§ç”Ÿä¸€äº›ï¼Œå½“ä½ æ”¾å›žåŽ»äº†ä¹‹åŽè¿™äº›å¯¹è±¡ä¼šè¢«åˆ«äººè¿›è¡Œå¤ç”¨ï¼Œå½“å¯¹è±¡ç‰¹åˆ«å¤§å¹¶ä¸”ä½¿ç”¨éžå¸¸é¢‘ç¹çš„æ—¶å€™å¯ä»¥å¤§å¤§çš„å‡å°‘å¯¹è±¡çš„åˆ›å»ºå’Œå›žæ”¶çš„æ—¶é—´ã€‚ æ¥çœ‹çœ‹docå…¶å®žå®˜æ–¹æ–‡æ¡£é‡Œé¢ç»™å‡ºäº†ä¸€äº›å°ç»†èŠ‚è®©æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹ https://golang.google.cn/pkg/sync/#Pool A Pool is a set of temporary objects that may be individually saved and retrieved. Any item stored in the Pool may be removed automatically at any time without notification. If the Pool holds the only reference when this happens, the item might be deallocated. A Pool is safe for use by multiple goroutines simultaneously. Poolâ€™s purpose is to cache allocated but unused items for later reuse, relieving pressure on the garbage collector. That is, it makes it easy to build efficient, thread-safe free lists. However, it is not suitable for all free lists. An appropriate use of a Pool is to manage a group of temporary items silently shared among and potentially reused by concurrent independent clients of a package. Pool provides a way to amortize allocation overhead across many clients. An example of good use of a Pool is in the fmt package, which maintains a dynamically-sized store of temporary output buffers. The store scales under load (when many goroutines are actively printing) and shrinks when quiescent. On the other hand, a free list maintained as part of a short-lived object is not a suitable use for a Pool, since the overhead does not amortize well in that scenario. It is more efficient to have such objects implement their own free list. A Pool must not be copied after first use. æ³¨æ„å…¶ä¸­åŠ ç²—çš„éƒ¨åˆ†ï¼Œæˆ‘åˆ—ä¸€ä¸‹å…¶ä¸­çš„ç‚¹ï¼Œå»ºè®®è¿˜æ˜¯å°è¯•åŽ»é˜…è¯»docé‡Œé¢çš„è¯´æ˜Žã€‚ ä¸´æ—¶å¯¹è±¡ è‡ªåŠ¨ç§»é™¤ å½“è¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨åªæœ‰sync.PoolæŒæœ‰æ—¶ï¼Œè¿™ä¸ªå¯¹è±¡å†…å­˜ä¼šè¢«é‡Šæ”¾ å¤šçº¿ç¨‹å®‰å…¨ ç›®çš„å°±æ˜¯ç¼“å­˜å¹¶é‡ç”¨å¯¹è±¡ï¼Œå‡å°‘GCçš„åŽ‹åŠ› è‡ªåŠ¨æ‰©å®¹ã€ç¼©å®¹ ä¸è¦åŽ»æ‹·è´poolï¼Œä¹Ÿå°±æ˜¯è¯´æœ€å¥½å•ä¾‹ æºç åˆ†æžä¸‹é¢æˆ‘ä»¬ä»Žæºç å±‚é¢æ¥çœ‹çœ‹è¿™ä¸ª sync.Poolï¼›å¯èƒ½éœ€è¦ä½ æœ‰GPMæ¨¡åž‹å’ŒGCçš„ç›¸å…³çŸ¥è¯†ã€‚ä½¿ç”¨golangç‰ˆæœ¬ï¼š go version go1.13 ç»“æž„12345678910111213141516171819202122232425262728type Pool struct &#123; noCopy noCopy local unsafe.Pointer // local fixed-size per-P pool, actual type is [P]poolLocal localSize uintptr // size of the local array victim unsafe.Pointer // local from previous cycle victimSize uintptr // size of victims array // New optionally specifies a function to generate // a value when Get would otherwise return nil. // It may not be changed concurrently with calls to Get. New func() interface&#123;&#125;&#125;// Local per-P Pool appendix.type poolLocalInternal struct &#123; private interface&#123;&#125; // Can be used only by the respective P. shared poolChain // Local P can pushHead/popHead; any P can popTail.&#125;type poolLocal struct &#123; poolLocalInternal // Prevents false sharing on widespread platforms with // 128 mod (cache line size) = 0 . pad [128 - unsafe.Sizeof(poolLocalInternal&#123;&#125;)%128]byte&#125; æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¶å®žç»“æž„å¹¶ä¸å¤æ‚ï¼Œä½†æ˜¯å¦‚æžœè‡ªå·±çœ‹çš„è¯æœ‰ç‚¹æ‡µã€‚æ³¨æ„å‡ ä¸ªç»†èŠ‚å°±okã€‚ localè¿™é‡Œé¢çœŸæ­£çš„æ˜¯[P]poolLocalå…¶ä¸­På°±æ˜¯GPMæ¨¡åž‹ä¸­çš„Pï¼Œæœ‰å¤šå°‘ä¸ªPæ•°ç»„å°±æœ‰å¤šå¤§ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªPç»´æŠ¤äº†ä¸€ä¸ªæœ¬åœ°çš„poolLocalã€‚ poolLocalé‡Œé¢ç»´æŠ¤äº†ä¸€ä¸ªprivateä¸€ä¸ªsharedï¼Œçœ‹åå­—å…¶å®žå°±å¾ˆæ˜Žæ˜¾äº†ï¼Œprivateæ˜¯ç»™è‡ªå·±ç”¨çš„ï¼Œè€Œsharedçš„æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå¯ä»¥ç»™åˆ«äººç”¨çš„ã€‚æ³¨é‡Šå†™çš„ä¹Ÿå¾ˆæ¸…æ¥šï¼Œè‡ªå·±å¯ä»¥ä»Žé˜Ÿåˆ—çš„å¤´éƒ¨å­˜ç„¶åŽä»Žå¤´éƒ¨å–ï¼Œè€Œåˆ«çš„På¯ä»¥ä»Žå°¾éƒ¨å–ã€‚ victimè¿™ä¸ªä»Žå­—é¢ä¸Šé¢ä¹Ÿå¯ä»¥çŸ¥é“ï¼Œå¹¸å­˜è€…å˜›ï¼Œå½“è¿›è¡Œgcçš„stwæ—¶å€™ï¼Œä¼šå°†localä¸­çš„å¯¹è±¡ç§»åˆ°victimä¸­åŽ»ï¼Œä¹Ÿå°±æ˜¯è¯´å¹¸å­˜äº†ä¸€æ¬¡gcï¼Œ Get123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960func (p *Pool) Get() interface&#123;&#125; &#123; ...... l, pid := p.pin() x := l.private l.private = nil if x == nil &#123; // Try to pop the head of the local shard. We prefer // the head over the tail for temporal locality of // reuse. x, _ = l.shared.popHead() if x == nil &#123; x = p.getSlow(pid) &#125; &#125; runtime_procUnpin() ...... if x == nil &amp;&amp; p.New != nil &#123; x = p.New() &#125; return x&#125;func (p *Pool) getSlow(pid int) interface&#123;&#125; &#123; // See the comment in pin regarding ordering of the loads. size := atomic.LoadUintptr(&amp;p.localSize) // load-acquire locals := p.local // load-consume // Try to steal one element from other procs. for i := 0; i &lt; int(size); i++ &#123; l := indexLocal(locals, (pid+i+1)%int(size)) if x, _ := l.shared.popTail(); x != nil &#123; return x &#125; &#125; // Try the victim cache. We do this after attempting to steal // from all primary caches because we want objects in the // victim cache to age out if at all possible. size = atomic.LoadUintptr(&amp;p.victimSize) if uintptr(pid) &gt;= size &#123; return nil &#125; locals = p.victim l := indexLocal(locals, pid) if x := l.private; x != nil &#123; l.private = nil return x &#125; for i := 0; i &lt; int(size); i++ &#123; l := indexLocal(locals, (pid+i)%int(size)) if x, _ := l.shared.popTail(); x != nil &#123; return x &#125; &#125; // Mark the victim cache as empty for future gets don't bother // with it. atomic.StoreUintptr(&amp;p.victimSize, 0) return nil&#125; æˆ‘åŽ»æŽ‰äº†å…¶ä¸­ä¸€äº›ç«žæ€åˆ†æžçš„ä»£ç ï¼ŒGetçš„é€»è¾‘å…¶å®žéžå¸¸æ¸…æ™°ã€‚ å¦‚æžœ private ä¸æ˜¯ç©ºçš„ï¼Œé‚£å°±ç›´æŽ¥æ‹¿æ¥ç”¨ å¦‚æžœ private æ˜¯ç©ºçš„ï¼Œé‚£å°±å…ˆåŽ»æœ¬åœ°çš„sharedé˜Ÿåˆ—é‡Œé¢ä»Žå¤´ pop ä¸€ä¸ª å¦‚æžœæœ¬åœ°çš„ shared ä¹Ÿæ²¡æœ‰äº†ï¼Œé‚£ getSlow åŽ»æ‹¿ï¼Œå…¶å®žå°±æ˜¯åŽ»åˆ«çš„Pçš„ shared é‡Œé¢å·ï¼Œå·ä¸åˆ°å›žåŽ» victim å¹¸å­˜è€…é‡Œé¢æ‰¾ å¦‚æžœæœ€åŽéƒ½æ²¡æœ‰ï¼Œé‚£å°±åªèƒ½è°ƒç”¨ New æ–¹æ³•åˆ›å»ºä¸€ä¸ªäº† æˆ‘éšæ‰‹ç”»äº†ä¸€ä¸‹ï¼Œå¯èƒ½ä¸æ˜¯ç‰¹åˆ«å‡†ç¡®ï¼Œæ„æ€åˆ°ä½äº† Put1234567891011121314151617// Put adds x to the pool.func (p *Pool) Put(x interface&#123;&#125;) &#123; if x == nil &#123; return &#125; ...... l, _ := p.pin() if l.private == nil &#123; l.private = x x = nil &#125; if x != nil &#123; l.shared.pushHead(x) &#125; runtime_procUnpin() ......&#125; çœ‹å®ŒGetå…¶å®žPutå°±å¾ˆç®€å•äº† å¦‚æžœ private æ²¡æœ‰ï¼Œå°±æ”¾åœ¨ private å¦‚æžœ private æœ‰äº†ï¼Œé‚£ä¹ˆå°±æ”¾åˆ° shared é˜Ÿåˆ—çš„å¤´éƒ¨ å®žé™…æµ‹è¯•è®©æˆ‘ä»¬å®žé™…å†™ä¸ªæµ‹è¯•çš„æ¡ˆä¾‹æ¥æµ‹æµ‹å…·ä½“ä½¿ç”¨æ—¶ä¼šæœ‰ä»€ä¹ˆæ ·çš„å˜åŒ– Putä¹‹åŽé©¬ä¸ŠGet123456789101112131415var pool = sync.Pool&#123; New: func() interface&#123;&#125; &#123; return "123" &#125;,&#125;func main() &#123; t := pool.Get().(string) fmt.Println(t) pool.Put("321") t2 := pool.Get().(string) fmt.Println(t2)&#125; è¾“å‡ºï¼š123321 Putä¹‹åŽGCåŽGet123456789101112131415161718192021222324252627var pool = sync.Pool&#123; New: func() interface&#123;&#125; &#123; return "123" &#125;,&#125;func main() &#123; t := pool.Get().(string) fmt.Println(t) pool.Put("321") pool.Put("321") pool.Put("321") pool.Put("321") runtime.GC() time.Sleep(1 * time.Second) t2 := pool.Get().(string) fmt.Println(t2) runtime.GC() time.Sleep(1 * time.Second) t2 = pool.Get().(string) fmt.Println(t2)&#125; è¾“å‡ºï¼š123321123 ä½ çŸ¥é“ä¸ºä»€ä¹ˆå—ï¼Ÿ æ€»ç»“è¿™æ¬¡æ€»ç»“æ¥ç‚¹ä¸ä¸€æ ·çš„ï¼Œæå‡ ä¸ªé—®é¢˜å§ã€‚ ä»€ä¹ˆæƒ…å†µä¸‹é€‚åˆä½¿ç”¨sync.Poolå‘¢ï¼Ÿ sync.Poolçš„å¯¹è±¡ä»€ä¹ˆæ—¶å€™ä¼šè¢«å›žæ”¶å‘¢ï¼Ÿ sync.Poolæ˜¯å¦‚ä½•å®žçŽ°çº¿ç¨‹å®‰å…¨çš„ï¼Ÿå¦‚æžœä½ èƒ½å›žç­”ä¸Šé¢çš„é—®é¢˜ï¼Œè¯æ˜Žä½ å¯¹å®ƒå·²ç»è¶³å¤Ÿäº†è§£äº†ï¼Œé‚£ä¹ˆå°±å¯ä»¥å°è¯•åœ¨å…·ä½“çš„æƒ…å†µä¸‹ä½¿ç”¨å®ƒæ¥çŽ©çŽ©äº†ã€‚è¯•è¯•å§~]]></content>
      <categories>
        <category>golangæºç è§£æž</category>
      </categories>
      <tags>
        <tag>sync.Pool</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å›¾è§£golangå†…å­˜åˆ†é…]]></title>
    <url>%2F2019%2F11%2F02%2Fgolang%2Fbasic%2Fgo-memory%2F</url>
    <content type="text"><![CDATA[æˆ‘ä»¬çŸ¥é“æ‰€æœ‰ç¨‹åºè¿è¡Œéƒ½éœ€è¦ä½¿ç”¨å†…å­˜ï¼Œè€Œå†…å­˜çš„ç®¡ç†å’Œåˆ†é…åˆæ˜¯éžå¸¸é‡è¦çš„ï¼Œå®ƒå†³å®šäº†ä½ çš„ç¨‹åºèƒ½ä¸èƒ½åœ¨æœ‰é™çš„èµ„æºå†…è·‘çš„æ›´å¿«ã€‚å¯ä»¥è®¾æƒ³ä¸€ä¸‹ï¼Œå¦‚æžœä½ è‡ªå·±æ¥è®¾è®¡çš„ä¸€ä¸ªå†…å­˜åˆ†é…çš„è§„åˆ™ï¼Œä¼šé‡åˆ°ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿå¦‚æžœä½ æœ‰äº†ä¸€å¤§å—å†…å­˜ä½ è¦æ€Žä¹ˆåŽ»åˆç†çš„åˆ†é…å’Œä½¿ç”¨å‘¢ï¼Ÿä»Šå¤©æˆ‘ä»¬é€šè¿‡å‡ å¼ å›¾æ¥çœ‹çœ‹golangä¸­çš„å†…å­˜åˆ†é…æ˜¯æ€Žæ ·çš„ã€‚ å‰ç½®çŸ¥è¯†ï¼šå¯¹golangçš„GPMæ¨¡åž‹æœ‰æ‰€äº†è§£ï¼Œå¯¹GCæœ‰ä¸€å®šçš„äº†è§£ï¼Œæœ‰åŠ©äºŽä½ ç†è§£ä¸‹é¢çš„å†…å®¹ã€‚ æƒ³ä¸€æƒ³æˆ‘ä»¬é¦–å…ˆæ¥æƒ³ä¸€ä¸‹ï¼Œå¦‚æžœæˆ‘ä»¬è‡ªå·±æ¥åˆ†é…å†…å­˜çš„æ—¶å€™å¯èƒ½ä¼šé‡åˆ°ä»€ä¹ˆé—®é¢˜ã€‚ æˆ‘æƒ³è¦512Gï¼Œä½ èƒ½ç»™å—ï¼Ÿæ“ä½œç³»ç»Ÿçš„å†…å­˜ä¸æ˜¯ä½ æƒ³è¦å¤šå°‘å°±ç»™ä½ å¤šå°‘çš„ã€‚æ¯”å¦‚æˆ‘è·Ÿæ“ä½œç³»ç»Ÿè¯´æˆ‘è¦512Gå†…å­˜ï¼Œä½ èµ¶ç´§ç»™æˆ‘ï¼Œä¸ç»™æˆ‘æˆ‘å°±æŽæ­»ä½ ï¼Œå¦‚æžœä½ æ˜¯æ“ä½œç³»ç»Ÿï¼Œæ˜¯ä¸æ˜¯ç«‹é©¬å°±æƒ³æŠŠæˆ‘ç»™ç»“æŸäº†ï¼Ÿ èƒ½éšä¾¿åˆ†å‰²å—ï¼Ÿå¦‚æžœæˆ‘æ‹¿åˆ°ä¸€å—å†…å­˜ï¼ŒæŒºå¤§çš„ï¼Œä½ æŠŠå®ƒæƒ³è±¡æˆä¸€å—åœ°ï¼Œæˆ‘ä»Šå¤©è¦ç”¨è¿™å—åœ°çš„è¿™ä¸ªéƒ¨åˆ†ï¼Œè‚¯å®šæ˜¯ä»Žä¸­é—´åˆ‡ä¸€å—å‡ºæ¥ç”¨ï¼Œç„¶åŽæ˜Žå¤©è¦å¦ä¸€ä¸ªéƒ¨åˆ†ï¼Œç„¶åŽå†åˆ‡å‡ºæ¥ä¸€éƒ¨åˆ†ã€‚å¦‚æžœéšä¾¿åˆ‡ï¼Œä»Šå¤©è¦ä¸€å—ä¸‰è§’å½¢ï¼Œæ˜Žå¤©è¦ä¸€å—åœ†å½¢ï¼Œé‚£ä¹ˆè‚¯å®šä¼šç•™æœ‰å¾ˆå¤šå°å—çš„åœ°æ–¹ï¼Œé‚£äº›åœ°æ–¹æ²¡æœ‰åŠžæ³•è¢«åˆç†çš„ä½¿ç”¨ï¼Œå°±ä¼šæµªè´¹ã€‚ç­‰åˆ°æƒ³å†è¦ä¸€å—æ­£æ–¹å½¢çš„åœ°çš„æ—¶å€™å‘çŽ°æ²¡åœ°æ–¹å¯ä»¥åˆ‡äº†ã€‚ ä¸ç”¨äº†æˆ‘éœ€è¦æ”¾å›žåŽ»å—ï¼Ÿå¦‚æžœæˆ‘å ç”¨äº†å¾ˆå¤§ä¸€å—å†…å­˜èµ„æºï¼Œç„¶åŽç”¨å®Œäº†ï¼ŒçŽ°åœ¨ä¸éœ€è¦äº†ï¼Œé‚£è‡ªç§çš„äººè‚¯å®šæƒ³ç€ï¼Œæˆ‘å°±å·å·ä¸€ç›´å ç”¨ä¸è¡Œå—ï¼Ÿæ˜¾ç„¶æ˜¯ä¸å¯ä»¥çš„ï¼Œä¸ç„¶çš„è¯ä½ çš„åº”ç”¨ç¨‹åºå°±æ¯å¤©å ç”¨ç€ä¸€å°æœºå™¨å¤§é‡çš„èµ„æºä¸é‡Šæ”¾ï¼Œåˆ«çš„äººéƒ½æ²¡å¾—ç”¨äº†ï¼Œè‚¯å®šæƒ³æŠŠä½ å¹²æŽ‰ã€‚æ‰€ä»¥ç”¨å®Œäº†è¦æ”¾å›žåŽ»ã€‚ â€“å…¶å®žä¸Šé¢çš„é—®é¢˜å°±æ˜¯å†…å­˜åˆ†é…å¸¸è§çš„ä¸€äº›é—®é¢˜ï¼Œé‚£ä¸ºäº†é«˜æ•ˆã€åˆç†åˆ©ç”¨å†…å­˜ï¼ŒåŠ¿å¿…éœ€è¦ä¸€äº›äººçš„ç®¡ç†å’Œå¸®åŠ©ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹é‚£äº›åœ¨golangä¸­çš„ç®¡ç†è€…ï¼Œçœ‹çœ‹ä»–ä»¬æ˜¯å¦‚ä½•å¸®åŠ©æˆ‘ä»¬åŽ»ç®¡ç†å’Œåˆ†é…å†…å­˜çš„ã€‚ å†…å­˜çš„ç®¡ç†è€…è¿™å¼ å›¾é‡Œé¢å°±æ˜¯golangä¸­å†…å­˜çš„ç®¡ç†è€…ä»¬ï¼Œä¸‹é¢æˆ‘æ¥ä¾æ¬¡ä»‹ç»ä¸€ä¸‹ OSé¦–å…ˆæ˜¯æ“ä½œç³»ç»Ÿï¼Œä»–æ‹¥æœ‰ç€å…¨éƒ¨çš„æœºå™¨å†…å­˜ï¼Œæˆ‘ä»¬çš„ç¨‹åºå¿…é¡»å‘å®ƒè¦ã€‚ä½†æ˜¯ä»–æ˜¯å¤§é¢†å¯¼ï¼Œå¾ˆå¿™çš„ï¼Œä½ ä¸èƒ½æ²¡äº‹æ€»æ‰¾ä»–è¦ï¼Œå¾ˆçƒ¦ï¼Œæ‰€ä»¥æ¯æ¬¡éƒ½ä¼šå‘ä»–ä¸€å¤§å—å†…å­˜ï¼ˆ1Mæ‰“åº•ï¼‰ä»–ä¼šç»™ä½ ä¸€ç¥¨åœ°å€ï¼Œä½†æ˜¯å®žé™…å…¶å®žå¹¶ä¸ä¼šç›´æŽ¥ç»™ä½ åˆ†é…å†…å­˜ï¼Œä½†æ˜¯ä½ ç”¨åˆ°äº†è‡ªç„¶ä¼šæœ‰ã€‚ heapè¿™ä¸ªæ˜¯æˆ‘ä»¬ç¨‹åºä¸­æœ€å¤§çš„å†…å­˜æŒæœ‰åŒºåŸŸï¼Œå †ï¼Œä»–ç®¡ç†ç€é‚£äº›å¾ˆå¤§çš„å†…å­˜å—ï¼ŒåŒæ—¶æ˜¯ä»–å‘æ“ä½œç³»ç»ŸåŽ»ç”³è¯·å†…å­˜çš„ï¼Œå…¨å±€åªæœ‰ä»–ä¸€ä¸ªå¤§äººç‰©ã€‚ä»–è¿˜éœ€è¦å°†ä»Žæ“ä½œç³»ç»Ÿæ‹¿è¿‡æ¥çš„å†…å­˜è¿›è¡Œä¸€å®šçš„åˆ’åˆ†ï¼Œåˆ’åˆ†æˆä¸€æ•´å—ä¸€æ•´å—çš„æ ·å­æ–¹ä¾¿ç®¡ç†ï¼ŒåŒæ—¶è®°å½•å†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œæ–¹ä¾¿æ•´ç†å’Œå›žæ”¶ã€‚ centralè¿™ä¸ªæ˜¯äºŒæŠŠæ‰‹ï¼Œæœ‰å¾ˆå¤šï¼Œä»–ä»¬ä¼šè´Ÿè´£å°†å†…å­˜åˆ’åˆ†æˆè¶³å¤Ÿå°çš„å•å…ƒï¼ŒåŒæ—¶éœ€è¦å‘ä¸‹æä¾›å†…å­˜çš„åˆ†é…å·¥ä½œï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ä¸€äº›åˆç†çš„åˆ†é…æŽªæ–½äº†ï¼Œè¿™ä¸ªæˆ‘ä»¬åŽé¢å†è¯´ã€‚ cacheè¿™ä¸ªæ˜¯æœ€åŽä¸€ä¸ªå°é¢†å¯¼äº†ï¼Œç®¡ç†ç€æœ€ç»ˆçº¿ç¨‹éœ€è¦ä½¿ç”¨çš„å†…å­˜èµ„æºï¼Œè€Œä¸”æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰ä¸€ä¸ªç‹¬ç«‹çš„cacheï¼Œä¸€å¯¹ä¸€ç»‘å®šï¼Œè¿™æ ·ä½¿ç”¨çš„æ—¶å€™å°±ä¼šç›´æŽ¥ä»Žå¯¹åº”çš„cacheä¸­åŽ»å–æ¥ä½¿ç”¨ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯ä¸ç”¨å’Œåˆ«äººå‘ç”Ÿäº‰æŠ¢ã€‚å¦‚æžœæ‰€æœ‰çš„çº¿ç¨‹éƒ½ä»Žä¸€ä¸ªåœ°æ–¹è¿›è¡Œå–ç”¨ï¼Œé‚£ä¹ˆåŠ¿å¿…ä¼šé€ æˆä½ ä¹Ÿè¦ç”¨ï¼Œæˆ‘ä¹Ÿè¦ç”¨çš„æƒ…å†µã€‚ æ€»ç»“ä»Žä¸Šé¢çš„å›¾æˆ‘ä»¬å¯ä»¥åŸºæœ¬æ˜Žç™½ä¸€ä¸ªæ€»ä½“çš„æ€è·¯æ˜¯è¯´ï¼šéœ€è¦æœ‰äººæ€»ä½“åŽ»æŠŠæŽ§æ‰€æœ‰å†…å­˜èµ„æºçš„ä½¿ç”¨ï¼Œåšåˆ°ç»Ÿä¸€çš„è°ƒåº¦å’Œç®¡ç†ï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿åŽç»­çš„å›žæ”¶å’Œåˆ©ç”¨ã€‚åŒæ—¶éœ€è¦ä¸‹é¢æœ‰äººè´Ÿè´£æœ€ç»ˆä½¿ç”¨çš„åˆ†é…ï¼Œä»Žè€Œèƒ½è¾¾åˆ°ä¸€ä¸ªå†…å­˜çš„å¿«é€Ÿåˆ†é…è€Œä¸å‘ç”Ÿäº‰æŠ¢ã€‚ å†…å­˜çš„åˆ†é…ç»“æž„æˆ‘ä»¬çŸ¥é“äº†å†…å­˜çš„ç®¡ç†è€…æ˜¯è°ï¼Œé‚£ä¹ˆçŽ°åœ¨æˆ‘ä»¬å†æ¥çœ‹çœ‹å†…å­˜åˆ°åº•æ˜¯æ€Žä¹ˆåˆ’åˆ†çš„ï¼Œç©¶ç«Ÿæ˜¯åˆ‡æˆä¸€ä¸ªä¸ªé•¿æ–¹å½¢è¿˜æ˜¯åˆ‡æˆä¸€ä¸ªä¸ªåœ†å½¢äº†å‘¢ï¼Ÿ è¿™å¼ å›¾å°±è¡¨ç¤ºäº†æ•´ä¸ªgolangä¸­å†…å­˜çš„åˆ†é…ç»“æž„é•¿ä»€ä¹ˆæ ·å­ã€‚ arenaè¿™å—åŒºåŸŸæœ€å¤§ï¼Œæ˜Žæ˜¾å°±æ˜¯ç”¨æ¥å­˜æ”¾æˆ‘ä»¬æœ€ç»ˆçš„å¯¹è±¡ï¼Œé‡Œé¢åˆ†æˆäº†ä¸€ä¸ªä¸ª8Kå¤§å°çš„æˆ¿é—´ï¼Œæ¯ä¸ªæˆ¿é—´æˆ‘ä»¬ç§°ä¸ºpageã€‚ï¼ˆè¿™é‡Œè™½ç„¶å†™äº†å®ƒæ˜¯512Gï¼Œä½†æ˜¯ä½ å¿ƒé‡Œè¦æœ‰Bæ•°ï¼Œä½ ç”µè„‘æ ¹æœ¬æ²¡è¿™ä¹ˆå¤§çš„å†…å­˜ï¼Œå…¶å®žæ“ä½œç³»ç»Ÿåªæ˜¯ç»™äº†ä½ åœ°å€è€Œå·²ï¼‰åŒæ—¶å‡ ä¸ªpageç»„åˆåœ¨ä¸€èµ·çš„å¤§æˆ¿é—´åˆå«åšmspanï¼ˆè¿™ä¸ªæ˜¯golangä¸­å†…å­˜ç®¡ç†çš„åŸºæœ¬å•å…ƒï¼‰ bitmapç„¶åŽæˆ‘ä»¬å†æ¥çœ‹ç¬¬äºŒå¤§çš„bitmapï¼Œå®ƒæ˜¯ç”¨æ¥è¡¨ç¤ºarenaä¸­å­˜æ”¾çš„å¯¹è±¡çš„ä¸€äº›ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¿™ä¸ªå¯¹è±¡GCæ ‡å¿—ï¼Œè¿˜æœ‰æ ‡è¯†è¿™ä¸ªå¯¹è±¡æ˜¯å¦åŒ…å«æŒ‡é’ˆã€‚ä½ è‚¯å®šå°±å¥½å¥‡ï¼Œå¹²å˜›è¦æœ‰è¿™ä¸ªå‘¢ï¼Ÿè¿™å…¶å®žä¹Ÿå¾ˆå¥½ç†è§£ï¼Œgolangåœ¨è¿›è¡Œåžƒåœ¾å›žæ”¶çš„æ—¶å€™æ˜¯æ ¹æ®å¼•ç”¨çš„å¯è¾¾æ€§åˆ†æžæ¥ç¡®å®šä¸€ä¸ªå¯¹è±¡æ˜¯å¦å¯ä»¥è¢«å›žæ”¶ï¼ŒåŒæ—¶é‡‡ç”¨çš„æ˜¯ä¸‰è‰²æ ‡è®°æ³•è¿›è¡Œæ ‡è®°å¯¹è±¡ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦æœ‰bitmapæ¥ä¿å­˜è¿™äº›ä¿¡æ¯ã€‚ï¼ˆå…·ä½“å¦‚æžœä¸æ¸…æ¥šåžƒåœ¾å›žæ”¶çš„ç»†èŠ‚å¯ä»¥åŽ»çœ‹çœ‹æˆ‘ä¹‹å‰å†™çš„æœ‰å…³åžƒåœ¾å›žæ”¶çš„éƒ¨åˆ†ï¼‰ spansæœ€åŽæ˜¯spansï¼Œè¿™é‡Œä¿å­˜äº†mspançš„æŒ‡é’ˆï¼Œè¿™ä¸ªä¹Ÿå¥½ç†è§£ï¼Œä¸ºäº†æ–¹ä¾¿ç®¡ç†é‚£ä¸€ä¸ªä¸ªå¤§æˆ¿é—´å˜› å†…å­˜åˆ†é…é‚£ä¹ˆæœ€åŽæˆ‘ä»¬æ¥çœ‹çœ‹æˆ‘ä»¬åˆ›å»ºçš„ä¸€ä¸ªå¯¹è±¡æœ€åŽç©¶ç«Ÿä¼šç»åŽ†äº›ä»€ä¹ˆï¼Œæ˜¯æ€Žä¹ˆæ ·åˆ†é…çš„å‘¢ï¼Ÿé¦–å…ˆè¦è¯´æ˜Žçš„æ˜¯ï¼Œgolangå¾ˆèªæ˜Žçš„ï¼Œå¦‚æžœä¸€ä¸ªå˜é‡å¯ä»¥åˆ†é…åœ¨æ ˆä¸Šï¼Œé‚£ä¹ˆå°±ä¸ä¼šè¢«åˆ†é…åœ¨å †ä¸Šï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆçš„èŠ‚çº¦èµ„æºï¼ˆå…·ä½“æˆ‘åŽç»­è¿˜ä¼šå†™åˆ«çš„æ¥è¯´æ˜Žgolangä¸­çš„å˜é‡ï¼‰ã€‚æ€»ä¹‹æˆ‘ä»¬è¿™é‡Œè®¨è®ºçš„æ˜¯åˆ†é…åœ¨å †ä¸Šçš„æƒ…å†µã€‚æ•´ä¸ªæµç¨‹å·®ä¸å¤šç±»ä¼¼å°±æ˜¯è¿™æ ·ï¼Œå—¯ï¼Œä½ åªè¦æŠŠå†…å­˜æƒ³è±¡æˆæˆ¿é—´ï¼ŒçŽ°åœ¨æˆ¿ä»·é‚£ä¹ˆè´µï¼Œä½ æ‡‚çš„ åˆ†é…æµç¨‹ å¤§å¯¹è±¡ï¼š &gt;32KB çš„å¯¹è±¡ï¼Œç›´æŽ¥ä»Žheapä¸Šåˆ†é… å°å¯¹è±¡ï¼š 16B &lt; obj &lt;= 32KB è®¡ç®—è§„æ ¼åœ¨mcacheä¸­æ‰¾åˆ°åˆé€‚å¤§å°çš„mspanè¿›è¡Œåˆ†é…ï¼ˆä½ æœ‰å¤šå¤§å°±ä½å¤šå¤§çš„æˆ¿å­ç«Ÿå¯èƒ½çš„ä¸è¦æµªè´¹æˆ¿å­çš„ç©ºé—´ï¼‰ å¾®å°å¯¹è±¡ï¼š &lt;=16B çš„å¯¹è±¡ä½¿ç”¨mcacheçš„tinyåˆ†é…å™¨åˆ†é…ï¼›ï¼ˆå¦‚æžœå°†å¤šä¸ªå¾®å°å¯¹è±¡ç»„åˆèµ·æ¥ï¼Œç”¨å•å—å†…å­˜ï¼ˆobjectï¼‰å­˜å‚¨ï¼Œå¯æœ‰æ•ˆå‡å°‘å†…å­˜æµªè´¹ã€‚ï¼‰ ç§‰æŒåŽŸåˆ™ï¼šç»™åˆ°æœ€åˆé€‚çš„å¤§å°ï¼Œç„¶åŽèƒ½å‡‘ä¸€èµ·çš„å‡‘ä¸€èµ·æŒ¤ä¸€æŒ¤ æ‰©å®¹å¦‚æžœä¸å¤Ÿæ€Žä¹ˆåŠžå‘¢ï¼Ÿä¸å¤Ÿè‚¯å®šå°±è¦æ‰©å®¹äº†å‘—ï¼Œå½“ä¸å¤Ÿçš„æ—¶å€™å°±ä¼šå‘é¢†å¯¼ä¸ŠæŠ¥ï¼Œé€å±‚ä¸ŠæŠ¥ï¼Œæœ€ç»ˆæƒ³åŠžæ³•æ‹¿åˆ°å†…å­˜ã€‚å¦‚æžœcacheæ²¡æœ‰ç›¸åº”è§„æ ¼å¤§å°çš„mspanï¼Œåˆ™å‘centralç”³è¯·å¦‚æžœcentralæ²¡æœ‰ç›¸åº”è§„æ ¼å¤§å°çš„mspanï¼Œåˆ™å‘heapç”³è¯·å¦‚æžœheapä¸­ä¹Ÿæ²¡æœ‰åˆé€‚å¤§å°çš„mspanï¼Œåˆ™å‘æ“ä½œç³»ç»Ÿç”³è¯· å›žæ”¶æœ€åŽè¿˜è¦è®°å¾—ï¼Œå¦‚æžœä½ ç”¨å®Œäº†ï¼Œä¸ç”¨äº†ï¼Œä¼šæœ‰åŽå°çš„æ¸…æ´å·¥æ¥å›žæ”¶æŽ‰ï¼Œæœ€ç»ˆè¿˜æ˜¯ä¼šè¿˜å›žåŽ»çš„ã€‚ä¸€æ–¹é¢å‘¢ï¼šcacheç”¨å®Œäº†è¿˜ç»™centralï¼Œcentralå°±å¯ä»¥ç»™åˆ«çš„cacheç”¨ï¼›centralç”¨å®Œäº†å°±ä¼šè¿˜ç»™heapâ€¦æœ€ç»ˆéƒ½ä¸ç”¨çš„è¿˜ç»™æ“ä½œç³»ç»Ÿ æ€»ç»“è‡³æ­¤golangçš„å†…å­˜åˆ†é…ä¹Ÿå°±è¯´çš„å·®ä¸å¤šäº†ï¼Œå…¶ä¸­ä¸€äº›ç»†èŠ‚å¯èƒ½æ²¡æœ‰è¯´åˆ°ï¼Œå¯èƒ½ä½ è¿˜éœ€è¦çœ‹çœ‹åˆ«çš„æ–‡ç« æ¥è¡¥ä¸€è¡¥ã€‚æ€»ç»“ä¸€ä¸‹ï¼š ä½ å¤šå¤§äººä½å¤šå¤§çš„æˆ¿é—´ï¼Œä¸å¤šç»™ åˆ’åˆ†æˆåˆç†çš„å¤§å°å¯ä»¥ä¸€èµ·ç»™ä¸€èµ·å›žæ”¶ï¼Œå¤§å°åˆé€‚çš„åˆ†å‰²æ‰ä¸ä¼šæµªè´¹ ç”¨å®Œè¿˜å›žåŽ»ï¼Œéœ€è¦æ ‡è®°æ€Žä¹ˆæ ·ç®—ç”¨å®Œäº† æ¯ä¸ªäººçº¿ç¨‹æœ‰ç‹¬ç«‹çš„ç¼“å†²åŒºæ¥è¿›è¡Œå¿«é€Ÿåˆ†é…ï¼Œä¸ç”¨æŠ¢æ¥æŠ¢åŽ»]]></content>
      <categories>
        <category>golangåŸºç¡€</category>
      </categories>
      <tags>
        <tag>å†…å­˜</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å¤§è¯å›¾è§£ginæºç ]]></title>
    <url>%2F2019%2F08%2F20%2Fgolang%2Fopen-source-component%2Fgin%2F</url>
    <content type="text"><![CDATA[æœ€è¿‘åœ¨ç½‘ä¸Šæœäº†ä¸€ä¸‹ï¼Œå¯¹äºŽginæ¡†æž¶ç”¨çš„äººè¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼Œæˆ‘è‡ªå·±ä¹‹å‰ä¹Ÿåœ¨ä½¿ç”¨ï¼Œä½†æ˜¯å¯¹äºŽæºç è§£æžè¿™å—ï¼Œæˆ‘æ²¡æœ‰çœ‹åˆ°è‡ªå·±æƒ³çœ‹åˆ°çš„é‚£ç§ä»Žæ¡†æž¶å…¥æ‰‹çš„è§£æžå›¾ï¼Œæ‰€ä»¥å˜¿å˜¿å˜¿ï¼Œæˆ‘çš„æœºä¼šå°±æ¥äº†ï¼Œä»Šå¤©å°±å¸¦æ¥æœ€å®Œæ•´çš„ginæºç å›¾è§£ã€‚å¸Œæœ›é€šè¿‡è¿™ç¯‡åšå®¢ä½ ä¹Ÿèƒ½è‡ªå·±å­¦ä¼šæ‹†è½®å­ã€‚ PSï¼šæœ¬æ–‡å»ºç«‹åœ¨ä½ å·²ç»èƒ½ç†Ÿç»ƒä½¿ç”¨ginçš„åŸºç¡€ä¹‹ä¸Šï¼Œå¦‚æžœè¿˜æ²¡ç”¨è¿‡å¯ä»¥åŽ»å®˜ç½‘çœ‹ä¸€ä¸‹ï¼šhttps://gin-gonic.com/zh-cn/docs/ç„¶åŽginæ˜¯å¯¹golangçš„httpåŒ…çš„å°è£…ï¼Œæ‰€ä»¥æœ€å¥½å¯¹httpåŒ…ä¹Ÿè¦æœ‰äº†è§£ã€‚ æ•´ä½“åˆ†æžé€»è¾‘å…ˆæ¥è¯´æ˜Žä¸€ä¸‹æˆ‘æ•´ä½“æ‹†è§£çš„é€»è¾‘ï¼Œå¯¹äºŽä¸€ä¸ªæ¡†æž¶ï¼Œæˆ‘å–œæ¬¢ä»Žä¸‹é¢å‡ ä¸ªæ–¹é¢åŽ»å…¥æ‰‹æ‹†è§£ï¼š å¯åŠ¨æ–¹å¼ å¦‚ä½•ä½¿ç”¨ å®žçŽ°ä¸Žç‰¹ç‚¹é’ˆå¯¹äºŽginï¼Œæˆ‘ä¹Ÿå°†ä»Žè¿™å‡ ä¸ªæ–¹é¢åŽ»å…¥æ‰‹ï¼Œå°±ä¼šå¾—åˆ°ä¸‹é¢å‡ ä¸ªé—®é¢˜ï¼Œå¸¦ç€é—®é¢˜çœ‹æºç æ˜¯å¿…å¤‡æ¡ä»¶ã€‚é¦–å…ˆå¯åŠ¨çš„æ—¶å€™ginåšäº†äº›ä»€ä¹ˆï¼Ÿginå°è£…äº†ä»€ä¹ˆç„¶åŽæ€Žä¹ˆåŽ»å®žçŽ°çš„ï¼Ÿginæ•´ä½“ç»“æž„æ˜¯æ€Žä¹ˆæ ·çš„ï¼Œæœ‰å“ªäº›ç»“æž„ï¼Ÿâ€¦ ç„¶åŽä½¿ç”¨ä¸€ä¸ªæ¯”è¾ƒå°çš„demoï¼Œç„¶åŽå…ˆä»Žæ–¹æ³•å…¥æ‰‹ï¼Œè¿›æºç çœ‹ã€‚12345678910111213141516func main() &#123; router := gin.Default() router.Use(gin.Recovery()) router.GET("/test", func(context *gin.Context) &#123; context.JSON(http.StatusOK, gin.H&#123; "code" : 1, "message" : "xxx", &#125;) &#125;) if err := router.Run(); err != nil &#123; panic(err) &#125;&#125; æ•´ä½“ç»“æž„è®¤è¯†Engineæ˜¯ä¸€ä¸ªæ€»çš„å¼•æ“Žï¼Œä¿å­˜äº†å„ä¸ªç»„ä»¶çš„ä¿¡æ¯RouterGroupæ˜¯ä¸€ä¸ªè·¯ç”±ç»„ï¼Œä¿å­˜äº†è·¯ç”±ä¿¡æ¯treesæ˜¯ä¸€æ£µæ ‘ï¼Œä¿å­˜äº†urlä¸Žhandleçš„æ˜ å°„å…³ç³»engineä¸­çš„poolç”¨äºŽå¤ç”¨ContextContextç”¨äºŽrequestä¸­ä¼ é€’å€¼ è¿™æ ·ä½ å°±å¯¹ginçš„æ•´ä¸ªç»“æž„æœ‰äº†å¤§è‡´çš„è®¤è¯†ï¼Œå½“ç„¶æœ‰ä¸€äº›ç»†èŠ‚å­—æ®µæˆ‘è¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚ æ¯ä¸ªæ–¹æ³•åˆ†æžgin.Default()è°ƒç”¨è¿‡ç¨‹å¤§æ¦‚æ˜¯è¿™æ ·ï¼Œè¿™æ˜¯ä¸€ä¸ªginçš„åˆå§‹åŒ–æ–¹æ³•ï¼Œç›®çš„æ˜¯ä¸ºäº†åˆ›å»ºæ•´ä¸ªå¼•æ“Žï¼Œå¹¶åˆå§‹åŒ–ç›¸å…³å‚æ•°ã€‚åˆå§‹åŒ–RouterGroupã€poolç­‰ router.Use()è¿™ä¸ªæ˜¯ä¸€ä¸ªä½¿ç”¨ä¸­é—´ä»¶çš„æ–¹æ³•ï¼Œå½“ç„¶ä¸­é—´ä»¶ä¹Ÿæœ‰åˆ«çš„æ–¹æ³•ï¼Œè¿™è¾¹ä½¿ç”¨useä¸¾ä¾‹ï¼Œå…¶å®žå°±æ˜¯å°†è¯·æ±‚è¿‡ç¨‹ä¸­éœ€è¦è°ƒç”¨çš„ä¸­é—´ä»¶æ”¾å…¥åˆ°HandlersChainï¼Œè¿™ä¸ªæ˜¯ä¸€ä¸ªæ•°ç»„PSï¼šä½ ä¸çŸ¥é“ä¸­é—´ä»¶ï¼Ÿé‚£ä½ ç”¨ä¸€ä¸‹å°±çŸ¥é“äº†ï¼Œæˆ‘ä»¬å¾ˆå¤šæ—¶å€™å†è¯·æ±‚å‰åŽéœ€è¦åŠ å…¥é€šç”¨æ–¹æ³•å¦‚é‰´æƒç­‰ï¼Œå°±ä¼šç”¨åˆ°å®ƒ router.GETè¿™ä¸ªå°±æ˜¯æž„å»ºurlå’Œå…·ä½“å¤„ç†è¯·æ±‚çš„handleçš„å…³ç³»äº†ï¼Œå…¶å®žç›®æ ‡å¾ˆæ˜Žç¡®ï¼Œå°±æ˜¯è¦å°†è¿™ç»„å…³ç³»å­˜å…¥åˆ°æœ€ç»ˆçš„treesä¸­åŽ»ï¼Œè¿™é‡Œå…ˆè¿™æ ·ï¼ŒåŽé¢ä¼šæœ‰è¯¦ç»†è§£é‡Šã€‚ router.Run()è¿™ä¸ªå°±éžå¸¸ç®€å•äº†ï¼Œå°±æ˜¯è°ƒç”¨golangä¸­httpåŒ…ä¸‹çš„æ–¹æ³•ç›‘å¬æœåŠ¡ç«¯å£è€Œå·²ï¼Œæ²¡å•¥å¥½è¯´çš„ï¼Œå¯åŠ¨äº†å˜›ã€‚ func (engine *Engine) ServeHTTPä½ ä»¥ä¸ºè¿™å°±å®Œäº†ï¼Ÿï¼Ÿï¼Ÿä¸Šé¢åªæ˜¯å¯åŠ¨çš„æ—¶å€™ï¼Œé‚£ä¹ˆè¯·æ±‚è¿‡æ¥çš„æ—¶å€™æ€Žä¹ˆåŠžå‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“å¦‚æžœè¦æŽ¥æ”¶è¯·æ±‚ï¼Œé‚£ä¹ˆå°±éœ€è¦å®žçŽ°ä¸‹é¢è¿™ä¸ªæŽ¥å£123type Handler interface &#123; ServeHTTP(ResponseWriter, *Request)&#125; æŽ¥å£ä¸­ServeHTTPå°±æ˜¯ç”¨æ¥å¤„ç†è¯·æ±‚çš„ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½ä¼šç»è¿‡è¿™ä¸ªæ–¹æ³•åŽ»å¤„ç†ã€‚é‚£ä¹ˆginæ˜¯æ€Žä¹ˆå®žçŽ°è¿™ä¸ªæ–¹æ³•çš„å‘¢ï¼Ÿè¿™ä¸ªå°±æ˜¯è°ƒç”¨è¿‡ç¨‹ï¼Œæ€»çš„æ¥è¯´å°±æ˜¯æ ¹æ®è¯·æ±‚çš„urlå’Œmethodæ‰¾åˆ°å¯¹åº”çš„handleåŽ»å¤„ç†ï¼Œè¿˜è®°å¾—ä¹‹å‰é‚£æ£µæ ‘å—ï¼Ÿå¯¹ï¼Œå°±æ˜¯åŽ»é‡Œé¢æ‰¾ã€‚åŒæ—¶åˆ©ç”¨contextè¿›è¡Œå‚æ•°ä¼ é€’ï¼Œæœ€åŽæ³¨æ„å¾ˆéšç§˜çš„ç”¨c.Nextè¿›è¡Œé€’å½’çš„è°ƒç”¨ï¼ˆæˆ‘å·²å¼€å§‹éƒ½æ²¡æ‰¾åˆ°ï¼‰ä¸ºå•¥è¦é€’å½’ï¼Ÿå› ä¸ºæœ‰ä¸­é—´ä»¶é¸­ï¼handleæ˜¯ä¸€ä¸ªé“¾å¼è¿‡ç¨‹è€Œéžåªæœ‰ä¸€ä¸ªhandle è‡³æ­¤æ‰€æœ‰ginçš„æ¡†æž¶é‡Œé¢çš„å†…å®¹åº”è¯¥éƒ½åŒ…æ‹¬äº†ï¼ŒåŒ…æ‹¬æ•´ä¸ªå®žçŽ°è¿‡ç¨‹ï¼Œå…¶å®žå¹¶ä¸å¤æ‚ï¼Œä½ å¯ä»¥æ ¹æ®ä¸Šé¢çš„è¿‡ç¨‹åœ¨æºç ä¸­æ‰¾åˆ°å¯¹åº”çš„åœ°æ–¹è¯¦ç»†æŸ¥çœ‹ã€‚ å¥½åœ¨å“ªé‡Œï¼Ÿæˆ‘ä»¬çœ‹æºç è‚¯å®šä¸èƒ½çœ‹å®Œï¼Œå“¦ï¼ŒçŸ¥é“æ€Žä¹ˆå®žçŽ°å°±å®Œäº‹äº†ï¼Œæˆ‘ä»¬æœ€ç»ˆçš„ç›®çš„æ˜¯è¦å­¦ä¹ å…¶ä¸­çš„ä¼˜ç‚¹ï¼Œé‚£ä¹ˆè¿™ä¸ªæ¡†æž¶æœ‰å“ªäº›å¥½çš„åœ°æ–¹å‘¢ï¼Ÿæˆ‘ä¸ªäººæ€»ç»“äº†ä»¥ä¸‹ä¸‰ç‚¹ä¾›ä½ å‚è€ƒã€‚ contextä½¿ç”¨contextåŒ…å«äº†Requestï¼ŒWriterç­‰ä¿¡æ¯ï¼Œç”¨å®ƒæ¥ä¼ é€’å‚æ•°ï¼Œä¹Ÿç®—æ˜¯åˆ©ç”¨golangçš„ä¸€ä¸ªç‰¹æ€§åŽ»åšçš„ï¼Œæˆ‘æ²¡æƒ³åˆ°ã€‚ sync.poolåˆ©ç”¨poolæ¥é‡å¤åˆ©ç”¨å¯¹è±¡ï¼Œå› ä¸ºè¯·æ±‚å¾ˆå¤šï¼Œæ‰€ä»¥ä¼šäº§ç”Ÿå¾ˆå¤šæ•°é‡çš„contextï¼Œåˆ©ç”¨sync.poolè¿›è¡Œå¤ç”¨ï¼Œä»Žè€Œå‡å°‘å†…å­˜çš„åˆ†é…ä¹Ÿæé«˜äº†æ•ˆçŽ‡ï¼Œå€¼å¾—å­¦ä¹ ã€‚ treesç”¨ä»€ä¹ˆæ•°æ®ç»“æž„å­˜æ”¾çš„urlå’Œhandleçš„æ˜ å°„å…³ç³»å‘¢ï¼Ÿæˆ‘ä¸€å¼€å§‹æƒ³åˆ°çš„å°±æ˜¯mapï¼Œç›´æŽ¥å¼„ä¸ªhashmapå­˜ä¸€ä¸‹ä¸å°±å¥½äº†å˜›ï¼Œæ²¡æƒ³åˆ°ginç”¨äº†ä¸€é¢—æ ‘æ¥è¿›è¡Œå­˜æ”¾ï¼Œå†…éƒ¨å®žçŽ°å¾ˆå¤æ‚ï¼Œè¿™é‡Œä¸åšå±•å¼€ï¼Œæ®è¯´æ˜¯radix treeï¼Œæˆ‘å°±æ˜¯æŠŠå®ƒç†è§£æˆå­—å…¸æ ‘ï¼Œä»Žè€Œæé«˜å­˜å‚¨å’ŒæŸ¥è¯¢ï¼Œæ£’ã€‚ æ€»ç»“å…¶å®žginæ¡†æž¶æœ¬èº«å®žçŽ°å¥½åƒå¹¶ä¸æ˜¯å¾ˆå¤æ‚ï¼Œå¾ˆé€‚åˆæ–°æ‰‹è¿›è¡Œå­¦ä¹ ï¼Œå…¶ä¸­ä¹Ÿæœ‰ä¸€äº›è®¾è®¡æ€æƒ³å¯ä»¥å€Ÿé‰´ã€‚]]></content>
      <categories>
        <category>gin</category>
      </categories>
      <tags>
        <tag>gin</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å›¾è§£goroutineè°ƒåº¦]]></title>
    <url>%2F2019%2F08%2F15%2Fgolang%2Fbasic%2Fgoroutine-dis%2F</url>
    <content type="text"><![CDATA[å…¶å®žè¿™ä¸ªè¯é¢˜æˆ‘æ—©å°±æƒ³åšäº†ï¼Œå¥ˆä½•è¿™ä¸ªé—®é¢˜ç¡®å®žæœ‰ç‚¹å¤æ‚ï¼Œçœ‹äº†å¾ˆå¤šæ–‡ç« æ‰æœ‰äº†ä¸€ç‚¹ç‚¹è‡ªå·±çš„ç†è§£ã€‚ä»Žgolangä¸€å¼€å§‹çš„ä½¿ç”¨æˆ‘å°±å·²ç»å¼€å§‹å¥½å¥‡äº†ï¼Œè¿™ä¸ªgoroutineåˆ°åº•æ˜¯æ€Žä¹ˆå®žçŽ°çš„å‘¢ï¼Ÿæ€Žä¹ˆå°±èƒ½æžå‡ºä¸€ä¸ªå’Œçº¿ç¨‹ç±»ä¼¼ï¼Œä½†æ˜¯æ€§èƒ½åˆé‚£ä¹ˆå¥½çš„ä¸œè¥¿çš„å‘¢ï¼Ÿ æ¨¡åž‹ä¸‰ä¸ªå°ä¼™å­åœ¨çœ‹æ•´ä½“ç»“æž„ä¹‹å‰ï¼Œæˆ‘å…ˆæ¥ä»‹ç»ä¸‰ä¸ªå°ä¼™å­ï¼Œgolangä¸ºäº†å®žçŽ°goroutineï¼Œå®šä¹‰äº†è¿™æ ·ä¸‰ä¸ªå°ä¼™å­ï¼Œè®©ä»–ä»¬å¸®å¿™åŽ»å®žçŽ°ã€‚ Gè¡¨ç¤ºgoroutineï¼Œå­˜å‚¨äº†goroutineçš„æ‰§è¡Œstackä¿¡æ¯ã€goroutineçŠ¶æ€ä»¥åŠgoroutineçš„ä»»åŠ¡å‡½æ•°ç­‰ï¼›å¦å¤–Gå¯¹è±¡æ˜¯å¯ä»¥é‡ç”¨çš„ã€‚ MMä»£è¡¨ç€çœŸæ­£çš„æ‰§è¡Œè®¡ç®—èµ„æºã€‚åœ¨ç»‘å®šæœ‰æ•ˆçš„PåŽï¼Œè¿›å…¥è°ƒåº¦å™¨å¾ªçŽ¯ï¼›è€Œè°ƒåº¦å™¨å¾ªçŽ¯çš„æœºåˆ¶å¤§è‡´æ˜¯ä»Žå„ç§é˜Ÿåˆ—ã€Pçš„æœ¬åœ°é˜Ÿåˆ—ä¸­èŽ·å–Gï¼Œåˆ‡æ¢åˆ°Gçš„æ‰§è¡Œæ ˆä¸Šå¹¶æ‰§è¡ŒGçš„å‡½æ•°ï¼Œè°ƒç”¨goexitåšæ¸…ç†å·¥ä½œå¹¶å›žåˆ°Mï¼Œå¦‚æ­¤åå¤ã€‚Må¹¶ä¸ä¿ç•™GçŠ¶æ€ï¼Œè¿™æ˜¯Gå¯ä»¥è·¨Mè°ƒåº¦çš„åŸºç¡€ã€‚ Pè¡¨ç¤ºé€»è¾‘processorï¼ŒPçš„æ•°é‡å†³å®šäº†ç³»ç»Ÿå†…æœ€å¤§å¯å¹¶è¡Œçš„Gçš„æ•°é‡ï¼ˆå‰æï¼šç³»ç»Ÿçš„ç‰©ç†cpuæ ¸æ•°&gt;=Pçš„æ•°é‡ï¼‰ï¼›Pçš„æœ€å¤§ä½œç”¨è¿˜æ˜¯å…¶æ‹¥æœ‰çš„å„ç§Gå¯¹è±¡é˜Ÿåˆ—ã€é“¾è¡¨ã€ä¸€äº›cacheå’ŒçŠ¶æ€ã€‚ æ•´ä½“ç»“æž„æ¨¡åž‹æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹é¢çš„è¿™å¼ å›¾ï¼Œä»Žå¤§ä½“ç»“æž„ä¸Šçœ‹ï¼Œæˆ‘ä»¬å°±èƒ½ç†è§£goroutineäº† çœ‹åˆ°è¿™ä¸ªå›¾ä½ åº”è¯¥ç†è§£äº†ä¸€åŠï¼Œä¸‹é¢æˆ‘æ¥è¯´æ˜Žä¸€ä¸‹ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨æ“ä½œç³»ç»Ÿçœ¼é‡Œå…¶å®žåªæœ‰cpuå’Œçº¿ç¨‹ï¼Œå®ƒåŽ»æŽ§åˆ¶ç€å„ä¸ªçº¿ç¨‹çš„è°ƒåº¦ï¼Œåˆ‡æ¢ï¼Œæ‰§è¡Œç­‰ç­‰ï¼Œè€Œå¯¹äºŽgoroutineçš„å®žçŽ°å…¶å®žéžå¸¸ç±»ä¼¼ï¼›åœ¨golangå±‚é¢ï¼Œé¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“ï¼Œæœ€ç»ˆåœ¨å¤–é¢æ‰§è¡Œçš„è‚¯å®šæ˜¯çº¿ç¨‹ï¼Œä½†æ˜¯æˆ‘ä»¬å†…éƒ¨å¼€å‡ºçš„é‚£äº›goroutineåˆ°å“ªé‡ŒåŽ»äº†å‘¢ï¼Ÿgolangæå‡ºGPMæ¨¡åž‹ï¼Œåœ¨Gçš„çœ¼é‡Œï¼Œåªæœ‰Pï¼ŒPä¿å­˜äº†éœ€è¦æ‰§è¡Œçš„é‚£äº›goroutineï¼›è€Œåœ¨æ•´ä¸ªgoè°ƒåº¦çš„å±‚é¢ï¼Œå¯¹å¤–çš„æ˜¯Mï¼ŒPä¼šæ‰¾åˆ°ä¸€ä¸ªMï¼Œè®©å®ƒåŽ»ä¸Žå¤–é¢çš„çº¿ç¨‹äº¤äº’ï¼Œä»Žè€ŒåŽ»çœŸæ­£æ‰§è¡Œç¨‹åºã€‚ä»Žè¿™é‡Œæˆ‘ä»¬å¯ä»¥å‘çŽ°ï¼Œå…¶å®žgoroutineçš„è°ƒåº¦å™¨æ•´ä¸ªå°±æ˜¯ä¸€ä¸ªå°åž‹çš„æ“ä½œç³»ç»Ÿï¼Œå†…éƒ¨åŽ»é€ å‡ºäº†ç±»ä¼¼çš„éƒ¨ä»¶åŽ»å®Œæˆgoroutineçš„å®žçŽ°ï¼Œè€Œå› ä¸ºæ˜¯åœ¨å†…éƒ¨å®žçŽ°ï¼Œæ‰€ä»¥è§£å†³äº†æ“ä½œç³»ç»Ÿå±‚é¢æ‰€å¸¦æ¥çš„çº¿ç¨‹åˆ›å»ºæ…¢ç­‰é—®é¢˜ã€‚ ä½†æ˜¯ï¼ŒåŒæ—¶è¿™æ ·çš„è°ƒåº¦ä¹Ÿä¼šæœ‰é—®é¢˜ï¼Œæ‰€ä»¥éœ€è¦ä¸€äº›é¢å¤–çš„æŽªæ–½ï¼ è°ƒåº¦ä¸­çš„é—®é¢˜é—®é¢˜1 Gä¸å‡æˆ‘ä»¬çŸ¥é“ï¼ŒçŽ°å®žæƒ…å†µæœ‰çš„goroutineè¿è¡Œçš„å¿«ï¼Œæœ‰çš„æ…¢ï¼Œé‚£ä¹ˆåŠ¿å¿…è‚¯å®šä¼šå¸¦æ¥çš„é—®é¢˜å°±æ˜¯ï¼Œå¿™çš„å¿™æ­»ï¼Œé—²çš„é—²æ­»ï¼Œgoè‚¯å®šä¸å…è®¸æ‘¸é±¼çš„På­˜åœ¨ï¼ŒåŠ¿å¿…è¦æ¦¨å¹²æ‰€æœ‰åŠ³åŠ¨åŠ›ã€‚å¦‚æžœä½ æ²¡æœ‰ä»»åŠ¡ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬çœ‹åˆ°æ¨¡åž‹ä¸­è¿˜æœ‰ä¸€ä¸ªå…¨å±€Gé˜Ÿåˆ—çš„å­˜åœ¨ï¼Œå¦‚æœ¬åœ°é˜Ÿåˆ—å·²æ»¡ï¼Œä¼šä¸€æ¬¡æ€§è½¬ç§»åŠæ•°åˆ°å…¨å±€é˜Ÿåˆ—ã€‚å…¶ä»–é—²çš„å°ä¼™å­å°±ä¼šä»Žå…¨å±€é˜Ÿåˆ—ä¸­æ‹¿ï¼›ï¼ˆé¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œä¼˜å…ˆçº§æ˜¯å…ˆæ‹¿ä¸‹ä¸€ä¸ªéœ€è¦æ‰§è¡Œçš„ï¼Œç„¶åŽåŽ»æœ¬åœ°é˜Ÿåˆ—ä¸­æ‹¿ï¼Œå†åŽ»å…¨å±€é˜Ÿåˆ—ä¸­æ‹¿ï¼Œå…ˆæŠŠè‡ªå·±çš„åšå®Œå†åšåˆ«äººçš„å˜›ï¼‰åŒæ—¶å¦‚æžœå…¨å±€éƒ½æ²¡æœ‰äº†ï¼Œå°±ä¼šåŽ»æŠ¢åˆ«äººçš„åšã€‚ é—®é¢˜2 ä»»åŠ¡å¡ä¸»äº†ä¸‡ä¸€æœ‰ä¸ªç¨‹åºå‘˜å¯åŠ¨ä¸€ä¸ªgoroutineåŽ»æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œç„¶åŽè¿™ä¸ªä»»åŠ¡ä¸€ç›´ç¡è§‰ï¼ˆsleepï¼‰å°±æ˜¯å¾ªçŽ¯ç¡è§‰ï¼Œé‚£å’‹åŠžå˜›ï¼ä½ ä½œä¸ºæ‰§è¡Œäººï¼Œä½ æ€»ä¸èƒ½è¯´ï¼Œè®©å®ƒä¸€ç›´å ç”¨ç€ä¸€æ•´ä¸ªçº¿ç¨‹çš„èµ„æºï¼Œç„¶åŽåŽé¢çš„goroutineéƒ½å¡ä¸»äº†ï¼Œé‚£å¦‚æžœåªæœ‰ä¸€ä¸ªæ ¸å¿ƒPï¼Œä¸å°±å®Œè›‹äº†ï¼Ÿèªæ˜Žçš„goæ‰ä¸ä¼šé‚£ä¹ˆå‚»ï¼Œå®ƒé‡‡ç”¨äº†æŠ¢å å¼è°ƒåº¦æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚åªè¦ä½ è¿™ä¸ªä»»åŠ¡æ‰§è¡Œè¶…è¿‡ä¸€å®šçš„æ—¶é—´ï¼ˆ10msï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªä»»åŠ¡å°±ä¼šè¢«æ ‡è¯†ä¸ºå¯æŠ¢å çš„ï¼Œé‚£ä¹ˆåˆ«çš„goroutineå°±å¯ä»¥æŠ¢å…ˆè¿›æ¥æ‰§è¡Œã€‚åªè¦ä¸‹æ¬¡è¿™ä¸ªgoroutineè¿›è¡Œå‡½æ•°è°ƒç”¨ï¼Œé‚£ä¹ˆå°±ä¼šè¢«å¼ºå ï¼ŒåŒæ—¶ä¹Ÿä¼šä¿æŠ¤çŽ°åœºï¼Œç„¶åŽé‡æ–°æ”¾å…¥Pçš„æœ¬åœ°é˜Ÿåˆ—é‡Œé¢ç­‰å¾…ä¸‹æ¬¡æ‰§è¡Œã€‚è°æ¥åšçš„å‘¢ï¼Ÿsysmonï¼Œå°±æ˜¯è¿™ä¸ªèƒŒåŽé»˜é»˜ä»˜å‡ºçš„äººï¼Œå®ƒæ˜¯ä¸€ä¸ªåŽå°è¿è¡Œçš„ç›‘æŽ§çº¿ç¨‹ï¼Œå®ƒæ¥ç›‘æŽ§é‚£äº›é•¿æ—¶é—´è¿è¡Œçš„Gä»»åŠ¡ç„¶åŽè®¾ç½®å¯ä»¥å¼ºå çš„æ ‡è¯†ç¬¦ã€‚ï¼ˆåŒæ—¶é¡ºä¾¿æä¸€ä¸‹ï¼Œå®ƒè¿˜ä¼šåšçš„ä¸€äº›äº‹æƒ…ï¼Œä¾‹å¦‚ï¼Œé‡Šæ”¾é—²ç½®çš„spanå†…å­˜ï¼Œ2åˆ†é’Ÿçš„é»˜è®¤gcç­‰ï¼‰ é—®é¢˜3 é˜»å¡žå¯æ€Žä¹ˆåŠžï¼Ÿæˆ‘ä»¬ç»å¸¸ä½¿ç”¨goroutineè¿˜æœ‰ä¸€ä¸ªåœºæ™¯å°±æ˜¯ç½‘ç»œè¯·æ±‚å’ŒIOæ“ä½œï¼Œè¿™ç§é˜»å¡žçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„Gå’ŒMåˆä¼šæ€Žä¹ˆåšå‘¢ï¼Ÿè¿™ä¸ªæ—¶å€™æœ‰ä¸ªå«åšnetpollerçš„ä¸œè¥¿å‡ºçŽ°äº†ï¼Œå½“æ¯æ¬¡æœ‰ä¸€ä¸ªç½‘ç»œè¯·æ±‚é˜»å¡žçš„æ—¶å€™ï¼Œå¦‚æžœæŒ‰ç…§åŽŸæ¥çš„æ–¹æ³•è¿™ä¸ªæ—¶å€™è¿™ä¸ªè¯·æ±‚ä¼šé˜»å¡žçº¿ç¨‹ï¼Œè€Œæœ‰äº†netpollerè¿™ä¸ªä¸œè¥¿ï¼Œå¯ä»¥å°†è¯·æ±‚é˜»å¡žåˆ°goroutineã€‚æ„æ€æ˜¯è¯´ï¼Œå½“é˜»å¡žå‡ºçŽ°çš„æ—¶å€™ï¼Œå½“å‰goroutineä¼šè¢«é˜»å¡žï¼Œç­‰å¾…é˜»å¡žnotifyï¼Œè€Œæ”¾å‡ºMåŽ»åšåˆ«çš„gï¼Œè€Œå½“é˜»å¡žæ¢å¤çš„æ—¶å€™ï¼Œnetpollerå°±ä¼šé€šçŸ¥å¯¹åº”çš„må¯ä»¥åšåŽŸæ¥çš„gäº†ã€‚åŒæ—¶è¿˜è¦é¡ºä¾¿æä¸€å¥ï¼Œå½“På‘çŽ°æ²¡æœ‰ä»»åŠ¡çš„æ—¶å€™ï¼Œé™¤äº†ä¼šæ‰¾æœ¬åœ°å’Œå…¨å±€ï¼Œä¹Ÿä¼šåŽ»netpollä¸­æ‰¾ã€‚ é—®é¢˜4 ç³»ç»Ÿæ–¹æ³•è°ƒç”¨é˜»å¡žï¼Ÿè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬è‡ªå·±æƒ³å¯èƒ½æ¯”è¾ƒéš¾æƒ³åˆ°ï¼Œå°±æ˜¯å½“è°ƒç”¨ä¸€äº›ç³»ç»Ÿæ–¹æ³•çš„æ—¶å€™ï¼Œå¦‚æžœç³»ç»Ÿæ–¹æ³•è°ƒç”¨çš„æ—¶å€™å‘ç”Ÿé˜»å¡žå°±æ¯”è¾ƒéº»çƒ¦äº†ã€‚ä¸‹é¢å¼•ç”¨ä¸€æ®µè¯ï¼šå½“Gè¢«é˜»å¡žåœ¨æŸä¸ªç³»ç»Ÿè°ƒç”¨ä¸Šæ—¶ï¼Œæ­¤æ—¶Gä¼šé˜»å¡žåœ¨_GsyscallçŠ¶æ€ï¼ŒMä¹Ÿå¤„äºŽblock on syscallçŠ¶æ€ï¼Œæ­¤æ—¶çš„Må¯è¢«æŠ¢å è°ƒåº¦ï¼šæ‰§è¡Œè¯¥Gçš„Mä¼šä¸ŽPè§£ç»‘ï¼Œè€ŒPåˆ™å°è¯•ä¸Žå…¶å®ƒidleçš„Mç»‘å®šï¼Œç»§ç»­æ‰§è¡Œå…¶å®ƒGã€‚å¦‚æžœæ²¡æœ‰å…¶å®ƒidleçš„Mï¼Œä½†Pçš„Localé˜Ÿåˆ—ä¸­ä»ç„¶æœ‰Géœ€è¦æ‰§è¡Œï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„Mï¼›å½“ç³»ç»Ÿè°ƒç”¨å®ŒæˆåŽï¼ŒGä¼šé‡æ–°å°è¯•èŽ·å–ä¸€ä¸ªidleçš„Pè¿›å…¥å®ƒçš„Localé˜Ÿåˆ—æ¢å¤æ‰§è¡Œï¼Œå¦‚æžœæ²¡æœ‰idleçš„Pï¼ŒGä¼šè¢«æ ‡è®°ä¸ºrunnableåŠ å…¥åˆ°Globalé˜Ÿåˆ—ã€‚ æºç ä¸€çž¥12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394struct G&#123; uintptr stackguard; // åˆ†æ®µæ ˆçš„å¯ç”¨ç©ºé—´ä¸‹ç•Œ uintptr stackbase; // åˆ†æ®µæ ˆçš„æ ˆåŸºå€ Gobuf sched; //è¿›ç¨‹åˆ‡æ¢æ—¶ï¼Œåˆ©ç”¨schedåŸŸæ¥ä¿å­˜ä¸Šä¸‹æ–‡ uintptr stack0; FuncVal* fnstart; // goroutineè¿è¡Œçš„å‡½æ•° void* param; // ç”¨äºŽä¼ é€’å‚æ•°ï¼Œç¡çœ æ—¶å…¶å®ƒgoroutineè®¾ç½®paramï¼Œå”¤é†’æ—¶æ­¤goroutineå¯ä»¥èŽ·å– int16 status; // çŠ¶æ€Gidle,Grunnable,Grunning,Gsyscall,Gwaiting,Gdead int64 goid; // goroutineçš„idå· G* schedlink; M* m; // for debuggers, but offset not hard-coded M* lockedm; // Gè¢«é”å®šåªèƒ½åœ¨è¿™ä¸ªmä¸Šè¿è¡Œ uintptr gopc; // åˆ›å»ºè¿™ä¸ªgoroutineçš„goè¡¨è¾¾å¼çš„pc ...&#125;;struct M&#123; G* g0; // å¸¦æœ‰è°ƒåº¦æ ˆçš„goroutine G* gsignal; // signal-handling G å¤„ç†ä¿¡å·çš„goroutine void (*mstartfn)(void); G* curg; // Mä¸­å½“å‰è¿è¡Œçš„goroutine P* p; // å…³è”Pä»¥æ‰§è¡ŒGoä»£ç  (å¦‚æžœæ²¡æœ‰æ‰§è¡ŒGoä»£ç åˆ™Pä¸ºnil) P* nextp; int32 id; int32 mallocing; //çŠ¶æ€ int32 throwing; int32 gcing; int32 locks; int32 helpgc; //ä¸ä¸º0è¡¨ç¤ºæ­¤måœ¨åšå¸®å¿™gcã€‚helpgcç­‰äºŽnåªæ˜¯ä¸€ä¸ªç¼–å· bool blockingsyscall; bool spinning; Note park; M* alllink; // è¿™ä¸ªåŸŸç”¨äºŽé“¾æŽ¥allm M* schedlink; MCache *mcache; G* lockedg; M* nextwaitm; // next M waiting for lock GCStats gcstats; ...&#125;;struct P&#123; Lock; uint32 status; // Pidleæˆ–Prunningç­‰ P* link; uint32 schedtick; // æ¯æ¬¡è°ƒåº¦æ—¶å°†å®ƒåŠ ä¸€ M* m; // é“¾æŽ¥åˆ°å®ƒå…³è”çš„M (nil if idle) MCache* mcache; G* runq[256]; int32 runqhead; int32 runqtail; // Available G's (status == Gdead) G* gfree; int32 gfreecnt; byte pad[64];&#125;;struct Sched &#123; Lock; uint64 goidgen; M* midle; // idle m's waiting for work int32 nmidle; // number of idle m's waiting for work int32 nmidlelocked; // number of locked m's waiting for work int3 mcount; // number of m's that have been created int32 maxmcount; // maximum number of m's allowed (or die) P* pidle; // idle P's uint32 npidle; //idle Pçš„æ•°é‡ uint32 nmspinning; // Global runnable queue. G* runqhead; G* runqtail; int32 runqsize; // Global cache of dead G's. Lock gflock; G* gfree; int32 stopwait; Note stopnote; uint32 sysmonwait; Note sysmonnote; uint64 lastpoll; int32 profilehz; // cpu profiling rate&#125; æ€»ç»“goroutineçš„è®¾è®¡æ€»çš„æ¥è¯´å°±æ˜¯å‚è€ƒæ“ä½œç³»ç»Ÿçš„è®¾è®¡ï¼Œæ‰€æœ‰çš„ç›®çš„å¾ˆæ˜Žç¡®å°±æ˜¯ä¸ºäº†åœ¨æ•´ä¸ªè¿è¡Œè¿‡ç¨‹ä¸­èƒ½å……åˆ†åˆ©ç”¨å·²æœ‰çš„èµ„æºï¼Œå°½å¯èƒ½åœ¨æœ‰é™çš„èµ„æºé‡Œé¢å¤šåšäº‹æƒ…ï¼Œåˆ©ç”¨gpmçš„æ¨¡åž‹ä»¥åŠä¸€äº›netpollerã€sysmonç­‰å¸®åŠ©åœ¨é˜»å¡žçš„æ—¶å€™ä¹Ÿèƒ½åˆç†åˆ©ç”¨èµ„æºï¼Œä»Žè€Œè¾¾åˆ°æˆ‘ä»¬çŽ°åœ¨é«˜æ•ˆçš„goroutine å‚è€ƒèµ„æ–™ï¼šhttps://tiancaiamao.gitbooks.io/go-internals/content/zh/05.1.htmlhttp://morsmachine.dk/go-schedulerhttp://morsmachine.dk/netpollerhttps://studygolang.com/articles/10116]]></content>
      <categories>
        <category>golangåŸºç¡€</category>
      </categories>
      <tags>
        <tag>goroutine</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Golangçš„interface]]></title>
    <url>%2F2019%2F08%2F10%2Fgolang%2Fsource-code%2Finterface-source-code%2F</url>
    <content type="text"><![CDATA[ç”±äºŽgolangä¸­è¯´interfaceçš„æ–‡ç« å¤ªå¤šäº†ï¼Œå¾ˆå¤šéƒ½å·²ç»è¯´çš„å¾ˆç»†èŠ‚äº†ï¼Œæ‰€ä»¥æˆ‘å†è¯´æ„Ÿè§‰ä¹Ÿæœ‰ç‚¹éš¾ã€‚äºŽæ˜¯æ€»ç»“å‡ºå‡ ä¸ªå…³é”®é—®é¢˜ï¼Œä¾›ä½ å‚è€ƒï¼Œå¦‚æžœèƒ½åšåˆ°å‡†ç¡®æ— è¯¯æœ‰ç†æœ‰æ®çš„å›žç­”ï¼Œé‚£ä¹ˆinterfaceåº”è¯¥æ˜¯æ²¡æœ‰é—®é¢˜äº†ã€‚ é—®é¢˜ interfaceåº•å±‚ç»“æž„æœ‰å“ªä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œé‡Œé¢ä¿å­˜äº†å“ªäº›ä¿¡æ¯ï¼Ÿ å…¶ä¸­tabæ˜¯ä»€ä¹ˆæ—¶å€™ç”Ÿæˆçš„ï¼Ÿ ä»Žåˆ«çš„ç±»åž‹è½¬æ¢æˆinterfaceï¼Œä»Žinterfaceè½¬æ¢æˆåˆ«çš„ç±»åž‹ï¼Œè¿™ä¸¤è€…çš„è¿‡ç¨‹æ˜¯æ€Žä¹ˆæ ·çš„ï¼Ÿ ä¸¤ä¸ªinterfaceä¹‹é—´æ˜¯å¦å¯ä»¥æ¯”è¾ƒï¼Ÿ golangåº•å±‚æ˜¯å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªç±»åž‹æ˜¯å¦å®žçŽ°äº†ä¸€ä¸ªinterfaceï¼Ÿ 1ã€åº•å±‚ç»“æž„12345678910111213141516171819202122232425262728293031type eface struct &#123; // 16 bytes on a 64bit arch _type *_type data unsafe.Pointer&#125;type iface struct &#123; // 16 bytes on a 64bit arch tab *itab data unsafe.Pointer&#125;type itab struct &#123; // 40 bytes on a 64bit arch inter *interfacetype _type *_type hash uint32 // copy of _type.hash. Used for type switches. _ [4]byte fun [1]uintptr // variable sized. fun[0]==0 means _type does not implement inter.&#125;type _type struct &#123; // 48 bytes on a 64bit arch size uintptr ptrdata uintptr // size of memory prefix holding all pointers hash uint32 tflag tflag align uint8 fieldalign uint8 kind uint8 alg *typeAlg // gcdata stores the GC type data for the garbage collector. // If the KindGCProg bit is set in kind, gcdata is a GC program. // Otherwise it is a ptrmask bitmap. See mbitmap.go for details. gcdata *byte str nameOff ptrToThis typeOff&#125; https://draveness.me/golang/basic/golang-interface.html 2ã€tabtabç»“æž„æ˜¯itabï¼Œé‡Œé¢åŒ…å«äº†interfacetypeï¼Œ_typeï¼Œfunï¼Œç¼–è¯‘æœŸç”Ÿæˆã€‚https://github.com/teh-cmc/go-internals/blob/master/chapter2_interfaces/README.md 3ã€ç±»åž‹è½¬æ¢ç”±å…¶ä»–ç±»åž‹è½¬æ¢æˆinterfaceè½¬efaceè½¬ç©ºæŽ¥å£ï¼Œå¾ˆç®€å•ï¼Œå°†Efaceä¸­çš„dataæŒ‡é’ˆæŒ‡å‘åŽŸåž‹æ•°æ®ï¼ŒtypeæŒ‡é’ˆä¼šæŒ‡å‘æ•°æ®çš„Typeç»“æž„ä½“ã€‚ è½¬ifaceä¸Žefaceç›¸åŒï¼Œä½†æ˜¯éœ€è¦èµ‹å€¼åˆ°itabï¼Œå¹¶ä¸”éœ€è¦åšæ£€æµ‹ï¼Œåªæœ‰å®žçŽ°æŽ¥å£æ‰€æœ‰æ–¹æ³•æ‰å¯ä»¥è¿›è¡Œè½¬æ¢ã€‚ interfaceè½¬å…¶ä»–ç±»åž‹é‚£æ²¡è¯è¯´ï¼Œç›´æŽ¥åå°„èµ°èµ·æœ‰è¿™æ ·çš„è¯­æ³•è§£å†³v, ok := i.(T)è½¬æ¢çš„æ—¶å€™ä¹Ÿéœ€è¦æ¯”è¾ƒèƒ½å¦è¿›è¡Œè½¬æ¢ 4ã€ç±»åž‹æ¯”è¾ƒä¸¤ä¸ªinterfaceæ˜¯å¯ä»¥æ¯”è¾ƒçš„ï¼Œhttp://docs.studygolang.com/ref/spec#Comparison_operatorså…¶ä¸­è¯´åˆ°Interface values are comparable. Two interface values are equal if they have identical dynamic types and equal dynamic values or if both have value nil.åªè¦ä¸¤ä¸ªinterfaceçš„åŠ¨æ€ç±»åž‹ç›¸åŒå’Œå€¼ç›¸åŒå°±å¯ä»¥ã€‚ 5ã€åˆ¤æ–­å®žçŽ°è¿™ä¸ªåˆ¤æ–­å…¶å®žåœ¨æ£€æµ‹çš„æ—¶å€™éƒ½éœ€è¦ç”¨åˆ°ã€‚æ£€æµ‹å°±æ˜¯çœ‹Typeä¸­çš„æ–¹æ³•è¡¨æ˜¯å¦åŒ…å«äº†InterfaceTypeçš„æ–¹æ³•è¡¨ä¸­çš„æ‰€æœ‰æ–¹æ³•ï¼Œå¹¶æŠŠTypeæ–¹æ³•è¡¨ä¸­çš„å®žçŽ°éƒ¨åˆ†æ‹·åˆ°Itabçš„funcé‚£å¼ è¡¨ä¸­ã€‚å…¶ä¸­è¡¨ä¸­çš„æ•°æ®éƒ½æ˜¯æŽ’åºè¿‡çš„ï¼Œæ‰€ä»¥å¯¹æ¯”èµ·æ¥å¿«ã€‚https://tiancaiamao.gitbooks.io/go-internals/content/zh/07.2.html]]></content>
      <categories>
        <category>golangæºç è§£æž</category>
      </categories>
      <tags>
        <tag>interface</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Golangä¹‹channel]]></title>
    <url>%2F2019%2F08%2F05%2Fgolang%2Fsource-code%2Fchannel-source-code%2F</url>
    <content type="text"><![CDATA[goä¸­çš„ä¸€ä¸ªç²¾é«“å°±æ˜¯å°±æ˜¯channelï¼Œé‚£ä¹ˆä½ æœ‰æ²¡æœ‰æƒ³è¿‡ï¼Œå®ƒç©¶ç«Ÿæ˜¯æ€Žä¹ˆå®žçŽ°çš„å‘¢ï¼Ÿæˆ‘ä¹‹å‰å°±æ€€ç–‘è¿‡ï¼Œæ˜¯ä¸æ˜¯å°±æ˜¯é€šè¿‡ä¸€ä¸ªæ•°ç»„ä¿å­˜äº†ä¸€ä¸‹ä¼ å…¥çš„æ•°æ®ï¼Œç„¶åŽåœ¨æŽ¥æ”¶æ–¹è¯»ä¸€è¯»å°±å®Œäº‹äº†ï¼Œé‚£ä¹ˆé˜»å¡žåˆæ˜¯æ€Žä¹ˆå®žçŽ°çš„å‘¢ï¼Ÿcloseçš„æ—¶å€™éœ€è¦æ³¨æ„äº›ä»€ä¹ˆå‘¢ï¼Ÿ ç»“æž„é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹channelçš„ç»“æž„æ˜¯æ€Žä¹ˆæ ·çš„ã€‚1234567891011121314151617181920type hchan struct &#123; qcount uint // total data in the queue dataqsiz uint // size of the circular queue buf unsafe.Pointer // points to an array of dataqsiz elements elemsize uint16 closed uint32 elemtype *_type // element type sendx uint // send index recvx uint // receive index recvq waitq // list of recv waiters sendq waitq // list of send waiters // lock protects all fields in hchan, as well as several // fields in sudogs blocked on this channel. // // Do not change another G's status while holding this lock // (in particular, do not ready a G), as this can deadlock // with stack shrinking. lock mutex&#125; å…¶å®žçœ‹æ³¨é‡Šè¿™å‡ ä¸ªå­—æ®µéƒ½éžå¸¸å¥½ç†è§£ï¼Œè§£é‡Šä¸€ä¸‹å…¶ä¸­å‡ ä¸ªï¼šelemtypeæ˜¯è¡¨ç¤ºè¿™ä¸ªchannelä¸­å­˜æ”¾çš„æ˜¯ä»€ä¹ˆç±»åž‹çš„æ•°æ®ï¼›sendxã€recvxä¸¤ä¸ªç´¢å¼•æŒ‡å‘åº•å±‚å¾ªçŽ¯æ•°ç»„recvqã€sendqä¸¤ä¸ªåŒå‘é“¾è¡¨ä¿å­˜é‚£äº›ç­‰å¾…çš„goroutinelockï¼Ÿå¯¹å°±æ˜¯lockï¼Œä¸ç„¶ä½ ä»¥ä¸ºå¹¶å‘çš„æ—¶å€™channelæ€Žä¹ˆåŠžï¼Ÿé”å‘—ã€‚ PS: å…¶å®žå’Œæˆ‘ä¸€å¼€å§‹æƒ³çš„å·®ä¸å¤šï¼Œåº•å±‚å°±æ˜¯åˆ©ç”¨ä¸€ä¸ªå¾ªçŽ¯æ•°ç»„æ¥å®žçŽ°çš„å¸¦æœ‰ç¼“å†²çš„channelï¼Œåˆ©ç”¨ä¸¤ä¸ªindexæ ‡è®°çš„ç§»åŠ¨æ¥è®°å½•å‘é€å’Œè¯»å–ï¼Œç„¶åŽç”¨ä¸€ä¸ªè®¡æ•°å™¨è¡¨ç¤ºå½“å‰è¿˜æœ‰å¤šå°‘ä¸ªå…ƒç´ ï¼Œeasy ä½†æ˜¯å¦‚æžœä½ æƒ³ç€goåªæœ‰è¿™ä¹ˆç‚¹ä¸œè¥¿ï¼Œé‚£ä½ å°±å¤ªå°çœ‹å®ƒäº†ï¼Œç»†èŠ‚èƒ½æŠŠä½ çœ‹å“­ï¼Œå˜¿å˜¿å˜¿ï¼Œä¸‹é¢æ¥çœ‹çœ‹æºç ä¸­å…·ä½“çš„æŽ¥æ”¶å’Œå‘é€æ˜¯æ€Žä¹ˆå®žçŽ°çš„ã€‚ å®žçŽ°æœ¬è´¨ï¼šchannelå‘é€æŽ¥æ”¶æ•°æ®çš„æœ¬è´¨æ˜¯æ•°æ®æ‹·è´ï¼ æŽ¥æ”¶æˆ‘ä¼šåˆ é™¤å…¶ä¸­ä¸€äº›ç»†èŠ‚éƒ¨åˆ†ï¼Œç•™ä¸‹å…¶ä¸­é‡è¦çš„ç‚¹çœ‹ä¸€ä¸‹ï¼Œå¦‚æžœå¸Œæœ›çœ‹åˆ°å…¨éƒ¨ï¼Œè¯·è‡ªè¡Œé˜…è¯»æºç ã€‚123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293func chanrecv(c *hchan, ep unsafe.Pointer, block bool) (selected, received bool) &#123; // ...... // å¦‚æžœæ”¶ä¸€ä¸ªnilçš„channelä¸ä¼španicçš„ï¼Œè€Œæ˜¯è¢«é˜»å¡žï¼Œgoparkå°±æ˜¯å°†å½“å‰goroutineé˜»å¡ž if c == nil &#123; if !block &#123; return &#125; gopark(nil, nil, "chan receive (nil chan)", traceEvGoStop, 2) throw("unreachable") &#125; // ...... // åŠ é”å“¦ï¼é˜²æ­¢å¹¶æ“ä½œchannel lock(&amp;c.lock) // å¤„ç†å…³é—­çš„æƒ…å†µå’Œæ— dataçš„æƒ…å†µ if c.closed != 0 &amp;&amp; c.qcount == 0 &#123; if raceenabled &#123; raceacquire(unsafe.Pointer(c)) &#125; unlock(&amp;c.lock) if ep != nil &#123; typedmemclr(c.elemtype, ep) &#125; return true, false &#125; // å½“æ— ç¼“å†² æˆ–è€… æ˜¯æœ‰ç¼“å†²ä½†æ˜¯ç¼“å†²æ»¡äº† è¿™ä¸¤ç§æƒ…å†µä¸‹åŽ»recv if sg := c.sendq.dequeue(); sg != nil &#123; recv(c, sg, ep, func() &#123; unlock(&amp;c.lock) &#125;, 3) return true, true &#125; // å‰©ä¸‹çš„æƒ…å†µå°±æ˜¯æœ‰ç¼“å†²çš„æƒ…å†µï¼Œå¦‚æžœæœ‰æ•°æ®çš„è¯è¿›ifé‡Œé¢ï¼Œé‡Œé¢å…¶å®žå°±æ˜¯å°†ç¼“å†²ä¸­çš„æ•°æ®æ‹¿å‡ºæ¥ï¼Œå¹¶ä¸”ç§»åŠ¨ç›¸å¯¹åº”çš„ç´¢å¼•ï¼Œå‡å°‘qcount if c.qcount &gt; 0 &#123; // Receive directly from queue qp := chanbuf(c, c.recvx) if raceenabled &#123; raceacquire(qp) racerelease(qp) &#125; if ep != nil &#123; typedmemmove(c.elemtype, ep, qp) &#125; typedmemclr(c.elemtype, qp) c.recvx++ if c.recvx == c.dataqsiz &#123; c.recvx = 0 &#125; c.qcount-- unlock(&amp;c.lock) return true, true &#125; if !block &#123; unlock(&amp;c.lock) return false, false &#125; // å¦‚æžœå½“å‰æ²¡æœ‰æ•°æ®ï¼Œé‚£ä¹ˆåªèƒ½é˜»å¡žå’¯ // no sender available: block on this channel. gp := getg() mysg := acquireSudog() mysg.releasetime = 0 if t0 != 0 &#123; mysg.releasetime = -1 &#125; // No stack splits between assigning elem and enqueuing mysg // on gp.waiting where copystack can find it. mysg.elem = ep mysg.waitlink = nil gp.waiting = mysg mysg.g = gp mysg.isSelect = false mysg.c = c gp.param = nil c.recvq.enqueue(mysg) goparkunlock(&amp;c.lock, "chan receive", traceEvGoBlockRecv, 3) // someone woke us up if mysg != gp.waiting &#123; throw("G waiting list is corrupted") &#125; gp.waiting = nil if mysg.releasetime &gt; 0 &#123; blockevent(mysg.releasetime-t0, 2) &#125; closed := gp.param == nil gp.param = nil mysg.c = nil releaseSudog(mysg) return true, !closed&#125; å‘é€å‘é€å…¶å®žå’ŒæŽ¥å—å¼‚æ›²åŒå·¥ï¼Œä¹Ÿæ˜¯å¤„ç†å…¶ä¸­å‡ ç§æƒ…å†µ123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596func chansend(c *hchan, ep unsafe.Pointer, block bool, callerpc uintptr) bool &#123; // å‘ç»™ä¸€ä¸ªnilçš„channelå°±panicå‘— if c == nil &#123; if !block &#123; return false &#125; gopark(nil, nil, "chan send (nil chan)", traceEvGoStop, 2) throw("unreachable") &#125; // ...... // å¦‚æžœ // ä¸æ˜¯ç¼“å†²çš„channelè€Œä¸”æ²¡æœ‰æŽ¥å—è€…æ­£åœ¨æŽ¥å— // æ˜¯ç¼“å†²çš„channelä½†æ˜¯ç¼“å†²æ»¡äº† // é‚£å°±ç›´æŽ¥è¿”å›ž if !block &amp;&amp; c.closed == 0 &amp;&amp; ((c.dataqsiz == 0 &amp;&amp; c.recvq.first == nil) || (c.dataqsiz &gt; 0 &amp;&amp; c.qcount == c.dataqsiz)) &#123; return false &#125; // ...... // åŠ é”ï¼ lock(&amp;c.lock) // å¦‚æžœåŠ é”å®Œäº†ä¹‹åŽå‘çŽ°è¢«å…³äº†ï¼Œè¦æ­»ï¼Œç›´æŽ¥è§£é”å¹¶panic if c.closed != 0 &#123; unlock(&amp;c.lock) panic(plainError("send on closed channel")) &#125; // å½“æœ‰æŽ¥æ”¶è€…ï¼Œé‚£å°±ç›´æŽ¥å‘ç»™å®ƒå°±å¥½äº† if sg := c.recvq.dequeue(); sg != nil &#123; send(c, sg, ep, func() &#123; unlock(&amp;c.lock) &#125;, 3) return true &#125; // å¦‚æžœæ˜¯ç¼“å†²çš„ï¼Œè€Œä¸”è¿˜æœ‰ç©ºé—´ï¼Œé‚£ä¹ˆä¹…æ”¾åˆ°ç¼“å†²é‡Œé¢åŽ»ï¼Œç§»åŠ¨å¯¹åº”çš„ç´¢å¼• if c.qcount &lt; c.dataqsiz &#123; // Space is available in the channel buffer. Enqueue the element to send. qp := chanbuf(c, c.sendx) if raceenabled &#123; raceacquire(qp) racerelease(qp) &#125; typedmemmove(c.elemtype, qp, ep) c.sendx++ if c.sendx == c.dataqsiz &#123; c.sendx = 0 &#125; c.qcount++ unlock(&amp;c.lock) return true &#125; if !block &#123; unlock(&amp;c.lock) return false &#125; // å½“æ²¡æœ‰ç¼“å†²äº†ï¼Œé‚£ä¹ˆå°±éœ€è¦é˜»å¡žå‘é€äººäº† gp := getg() mysg := acquireSudog() mysg.releasetime = 0 if t0 != 0 &#123; mysg.releasetime = -1 &#125; // No stack splits between assigning elem and enqueuing mysg // on gp.waiting where copystack can find it. mysg.elem = ep mysg.waitlink = nil mysg.g = gp mysg.isSelect = false mysg.c = c gp.waiting = mysg gp.param = nil c.sendq.enqueue(mysg) goparkunlock(&amp;c.lock, "chan send", traceEvGoBlockSend, 3) // someone woke us up. if mysg != gp.waiting &#123; throw("G waiting list is corrupted") &#125; gp.waiting = nil if gp.param == nil &#123; if c.closed == 0 &#123; throw("chansend: spurious wakeup") &#125; panic(plainError("send on closed channel")) &#125; gp.param = nil if mysg.releasetime &gt; 0 &#123; blockevent(mysg.releasetime-t0, 2) &#125; mysg.c = nil releaseSudog(mysg) return true&#125; å…³é—­12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576func closechan(c *hchan) &#123; // å…³é—­ä¸€ä¸ªnilçš„channel é‚£å°±panic if c == nil &#123; panic(plainError("close of nil channel")) &#125; // å…³é—­ä¹Ÿæ˜¯è¦åŠ é”çš„ï¼ lock(&amp;c.lock) if c.closed != 0 &#123; unlock(&amp;c.lock) panic(plainError("close of closed channel")) &#125; if raceenabled &#123; callerpc := getcallerpc() racewritepc(unsafe.Pointer(c), callerpc, funcPC(closechan)) racerelease(unsafe.Pointer(c)) &#125; // è®¾ç½®æ ‡å¿— c.closed = 1 var glist *g // å¤„ç†æ‰€æœ‰çš„æŽ¥æ”¶è€…ï¼Œæ³¨æ„å³ä½¿å…³é—­äº†ï¼Œä¹Ÿæ˜¯å¯ä»¥æŽ¥æ”¶çš„ï¼Œå› ä¸ºæœ‰ç¼“å†²ï¼Œç¼“å†²é‡Œé¢è¿˜æœ‰ä¸œè¥¿ // release all readers for &#123; sg := c.recvq.dequeue() if sg == nil &#123; break &#125; if sg.elem != nil &#123; typedmemclr(c.elemtype, sg.elem) sg.elem = nil &#125; if sg.releasetime != 0 &#123; sg.releasetime = cputicks() &#125; gp := sg.g gp.param = nil if raceenabled &#123; raceacquireg(gp, unsafe.Pointer(c)) &#125; gp.schedlink.set(glist) glist = gp &#125; // ä½†æ˜¯å¯¹äºŽå‘é€çš„æ¥è¯´ï¼Œå¦‚æžœä½ å…³é—­äº†ï¼Œè¿˜æœ‰äººåœ¨å‘ï¼Œé‚£ä¹ˆå°±ä¼šæ— æƒ…çš„panicäº†ï¼Œè¿™ä¸ªåœ¨å‘é€çš„ä»£ç é‡Œé¢å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¿™é‡Œæ˜¯å¤„ç†æ‰€æœ‰å‘é€çš„goroutineå°±å¯ä»¥äº† // release all writers (they will panic) for &#123; sg := c.sendq.dequeue() if sg == nil &#123; break &#125; sg.elem = nil if sg.releasetime != 0 &#123; sg.releasetime = cputicks() &#125; gp := sg.g gp.param = nil if raceenabled &#123; raceacquireg(gp, unsafe.Pointer(c)) &#125; gp.schedlink.set(glist) glist = gp &#125; unlock(&amp;c.lock) // Ready all Gs now that we've dropped the channel lock. for glist != nil &#123; gp := glist glist = glist.schedlink.ptr() gp.schedlink = 0 goready(gp, 3) &#125;&#125; åœ¨è¿™é‡Œæ€»ç»“ä¸€ä¸‹å‡ºçŽ° panic çš„æƒ…å†µï¼š close ä¸€ä¸ª nil çš„ channel close ä¸€ä¸ªå·²ç» closed çš„ channel å‘ä¸€ä¸ª closed çš„ channel å‘é€æ¶ˆæ¯]]></content>
      <categories>
        <category>golangæºç è§£æž</category>
      </categories>
      <tags>
        <tag>channel</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä½ å¯èƒ½ä¸çŸ¥é“çš„redis]]></title>
    <url>%2F2019%2F07%2F20%2Fmiddleware%2Fredis%2Fredis-knowledge-point%2F</url>
    <content type="text"><![CDATA[ä»¥ä¸‹æ˜¯é’ˆå¯¹redisçš„çŸ¥è¯†ç‚¹æ•´ç†ï¼Œç”¨äºŽå¤ä¹ ï¼Œä¸»è¦ä»¥ç½—åˆ—ä¸ºä¸»ï¼Œè¯¦ç»†å…·ä½“è®²è§£å¯ä»¥å‚è€ƒä¹¦ã€ŠRedisè®¾è®¡ä¸Žå®žçŽ°ã€‹ï¼Œä½ å¯ä»¥è¿‡ä¸€éçœ‹çœ‹æœ‰æ— çŸ¥è¯†ç‚¹é—æ¼ã€‚ä¸ªäººèƒ½åŠ›æœ‰é™ï¼Œå¦‚æžœä½ è¿˜æœ‰è¡¥å……å¯ä»¥å†ä¸‹æ–¹è¯„è®ºæŒ‡å‡ºï¼Œä¸‡åˆ†æ„Ÿè°¢ã€‚ åŸºç¡€çŸ¥è¯†ç‚¹ æ•°æ®ç±»åž‹string (å­—ç¬¦ä¸²)ã€list (åˆ—è¡¨)ã€set (é›†åˆ)ã€hash (å“ˆå¸Œ) å’Œ zset (æœ‰åºé›†åˆ)åº•å±‚å®žçŽ°åŒ…æ‹¬ï¼šSDSåŠ¨æ€å­—ç¬¦ä¸²ï¼ŒåŒå‘é“¾è¡¨ï¼Œæ•°ç»„åŠ é“¾è¡¨ï¼Œæ¸è¿›å¼hashï¼Œè·³è¡¨ redisæ˜¯å•çº¿ç¨‹ redisé»˜è®¤æœ‰16ä¸ªæ•°æ®åº“ï¼Œé»˜è®¤å…ˆç”¨0ï¼Œå¯ä»¥ä½¿ç”¨selectå‘½ä»¤åˆ‡æ¢ è¿‡æœŸç­–ç•¥æƒ°æ€§åˆ é™¤ï¼šå½“è¿™ä¸ªkeyè¢«è®¿é—®åˆ°ï¼Œä½†æ˜¯å·²ç»è¿‡æœŸï¼Œé‚£å°±åˆ é™¤å®šæœŸåˆ é™¤ï¼šè¿‡ä¸€å®šæ—¶é—´ï¼Œæ‹¿å‡ºä¸€å®šçš„keyåˆ¤æ–­ï¼Œè¿›è¡Œåˆ é™¤ï¼Œå¦‚æžœè¶…è¿‡ä¸€å®šæ•°é‡ï¼Œç»§ç»­æ‹¿å‡ºä¸€å®šçš„keyè¿›è¡Œåˆ¤æ–­åˆ é™¤ï¼Œæ—¶é—´å­˜åœ¨ä¸Šé™ å†…å­˜è¶…é™å½“redisä½¿ç”¨è¶…è¿‡å†…å­˜é™åˆ¶ä¼šæ ¹æ®ç­–ç•¥æ¥æ‰§è¡Œï¼šnoevictionï¼šä¸èƒ½putï¼Œä½†æ˜¯å¯ä»¥delå’Œgetï¼Œé»˜è®¤æ˜¯è¿™ä¸ªç­–ç•¥volatile-lruï¼šåœ¨æœ‰è¿‡æœŸæ—¶é—´çš„keyä¸­ï¼Œæ·˜æ±°æœ€å°‘ç”¨çš„ï¼ˆredisæ˜¯è¿‘ä¼¼lruç®—æ³•ï¼Œä¼šéšæœºå–å‡ ä¸ªæ·˜æ±°æœ€å°‘ç”¨çš„ï¼‰volatile-ttlï¼šåœ¨æœ‰è¿‡æœŸæ—¶é—´çš„keyä¸­ï¼Œæ·˜æ±°è¿‡æœŸæ—¶é—´æœ€çŸ­çš„ï¼ˆå‰©ä¸‹å¯¿å‘½æœ€çŸ­çš„ï¼‰volatile-randomï¼šåœ¨æœ‰è¿‡æœŸæ—¶é—´çš„keyä¸­ï¼Œéšæœºæ·˜æ±°allkeys-lruï¼šæ‰€æœ‰keyä¸­ï¼Œæ·˜æ±°æœ€å°‘ç”¨çš„allkeys-randomï¼šæ‰€æœ‰keyä¸­ï¼Œéšæœºæ·˜æ±° æŒä¹…åŒ–æ–¹å¼RDBã€AOFã€æ··åˆRDBï¼šç±»ä¼¼å¿«ç…§ï¼Œå°†å½“å‰æ•°æ®æ‹ä¸ªç…§ç‰‡ä¿å­˜ï¼Œåˆ©ç”¨æ“ä½œç³»ç»Ÿçš„ COW æœºåˆ¶æ¥è¿›è¡Œæ•°æ®æ®µé¡µé¢çš„åˆ†ç¦»ï¼Œè¿›è¡Œå¯¹æ•°æ®çš„å¤åˆ¶ï¼ŒåŒæ—¶ï¼Œæ–°æ•°æ®ä¼šåœ¨æ–°çš„pageä¸Šé¢AOFï¼šåˆ©ç”¨æ—¥å¿—æ¥å®Œæˆè®°å½•ï¼Œå½“é€»è¾‘å¤„ç†å®Œæˆè®°å½•æ—¥å¿—ï¼Œåˆ©ç”¨æ—¥å¿—é‡æ”¾æ¥æ¢å¤ï¼Œä¼šå¯¹aofè¿›è¡Œé‡å†™ç˜¦èº«ï¼Œé€šè¿‡fsyncæ¥ä¿è¯æ•°æ®åˆ·åˆ°ç£ç›˜ä¸Šé¢ï¼Œ1sä¸€æ¬¡æ··åˆï¼šrdbå­˜å‚¨ï¼Œå¢žé‡ç”¨AOFï¼Œé‡å¯åŽå…ˆè¯»å–rdbå†é‡æ”¾aof é€šä¿¡åè®®RESPç›´è§‚çš„æ–‡æœ¬åè®®ï¼Œåˆ©ç”¨ä¸€äº›ç‰¹æ®Šå­—ç¬¦æ¥ç¡®å®šå½“å‰çš„æ˜¯ä»€ä¹ˆè¯­å¥ redisäº‹åŠ¡rediså¯ä»¥ä½¿ç”¨multi/exec/discardã€‚multi æŒ‡ç¤ºäº‹åŠ¡çš„å¼€å§‹ï¼Œexec æŒ‡ç¤ºäº‹åŠ¡çš„æ‰§è¡Œï¼Œdiscard æŒ‡ç¤ºäº‹åŠ¡çš„ä¸¢å¼ƒã€‚redisæ˜¯ä¸æ”¯æŒå›žæ»šçš„ï¼Œåªèƒ½æŠŠå½“å‰æ‰€æœ‰çš„æ‰§è¡Œä¸¢å¼ƒï¼Œäº‹åŠ¡æ€§èƒ½ä¸é«˜ï¼Œä½¿ç”¨ç®¡é“ä¼˜åŒ–ï¼Œæä¾›watchæœºåˆ¶ç›‘å¬æ”¹å˜ï¼Œä½†æ˜¯é’ˆå¯¹æ”¹å˜åªæ˜¯çŸ¥é“ï¼Œä½†æ˜¯ä¸äºˆå¤„ç†ã€‚ keyså’Œscané€šè¿‡è¿™ä¸¤ä¸ªå‘½ä»¤å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„é”®ï¼Œkeysä¼šå¡ï¼Œscanä¸ä¼šä½†æ˜¯æ…¢ä¸€ç‚¹ï¼Œå¯èƒ½ä¼šé‡å¤ã€‚ rediså¯¹å†…å­˜ä¼˜åŒ–åœ¨å­˜æ”¾å¤§keyæˆ–è€…æ•°é‡é‡å¤§åˆ—è¡¨æ—¶ï¼Œä¼šå¯¹å­˜å‚¨ç»“æž„è¿›è¡ŒåŽ‹ç¼©ï¼Œziplistå½“åˆ é™¤å¤šä¸ªé”®çš„æ—¶å€™å†…å­˜ä¸ä¼šé©¬ä¸Šè¢«å›žæ”¶ï¼Œå› ä¸ºæ“ä½œç³»ç»Ÿçš„å†…å­˜æ˜¯æŒ‰é¡µæ¥çš„ï¼Œåªæœ‰è¿™ä¸ªé¡µä¸Šé¢çš„keyå…¨éƒ¨åˆ é™¤æ‰èƒ½å›žæ”¶ï¼ŒåŒæ—¶ï¼Œæ–°çš„keyä¼šåˆ©ç”¨åˆ é™¤åŽçš„ç©ºé—´ Pipelineç½‘ç»œäº¤äº’ä¸­åˆ©ç”¨äº†å†…æ ¸çš„ç‰¹æ€§ï¼Œå®¢æˆ·å‘é€æ¶ˆæ¯æ—¶ï¼Œåªéœ€è¦å°†æ¶ˆæ¯å†™å…¥æœ¬åœ°ç¼“å­˜ï¼Œå°±é©¬ä¸Šè¿”å›žï¼Œä¸éœ€è¦ç­‰å¾…ï¼ŒåŽç»­æ“ä½œç”±å†…æ ¸ç½‘å…³åŽ»å¼‚æ­¥å‘é€ï¼Œè€Œè¯»å–è¿”å›žæ¶ˆæ¯æ—¶ä¹Ÿæ˜¯è¯»å–çš„æœ¬åœ°ç›¸å¯¹åº”çš„è¯»ç¼“å­˜ï¼Œå¦‚æžœæ²¡æœ‰æ•°æ®å°±éœ€è¦ç­‰å¾…ç½‘ç»œè¿”å›žæ•°æ®ä»Žè€Œä»Žç¼“å­˜ä¸­è¯»å–æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™æ˜¯çœŸæ­£è€—æ—¶çš„æ—¶å€™ã€‚ å¸¸ç”¨æž¶æž„ å•æœºå•ä¸ªèŠ‚ç‚¹ä½¿ç”¨ ä¸»ä»Žä¸€æ–¹é¢æ˜¯ä»Žåšå¤‡ä»½ï¼Œä¸€æ–¹é¢ä»Žå¯ä»¥æä¾›getæœåŠ¡RedisåŒæ­¥çš„æ˜¯æŒ‡ä»¤æµï¼Œå¢žé‡åŒæ­¥ï¼Œåˆ©ç”¨bufferè¿›è¡Œç¼“å†²ï¼Œå¯èƒ½å‡ºçŽ°bufferå……æ»¡çš„æ—¶å€™å°±éœ€è¦è¿›è¡Œå¿«ç…§å¤åˆ¶ï¼Œå°†ä¸»èŠ‚ç‚¹è¿›è¡Œå¿«ç…§ï¼Œç„¶åŽç›´æŽ¥å‘é€ç»™ä»ŽèŠ‚ç‚¹ï¼Œç„¶åŽä»ŽèŠ‚ç‚¹åˆ é™¤æ‰€æœ‰æ•°æ®ï¼Œç„¶åŽä»ŽèŠ‚ç‚¹è¿›è¡ŒåŠ è½½ï¼Œç„¶åŽåŒæ­¥æ–°çš„æŒ‡ä»¤ï¼Œé€Ÿåº¦æ…¢ã€‚ å“¨å…µåˆ©ç”¨å“¨å…µåŽ»è‡ªåŠ¨é€‰ä¸¾å‡ºä¸»èŠ‚ç‚¹ï¼ŒåŒæ—¶å‡ºçŽ°å¼‚å¸¸è‡ªåŠ¨é‡æ–°é€‰å‡ºä¸»èŠ‚ç‚¹ é›†ç¾¤codisï¼šåˆ©ç”¨ä¸­é—´ä»£ç†äººåŽ»è®¿é—®ï¼Œå°†ä¸åŒçš„æ§½ä½åˆ†é…åˆ°ç›¸åº”çš„redisèŠ‚ç‚¹ä¸Šé¢ï¼Œclienté€šè¿‡codisè¿›è¡Œè®¿é—®ï¼Œcodiså¯ä»¥é…ç½®å¤šä¸ªï¼Œé€šè¿‡zkæ¥åŒæ­¥æ§½ä½ã€‚clusterï¼šå®˜æ–¹ç»™å‡ºï¼ŒåŽ»ä¸­å¿ƒåŒ–ï¼Œè‡ªåŠ¨ç»´æŠ¤æ§½ä½åˆ†å¸ƒã€‚ åº”ç”¨åœºæ™¯ åˆ†å¸ƒå¼é”setnx(set if not exists)ä¸€å¼€å§‹ä¸æ”¯æŒè®¾ç½®è¿‡æœŸæ—¶é—´ï¼ŒåŽæ¥2.8æ›´æ–°åŽï¼Œå‘½ä»¤ä¸ºï¼šset lock true ex 5 nxä½†æ˜¯è¶…æ—¶æ˜¯å­˜åœ¨é—®é¢˜çš„ï¼Œå¦‚æžœå†æ—¶é—´é™åˆ¶è¿‡ç¨‹ä¸­ï¼Œæ²¡æœ‰æ‰§è¡Œå®Œï¼Œé”è‡ªåŠ¨é‡Šæ”¾äº†ï¼Œä½†æ˜¯å®žé™…è¿˜åœ¨æ‰§è¡Œï¼Œä½†æ˜¯åˆ«çš„çº¿ç¨‹å¯ä»¥æŠ¢åˆ°é”åŽ»æ‰§è¡Œäº†ã€‚ MQå¯ä»¥åˆ©ç”¨listæ¥å®žçŽ°æ¶ˆæ¯é˜Ÿåˆ—çš„æ“ä½œï¼Œrpop lpushï¼Œredisçš„listæ˜¯ä¸€ä¸ªåŒç«¯é˜Ÿåˆ—ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒé˜»å¡žæ‹¿å‡ºæ¶ˆæ¯ï¼Œæ¥æ”¯æŒé˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™çš„é—®é¢˜åŒæ—¶æœ‰PubSubæ”¯æŒè®¢é˜…ï¼Œä½†æ˜¯å°‘äº†å¾ˆå¤šåŠŸèƒ½å¦‚ackï¼Œä¸èƒ½ä¿è¯æ•°æ®ä¸€å®šæˆåŠŸå‘å‡ºï¼ŒåŽé¢å¼•å…¥Stream HyperLogLogç”¨äºŽæ¨¡ç³Šç»Ÿè®¡ï¼Œå¯ä»¥ç”¨äºŽç»Ÿè®¡ç½‘ç«™çš„uvï¼ˆå•ä¸ªç”¨æˆ·è®¿é—®åªèƒ½ç®—ä¸€æ¬¡ï¼‰ï¼Œåˆ©ç”¨çŸ©é˜µã€‚ GeoHashredisæ”¯æŒå­˜å‚¨åœ°ç†ä½ç½®ï¼Œå¹¶ä¸”è¿›è¡Œé™„è¿‘ç»Ÿè®¡å’Œè·ç¦»è®¡ç®— å¸ƒéš†è¿‡æ»¤rebloomç”¨äºŽæœ€å¤§åŒ–æ•ˆçŽ‡åŽ»é‡ï¼Œä¼šæœ‰è¯¯åˆ¤ï¼Œåˆ©ç”¨hashåŽŸç†ã€‚å®žé™…é€‚ç”¨äºŽï¼šçˆ¬è™«ç³»ç»Ÿè¿‡æ»¤å·²ç»æŸ¥è¿‡çš„urlã€åžƒåœ¾é‚®ä»¶è¿‡æ»¤ã€ç¼“å­˜å‡»ç©¿é˜²å¾¡ç­‰ï¼Œæ€»ä¹‹ç”¨äºŽæ•°æ®é‡å¤§ã€è¦æ±‚é€Ÿåº¦å¿«ã€å¯ä»¥å¿å—è¯¯åˆ¤çš„æƒ…å†µã€‚ é—®é¢˜è§£å†³ç¼“å­˜å‡»ç©¿å¤šæ¬¡æŸ¥è¯¢é‚£äº›ä¸€å®šä¸å­˜åœ¨çš„æ•°æ®ï¼Œæˆ–è€…å½“å‰æ•°æ®ä¸åœ¨ç¼“å­˜çš„é«˜å¹¶å‘æŸ¥è¯¢ï¼Œå¯¼è‡´å·¨å¤§æµé‡æ¶Œå…¥æ•°æ®åº“ã€‚è§£å†³æ–¹å¼ï¼š ç¼“å­˜ç©ºå¯¹è±¡ï¼Œå¦‚æžœå¯ä»¥ç¼“å­˜ç©ºå¯¹è±¡ï¼Œå°†ç©ºå¯¹è±¡ä½œä¸ºnullç¼“å­˜èµ·æ¥ï¼Œè®©ç¼“å­˜å¼ºåˆ¶å‘½ä¸­ï¼ˆæå‰ç¼“å­˜æˆ–è€…æƒ°æ€§ç¼“å­˜å‡å¯ï¼‰ã€‚å­˜åœ¨é—®é¢˜ï¼šå½“ç©ºå¯¹è±¡å¤šæ—¶ï¼Œæµªè´¹äº†ç¼“å­˜çš„ç©ºé—´ã€‚ åˆ©ç”¨å¸ƒéš†è¿‡æ»¤å™¨ç¼“å­˜å‡ºçŽ°è¿‡çš„keyï¼Œä¿è¯ä¸åœ¨è¿‡æ»¤å™¨é‡Œé¢çš„keyä¸€å®šä¸å­˜åœ¨ï¼Œå¸ƒéš†è¿‡æ»¤å™¨èŠ‚çœå¾ˆå¤šç©ºé—´ ç¼“å­˜é›ªå´©æƒ…å†µä¸€ï¼šå¤šæ•°ç±»ä¼¼ç¼“å­˜åŒæ—¶è¿‡æœŸï¼Œå¯¼è‡´å¯¹è¿™äº›keyçš„æŸ¥è¯¢åŒæ—¶è½åˆ°æ•°æ®åº“ã€‚æƒ…å†µäºŒï¼šç¼“å­˜æœåŠ¡å™¨ç›´æŽ¥æŒ‚æŽ‰ï¼Œå¯¼è‡´æ‰€æœ‰è¯·æ±‚å…¨éƒ¨è½åˆ°æ•°æ®åº“ï¼Œå¯¼è‡´åŽç»­é›ªå´©ã€‚è¿™é‡Œçš„è§£å†³æ–¹å¼å°±éœ€è¦è§†æƒ…å†µè€Œå®šï¼šæƒ…å†µä¸€çš„è¯ï¼Œå¯ä»¥å°è¯•è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´ä¸ºéšæœºå€¼ï¼Œä¸è®©åŒç±»åž‹ç¼“å­˜åŒæ—¶è¿‡æœŸã€‚æƒ…å†µäºŒçš„è¯ï¼Œé¦–å…ˆä¼˜å…ˆä¿è¯æž¶æž„ä¸Šé¢èƒ½åŽ‹ä½ï¼Œå°½å¯èƒ½ä¿è¯æœ‰redisçš„å¤‡ä»½èŠ‚ç‚¹å¯ä»¥æ¢å¤ï¼Œå½“ç„¶ä¹Ÿè¦åšplanBï¼Œä¸‡ä¸€å…¨éƒ¨ç¼“å­˜èŠ‚ç‚¹å…¨éƒ¨æŒ‚ï¼Œæœ€å‰é¢ç½‘å…³å±‚é¢è¦è¦åšåˆ°é™æµï¼ŒåŽç»­æœåŠ¡éœ€è¦åšé™çº§æˆ–ç†”æ–­ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¸æ˜¯ç¼“å­˜çš„é—®é¢˜äº†ï¼Œå°±æ˜¯æž¶æž„çš„é—®é¢˜äº†ã€‚]]></content>
      <categories>
        <category>redis</category>
      </categories>
      <tags>
        <tag>redis</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä½ å¯èƒ½ä¸çŸ¥é“çš„mysql]]></title>
    <url>%2F2019%2F07%2F15%2Fmiddleware%2Fmysql%2Fmysql-knowledge-point%2F</url>
    <content type="text"><![CDATA[ä»¥ä¸‹æ˜¯é’ˆå¯¹mysqlçš„çŸ¥è¯†ç‚¹æ•´ç†ï¼Œç”¨äºŽå¤ä¹ ï¼Œä¸»è¦ä»¥ç½—åˆ—ä¸ºä¸»ï¼Œè¯¦ç»†å…·ä½“è®²è§£å¯ä»¥å‚è€ƒä¹¦ã€Šé«˜æ€§èƒ½mysqlã€‹ï¼Œä½ å¯ä»¥è¿‡ä¸€éçœ‹çœ‹æœ‰æ— çŸ¥è¯†ç‚¹é—æ¼ã€‚ æ‰§è¡Œsqlè¿‡ç¨‹å®¢æˆ·ç«¯ -&gt; è¿žæŽ¥å™¨ -&gt; åˆ†æžå™¨ -&gt; ä¼˜åŒ–å™¨ -&gt; æ‰§è¡Œå™¨ -&gt; å­˜å‚¨å¼•æ“Žè¿žæŽ¥å™¨ï¼šè¿žæŽ¥ä¸Šæ•°æ®åº“ï¼Œé•¿è¿žæŽ¥åˆ†æžå™¨ï¼šåˆ†æžè¯­æ³•ï¼ˆåŒ…å«è§£æžå™¨å’Œé¢„å¤„ç†å™¨ï¼Œè§£æžå™¨ç”Ÿæˆè§£æžæ ‘ï¼Œé¢„å¤„ç†å™¨åˆ¤æ–­å­—æ®µå­˜åœ¨æ­§ä¹‰ï¼‰ä¼˜åŒ–å™¨ï¼šé€‰æ‹©æ­£ç¡®çš„ç´¢å¼•è¿›è¡Œä¼˜åŒ–æ‰§è¡Œæ‰§è¡Œå™¨ï¼šæ‰§è¡Œå…·ä½“sqlè¿”å›žç»“æžœ mysqlçš„ä¸¤ä¸ªé‡è¦æ—¥å¿—redo-logï¼ˆé‡åšæ—¥å¿—ï¼‰ï¼šå›ºå®šå¤§å°çš„å¾ªçŽ¯ç¼“å­˜ï¼ŒInnoDBä½¿ç”¨ï¼Œå³ä½¿é‡å¯ï¼Œåªè¦è®°å½•åˆ°äº†redo-logå°±ä¸ä¼šä¸¢å¤±ã€‚é˜²æ­¢mysqlæ„å¤–ã€‚bin-logï¼šå½’æ¡£æ—¥å¿—ï¼Œæ‰€æœ‰sqléƒ½ä¼šè®°å½•ï¼Œå¹¶ä¸”é‡‡ç”¨è¿½åŠ ï¼Œæ»¡äº†ä¹‹åŽæ–°å¼€ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯è®°å½•sqlè¯­å¥ï¼ˆstatementï¼‰ï¼Œä¸€ç§æ˜¯rowï¼Œè®°å½•å‡ºçŽ°çš„äº‹ä»¶ã€‚å¦‚æžœåªè®°å½•sqlè¯­å¥ä¼šå¯¼è‡´ä¸»ä»ŽåŒæ­¥ä¸Šé¢å­˜åœ¨é—®é¢˜ï¼Œä»Žåº“æ‰§è¡Œç›¸åŒçš„sqlå¾—åˆ°æ•ˆæžœä¸åŒï¼Œæ‰€ä»¥è¿˜æœ‰ä¸€ç§æ··åˆçš„æ–¹å¼ï¼Œmysqlä¼šè‡ªåŠ¨åˆ¤æ–­å½“å‰è¯­å¥æ˜¯å¦ä¼šé€ æˆä¸»ä»Žä¸åŒæ­¥çš„æƒ…å†µï¼Œå¦‚æžœä¼šï¼Œé‚£ä¹ˆå°±ä½¿ç”¨rowè®°å½•å¦‚æžœä¸ä¼šå°±æ˜¯ç”¨sqlè®°å½•ï¼Œå› ä¸ºrowè®°å½•ä¼šå¢žåŠ å­˜å‚¨ç©ºé—´ã€‚ undo-logï¼ˆå›žæ»šæ—¥å¿—ï¼‰ï¼šè®°å½•ä¿®æ”¹çš„çŠ¶æ€å’Œå›žæ»šä¿¡æ¯ï¼Œåˆ©ç”¨è¿™ä¸ªå®žçŽ°mvccï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æŽ§åˆ¶ï¼‰ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åˆ¤æ–­å›žæ»šæ—¥å¿—ä»€ä¹ˆæ—¶å€™ä¼šè¢«åˆ é™¤ã€‚ç”¨äºŽå›žæ»šæ“ä½œã€‚ ä¸¤ä¸ªæ—¥å¿—è®°å½•çš„é¡ºåºï¼šæ›´æ–°çš„è¡Œå¦‚æžœä¸åœ¨å†…å­˜ï¼Œä»Žç£ç›˜å–å‡º -&gt; ä¿®æ”¹å†…å­˜ä¸­çš„å€¼ -&gt; å†™å…¥redo-logçŠ¶æ€ä¸ºprepare -&gt; å†™binlog -&gt; æäº¤äº‹åŠ¡redo-logè¿›è¡Œcommit æ•°æ®åº“çš„éš”ç¦»çº§åˆ«è¯»æœªæäº¤ï¼šèƒ½è¯»åˆ°åˆ«äººæœªæäº¤äº‹åŠ¡ä¿®æ”¹çš„æ•°æ®è¯»å·²æäº¤ï¼šèƒ½è¯»åˆ°åˆ«äººæäº¤äº‹åŠ¡ä¹‹åŽä¿®æ”¹çš„æ•°æ®å¯é‡å¤è¯»ï¼šåœ¨è¯»å·²æäº¤çš„åŸºç¡€ä¸Šï¼Œå½“å‰äº‹åŠ¡è¯»å–ç¬¬ä¸€æ¬¡å’Œç¬¬äºŒæ¬¡çš„ç»“æžœç›¸åŒä¸²è¡ŒåŒ–ï¼šè¯»ä¼šåŠ è¯»é”ï¼Œå†™ä¼šåŠ å†™é”ï¼Œè¯»å†™å†²çªä¸²è¡ŒåŒ–æ‰§è¡Œ éš”ç¦»çº§åˆ«é€šè¿‡è§†å›¾å®žçŽ°ï¼Œè¯»æœªæäº¤æ²¡æœ‰è§†å›¾ï¼Œè¯»å·²æäº¤æ¯æ¬¡sqlæ‰§è¡Œåˆ›å»ºä¸€ä¸ªè§†å›¾ï¼Œå¯é‡å¤è¯»åœ¨å¼€å§‹ä¹‹å‰åˆ›å»ºä¸€ä¸ªè§†å›¾ï¼Œä¸²è¡ŒåŒ–ç›´æŽ¥åŠ é”æ²¡æœ‰è§†å›¾ã€‚ äº‹åŠ¡ä¸Žéš”ç¦»çº§åˆ«ï¼šæ›´æ–°æ•°æ®éƒ½æ˜¯å…ˆè¯»åŽå†™çš„ï¼Œè€Œè¿™ä¸ªè¯»ï¼Œåªèƒ½è¯»å½“å‰çš„å€¼ï¼Œç§°ä¸ºâ€œå½“å‰è¯»â€ï¼›æ‰€ä»¥å³ä½¿æ˜¯å¯ä»¥é‡å¤è¯»çš„éš”ç¦»çº§åˆ«ï¼Œæ›´æ–°æ•°æ®æ—¶è¿˜æ˜¯ä¼šè¿›è¡Œå½“å‰è¯»æ¥ä¿è¯åˆ«äººå·²ç»æäº¤çš„äº‹åŠ¡ä¸è¢«è¦†ç›–ã€‚ å¹»è¯»ï¼šå¹»è¯»æ˜¯å‡ºçŽ°åœ¨èŒƒå›´æŸ¥è¯¢ï¼Œç¬¬äºŒæ¬¡æŸ¥è¯¢ä¹‹å‰ï¼Œç”±äºŽå…¶ä»–äº‹åŠ¡æ–°å¢žè®°å½•å¯¼è‡´æŸ¥è¯¢ä¸¤æ¬¡ä¸åŒï¼ŒåŒºåˆ«äºŽå¯é‡å¤è¯»ã€‚InnoDBå¼•å…¥é—´éš™é”æ¥è§£å†³ï¼Œé”ä½èŒƒå›´å†…çš„å„ä¸ªé—´éš™ã€‚ä½†æ˜¯è¦æ³¨æ„é—´éš™é”ä¹Ÿå®¹æ˜“å¯¼è‡´æ­»é”ï¼Œè·Ÿé—´éš™é”å­˜åœ¨å†²çªå…³ç³»çš„ï¼Œæ˜¯â€œå¾€è¿™ä¸ªé—´éš™ä¸­æ’å…¥ä¸€ä¸ªè®°å½•â€è¿™ä¸ªæ“ä½œï¼Œé—´éš™é”ä¹‹é—´éƒ½ä¸å­˜åœ¨å†²çªå…³ç³»ã€‚ ç´¢å¼•åŸºç¡€å¸¸è§çš„ç´¢å¼•ç±»åž‹æœ‰ï¼šå“ˆå¸Œã€æ•°ç»„ã€æœç´¢æ ‘å“ˆå¸Œç”¨äºŽç­‰å€¼æŸ¥è¯¢ï¼Œä¸é€‚åˆèŒƒå›´æŸ¥è¯¢ï¼›æ•°ç»„æŸ¥è¯¢å¾ˆå¿«ï¼Œä½†æ˜¯æ›´æ–°æ•ˆçŽ‡ä½Žæ•°æ®åº“ä½¿ç”¨Nå‰æ ‘é™ä½Žæ ‘çš„å±‚çº§ï¼Œinnodbä½¿ç”¨çš„æ˜¯B+æ ‘ åœ¨InnoDbä¸­ï¼Œä¸»é”®ç´¢å¼•åˆå«èšç°‡ç´¢å¼•ï¼Œéžä¸»é”®ç´¢å¼•åˆå«äºŒçº§ç´¢å¼•ä¸»é”®ç´¢å¼•å¯ä»¥æ‹¿åˆ°å…¨éƒ¨æ•°æ®ï¼Œè€Œéžä¸»é”®ç´¢å¼•åªèƒ½æ‹¿åˆ°ä¸»é”®idé€šè¿‡å›žè¡¨æŸ¥è¯¢æ¥æ‹¿åˆ°æ•°æ®å¦‚æžœä¸€ä¸ªæ•°æ®é¡µæ»¡äº†éœ€è¦æ–°å¢žä¸€ä¸ªæ•°æ®é¡µä¹Ÿå«åšé¡µåˆ†è£‚æ€§èƒ½ä¸‹é™å¹¶ä¸”ç©ºé—´åˆ©ç”¨çŽ‡ä¸‹é™ï¼Œæ‰€ä»¥ä½¿ç”¨è‡ªå¢žä¸»é”®æ›´åŠ åˆç† è¦†ç›–ç´¢å¼•ï¼šå½“æˆ‘ä»¬æŸ¥è¯¢çš„æ—¶å€™åªéœ€è¦æŸ¥è¯¢å‡ºidå­—æ®µçš„æ—¶å€™å°±å¯ä»¥ç›´æŽ¥ä½¿ç”¨å•ä¸ªç´¢å¼•æ¥å®Œæˆï¼Œä¸éœ€è¦è¿›è¡Œå›žè¡¨æ“ä½œï¼Œå‡å°‘æœç´¢æ¬¡æ•°ã€‚ æœ€å·¦å‰ç¼€åŽŸåˆ™ï¼šå½“æˆ‘ä»¬è¿›è¡Œä¸€ä¸ªå­—æ®µæŸ¥è¯¢çš„æ—¶å€™ï¼Œå¦‚æžœè¿™ä¸ªå­—æ®µæ²¡æœ‰å•ç‹¬åšç´¢å¼•ï¼Œä½†æ˜¯æœ‰åˆ«çš„è”åˆç´¢å¼•åŒ…å«è¿™ä¸ªå­—æ®µï¼Œä¸”åˆšå¥½ä»¥è¿™ä¸ªå­—æ®µå¼€å¤´ï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥è¿›è¡ŒåŒ¹é…ã€‚æ‰€ä»¥åœ¨å»ºç«‹è”åˆç´¢å¼•çš„æ—¶å€™éœ€è¦è€ƒè™‘å­—æ®µæŽ’åºï¼Œè¿™æ ·å°±å¯ä»¥å‡å°‘ç»´æŠ¤çš„ç´¢å¼•ä¸ªæ•°ã€‚ ç´¢å¼•ä¸‹å †ä¼˜åŒ–ï¼šmysql5.6ä¹‹åŽï¼Œå½“æŸ¥è¯¢çš„æ¡ä»¶ä¸­åŒ…å«ç´¢å¼•ä¸­çš„å­—æ®µï¼Œä¼šä¼˜å…ˆå¯¹ç´¢å¼•ä¸­çš„å­—æ®µåšåˆ¤æ–­ï¼Œè€Œéžç›´æŽ¥å›žè¡¨æŸ¥è¯¢ã€‚ é‡å»ºç´¢å¼•ï¼šå½“åˆ é™¤å¾ˆå¤šæ•°æ®ä¹‹åŽï¼Œç”±äºŽç´¢å¼•æ²¡æœ‰è¢«åˆ é™¤ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´æ•°æ®é¡µæœ‰ç©ºæ´žï¼Œè€Œä¸”å ç”¨èµ„æºï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥è€ƒè™‘å†ä½Žè°·æœŸé‡å»ºç´¢å¼•alter table T engine=InnoDBã€‚ å”¯ä¸€ç´¢å¼•å’Œæ™®é€šç´¢å¼•ï¼šæ’å…¥ä¸Šé¢æ€§èƒ½å‡ ä¹Žæ²¡æœ‰åŒºåˆ«ï¼Œæ›´æ–°ä¸Šé¢æ™®é€šç´¢å¼•å¯ä»¥ä½¿ç”¨change bufferæ‰€ä»¥æ›´åŠ å¿«ä¸€äº›ï¼Œè€Œå”¯ä¸€ç´¢å¼•éœ€è¦åˆ¤æ–­æ‰€ä»¥æ…¢ä¸€äº›ã€‚é€‰æ‹©è¿˜æ˜¯éœ€è¦æ ¹æ®ä¸šåŠ¡å‡ºå‘åŽ»è€ƒè™‘ã€‚ åˆç†è®¾ç½®å‰ç¼€ç´¢å¼•ï¼šç´¢å¼•å¯ä»¥è®¾ç½®åªç”¨å‰é¢å‡ ä½ï¼Œå¯ä»¥å‡å°‘ç´¢å¼•å ç”¨ç©ºé—´ï¼ŒåŒæ—¶è®¾ç½®æ—¶åº”ä¿è¯åˆé€‚çš„åŒºåˆ†åº¦ã€‚ é”ç›¸å…³å…¨å±€é”ï¼šç”¨äºŽå¤‡ä»½çš„æ—¶å€™ï¼Œé”ä½æ•´ä¸ªåº“ï¼Œé˜²æ­¢å¤‡ä»½è¿‡ç¨‹ä¸­æ•°æ®ä¿®æ”¹å¯¼è‡´é—®é¢˜ã€‚è¡¨é”ï¼šæœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯è¡¨é”ï¼Œåœ¨å¼•æ“Žä¸æ”¯æŒè¡Œé”çš„æ—¶å€™ä½¿ç”¨ï¼Œé”ä½ä¹‹åŽä¸èƒ½è¿›è¡Œå¢žåˆ æ”¹æŸ¥ï¼›å¦ä¸€ç§æ˜¯å…ƒæ•°æ®é”ï¼Œè®¿é—®è¡¨çš„æ—¶å€™è‡ªåŠ¨åŠ ä¸Šï¼Œè¯»å†™é”ã€‚é»˜è®¤å°±æ˜¯ã€‚ è¡Œé”ï¼šåœ¨InnoDBäº‹åŠ¡ä¸­ï¼Œè¡Œé”æ˜¯åœ¨éœ€è¦çš„æ—¶å€™æ‰åŠ ä¸Šçš„ï¼Œä½†å¹¶ä¸æ˜¯ä¸éœ€è¦äº†å°±ç«‹åˆ»é‡Šæ”¾ï¼Œè€Œæ˜¯è¦ç­‰åˆ°äº‹åŠ¡ç»“æŸæ—¶æ‰é‡Šæ”¾ã€‚è¿™ä¸ªå°±æ˜¯ä¸¤é˜¶æ®µé”åè®®ã€‚å¦‚æžœä½ çš„äº‹åŠ¡ä¸­éœ€è¦é”å¤šä¸ªè¡Œï¼Œè¦æŠŠæœ€å¯èƒ½é€ æˆé”å†²çªã€æœ€å¯èƒ½å½±å“å¹¶å‘åº¦çš„é”å°½é‡å¾€åŽæ”¾ã€‚ é—´éš™é”ï¼šä¸“é—¨ç”¨æ¥è§£å†³å¹»è¯»çš„é—®é¢˜ï¼Œåœ¨å¯é‡å¤è¯»çš„æƒ…å†µä¸‹æ‰ä¼šç”Ÿæ•ˆã€‚ï¼ˆé—´éš™é”å’Œè¡Œé”åˆç§°next-key lockï¼‰next-key locké”çš„è§„åˆ™ï¼šåŠ é”èŒƒå›´æ˜¯å‰å¼€åŽé—­åŒºé—´ï¼›æŸ¥æ‰¾è¿‡ç¨‹ä¸­è®¿é—®åˆ°çš„å¯¹è±¡æ‰ä¼šåŠ é”ï¼›å½“é‡åˆ°ç´¢å¼•ç­‰å€¼æŸ¥è¯¢ï¼Œå¦‚æžœæ˜¯å”¯ä¸€ç´¢å¼•ï¼Œé‚£ä¹ˆå› ä¸ºåªå¯èƒ½æœ‰ä¸€è¡Œè®°å½•é‚£ä¹ˆå°±é€€åŒ–ä¸ºè¡Œé”ï¼›å¦‚æžœç´¢å¼•ç­‰å€¼æŸ¥è¯¢ï¼Œå‘çŽ°æ²¡æœ‰æ»¡è¶³æƒ…å†µï¼Œå°±åªèƒ½é€€åŒ–ä¸ºé—´éš™é”åŽ»é”é—´éš™ï¼›å¦‚æžœæ˜¯èŒƒå›´æŸ¥è¯¢é‚£ä¹ˆå°±ä¼šæŸ¥è¯¢åˆ°ç¬¬ä¸€ä¸ªä¸æ»¡è¶³æ¡ä»¶çš„æƒ…å†µä¸ºæ­¢ã€‚ æ­»é”ï¼šå½“å¯¹äºŽåŒä¸€ä¸ªè¡¨çš„å¤šè¡Œæ•°æ®è¿›è¡Œä¿®æ”¹çš„æ—¶å€™ï¼Œå®¹æ˜“å‡ºçŽ°æ­»é”ï¼Œç›¸äº’ç­‰å¾…ã€‚æ­»é”å¯ä»¥é€šè¿‡æ­»é”æ£€æµ‹æˆ–è€…æ˜¯è¶…æ—¶å›žæ»šæ¥è§£å†³ï¼Œä½†æ˜¯å¯¹äºŽæ€§èƒ½æŸå¤±å·¨å¤§ï¼Œæœ€å¥½é€šè¿‡ä¸šåŠ¡æˆ–è€…å®¢æˆ·ç«¯ä¼˜åŒ–å¤„ç†ã€‚ count(*)ï¼šé’ˆå¯¹è¿™ä¸ªæœ‰ç‰¹æ®Šä¼˜åŒ–ï¼Œä½†innodbæ²¡æœ‰ç›´æŽ¥è®°å½•è¡Œæ•°ï¼Œè¿˜æ˜¯éœ€è¦éåŽ†è®¡æ•°ï¼Œå®žåœ¨ä¸è¡Œå¯ä»¥ä¸šåŠ¡å®žçŽ°è®¡æ•°ã€‚ MyISAMä¸æ”¯æŒäº‹åŠ¡MyISAMä¸æ”¯æŒè¡Œé”åœ¨InnoDBä¸­ï¼Œæ¯ä¸ªæ•°æ®é¡µçš„å¤§å°é»˜è®¤æ˜¯16KBã€‚ order byçš„å®žçŽ°ï¼šåœ¨ä¸ç”¨ç´¢å¼•çš„æ—¶å€™ï¼Œå¦‚æžœå†…å­˜å¤Ÿç”¨ï¼Œé‚£ä¹ˆä¼šå°†æŸ¥è¯¢å…¨éƒ¨æŸ¥å‡ºæ¥ç„¶åŽæ”¾åˆ°å†…å­˜ä¸­å¿«æŽ’ï¼Œå¦‚æžœå†…éƒ¨ä¸å¤Ÿï¼Œä½¿ç”¨ç£ç›˜è¿›è¡ŒæŽ’åºåŽå½’å¹¶ã€‚æ›´å¥½çš„æƒ…å†µæ˜¯åŽ»ä½¿ç”¨ç´¢å¼•ï¼Œå› ä¸ºå­˜å‚¨çš„æ—¶å€™é»˜è®¤å°±æ˜¯æœ‰é¡ºåºçš„ï¼Œè¿™æ ·èƒ½å‡å°‘æŽ’åºä»Žè€ŒåŠ é€Ÿã€‚ æ— æ³•ä½¿ç”¨ç´¢å¼•çš„æƒ…å†µ å¦‚æžœå¯¹å­—æ®µåšäº†å‡½æ•°è®¡ç®—ï¼Œå°±ç”¨ä¸ä¸Šç´¢å¼•äº† å¦‚æžœè§¦å‘éšå¼è½¬æ¢ä¹Ÿç”¨ä¸ä¸Šç´¢å¼•äº† å­—ç¬¦é›†ä¸åŒè§¦å‘è½¬æ¢ä¹Ÿæ— æ³•ä½¿ç”¨ç´¢å¼• æŸ¥çœ‹ç›¸å…³å‘½ä»¤show processlistå‘½ä»¤æŸ¥çœ‹Waiting for table metadata lockæŸ¥çœ‹å„ä¸ªçº¿ç¨‹é”çš„æƒ…å†µ select from information_schema.innodb_trx\Gselect from t sys.innodb_lock_waits where locked_table=&#39;test&#39;.&#39;t&#39;\Gå¯ä»¥æŸ¥çœ‹å…·ä½“æ˜¯è¢«é‚£ä¸ªçº¿ç¨‹é”ä½äº† ä¸€äº›å°çš„for updateå’Œlock in share modelock in share modeæ˜¯æ„å‘å…±äº«é”ï¼Œå…¶ä»–sessionå¯ä»¥è¯»å–ç›¸å…³è®°å½•ï¼Œä¹Ÿå¯ä»¥ç»§ç»­åŠ ISï¼Œä½†æ˜¯æ— æ³•ä¿®æ”¹for updateæ˜¯æ„å‘æŽ’ä»–é”ï¼Œå…¶ä»–sessionæ— æ³•è¿›è¡Œselectâ€¦for updateæ“ä½œï¼Œä¹Ÿå°±æ˜¯æŽ’é™¤åˆ«çš„æƒ³è¦åŠ æŽ’å®ƒé”çš„æƒ…å†µã€‚ä¸¤è€…éƒ½ä¸ä¼šé˜»å¡žåˆ«çš„sessionè¿›è¡Œçš„å¿«ç…§è¯»ã€‚ç”¨æ³•ï¼Œlock in share modeç”¨äºŽä¸¤ä¸ªè¡¨ä¹‹é—´è¦ä¿è¯ä¸€è‡´æ€§ï¼Œaè¡¨çš„æ“ä½œæ—¶è¦ä¿è¯bè¡¨ä¸­çš„æŸæ¡æ•°æ®ä¸èƒ½è¢«ä¿®æ”¹ï¼›for updateç”¨äºŽåŒä¸€ä¸ªè¡¨ä¸­çš„æ•°æ®ï¼Œaäº‹åŠ¡æ“ä½œæ—¶ä¸å…è®¸bäº‹åŠ¡è¿›è¡Œä¿®æ”¹ã€‚ åœ¨åˆ é™¤æ•°æ®çš„æ—¶å€™å°½é‡åŠ limitã€‚è¿™æ ·ä¸ä»…å¯ä»¥æŽ§åˆ¶åˆ é™¤æ•°æ®çš„æ¡æ•°ï¼Œè®©æ“ä½œæ›´å®‰å…¨ï¼Œè¿˜å¯ä»¥å‡å°åŠ é”çš„èŒƒå›´ã€‚ ä¸è¦ä¸€æ¬¡æ€§åœ°ç”¨deleteè¯­å¥åˆ é™¤å¤ªå¤šæ•°æ®ã€‚å…¶å®žï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå…¸åž‹çš„å¤§äº‹åŠ¡åœºæ™¯ã€‚ sqlæ…¢çš„åŽŸå› ç´¢å¼•è®¾è®¡ä¸åˆç†sqlè®¾è®¡ä¸åˆç†mysqlç´¢å¼•è‡ªåŠ¨é€‰æ‹©é”™è¯¯ è¿ç»´ä¸Šçš„ä¸€äº›åŒä¸»çš„æ—¶å€™ï¼Œé€šè¿‡binlogä¸Šé¢çš„serveridè®°å½•æ¥åˆ¤æ–­æ˜¯å¦ä¸Žè‡ªå·±ç›¸åŒï¼Œå¦‚æžœä¸åŒæ‰ä¼šæ›´æ–°ï¼Œé¿å…å¾ªçŽ¯å¤åˆ¶ ä¸»å¤‡å»¶è¿Ÿçš„æ¥æºï¼šå¤‡åº“æœºå™¨æ€§èƒ½å·®ï¼Œå¤‡åº“æŸ¥è¯¢åŽ‹åŠ›å¤§ï¼Œå¤§äº‹åŠ¡ä¸€ç›´æ­£åœ¨å¤„ç†ã€‚mysql5.7é‡‡ç”¨å¹¶è¡Œå¤åˆ¶çš„ç­–ç•¥å‡å°‘ä¸»å¤‡å»¶è¿Ÿ å› ä¸ºä¸»å¤‡åŒæ­¥ä¼šå­˜åœ¨å»¶è¿Ÿï¼Œæ‰€ä»¥åœ¨å¼€å‘çš„æ—¶å€™ä¸€å®šè¦æ³¨æ„è¯»å–ä»Žåº“çš„æ—¶å€™ä¸ä¸€å®šæ˜¯æœ€æ–°çš„å€¼ã€‚1ã€è¯»å–çš„æ—¶å€™è¯»ä¸»åº“ï¼Œæœ€å¸¸ç”¨2ã€è¯»å–ä¹‹å‰è¿›è¡Œç¡çœ ä¸€æ®µæ—¶é—´ä¿è¯åŒæ­¥ä¿è¯seconds_behind_masterä¸€å®šä¸º0çš„æ—¶å€™æ‰æ‰§è¡ŒæŸ¥è¯¢æˆ–è€…å¯ä»¥ä½¿ç”¨semi-sync replicationï¼Œå½“ä»Žåº“æ”¶åˆ°binlogä¹‹åŽä¼šè¿”å›žä¸»åº“ä¸€ä¸ªackï¼Œä¸»åº“åªæœ‰æ”¶åˆ°è¿™ä¸ªackä¹‹åŽæ‰è®¤ä¸ºäº‹åŠ¡å®Œæˆ å¦‚ä½•è¿›è¡Œä¸»å¤‡åˆ‡æ¢ï¼Ÿï¼Ÿï¼Ÿï¼Ÿè¿‡ç¨‹æ˜¯æ€Žä¹ˆæ ·çš„ï¼Ÿ å¯¹æ¯”ä½ç‚¹Master_Log_Fileå’ŒRead_Master_Log_Posï¼Œè¡¨ç¤ºçš„æ˜¯è¯»åˆ°çš„ä¸»åº“çš„æœ€æ–°ä½ç‚¹ï¼›Relay_Master_Log_Fileå’ŒExec_Master_Log_Posï¼Œè¡¨ç¤ºçš„æ˜¯å¤‡åº“æ‰§è¡Œçš„æœ€æ–°ä½ç‚¹ã€‚å¦‚æžœä½ç‚¹ç›¸åŒå¯ä»¥è®¤ä¸ºå·²ç»åŒæ­¥ å¯¹æ¯”GTIDé›†åˆç¡®ä¿ä¸»å¤‡æ— å»¶è¿Ÿï¼š å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªæ•°æ®åº“æ­£å¸¸1ã€ä½¿ç”¨selectè¿›è¡ŒæŸ¥è¯¢ï¼ŒæŸ¥è¯¢ä¸€ä¸ªåˆ›å»ºåœ¨mysqlåº“ä¸­çš„è¡¨ï¼›å®¹æ˜“å®žçŽ°ï¼Œä½†æ˜¯å› ä¸ºåªæ˜¯æŸ¥è¯¢æ‰€ä»¥ä¼šæ¼æŽ‰ä¸€äº›é”™è¯¯æ¡ä»¶ï¼Œæ¯”å¦‚å½“ç£ç›˜æ»¡äº†ï¼Œbinlogå†™ä¸è¿›åŽ»äº†ï¼Œä½†æ˜¯å¯ä»¥è¯»ä¸èƒ½å†™ã€‚é‚£ä¹ˆå¯ä»¥ä½¿ç”¨updateæ¥è¿›è¡Œä¼˜åŒ–ä¸€ä¸‹ä¸‹ã€‚å°è¯•åŽ»ä¿®æ”¹ä¸€ä¸ªå€¼æ¥å®žçŽ°ã€‚ å½“å‡ºçŽ°è¯¯åˆ é™¤ï¼ˆdeleteï¼‰çš„æ—¶å€™ï¼Œè¿™ä¸ªæ—¶å€™è¦æŒ‡æœ›binlogå­˜æ”¾äº†æ•°æ®ï¼Œç„¶åŽé€†æ‰§è¡ŒåŽ»æ¢å¤ï¼ˆFlashbackï¼‰ï¼Œä½†æ˜¯éœ€è¦ç¡®ä¿binlog_format=row å’Œ binlog_row_image=FULLã€‚ é¢„é˜²æ‰æ˜¯å…³é”®ï¼šæŠŠsql_safe_updateså‚æ•°è®¾ç½®ä¸ºonã€‚è¿™æ ·ä¸€æ¥ï¼Œå¦‚æžœæˆ‘ä»¬å¿˜è®°åœ¨deleteæˆ–è€…updateè¯­å¥ä¸­å†™whereæ¡ä»¶ï¼Œæˆ–è€…whereæ¡ä»¶é‡Œé¢æ²¡æœ‰åŒ…å«ç´¢å¼•å­—æ®µçš„è¯ï¼Œè¿™æ¡è¯­å¥çš„æ‰§è¡Œå°±ä¼šæŠ¥é”™ã€‚ å¦‚æžœæ˜¯ç›´æŽ¥æ‰§è¡Œçš„dropçš„è¯ï¼Œbinlogä¹Ÿæ— èƒ½ä¸ºåŠ›ï¼Œå› ä¸ºlogä¸­æ²¡æœ‰å­˜æ”¾åˆ é™¤çš„æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™åªèƒ½ä¾èµ–å¤‡ä»½äº†ï¼Œåˆ©ç”¨æœ€è¿‘ä¸€æ¬¡å¤‡ä»½çš„æ•°æ®è¿›è¡Œæ¢å¤ï¼Œç„¶åŽè¿›è¡Œbinlogé‡æ”¾ã€‚ æ•…æ„å»¶è¿Ÿå¤åˆ¶çš„ä»Žåº“ï¼Œå¼„ä¸€ä¸ªæ•…æ„å»¶è¿Ÿä¸€ä¸ªå°æ—¶å¤åˆ¶çš„ä»Žåº“ï¼Œè¿™æ ·æ— è®ºä»€ä¹ˆæ—¶å€™éƒ½èƒ½å¿«é€Ÿæ‹¿åˆ°ä¸€ä¸ªå°æ—¶å‰çš„æ•°æ®ã€‚ è´¦å·æƒé™å¾ˆå…³é”®ï¼Œæ²¡æœ‰æƒé™åŽ»æ‰§è¡Œå¯¹åº”æ“ä½œçš„sqlå°±å¯ä»¥äº† kill query +çº¿ç¨‹idï¼Œå¯ä»¥ç»ˆæ­¢ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„sqlè¯­å¥ mysqlé‡‡ç”¨çš„æ˜¯è¾¹æŸ¥è¾¹ç»™çš„ï¼ŒæŸ¥åˆ°å°±ä¼šå‘ç»™å®¢æˆ·ç«¯ï¼Œè€Œä¸æ˜¯å…¨éƒ¨æŸ¥åˆ°å…¨éƒ¨ç»“æžœä¹‹åŽå†å‘ ä½¿ç”¨joinçš„æ—¶å€™ä¸€å®šè¦æ³¨æ„ï¼Œä½¿ç”¨æ˜¯æœ‰æ¡ä»¶çš„ï¼šå½“ä½¿ç”¨joinçš„æ—¶å€™è¢«é©±åŠ¨è¡¨èƒ½ä½¿ç”¨ç´¢å¼•ï¼Œé‚£ä¹ˆæ˜¯å¯ä»¥çš„ï¼ŒåŒæ—¶ä¹Ÿéœ€è¦æ³¨æ„ï¼Œä½¿ç”¨å°è¡¨ä½œä¸ºé©±åŠ¨è¡¨ï¼Œè¿™æ ·èƒ½è®©æ‰«æè¡Œæ•°æ›´åŠ å°‘ä¸€äº›ï¼Œå¤§è¡¨åŽ»èµ°ç´¢å¼•åŽ»ã€‚å½“ä½¿ç”¨joinçš„æ—¶å€™å¦‚æžœä¸èƒ½èµ°ç´¢å¼•çš„æƒ…å†µï¼Œé‚£ä¹ˆmysqlä¼šä½¿ç”¨BNLç®—æ³•ï¼Œå°†é©±åŠ¨è¡¨çš„æ•°æ®å’Œè¢«é©±åŠ¨è¡¨çš„æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¹¶ä¸”ä½¿ç”¨join_bufferæ¥è¿›è¡Œåˆå¹¶æ“ä½œï¼Œä½†æ˜¯è¿™æ ·æ‰«æè¡Œä¼šå˜çš„éžå¸¸çš„å·¨å¤§ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™å¦‚æžœè¡¨çš„æ•°æ®å¤ªå¤šå°±ä¸é€‚åˆä½¿ç”¨ã€‚ mysqlé¢è¯•é—®é¢˜ä¸»ä»Žå¤åˆ¶çš„åŽŸç†ä¸Žæµç¨‹ï¼Ÿ ä¸»åº“å°†ä¿®æ”¹å†™å…¥æœ¬åœ°binlogä¸­ ä»Žåº“å°†æ‹‰å–ä¸»åº“binlogå†™å…¥æœ¬åœ°relay logä¸­ ä»Žåº“è¯»å–relay logå¹¶æ‰§è¡Œï¼ˆè¿™é‡Œæ˜¯å•çº¿ç¨‹æ‰§è¡Œï¼Œä¸èƒ½å¹¶å‘ï¼Œæ‰€ä»¥æ…¢ï¼‰ innodbå’Œmyisamä¸ŽåŒºåˆ«innodbæ”¯æŒäº‹åŠ¡ï¼Œmyisamä¸æ”¯æŒinnodbæ”¯æŒè¡Œé”ï¼Œmyisamæ”¯æŒè¡¨é”innodbæ”¯æŒmvccï¼Œmyisamä¸æ”¯æŒinnodbæ”¯æŒå¤–é”®ï¼Œmyisamä¸æ”¯æŒmyisamä¸æ”¯æŒå´©æºƒåŽå®‰å…¨æ¢å¤ innodbå¼•æ“Žçš„4å¤§ç‰¹æ€§ æ’å…¥ç¼“å†²insert bufferï¼Œchange bufferï¼›å°†ä¸€ç³»åˆ—çš„æ“ä½œç¼“å­˜ï¼Œç„¶åŽä¸€æ¬¡æ€§å†™åˆ°ç£ç›˜ï¼Œç›®çš„è¿˜æ˜¯ä¸ºäº†å‡å°‘éšæœºIOå¸¦æ¥æ€§èƒ½æŸè€—ã€‚ äºŒæ¬¡å†™ï¼šä»Žinnodb buffer poolä¸­flushå†™æ–‡ä»¶ä¹‹å‰å­˜doublewrite bufferå†™åˆ°ç‰©ç†ç£ç›˜ä¸Šå…±äº«è¡¨ç©ºé—´ã€‚ è‡ªé€‚åº”å“ˆå¸Œç´¢å¼•ï¼šå½“äºŒçº§ç´¢å¼•è®¿é—®é¢‘ç¹çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨å»ºç«‹å“ˆå¸Œç´¢å¼•æ¥åŠ é€Ÿ é¢„è¯» mysqlç´¢å¼•æ–¹æ³•æœ‰å“ªäº›B-Treeç´¢å¼•ï¼šåˆ©ç”¨äºŒå‰æ ‘çš„ç‰¹æ€§ï¼ŒåŒæ—¶ä¼˜åŒ–ç£ç›˜ioï¼Œç„¶åŽæŸ¥è¯¢æ›´å¿«ï¼ŒåŒæ—¶ä¼˜åŒ–ç´¢å¼•æŸ¥è¯¢å’ŒæŽ’åºHashç´¢å¼•ï¼šåŸºäºŽhashå®žçŽ°ï¼Œåœ¨hashå†²çªä¸é«˜çš„æƒ…å†µä¸‹ï¼Œé€Ÿåº¦å¿«ï¼Œä½†æ˜¯å¯¹äºŽèŒƒå›´æŸ¥è¯¢å’ŒæŽ’åºéƒ½ä¸æ”¯æŒ mysqlç´¢å¼•ç±»åž‹æœ‰å“ªäº›ä¸»é”®ç´¢å¼•ï¼Œæ™®é€šç´¢å¼•ï¼ˆç»„åˆç´¢å¼•ï¼‰ï¼Œå”¯ä¸€ç´¢å¼•ï¼Œå…¨æ–‡ç´¢å¼•ï¼Œç©ºé—´ç´¢å¼•]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Golangçš„åžƒåœ¾å›žæ”¶]]></title>
    <url>%2F2019%2F07%2F04%2Fgolang%2Fbasic%2Fgc-go-on%2F</url>
    <content type="text"><![CDATA[æœ€è¿‘åžƒåœ¾åˆ†ç±»çš„è¯é¢˜çƒ­åº¦ä¸€ä¸‹å­å°±ä¸ŠåŽ»äº†ï¼Œå¾ˆå¤šäººå› ä¸ºåžƒåœ¾åˆ†ç±»çš„é—®é¢˜å¾ˆå¤´ç—›ã€‚å› ä¸ºåžƒåœ¾è¿™ä¸ªè¯é¢˜ï¼Œé‚£æˆ‘å°±æƒ³æ¥è¯´è¯´Golangé‡Œé¢çš„åžƒåœ¾ï¼ŒäºŽæ˜¯å°±æœ‰äº†è¿™ç¯‡åšå®¢ï¼Œgolangä¸­çš„åžƒåœ¾å›žæ”¶ã€‚ çŽ°é˜¶æ®µç½‘ä¸Šé’ˆå¯¹golangåžƒåœ¾å›žæ”¶çš„è§£æžå·²ç»å¾ˆå¤šäº†ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿæ²¡æœ‰å¿…è¦ä»”ä»”ç»†ç»†çš„ä¸€ç‚¹ç‚¹è¯´ï¼Œè¿˜æ˜¯é‚£ä¸ªåŽŸåˆ™ï¼Œç”¨æœ€ç›´ç™½çš„è¯å‘Šè¯‰ä½ ï¼Œåžƒåœ¾åˆ°åº•æ˜¯æ€Žä¹ˆæ”¶çš„ã€‚ GCçš„æ„ä¹‰é¦–å…ˆæœ¬æ–‡åŽç»­éƒ½ä¼šä½¿ç”¨ GC ä»£æ›¿åžƒåœ¾å›žæ”¶è¿™å‡ ä¸ªå­—ã€‚æˆ‘ä»¬çŸ¥é“åˆ›å»ºå¯¹è±¡ä¼šç»™ä»–åˆ†é…å†…å­˜èµ„æºï¼Œå¦‚æžœè¿™ä¸ªå¯¹è±¡ä¸ä½¿ç”¨äº†ï¼Œè€Œè¿™ä¸ªå†…å­˜èµ„æºå´ä¸€ç›´è¢«å ç”¨çš„è¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ç”µè„‘å¾ˆå¿«å°±ä¼šè¢«æ”¾æ»¡ï¼Œæ‰€ä»¥éœ€è¦å°†è¿™äº›åžƒåœ¾å¯¹è±¡è¿›è¡Œå›žæ”¶ã€‚ ä»€ä¹ˆæ‰æ˜¯åžƒåœ¾è¦å›žæ”¶ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¿…é¡»çŸ¥é“ä»€ä¹ˆæ‰æ˜¯åžƒåœ¾ï¼Œä»€ä¹ˆä¸æ˜¯åžƒåœ¾ã€‚åœ¨æˆ‘ä»¬çœ‹æ¥ï¼Œä¸€ä¸ªå¯¹è±¡ä»¥åŽéƒ½ä¸ç”¨äº†ï¼Œå°±æ˜¯åžƒåœ¾ã€‚åœ¨ç¨‹åºçœ‹æ¥ï¼Œä¸€ä¸ªå¯¹è±¡æ²¡æœ‰è¢«å¼•ç”¨äº†ï¼Œå°±æ˜¯åžƒåœ¾ã€‚ GCçš„æµç¨‹é¦–å…ˆè¯´æ˜Žä¸€ä¸‹ï¼Œä¸‹é¢è¯´çš„åœï¼Œéƒ½æ˜¯STWï¼Œstop the worldï¼Œå…¨ä¸–ç•Œæš‚åœï¼Œæ‰€æœ‰è¿è¡Œçš„éƒ½åœä¸‹æ¥äº†ã€‚è¿™ä¸ªæµç¨‹å¯ä»¥ç”±ä¸‹é¢è¿™å¼ å›¾å±•ç¤ºï¼š ç¬¬ä¸€ä¸ªè¿‡ç¨‹å…ˆå‘Šè¯‰æ‰€æœ‰äººï¼Œåœä¸€ä¸‹ï¼Œæˆ‘æ¥è®°å½•ä¸€ä¸‹å½“å‰çŠ¶æ€ã€‚ ç¬¬äºŒä¸ªè¿‡ç¨‹å‘Šè¯‰æ‰€æœ‰äººï¼Œä½ ä»¬ç»§ç»­ï¼Œè¯¥å¹²å˜›å¹²å˜›ï¼Œæˆ‘æ ‡è®°ä¸€ä¸‹è¦ç”¨çš„å¯¹è±¡ä¸€å¼€å§‹æ‰€æœ‰ç‚¹æ˜¯ç™½è‰²ï¼Œé¦–å…ˆä»Žæ ¹èŠ‚ç‚¹å‡ºå‘ï¼Œæ ‡è®°ç›¸è¿žçš„ç‚¹ä¸ºç°è‰²ï¼ˆç›¸è¿žè¯æ˜Žæœ‰å¼•ç”¨ï¼‰ï¼Œå¹¶ä¸”å°†æ‰€æœ‰ç°è‰²çš„ç‚¹å­˜èµ·æ¥ï¼›ç„¶åŽéåŽ†æ‰€æœ‰ç°è‰²çš„ç‚¹ï¼Œæ ‡è®°æ‰€æœ‰ç°è‰²çš„ç‚¹ç›¸è¿žçš„ç‚¹ä¸ºç°è‰²ï¼Œå¹¶ä¸”å°†è‡ªå·±æ ‡è®°ä¸ºé»‘è‰²ï¼›ç„¶åŽé‡å¤ï¼Œç›´åˆ°æ²¡æœ‰ç‚¹æ˜¯ç°è‰²ï¼› ç¬¬ä¸‰ä¸ªè¿‡ç¨‹å‘Šè¯‰æ‰€æœ‰äººï¼Œå†åœä¸€ä¸‹ï¼Œåœ¨ç¬¬äºŒä¸ªè¿‡ç¨‹ä¸­ï¼Œå› ä¸ºæ‰€æœ‰äººç»§ç»­åœ¨å·¥ä½œï¼Œé‚£ä¹ˆå°±ä¼šäº§ç”Ÿæ–°çš„åžƒåœ¾ï¼Œå› ä¸ºç¬¬ä¸€ä¸ªè¿‡ç¨‹è®°å½•äº†çŠ¶æ€ï¼Œæ‰€ä»¥éœ€è¦æ ‡è®°ä¸€ä¸‹æ–°çš„åžƒåœ¾ï¼›ç„¶åŽæ¸…é™¤æ‰€æœ‰ç™½è‰²çš„ç‚¹ï¼Œå› ä¸ºç™½è‰²çš„ç‚¹æ˜¯æ²¡äººå¼•ç”¨çš„ï¼Œä¹Ÿå°±æ˜¯åžƒåœ¾ã€‚ ä¸ºä»€ä¹ˆè¦è¿™æ ·GCä½ ä¸€å®šä¼šæœ‰è¿™æ ·çš„ç–‘é—®ï¼š ä¸ºä»€ä¹ˆè¦æš‚åœä¸¤æ¬¡ï¼Ÿ ä¸ºä»€ä¹ˆä¸ç›´æŽ¥æ ‡è®°ï¼Ÿ å¦‚æžœå†æ ‡è®°çš„è¿‡ç¨‹ä¸­ä¸æ–­çš„åœ¨åˆ›å»ºæ–°çš„å¯¹è±¡ï¼Œé‚£ä¹ˆæ°¸è¿œå°±æ ‡è®°ä¸å®Œäº†ã€‚ å¦‚æžœæ ‡è®°çš„è¿‡ç¨‹ä¸­ï¼ŒåŽŸæ¥çš„è¢«æ ‡è®°çš„å¯¹è±¡å¼•ç”¨å‘ç”Ÿå˜æ›´ä¹Ÿä¼šå¯¼è‡´é—®é¢˜ã€‚ é‚£ä¹ˆæ—¢ç„¶ä¼šå¯¼è‡´é‚£ä¹ˆå¤šé—®é¢˜ï¼Œä¸ºä»€ä¹ˆä¸ç›´æŽ¥åœä¸‹æ¥ï¼Œæ ‡è®°å®Œå›žæ”¶å®Œäº†å†å¼€å§‹å‘¢ï¼Ÿå› ä¸ºæ…¢~ æ‰€ä»¥è¿™æ ·GCçš„åŽŸå› æ˜¯æ—¢è¦ä¿è¯GCæ­£å¸¸æ‰§è¡Œï¼Œåˆè¦ä¿è¯æ•ˆçŽ‡ï¼Œä¸èƒ½åœçš„æ—¶é—´å¤ªé•¿ã€‚ ç¬¬ä¸€ä¸ªè¿‡ç¨‹å…¶å®žç¬¬ä¸€æ¬¡åœçš„æ—¶å€™ï¼Œå¯åŠ¨äº†ä¸€ä¸ªå†™å±éšœ (write barrier)å®ƒéœ€è¦è®°å½•åŽç»­è¿‡ç¨‹ä¸­æ–°åˆ›å»ºçš„å¯¹è±¡ ç¬¬äºŒä¸ªè¿‡ç¨‹è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºä¸‰è‰²æ ‡è®°ï¼Œæœ‰ç‚¹ç±»ä¼¼å¹¿åº¦ä¼˜å…ˆæœç´¢ã€‚ ç¬¬ä¸‰ä¸ªè¿‡ç¨‹è¿™æ¬¡æ˜¯å¿…é¡»åœï¼Œå› ä¸ºåœ¨ç¬¬äºŒä¸ªè¿‡ç¨‹ä¸­å¼•ç”¨ä¼šå‘ç”Ÿå˜åŒ–ï¼Œä»Žè€Œéœ€è¦åœæ­¢åŽé‡æ–°æ‰«æä¸€éï¼›ç„¶åŽå…³é—­å†™å±éšœï¼Œæœ€åŽå†æ¸…ç†ã€‚ é‡ ç‚¹ ä»€ä¹ˆæ—¶å€™éœ€è¦stwï¼Ÿ å¼€å¯å†™å±éšœæ—¶éœ€è¦stwå…³é—­å†™å±éšœå‰éœ€è¦stw ä»€ä¹ˆæ—¶å€™æ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼Ÿ å¼€å¯å†™å±éšœä¹‹åŽçš„æ ‡è®°è¿‡ç¨‹ä¸Žå…¶ä»–ç¨‹åºå¹¶å‘æ‰§è¡Œå…³é—­å†™å±éšœä¹‹åŽçš„æ¸…æ‰«è¿‡ç¨‹ä¸Žå…¶ä»–ç¨‹åºå¹¶å‘æ‰§è¡Œ GCçš„è§¦å‘æ¡ä»¶é‚£æ¯•ç«ŸGCè¿˜æ˜¯éœ€è¦STWçš„ï¼Œè™½ç„¶å¯èƒ½åœæ­¢æ—¶é—´å¾ˆçŸ­ï¼Œä½†æ˜¯å¯¹äºŽç¨‹åºæ¥è¯´ï¼Œæ•´ä¸ªç¨‹åºåœæ­¢1ç§’é‚£å¯¹äºŽç”¨æˆ·æ¥è¯´å°±æ˜¯è‡´å‘½æ‰“å‡»ã€‚æ‰€ä»¥GCè‚¯å®šéœ€è¦ä¸€ä¸ªè§¦å‘çš„æ¡ä»¶ï¼Œä¸èƒ½æƒ³æ¥å°±æ¥ã€‚ GCç™¾åˆ†æ¯”è¿™æ˜¯ä¸€ä¸ªè§¦å‘çš„æ¡ä»¶ï¼Œé»˜è®¤GCç™¾åˆ†æ¯”è®¾ç½®çš„æ˜¯100ï¼Œæ„æ€æ˜¯ï¼Œå¦‚æžœè¿™æ¬¡å›žæ”¶ä¹‹åŽæ€»å…±å ç”¨2Mçš„å†…å­˜ï¼Œé‚£ä¹ˆä¸‹æ¬¡è§¦å‘çš„æ¡ä»¶æ—¶å½“è¶…è¿‡4Mçš„æ—¶å€™ï¼›åŒç†ï¼Œå½“è¿™æ¬¡å›žæ”¶ä¹‹åŽæ€»å…±å ç”¨4Mï¼Œé‚£ä¹ˆä¸‹æ¬¡è§¦å‘æ¡ä»¶å°±æ˜¯8Mã€‚ 2åˆ†é’Ÿè¿™ä¸ªç®€å•ï¼Œå½“ä¸€å®šæ—¶é—´ï¼ˆ2åˆ†é’Ÿï¼‰æ²¡æœ‰æ‰§è¡Œè¿‡GCå°±è§¦å‘GCï¼ˆç§°ä¸ºGC forcedï¼‰ç›‘æŽ§æœåŠ¡ sysmon æ¯éš” 2 åˆ†é’Ÿå°±ä¼šæ£€æŸ¥ä¸€æ¬¡åžƒåœ¾ å›žæ”¶çŠ¶æ€ï¼Œå¦‚è¶…å‡º 2 åˆ†é’Ÿæœªæ›¾è§¦å‘ï¼Œé‚£å°±å¼ºåˆ¶æ‰§è¡Œã€‚ æ‰‹åŠ¨ä½¿ç”¨å‘½ä»¤runtime.GC()æ‰‹åŠ¨è§¦å‘GC å¦‚ä½•æŸ¥è¯¢gcè¿‡ç¨‹å¯åŠ¨æ—¶åŠ ä¸Šå‘½ä»¤GODEBUG=&quot;gctrace=1&quot;è¿è¡Œä¸€æ®µæ—¶é—´ä½ ä¼šçœ‹åˆ°ç±»ä¼¼ä¸‹é¢çš„è¾“å‡º12345gc 1 @351.002s 0%: 0.017+0.88+0.038 ms clock, 0.21+0/0.75/0.72+0.45 ms cpu, 4-&gt;4-&gt;2 MB, 5 MB goal, 12 Pgc 2 @351.022s 0%: 0.006+1.6+0.045 ms clock, 0.075+0/0.57/0.65+0.54 ms cpu, 8-&gt;8-&gt;7 MB, 9 MB goal, 12 Pgc 3 @351.030s 0%: 0.005+2.7+0.032 ms clock, 0.061+0/3.0/0.90+0.38 ms cpu, 15-&gt;15-&gt;13 MB, 16 MB goal, 12 Pgc 4 @351.042s 0%: 0.005+5.7+0.043 ms clock, 0.067+0/0.44/5.6+0.52 ms cpu, 29-&gt;29-&gt;25 MB, 30 MB goal, 12 Pgc 5 @351.069s 0%: 0.005+10+0.039 ms clock, 0.063+0/0.33/10+0.47 ms cpu, 57-&gt;57-&gt;49 MB, 58 MB goal, 12 P 1 è¡¨ç¤ºç¬¬ä¸€æ¬¡æ‰§è¡Œ @351.002s è¡¨ç¤ºç¨‹åºæ‰§è¡Œçš„æ€»æ—¶é—´ 0% åžƒåœ¾å›žæ”¶æ—¶é—´å ç”¨çš„ç™¾åˆ†æ¯” 0.017+0.88+0.038 ms clock åžƒåœ¾å›žæ”¶çš„æ—¶é—´ï¼Œåˆ†åˆ«stop-the-world (STW) sweep termination + concurrent mark and scan + and STW mark termination0.017è¡¨ç¤ºmarké˜¶æ®µstwçš„æ—¶é—´ï¼Œæ˜¯ç¬¬ä¸€æ¬¡stwï¼ŒçŸ­æš‚çš„é‚£ä¸ªã€‚0.88è¡¨ç¤ºå¹¶å‘æ ‡è®°å’Œæ‰«æçš„æ—¶é—´ã€‚0.038è¡¨ç¤ºmark terminationä¸­stwçš„æ—¶é—´ï¼Œç¬¬äºŒæ¬¡stwï¼Œé•¿çš„é‚£ä¸ªã€‚ 0.10+0.23/5.4/12+0.40 ms cpuï¼šæŒ‰é¡ºåºåˆ†æˆä¸‰éƒ¨åˆ†ï¼Œ0.10è¡¨ç¤ºæ•´ä¸ªè¿›ç¨‹åœ¨marké˜¶æ®µSTWåœé¡¿æ—¶é—´(0.013 8)ï¼›0.23/5.4/12æœ‰ä¸‰å—ä¿¡æ¯ï¼Œ0.23æ˜¯mutator assistså ç”¨çš„æ—¶é—´ï¼Œ5.4æ˜¯dedicated mark workers+fractional mark workerå ç”¨çš„æ—¶é—´ï¼Œ12æ˜¯idle mark workerså ç”¨çš„æ—¶é—´ã€‚è¿™ä¸‰å—æ—¶é—´åŠ èµ·æ¥ä¼šæŽ¥è¿‘2.98(Pçš„ä¸ªæ•°)ï¼›0.40 msè¡¨ç¤ºæ•´ä¸ªè¿›ç¨‹åœ¨markTerminationé˜¶æ®µSTWåœé¡¿æ—¶é—´(0.050 * 8)ã€‚ 4-&gt;4-&gt;2 MB æŒ‰é¡ºåºåˆ†æˆä¸‰éƒ¨åˆ†ï¼Œ4è¡¨ç¤ºå¼€å§‹marké˜¶æ®µå‰çš„heap_liveå¤§å°ï¼›4è¡¨ç¤ºå¼€å§‹markTerminationé˜¶æ®µå‰çš„heap_liveå¤§å°ï¼›2è¡¨ç¤ºè¢«æ ‡è®°å¯¹è±¡çš„å¤§å°ã€‚ 5 MB goal è¡¨ç¤ºä¸‹ä¸€æ¬¡è§¦å‘GCçš„å†…å­˜å ç”¨é˜€å€¼æ˜¯5MBï¼Œç­‰äºŽ2MB * 2ï¼Œå‘ä¸Šå–æ•´ã€‚ 12 P ä½¿ç”¨çš„Processoræ•°é‡ æ€»ç»“ä»¥ä¸Šå°±æ˜¯åœ¨golangä¸­åžƒåœ¾å›žæ”¶çš„å¤§è‡´æµç¨‹ï¼Œæ€»çš„æ¥è¯´ä½¿ç”¨ä¸‰è‰²æ ‡è®°æ³•è¿›è¡Œæ ‡è®°æ¸…é™¤ï¼Œå¹¶ä¸”æ ‡è®°æ—¶ä¸Žç¨‹åºè¿è¡Œå¹¶è¡Œï¼Œä¸ºäº†è§£å†³é—®é¢˜ä½¿ç”¨å†™å±éšœæ¥è®°å½•æ ‡è®°è¿‡ç¨‹ä¸­å¯¹è±¡çš„å˜æ›´ã€‚æ€»æ¥çš„æ¥è¯´ä¹Ÿæ˜¯ä¸ºäº†æé«˜åžƒåœ¾å›žæ”¶çš„æ•ˆçŽ‡ï¼Œå¹¶ä¸”å°½å¯èƒ½çš„å‡å°‘STWçš„æ—¶é—´ã€‚äº†è§£ä¸‹æ¥ï¼Œä¸Žjavaçš„åˆ†ä»£å›žæ”¶ç›¸æ¯”ï¼Œgolangä¸­çš„å›žæ”¶ç®—æ³•ç†è§£èµ·æ¥æ›´åŠ ç®€å•ä¸€äº›ã€‚ å‚è€ƒæ–‡ç« https://studygolang.com/articles/21569https://spin.atomicobject.com/2014/09/03/visualizing-garbage-collection-algorithms/https://www.jianshu.com/p/8b0c0f7772dahttp://legendtkl.com/2017/04/28/golang-gc/]]></content>
      <categories>
        <category>golangåŸºç¡€</category>
      </categories>
      <tags>
        <tag>gc</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä¸æ˜¯æˆ‘å¹ï¼Œä½ å¯èƒ½è¿ždeferéƒ½ä¸æ¸…æ¥š]]></title>
    <url>%2F2019%2F07%2F02%2Fgolang%2Fbasic%2Fdefer-dis%2F</url>
    <content type="text"><![CDATA[åœ¨golangä¸­ï¼Œå¯¹äºŽdeferï¼Œæˆ‘ä¹‹å‰çš„ç†è§£å°±æ˜¯å’Œjavaä¸­çš„finallyä»£ç å—ä¸€æ ·ï¼Œæ²¡ä»€ä¹ˆéš¾åº¦ï¼Œä½†æ˜¯å§ï¼Œå½“æˆ‘æœ€è¿‘çœ‹çš„ä¸€äº›ç¥žå¥‡çš„é—®é¢˜ï¼Œæˆ‘å°±å‘çŽ°åŽŸæ¥å¹¶éžæƒ³çš„é‚£ä¹ˆç®€å•ã€‚ å…ˆä¸¾ä¸ªæ —å­123456789101112131415161718192021222324252627282930313233343536373839404142package mainimport "fmt"func main() &#123; fmt.Println(DeferFunc1(1)) fmt.Println(DeferFunc2(1)) fmt.Println(DeferFunc3(1)) DeferFunc4()&#125;func DeferFunc1(i int) (t int) &#123; t = i defer func() &#123; t += 3 &#125;() return t&#125;func DeferFunc2(i int) int &#123; t := i defer func() &#123; t += 3 &#125;() return t&#125;func DeferFunc3(i int) (t int) &#123; defer func() &#123; t += i &#125;() return 2&#125;func DeferFunc4() (t int) &#123; defer func(i int) &#123; fmt.Println(i) fmt.Println(t) &#125;(t) t = 1 return 2&#125; è¯·é—®è¿™æ®µä»£ç è¾“å‡ºçš„ç»“æžœæ˜¯ä»€ä¹ˆï¼Ÿç­”æ¡ˆè§æ–‡æœ«å¦‚æžœä½ çœ‹å®Œç­”å¯¹äº†ï¼Œé‚£ä¹ˆè¯·ç›´æŽ¥ç‚¹å‡»å³ä¸Šè§’çš„å…³é—­æŒ‰é’®ï¼Œå¦‚æžœä½ ç­”é”™äº†ï¼Œä½ å¯ä»¥ç»§ç»­å¾€ä¸‹çœ‹äº†ã€‚ä¸‹é¢ä¼šä¸€æ­¥æ­¥ä»‹ç»ï¼Œåˆ°åº•ä¸ºä»€ä¹ˆç»“æžœä¼šæ˜¯è¿™æ · åŸºç¡€çŸ¥è¯†å‡½æ•°çš„è¿”å›žå€¼åˆå§‹åŒ–å¦‚ ï¼š func DeferFunc1(i int) (t int) {å…¶ä¸­è¿”å›žå€¼t intï¼Œè¿™ä¸ªtä¼šåœ¨å‡½æ•°èµ·å§‹å¤„è¢«åˆå§‹åŒ–ä¸ºå¯¹åº”ç±»åž‹çš„é›¶å€¼å¹¶ä¸”ä½œç”¨åŸŸä¸ºæ•´ä¸ªå‡½æ•°ã€‚ deferçš„æ‰§è¡Œé¡ºåºè™½ç„¶è¿™è¾¹æ²¡æœ‰æåŠï¼Œä½†æ˜¯è¿˜æ˜¯è¦è¯´ä¸€ä¸‹ï¼Œå› ä¸ºå¾ˆå¤šäººå­¦ä¹ deferçš„æ—¶å€™éƒ½ä¼šç”¨åˆ°ï¼Œå°±æ˜¯å½“å¤šä¸ªdeferå‡ºçŽ°çš„æ—¶å€™ï¼Œå®ƒæ˜¯ä¸€ä¸ªâ€œæ ˆâ€çš„å…³ç³»ï¼Œä¹Ÿå°±æ˜¯å…ˆè¿›åŽå‡ºã€‚ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œå†™åœ¨å‰é¢çš„deferä¼šæ¯”å†™åœ¨åŽé¢çš„deferè°ƒç”¨çš„æ™šã€‚ deferä¸Žreturnè°å…ˆè°åŽreturnå…ˆï¼ŒdeferåŽè¿™ä¸ªå¯èƒ½ä¼šè®©äººæ€€ç–‘ï¼ŒåŽé¢ä¼šè¯¦ç»†è§£é‡Šã€‚ å‡½æ•°çš„è¿”å›žä¸Žreturnåœ¨æ²¡æœ‰deferçš„æƒ…å†µä¸‹ï¼Œå…¶å®žå‡½æ•°çš„è¿”å›žå°±æ˜¯ä¸Žreturnä¸€è‡´çš„ï¼Œä½†æ˜¯æœ‰äº†deferå°±ä¸ä¸€æ ·äº†ã€‚å‡½æ•°çš„è¿”å›žå…¶å®žæ˜¯æœ‰ä¸¤ä¸ªæ­¥éª¤çš„ï¼Œç¬¬ä¸€ä¸ªå½“æ‰§è¡Œåˆ°returnè¯­å¥çš„æ—¶å€™123456func DeferFunc3(i int) (t int) &#123; defer func() &#123; t += i &#125;() return 2&#125; è¿™ä¸ªæ—¶å€™ä¼šå…ˆå°†è¿”å›žå€¼tèµ‹å€¼ä¸º2ï¼Œç„¶åŽæ‰§è¡Œdeferï¼Œå®Œæˆä¹‹åŽæ‰ä¼šçœŸæ­£è¿”å›žå¤–éƒ¨è°ƒç”¨è€…ã€‚ deferè°ƒç”¨çš„ä¸‰æ­¥èµ°è¿™ä¸ªå°±æ˜¯ä»Šå¤©çš„é‡å¤´æˆäº†ï¼Œdeferè¿™ä¸ªè¯­æ³•å…¶å®žä¸€å…±æœ‰ä¸‰ä¸ªæ­¥éª¤ã€‚ å°†deferæ–¹æ³•ä¸­çš„å‚æ•°è¿›è¡Œèµ‹å€¼ã€‚ å°†deferåŽ‹å…¥æ ˆä¸­ã€‚ å½“returnæˆ–è€…æ˜¯panicçš„æ—¶å€™ä¾æ¬¡å‡ºæ ˆæ‰§è¡Œã€‚åŽé¢ä¼šç”¨å®žé™…çš„ä¾‹å­è¯´æ˜Žå…·ä½“æ‰§è¡Œçš„æƒ…å†µã€‚ è§£é‡Šæœ‰äº†ä¸Šé¢çš„æ‰€æœ‰çŸ¥è¯†ç‚¹ï¼Œå…¶å®žä½ å°±åº”è¯¥èƒ½æ˜Žç™½ä¸Šé¢è¾“å‡ºçš„ç»“æžœäº†ã€‚å¦‚æžœè¿˜ä¸æ˜Žç™½å°±çœ‹çœ‹ä¸‹é¢çš„åˆ†æžè§£é‡Šå§ã€‚ DeferFunc11234567func DeferFunc1(i int) (t int) &#123; t = i defer func() &#123; t += 3 &#125;() return t&#125; é¦–å…ˆä¸Šé¢æ˜¯ç¬¬ä¸€ä¸ªæ–¹æ³• å°†è¿”å›žå€¼tèµ‹å€¼ä¸ºä¼ å…¥çš„iï¼Œæ­¤æ—¶tä¸º1 æ‰§è¡Œreturnè¯­å¥å°†tèµ‹å€¼ç»™tï¼ˆç­‰äºŽå•¥ä¹Ÿæ²¡åšï¼‰ æ‰§è¡Œdeferæ–¹æ³•ï¼Œå°†t + 3 = 4 å‡½æ•°è¿”å›ž 4å› ä¸ºtçš„ä½œç”¨åŸŸä¸ºæ•´ä¸ªå‡½æ•°æ‰€ä»¥ä¿®æ”¹æœ‰æ•ˆã€‚ DeferFunc21234567func DeferFunc2(i int) int &#123; t := i defer func() &#123; t += 3 &#125;() return t&#125; ç¬¬äºŒä¸ªæ–¹æ³• åˆ›å»ºå˜é‡tå¹¶èµ‹å€¼ä¸º1 æ‰§è¡Œreturnè¯­å¥ï¼Œæ³¨æ„è¿™é‡Œæ˜¯å°†tèµ‹å€¼ç»™è¿”å›žå€¼ï¼Œæ­¤æ—¶è¿”å›žå€¼ä¸º1ï¼ˆè¿™ä¸ªè¿”å›žå€¼å¹¶ä¸æ˜¯tï¼‰ æ‰§è¡Œdeferæ–¹æ³•ï¼Œå°†t + 3 = 4 å‡½æ•°è¿”å›žè¿”å›žå€¼1 å¯èƒ½è¿™é‡Œå°±æœ‰ç‚¹éš¾ç†è§£äº†ï¼Œä¿®æ”¹ä¸€ä¸‹ä»£ç ä½ å°±æ˜Žç™½äº†1234567func DeferFunc2(i int) (result int) &#123; t := i defer func() &#123; t += 3 &#125;() return t&#125; ä¸Šé¢çš„ä»£ç returnçš„æ—¶å€™ç›¸å½“äºŽå°†tèµ‹å€¼ç»™äº†resultï¼Œå½“deferä¿®æ”¹äº†tçš„å€¼ä¹‹åŽï¼Œå¯¹resultæ˜¯ä¸ä¼šé€ æˆå½±å“çš„ã€‚ DeferFunc3123456func DeferFunc3(i int) (t int) &#123; defer func() &#123; t += i &#125;() return 2&#125; é¦–å…ˆæ‰§è¡Œreturnå°†è¿”å›žå€¼tèµ‹å€¼ä¸º2 æ‰§è¡Œdeferæ–¹æ³•å°†t + 1 æœ€åŽè¿”å›ž 3 DeferFunc412345678func DeferFunc4() (t int) &#123; defer func(i int) &#123; fmt.Println(i) fmt.Println(t) &#125;(t) t = 1 return 2&#125; è¿™ä¸ªåˆ†æžçš„æ­¥éª¤è¦è¯¦ç»†ä¸€äº› åˆå§‹åŒ–è¿”å›žå€¼tä¸ºé›¶å€¼ 0 é¦–å…ˆæ‰§è¡Œdeferçš„ç¬¬ä¸€æ­¥ï¼Œèµ‹å€¼deferä¸­çš„funcå…¥å‚tä¸º0 æ‰§è¡Œdeferçš„ç¬¬äºŒæ­¥ï¼Œå°†deferåŽ‹æ ˆ å°†tèµ‹å€¼ä¸º1 æ‰§è¡Œreturnè¯­å¥ï¼Œå°†è¿”å›žå€¼tèµ‹å€¼ä¸º2 æ‰§è¡Œdeferçš„ç¬¬ä¸‰æ­¥ï¼Œå‡ºæ ˆå¹¶æ‰§è¡Œå› ä¸ºåœ¨å…¥æ ˆæ—¶deferæ‰§è¡Œçš„funcçš„å…¥å‚å·²ç»èµ‹å€¼äº†ï¼Œæ­¤æ—¶å®ƒä½œä¸ºçš„æ˜¯ä¸€ä¸ªå½¢å¼å‚æ•°ï¼Œæ‰€ä»¥æ‰“å°ä¸º0ï¼›ç›¸å¯¹åº”çš„å› ä¸ºæœ€åŽå·²ç»å°†tçš„å€¼ä¿®æ”¹ä¸º2ï¼Œæ‰€ä»¥å†æ‰“å°ä¸€ä¸ª2 æºç ä¸€çž¥é‚£ä¹ˆ defer åœ¨åº•å±‚ç©¶ç«Ÿæ˜¯å¦‚ä½•å®žçŽ°çš„å‘¢ï¼Ÿé€šè¿‡ç”Ÿæˆæ±‡ç¼–ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸‹é¢è¿™æ ·çš„æ–¹æ³•ï¼šCALL runtime.deferproc(SB)CALL runtime.deferreturn(SB)å®žé™…ä¸Šæ¥è¯´å½“æˆ‘ä»¬ä½¿ç”¨deferçš„ä½¿ç”¨å°±ä¼šè°ƒç”¨runtime.deferprocï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œå°±ä¼šå°†æ‰€æœ‰çš„å‚æ•°èµ‹å€¼å¥½ï¼Œæ‰€æœ‰å°±åƒæˆ‘ä»¬ä¸Šé¢ä¾‹å­ä¸­çœ‹åˆ°çš„ä¸€æ ·ï¼Œåœ¨è°ƒç”¨deferçš„æ—¶å€™å‚æ•°ä¼šå…ˆè®¡ç®—å¥½ä¿å­˜èµ·æ¥ï¼Œç„¶åŽæŒ‚è½½åˆ°G._deferä¸­ï¼Œæœ€åŽdeferreturnçš„æ—¶å€™è¿›è¡Œæ‰§è¡Œç›¸å…³çš„deferä¸­çš„æ–¹æ³•123456789101112131415161718func deferproc(siz int32, fn *funcval) &#123; // arguments of fn follow fn sp := getcallersp(unsafe.Pointer(&amp;siz)) argp := uintptr(unsafe.Pointer(&amp;fn)) + unsafe.Sizeof(fn) callerpc := getcallerpc(unsafe.Pointer(&amp;siz)) systemstack(func() &#123; d := newdefer(siz)&#125;)d.fn = fnd.pc = callerpcd.sp = spmemmove(add(unsafe.Pointer(d), unsafe.Sizeof(*d)), unsafe.Pointer(argp), uintptr(siz)) // deferproc returns 0 normally. // a deferred func that stops a panic makes the deferproc return 1. // the code the compiler generates always checks the return value and jumps to the // end of the function if deferproc returns != 0. return0()&#125; æ€»ç»“çœ‹å®Œï¼Œæœ‰çš„äººè‚¯å®šåˆè¦å‡ºæ¥æžäº‹äº†ï¼Œè¯´è¿™ä¸ªåœ¨å®žé™…ä¸­ä¸ä¼šé‡åˆ°çš„ï¼Œå®žé™…ä¸­è°å†™è¿™ä¹ˆè ¢çš„ä»£ç ã€‚ä½†æ˜¯å…¶å®žæŸäº›æ—¶å€™éžå¸¸é‡è¦ï¼Œå½“æˆ‘ä»¬éœ€è¦åœ¨deferä¸­è¿”å›žä¸€äº›é”™è¯¯ä¿¡æ¯çš„æ—¶å€™ï¼Œå¹¶ä¸”éœ€è¦å°†è¿™äº›ä¿¡æ¯ç»™åˆ°è°ƒç”¨è€…çš„æ—¶å€™ï¼Œå°±éœ€è¦æ³¨æ„å˜é‡çš„ä½œç”¨åŸŸä»¥åŠæ‰§è¡Œé¡ºåºæ‰€å¸¦æ¥çš„å·®å¼‚ã€‚ è€Œä¸”æ­£å› ä¸ºè¿™æ ·çš„æ‰§è¡Œé¡ºåºï¼Œåœ¨å®žé™…ä¸­è¦è®°ä½ï¼šdefer æœ€å¤§çš„åŠŸèƒ½æ˜¯ panic åŽä¾ç„¶æœ‰æ•ˆæ‰€ä»¥deferå¯ä»¥ä¿è¯ä½ çš„ä¸€äº›èµ„æºä¸€å®šä¼šè¢«å…³é—­ï¼Œä»Žè€Œé¿å…ä¸€äº›å¼‚å¸¸å‡ºçŽ°çš„é—®é¢˜ã€‚ å‚è€ƒä¾‹å­æ¥æºäºŽç½‘ç»œï¼Œè‡ªå·±åšäº†ä¿®æ”¹å’Œç»“åˆï¼šhttps://stackoverflow.com/questions/52718143/is-golang-defer-statement-execute-before-or-after-return-statement ç­”æ¡ˆ41302]]></content>
      <categories>
        <category>golangåŸºç¡€</category>
      </categories>
      <tags>
        <tag>defer</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Golangä¹‹context]]></title>
    <url>%2F2019%2F06%2F27%2Fgolang%2Fsource-code%2Fcontext-code-view%2F</url>
    <content type="text"><![CDATA[å½“æˆ‘ä»¬ä½¿ç”¨ä¸€äº›golangæ¡†æž¶çš„æ—¶å€™ï¼Œæ€»èƒ½åœ¨æ¡†æž¶ä¸­å‘çŽ°æœ‰ä¸ªå«åšcontextçš„ä¸œè¥¿ã€‚å¦‚æžœä½ ä¹‹å‰äº†è§£è¿‡javaçš„springï¼Œé‚£ä¹ˆä½ è‚¯å®šä¹Ÿå¬è¯´è¿‡å…¶ä¸­æœ‰ä¸ªç‰›é€¼çš„ApplicationContextã€‚Contextè¿™ä¸ªä¸œè¥¿å¥½åƒéšæ—¶éšåœ°éƒ½åœ¨å‡ºçŽ°ï¼Œåœ¨golangä¸­ä¹Ÿæ˜¯éžå¸¸é‡è¦çš„å­˜åœ¨ã€‚ä»Šå¤©æˆ‘ä»¬å°±æ¥çœ‹çœ‹è¿™ä¸ªç¥žå¥‡çš„Contextã€‚ å®šä¹‰ é¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“ä»€ä¹ˆæ˜¯contextï¼Ÿ å¾ˆå¤šäººæŠŠå®ƒç¿»è¯‘æˆä¸Šä¸‹æ–‡ï¼Œå…¶å®žè¿™ä¸ªæ˜¯ä¸€ä¸ªå¾ˆéš¾æè¿°å¾ˆå®šä¹‰çš„ä¸œè¥¿ï¼Œå¯¹äºŽè¿™ç§ä¸œè¥¿ï¼Œæˆ‘ä¹ æƒ¯ç”¨åŠŸèƒ½åŽ»å®šä¹‰å®ƒã€‚æˆ‘çš„å®šä¹‰æ˜¯ï¼šcontextæ˜¯ç”¨äºŽåœ¨å¤šä¸ªgoroutinesä¹‹é—´ä¼ é€’ä¿¡æ¯çš„åª’ä»‹ã€‚å®˜æ–¹å®šä¹‰ï¼šAt Google, we developed a context package that makes it easy to pass request-scoped values, cancelation signals, and deadlines across API boundaries to all the goroutines involved in handling a request. ç”¨æ³•åŒæ ·çš„æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å®ƒçš„ä¸€äº›åŸºæœ¬ç”¨æ³•ï¼Œå¤§è‡´äº†è§£å®ƒçš„ä½¿ç”¨ã€‚ ä¼ é€’ä¿¡æ¯123456func main() &#123; ctx := context.Background() ctx = context.WithValue(ctx, "xxx", "123") value := ctx.Value("xxx") fmt.Println(value)&#125; å…¶å®žä¼ é€’æ¶ˆæ¯å¾ˆç®€å•ï¼Œåªéœ€è¦é€šè¿‡context.WithValueæ–¹æ³•è®¾ç½®ï¼Œkey-valueç„¶åŽé€šè¿‡ctx.Valueæ–¹æ³•å–å€¼å°±å¯ä»¥äº†ã€‚ æš‚æ—¶ä¸ç”¨å…³å¿ƒcontext.Background()åªè¦çŸ¥é“contextæœ‰ä¼ é€’å€¼çš„åŠŸèƒ½å°±å¯ä»¥äº†ã€‚ å…³é—­goroutineåœ¨æˆ‘ä»¬å†™golangçš„æ—¶å€™goroutineæ˜¯ä¸€ä¸ªéžå¸¸å¸¸ç”¨çš„ä¸œè¥¿ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šå¼€ä¸€ä¸ªgoroutineåŽ»å¤„ç†å¯¹åº”çš„ä»»åŠ¡ï¼Œç‰¹åˆ«æ˜¯ä¸€äº›å¾ªçŽ¯ä¸€ç›´å¤„ç†çš„æƒ…å†µï¼Œè¿™äº›goroutineéœ€è¦çŸ¥é“è‡ªå·±ä»€ä¹ˆæ—¶å€™è¦åœæ­¢ã€‚æˆ‘ä»¬å¸¸è§çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ä¸€ä¸ªchannelåŽ»æŽ¥æ”¶ä¸€ä¸ªå…³é—­çš„ä¿¡å·ï¼Œæ”¶åˆ°ä¿¡å·ä¹‹åŽå…³é—­ï¼Œæˆ–è€…è¯´ï¼Œéœ€è¦ä¸€ä¸ªæ ‡è¯†ç¬¦ï¼Œæ¯ä¸ªgoroutineåŽ»åˆ¤æ–­è¿™ä¸ªæ ‡è¯†ç¬¦çš„å˜æ›´ä»Žè€Œå¾—çŸ¥ä»€ä¹ˆæ—¶å€™å…³é—­ã€‚é‚£ä¹ˆç”¨contextå¦‚ä½•å®žçŽ°å‘¢ï¼Ÿ 12345678910111213141516171819202122232425262728293031323334func main() &#123; ctx, _ := context.WithTimeout(context.Background(), time.Second * 3) go func() &#123; go1(ctx) &#125;() go func() &#123; go2(ctx) &#125;() time.Sleep(time.Second * 5)&#125;func go1(ctx context.Context) &#123; for &#123; fmt.Println("1 æ­£åœ¨å·¥ä½œ") select &#123; case &lt;-ctx.Done(): fmt.Println("1 åœæ­¢å·¥ä½œ") return case &lt;-time.After(time.Second): &#125; &#125;&#125;func go2(ctx context.Context) &#123; for &#123; fmt.Println("2 æ­£åœ¨å·¥ä½œ") select &#123; case &lt;-ctx.Done(): fmt.Println("2 åœæ­¢å·¥ä½œ") return case &lt;-time.After(time.Second): &#125; &#125;&#125; é€šè¿‡context.WithTimeoutæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª3ç§’åŽè‡ªåŠ¨å–æ¶ˆçš„contextï¼›æ‰€æœ‰å·¥ä½œgoroutineç›‘å¬ctx.Done()çš„ä¿¡å·ï¼›æ”¶åˆ°ä¿¡å·å°±è¯æ˜Žéœ€è¦å–æ¶ˆä»»åŠ¡ï¼› å…¶å®žä½¿ç”¨èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹å†…éƒ¨çš„åŽŸç†ã€‚ æºç è§£æžåˆ›å»ºcontext.TODO()è¿™ä¸ªå°±æ˜¯åˆ›å»ºä¸€ä¸ªå ä½ç”¨çš„contextï¼Œå¯èƒ½åœ¨å†™ç¨‹åºçš„è¿‡ç¨‹ä¸­è¿˜ä¸èƒ½ç¡®å®šåŽæœŸè¿™ä¸ªcontextçš„ä½œç”¨ï¼Œæ‰€ä»¥æš‚æ—¶ç”¨è¿™ä¸ªå ä½ context.Background()è¿™ä¸ªæ˜¯æœ€å¤§çš„contextï¼Œä¹Ÿå°±æ˜¯æ ¹contextï¼Œè¿™é‡Œå°±æœ‰å¿…è¦è¯´ä¸€ä¸‹contextçš„æ•´ä¸ªæž„æˆäº†ï¼Œcontextå…¶å®žæž„æˆçš„æ˜¯ä¸€æ£µæ ‘ï¼ŒBackgroundä¸ºæ ¹èŠ‚ç‚¹ï¼Œæ¯æ¬¡åˆ›å»ºä¸€ä¸ªæ–°çš„contextå°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„èŠ‚ç‚¹åŠ å…¥è¿™æ£µæ ‘ã€‚ context.WithTimeout()æ¯”å¦‚è¿™ä¸ªæ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ªè‡ªåŠ¨è¿‡æœŸçš„context12345678910111213// WithTimeout returns WithDeadline(parent, time.Now().Add(timeout)).//// Canceling this context releases resources associated with it, so code should// call cancel as soon as the operations running in this Context complete://// func slowOperationWithTimeout(ctx context.Context) (Result, error) &#123;// ctx, cancel := context.WithTimeout(ctx, 100*time.Millisecond)// defer cancel() // releases resources if slowOperation completes before timeout elapses// return slowOperation(ctx)// &#125;func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc) &#123; return WithDeadline(parent, time.Now().Add(timeout))&#125; å¯ä»¥çœ‹åˆ°éœ€è¦ä¼ å…¥ä¸€ä¸ªparentï¼Œå’Œè¿‡æœŸæ—¶é—´ï¼Œæ–°åˆ›å»ºçš„contextå°±æ˜¯parentçš„å­èŠ‚ç‚¹ã€‚123456789101112131415161718192021222324func WithDeadline(parent Context, d time.Time) (Context, CancelFunc) &#123; if cur, ok := parent.Deadline(); ok &amp;&amp; cur.Before(d) &#123; // The current deadline is already sooner than the new one. return WithCancel(parent) &#125; c := &amp;timerCtx&#123; cancelCtx: newCancelCtx(parent), deadline: d, &#125; propagateCancel(parent, c) dur := time.Until(d) if dur &lt;= 0 &#123; c.cancel(true, DeadlineExceeded) // deadline has already passed return c, func() &#123; c.cancel(true, Canceled) &#125; &#125; c.mu.Lock() defer c.mu.Unlock() if c.err == nil &#123; c.timer = time.AfterFunc(dur, func() &#123; c.cancel(true, DeadlineExceeded) &#125;) &#125; return c, func() &#123; c.cancel(true, Canceled) &#125;&#125; æ³¨æ„å…¶ä¸­cancelCtx: newCancelCtx(parent),å…¶å®žæ˜¯åˆ›å»ºäº†ä¸€ä¸ªå¯ä»¥å–æ¶ˆçš„ctxï¼Œç„¶åŽåˆ©ç”¨time.AfterFuncæ¥å®žçŽ°å®šæ—¶è‡ªåŠ¨è¿‡æœŸã€‚ è¿˜æœ‰ä¸€ä¸ªç»†èŠ‚c.mu.Lock()defer c.mu.Unlock()è¿™ä¸ªmuæ¥è‡ªï¼š12345678type cancelCtx struct &#123; Context mu sync.Mutex // protects following fields done chan struct&#123;&#125; // created lazily, closed by first cancel call children map[canceler]struct&#123;&#125; // set to nil by the first cancel call err error // set to non-nil by the first cancel call&#125; è¿™ä¸ªcontextå› ä¸ºæœ‰äº†é”ï¼Œæ‰€ä»¥æ˜¯å¹¶å‘å®‰å…¨çš„ã€‚ å–æ¶ˆ12345678910111213141516171819202122232425262728// cancel closes c.done, cancels each of c's children, and, if// removeFromParent is true, removes c from its parent's children.func (c *cancelCtx) cancel(removeFromParent bool, err error) &#123; if err == nil &#123; panic("context: internal error: missing cancel error") &#125; c.mu.Lock() if c.err != nil &#123; c.mu.Unlock() return // already canceled &#125; c.err = err if c.done == nil &#123; c.done = closedchan &#125; else &#123; close(c.done) &#125; for child := range c.children &#123; // NOTE: acquiring the child's lock while holding parent's lock. child.cancel(false, err) &#125; c.children = nil c.mu.Unlock() if removeFromParent &#123; removeChild(c.Context, c) &#125;&#125; å½“è¾¾åˆ°è¿‡æœŸæ—¶é—´æˆ–è€…è°ƒç”¨cancelFuncçš„æ—¶å€™å°±ä¼šè§¦å‘contextçš„å–æ¶ˆï¼Œç„¶åŽçœ‹åˆ°ä¸Šé¢çš„æºç ä½ å°±æ˜Žç™½äº†ï¼Œå–æ¶ˆçš„æ—¶å€™æœ‰ä¸€ä¸ªä¸‰ä¸ªæ“ä½œï¼š c.mu.Lock() åŠ é”ä¿è¯å®‰å…¨ close(c.done) å°†doneä¿¡é“å…³é—­ï¼Œä»Žè€Œæ‰€æœ‰åœ¨è§‚å¯Ÿdoneä¿¡é“çš„goroutineéƒ½çŸ¥é“è¦å…³é—­äº† for child := range c.children å¾ªçŽ¯æ¯ä¸ªå­èŠ‚ç‚¹ï¼Œå…³é—­æ¯ä¸ªå­èŠ‚ç‚¹ã€‚æˆ‘ä»¬çŸ¥é“contextçš„ç»“æž„æ˜¯æ ‘çŠ¶çš„ï¼Œæ‰€ä»¥åŒæ—¶æˆ‘ä»¬è¦æ³¨æ„çˆ¶èŠ‚ç‚¹å¦‚æžœå…³é—­ä¼šå…³é—­å­èŠ‚ç‚¹çš„contextã€‚ WithValueå’ŒValue1234type valueCtx struct &#123; Context key, val interface&#123;&#125;&#125; é¦–å…ˆvalueCtxçš„ç»“æž„å¦‚ä¸Šæ‰€ç¤ºï¼ŒåŒ…å«ä¸€ä¸ªContextå’Œkey-val 123456789func WithValue(parent Context, key, val interface&#123;&#125;) Context &#123; if key == nil &#123; panic("nil key") &#125; if !reflect.TypeOf(key).Comparable() &#123; panic("key is not comparable") &#125; return &amp;valueCtx&#123;parent, key, val&#125;&#125; å…¶å®žè¿™ä¸ªæ–¹æ³•å¾ˆç®€å•ï¼Œå°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ªparentçš„æ‹·è´ï¼Œå¹¶ä¸”å°†å¯¹åº”çš„keyå’Œvalæ”¾è¿›åŽ»ã€‚ 123456func (c *valueCtx) Value(key interface&#123;&#125;) interface&#123;&#125; &#123; if c.key == key &#123; return c.val &#125; return c.Context.Value(key)&#125; Valueæ–¹æ³•å°±æ›´ç®€å•äº†ï¼Œå°±æ˜¯åˆ¤æ–­å½“å‰keyæ˜¯å¦åŒ¹é…ï¼Œå¦‚æžœä¸åŒ¹é…å°±åŽ»å­èŠ‚ç‚¹å¯»æ‰¾ã€‚ æ¡ˆä¾‹æœ€åŽæˆ‘ä»¬æ¥çœ‹çœ‹åœ¨å®žé™…çš„ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åœ¨å“ªé‡Œä½¿ç”¨åˆ°äº†contextï¼Œæˆ‘ä¸¾ä¸¤ä¸ªå®žé™…ä¸­å¸¸ç”¨çš„æ¡†æž¶ginå’Œetcd ginginæ˜¯ä¸€ä¸ªwebæ¡†æž¶ï¼Œåœ¨webå¼€å‘çš„æ—¶å€™éžå¸¸å®žç”¨ã€‚1234567891011121314func main() &#123; router := gin.Default() router.POST("/post", func(c *gin.Context) &#123; id := c.Query("id") page := c.DefaultQuery("page", "0") name := c.PostForm("name") message := c.PostForm("message") fmt.Printf("id: %s; page: %s; name: %s; message: %s", id, page, name, message) &#125;) router.Run(":8080")&#125; å…¶å®žå¾ˆå¤šwebæ¡†æž¶éƒ½æœ‰Contextï¼Œä»–ä»¬éƒ½è‡ªå·±å°è£…äº†ä¸€ä¸ªContextï¼Œåˆ©ç”¨è¿™ä¸ªContextå¯ä»¥åšåˆ°ä¸€ä¸ªrequest-scopeä¸­çš„å‚æ•°ä¼ é€’å’Œè¿”å›žï¼Œè¿˜æœ‰å¾ˆå¤šæ“ä½œé€šé€šéƒ½å¯ä»¥ç”¨Contextæ¥å®Œæˆã€‚ etcdå¦‚æžœä½ æ²¡æœ‰äº†è§£è¿‡etcdä½ å°±å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆredisï¼Œå®ƒå…¶å®žæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„k-væ•°æ®å­˜å‚¨æˆ‘ä»¬åœ¨ä½¿ç”¨etcdè¿›è¡Œæ“ä½œï¼ˆputæˆ–delç­‰ï¼‰çš„æ—¶å€™ï¼Œéœ€è¦ä¼ å…¥contextå‚æ•°12345678timeoutCtx, cancel := context.WithTimeout(context.Background(), 2 * time.Second)defer cancel()putResponse, err := client.Put(timeoutCtx, "aaa", "xxx")if err != nil &#123; fmt.Println(err) return&#125;fmt.Println(putResponse.Header.String()) è¿™é‡Œä¼ å…¥çš„contextæ˜¯ä¸€ä¸ªè¶…æ—¶è‡ªåŠ¨å–æ¶ˆçš„contextï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“putæ“ä½œè¶…è¿‡ä¸¤ç§’åŽè¿˜æ²¡æœ‰æ‰§è¡ŒæˆåŠŸçš„è¯ï¼Œcontextå°±ä¼šè‡ªåŠ¨doneï¼ŒåŒæ—¶è¿™ä¸ªæ“ä½œä¹Ÿå°†è¢«å–æ¶ˆã€‚ å› ä¸ºæˆ‘ä»¬åœ¨ä½¿ç”¨etcdçš„æ—¶å€™ï¼Œå¦‚æžœå½“å‰ç½‘ç»œå‡ºçŽ°å¼‚å¸¸ï¼Œæ— æ³•è¿žæŽ¥åˆ°èŠ‚ç‚¹ï¼Œæˆ–è€…æ˜¯èŠ‚ç‚¹æ•°é‡ä¸è¶³çš„æ—¶å€™ï¼Œéƒ½ä¼šå‡ºçŽ°æ“ä½œè¢«hangä½ï¼Œå¦‚æžœæ²¡æœ‰å®šæ—¶å–æ¶ˆçš„æœºåˆ¶ï¼Œæˆ–è€…æ‰‹åŠ¨å–æ¶ˆï¼Œé‚£ä¹ˆå½“å‰goroutineä¼šè¢«ä¸€ç›´å ç”¨ã€‚æ‰€ä»¥å°±åˆ©ç”¨contextæ¥å®Œæˆè¿™ä¸ªæ“ä½œã€‚ æ€»ç»“ contextåœ¨webå¼€å‘ä¸­ï¼Œä½ å¯ä»¥ç±»æ¯”javaä¸­çš„ThreadLocalï¼Œåˆ©ç”¨å®ƒæ¥å®Œæˆä¸€ä¸ªrequest-scopeä¸­å‚æ•°çš„ä¼ é€’ contextå¯ä»¥ç”¨äºŽå¤šä¸ªgoroutineä¹‹é—´çš„å‚æ•°ä¼ é€’ contextè¿˜å¯ä»¥ä½œä¸ºå®Œæˆä¿¡å·çš„é€šçŸ¥ contextå¹¶å‘å®‰å…¨ å…¶å®žï¼Œæˆ‘ä»¬ä¸ä»…è¦å­¦åˆ°contextçš„ä½¿ç”¨ï¼Œè¿˜å¯ä»¥å­¦åˆ°è¿™æ ·è®¾è®¡ä¸€ä¸ªç³»ç»Ÿçš„ä¼˜ç‚¹ï¼Œå¦‚æžœä»¥åŽè‡ªå·±åœ¨è®¾è®¡ä¸€äº›æ¡†æž¶å’Œç³»ç»Ÿçš„æ—¶å€™å¯ä»¥æœ‰æ›´å¤šçš„æƒ³æ³•ã€‚]]></content>
      <categories>
        <category>golangæºç è§£æž</category>
      </categories>
      <tags>
        <tag>context</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Golangä¹‹reflect]]></title>
    <url>%2F2019%2F06%2F25%2Fgolang%2Fsource-code%2Freflect-code-view%2F</url>
    <content type="text"><![CDATA[åå°„ â€”â€” å¦‚æžœä½ ä¹‹å‰å­¦è¿‡ä¸€äº›åˆ«çš„è¯­è¨€ï¼Œæ¯”å¦‚javaå¯èƒ½å°±ä¼šäº†è§£ï¼Œåå°„æ˜¯ä¸€ä¸ªä¼ è¯´ä¸­å¾ˆåŽ‰å®³çš„æ“ä½œï¼Œç®—æ˜¯ä¸€ä¸ªé«˜çº§ç”¨æ³•ã€‚è€ŒåŒæ—¶ï¼Œå¾ˆå¤šäººä¹Ÿä¼šå‘Šè¯‰ä½ ï¼Œåå°„æ˜¯ä¸€ä¸ªå±é™©çš„æ“ä½œï¼Œé‚£ä¹ˆåœ¨golangä¸­ï¼Œåå°„åˆæ˜¯æ€Žä¹ˆæ“ä½œçš„å‘¢ï¼Ÿä»Šå¤©å°±æ¥è¯´è¯´golangä¸­çš„åå°„reflectã€‚ åå°„çš„å®šä¹‰é¦–å…ˆé—®é—®è‡ªå·±ï¼Œä½ çŸ¥é“ä»€ä¹ˆæ˜¯åå°„å—ï¼Ÿå¦‚æžœä½ æœ‰ä¸€ä¸ªæ¸…æ¥šçš„å®šä¹‰ï¼Œè¯æ˜Žä½ å·²ç»å¯¹åå°„éžå¸¸ç†Ÿæ‚‰äº†ã€‚å®˜æ–¹çš„å®šä¹‰å¾ˆå®˜æ–¹ï¼Œæˆ‘å°±è¯´è¯´æˆ‘çš„ï¼šåå°„ï¼Œåå°„ï¼Œä»Žå­—é¢ç†è§£å°±æ˜¯é€šè¿‡é•œå­ï¼ˆæˆ–ç±»ä¼¼çš„ä¸œè¥¿ï¼‰çœ‹åˆ°è‡ªå·±ã€‚è€Œåœ¨ç¼–ç¨‹ä¸­ï¼Œåå°„æŒ‡çš„æ˜¯åœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­çœ‹åˆ°è‡ªå·±ã€‚åœ¨å®žé™…çš„ç¼–ç¨‹è¿‡ç¨‹ä¸­æˆ‘ä»¬çŸ¥é“ï¼Œåˆ›å»ºçš„è¿™ä¸ªå˜é‡æˆ–è€…å¯¹è±¡æ˜¯ä»€ä¹ˆç±»åž‹æˆ–è€…æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼ŒåŒæ—¶å¾ˆå®¹æ˜“èƒ½å¯¹å®ƒè¿›è¡Œæ“ä½œã€‚è€Œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œç¨‹åºæ²¡æœ‰æˆ‘ä»¬çš„çœ¼ç›ï¼Œå®ƒå¹¶ä¸çŸ¥é“è¿™ä¸ªä¸œè¥¿æ˜¯æ€Žä¹ˆæ ·çš„ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦è¿ç”¨åˆ°åå°„ã€‚é€šè¿‡åå°„æˆ‘å¯ä»¥çŸ¥é“è‡ªå·±é•¿ä»€ä¹ˆæ ·å­ã€‚ åå°„çš„ä½¿ç”¨reflect.TypeOfå¦‚æžœä½ å¯¹åå°„è¿˜æ˜¯æœ‰äº›æ¨¡ç³Šï¼Œé‚£ä¹ˆçœ‹ä¸‹é¢è¿™ä¸ªæœ€ç®€å•çš„ä¾‹å­1234func main() &#123; a := 1.3 fmt.Println("açš„ç±»åž‹æ˜¯", reflect.TypeOf(a))&#125; è¾“å‡º1açš„ç±»åž‹æ˜¯ float64 æ˜¯ä¸æ˜¯çž¬é—´æ˜Žç™½äº†ï¼Œæ²¡é”™ï¼Œåå°„æ²¡æœ‰é‚£ä¹ˆå¤æ‚ã€‚ä½ æƒ³æƒ³ï¼Œä½œä¸ºç¨‹åºè‡ªå·±ï¼Œæˆ‘è¿è¡Œä¸­ï¼Œæˆ‘æ€Žä¹ˆçŸ¥é“aæ˜¯ä»€ä¹ˆç±»åž‹ï¼Œåªèƒ½é€šè¿‡ç…§é•œå­ï¼ˆåå°„ï¼‰å¾—åˆ°ã€‚ ä¸‹é¢å†è¯´è¯´ä¸€äº›æ›´é«˜çº§çš„ç”¨æ³•ã€‚ reflect.ValueOf1234567func main() &#123; type MyInt int var x MyInt = 7 v := reflect.ValueOf(x) fmt.Println(v.Type()) fmt.Println(v.Kind())&#125; è¾“å‡º12main.MyIntint è¿™é‡Œæˆ‘ä»¬é€šè¿‡reflect.ValueOfæ–¹æ³•æ‹¿åˆ°çš„vï¼Œå…¶ä¸­v.Type()æ‹¿åˆ°çš„æ˜¯å®ƒå½“å‰çš„ç±»åž‹ï¼Œè€Œv.Kind()å¯ä»¥æ‹¿åˆ°å®ƒæœ€åŸºæœ¬çš„ç±»åž‹ã€‚ Elem()1234567func main() &#123; a := 1.3 v := reflect.ValueOf(&amp;a) elem := v.Elem() elem.SetFloat(0.2) fmt.Println(a)&#125; è¾“å‡º10.2 è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡åå°„æ‹¿åˆ°vä½¿ç”¨v.Elem()æ–¹æ³•å¯ä»¥æ‹¿åˆ°å¯¹åº”æŒ‡é’ˆè¿›è¡Œæ“ä½œèµ‹å€¼ Field()1234567891011121314151617type MyData struct &#123; A int b float32&#125; func main() &#123; myData := MyData&#123; A: 1, b: 1.1, &#125; myDataV := reflect.ValueOf(&amp;myData).Elem() fmt.Println("å­—æ®µa:", myDataV.Field(0)) fmt.Println("å­—æ®µb:", myDataV.Field(1)) fmt.Println(myDataV) myDataV.Field(0).SetInt(2) fmt.Println(myDataV)&#125; è¾“å‡º1234å­—æ®µa: 1å­—æ®µb: 1.1&#123;1 1.1&#125;&#123;2 1.1&#125; è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å³ä½¿ä¸çŸ¥é“ä¸€ä¸ªç»“æž„ä½“é‡Œé¢çš„æƒ…å†µï¼Œæˆ‘ä»¬ä¾æ—§å¯ä»¥é€šè¿‡Fieldæ–¹æ³•èŽ·å¾—å…¶ä¸­çš„å€¼ï¼Œå¹¶ä¸”å¦‚æžœè¿™ä¸ªå˜é‡å¯ä»¥è¢«å¤–ç•Œè®¿é—®é‚£ä¹ˆè¿˜å¯ä»¥ä¿®æ”¹ã€‚ Interface()123456func main() &#123; a := 1.3 v := reflect.ValueOf(a) a1 := v.Interface().(float64) fmt.Println(a1)&#125; 1.31açš„ç±»åž‹æ˜¯ float64 åå°„ä¹‹åŽçš„å¯¹è±¡é€šè¿‡Interfaceè¿˜å¯ä»¥è½¬æ¢å›žæ¥ åå°„çš„æ³•åˆ™ä¸Šé¢å°±æ˜¯ä¸€äº›åå°„çš„åŸºæœ¬ç”¨æ³•ï¼Œå¸¸ç”¨çš„å°±æ˜¯èŽ·å–ä¸€ä¸ªå¯¹è±¡åœ¨è¿è¡Œä¸­çš„ä¸€ä¸ªçŠ¶æ€ï¼Œæˆ–è€…æ˜¯é’ˆå¯¹è¿è¡Œä¸­çš„ä¸€ä¸ªä¸ç¡®å®šçš„å¯¹è±¡è¿›è¡Œä¿®æ”¹ã€‚ä¸‹é¢è¦è¯´çš„æ˜¯åå°„çš„æ³•åˆ™ã€‚å¦‚æžœä½ è‹±æ–‡å¤Ÿå¥½ï¼Œå¹¶ä¸”ç½‘ç»œè‡ªç”±ï¼Œå¯ä»¥çœ‹çœ‹golangå®˜æ–¹çš„åšå®¢ï¼šhttps://blog.golang.org/laws-of-reflectioné‡Œé¢è¯¦ç»†æè¿°äº†åå°„çš„ä¸‰ä¸ªæ³•åˆ™ï¼Œå¦‚æžœä½ çœ‹ä¸åˆ°ï¼Œé‚£å°±åªèƒ½å¬æˆ‘ä¸‹é¢å¹ä¸€å¹äº†ã€‚ Reflection goes from interface value to reflection object. Reflection goes from reflection object to interface value. To modify a reflection object, the value must be settable. è¿™ä¸‰ä¸ªå°±æ˜¯å®˜æ–¹ç»™å‡ºçš„æ³•åˆ™ï¼Œæˆ‘åˆ†åˆ«ç”¨è‡ªå·±çš„è¯è§£é‡Šä¸€ä¸‹ã€‚ åå°„å°±æ˜¯å°†ä»»æ„å€¼è½¬æ¢ä¸ºåå°„å¯¹è±¡åœ¨golangä¸­æˆ‘ä»¬çŸ¥é“interfaceå°±å’Œjavaä¸­çš„Objectç±»ä¼¼ï¼ˆåªæ˜¯ç±»ä¼¼è€Œå·²ï¼‰ï¼Œä»£è¡¨äº†æ‰€æœ‰ç±»åž‹ï¼ŒreflectåŒ…æ­£æ˜¯å¸®æˆ‘ä»¬å°†ä»»æ„çš„ä¸€ä¸ªç±»åž‹è½¬æ¢æˆäº†æˆ‘ä»¬ä¸Šé¢ä¾‹å­ä¸­çœ‹åˆ°çš„ä¸€ä¸ªvï¼Œè¿™ä¸ªvå°±æ˜¯åå°„å¯¹è±¡ã€‚é€šè¿‡è¿™ä¸ªåå°„å¯¹è±¡ä¸­çš„ä¸€äº›æ–¹æ³•æˆ‘ä»¬æ‰èƒ½çœ‹è§åŽŸæ¥çš„å¯¹è±¡æ˜¯ä»€ä¹ˆæ ·å­ã€‚ åå°„å¯¹è±¡å¯ä»¥è½¬æ¢ä¸ºä»»æ„å¯¹è±¡è¿™ä¸ªæ­£å¥½ä¸Žç¬¬ä¸€ä¸ªç›¸åï¼Œå°±åƒæœ€åŽä¸€ä¸ªä¾‹å­ä¸­ç»™å‡ºçš„ï¼Œåå°„èŽ·å¾—çš„åå°„å¯¹è±¡å¯ä»¥é€šè¿‡Interfaceæ–¹æ³•è½¬æ¢ä¸ºåŽŸæ¥çš„å¯¹è±¡ã€‚ å¦‚æžœä½ è¦ä¿®æ”¹åå°„å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å¿…é¡»è¦å¯ä»¥è¢«ä¿®æ”¹ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå°±å¦‚åŒè¿™ä¸ªæ¡ˆä¾‹ä¸­1234567func main() &#123; a := 1.3 v := reflect.ValueOf(&amp;a) elem := v.Elem() elem.SetFloat(0.2) fmt.Println(a)&#125; å¦‚æžœæˆ‘ä»¬ä¼ é€’çš„å¹¶éžaçš„åœ°å€å¹¶ä¸”ç›´æŽ¥ä½¿ç”¨v.SetFloaté‚£ä¹ˆå°±ä¼šæŠ¥é”™ï¼Œå› ä¸ºæˆ‘ä»¬æ— æ³•å¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼Œåå°„ä¼šå¸®æˆ‘ä»¬copyä¸€ä¸ªï¼Œæ‰€ä»¥æ— æ³•ä¿®æ”¹ï¼Œåªæœ‰å½“æˆ‘ä»¬ä½¿ç”¨æŒ‡é’ˆçš„æ—¶å€™æ‰èƒ½ä¿®æ”¹ã€‚ åŒæ ·çš„ï¼Œå’Œæ¡ˆä¾‹ä¸­çš„ç»“æž„ä½“æ“ä½œä¸€æ ·ï¼Œå¦‚æžœä¸€ä¸ªç»“æž„ä½“çš„å˜é‡æ˜¯å°å†™çš„è€Œä¸æ˜¯å¤§å†™çš„ï¼Œè¯æ˜Žå¤–ç•Œæ²¡æœ‰åŠžæ³•è®¿é—®åˆ°ï¼Œæ‰€ä»¥ä¹Ÿæ²¡æœ‰åŠžæ³•ä¿®æ”¹ï¼Œä¹Ÿä¼šå‡ºçŽ°å¼‚å¸¸ã€‚ åå°„çš„åŽŸç†ä¸‹é¢å°±éœ€è¦çœ‹çœ‹åœ¨æºç ä¸­ï¼Œåå°„åˆ°åº•æ˜¯æ€Žä¹ˆå®žçŽ°çš„äº†ã€‚æˆ‘ä»¬ç€é‡çœ‹ä¸¤ä¸ªæ–¹æ³•TypeOfå’ŒValueOf TypeOf123456// TypeOf returns the reflection Type that represents the dynamic type of i.// If i is a nil interface value, TypeOf returns nil.func TypeOf(i interface&#123;&#125;) Type &#123; eface := *(*emptyInterface)(unsafe.Pointer(&amp;i)) return toType(eface.typ)&#125; æˆ‘ä»¬å…ˆæ¥çœ‹è¿™ä¸ªç®€å•çš„TypeOfçœ‹åˆ°æºç ä¸­å¾ˆç®€å•ï¼Œé€šè¿‡unsafe.PointerèŽ·å¾—æŒ‡é’ˆè½¬æ¢æˆemptyInterfaceç±»åž‹12345// emptyInterface is the header for an interface&#123;&#125; value.type emptyInterface struct &#123; typ *rtype word unsafe.Pointer&#125; ç„¶åŽé€šè¿‡toTypeæ–¹æ³•å¾—åˆ°å…·ä½“ç±»åž‹123456func toType(t *rtype) Type &#123; if t == nil &#123; return nil &#125; return t&#125; å…¶ä¸­Typeå°±åŒ…å«äº†æ‰€æœ‰çš„ä¿¡æ¯ï¼Œç„¶åŽè¿”å›žå‡ºåŽ»å°±å®Œæˆäº†ã€‚ ValueOf123456789101112131415// ValueOf returns a new Value initialized to the concrete value// stored in the interface i. ValueOf(nil) returns the zero Value.func ValueOf(i interface&#123;&#125;) Value &#123; if i == nil &#123; return Value&#123;&#125; &#125; // TODO: Maybe allow contents of a Value to live on the stack. // For now we make the contents always escape to the heap. It // makes life easier in a few places (see chanrecv/mapassign // comment below). escapes(i) return unpackEface(i)&#125; ä¸Šé¢nilå°±ä¸è¯´äº†ï¼Œä¸»è¦æ–¹æ³•æ˜¯ä¸‹é¢unpackEface1234567891011121314// unpackEface converts the empty interface i to a Value.func unpackEface(i interface&#123;&#125;) Value &#123; e := (*emptyInterface)(unsafe.Pointer(&amp;i)) // NOTE: don't read e.word until we know whether it is really a pointer or not. t := e.typ if t == nil &#123; return Value&#123;&#125; &#125; f := flag(t.Kind()) if ifaceIndir(t) &#123; f |= flagIndir &#125; return Value&#123;t, e.word, f&#125;&#125; æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¶å®žä¸ŽTypeOfä¸€æ ·ï¼Œåªä¸è¿‡å¤šå°è£…äº†ä¸€å±‚Valueï¼Œå…¶ä¸­çš„wordå°±æ˜¯å½“å‰å¯¹è±¡çš„æŒ‡é’ˆï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“é€šè¿‡TypeOfå¾—åˆ°çš„Valueå¯ä»¥ç”¨å¾ˆå¤šæ“ä½œã€‚12345// emptyInterface is the header for an interface&#123;&#125; value.type emptyInterface struct &#123; typ *rtype word unsafe.Pointer&#125; åå°„çš„æ„ä¹‰è¯´äº†è¿™ä¹ˆå¤šï¼Œé‚£ä¹ˆåå°„å­˜åœ¨çš„æ„ä¹‰åˆ°åº•åœ¨å“ªï¼Ÿè¯´ç™½äº†ï¼Œæˆ‘ä»¬åœ¨å†™ä»£ç çš„æ—¶å€™ä»€ä¹ˆæ—¶å€™èƒ½ç”¨ä¸Šå®ƒï¼Ÿè¿˜æ˜¯ä¸¾ä¸ªä¾‹å­ä½ å°±æ˜Žç™½äº†ã€‚ json.Marshalæ¡ˆä¾‹json.Marshalè¿™ä¸ªæ–¹æ³•ç”¨è¿‡å§ï¼Œæ˜¯å°†ä»»æ„å¯¹è±¡è½¬æ¢æˆjsonï¼Œè¿™ä¸ªæ¡ˆä¾‹å°±è¶³ä»¥è¯´æ˜Žåå°„çš„åŽ‰å®³äº†ã€‚æˆ‘ä»¬å…ˆè‡ªå·±æƒ³ä¸€ä¸‹ï¼Œå¦‚æžœè¦å°†ä¸€ä¸ªå¯¹è±¡è½¬æ¢æˆjsonï¼š æˆ‘ä»¬è¿è¡Œä¹‹å‰å…¶å®žæ˜¯ä¸çŸ¥é“ä¼ å…¥å¯¹è±¡çš„ç±»åž‹ï¼Œè€Œä¸”ä¼ å…¥çš„å¯¹è±¡ä¸åŒï¼Œé‚£ä¹ˆè§£æžæ–¹å¼è‚¯å®šä¸åŒï¼Œå¦‚æžœä¼ å…¥çš„æ˜¯mapæˆ–è€…ä¼ å…¥çš„æ˜¯structè‚¯å®šè§£æžæ–¹å¼ä¸åŒï¼Œæ‰€ä»¥æ–¹æ³•å†…éƒ¨éœ€è¦åŠ¨æ€çš„åˆ¤æ–­ä¼ å…¥ç±»åž‹ä»Žè€Œåšæ“ä½œã€‚ è¿˜æœ‰æˆ‘ä»¬ä¸çŸ¥é“ä¼ å…¥çš„structå†…éƒ¨çš„å±žæ€§é•¿ä»€ä¹ˆæ ·å­ã€‚ è¿™ä¸ªæ—¶å€™åå°„å°±èƒ½è§£å†³è¿™æ ·çš„é—®é¢˜ï¼Œé€šè¿‡åå°„å¯ä»¥çŸ¥é“ä¼ å…¥å¯¹è±¡çš„ç±»åž‹ï¼Œæ ¹æ®ä¸åŒçš„ç±»åž‹åšæ“ä½œï¼ŒåŒæ—¶å¯ä»¥èŽ·å–åˆ°å¦‚structè¿™æ ·ç±»åž‹å†…éƒ¨çš„å­—æ®µå±žæ€§å’Œå€¼åˆ†åˆ«æ˜¯å¤šå°‘ã€‚ json.Marshalæºç åˆ†æžå› ä¸ºæ‰€æœ‰æºç å¤ªå¤šï¼Œæˆ‘ç»™å‡ºæŸ¥çœ‹è·¯çº¿ï¼Œç„¶åŽç»™å‡ºä¸Šé¢æ‰€è¿°çš„ä¸¤å¤„é‡ç‚¹ã€‚json.Marshal -&gt; e.marshal -&gt; e.reflectValue -&gt; valueEncoder -&gt; typeEncoder -&gt; newTypeEncoder -&gt; newStructEncoder -&gt; se.encode è¦ç‚¹1 - newTypeEncoder12345678910111213141516171819202122232425262728293031323334// newTypeEncoder constructs an encoderFunc for a type.// The returned encoder only checks CanAddr when allowAddr is true.func newTypeEncoder(t reflect.Type, allowAddr bool) encoderFunc &#123; ........... switch t.Kind() &#123; case reflect.Bool: return boolEncoder case reflect.Int, reflect.Int8, reflect.Int16, reflect.Int32, reflect.Int64: return intEncoder case reflect.Uint, reflect.Uint8, reflect.Uint16, reflect.Uint32, reflect.Uint64, reflect.Uintptr: return uintEncoder case reflect.Float32: return float32Encoder case reflect.Float64: return float64Encoder case reflect.String: return stringEncoder case reflect.Interface: return interfaceEncoder case reflect.Struct: return newStructEncoder(t) case reflect.Map: return newMapEncoder(t) case reflect.Slice: return newSliceEncoder(t) case reflect.Array: return newArrayEncoder(t) case reflect.Ptr: return newPtrEncoder(t) default: return unsupportedTypeEncoder &#125;&#125; é€šè¿‡åå°„èŽ·å¾—ä¼ å…¥å¯¹è±¡çš„ç±»åž‹ï¼Œåˆ¤æ–­é€‰æ‹©å…·ä½“çš„ç¼–ç å™¨è¿›è¡Œç¼–ç ï¼Œå¦‚æžœä¼ å…¥çš„æ˜¯mapé‚£å°±â€¦å¦‚æžœä¼ å…¥çš„æ˜¯structé‚£å°±â€¦ è¦ç‚¹2 - se.encode1234567891011121314151617181920func (se *structEncoder) encode(e *encodeState, v reflect.Value, opts encOpts) &#123; e.WriteByte('&#123;') first := true for i, f := range se.fields &#123; fv := fieldByIndex(v, f.index) if !fv.IsValid() || f.omitEmpty &amp;&amp; isEmptyValue(fv) &#123; continue &#125; if first &#123; first = false &#125; else &#123; e.WriteByte(',') &#125; e.string(f.name, opts.escapeHTML) e.WriteByte(':') opts.quoted = f.quoted se.fieldEncs[i](e, fv, opts) &#125; e.WriteByte('&#125;')&#125; 123456789101112func fieldByIndex(v reflect.Value, index []int) reflect.Value &#123; for _, i := range index &#123; if v.Kind() == reflect.Ptr &#123; if v.IsNil() &#123; return reflect.Value&#123;&#125; &#125; v = v.Elem() &#125; v = v.Field(i) &#125; return v&#125; encodeè¿™ä¸ªæ–¹æ³•æ˜¯è§£æžç»“æž„ä½“çš„ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ¥šçš„çœ‹çš„ä»Žç»“æž„ä½“ä¸­é€šè¿‡v.Fieldå°†é‡Œé¢çš„å‚æ•°æ‹¿å‡ºæ¥ã€‚å…¶ä»–ç»†èŠ‚è¿™é‡Œå°±ä¸åšè¯´æ˜Žäº†ï¼Œä¸»è¦çš„ç›®çš„æ˜¯è¦è¡¨ç¤ºåå°„åœ¨å…¶ä¸­èµ·åˆ°çš„é‡è¦ä½œç”¨ã€‚ æ€»ç»“å’Œæé†’çœ‹å®Œä½ å°±åº”è¯¥æ¸…æ¥šåå°„åˆ°åº•æ˜¯åšä»€ä¹ˆç”¨çš„ï¼Œå…·ä½“æˆ‘ä»¬ä»€ä¹ˆæ—¶å€™ä¼šç”¨åˆ°å®ƒã€‚æœ€åŽè¿˜è¦æé†’ä¸€ä¸‹ï¼Œåå°„ä¹Ÿå­˜åœ¨ä¸¤ä¸ªå¿…ç„¶çš„é—®é¢˜ï¼š ç¬¬ä¸€ä¸ªæ˜¯ä¸å®‰å…¨ï¼Œå› ä¸ºåå°„çš„ç±»åž‹åœ¨è½¬æ¢ä¸­æžæ˜“å‡ºçŽ°é—®é¢˜ï¼Œæ‰€ä»¥ä½¿ç”¨éœ€è°¨æ…Žã€‚ ç¬¬äºŒä¸ªæ˜¯é€Ÿåº¦æ…¢ï¼Œä¹‹æ‰€ä»¥æœ‰äººæŠ¨å‡»golangçš„jsonè§£æžåº“æ…¢ï¼Œä¸€éƒ¨åˆ†åŽŸå› å°±æ˜¯å› ä¸ºå…¶ä¸­æ¶‰åŠåˆ°äº†åå°„ï¼Œæ‰€ä»¥å¦‚æžœå¯¹æ•ˆçŽ‡æœ‰è¦æ±‚çš„åœ°æ–¹å°±è¦æ–Ÿé…Œä½¿ç”¨äº†ã€‚]]></content>
      <categories>
        <category>golangæºç è§£æž</category>
      </categories>
      <tags>
        <tag>reflect</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Golangçš„strings.goæºç è§£æž - Rabin-Karpäº†è§£ä¸€ä¸‹ï¼Ÿ]]></title>
    <url>%2F2019%2F06%2F20%2Fgolang%2Fsource-code%2Fstrings-go-source-code%2F</url>
    <content type="text"><![CDATA[stringsåŒ…æ˜¯æˆ‘ä»¬ç»å¸¸åœ¨å¤„ç†å­—ç¬¦ä¸²çš„æ—¶å€™è¦ç”¨çš„ï¼Œè¿™æ¬¡æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒå…¶ä¸­çš„ä¸€äº›æ–¹æ³•å…·ä½“æ˜¯å¦‚ä½•å®žçŽ°çš„ã€‚æˆ‘å°±æ‰¾åˆ°å…¶ä¸­å¸¸ç”¨çš„å‡ ä¸ªæ–¹æ³•ï¼Œç„¶åŽé’ˆå¯¹å…¶ä¸­æ¯”è¾ƒéš¾çš„éƒ¨åˆ†è¿˜æœ‰åº”ç”¨åˆ°ä¸€äº›ç‰¹åˆ«ç®—æ³•çš„éƒ¨åˆ†è¿›è¡Œåˆ†æžã€‚ ToUpperå…ˆæ¥çœ‹ä¸ªç®€å•çš„ToUpperï¼Œå°†æ‰€æœ‰å­—ç¬¦è½¬æ¢æˆå¤§å†™ã€‚è¿™ä¸ªå¦‚æžœè®©æˆ‘ä»¬è‡ªå·±å®žçŽ°ä¹Ÿæ²¡æœ‰ä»€ä¹ˆéš¾åº¦ï¼Œå°±æ˜¯éåŽ†æ¯ä¸ªå­—ç¬¦è½¬æ¢æˆå¤§å†™å°±å¯ä»¥ã€‚ 12345678910111213141516171819202122232425262728// ToUpper returns a copy of the string s with all Unicode letters mapped to their upper case.func ToUpper(s string) string &#123; isASCII, hasLower := true, false for i := 0; i &lt; len(s); i++ &#123; c := s[i] if c &gt;= utf8.RuneSelf &#123; isASCII = false break &#125; hasLower = hasLower || (c &gt;= 'a' &amp;&amp; c &lt;= 'z') &#125; if isASCII &#123; // optimize for ASCII-only strings. if !hasLower &#123; return s &#125; b := make([]byte, len(s)) for i := 0; i &lt; len(s); i++ &#123; c := s[i] if c &gt;= 'a' &amp;&amp; c &lt;= 'z' &#123; c -= 'a' - 'A' &#125; b[i] = c &#125; return string(b) &#125; return Map(unicode.ToUpper, s)&#125; å¯ä»¥çœ‹åˆ°ï¼Œæºç ä¸­è€ƒè™‘çš„æ¯”è¾ƒå‘¨å…¨ï¼Œåˆ¤æ–­äº†ä¸€ä¸‹å­—ç¬¦é›†çš„é—®é¢˜ã€‚ å°æŠ€å·§c -= â€˜aâ€™ - â€˜Aâ€™æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªè½¬æ¢å¤§å†™çš„æŠ€å·§ï¼Œå­¦ä¹ ä¸€ä¸‹ã€‚å¦‚æžœè½¬æ¢æˆå°å†™ï¼Œåªè¦æ”¹æˆ+å°±å¯ä»¥äº†ã€‚ Replaceç„¶åŽçœ‹ä¸€ä¸ªç¨å¾®å¤æ‚ä¸€äº›çš„ï¼ŒReplaceï¼Œè¿™ä¸ªå‡½æ•°çš„ç›®æ ‡æ˜¯æ›¿æ¢sä¸­oldçš„å­—ç¬¦ï¼Œæ›¿æ¢å‰nä¸ªï¼Œå¦‚æžœnä¸ºè´Ÿæ•°åˆ™å…¨éƒ¨æ›¿æ¢ã€‚ä½œä¸ºå®žçŽ°ä¹Ÿå…¶å®žä¸éš¾ï¼Œå°±æ˜¯æ‰¾åˆ°å¯¹åº”å­—ç¬¦æ›¿æ¢å°±å¯ä»¥ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839// Replace returns a copy of the string s with the first n// non-overlapping instances of old replaced by new.// If old is empty, it matches at the beginning of the string// and after each UTF-8 sequence, yielding up to k+1 replacements// for a k-rune string.// If n &lt; 0, there is no limit on the number of replacements.func Replace(s, old, new string, n int) string &#123; if old == new || n == 0 &#123; return s // avoid allocation &#125; // Compute number of replacements. if m := Count(s, old); m == 0 &#123; return s // avoid allocation &#125; else if n &lt; 0 || m &lt; n &#123; n = m &#125; // Apply replacements to buffer. t := make([]byte, len(s)+n*(len(new)-len(old))) w := 0 start := 0 for i := 0; i &lt; n; i++ &#123; j := start if len(old) == 0 &#123; if i &gt; 0 &#123; _, wid := utf8.DecodeRuneInString(s[start:]) j += wid &#125; &#125; else &#123; j += Index(s[start:], old) &#125; w += copy(t[w:], s[start:j]) w += copy(t[w:], new) start = j + len(old) &#125; w += copy(t[w:], s[start:]) return string(t[0:w])&#125; å…¶å®žæ ¸å¿ƒå°±æ˜¯ä¸‹é¢ä¸‰å¥w += copy(t[w:], s[start:j])w += copy(t[w:], new)start = j + len(old)åˆ©ç”¨ä¸€ä¸ªstartåŽ»æ ‡è®°ä»Žæ—§å­—ç¬¦ä¸²çš„é‚£ä¸ªä½ç½®å¼€å§‹å¤åˆ¶ï¼Œåˆ°ç›®æ ‡å­—ç¬¦å¤„ï¼Œç„¶åŽå¤åˆ¶éœ€è¦æ›¿æ¢çš„å­—ç¬¦è¿›åŽ»å°±å¯ä»¥äº†ï¼Œæœ€åŽç§»åŠ¨startä¸ºäº†ä¸‹ä¸€æ¬¡å‡†å¤‡å°±å¯ä»¥äº†ã€‚ å°æŠ€å·§t := make([]byte, len(s)+n*(len(new)-len(old)))è¿™ä¸ªåœ¨æºç ä¸­å¾ˆæ˜¯å¸¸è§ï¼Œå‘Šè¯‰æˆ‘ä»¬ä¸€ä¸ªé“ç†ï¼Œåœ¨åˆ›å»ºsliceçš„æ—¶å€™ï¼Œå°½å¯èƒ½çš„åŽ»æŒ‡å®šå¥½ä½ éœ€è¦çš„é•¿åº¦æ¥é¿å…æ‰©å®¹ã€‚ Indexå¥½äº†ï¼Œçƒ­èº«å·®ä¸å¤šäº†ï¼Œæ¥çœ‹æˆ‘ä»¬è¿™æ¬¡çš„é‡å¤´æˆï¼Œindexã€‚æˆ‘ä»¬ç»å¸¸éœ€è¦ç¡®å®šä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯å¦å­˜åœ¨äºŽå¦ä¸€ä¸ªå­—ç¬¦ä¸²å†…ï¼Œå¹¶ä¸”è¦çŸ¥é“å®ƒçš„ä½ç½®ï¼Œæ‰€ä»¥éœ€è¦indexæ–¹æ³•ã€‚å…¶å®žè¯´åˆ°åº•å°±æ˜¯å­—ç¬¦ä¸²åŒ¹é…å˜›ã€‚ è‡ªå·±æ€è€ƒä¸€èˆ¬çœ‹æºç æˆ‘éƒ½ä¹ æƒ¯å…ˆè‡ªå·±æƒ³æƒ³æ€Žä¹ˆåŽ»å®žçŽ°ï¼Œè¿™ä¸ªæ–¹æ³•å¯¹äºŽæˆ‘æ¥è¯´å¾ˆç†Ÿæ‚‰ï¼Œåœ¨javaä¸­å…¶å®žå¾ˆæš´åŠ›ï¼Œå°±æ˜¯ä¸¤å±‚foræžå®šï¼Œå…ˆæ‰¾åˆ°ç¬¬ä¸€ä¸ªä¸€æ ·çš„å­—ç¬¦ï¼Œç„¶åŽåŒ¹é…å‰©ä¸‹çš„ã€‚ç„¶åŽæˆ‘ä¹ŸçŸ¥é“ï¼Œå­—ç¬¦ä¸²åŒ¹é…åœ¨ç®—æ³•ä¸­æœ‰è‘—åçš„KMPç®—æ³•ï¼Œä½†æ˜¯ç†è§£éš¾åº¦å¾ˆå¤§ã€‚ä¸çŸ¥é“golangä¼šæ€Žä¹ˆå®žçŽ°ï¼ŒäºŽæ˜¯æˆ‘çœ‹åˆ°äº†ä¸€ä¸ªæ–°çš„ç®—æ³•RabinKarpï¼ˆæˆ‘ä¹‹å‰ä¸äº†è§£ï¼‰ æºç 1234567891011121314151617181920212223func indexRabinKarp(s, substr string) int &#123; // Rabin-Karp search hashss, pow := hashStr(substr) n := len(substr) var h uint32 for i := 0; i &lt; n; i++ &#123; h = h*primeRK + uint32(s[i]) &#125; if h == hashss &amp;&amp; s[:n] == substr &#123; return 0 &#125; for i := n; i &lt; len(s); &#123; h *= primeRK h += uint32(s[i]) h -= pow * uint32(s[i-n]) i++ if h == hashss &amp;&amp; s[i-n:i] == substr &#123; return i - n &#125; &#125; return -1&#125; ä½ å…ˆè‡ªå·±å°è¯•çœ‹çœ‹æ˜¯å¦èƒ½çœ‹å‡ºä»€ä¹ˆé—¨é“ï¼Ÿ çŒœæµ‹æ˜¯ä¸æ˜¯ä¹çœ‹ä¹‹ä¸‹è¿™ä¸ªæ–¹æ³•å¾ˆå¤æ‚ï¼Œå„ç§æ“ä½œçœ¼èŠ±ç¼­ä¹±ï¼Œå¦‚æžœä½ æ˜¯ç¬¬ä¸€æ¬¡çœ‹æºç å¯èƒ½æ˜¯è¿™æ ·çš„ï¼Œçœ‹å¤šäº†ä½ åº”è¯¥æœ‰å’Œæˆ‘ä¸€æ ·çš„ç›´è§‰å’Œç»éªŒï¼ˆåæ­£æˆ‘æ˜¯æœ‰æ„Ÿè§‰ï¼‰æˆ‘çœ‹æºç çš„ç¬¬äºŒä¸ªæ­¥éª¤å°±æ˜¯å¤§è‡´çœ‹ä¸€çœ¼ï¼Œç„¶åŽåœ¨ä¸çœ‹ä»»ä½•æ–‡ç« è§£æžçš„æƒ…å†µä¸‹çŒœæµ‹å®ƒçš„å®žçŽ°ã€‚åœ¨æˆ‘çœ‹å®Œä¸Šé¢ä¹‹åŽç•™ä¸ªæˆ‘ä¸‰ä¸ªé‡ç‚¹ hashss, pow := hashStr(substr) h += uint32(s[i]) h -= pow * uint32(s[i-n]) if h == hashss &amp;&amp; s[i-n:i] == substr { å®ƒèŽ·å–äº†å¯¹åº”çš„hashå€¼ï¼Œè¿™ä¸ªç®—æ³•å’Œhashæœ‰å…³ å®ƒå¯¹å“ˆå¸Œå€¼è¿›è¡Œäº†å¢žå‡æ“ä½œ å®ƒæ¯”è¾ƒå“ˆå¸Œå€¼å’Œå­—ç¬¦ä¸²ä»Žè€Œç¡®å®šä½ç½® åˆ°è¿™é‡Œï¼Œæˆ‘å·²ç»æœ‰äº†ä¸€ä¸ªå¤§æ¦‚çš„æ€è·¯ï¼Œè¿™ä¸ªç®—æ³•åº”è¯¥æ˜¯é€šè¿‡å“ˆå¸Œå€¼å¿«é€Ÿç¡®å®šå­ä¸²æ˜¯å¦å¯èƒ½å­˜åœ¨ï¼Œåœ¨å“ˆå¸Œå€¼ç›¸åŒçš„æƒ…å†µä¸‹å†åŽ»æ¯”è¾ƒçœŸå®žçš„å­—ç¬¦æ˜¯å¦ä¸€è‡´ï¼ŒåŒæ—¶åœ¨è®¡ç®—å“ˆå¸Œå€¼çš„æ—¶å€™é‡‡ç”¨ç‰¹æ®Šçš„æœºåˆ¶æ¥å®žçŽ°äº†å¢žåŠ å°±å¯ä»¥å®Œæˆå“ˆå¸Œçš„æ”¹å˜ã€‚å…¶å®žå¦‚æžœä½ æœ‰ç›¸åŒçš„æƒ³æ³•ï¼Œæ­å–œä½ ï¼Œå·²ç»å…«ä¹ä¸ç¦»åäº†ã€‚ åˆ†æžæˆ‘ä»¬ä¸¾ä¸ªå®žé™…çš„ä¾‹å­æ¥è¯´æ˜Žä¸Šé¢çš„äº‹æƒ…åŽŸæœ¬çš„å­—ç¬¦ä¸²ä¸ºï¼šâ€ABCDEâ€ï¼Œå­ä¸²ä¸ºâ€BCDâ€é¦–å…ˆè®¡ç®—å‡ºâ€BCDâ€çš„hashä¸º100ï¼ˆä¸¾ä¸ªä¾‹å­ï¼‰ç„¶åŽå¾ªçŽ¯åŽŸæœ¬çš„å­—ç¬¦ä¸²å–å‡ºâ€ABCâ€è®¡ç®—hashä¸º200 != 100æ‰€ä»¥ä¸€å®šä¸æ˜¯å–å‡ºå­—ç¬¦DåŽŸæ¥çš„hashåŠ Då‡åŽ»Aè®¡ç®—hashä¸º100 == 100ï¼ˆè¿™é‡Œæ³¨æ„ï¼Œä¸æ˜¯é‡æ–°è®¡ç®—ï¼Œè€Œæ˜¯åœ¨åŽŸæœ‰çš„åŸºç¡€ä¸Šè¿›è¡Œçš„è®¡ç®—ï¼‰æœ€åŽè¿˜æ˜¯è¦æ¯”è¾ƒä¸€éæ˜¯å¦æ­£ç¡®ï¼Œå› ä¸ºhashä¸€è‡´ä¸ä¸€å®šåŽŸå€¼ä¸€è‡´ã€‚ å‡è®¾å¾…åŒ¹é…å­—ç¬¦ä¸²çš„é•¿åº¦ä¸ºMï¼Œç›®æ ‡å­—ç¬¦ä¸²çš„é•¿åº¦ä¸ºNï¼Œé‚£ä¹ˆä¸€å…±æ¯”è¾ƒN-M+1å°±å¯ä»¥äº† hashé‚£ä¹ˆå…¶å®žä½ åº”è¯¥æ³¨æ„åˆ°äº†ï¼Œæœ€ç¥žå¥‡çš„å°±æ˜¯è¿™ä¸ªhashå€¼ï¼Œä¸ºä»€ä¹ˆå¯ä»¥è¿™æ ·æ“ä½œï¼Œå¦‚æžœæ˜¯md5è¿™ç§å¿…é¡»é‡æ–°è®¡ç®—ï¼Œæ˜¯ä¸å¯èƒ½å®Œæˆè¿™æ ·çš„æ“ä½œçš„ã€‚ 12345678910111213141516171819// primeRK is the prime base used in Rabin-Karp algorithm.const primeRK = 16777619// hashStr returns the hash and the appropriate multiplicative// factor for use in Rabin-Karp algorithm.func hashStr(sep string) (uint32, uint32) &#123; hash := uint32(0) for i := 0; i &lt; len(sep); i++ &#123; hash = hash*primeRK + uint32(sep[i]) &#125; var pow, sq uint32 = 1, primeRK for i := len(sep); i &gt; 0; i &gt;&gt;= 1 &#123; if i&amp;1 != 0 &#123; pow *= sq &#125; sq *= sq &#125; return hash, pow&#125; è¿™ä¸ªå°±æ˜¯hashç®—æ³•ï¼Œå…¶å®žå®ƒæ¯æ¬¡å®Œæˆçš„å°±æ˜¯ *primeRK åŠ ä¸Šæ–°çš„å­—ç¬¦ï¼Œé‚£ä¹ˆpowæ˜¯ä»€ä¹ˆå‘¢ï¼ŸåŠ å‡ç©¶ç«Ÿæ˜¯å¦‚ä½•å®Œæˆçš„å‘¢ï¼Ÿæˆ‘ä¸¾ä¸ªä¾‹å­ä½ å°±æ˜Žç™½äº†ã€‚ è¿˜æ˜¯åˆšæ‰çš„ABCDEå’ŒBCDï¼Œæˆ‘ä»¬ç”¨qè¡¨ç¤ºå¸¸æ•°primeRKé‚£ä¹ˆBCDçš„hashè®¡ç®—å‡ºæ¥åº”è¯¥æ˜¯B q^2 + C q + Dè€ŒABCçš„hashåº”è¯¥æ˜¯A q^2 + B q + Cé‚£å½“Dæ¥çš„æ—¶å€™å¦‚ä½•æ“ä½œçš„å‘¢ï¼Ÿå›žçœ‹ä¸€ä¸‹indexRabinKarpå°±æ˜Žç™½äº†ã€‚[A q^2 + B q + C] q + D - A pow= A q^3 - A pow + B q^2 + C q + Dæ˜Žç™½äº†å§ï¼Œè¿™ä¸ªpowå…¶å®žå°±æ˜¯è®¡ç®—hashå€¼æ—¶çš„æœ€é«˜æŒ‡æ•°ï¼Œé€šè¿‡æ¯æ¬¡å‡åŽ»å¸¸æ•°çš„æœ€é«˜æŒ‡æ•°é¡¹å°±èƒ½å®Œæˆä¹‹å‰çš„æ“ä½œã€‚ èªæ˜Žã€‚ä¸ç”±å¾—ä½©æœèƒ½æƒ³å‡ºè¿™æ ·ç®—æ³•çš„äºº~ å…¶ä»–ä¸€äº›æ–¹æ³•çœ‹å®Œæœ€å¤æ‚çš„indexå®žçŽ°ï¼Œå†è¯´è¯´å‡ ä¸ªç”±å®ƒå¼•ç”³å‡ºæ¥çš„æ–¹æ³•ã€‚ genSplitå…¶å®žå°±æ˜¯åˆ†ç»„å­—ç¬¦ä¸²ï¼Œé€šè¿‡æŸäº›å­ä¸²åŽ»åˆ†å‰²æˆä¸€ä¸ªä¸ªéƒ¨åˆ†ï¼Œå…¶å®žå®žçŽ°å°±æ˜¯æ¯æ¬¡Indexæ‰¾åˆ°ä½ç½®ç„¶åŽè¿›è¡Œå­˜å‚¨åˆ°æ–°çš„åœ°æ–¹å°±å¯ä»¥äº†ã€‚123456789for i &lt; n &#123; m := Index(s, sep) if m &lt; 0 &#123; break &#125; a[i] = s[:m+sepSave] s = s[m+len(sep):] i++&#125; countGenericè®¡æ•°ï¼Œç»Ÿè®¡å­—ç¬¦ä¸²ä¸­å­ä¸²å‡ºçŽ°çš„æ•°ç›®ï¼Œä¹Ÿæ˜¯é€šè¿‡indexå®Œæˆï¼Œç»Ÿè®¡ä¸€ä¸‹è€Œå·²12345678for &#123; i := Index(s, substr) if i == -1 &#123; return n &#125; n++ s = s[i+len(substr):]&#125; æ€»ç»“å…¶å®žå¾ˆå¤šæºç ä¸­çš„å®žçŽ°ä¸å¤æ‚ï¼Œå¤šçœ‹çœ‹ï¼Œä¸ä»…èƒ½ç†Ÿç»ƒä½¿ç”¨apiè¿˜èƒ½å­¦åˆ°ä¸€äº›éªšæ“ä½œï¼Œä½•ä¹è€Œä¸ä¸ºå‘¢ï¼Ÿä¸å¾—ä¸ä½©æœä¸€äº›ç‰›é€¼çš„ç®—æ³•å®žçŽ°ï¼ŒçœŸçš„åŽ‰å®³~]]></content>
      <categories>
        <category>golangæºç è§£æž</category>
      </categories>
      <tags>
        <tag>strings</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Golangçš„slice]]></title>
    <url>%2F2019%2F06%2F18%2Fgolang%2Fsource-code%2Fslice-source-code-review%2F</url>
    <content type="text"><![CDATA[ä»Šå¤©æ¥è¯´ä¸ªç®€å•çš„ï¼Œä¹Ÿä¸ç®€å•çš„ä¸œè¥¿ï¼Œé‚£å°±æ˜¯åˆ‡ç‰‡ã€‚sliceå¯¹äºŽgolangæ¥è¯´é‚£çœŸçš„æ˜¯ä¸€ä¸ªéžå¸¸å¸¸ç”¨çš„ä¸œè¥¿äº†ï¼Œå¾ˆå¤šåœ°æ–¹éƒ½ä¼šç”¨åˆ°å®ƒï¼Œä»Šå¤©å°±æ¥è¯´è¯´ï¼Œsliceåº•å±‚æ˜¯å¦‚ä½•å®žçŽ°çš„ï¼Œåˆæœ‰å“ªäº›å‘æ˜¯éœ€è¦æå‰æ³¨æ„çš„ã€‚ sliceç»“æž„å¾ˆå¤šç¬¬ä¸€æ¬¡æŽ¥è§¦golangçš„åŒå­¦éƒ½ä¼šè®¤ä¸ºï¼Œæ•°ç»„å’Œåˆ‡ç‰‡æ˜¯å·®ä¸å¤šçš„ä¸œè¥¿ï¼Œå…¶å®žä¸æ˜¯çš„ï¼Œåˆ‡ç‰‡æ˜¯æ•°ç»„çš„å°è£…ã€‚12345type slice struct &#123; array unsafe.Pointer len int cap int&#125; ä¸Šé¢è¿™ä¸ªå°±æ˜¯sliceçš„ç»“æž„ï¼Œé¡ºä¾¿è¯´ä¸€ä¸‹ï¼šsliceçš„æºç ä½ç½®æ˜¯ï¼šgo/src/runtime/slice.go å…¶ä¸­arrayæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘åº•å±‚çš„æ•°ç»„ lenä»£è¡¨sliceçš„é•¿åº¦ capä»£è¡¨sliceçš„å®¹é‡ ä¸ºä»€ä¹ˆä¼šæœ‰é•¿åº¦å’Œå®¹é‡è¿™ä¸ªåŒºåˆ†å‘¢ï¼Œè¿™ä¸¤ä¸ªä¸œè¥¿æ˜¯ç”¨æ¥å¹²ä»€ä¹ˆçš„å‘¢ï¼Ÿæˆ‘ä»¬å¾€ä¸‹çœ‹ã€‚ sliceçš„é•¿åº¦å’Œå®¹é‡æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªæœ€ç®€å•çš„æ¡ˆä¾‹1234sli := make([]int, 2)fmt.Printf("len=%d cap=%d\n", len(sli), cap(sli))sli = append(sli, 1)fmt.Printf("len=%d cap=%d\n", len(sli), cap(sli)) æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º2çš„sliceç„¶åŽæ‰“å°ä¸€ä¸‹å®ƒçš„lenå’Œcapã€‚ç„¶åŽæ·»åŠ ä¸€ä¸ªå…ƒç´ ï¼Œå†æ¬¡æ‰“å°æœ€åŽç»“æžœä¸ºï¼šlen=2 cap=2len=3 cap=4 ä»Žä¸­æˆ‘ä»¬å¯ä»¥çŸ¥é“lenå’Œcapæ˜¯ä¸åŒçš„ä¸œè¥¿ï¼Œæ˜Žæ˜¾å˜›ã€‚ä½†æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ å…¶å®žåŽŸå› å¾ˆç®€å•ï¼Œå› ä¸ºæ•°ç»„åœ¨åˆ›å»ºçš„æ—¶å€™åªèƒ½åˆ›å»ºå›ºå®šå¤§å°çš„æ•°ç»„ï¼Œè€Œå½“sliceåœ¨ä¸æ–­å¾€å…¶ä¸­æ·»åŠ å…ƒç´ çš„æ—¶å€™ï¼ŒåŠ¿å¿…ä¼šé‡åˆ°å¤§å°ä¸å¤Ÿçš„æƒ…å†µï¼Œå¦‚æžœæ¯æ¬¡æ·»åŠ éƒ½ä¸å¤Ÿï¼Œé‚£ä¹ˆæ¯æ¬¡éƒ½è¦åˆ›å»ºæ–°çš„æ•°ç»„ï¼Œé‚£ä¼šç›¸å½“æµªè´¹æ—¶é—´å’Œèµ„æºï¼Œæ‰€ä»¥å½“ä¸å¤Ÿçš„æ—¶å€™ç´¢æ€§ä¸€æ¬¡å°±åˆ›å»ºå¤§ä¸€äº›ï¼Œæ‰€ä»¥capå…¶å®žå°±ä»£è¡¨äº†æ•´ä½“çš„ä¸€ä¸ªå®¹é‡ï¼Œè€Œlenä»£è¡¨å½“å‰ç”¨åˆ°äº†ç¬¬å‡ ä¸ªã€‚ sliceçš„æ‰©å®¹åˆšæ‰æåˆ°çš„æ•´ä¸ªè¿‡ç¨‹å°±æ˜¯æ‰©å®¹çš„åŽŸå› ï¼Œé‚£ä¹ˆsliceç©¶ç«Ÿæ˜¯å¦‚ä½•è¿›è¡Œæ‰©å®¹çš„å‘¢ï¼Ÿç½‘ä¸Šæˆ‘çœ‹è§è¿‡ä¸¤ä¸ªè¯´æ³•ï¼š æ¯æ¬¡2å€ å½“len&lt;1024çš„æ—¶å€™æ¯æ¬¡2å€ï¼Œå½“len&gt;1024çš„æ—¶å€™æ¯æ¬¡1.25å€ æˆ‘æœ€åŽå¾—åˆ°çš„ç»“è®ºæ˜¯å…¶å®žä¸¤ä¸ªéƒ½ä¸å®Œå…¨æ­£ç¡®ã€‚æ­£ç¡®çš„åº”è¯¥çœ‹çœ‹æºç ä¸­æ˜¯æ€Žä¹ˆè¯´çš„ã€‚123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051func growslice(et *_type, old slice, cap int) slice &#123; ..... newcap := old.cap doublecap := newcap + newcap if cap &gt; doublecap &#123; newcap = cap &#125; else &#123; if old.len &lt; 1024 &#123; newcap = doublecap &#125; else &#123; // Check 0 &lt; newcap to detect overflow // and prevent an infinite loop. for 0 &lt; newcap &amp;&amp; newcap &lt; cap &#123; newcap += newcap / 4 &#125; // Set newcap to the requested cap when // the newcap calculation overflowed. if newcap &lt;= 0 &#123; newcap = cap &#125; &#125; &#125; var overflow bool var lenmem, newlenmem, capmem uintptr const ptrSize = unsafe.Sizeof((*byte)(nil)) switch et.size &#123; case 1: lenmem = uintptr(old.len) newlenmem = uintptr(cap) capmem = roundupsize(uintptr(newcap)) overflow = uintptr(newcap) &gt; _MaxMem newcap = int(capmem) case ptrSize: lenmem = uintptr(old.len) * ptrSize newlenmem = uintptr(cap) * ptrSize capmem = roundupsize(uintptr(newcap) * ptrSize) overflow = uintptr(newcap) &gt; _MaxMem/ptrSize newcap = int(capmem / ptrSize) default: lenmem = uintptr(old.len) * et.size newlenmem = uintptr(cap) * et.size capmem = roundupsize(uintptr(newcap) * et.size) overflow = uintptr(newcap) &gt; maxSliceCap(et.size) newcap = int(capmem / et.size) &#125; ...... return slice&#123;p, old.len, newcap&#125;&#125; æˆ‘ä»¬çœç•¥å…¶ä¸­éƒ¨åˆ†ä»£ç çœ‹å…³é”®éƒ¨åˆ†ï¼Œé¦–å…ˆè¯´æ˜Žä¸€ä¸‹growsliceè¿™ä¸ªæ–¹æ³•æ˜¯æ‰©å®¹çš„æ–¹æ³•ï¼Œå…¶ä¸­çš„å…¥å‚et *_type, old slice, cap intåˆ†åˆ«æ˜¯å…ƒç´ çš„ç±»åž‹ï¼Œè€çš„sliceï¼Œæ–°sliceè¦æ±‚çš„æœ€å°å®¹é‡é’ˆå¯¹æœ€åŽè¿™ä¸ªå‚æ•°ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œå½“å‰å¦‚æžœæ˜¯len=2ï¼Œcap=2çš„ä¸€ä¸ªsliceæ·»åŠ ä¸€ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆè¿™ä¸ªå‚æ•°ä¼ å…¥çš„å°±æ˜¯3ï¼Œå› ä¸ºæœ€å°éœ€è¦å®¹é‡ä¸º3ã€‚ å…¶å®žä»Žå‰åŠéƒ¨åˆ†æ¥çœ‹ï¼Œç¬¬äºŒç§è¯´æ³•æ˜¯æ­£ç¡®çš„ï¼Œå½“len&lt;1024ç¡®å®žå°±æ˜¯ä¸¤å€ï¼Œè€Œå½“len&gt;1024çš„æ—¶å€™ï¼Œæ¯æ¬¡ä»¥åŽŸæ¥çš„25%å¢žåŠ ç›´åˆ°æ»¡è¶³è¦æ±‚ã€‚ ä½†æ˜¯å…¶å®žä½ çœ‹åŽé¢éƒ¨åˆ†ï¼Œæœ‰ä¸€ä¸ªroundupsizeçš„æ–¹æ³•ï¼Œå¹¶ä¸”åˆå¯¹newcapè¿›è¡Œèµ‹å€¼ï¼Œæ‰€ä»¥è‚¯å®šä¿®æ”¹äº†capçš„å€¼ï¼Œæ‰€ä»¥å…¶å®žæ‰©å®¹å¹¶æ²¡æœ‰æè¿°çš„é‚£ä¹ˆç®€å•ï¼Œå®žé™…ä¸­ä¼šè¿›è¡Œå†…å­˜å¯¹é½ï¼Œå…·ä½“ä»€ä¹ˆäº‹å†…å­˜å¯¹é½å‘¢ï¼Ÿç®€å•çš„æè¿°æ˜¯ï¼Œå†…å­˜ä¸­è‚¯å®šä¸æ˜¯ä½ æƒ³æ€Žä¹ˆæ”¾å°±æ€Žä¹ˆæ”¾çš„è‚¯å®šè¦æ»¡è¶³ä¸€ä¸ªè§„åˆ™ï¼Œæœ‰çš„åœ°æ–¹è™½ç„¶ä½ åªè¦è¿™ä¹ˆç‚¹åœ°æ–¹ï¼Œä½†æ˜¯ç”±äºŽç¾Žè§‚çš„è¦æ±‚ï¼Œä¼šå¤šç»™ä½ ä¸€ç‚¹ï¼Œå‡‘ä¸ªæ•´ï¼Œä¿æŒç»Ÿä¸€æ•´é½ï¼Œè¿™å°±æ˜¯å†…å­˜å¯¹é½ã€‚ï¼ˆæ˜¯ä¸æ˜¯èŠ±é‡Œèƒ¡å“¨çš„ï¼Œæˆ‘å°½å¯èƒ½å·²ç»ç™½è¯äº†ï¼Œå…·ä½“è¿˜æ˜¯è¦çœ‹ï¼‰https://blog.csdn.net/u011957758/article/details/85059117æ€»ä¹‹ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œsliceçš„æ‰©å®¹å¹¶ä¸æ˜¯é‚£ä¹ˆç®€å•çš„ã€‚æœ€åŽé™„ä¸Šä¸€ä¸ªä¾‹å­ä½œä¸ºéªŒè¯ï¼š123456789101112func main() &#123; sli := make([]int, 2) preCap := cap(sli) for i := 0; i &lt;= 2048; i++ &#123; sli = append(sli, i) if cap(sli) != preCap &#123; fmt.Printf("len=%4d \t cap=%d\n", len(sli)-1, cap(sli)) preCap = cap(sli) &#125; &#125;&#125; è¾“å‡º123456789101112len= 2 cap=4len= 4 cap=8len= 8 cap=16len= 16 cap=32len= 32 cap=64len= 64 cap=128len= 128 cap=256len= 256 cap=512len= 512 cap=1024len=1024 cap=1280len=1280 cap=1696len=1696 cap=2304 1280 = 1024 1.251696 = 1280 1.325 sliceçš„æ“ä½œæ™®é€šçš„åˆ›å»ºæ·»åŠ å…ƒç´ æˆ‘å°±ä¸å¤šè¯´äº†ï¼Œä½ è‚¯å®šçŸ¥é“ï¼Œä½ è¦æ˜¯ä¸çŸ¥é“å°±ä¸ä¼šæ¥çœ‹æˆ‘çš„åšå®¢äº†ã€‚è¯´ä¸€äº›çœ‹èµ·æ¥é«˜ç«¯çš„å¾®æ“ã€‚ åˆ›å»ºslicemake([]int, 10, 32)makeçš„æ—¶å€™å¯ä»¥æŒ‡å®šç¬¬ä¸‰ä¸ªå‚æ•°ä¹Ÿå°±æ˜¯åˆå§‹çš„cap sliceåˆ é™¤ä¸€ä¸ªå…ƒç´ sli = append(sli[:3], sli[4:]â€¦)å› ä¸ºåº•å±‚æ˜¯æ•°ç»„ï¼Œæ‰€ä»¥åˆ é™¤ä¸€ä¸ªå…ƒç´ çœ‹èµ·æ¥ä¼šæ¯”è¾ƒéº»çƒ¦ reslice123456789101112func main() &#123; sli := make([]int, 0) for i := 1; i &lt;= 10; i++ &#123; sli = append(sli, i) &#125; fmt.Println(sli) sli = sli[1:3:5] fmt.Println(sli) fmt.Println(len(sli), cap(sli))&#125; sli = sli[1:3:5]resliceçš„æ—¶å€™ä¹Ÿå¯ä»¥æŒ‡å®šcapï¼Œä½†æ˜¯æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªæ—¶å€™å¹¶ä¸æ˜¯æŒ‡å®šçš„æ•´ä½“å®¹é‡ä¸º5ï¼Œè€Œæ˜¯å®¹é‡ä¸ºåŽŸæ¥sliceä¸‹æ ‡ä¸º5çš„åœ°æ–¹ã€‚å¦‚æžœåŽŸæ¥æ˜¯[1 2 3 4 5 6 7 8 9 10]æŒ‰ç…§ä¸Šé¢çš„æ“ä½œï¼ŒæŒ‰ç…§æˆ‘è‡ªå·±çš„å¹³å¸¸è¯´çš„å°±æ˜¯åˆ‡ä¸¤åˆ€ï¼Œç¬¬ä¸€åˆ€æ˜¯åˆ‡åˆ°3ï¼Œç¬¬äºŒåˆ€æ˜¯åˆ‡åˆ°5sliceæ˜¯[2,3]ï¼Œä½†æ˜¯å®žé™…åº•å±‚è¿˜æœ‰[4,5] capåº”è¯¥æ˜¯4ï¼Œæ‰€ä»¥è¾“å‡ºåº”è¯¥æ˜¯ï¼š 123[1 2 3 4 5 6 7 8 9 10][2 3]2 4 sliceçš„å‘ç‚¹sliceçš„å‘å…¶å®žä¸»è¦åœ¨äºŽä½¿ç”¨è€…éœ€è¦æ¸…æ¥šå€¼ä¼ é€’å¼•ç”¨ä¼ é€’çš„å…³ç³»ã€‚é¦–å…ˆåœ¨golangä¸­åªæœ‰å€¼ä¼ é€’ï¼Œæ²¡æœ‰å¼•ç”¨ä¼ é€’ã€‚ resliceçš„æ—¶å€™è¦æ³¨æ„ï¼Œå¦‚æžœåªæ˜¯resliceé‚£ä¹ˆåŽç»­æ“ä½œæ˜¯ä¼šå¯¹åŽŸæ¥çš„sliceé€ æˆå½±å“çš„ã€‚ ä½†æ˜¯å¦‚æžœç»è¿‡appendä¹‹åŽï¼Œé‚£ä¹ˆç”±äºŽæ‰©å®¹çš„æ—¶å€™å›žé‡æ–°åˆ†é…å†…å­˜ï¼Œå¦‚æžœæ¶‰åŠæ‰©å®¹ä¹‹åŽï¼Œé‚£ä¹ˆå°±ä¸ä¼šå¯¹åŽŸæ¥çš„sliceé€ æˆå½±å“ã€‚ å¦‚æžœä½œä¸ºå‡½æ•°çš„å‚æ•°ä¼ é€’çš„æ˜¯æ•°ç»„ï¼Œå› ä¸ºæ˜¯å€¼ä¼ é€’ï¼Œæ‰€ä»¥å‡½æ•°å†…éƒ¨çš„ä¿®æ”¹ä¸ä¼šå¯¹å¤–éƒ¨çš„å˜é‡äº§ç”Ÿå½±å“ï¼Œä½†æ˜¯å¦‚æžœæ˜¯sliceä¼ é€’ï¼Œé‚£ä¹ˆå› ä¸ºä¼ é€’çš„æ˜¯æŒ‡é’ˆï¼Œæ‰€ä»¥ä¼šä¿®æ”¹å¤–éƒ¨çš„å˜é‡ã€‚ åŒæ—¶å› ä¸ºæ˜¯å€¼ä¼ é€’ï¼Œå½¢å‚çš„é‡æ–°èµ‹å€¼æ˜¯ä¸ä¼šå¯¹å¤–éƒ¨çš„å˜é‡é€ æˆå½±å“çš„ã€‚ ä¸‹é¢çš„ä»£ç è¯´æ˜Žäº†ä»¥ä¸Šå¯èƒ½å‡ºçŽ°çš„å‘ç‚¹1234567891011121314151617181920212223242526272829303132333435363738package mainimport "fmt"func main() &#123; a := [3]int&#123;1, 1, 1&#125; s := []int&#123;1, 1, 1&#125; modifyArray(a) fmt.Println(a) modifySlice(s) fmt.Println(s) reslice(s) fmt.Println(s) s1 := make([]int, 2, 3) s2 := append(s1, 1) s2[0] = 3 fmt.Println(s1) s3 := append(s1, 1, 1) s3[0] = 4 fmt.Println(s1)&#125;func modifyArray(a [3]int) &#123; a[0] = 2&#125;func modifySlice(s []int) &#123; s[0] = 2&#125;func reslice(s []int) &#123; s = s[:2]&#125; æ€»ç»“æ€»ç»“ä¸€ä¸‹ï¼Œåˆ›å»ºsliceçš„æ—¶å€™å¦‚æžœå¯ä»¥çš„è¯å°½å¯èƒ½åˆå§‹åŒ–å¥½è¦ç”¨å®¹é‡ï¼Œä»¥å…ç»å¸¸æ‰©å®¹ã€‚sliceä½œä¸ºå‚æ•°è¿›è¡Œä¼ é€’çš„æ—¶å€™ï¼Œè¿˜æœ‰sliceè¿›è¡Œappendçš„æ—¶å€™æ³¨æ„ä¸€ä¸‹ï¼Œåˆ«çš„åº”è¯¥æ²¡æœ‰é—®é¢˜ã€‚æ€»çš„æ¥è¯´sliceçš„å®žçŽ°è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚]]></content>
      <categories>
        <category>golangæºç è§£æž</category>
      </categories>
      <tags>
        <tag>slice</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æµ…å…¥æ·±å‡ºETCDä¹‹ã€é›†ç¾¤éƒ¨ç½²ä¸Žgolangå®¢æˆ·ç«¯ä½¿ç”¨ã€‘]]></title>
    <url>%2F2019%2F06%2F14%2Fgolang%2Fopen-source-component%2Fetcd-cluster-client%2F</url>
    <content type="text"><![CDATA[ä¹‹å‰è¯´äº†etcdçš„ç®€ä»‹ï¼Œå‘½ä»¤è¡Œä½¿ç”¨ï¼Œä¸€äº›åŸºæœ¬åŽŸç†ã€‚è¿™æ¬¡æ¥è¯´è¯´çŽ°å®žä¸€ç‚¹çš„é›†ç¾¤éƒ¨ç½²å’Œgolangç‰ˆæœ¬çš„å®¢æˆ·ç«¯ä½¿ç”¨ã€‚å› ä¸ºåœ¨å®žé™…ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œetcdçš„èŠ‚ç‚¹è‚¯å®šæ˜¯éœ€è¦2N+1ä¸ªè¿›è¡Œéƒ¨ç½²çš„ï¼Œæ‰€ä»¥æœ‰å¿…è¦è¯´æ˜Žä¸€ä¸‹é›†ç¾¤çš„éƒ¨ç½²ã€‚ é›†ç¾¤éƒ¨ç½²ç½‘ä¸Šæœ‰å¾ˆå¤šé›†ç¾¤éƒ¨ç½²çš„æ•™ç¨‹ï¼Œæœ‰çš„å¾ˆå¤æ‚ï¼Œå…¶å®žå¯¹äºŽæˆ‘ä»¬å®žé™…ä½¿ç”¨æ¥è¯´ï¼Œå…¶å®žé…ç½®å¹¶ä¸å¤æ‚ï¼Œä¸‹é¢ä¸¾ä¾‹ä¸€ç§æœ€ç®€å•çš„é›†ç¾¤é…ç½®ã€‚ï¼ˆç®€å•åˆ°ä½ æƒ³ä¸åˆ°~ï¼‰ ä¸‹è½½https://github.com/etcd-io/etcd/releasesè¿˜æ˜¯åœ¨githubä¸Šé¢æ‰¾åˆ°éœ€è¦ä¸‹è½½çš„ç‰ˆæœ¬æˆ‘ä½¿ç”¨çš„æ˜¯etcd-v3.3.13-linux-amd64.tar.gzä½¿ç”¨wgetä¸‹è½½åˆ°linuxä½ å–œæ¬¢çš„ç›®å½•ï¼Œæˆ–è€…æœ¬åœ°ä¸‹è½½å®Œæˆä¹‹åŽä¸Šä¼ å‡å¯ã€‚ éƒ¨ç½²é¦–å…ˆæˆ‘æ‰¾äº†ä¸‰å°æœºå™¨ï¼Œå¯¹åº”ipä¸º192.168.4.224192.168.4.225192.168.4.226PSï¼šæé†’ä¸€ä¸‹è®°å¾—å¼€å‘å¯¹åº”é˜²ç«å¢™çš„ç«¯å£ ç„¶åŽå°†ä¸‹è½½çš„æ–‡ä»¶è§£åŽ‹ï¼Œä¹‹åŽè¿›å…¥è§£åŽ‹åŽçš„ç›®å½•ï¼Œåˆ†åˆ«ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å¯åŠ¨ã€‚(æ³¨æ„ä¸‹é¢çš„å‘½ä»¤å¯¹åº”çš„æ˜¯ä¸‰å°ä¸åŒçš„æœºå™¨ï¼Œä½ éœ€è¦ä¿®æ”¹å¯¹åº”ä¸ºä½ è‡ªå·±çš„ip) 1234567891011121314151617181920212223$ ./etcd --name infra0 --initial-advertise-peer-urls http://192.168.4.224:2380 \--listen-peer-urls http://192.168.4.224:2380 \--listen-client-urls http://192.168.4.224:2379,http://127.0.0.1:2379 \--advertise-client-urls http://192.168.4.224:2379 \--initial-cluster-token etcd-cluster-1 \--initial-cluster infra0=http://192.168.4.224:2380,infra1=http://192.168.4.225:2380,infra2=http://192.168.4.226:2380 \--initial-cluster-state new$ ./etcd --name infra1 --initial-advertise-peer-urls http://192.168.4.225:2380 \--listen-peer-urls http://192.168.4.225:2380 \--listen-client-urls http://192.168.4.225:2379,http://127.0.0.1:2379 \--advertise-client-urls http://192.168.4.225:2379 \--initial-cluster-token etcd-cluster-1 \--initial-cluster infra0=http://192.168.4.224:2380,infra1=http://192.168.4.225:2380,infra2=http://192.168.4.226:2380 \--initial-cluster-state new$ ./etcd --name infra2 --initial-advertise-peer-urls http://192.168.4.226:2380 \--listen-peer-urls http://192.168.4.226:2380 \--listen-client-urls http://192.168.4.226:2379,http://127.0.0.1:2379 \--advertise-client-urls http://192.168.4.226:2379 \--initial-cluster-token etcd-cluster-1 \--initial-cluster infra0=http://192.168.4.224:2380,infra1=http://192.168.4.225:2380,infra2=http://192.168.4.226:2380 \--initial-cluster-state new è‡³æ­¤ï¼Œä¸‰ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤éƒ¨ç½²å®Œæˆã€‚ðŸ˜‚ðŸ˜‚ðŸ˜‚æ²¡é”™å°±æ˜¯è¿™ä¹ˆeasyï¼Œæ²¡æœ‰ç½‘ä¸Šè¯´çš„é‚£ä¹ˆå¤æ‚ã€‚ é…ç½®æ–‡ä»¶å¦‚æžœä½ å«Œå¼ƒæ¯æ¬¡ä½¿ç”¨è¿™ä¹ˆé•¿çš„å‘½ä»¤è¿›è¡Œå¯åŠ¨ï¼Œä½ å¯ä»¥å°†å®ƒå†™ä¸ºé…ç½®æ–‡ä»¶ï¼š12345678910111213141516171819202122# å½“å‰èŠ‚ç‚¹åç§°name: infra1# etcdæ•°æ®ä¿å­˜ç›®å½•data-dir: /usr/local/etcd# ä¾›å¤–éƒ¨å®¢æˆ·ç«¯ä½¿ç”¨çš„urllisten-client-urls: http://192.168.4.225:2379,http://127.0.0.1:2379# å¹¿æ’­ç»™å¤–éƒ¨å®¢æˆ·ç«¯ä½¿ç”¨çš„urladvertise-client-urls: http://192.168.4.225:2379# é›†ç¾¤å†…éƒ¨é€šä¿¡ä½¿ç”¨çš„URLlisten-peer-urls: http://192.168.4.225:2380# å¹¿æ’­ç»™é›†ç¾¤å†…å…¶ä»–æˆå‘˜è®¿é—®çš„URLinitial-advertise-peer-urls: http://192.168.4.225:2380# é›†ç¾¤çš„åç§°initial-cluster-token: etcd-cluster-1# åˆå§‹é›†ç¾¤æˆå‘˜åˆ—è¡¨initial-cluster: infra0=http://192.168.4.224:2380,infra1=http://192.168.4.225:2380,infra2=http://192.168.4.226:2380#åˆå§‹é›†ç¾¤çŠ¶æ€initial-cluster-state: new ç„¶åŽæŒ‡å®šé…ç½®æ–‡ä»¶çš„è·¯å¾„è¿›è¡Œå¯åŠ¨å°±å¯ä»¥äº†1./etcd --config-file=conf.yml å…¶ä»–éƒ¨ç½²ç­–ç•¥ä»¥ä¸Šçš„éƒ¨ç½²ä¸€æ–¹é¢ï¼Œæˆ‘ä¸ªäººéƒ¨ç½²æ—¶ä½¿ç”¨çš„æœ€ç®€å•æ–¹å¼ï¼Œæ›´ç®€å•çš„å¯èƒ½æ˜¯ä½¿ç”¨yumè¿›è¡Œetcdçš„ä¸‹è½½ã€‚å½“ç„¶ä¸Šè¿°æ–¹å¼ä¹Ÿå­˜åœ¨ä¸€äº›é—®é¢˜ï¼ŒçŽ°åœ¨çš„etcdç›¸å½“äºŽè£¸å¥”çš„æƒ…å†µï¼š æ²¡æœ‰é‰´æƒå°±æƒ³åˆ°äºŽä»»ä½•äººçŸ¥é“ipå’Œç«¯å£å°±å¯ä»¥è¿žæŽ¥ä¸Šä½ çš„etcdï¼Œæ‰€ä»¥å½“å‰å¯èƒ½åªé€‚ç”¨äºŽå†…ç½‘ä½¿ç”¨ï¼ŒæœåŠ¡é€šè¿‡å†…ç½‘ipè¿›è¡Œè®¿é—®ï¼ˆè¿™ä¸ªå¯ä»¥é€šè¿‡æ·»åŠ æƒé™å’Œç”¨æˆ·æ¥å®Œæˆï¼‰ å½“å‰é€šä¿¡æ˜¯æ²¡æœ‰åŠ å¯†çš„ å½“å‰etcdæ˜¯åˆ©ç”¨é™æ€ipæ¥è¿›è¡Œé…ç½®çš„ï¼Œæˆ‘è®¤ä¸ºè¿™ä¹Ÿæ˜¯å®žé™…ä¸­ç”¨åˆ°æœ€æ™®é€šçš„æƒ…å†µï¼Œä½†æ˜¯etcdè¿˜æä¾›å‘çŽ°æœºåˆ¶æ¥è¿›è¡Œéƒ¨ç½²å’Œé…ç½®ï¼Œæ›´åŠ çµæ´» ç­‰ç­‰ï¼Œè¿™äº›éƒ¨ç½²ç­–ç•¥æ›´å¤šé’ˆå¯¹äºŽçº¿ä¸Šï¼Œå› ä¸ºå®˜æ–¹å†™çš„éžå¸¸è¯¦ç»†äº†ï¼Œæˆ‘æ„Ÿè§‰å†å†™ä¹Ÿå°±ç­é—¨å¼„æ–§äº†ã€‚https://doczhcn.gitbook.io/etcd/index/index-1/clustering Golangå®¢æˆ·ç«¯ä½¿ç”¨è¿™é‡Œæ¥å®žé™…ç”¨ä»£ç æ“ä½œä¸€ä¸‹etcdï¼Œè¿˜æ˜¯å’Œä¹‹å‰ä½¿ç”¨å‘½ä»¤è¡Œä¸€æ ·ï¼Œget/put/del/watch/leaseç”¨ä¸€ä¸‹è¿™äº›æ“ä½œï¼Œå…¶ä»–æ“ä½œè¯·æŸ¥çœ‹dochttps://godoc.org/github.com/coreos/etcd/clientv3 å®¢æˆ·ç«¯ä¸‹è½½è¿™é‡Œä¸å»ºè®®ä½¿ç”¨go getè¿›è¡Œä¸‹è½½ï¼ŒçœŸçš„å¤ªæ…¢äº†ï¼Œå¯ä»¥ç›´æŽ¥ä»Žgithubä¸Šé¢ä¸‹è½½ä¹‹åŽæ”¾åˆ°å¯¹åº”ç›®å½•å¿«ä¸€äº›ã€‚https://github.com/etcd-io/etcdä¸‹è½½è§£åŽ‹ä¹‹åŽæ”¾åˆ°gopathä¸‹å¯¹åº”ï¼šgo/src/go.etcd.io/etcd ä»£ç 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980package mainimport ( "context" "fmt" "go.etcd.io/etcd/clientv3" "go.etcd.io/etcd/mvcc/mvccpb" "time")func main() &#123; // é…ç½®å®¢æˆ·ç«¯è¿žæŽ¥ client, err := clientv3.New(clientv3.Config&#123; // Endpoints: []string&#123;"127.0.0.1:2379"&#125;, Endpoints: []string&#123;"192.168.4.224:2379", "192.168.4.225:2379", "192.168.4.226:2379"&#125;, DialTimeout: 5 * time.Second, &#125;) if err != nil &#123; panic(err) &#125; defer client.Close() // å¯åŠ¨watchç›‘å¬ watch := client.Watch(context.TODO(), "aaa") go func() &#123; for &#123; watchResponse := &lt;- watch for _, ev := range watchResponse.Events &#123; switch ev.Type &#123; case mvccpb.DELETE: fmt.Printf("ç›‘å¬åˆ°delï¼š%s\n", ev.Kv.Key) case mvccpb.PUT: fmt.Printf("ç›‘å¬åˆ°putï¼š%s, %s\n", ev.Kv.Key, ev.Kv.Value) &#125; &#125; &#125; &#125;() // æ–°å¢ž putResponse, err := client.Put(context.TODO(), "aaa", "xxx") if err != nil &#123; fmt.Println(err) return &#125; fmt.Println(putResponse.Header.String()) // æŸ¥è¯¢ getResponse, err := client.Get(context.TODO(), "aaa") if err != nil &#123; fmt.Println(err) return &#125; fmt.Println(getResponse.Kvs) // åˆ é™¤ deleteResponse, err := client.Delete(context.TODO(), "aaa") if err != nil &#123; fmt.Println(err) return &#125; fmt.Println(deleteResponse.Header.String()) // ç”³è¯·ç§Ÿçº¦ grantResponse, err := client.Grant(context.TODO(), 10) if err != nil &#123; fmt.Println(err) return &#125; // ä½¿ç”¨ç§Ÿçº¦ response, err := client.Put(context.TODO(), "aaa", "xxx", clientv3.WithLease(grantResponse.ID)) if err != nil &#123; fmt.Println(err) return &#125; fmt.Println(response.Header.String()) // ç­‰å¾…ç§Ÿçº¦è‡ªåŠ¨è¿‡æœŸ time.Sleep(time.Second * 20)&#125; å¤§è‡´èƒ½å¾—åˆ°ä»¥ä¸‹è¾“å‡º ç›‘å¬åˆ°putï¼šaaa, xxxcluster_id:14841639068965178418 member_id:10276657743932975437 revision:53 raft_term:4[key:â€aaaâ€ create_revision:53 mod_revision:53 version:1 value:â€xxxâ€ ]ç›‘å¬åˆ°delï¼šaaacluster_id:14841639068965178418 member_id:10276657743932975437 revision:54 raft_term:4ç›‘å¬åˆ°putï¼šaaa, xxxcluster_id:14841639068965178418 member_id:10276657743932975437 revision:55 raft_term:4ç›‘å¬åˆ°delï¼šaaa å…¶å®žä½¿ç”¨èµ·æ¥è¿˜æ˜¯éžå¸¸ç®€å•ï¼Œæˆ‘å°±ä¸è¿‡å¤šèµ˜è¿°äº†ã€‚]]></content>
      <categories>
        <category>etcd</category>
      </categories>
      <tags>
        <tag>etcd</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æµ…å…¥æ·±å‡ºETCDä¹‹ã€raftåŽŸç†ã€‘]]></title>
    <url>%2F2019%2F06%2F12%2Fgolang%2Fopen-source-component%2Fetcd-raft%2F</url>
    <content type="text"><![CDATA[è¿™æ¬¡æˆ‘ä»¬æ¥è¯´è¯´ï¼Œæœ‰å…³äºŽetcdåŽŸç†çš„ä¸€äº›äº‹æƒ…ã€‚ä¹‹å‰æˆ‘ä»¬å·²ç»äº†è§£åˆ°äº†etcdæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„k-vå­˜å‚¨ï¼Œé‚£ä¹ˆå®ƒç©¶ç«Ÿæ˜¯å¦‚ä½•ä¿è¯æ•°æ®æ˜¯å¦‚ä½•å¤åˆ¶åˆ°æ¯ä¸ªèŠ‚ç‚¹ä¸Šé¢åŽ»çš„å‘¢ï¼Ÿåˆæ˜¯å¦‚ä½•ä¿è¯åœ¨ç½‘ç»œåˆ†åŒºçš„æƒ…å†µä¸‹èƒ½æ­£å¸¸å·¥ä½œä¸‹åŽ»ï¼Ÿraftåè®®åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿå¸¦ç€è¿™äº›é—®é¢˜æˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ã€‚ rafté€‰ä¸¾ç­–ç•¥æˆ‘ä»¬çŸ¥é“etcdä½¿ç”¨raftåè®®æ¥ä¿è¯æ•´ä¸ªåˆ†å¸ƒå¼çš„èŠ‚ç‚¹ç½‘ç»œèƒ½æ­£å¸¸çš„è¿è½¬å¹¶ä¸”èƒ½æ­£ç¡®çš„å°†æ•°æ®å¤åˆ¶åˆ°æ¯ä¸ªèŠ‚ç‚¹ä¸Šé¢åŽ»ã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯raftåè®®å˜žï¼Ÿ é¦–å…ˆæˆ‘ä»¬æœ‰è¿™æ ·ä¸€ä¸ªèƒŒæ™¯ï¼šraftæ˜¯æƒ³ç»´æŠ¤æ•´ä¸€ä¸ªç½‘ç»œï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªé¢†å¯¼äººï¼Œè¿™ä¸ªé¢†å¯¼äººè´Ÿè´£å°†æ”¶åˆ°çš„ä¿¡æ¯åŒæ­¥ç»™ç½‘ç»œä¸­çš„å…¶ä»–æ‰€æœ‰èŠ‚ç‚¹ï¼Œä»Žè€Œä¿è¯æ•´ä¸ªç½‘ç»œæ•°æ®ä¸€è‡´ã€‚ å¦‚æžœä½ æœ‰ä¸€å®šçš„è‹±æ–‡åŸºç¡€ï¼Œæˆ‘å»ºè®®ç›´æŽ¥æŸ¥çœ‹ä¸‹é¢è¿™ä¸ªç½‘ç«™ï¼Œå®ƒç”¨åŠ¨ç”»éžå¸¸æ¸…æ¥šçš„æè¿°äº†rafté€‰ä¸¾çš„æ•´ä¸ªè¿‡ç¨‹ï¼šhttp://thesecretlivesofdata.com/raft/ è¿™ä¸ªå…¶å®žå·²ç»è¯´æ˜Žçš„è¶…çº§æ£’äº†ï¼Œå¦‚æžœä½ è¿˜çœ‹ä¸æ‡‚ï¼Œæˆ‘ä¸‹é¢ä¼šç”¨æœ€ç®€å•çš„å‡ ä¸ªè¦ç‚¹æ¥è¿›è¡Œæœ€ç®€å•çš„è¯´æ˜Žã€‚ å¤§å¤šæ•°ç†è®ºé¦–å…ˆè¯´æ˜Žä¸€ä¸ªç†è®ºï¼Œå«åšå¤§å¤šæ•°ç†è®ºï¼Œå¾ˆç®€å•ï¼Œä¸¾ä¸ªæ —å­ï¼š æœ‰10ä¸ªäººï¼Œå¦‚æžœä½ å°†è‹¹æžœç»™å…¶ä¸­çš„6ä¸ªäººï¼ˆå¤§å¤šæ•°ï¼‰ï¼Œé‚£ä¹ˆä½ éšæœºé€‰æ‹©5ä¸ªäººï¼Œä¸€å®šæœ‰ä¸€ä¸ªäººä¼šæœ‰è‹¹æžœã€‚ åœ¨etcdä¸­çš„åº”ç”¨ï¼š é€‰ä¸¾ä¸­åªè¦æœ‰å¤§å¤šæ•°ï¼ˆè¶…è¿‡åŠæ•°çš„äººç»™ä½ æŠ•ç¥¨ï¼‰ä½ è‚¯å®šå°±æ˜¯ç¥¨æ•°æœ€å¤šçš„äº†ï¼Œä¸å¯èƒ½æœ‰äººæ¯”ä½ æ›´å¤šã€‚ åªéœ€è¦å°†æ—¥å¿—å¤åˆ¶ç»™å¤§å¤šæ•°çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆåªè¦æœ‰ä¸€åŠçš„èŠ‚ç‚¹æ­£å¸¸å·¥ä½œå°±èƒ½ä¿è¯æ•°æ®æœ€æ–° é€‰ä¸¾çŠ¶æ€ä¸‹é¢æ˜¯ä¸€äº›é€‰ä¸¾è¿‡ç¨‹ä¸­èŠ‚ç‚¹çš„çŠ¶æ€leader è¡¨ç¤ºé€‰ä¸¾æœ€ç»ˆäº§ç”Ÿçš„é¢†å¯¼äººcandidate å€™é€‰çŠ¶æ€ï¼Œè¡¨ç¤ºå½“å‰æ­£åœ¨å‚ä¸Žé€‰ä¸¾follower è¡¨ç¤ºé€‰ä¸¾æœ€ç»ˆè‡ªå·±ä¸æ˜¯é¢†å¯¼äººï¼Œé‚£è‡ªå·±å°±æ˜¯ä»Žå±žèŠ‚ç‚¹ é€‰ä¸¾è¿‡ç¨‹ä¸Žè¦ç‚¹ æ‰€æœ‰èŠ‚ç‚¹ä¸€å¼€å§‹éƒ½æ˜¯followerçŠ¶æ€ å½“èŠ‚ç‚¹å¤„äºŽfollowerçŠ¶æ€æ—¶ï¼Œæ¯ä¸ªèŠ‚ç‚¹éšæœºç»è¿‡ä¸€æ®µæ—¶é—´ï¼Œå¦‚æžœæ²¡æœ‰æ”¶åˆ°leaderçš„æ¶ˆæ¯å°±ä¼šè¿›å…¥candidateçŠ¶æ€ï¼ˆè¯æ˜Žå½“å‰æ²¡æœ‰leaderèŠ‚ç‚¹éœ€è¦é‡æ–°è¿›è¡Œé€‰ä¸¾ï¼‰ï¼Œå¦‚æžœæ”¶åˆ°ä¿¡æ¯å°±ä¼šç»§ç»­ä¿æŒfollowerçŠ¶æ€ å½“èŠ‚ç‚¹å¤„äºŽcandidateå°±ä¼šè¦æ±‚åˆ«äººç»™è‡ªå·±æŠ•ç¥¨ï¼Œæ”¶åˆ°å¤§å¤šæ•°çš„èŠ‚ç‚¹çš„æŠ•ç¥¨é‚£å°±è½¬å˜ä¸ºleaderçŠ¶æ€ï¼Œå¦åˆ™è¦ä¹ˆæ˜¯åˆ«çš„èŠ‚ç‚¹æˆä¸ºäº†leaderï¼Œè¦ä¹ˆå°±æ˜¯å› ä¸ºç‰¹æ®Šæƒ…å†µå¯¼è‡´è¿™æ¬¡é€‰ä¸¾å¤±è´¥é‡æ–°è¿›è¡Œé€‰ä¸¾ æ¯æ¬¡é€‰ä¸¾ä¸¾åŠžçš„æ—¶å€™æœ‰ä¸€ä¸ªtermï¼Œåœ¨æ¯ä¸€ä¸ªtermä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹åªèƒ½æŠ•ç¥¨ä¸€æ¬¡ æŠ•ç¥¨çš„æ—¶å€™å¿…é¡»æŠ•ç»™å½“å‰æ•°æ®è‡³å°‘å’Œè‡ªå·±ä¸€æ ·çš„èŠ‚ç‚¹ï¼Œå¹¶ä¸”termå¤§çš„ä¼˜å…ˆ æ—¥å¿—å¤åˆ¶è§„åˆ™etcdæ˜¯é€šè¿‡æ—¥å¿—å¤åˆ¶æ¥å®žçŽ°æ•°æ®åŒæ­¥çš„è¿™ä¸ªå›¾ç½‘ä¸Šä¹Ÿå¾ˆå¤šï¼Œè¯´æ˜Žçš„æ˜¯æ—¥å¿—å¤åˆ¶çš„è§„åˆ™æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä»½è‡ªå·±çš„æ—¥å¿—ï¼Œæœ‰çš„èŠ‚ç‚¹å¤šï¼Œæœ‰çš„èŠ‚ç‚¹å°‘ï¼Œæ—¥å¿—æœ€å¤šçš„è‚¯å®šæ˜¯leaderã€‚ä¸Šå›¾è¿˜æœ‰å‡ ä¸ªè¦ç‚¹ï¼Œæˆ‘çœ‹åˆ«äººæ²¡æåˆ°ï¼Œæˆ‘å°±æä¸€ä¸‹ï¼š é¢œè‰²ä»£è¡¨term ç¬¬å››è¡Œè¡¨ç¤ºçš„è¿™ä¸ªèŠ‚ç‚¹ï¼Œç¬¬ä¸€termä¸‹å¤åˆ¶äº†ä¸¤ä¸ªæ—¥å¿—å°±å¼‚å¸¸æŒ‚æŽ‰äº† æœ€ç»ˆåªæœ‰ç¬¬ä¸‰è¡Œè¿™ä¸ªfollowerå’Œç¬¬ä¸€è¡Œçš„leaderä¿æŒäº†åŒæ­¥ å¼‚å¸¸æƒ…å†µraftä¹‹æ‰€ä»¥åŽ‰å®³å› ä¸ºå³ä½¿å‡ºçŽ°ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼Œæ•´ä¸ªç½‘ç»œåœ¨ä¸€å®šçš„æ—¶é—´ä¹‹åŽä¹Ÿèƒ½è‡ªåŠ¨æ¢å¤å¹¶æ­£å¸¸å·¥ä½œã€‚ ä¸€ä¸ªèŠ‚ç‚¹çš„å¼‚å¸¸é¦–å…ˆæœ€å¸¸è§çš„æƒ…å†µå°±æ˜¯ä¸€ä¸ªèŠ‚ç‚¹å‡ºçŽ°å¼‚å¸¸ï¼Œæœ‰å¯èƒ½æ˜¯è¿™ä¸ªèŠ‚ç‚¹çš„æœåŠ¡å™¨æŒ‚äº†ï¼Œæˆ–è€…åˆ«çš„ä»€ä¹ˆåŽŸå› ã€‚ å¦‚æžœå‡ºçŽ°é—®é¢˜çš„è¿™ä¸ªèŠ‚ç‚¹æ˜¯followerï¼Œé‚£ä¹ˆæ²¡æœ‰å…³ç³»ï¼Œæ•´ä¸ªç½‘ç»œä¾æ—§èƒ½æ­£å¸¸è¿è¡Œï¼Œå½“è¿™ä¸ªèŠ‚ç‚¹å†æ¬¡åŠ å…¥ç½‘ç»œçš„æ—¶å€™ä¹Ÿåªéœ€è¦åŒæ­¥åŽé¢çš„æ•°æ®å³å¯ã€‚ å¦‚æžœå‡ºçŽ°é—®é¢˜çš„æ˜¯leaderï¼Œæœ‰ä¸€ç‚¹éº»çƒ¦ï¼Œå› ä¸ºç½‘ç»œä¸­æ²¡æœ‰leaderèŠ‚ç‚¹äº†ï¼Œé‚£ä¹ˆå°±ä¼šé‡æ–°è¿›è¡Œé€‰ä¸¾ï¼Œé‡æ–°æ‰¾ä¸€ä¸ªleaderï¼Œå½“è¿™ä¸ªå¼‚å¸¸èŠ‚ç‚¹æ¢å¤ä¹‹åŽå‘çŽ°å½“å‰ç½‘ç»œä¸­æœ‰leaderäº†ï¼Œè€Œä¸”termè¿˜æ¯”è‡ªå·±å¤§ï¼Œé‚£ä¹ˆè‡ªå·±å°±é€€ä½ç§°ä¸ºfollowerã€‚ ç½‘ç»œåˆ†åŒºè¿˜æœ‰ä¸€ç§å¼‚å¸¸æƒ…å†µæ˜¯ç”±äºŽç½‘ç»œå¯¼è‡´çš„ï¼Œç½‘ç»œå‡ºçŽ°å¼‚å¸¸ï¼Œå¯¼è‡´èŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡å­˜åœ¨å¼‚å¸¸ï¼Œä¸€éƒ¨åˆ†èŠ‚ç‚¹ä¸Žå¦ä¸€éƒ¨åˆ†ä¹‹é—´æ²¡æœ‰åŠžæ³•è®¿é—®äº†ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ä¸Šé¢ä¸‰ä¸ªfolloweræ²¡æœ‰åŠžæ³•ä¸Žä¸‹é¢çš„èŠ‚ç‚¹è¿›è¡Œé€šä¿¡ã€‚ å½“å®¢æˆ·ç«¯å†æ¬¡è¯·æ±‚leaderå‘é€æ•°æ®çš„æ—¶å€™ï¼Œleaderå‘çŽ°æ²¡æœ‰åŠžæ³•å°†æ•°æ®åŒæ­¥ç»™ç»™å¤§å¤šæ•°èŠ‚ç‚¹ï¼Œå®ƒåªèƒ½ç»™è‡ªå·±å’Œæ—è¾¹çš„ä¸€ä¸ªï¼Œæ­¤æ—¶leaderæ²¡æœ‰åŠžæ³•ç»™å®¢æˆ·ç«¯åé¦ˆã€‚ ä¸Šé¢ä¸‰ä¸ªèŠ‚ç‚¹ç”±äºŽæ”¶ä¸åˆ°leaderçš„æ¶ˆæ¯ï¼Œé‚£ä¹ˆä¼šè®¤ä¸ºç½‘ç»œä¸­æ²¡æœ‰leaderå­˜åœ¨ï¼Œä¼šé‡æ–°è¿›è¡Œé€‰ä¸¾æ“ä½œï¼Œå› ä¸ºå½“å‰ä¸Šé¢æœ‰ä¸‰ä¸ªèŠ‚ç‚¹å­˜åœ¨ï¼ˆåªè¦æœ‰è¶…è¿‡åŠæ•°çš„èŠ‚ç‚¹å‚ä¸Žé€‰ä¸¾å°±è¡Œï¼‰ï¼Œæ‰€ä»¥å¯ä»¥é‡æ–°é€‰ä¸¾æˆåŠŸï¼Œé€‰å‡ºæ–°çš„leaderå‘Šè¯‰å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å°±ä¼šé‡æ–°å‘é€æ•°æ®åˆ°æ–°çš„leaderã€‚ å½“ç½‘ç»œæ¢å¤ä¹‹åŽåˆä¼šæ‰¾åˆ°æœ€æ–°çš„leaderä»Žè€Œå°†æ•°æ®åŒæ­¥è‡³æœ€æ–°çš„çŠ¶æ€ã€‚ æ€»ç»“æ€»çš„æ¥è¯´ï¼Œåªè¦æ•´ä¸ªç½‘ç»œä¸­å­˜åœ¨å¤§å¤šæ•°èŠ‚ç‚¹æ­£å¸¸è¿è¡Œï¼Œé‚£ä¹ˆetcdå°±æ˜¯å¯ç”¨çš„ï¼Œå¹¶ä¸”èƒ½å¤Ÿä¿è¯æ•°æ®æ­£ç¡®ã€‚å½“ç½‘ç»œæ¢å¤ä¹‹åŽä¹Ÿèƒ½å°†æ•°æ®è°ƒæ•´åˆ°æœ€æ–°çš„çŠ¶æ€ã€‚raftå¼ºå¤§çš„åœ°æ–¹åœ¨äºŽå®ƒèƒ½è‡ªåŠ¨çš„è¿›è¡ŒçŠ¶æ€çš„å˜åŒ–ï¼Œè‡ªåŠ¨è¿›è¡Œé€‰ä¸¾ï¼Œå¹¶ä¸”é€‰ä¸¾éµå¾ªä¸€å®šçš„ç­–ç•¥ï¼Œè¿›è€Œä¿è¯æ•´ä¸ªç½‘ç»œçš„æ­£å¸¸è¿è½¬ã€‚åŒæ—¶ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚äº†è§£etcdçš„è¿™ä¸ªåŽŸç†æœ‰åŠ©äºŽæˆ‘ä»¬åŽç»­çš„ä½¿ç”¨ä»¥åŠæºç çš„é˜…è¯»ã€‚]]></content>
      <categories>
        <category>etcd</category>
      </categories>
      <tags>
        <tag>etcd</tag>
        <tag>raft</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æµ…å…¥æ·±å‡ºETCDä¹‹ã€ç®€ä»‹ä¸Žå‘½ä»¤è¡Œä½¿ç”¨ã€‘]]></title>
    <url>%2F2019%2F06%2F10%2Fgolang%2Fopen-source-component%2Fetcd-brief%2F</url>
    <content type="text"><![CDATA[ä½ çŸ¥é“etcdå—ï¼Ÿéšç€k8sçš„ä½¿ç”¨å¹¿æ³›ä¹‹åŽï¼Œetcdè¢«éžå¸¸å¤šçš„äººæ‰€çŸ¥é“ï¼ŒåŒæ—¶åˆå› ä¸ºå®ƒå¯é çš„åˆ†å¸ƒå¼ç‰¹æ€§è¢«å¾ˆå¤šäººå–œæ¬¢ã€‚æ‰€ä»¥ï¼Œæˆ‘å‡†å¤‡æœ‰å‡ ç¯‡åšæ–‡æ¥è®°å½•ä¸€ä¸‹ï¼Œä»ŽåŸºæœ¬ä½¿ç”¨åˆ°çº¿ä¸Šéƒ¨ç½²å†åˆ°åŽŸç†åˆ†æžï¼Œåšä¸€ä¸ªç³»åˆ—ã€‚é‚£ä¹ˆï¼Œä»Šå¤©å…ˆæ¥è¯´è¯´å®ƒçš„ç®€ä»‹ä¸Žå‘½ä»¤è¡Œçš„ä½¿ç”¨ã€‚ ç®€ä»‹ETCDæ˜¯ä»€ä¹ˆæˆ‘ä¸ªäººæ€»ç»“ä¸ºä¸‹é¢ç”¨å‡ ä¸ªè¦ç‚¹ï¼š é«˜å¯ç”¨K-Vå­˜å‚¨ï¼Œå°±ç±»ä¼¼äºŽredisä¸€æ ·çš„é”®å€¼å¯¹å­˜å‚¨ã€‚ å…è®¸åº”ç”¨å®žæ—¶ç›‘å¬å­˜å‚¨ä¸­çš„K-Vå˜åŒ–ã€‚ èƒ½å¤Ÿå®¹å¿å•ç‚¹æ•…éšœï¼Œèƒ½å¤Ÿåº”å¯¹ç½‘ç»œåˆ†åŒºã€‚ etcdåˆ©ç”¨raftåœ¨é›†ç¾¤ä¸­åŒæ­¥K-Vä¿¡æ¯ï¼Œraftæ˜¯å¼ºä¸€è‡´çš„é›†ç¾¤æ—¥å¿—åŒæ­¥ç®—æ³•ã€‚ æ€»ç»“ï¼šetcdæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼é«˜å¯ç”¨k-vå­˜å‚¨ï¼Œé€šè¿‡å¤åˆ¶è¾¾åˆ°æ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨çš„ä¿¡æ¯ä¸€è‡´ï¼Œä»Žè€Œä¿è¯é«˜å¯ç”¨ã€‚ æ•°æ®å¤åˆ¶è¿™é‡Œç®€å•è¯´ä¸€ä¸‹å¤åˆ¶çš„å…·ä½“æµç¨‹ï¼š ï¼ˆclientä¸ºæˆ‘ä»¬çš„å®¢æˆ·ç«¯ï¼Œç”¨æ¥å‘å‡ºå­˜å‚¨è¯·æ±‚ï¼Œleaderå’Œfolloweréƒ½æ˜¯etcdçš„èŠ‚ç‚¹ï¼‰å°±å¦‚å›¾ä¸Šæ‰€çœ‹åˆ°çš„ï¼Œæˆ‘å«å®ƒä¸¤æ®µå¼æäº¤ï¼š å®¢æˆ·ç«¯è¯·æ±‚leaderå‘é€å­˜å‚¨çš„æ•°æ®ï¼Œç„¶åŽleaderèŠ‚ç‚¹è¦å°†ä¿¡æ¯é€šè¿‡æ—¥å¿—å¤åˆ¶ç»™å¤§å¤šæ•°çš„followerèŠ‚ç‚¹ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåªéœ€è¦å¤åˆ¶ç»™ä¸¤ä¸ªï¼ˆåŠ ä¸Šå®ƒè‡ªå·±æ˜¯ä¸‰ä¸ªï¼‰é‚£ä¹ˆå°±æ˜¯å¤§å¤šæ•°èŠ‚ç‚¹ã€‚ leaderå½“å¤åˆ¶å®Œæˆä¹‹åŽæ‰ä¼šæœ¬åœ°æäº¤ï¼Œç„¶åŽè¿”å›žç»™å®¢æˆ·ç«¯æˆåŠŸï¼Œï¼ˆå¦‚æžœæ²¡æœ‰æˆ–è€…ä¸èƒ½å¤åˆ¶ç»™å¤§å¤šæ•°èŠ‚ç‚¹ï¼Œé‚£ä¹ˆåˆ™å­˜å‚¨å¤±è´¥ï¼‰æ­¤æ—¶å†åŒæ—¶å…¶ä»–followeråŽ»ä»–ä»¬è‡ªå·±æœ¬åœ°æäº¤ã€‚æ˜¯ä¸æ˜¯æœ‰ä¸€ç§åˆ†å¸ƒå¼äº‹åŠ¡çš„æ„Ÿè§‰ï¼Ÿåˆ†å¸ƒå¼çš„è§£å†³é€šå¸¸éƒ½æ˜¯è¿™ç§æ„Ÿè§‰ã€‚ æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œetcdé€šè¿‡å…ˆå°†æ•°æ®å­˜æ”¾åœ¨å¤§å¤šæ•°èŠ‚ç‚¹ä¸Šé¢ä»Žè€Œä¿è¯æ•°æ®ä¸ä¼šå‡ºé”™å¹¶ä¸”æ•ˆçŽ‡è¾ƒé«˜ï¼Œæœ€ç»ˆæ‰€æœ‰èŠ‚ç‚¹æ•°æ®è¿˜æ˜¯ä¼šåŒæ­¥ä¸€è‡´çš„ã€‚ å®˜æ–¹ç»™å‡ºå†™å…¥çš„æ€§èƒ½ï¼š1000/s PS:è¿™é‡Œå› ä¸ºæ˜¯ç®€ä»‹ï¼Œæ‰€ä»¥å°±ç®€å•æä¸€ä¸‹ï¼Œæœ‰å…³å¦‚ä½•é€‰ä¸¾å‡ºleaderè¿˜æœ‰raftåè®®çš„ä¸€äº›å…·ä½“ç»†èŠ‚ï¼Œä»¥åŠå½“å‡ºçŽ°ç½‘ç»œåˆ†åŒºæˆ–è€…èŠ‚ç‚¹å¼‚å¸¸é—®é¢˜çš„æ¢å¤ä¼šåœ¨ä¹‹åŽçš„åšå®¢ä¸­ç»™å‡ºã€‚ å­˜å‚¨ç»“æž„åº•å±‚å­˜å‚¨keyæ˜¯æœ‰åºæŽ’åˆ—çš„â€˜keyâ€™ -&gt; â€˜valueâ€™ aaa/bbb -&gt; 111aaa/bbc -&gt; 3333bbb/aaa -&gt; 1321ccc -&gt; 24å°±æ˜¯æŒ‰ç…§keyçš„é¡ºåºä¾æ¬¡æŽ’åˆ—ï¼Œç›¸åŒå‰ç¼€çš„keyä¼šè¢«æ”¾åœ¨ä¸€èµ·ï¼Œè¿™æ ·åˆ°å­˜å‚¨ç»“æž„ï¼Œå½“æŸ¥è¯¢æ—¶å¯ä»¥é€šè¿‡keyçš„å‰ç¼€å°†ä¸€ç³»åˆ—çš„valueéƒ½å–å‡ºæ¥ watchæœºåˆ¶å’Œleaseç§Ÿçº¦etcdæœ‰ä¸€ä¸ªå¾ˆæ£’çš„æœºåˆ¶è¦å•ç‹¬æä¸€å¥ï¼Œå°±æ˜¯watchï¼Œå®ƒå…è®¸ä½ åŽ»ç›‘æŽ§ä¸€ä¸ªkeyçš„å˜åŒ–ã€‚å½“ä½ ç›‘æŽ§äº†ä¹‹åŽï¼Œè¿™ä¸ªkeyçš„æ·»åŠ ä¿®æ”¹åˆ é™¤éƒ½ä¼šè¢«ç›‘æŽ§åˆ°ã€‚leaseç§Ÿçº¦ï¼Œè¿™ä¸ªæœºåˆ¶å’Œredisä¸­çš„keyè¿‡æœŸæœºåˆ¶ä¸€æ ·ï¼Œå¯ä»¥ç”³è¯·ä¸€ä¸ªç§Ÿçº¦ï¼Œè¿™ä¸ªç§Ÿçº¦æœ‰ä¸€ä¸ªæ—¶é—´é™åˆ¶ï¼Œæ¯”å¦‚60ç§’ï¼Œä½ å¯ä»¥å°†è¿™ä¸ªç§Ÿçº¦è®¾ç½®åˆ°ä¸€ä¸ªkeyä¸Šï¼Œé‚£ä¹ˆè¿™ä¸ªkeyè¿‡60ç§’å°±ä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚å½“ç„¶ä¹Ÿå¯ä»¥è¿›è¡Œç»­ç§Ÿã€‚ å…·ä½“ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥ä»ŽåŽé¢çš„å‘½ä»¤è¡Œæ“ä½œä¸­çœ‹åˆ°ã€‚ è¿˜æœ‰ä¸€äº›å°ç‚¹ etcdä½¿ç”¨grpcï¼Œæ‰€ä»¥ç½‘ç»œæ€§èƒ½ä¼šé«˜ éƒ¨ç½²èŠ‚ç‚¹æ•°é‡è¦æ±‚æ˜¯2N+1ä¸ª é€‰ä¸¾leaderéœ€è¦åŠæ•°ä»¥ä¸Šçš„èŠ‚ç‚¹å‚ä¸Ž etcdæ˜¯æ”¯æŒäº‹åŠ¡æ“ä½œçš„ï¼Œå¯ä»¥ifç¬¬ä¸€æ¬¡aæäº¤æ­£å¸¸ï¼Œthenæäº¤bï¼Œelseä¸æäº¤b æœ¬åœ°å•èŠ‚ç‚¹éƒ¨ç½²æˆ‘ä»¬ä¸€å¼€å§‹å­¦ä¹ å’Œæµ‹è¯•çš„æ—¶å€™åªéœ€è¦åœ¨æœ¬åœ°éƒ¨ç½²ä¸€ä¸ªå•èŠ‚ç‚¹å°±å¯ä»¥äº†ï¼Œå•èŠ‚ç‚¹çš„éƒ¨ç½²æ¯”è¾ƒæ–¹ä¾¿è¿™è¾¹ç®€å•è¯´æ˜Žä¸€ä¸‹ã€‚é¦–å…ˆä¸‹è½½å¯¹åº”çš„ç‰ˆæœ¬ï¼šhttps://github.com/etcd-io/etcd/releasesæˆ‘è¿™è¾¹ä½¿ç”¨çš„macå¯¹åº”çš„darwin-amd64çš„ç‰ˆæœ¬ï¼Œå…¶ä»–ç‰ˆæœ¬åº”è¯¥ç±»ä¼¼ã€‚ä¸‹è½½è§£åŽ‹ä¹‹åŽæœ‰ä¸¤ä¸ªæ–‡ä»¶æ¯”è¾ƒé‡è¦ï¼š etcd è¿™ä¸ªæ˜¯èŠ‚ç‚¹ etcdctl è¿™ä¸ªæ˜¯å®¢æˆ·ç«¯è¿›å…¥æ‰€åœ¨ç›®å½•ä½¿ç”¨å‘½ä»¤è¿›è¡Œå¯åŠ¨å’Œä½¿ç”¨ ä½¿ç”¨èŠ‚ç‚¹å‘½ä»¤1âžœ ./etcd ä½¿ç”¨å®¢æˆ·ç«¯å‘½ä»¤1234567âžœ ./etcdctlNAME: etcdctl - A simple command line client for etcd.WARNING: Environment variable ETCDCTL_API is not set; defaults to etcdctl v2. Set environment variable ETCDCTL_API=3 to use v3 API or ETCDCTL_API=2 to use v2 API. ä¹‹åŽä¼šå‡ºçŽ°ä¸Šè¿°ç±»ä¼¼è­¦å‘Šï¼Œå‘Šè¯‰ä½ ï¼Œé»˜è®¤ä½¿ç”¨çš„æ˜¯v2ç‰ˆæœ¬çš„APIï¼Œä½ éœ€è¦è®¾ç½®çŽ¯å¢ƒå˜é‡ETCDCTL_API=3å°±èƒ½ä½¿ç”¨v3ç‰ˆæœ¬çš„APIäº†ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨å‘½ä»¤export ETCDCTL_API=3 æˆ–è€…ä½ å¯ä»¥æ‰‹åŠ¨ä¿®æ”¹çŽ¯å¢ƒå˜é‡æ·»åŠ export ETCDCTL_API=3å°±å¯ä»¥äº†ï¼Œå½“ä¸å‡ºçŽ°è­¦å‘Šçš„æ—¶å€™è¯æ˜ŽçŽ¯å¢ƒå˜é‡è®¾ç½®æ­£ç¡®ã€‚ ç®€å•å‘½ä»¤è¡Œæ“ä½œä¸‹é¢ä»‹ç»å‡ ä¸ªæœ€åŸºæœ¬çš„etcdçš„æ“ä½œï¼Œå…¶å®žéžå¸¸ç®€å•ã€‚ä¸»è¦ä¸Žredisä¸åŒçš„æ˜¯æ‹¥æœ‰ç‹¬ç‰¹çš„watchæœºåˆ¶ï¼Œè¿™ä¸ªæœºåˆ¶éžå¸¸æ£’ã€‚ put1234âžœ ./etcdctl put /aaa/a 1OKâžœ ./etcdctl put /aaa/b 2OK get12345678âžœ ./etcdctl get /aaa/a/aaa/a1âžœ ./etcdctl get --prefix /aaa/aaa/a1/aaa/b2 â€“prefixæ„æ€æ˜¯å–å‡ºæ‰€æœ‰å‰ç¼€ä¸º/aaaçš„key watchæ–°å¼€ä¸€ä¸ªçª—å£ä½¿ç”¨å‘½ä»¤watchè¿›è¡Œç›‘å¬1âžœ ./etcdctl watch /aaa/a ç„¶åŽå¯¹/aaa/aè¿™ä¸ªkeyçš„æ“ä½œå…¨éƒ¨éƒ½ä¼šè¢«ç›‘å¬åˆ°1234âžœ ./etcdctl put /aaa/a 123OKâžœ ./etcdctl del /aaa/a1 123456âžœ ./etcdctl watch /aaa/aPUT/aaa/a123DELETE/aaa/a leaseåˆ›å»ºä¸€ä¸ª60sçš„ç§Ÿçº¦12âžœ ./etcdctl lease grant 60lease 694d6b2b7d7e6a0c granted with TTL(60s) 12âžœ ./etcdctl put /aaa/a 123 --lease=694d6b2b7d7e6a0cOK putçš„æ—¶å€™ä½¿ç”¨ç§Ÿçº¦æ³¨æ„ï¼Œè¿™é‡Œéœ€è¦è¾“å…¥ä¸Šé¢ç§Ÿçº¦çš„16è¿›åˆ¶æ ‡è¯†ç¬¦ç„¶åŽç›‘å¬çš„åœ°æ–¹ä¼šå‘çŽ°ï¼Œ60ç§’åŽï¼Œ/aaa/aè¿™ä¸ªkeyè¢«è‡ªåŠ¨åˆ é™¤äº† å½“ç„¶ä½ å¯ä»¥ä½¿ç”¨keep-aliveè¿›è¡Œç»­ç§Ÿï¼Œå¦‚ï¼š1âžœ ./etcdctl lease keep-alive 694d6b2ac4a35625 æ€»ç»“ä»¥ä¸Šç®€å•è¯´æ˜Žäº†etcdçš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼Œå•èŠ‚ç‚¹éƒ¨ç½²ï¼Œä»¥åŠä¸€äº›åŸºæœ¬ç”¨æ³•ï¼Œä»Žä¸Šè¿°ä¿¡æ¯æˆ‘ä»¬æ€»ç»“å¯çŸ¥ï¼š etcdæ˜¯åˆ†å¸ƒå¼çš„ï¼Œèƒ½ä¿è¯åœ¨å•ç‚¹æ•…éšœä¸‹ä¹Ÿèƒ½æ­£å¸¸ä½¿ç”¨ åˆ†å¸ƒå¼ä¹Ÿä¼šå¯¼è‡´é—®é¢˜ï¼Œetcdå†™å…¥æ€§èƒ½ç›¸è¾ƒredisè‚¯å®šæœ‰æ‰€ä¸åŠ etcdç‹¬ç‰¹çš„watchæœºåˆ¶å¯ä»¥ç”¨äºŽå¾ˆå¤šåœºæ™¯ï¼Œå¦‚é…ç½®æ›´æ–°åˆ†å‘ç­‰ é‚£è¿™é‡Œå°±è¯´è¿™ä¹ˆå¤šï¼Œçœ‹å®Œä½ å°±åº”è¯¥å¤§è‡´çŸ¥é“etcdæ˜¯ä¸ªå•¥çŽ©æ„äº†ï¼Œä»ŽçŽ°åœ¨çœ‹æ¥ä½ å¯èƒ½è¿˜æ²¡æœ‰æ„Ÿè§‰å®ƒæœ‰ä»€ä¹ˆåŽ‰å®³çš„åœ°æ–¹ï¼ŒåŽé¢æˆ‘ä»¬ç»“åˆå®žé™…çš„åœºæ™¯ä½¿ç”¨å°±èƒ½æ›´åŠ æ˜Žç™½äº†ã€‚]]></content>
      <categories>
        <category>etcd</category>
      </categories>
      <tags>
        <tag>etcd</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[GolangæŒ‡é’ˆä¸Žunsafe]]></title>
    <url>%2F2019%2F06%2F06%2Fgolang%2Fsource-code%2Fpoint-unsafe%2F</url>
    <content type="text"><![CDATA[æˆ‘ä»¬çŸ¥é“åœ¨golangä¸­æ˜¯å­˜åœ¨æŒ‡é’ˆè¿™ä¸ªæ¦‚å¿µçš„ã€‚å¯¹äºŽæŒ‡é’ˆå¾ˆå¤šäººæœ‰ç‚¹å¿Œæƒ®ï¼ˆå¯èƒ½æ˜¯å› ä¸ºä¹‹å‰å­¦ä¹ è¿‡Cè¯­è¨€ï¼‰ï¼Œå› ä¸ºå®ƒä¼šå¯¼è‡´å¾ˆå¤šå¼‚å¸¸çš„é—®é¢˜ã€‚ä½†æ˜¯å¾ˆå¤šäººå­¦ä¹ ä¹‹åŽå‘çŽ°ï¼Œgolangä¸­çš„æŒ‡é’ˆå¾ˆç®€å•ï¼Œæ²¡æœ‰Cé‚£ä¹ˆå¤æ‚ã€‚æ‰€ä»¥ä»Šå¤©å°±è¯¦ç»†æ¥è¯´è¯´æŒ‡é’ˆã€‚ æŒ‡é’ˆçš„ä½¿ç”¨123a := 1p := &amp;afmt.Println(p) è¾“å‡ºï¼š0xc42001c070 å¯ä»¥çœ‹åˆ°på°±æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯açš„åœ°å€ã€‚ 1234a := 1var p *intp = &amp;afmt.Println(p) æˆ–è€…ä¹Ÿå¯ä»¥å†™æˆè¿™æ ·ï¼Œå› ä¸ºæˆ‘çŸ¥é“ï¼Œåœ¨å¾ˆå¤šäººçœ‹æ¥ï¼Œçœ‹åˆ°*å·æ‰æ˜¯æŒ‡é’ˆï¼ˆæ‰‹åŠ¨æ»‘ç¨½ï¼‰ 123a := 1p := &amp;afmt.Println(*p) è¾“å‡ºï¼š1 ç„¶åŽä½¿ç”¨å°±ç›´æŽ¥é€šè¿‡*å·å°±èƒ½åŽ»åˆ°å¯¹åº”çš„å€¼äº†ï¼Œå°±è¿™ä¹ˆç®€å• æŒ‡é’ˆçš„é™åˆ¶Golangä¸­æŒ‡é’ˆä¹‹æ‰€ä»¥çœ‹èµ·æ¥å¾ˆç®€å•ï¼Œæ˜¯å› ä¸ºæŒ‡é’ˆçš„åŠŸèƒ½ä¸å¤šã€‚æˆ‘ä»¬èƒ½çœ‹åˆ°çš„åŠŸèƒ½å°±æ˜¯æŒ‡é’ˆçš„æŒ‡å‘ä¸€ä¸ªåœ°å€è€Œå·²ï¼Œç„¶åŽå¯¹äºŽè¿™ä¸ªåœ°å€ä¹Ÿåªèƒ½è¿›è¡Œä¼ é€’ï¼Œæˆ–è€…é€šè¿‡è¿™ä¸ªçš„åœ°å€åŽ»è®¿é—®å€¼ã€‚ ä¸èƒ½åƒCè¯­è¨€ä¸­ä¸€æ ·p++ï¼Œè¿™æ ·ç§»åŠ¨æ“ä½œæŒ‡é’ˆï¼Œå› ä¸ºå…¶å®žè¿™æ ·æ“ä½œç¡®å®žä¸å®‰å…¨ï¼Œå¾ˆå®¹æ˜“è®¿é—®åˆ°å¥‡æ€ªçš„åŒºåŸŸã€‚ ä¸åŒç±»åž‹çš„æŒ‡é’ˆä¸èƒ½ç›¸äº’èµ‹å€¼ã€è½¬æ¢ã€æ¯”è¾ƒã€‚ä¼šå‡ºçŽ°cannot use &amp;a (type int) as type float32 in assignmentç±»ä¼¼è¿™æ ·çš„é”™è¯¯ å¦‚æžœåªæ˜¯å•çº¯è¯´goä¸­æŒ‡é’ˆçš„åŠŸèƒ½ï¼Œä¸Šé¢å°±å·²ç»è¯´å®Œäº†ï¼Œæ²¡å¿…è¦å†™åšå®¢ï¼Œä½†æ˜¯å…¶å®žgoä¸­è¿˜æœ‰ä¸€ä¸ªåŒ…å«unsafeï¼Œæœ‰äº†å®ƒï¼ŒæŒ‡é’ˆå°±å¯ä»¥åƒCä¸€æ ·æƒ³å¹²å˜›å¹²å˜›äº†ã€‚ unsafeä¸‰ä¸ªç±»åž‹å…¶å®žæŒ‡é’ˆæœ‰ä¸‰ç§ï¼šä¸€ç§æ˜¯æˆ‘ä»¬å¸¸è§çš„*ï¼Œç”¨*åŽ»è¡¨ç¤ºçš„æŒ‡é’ˆï¼›ä¸€ç§æ˜¯unsafe.Pointerï¼ŒPointeræ˜¯unsafeåŒ…ä¸‹çš„ä¸€ä¸ªç±»åž‹ï¼›æœ€åŽä¸€ç§æ˜¯uintptrï¼Œuintptrå°±åŽ‰å®³äº†ï¼Œè¿™çŽ©æ„æ˜¯å¯ä»¥è¿›è¡Œè¿ç®—çš„ä¹Ÿå°±æ˜¯å¯ä»¥++â€“ï¼› ä»–ä»¬ä¹‹é—´æœ‰è¿™æ ·çš„è½¬æ¢å…³ç³»ï¼š* &lt;=&gt; unsafe.Pointer &lt;=&gt; uintptr æœ‰ä¸€ç‚¹è¦æ³¨æ„çš„æ˜¯ï¼Œuintptr å¹¶æ²¡æœ‰æŒ‡é’ˆçš„è¯­ä¹‰ï¼Œæ„æ€å°±æ˜¯ uintptr æ‰€æŒ‡å‘çš„å¯¹è±¡ä¼šè¢« gc æ— æƒ…åœ°å›žæ”¶ã€‚è€Œ unsafe.Pointer æœ‰æŒ‡é’ˆè¯­ä¹‰ï¼Œå¯ä»¥ä¿æŠ¤å®ƒæ‰€æŒ‡å‘çš„å¯¹è±¡åœ¨â€œæœ‰ç”¨â€çš„æ—¶å€™ä¸ä¼šè¢«åžƒåœ¾å›žæ”¶ã€‚ ä»Žè¿™æ ·çš„å…³ç³»ä½ å¤§æ¦‚å°±å¯ä»¥çŒœåˆ°ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æŒ‡é’ˆ*pè½¬æ¢æˆPointerç„¶åŽè½¬æ¢uintptrè¿›è¡Œè¿ç®—ä¹‹åŽå†åŽŸè·¯è¿”å›žï¼Œç†è®ºä¸Šå°±èƒ½ç­‰åŒäºŽè¿›è¡Œäº†æŒ‡é’ˆçš„è¿ç®—ã€‚æˆ‘ä»¬ä¸‹é¢å°±æ¥å®žè·µä¸€ä¸‹ã€‚ unsafeæ“ä½œslice12345678910111213func main() &#123; s := make([]int, 10) s[1] = 2 p := &amp;s[0] fmt.Println(*p) up := uintptr(unsafe.Pointer(p)) up += unsafe.Sizeof(int(0)) // è¿™é‡Œå¯ä¸æ˜¯up++å“¦ p2 := (*int)(unsafe.Pointer(up)) fmt.Println(*p2)&#125; è¾“å‡ºï¼š02 ä»Žä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬é¦–å…ˆå°†æŒ‡é’ˆæŒ‡å‘åˆ‡ç‰‡çš„ç¬¬ä¸€ä¸ªä½ç½®ï¼Œç„¶åŽé€šè¿‡è½¬æ¢å¾—åˆ°uintptrï¼Œæ“ä½œuintptr + ä¸Š8ä½ï¼ˆæ³¨æ„è¿™é‡Œä¸èƒ½++å› ä¸ºå­˜æ”¾çš„æ˜¯intï¼Œä¸‹ä¸€ä¸ªå…ƒç´ ä½ç½®ç›¸éš”ä¸¾ä¾‹intä¸ªå­—èŠ‚ï¼‰ï¼Œæœ€åŽè½¬æ¢å›žæ¥å¾—åˆ°æŒ‡é’ˆï¼Œå–å€¼ï¼Œå°±èƒ½å–åˆ°åˆ‡ç‰‡çš„ç¬¬äºŒä¸ªä½ç½®äº†ã€‚ unsafeæ“ä½œstructå½“ç„¶æœ‰äººè‚¯å®šè¦è¯´äº†ï¼Œä¸Šé¢é‚£ä¸ªä¸€é¡¿æ“ä½œçŒ›å¦‚è™Žï¼Œä¸å°±æ˜¯è®¿é—®ä¸‹ä¸€ä¸ªä½ç½®å˜›ï¼Œæˆ‘ç›´æŽ¥è®¿é—®å°±è¡Œäº†ã€‚é‚£ä¸‹é¢å°±æ˜¯åŽ‰å®³çš„æ¥äº†ï¼Œæˆ‘ä»¬çŸ¥é“å¦‚æžœä¸€ä¸ªç»“æž„ä½“é‡Œé¢å®šä¹‰çš„å±žæ€§æ˜¯ç§æœ‰çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªå±žæ€§æ˜¯ä¸èƒ½è¢«å¤–ç•Œè®¿é—®åˆ°çš„ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ä¸‹é¢è¿™ä¸ªæ“ä½œï¼š 123456package basictype User struct &#123; age int name string&#125; 12345678910111213141516package mainfunc main() &#123; user := &amp;basic.User&#123;&#125; fmt.Println(user) s := (*int)(unsafe.Pointer(user)) *s = 10 up := uintptr(unsafe.Pointer(user)) + unsafe.Sizeof(int(0)) namep := (*string)(unsafe.Pointer(up)) *namep = "xxx" fmt.Println(user)&#125; Useræ˜¯å¦å¤–ä¸€ä¸ªbasicåŒ…ä¸­çš„ç»“æž„ä½“ï¼Œå…¶ä¸­çš„ageæ˜¯å°å†™å¼€å¤´çš„ï¼Œç†è®ºä¸Šæ¥è¯´ï¼Œæˆ‘ä»¬åœ¨å¤–éƒ¨æ²¡æœ‰åŠžæ³•ä¿®æ”¹ageçš„å€¼ï¼Œä½†æ˜¯ç»è¿‡ä¸Šé¢è¿™æ³¢æ“ä½œä¹‹åŽï¼Œè¾“å‡ºä¿¡æ¯æ˜¯ï¼š&amp;{0 }&amp;{10 xxx}ä¹Ÿå°±æ˜¯è¯´æˆåŠŸæ“ä½œåˆ°äº†ç»“æž„ä½“çš„ç§æœ‰å±žæ€§ã€‚ é¡ºä¾¿æä¸€å¥ï¼šåˆ›å»ºç»“æž„ä½“ä¼šè¢«åˆ†é…ä¸€å—è¿žç»­çš„å†…å­˜ï¼Œç»“æž„ä½“çš„åœ°å€ä¹Ÿä»£è¡¨äº†ç¬¬ä¸€ä¸ªæˆå‘˜çš„åœ°å€ã€‚ ä¸‹é¢æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹ä½ æ˜¯å¦å·²ç»å­¦ä¼šäº†unsafeçš„æ“ä½œï¼Œå°è¯•ä¸çœ‹ä¸€ä¸ªå°ç»“ï¼Œè‡ªå·±å°è¯•ä¸€ä¸‹ï¼šå¦‚ä½•å®Œæˆå­—ç¬¦ä¸²åˆ°[]byteçš„è½¬æ¢ï¼Œå¹¶ä¸”ä¸å¼€è¾Ÿæ–°çš„ç©ºé—´ï¼Ÿ å­—ç¬¦ä¸²å’Œbyteæ•°ç»„è½¬æ¢inplaceæˆ‘ä»¬çŸ¥é“å¦‚æžœå°†å­—ç¬¦ä¸²è½¬æ¢æˆ[]byteéžå¸¸æ–¹ä¾¿12s := "123"a := []byte(s) ä½†æ˜¯è¿™æ ·éœ€è¦å¼€è¾Ÿé¢å¤–çš„ç©ºé—´ï¼Œé‚£ä¹ˆå¦‚ä½•å®žçŽ°åŽŸåœ°çš„ï¼Œä¸éœ€è¦æ‹·è´æ•°æ®çš„è½¬æ¢å‘¢ï¼Ÿæˆ‘ä»¬æƒ³ä¸€ä¸‹ï¼Œå…¶å®žä»Žåº•å±‚çš„å­˜å‚¨è§’åº¦æ¥è¯´ï¼Œstringçš„å­˜å‚¨è§„åˆ™å’Œ[]byteæ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå…¶å®žæŒ‡é’ˆéƒ½æ˜¯ä»ŽæŸä¸ªä½ç½®å¼€å§‹åˆ°ä¸€æ®µç©ºé—´ï¼Œä¸­é—´ä¸€æ ¼ä¸€æ ¼ã€‚æ‰€ä»¥åˆ©ç”¨unsafeå°±å¯ä»¥åšåˆ°ã€‚ 123456789101112func main() &#123; s := "123" a := []byte(s) print("s = " , &amp;s, "\n") print("a = " , &amp;a, "\n") a2 := (*[]byte)(unsafe.Pointer(&amp;s)) print("a2 = " , a2, "\n") fmt.Println(*a2)&#125; è¾“å‡ºç»“æžœï¼šs = 0xc420055f40a = 0xc420055f60a2 = 0xc420055f40[49 50 51] æˆ‘ä»¬å¯ä»¥çœ‹åˆ°så’Œaçš„åœ°å€æ˜¯ä¸ä¸€æ ·çš„ï¼Œä½†æ˜¯så’Œa2çš„åœ°å€æ˜¯ä¸€æ ·çš„ï¼Œå¹¶ä¸”a2å·²ç»æ˜¯ä¸€ä¸ª[]byteäº†ã€‚å˜¿å˜¿å˜¿~ä½ ä»¥ä¸ºè¿™æ ·å°±ç»“æŸäº†ï¼Ÿï¼Ÿï¼Ÿ å­˜åœ¨çš„é—®é¢˜å…¶å®žè¿™ä¸ªè½¬æ¢æ˜¯å­˜åœ¨é—®é¢˜çš„ï¼Œé—®é¢˜å°±åœ¨æ–°çš„[]byteçš„Capæ²¡æœ‰æ­£ç¡®çš„åˆå§‹åŒ–ã€‚æˆ‘ä»¬æ‰“å°ä¸€ä¸‹capçœ‹ä¸€ä¸‹fmt.Println(â€œcap a =â€, cap(a))fmt.Println(â€œcap a2 =â€, cap(*a2))ç»“æžœæ˜¯ï¼šcap a = 32cap a2 = 17418400è¿™ä¹ˆå¤§çš„å®¹é‡æ˜¯è¦ä¸Šå¤©å‘¢ï¼Ÿï¼Ÿï¼Ÿ é—®é¢˜çš„åŽŸå› åœ¨src/reflect/value.goä¸‹çœ‹12345678910type StringHeader struct &#123; Data uintptr Len int&#125;type SliceHeader struct &#123; Data uintptr Len int Cap int&#125; çœ‹åˆ°å…¶å®žstringæ²¡æœ‰capè€Œ[]byteæœ‰ï¼Œæ‰€ä»¥å¯¼è‡´é—®é¢˜å‡ºçŽ°ï¼Œä¹Ÿå®¹æ˜“ç†è§£ï¼Œstringæ˜¯æ²¡æœ‰å®¹é‡æ‰©å®¹è¿™ä¸ªè¯´æ³•çš„ï¼Œæ‰€ä»¥æ–°çš„[]byteæ²¡æœ‰èµ‹å€¼capæ‰€ä»¥ä½¿ç”¨äº†é»˜è®¤å€¼ã€‚ é—®é¢˜è§£å†³123456789stringHeader := (*reflect.StringHeader)(unsafe.Pointer(&amp;s))bh := reflect.SliceHeader&#123; Data: stringHeader.Data, Len: stringHeader.Len, Cap: stringHeader.Len,&#125;return *(*[]byte)(unsafe.Pointer(&amp;bh)) é€šè¿‡é‡æ–°è®¾ç½®SliceHeaderå°±å¯ä»¥å®Œæˆ æ€»ç»“ä»¥ä¸Šå°±æ˜¯æ‰€æœ‰golangæŒ‡é’ˆå’Œunsafeçš„ç›¸å…³ç»†èŠ‚å’Œä½¿ç”¨ã€‚é‚£ä¹ˆè‚¯å®šæœ‰äººä¼šé—®è¿™ä¸ªæœ‰ä»€ä¹ˆç”¨äº†ï¼Ÿ 1ã€æ²¡å•¥äº‹ä½ å°±åˆ«ä¹±ç”¨äº†ï¼Œåˆ«äººéƒ½è¯´unsafeä¸å®‰å…¨äº†ã€‚ 2ã€æºç ä¸­å¾ˆå¤šå¤§é‡çš„ä½¿ç”¨äº†æŒ‡é’ˆç§»åŠ¨çš„æ“ä½œã€‚ å¦‚mapä¸­é€šè¿‡keyèŽ·å–valueçš„æ—¶å€™ï¼š v := add(unsafe.Pointer(b), dataOffset+bucketCnt uintptr(t.keysize)+i uintptr(t.valuesize)) é€šè¿‡æ¡¶çš„æŒ‡é’ˆçš„åç§»æ‹¿åˆ°å€¼ï¼Œå…·ä½“æˆ‘å°±ä¸å¤šä»‹ç»äº†ã€‚æ€»ä¹‹å¯¹äºŽä½ çœ‹golangæºç çš„æ—¶å€™ä¼šæœ‰å¾ˆå¤§å¸®åŠ©çš„ã€‚å¯èƒ½å¿…è¦çš„æ—¶å€™ä½ ä¹Ÿèƒ½ç”¨åˆ°å®ƒï¼Œè¿˜æ˜¯é‚£å¥è¯ï¼Œé™¤éžä½ çŸ¥é“å®ƒåœ¨å¹²ä»€ä¹ˆï¼Œå¦åˆ™ä¸è¦ç”¨ã€‚]]></content>
      <categories>
        <category>golangæºç è§£æž</category>
      </categories>
      <tags>
        <tag>unsafe</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å¤§è¯å›¾è§£golang mapæºç è¯¦è§£]]></title>
    <url>%2F2019%2F06%2F03%2Fgolang%2Fsource-code%2Fgraphic-golang-map%2F</url>
    <content type="text"><![CDATA[ç½‘ä¸Šåˆ†æžgolangä¸­mapçš„æºç çš„åšå®¢å·²ç»éžå¸¸å¤šäº†ï¼Œéšä¾¿ä¸€æœå°±æœ‰ï¼Œè€Œä¸”ä¹Ÿéžå¸¸è¯¦ç»†ï¼Œæ‰€ä»¥å¦‚æžœæˆ‘å†æ¥å†™å°±æœ‰ç‚¹ç”»è›‡æ·»è¶³äº†ï¼ˆè€Œä¸”æˆ‘ä¹Ÿå†™ä¸å¥½ï¼Œæ‰‹åŠ¨æ»‘ç¨½ï¼‰ã€‚ä½†æ˜¯æˆ‘è¿˜æ˜¯è¦å†™ï¼Œç•¥ç•¥ç•¥ï¼Œè¿™ç¯‡åšå®¢çš„æ„ä¹‰åœ¨äºŽèƒ½ä»Žå‡ å¼ å›¾ç‰‡ï¼Œç„¶åŽç”¨æˆ‘æœ€é€šä¿—çš„æ–‡å­—ï¼Œè®©æ²¡çœ‹è¿‡æºç çš„äººæœ€å¿«ç¨‹åº¦ä¸Šäº†è§£golangä¸­mapæ˜¯æ€Žä¹ˆæ ·çš„ã€‚ å½“ç„¶ï¼Œå› ä¸ºç®€å•ï¼Œæ‰€ä»¥ä¸å®Œç¾Žã€‚æœ‰å¾ˆå¤šåœ°æ–¹çœç•¥äº†ç»†èŠ‚é—®é¢˜ï¼Œå¦‚æžœä½ è§‰å¾—æ²¡çœ‹å¤Ÿï¼Œæˆ–è€…æœ¬æ¥å°±æƒ³äº†è§£è¯¦ç»†æƒ…å†µçš„è¯åœ¨æ–‡æœ«ç»™å‡ºäº†ä¸€äº›éžå¸¸ä¸é”™çš„åšå®¢ï¼Œå½“ç„¶æœ‰èƒ½åŠ›è¿˜æ˜¯è‡ªå·±åŽ»é˜…è¯»æºç æ¯”è¾ƒé è°±ã€‚ é‚£ä¹ˆä¸‹é¢æˆ‘å°†ä»Žè¿™å‡ ä¸ªæ–¹é¢æ¥è¯´æ˜Žï¼Œä½ å…ˆè®°ä½æœ‰ä¸‹é¢å‡ ä¸ªæ–¹å‘ï¼Œè¿™æ ·å¯ä»¥æœ‰ä¸€ä¸ªå¤§è‡´çš„æ€è·¯ï¼š åŸºç¡€ç»“æž„ï¼šgolangä¸­çš„mapæ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œæ˜¯ç”±ä»€ä¹ˆæ•°æ®ç»“æž„ç»„æˆçš„ï¼Ÿ åˆå§‹åŒ–ï¼šåˆå§‹åŒ–ä¹‹åŽmapæ˜¯æ€Žä¹ˆæ ·çš„ï¼Ÿ getï¼šå¦‚ä½•èŽ·å–ä¸€ä¸ªå…ƒç´ ï¼Ÿ putï¼šå¦‚ä½•å­˜æ”¾ä¸€ä¸ªå…ƒç´ ï¼Ÿ æ‰©å®¹ï¼šå½“å­˜æ”¾ç©ºé—´ä¸å¤Ÿçš„æ—¶å€™æ‰©å®¹æ˜¯æ€Žä¹ˆæ‰©çš„ï¼Ÿ åŸºç¡€ç»“æž„å›¾è§£è¿™ä¸ªå°±æ˜¯golangä¸­mapçš„ç»“æž„ï¼Œå…¶å®žçœŸçš„ä¸å¤æ‚ï¼Œæˆ‘çœç•¥äº†å…¶ä¸­ä¸€äº›å’Œç»“æž„å…³ç³»ä¸å¤§çš„å­—æ®µï¼Œå°±åªå‰©ä¸‹è¿™äº›äº†ã€‚ å¤§è¯å¤§è¯æ¥æè¿°ä¸€äº›è¦ç‚¹ï¼š æœ€å¤–é¢æ˜¯hmapç»“æž„ä½“ï¼Œç”¨bucketså­˜æ”¾ä¸€äº›åå­—å«bmapçš„æ¡¶ï¼ˆæ•°é‡ä¸å®šï¼Œæ˜¯2çš„æŒ‡æ•°å€ï¼‰ bmapæ˜¯ä¸€ç§æœ‰8ä¸ªæ ¼å­çš„æ¡¶ï¼ˆä¸€å®šåªæœ‰8ä¸ªæ ¼å­ï¼‰ï¼Œæ¯ä¸ªæ ¼å­å­˜æ”¾ä¸€å¯¹key-value bmapæœ‰ä¸€ä¸ªoverflowï¼Œç”¨äºŽè¿žæŽ¥ä¸‹ä¸€ä¸ªbmapï¼ˆæº¢å‡ºæ¡¶ï¼‰ hmapè¿˜æœ‰oldbucketsï¼Œç”¨äºŽå­˜æ”¾è€æ•°æ®ï¼ˆç”¨äºŽæ‰©å®¹æ—¶ï¼‰ mapextraç”¨äºŽå­˜æ”¾éžæŒ‡é’ˆæ•°æ®ï¼ˆç”¨äºŽä¼˜åŒ–å­˜å‚¨å’Œè®¿é—®ï¼‰ï¼Œå†…éƒ¨çš„overflowå’Œoldoverflowå®žé™…è¿˜æ˜¯bmapçš„æ•°ç»„ã€‚ è¿™å°±æ˜¯mapçš„ç»“æž„ï¼Œç„¶åŽæˆ‘ä»¬ç¨å¾®å¯¹æ¯”æ€»ç»“ä¸€ä¸‹ã€‚ æˆ‘ä»¬å¸¸è§çš„mapå¦‚javaä¸­çš„mapæ˜¯ç›´æŽ¥æ‹¿æ•°ç»„ï¼Œæ•°ç»„ä¸­ç›´æŽ¥å¯¹åº”å‡ºäº†key-valueï¼Œè€Œåœ¨golangä¸­ï¼Œåšäº†å¤šåŠ ä¸­é—´ä¸€å±‚ï¼Œbucketsï¼›javaä¸­å¦‚æžœkeyçš„å“ˆå¸Œç›¸åŒä¼šé‡‡ç”¨é“¾è¡¨çš„æ–¹å¼è¿žæŽ¥ä¸‹åŽ»ï¼Œå½“è¾¾åˆ°ä¸€å®šç¨‹åº¦ä¼šè½¬æ¢çº¢é»‘æ ‘ï¼Œgolangä¸­ç›´æŽ¥ç±»ä¼¼é“¾è¡¨è¿žæŽ¥ä¸‹åŽ»ï¼Œåªä¸è¿‡è¿žæŽ¥ä¸‹åŽ»çš„æ˜¯bucketsã€‚ æºç ä¸€çž¥ ä¸‹é¢é™„ä¸Šæºç ä¸­å®ƒä»¬çš„æ ·å­ï¼Œæ–¹ä¾¿ä¹‹åŽä½ è‡ªå·±é˜…è¯»çš„æ—¶å€™æœ‰ä¸ªå°è±¡ï¼ˆæ³¨æ„æºç ä¸­çš„æ ·å­å’Œç¼–è¯‘ä¹‹åŽæ˜¯ä¸åŒçš„å“Ÿï¼Œgolangä¼šæ ¹æ®mapå­˜æ”¾çš„ç±»åž‹ä¸åŒæ¥æžå®šå®ƒä»¬å®žé™…çš„æ ·å­ï¼‰ é‚£ä¹ˆçœ‹å®Œç»“æž„ä½ è‚¯å®šä¼šæœ‰ç–‘é—®ï¼Ÿä¸ºä»€ä¹ˆè¦å¤šä¸€å±‚8ä¸ªæ ¼å­çš„bucketå‘¢ï¼Ÿæˆ‘ä»¬æ€Žä¹ˆç¡®å®šæ”¾åœ¨8ä¸ªæ ¼å­å…¶ä¸­çš„å“ªä¸ªå‘¢ï¼Ÿå¸¦ç€é—®é¢˜å¾€ä¸‹çœ‹ã€‚ åˆå§‹åŒ–æºç ä¸€çž¥åˆå§‹åŒ–å°±ä¸éœ€è¦å›¾åŽ»è¯´æ˜Žäº†ï¼Œå› ä¸ºåˆå§‹åŒ–ä¹‹åŽå°±æ˜¯äº§ç”ŸåŸºç¡€çš„ä¸€ä¸ªç»“æž„ï¼Œæ ¹æ®mapä¸­å­˜æ”¾çš„ç±»åž‹ä¸åŒã€‚è¿™é‡Œä¸»è¦è¯´æ˜Žä¸€ä¸‹ï¼Œåˆå§‹åŒ–çš„ä»£ç æ”¾åœ¨ä»€ä¹ˆä½ç½®ã€‚æˆ‘ä¹Ÿåˆ é™¤äº†å…¶ä¸­ä¸€äº›ä»£ç ï¼Œå¤§è‡´çœ‹çœ‹å°±å¥½ã€‚ 123456789101112131415161718192021222324252627282930313233// makehmap_small implements Go map creation for make(map[k]v) and// make(map[k]v, hint) when hint is known to be at most bucketCnt// at compile time and the map needs to be allocated on the heap.func makemap_small() *hmap &#123; h := new(hmap) h.hash0 = fastrand() return h&#125;// makemap implements Go map creation for make(map[k]v, hint).// If the compiler has determined that the map or the first bucket// can be created on the stack, h and/or bucket may be non-nil.// If h != nil, the map can be created directly in h.// If h.buckets != nil, bucket pointed to can be used as the first bucket.func makemap(t *maptype, hint int, h *hmap) *hmap &#123; ..... // initialize Hmap if h == nil &#123; h = (*hmap)(newobject(t.hmap)) &#125; h.hash0 = fastrand() // find size parameter which will hold the requested # of elements B := uint8(0) for overLoadFactor(hint, B) &#123; B++ &#125; h.B = B ...... return h&#125; å…¶ä¸­éœ€è¦æ³¨æ„ä¸€ä¸ªç‚¹ï¼šâ€œBâ€ï¼Œè¿˜è®°å¾—åˆšæ‰è¯´åå­—å«bmapçš„æ¡¶æ•°é‡æ˜¯ä¸ç¡®å®šçš„å—ï¼Ÿè¿™ä¸ªBä¸€å®šç¨‹åº¦ä¸Šè¡¨ç¤ºçš„å°±æ˜¯æ¡¶çš„æ•°é‡ï¼Œå½“ç„¶ä¸æ˜¯è¯´Bæ˜¯3æ¡¶çš„æ•°é‡å°±æ˜¯3ï¼Œè€Œæ˜¯2çš„3æ¬¡æ–¹ï¼Œä¹Ÿå°±æ˜¯8ï¼›å½“Bä¸º5ï¼Œæ¡¶çš„æ•°é‡å°±æ˜¯32ï¼›è®°ä½è¿™ä¸ªBï¼ŒåŽé¢ä¼šç”¨åˆ°å®ƒã€‚ å…¶å®žä½ æƒ³å˜›ï¼Œåˆå§‹åŒ–è¿˜èƒ½å¹²ä»€ä¹ˆï¼Œæœ€é‡è¦çš„è‚¯å®šå°±æ˜¯ç¡®å®šä¸€å¼€å§‹è¦æœ‰å¤šå°‘ä¸ªæ¡¶ï¼Œåˆå§‹çš„å¤§å°è¿˜æ˜¯å¾ˆé‡è¦çš„ï¼Œè¿˜æœ‰ä¸€äº›åˆ«çš„åˆå§‹åŒ–å“ˆå¸Œç§å­ç­‰ç­‰ï¼Œé—®é¢˜ä¸å¤§ã€‚æˆ‘ä»¬çš„é‡ç‚¹è¿˜æ˜¯è¦æ”¾åœ¨å­˜/å–ä¸Šé¢ã€‚ GETå›¾è§£å…¶å®žä»Žç»“æž„ä¸Šé¢æ¥çœ‹ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥æ‘¸åˆ°ä¸€äº›é—¨é“äº†ã€‚å…ˆè‡ªå·±æƒ³ä¸€ä¸‹ï¼Œè¦ä»Žä¸€ä¸ªhashmapä¸­èŽ·å–ä¸€ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆä¸€å®šæ˜¯é€šè¿‡keyçš„å“ˆå¸Œå€¼åŽ»å®šä½åˆ°è¿™ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆæƒ³ç€è¿™ä¸ªå¤§è‡´æ–¹å‘ï¼Œçœ‹ä¸‹é¢ä¸€å¼ æµç¨‹å›¾æ¥è¯¦ç»†ç†è§£golangä¸­æ˜¯å¦‚ä½•å®žçŽ°çš„ã€‚ å¤§è¯ä¸‹é¢è¯´æ˜Žè¦ç‚¹ï¼š è®¡ç®—å‡ºkeyçš„hash ç”¨æœ€åŽçš„â€œBâ€ä½æ¥ç¡®å®šåœ¨å“ªä¸ªæ¡¶ï¼ˆâ€œBâ€å°±æ˜¯å‰é¢è¯´çš„é‚£ä¸ªï¼ŒBä¸º4ï¼Œå°±æœ‰16ä¸ªæ¡¶ï¼Œ0101ç”¨åè¿›åˆ¶è¡¨ç¤ºä¸º5ï¼Œæ‰€ä»¥åœ¨5å·æ¡¶ï¼‰ æ ¹æ®keyçš„å‰8ä½å¿«é€Ÿç¡®å®šæ˜¯åœ¨å“ªä¸ªæ ¼å­ï¼ˆé¢å¤–è¯´æ˜Žä¸€ä¸‹ï¼Œåœ¨bmapä¸­å­˜æ”¾äº†æ¯ä¸ªkeyå¯¹åº”çš„tophashï¼Œæ˜¯keyçš„å‰8ä½ï¼‰ æœ€ç»ˆè¿˜æ˜¯éœ€è¦æ¯”å¯¹keyå®Œæ•´çš„hashæ˜¯å¦åŒ¹é…ï¼Œå¦‚æžœåŒ¹é…åˆ™èŽ·å–å¯¹åº”value å¦‚æžœéƒ½æ²¡æœ‰æ‰¾åˆ°ï¼Œå°±åŽ»ä¸‹ä¸€ä¸ªoverflowæ‰¾ æ€»ç»“ä¸€ä¸‹ï¼šé€šè¿‡åŽBä½ç¡®å®šæ¡¶ï¼Œé€šè¿‡å‰8ä½ç¡®å®šæ ¼å­ï¼Œå¾ªçŽ¯éåŽ†è¿žç€çš„æ‰€æœ‰æ¡¶å…¨éƒ¨æ‰¾å®Œä¸ºæ­¢ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆè¦æœ‰è¿™ä¸ªtophashå‘¢ï¼Ÿå› ä¸ºtophashå¯ä»¥å¿«é€Ÿç¡®å®škeyæ˜¯å¦æ­£ç¡®ï¼Œä½ å¯ä»¥æŠŠå®ƒç†è§£æˆä¸€ç§ç¼“å­˜æŽªæ–½ï¼Œå¦‚æžœå‰8ä½éƒ½ä¸å¯¹äº†ï¼ŒåŽé¢å°±æ²¡æœ‰å¿…è¦æ¯”è¾ƒäº†ã€‚ æºç ä¸€çž¥å…¶ä¸­çº¢è‰²çš„å­—æ ‡å‡ºçš„åœ°æ–¹è¯´æ˜Žäº†ä¸Šé¢çš„å…³é”®ç‚¹ï¼Œæœ€åŽæœ‰å…³keyå’Œvalueå…·ä½“çš„å­˜æ”¾æ–¹å¼å’Œå–å‡ºçš„å®šä½ä¸åšæ·±ç©¶ï¼Œæœ‰å…´è¶£å¯ä»¥çœ‹æœ€åŽçš„å‚è€ƒåšå®¢ã€‚ PUTå…¶å®žå½“ä½ çŸ¥é“äº†å¦‚ä½•GETï¼Œé‚£ä¹ˆPUTå°±æ²¡æœ‰ä»€ä¹ˆéš¾åº¦äº†ï¼Œå› ä¸ºæœ¬è´¨æ˜¯ä¸€æ ·çš„ã€‚PUTçš„æ—¶å€™ä¸€æ ·çš„æ–¹å¼åŽ»å®šä½keyçš„ä½ç½®ï¼š é€šè¿‡keyçš„åŽâ€œBâ€ä½ç¡®å®šæ˜¯å“ªä¸€ä¸ªæ¡¶ é€šè¿‡keyçš„å‰8ä½å¿«é€Ÿç¡®å®šæ˜¯å¦å·²ç»å­˜åœ¨ æœ€ç»ˆç¡®å®šå­˜æ”¾ä½ç½®ï¼Œå¦‚æžœ8ä¸ªæ ¼å­å·²ç»æ»¡äº†ï¼Œæ²¡åœ°æ–¹æ”¾äº†ï¼Œé‚£ä¹ˆå°±é‡æ–°åˆ›å»ºä¸€ä¸ªbmapä½œä¸ºæº¢å‡ºæ¡¶è¿žæŽ¥åœ¨overflow å›¾è§£è¿™é‡Œä¸»è¦å›¾è§£è¯´æ˜Žä¸€ä¸‹ï¼Œå¦‚æžœæ–°æ¥çš„keyå‘çŽ°å‰é¢æœ‰ä¸€ä¸ªæ ¼å­ç©ºç€ï¼ˆè¿™ä¸ªæƒ…å†µæ˜¯åˆ é™¤é€ æˆçš„ï¼‰ï¼Œå°±ä¼šè®°å½•è¿™ä¸ªä½ç½®ï¼Œå½“å…¨éƒ¨æ‰«æå®Œæˆä¹‹åŽå‘çŽ°è‡ªå·±ç¡®å®žæ˜¯æ–°æ¥çš„ï¼Œé‚£ä¹ˆå°±ä¼šæ”¾å‰é¢é‚£ä¸ªç©ºç€çš„ï¼Œè€Œä¸ä¼šæ”¾æœ€åŽï¼ˆæˆ‘æŠŠè¿™ä¸ªç§°ä¸ºç´§å‡‘åŽŸåˆ™ï¼Œå°½å¯èƒ½ä¿è¯æ•°æ®å­˜æ”¾ç´§å‡‘ï¼Œè¿™æ ·ä¸‹æ¬¡æ‰«æä¼šå¿«ï¼‰ ä»£ç ä½ç½®go/src/runtime/hashmap.goçš„mapassignå‡½æ•°å°±æ˜¯mapçš„putæ–¹æ³•ï¼Œå› ä¸ºä»£ç å¾ˆé•¿è¿™é‡Œå°±ä¸å¤šèµ˜è¿°äº†ã€‚ æ‰©å®¹è¿™ä¸ªå°±æ˜¯æœ€å¤æ‚çš„åœ°æ–¹äº†ï¼Œä½†æ˜¯å‘¢ï¼ŸDonâ€™t worryæˆ‘è¿™é‡Œè¿˜æ˜¯ä¼šçœç•¥å…¶ä¸­æŸäº›éƒ¨åˆ†ï¼Œå°†æœ€é‡è¦çš„åœ°æ–¹æ‹Žå‡ºæ¥ã€‚ æ‰©å®¹çš„æ–¹å¼ ç›¸åŒå®¹é‡æ‰©å®¹ 2å€å®¹é‡æ‰©å®¹å•¥æ„æ€å‘¢ï¼Ÿç¬¬ä¸€ç§å‡ºçŽ°çš„æƒ…å†µæ˜¯ï¼šå› ä¸ºmapä¸æ–­çš„putå’Œdeleteï¼Œå‡ºçŽ°äº†å¾ˆå¤šç©ºæ ¼ï¼Œè¿™äº›ç©ºæ ¼ä¼šå¯¼è‡´bmapå¾ˆé•¿ï¼Œä½†æ˜¯ä¸­é—´æœ‰å¾ˆå¤šç©ºçš„åœ°æ–¹ï¼Œæ‰«ææ—¶é—´å˜é•¿ã€‚æ‰€ä»¥ç¬¬ä¸€ç§æ‰©å®¹å®žé™…æ˜¯ä¸€ç§æ•´ç†ï¼Œå°†æ•°æ®æ•´ç†åˆ°å‰é¢ä¸€èµ·ã€‚ç¬¬äºŒç§å‘¢ï¼šå°±æ˜¯çœŸçš„ä¸å¤Ÿç”¨äº†ï¼Œæ‰©å®¹ä¸¤å€ã€‚ æ‰©å®¹çš„æ¡ä»¶è£…è½½å› å­å¦‚æžœä½ çœ‹è¿‡Javaçš„HashMapå®žçŽ°ï¼Œå°±çŸ¥é“æœ‰ä¸ªè£…è½½å› å­ï¼ŒåŒæ ·çš„åœ¨golangä¸­ä¹Ÿæœ‰ï¼Œä½†æ˜¯ä¸ä¸€æ ·å“¦ã€‚è£…è½½å› å­çš„å®šä¹‰æ˜¯è¿™ä¸ªæ ·å­ï¼šloadFactor := count / (2^B)å…¶ä¸­countä¸ºmapä¸­å…ƒç´ çš„ä¸ªæ•°ï¼ŒBå°±æ˜¯ä¹‹å‰ä¸ªé‚£ä¸ªâ€œBâ€ç¿»è¯‘ä¸€ä¸‹å°±æ˜¯è£…è½½å› å­ = ï¼ˆmapä¸­å…ƒç´ çš„ä¸ªæ•°ï¼‰/ï¼ˆmapå½“å‰æ¡¶çš„ä¸ªæ•°ï¼‰ æ‰©å®¹æ¡ä»¶1è£…è½½å› å­ &gt; 6.5ï¼ˆè¿™ä¸ªå€¼æ˜¯æºç ä¸­å†™çš„ï¼‰å…¶å®žæ„æ€å°±æ˜¯ï¼Œæ¡¶åªæœ‰é‚£ä¹ˆå‡ ä¸ªï¼Œä½†æ˜¯å…ƒç´ å¾ˆå¤šï¼Œè¯æ˜Žæœ‰å¾ˆå¤šæº¢å‡ºæ¡¶çš„å­˜åœ¨ï¼ˆå¯ä»¥æƒ³æˆé“¾è¡¨æ‹‰çš„å¤ªé•¿äº†ï¼‰ï¼Œé‚£ä¹ˆæ‰«æé€Ÿåº¦ä¼šå¾ˆæ…¢ï¼Œå°±è¦æ‰©å®¹ã€‚ æ‰©å®¹æ¡ä»¶2overflow çš„ bucket æ•°é‡è¿‡å¤šï¼šå½“ B å°äºŽ 15ï¼Œå¦‚æžœ overflow çš„ bucket æ•°é‡è¶…è¿‡ 2^B ï¼›å½“ B &gt;= 15ï¼Œå¦‚æžœ overflow çš„ bucket æ•°é‡è¶…è¿‡ 2^15 ã€‚å…¶å®žæ„æ€å°±æ˜¯ï¼Œå¯èƒ½æœ‰ä¸€ä¸ªå•ç‹¬çš„ä¸€æ¡é“¾æ‹‰çš„å¾ˆé•¿ï¼Œæº¢å‡ºæ¡¶å¤ªå¤šäº†ï¼Œè¯´ç™½äº†å°±æ˜¯ï¼ŒåŠ å…¥çš„keyä¸å·§ï¼ŒåŽBä½éƒ½ä¸€æ ·ï¼Œä¸€ç›´è½åœ¨åŒä¸€ä¸ªæ¡¶é‡Œé¢ï¼Œè¿™ä¸ªæ¡¶ä¸€ç›´æ”¾ï¼Œè™½ç„¶è£…è½½å› å­ä¸é«˜ï¼Œä½†æ˜¯æ‰«æé€Ÿåº¦å°±å¾ˆæ…¢ã€‚ æ‰©å®¹æ¡ä»¶3å½“å‰ä¸èƒ½æ­£åœ¨æ‰©å®¹ å›¾è§£è¿™å¼ å›¾è¡¨ç¤ºçš„å°±æ˜¯ç›¸åŒå®¹é‡çš„æ‰©å®¹ï¼Œå®žé™…ä¸Šå°±æ˜¯ä¸€ç§æ•´ç†ï¼Œå°†åˆ†æ•£çš„æ•°æ®é›†åˆåˆ°ä¸€èµ·ï¼Œæé«˜æ‰«ææ•ˆçŽ‡ã€‚ï¼ˆä¸Šé¢è¡¨ç¤ºæ‰©å®¹ä¹‹å‰ï¼Œä¸‹é¢è¡¨ç¤ºæ‰©å®¹ä¹‹åŽï¼‰ è¿™å¼ å›¾è¡¨ç¤ºçš„æ˜¯å°±æ˜¯2å€çš„æ‰©å®¹ï¼ˆä¸Šé¢è¡¨ç¤ºæ‰©å®¹ä¹‹å‰ï¼Œä¸‹é¢è¡¨ç¤ºæ‰©å®¹ä¹‹åŽï¼‰ï¼Œå¦‚æžœæœ‰ä¸¤ä¸ªkeyåŽä¸‰ä½åˆ†åˆ«æ˜¯001å’Œ101ï¼Œå½“B=2æ—¶ï¼Œåªæœ‰4ä¸ªæ¡¶ï¼Œåªçœ‹æœ€åŽä¸¤ä½ï¼Œè¿™ä¸¤ä¸ªkeyåŽä¸¤ä½éƒ½æ˜¯01æ‰€ä»¥åœ¨ä¸€ä¸ªæ¡¶é‡Œé¢ï¼›æ‰©å®¹ä¹‹åŽB=3ï¼Œå°±ä¼šæœ‰8ä¸ªæ¡¶ï¼Œçœ‹åŽé¢ä¸‰ä½ï¼ŒäºŽæ˜¯å®ƒä»¬å°±åˆ†åˆ°äº†ä¸åŒçš„æ¡¶é‡Œé¢ã€‚ å¤§è¯ä¸‹é¢è¯´ä¸€äº›æ‰©å®¹æ—¶çš„ç»†èŠ‚ï¼š æ‰©å®¹ä¸æ˜¯ä¸€æ¬¡æ€§å®Œæˆçš„ï¼Œè¿˜è®°çš„æˆ‘ä»¬hmapä¸€å¼€å§‹æœ‰ä¸€ä¸ªoldbucketså—ï¼Ÿæ˜¯å…ˆå°†è€æ•°æ®å­˜åˆ°è¿™ä¸ªé‡Œé¢ æ¯æ¬¡æ¬è¿1åˆ°2ä¸ªbucketï¼Œå½“æ’å…¥æˆ–ä¿®æ”¹ã€åˆ é™¤keyè§¦å‘ æ‰©å®¹ä¹‹åŽè‚¯å®šä¼šå½±å“åˆ°getå’Œputï¼ŒéåŽ†çš„æ—¶å€™è‚¯å®šä¼šå…ˆä»Žoldbucketsæ‹¿ï¼Œputè‚¯å®šä¹Ÿè¦è€ƒè™‘æ˜¯å¦è¦æ”¾åˆ°æ–°äº§ç”Ÿçš„æ¡¶é‡Œé¢åŽ» æºç ä¸€çž¥æ‰©å®¹çš„ä¸‰ä¸ªæ¡ä»¶ï¼Œçœ‹åˆ°äº†å—ï¼Ÿè¿™ä¸ªåœ°æ–¹åœ¨mapassignæ–¹æ³•ä¸­ã€‚ è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œæ³¨é‡Šä¹Ÿå†™çš„å¾ˆæ¸…æ¥šï¼Œå¦‚æžœæ˜¯åŠ è½½å› å­è¶…å‡ºäº†ï¼Œé‚£ä¹ˆå°±2å€æ‰©å®¹ï¼Œå¦‚æžœä¸æ˜¯é‚£ä¹ˆå°±æ˜¯å› ä¸ºå¤ªå¤šæº¢å‡ºæ¡¶äº†ï¼ŒsameSizeGrowè¡¨ç¤ºå°±æ˜¯ç›¸åŒå®¹é‡æ‰©å®¹ evacuateæ˜¯æ¬è¿æ–¹æ³•ï¼Œè¿™è¾¹å¯ä»¥çœ‹åˆ°ï¼Œæ¯æ¬¡æ¬è¿æ˜¯1åˆ°2ä¸ª evacuateå®žåœ¨æ˜¯å¤ªé•¿äº†ï¼Œä¹Ÿéžå¸¸å¤æ‚ï¼Œä½†æ˜¯æƒ…å†µå°±æ˜¯å›¾ä¸Šæè¿°çš„é‚£æ ·ï¼Œæœ‰å…´è¶£çš„å¯ä»¥è¯¦ç»†åŽ»çœ‹ï¼Œè¿™é‡Œä¸æˆªå›¾è¯´æ˜Žäº†ã€‚ æ€»ç»“å’Œå°é—®é¢˜è‡³æ­¤ä½ åº”è¯¥å¯¹äºŽgolangä¸­çš„mapæœ‰ä¸€ä¸ªåŸºæœ¬çš„è®¤è¯†äº†ï¼Œä½ è¿˜å¯ä»¥åŽ»çœ‹çœ‹åˆ é™¤ï¼Œä½ è¿˜å¯ä»¥åŽ»çœ‹çœ‹éåŽ†ç­‰ç­‰ï¼Œç›¸ä¿¡æœ‰äº†ä¸Šé¢çš„åŸºæœ¬è®¤è¯†é‚£ä¹ˆåº”è¯¥ä¸ä¼šéš¾åˆ°ä½ ã€‚ä¸‹é¢æœ‰å‡ ä¸ªå°é—®é¢˜ï¼š æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿå¦ï¼Œè€Œä¸”å¹¶å‘æ“ä½œä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ æºç ä½ç½®ï¼šsrc/runtime/hashmap.go æ¯æ¬¡éåŽ†mapé¡ºåºæ˜¯å¦ä¸€è‡´ï¼Ÿä¸ä¸€è‡´ï¼Œæ¯æ¬¡éåŽ†ä¼šéšæœºä¸ªæ•°ï¼Œé€šè¿‡éšæœºæ•°æ¥å†³å®šä»Žå“ªä¸ªå…ƒç´ å¼€å§‹ã€‚ å†™çš„ä»“ä¿ƒï¼Œéš¾å…ç–æ¼ï¼Œæœ‰é—®é¢˜çš„åœ°æ–¹è¿˜è¯·æ‰¹è¯„æŒ‡æ­£ã€‚ å‚è€ƒèµ„æ–™å¦‚æžœä½ å¸Œæœ›çœ‹åˆ°æºç çš„å„ç§ç»†èŠ‚è®²è§£ï¼Œä¸‹é¢è¿™å‡ ç¯‡æ˜¯æˆ‘å­¦ä¹ çš„æ—¶å€™çœ‹çš„ï¼Œä¾›ä½ å‚è€ƒï¼Œå¸Œæœ›å¯¹ä½ æœ‰å¸®åŠ©https://github.com/qcrao/Go-Questions/tree/master/maphttps://github.com/cch123/golang-notes/blob/master/map.mdhttps://draveness.me/golang-hashmaphttps://lukechampine.com/hackmap.html]]></content>
      <categories>
        <category>golangæºç è§£æž</category>
      </categories>
      <tags>
        <tag>hashmap</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Golang è¯»å†™é”RWMutex äº’æ–¥é”Mutex æºç è¯¦è§£]]></title>
    <url>%2F2019%2F06%2F01%2Fgolang%2Fsource-code%2Frwmutex-mutex-source-code-review%2F</url>
    <content type="text"><![CDATA[Golangä¸­æœ‰ä¸¤ç§ç±»åž‹çš„é”ï¼ŒMutex ï¼ˆäº’æ–¥é”ï¼‰å’ŒRWMutexï¼ˆè¯»å†™é”ï¼‰å¯¹äºŽè¿™ä¸¤ç§é”çš„ä½¿ç”¨è¿™é‡Œå°±ä¸å¤šè¯´äº†ï¼Œæœ¬æ–‡ä¸»è¦ä¾§é‡äºŽä»Žæºç çš„è§’åº¦åˆ†æžè¿™ä¸¤ç§é”çš„å…·ä½“å®žçŽ°ã€‚ å¼•å­é—®é¢˜æˆ‘ä¸€èˆ¬å–œæ¬¢å¸¦ç€é—®é¢˜åŽ»çœ‹æºç ã€‚é‚£ä¹ˆå¯¹äºŽè¯»å†™é”ï¼Œä½ æ˜¯å¦æœ‰è¿™æ ·çš„é—®é¢˜ï¼Œä¸ºä»€ä¹ˆå¯ä»¥æœ‰å¤šä¸ªè¯»é”ï¼Ÿæœ‰æ²¡æœ‰å¯èƒ½å‡ºçŽ°æœ‰åç¨‹ä¸€ç›´æ— æ³•èŽ·å–åˆ°å†™é”çš„æƒ…å†µï¼Ÿå¸¦ç€ä½ çš„ç–‘é—®æ¥å¾€ä¸‹çœ‹çœ‹ï¼Œå…·ä½“è¿™ä¸ªé”æ˜¯å¦‚ä½•å®žçŽ°çš„ã€‚ å¦‚æžœä½ è‡ªå·±æƒ³çœ‹ï¼Œæˆ‘ç»™å‡ºé˜…è¯»çš„ä¸€ä¸ªæ€è·¯ï¼Œå¯ä»¥å…ˆçœ‹è¯»å†™é”ï¼Œå› ä¸ºè¯»å†™é”çš„å®žçŽ°ä¾èµ–äºŽäº’æ–¥é”ï¼Œå¹¶ä¸”è¯»å†™é”æ¯”è¾ƒç®€å•ä¸€äº›ï¼Œç„¶åŽæ•´ç†æ€è·¯ä¹‹åŽå†åŽ»æƒ³ä¸€ä¸‹å®žé™…çš„åº”ç”¨åœºæ™¯ï¼Œç„¶åŽå†åŽ»çœ‹äº’æ–¥é”ã€‚ ä¸‹é¢æˆ‘å°±ä¼šæŒ‰ç…§è¿™ä¸ªæ€è·¯ä¸€æ­¥æ­¥å¾€ä¸‹èµ°ã€‚ åŸºç¡€çŸ¥è¯†ç‚¹ çŸ¥è¯†ç‚¹1ï¼šä¿¡å·é‡ä¿¡å·é‡æ˜¯ Edsger Dijkstra å‘æ˜Žçš„æ•°æ®ç»“æž„ï¼ˆæ²¡é”™å°±æ˜¯é‚£ä¸ªæœ€çŸ­è·¯å¾„ç®—æ³•é‚£ä¸ªç‰›äººï¼‰ï¼Œåœ¨è§£å†³å¤šç§åŒæ­¥é—®é¢˜æ—¶å¾ˆæœ‰ç”¨ã€‚å…¶æœ¬è´¨æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œå¹¶å…³è”ä¸¤ä¸ªæ“ä½œï¼š ç”³è¯·acquireï¼ˆä¹Ÿç§°ä¸º waitã€decrement æˆ– P æ“ä½œï¼‰é‡Šæ”¾releaseï¼ˆä¹Ÿç§° signalã€increment æˆ– V æ“ä½œï¼‰ acquireæ“ä½œå°†ä¿¡å·é‡å‡ 1ï¼Œå¦‚æžœç»“æžœå€¼ä¸ºè´Ÿåˆ™çº¿ç¨‹é˜»å¡žï¼Œä¸”ç›´åˆ°å…¶ä»–çº¿ç¨‹è¿›è¡Œäº†ä¿¡å·é‡ç´¯åŠ ä¸ºæ­£æ•°æ‰èƒ½æ¢å¤ã€‚å¦‚ç»“æžœä¸ºæ­£æ•°ï¼Œçº¿ç¨‹åˆ™ç»§ç»­æ‰§è¡Œã€‚releaseæ“ä½œå°†ä¿¡å·é‡åŠ  1ï¼Œå¦‚å­˜åœ¨è¢«é˜»å¡žçš„çº¿ç¨‹ï¼Œæ­¤æ—¶ä»–ä»¬ä¸­çš„ä¸€ä¸ªçº¿ç¨‹å°†è§£é™¤é˜»å¡žã€‚ çŸ¥è¯†ç‚¹2ï¼šé”çš„å®šä¹‰åœ¨goalngä¸­å¦‚æžœå®žçŽ°äº†Lockå’ŒUnlockæ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒå°±å¯ä»¥è¢«ç§°ä¸ºé”ã€‚ çŸ¥è¯†ç‚¹3ï¼šé”çš„è‡ªæ—‹ï¼šï¼ˆè¯¦è§ç™¾åº¦ï¼‰ çŸ¥è¯†ç‚¹4ï¼šcasç®—æ³•ï¼šï¼ˆæœ€å¥½æœ‰æ‰€äº†è§£ï¼Œä¸çŸ¥é“é—®é¢˜ä¹Ÿä¸å¤§ï¼‰ è¯»å†™é”RWMutexé¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹RWMutexå¤§ä½“ç»“æž„çœ‹åˆ°ç»“æž„å‘çŽ°è¯»å†™é”å†…éƒ¨åŒ…å«äº†ä¸€ä¸ªw Mutexäº’æ–¥é”æ³¨é‡Šä¹Ÿå¾ˆæ˜Žç¡®ï¼Œè¿™ä¸ªé”çš„ç›®çš„å°±æ˜¯æŽ§åˆ¶å¤šä¸ªå†™å…¥æ“ä½œçš„å¹¶å‘æ‰§è¡ŒwriterSemæ˜¯å†™å…¥æ“ä½œçš„ä¿¡å·é‡readerSemæ˜¯è¯»æ“ä½œçš„ä¿¡å·é‡readerCountæ˜¯å½“å‰è¯»æ“ä½œçš„ä¸ªæ•°readerWaitå½“å‰å†™å…¥æ“ä½œéœ€è¦ç­‰å¾…è¯»æ“ä½œè§£é”çš„ä¸ªæ•°è¿™å‡ ä¸ªçŽ°åœ¨çœ‹ä¸æ‡‚æ²¡å…³ç³»ï¼ŒåŽé¢ç­‰ç”¨åˆ°äº†ä½ å†å›žæ¥çœ‹å°±å¥½äº†ã€‚ ç„¶åŽæˆ‘ä»¬çœ‹çœ‹æ–¹æ³•ä¸€å…±æœ‰5ä¸ªæ–¹æ³•ï¼Œçœ‹èµ·æ¥å°±ä¸å¤æ‚ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸ªæ¥çœ‹ã€‚ è¿™ä¸ªæœ€ç®€å•ï¼Œå°±æ˜¯è¿”å›žä¸€ä¸ªlockerå¯¹è±¡æ²¡å•¥å¥½è¯´çš„ é—®é¢˜çš„å…³é”®å°±åœ¨äºŽé”å’Œè§£é”çš„å‡ ä¸ªæ–¹æ³•ï¼Œå› ä¸ºæˆ‘å·²ç»çœ‹è¿‡ï¼Œæ‰€ä»¥æŽ¨èè¿™å‡ ä¸ªæ–¹æ³•çš„é˜…è¯»é¡ºåºæ˜¯RLock Lock RUnlock Unlock RLockï¼ˆèŽ·å–è¯»é”ï¼‰å…ˆä¸çœ‹ç«žæ€æ£€æµ‹çš„éƒ¨åˆ†ï¼Œå…ˆé‡ç‚¹çœ‹çº¢è‰²æ¡†ä¸­çš„éƒ¨åˆ†å¯ä»¥çœ‹åˆ°ï¼Œå…¶å®žå¾ˆç®€å•ï¼Œæ¯å½“æœ‰åç¨‹éœ€è¦èŽ·å–è¯»é”çš„æ—¶å€™ï¼Œå°±å°†readerCount + 1ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªæ¡ä»¶ï¼Œå½“readerCount + 1ä¹‹åŽçš„å€¼ &lt; 0çš„æ—¶å€™ï¼Œé‚£ä¹ˆå°†ä¼šè°ƒç”¨runtime_Semacquireæ–¹æ³•è¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªruntimeçš„æ–¹æ³•ï¼Œä¼šä¸€ç›´ç­‰å¾…ä¼ å…¥çš„så‡ºçŽ°&gt;0çš„æ—¶å€™ç„¶åŽæˆ‘ä»¬å¯ä»¥è®°å¾—ï¼Œè¿™é‡Œæœ‰è¿™æ ·ä¸€ä¸ªæƒ…å†µï¼Œå½“å‡ºå…ˆreaderCount + 1ä¸ºè´Ÿæ•°çš„æƒ…å†µé‚£ä¹ˆå°±ä¼šè¢«ç­‰å¾…ï¼Œçœ‹æ³¨é‡Šæˆ‘ä»¬å¯ä»¥çŒœåˆ°ï¼Œæ˜¯å½“æœ‰å†™å…¥æ“ä½œå‡ºçŽ°çš„æ—¶å€™ï¼Œé‚£ä¹ˆè¯»æ“ä½œå°±ä¼šè¢«ç­‰å¾…ã€‚ Lockï¼ˆèŽ·å–å†™é”ï¼‰å†™é”ç¨å¾®å¤æ‚ä¸€äº›ï¼Œä½†æ˜¯æ ·å­ä¹Ÿå·®ä¸å¤šï¼Œæˆ‘ä»¬è¿˜æ˜¯å…ˆæ¥çœ‹çº¢è‰²æ¡†ä¸­çš„éƒ¨åˆ†ã€‚é¦–å…ˆæ“ä½œæœ€å‰é¢è¯´çš„äº’æ–¥é”ï¼Œç›®çš„å°±æ˜¯å¤„ç†å¤šä¸ªå†™é”å¹¶å‘çš„æƒ…å†µï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“å†™é”åªæœ‰ä¸€æŠŠã€‚è¿™é‡Œä¸éœ€è¦æ·±å…¥äº’æ–¥é”ï¼Œåªéœ€è¦çŸ¥é“ï¼Œäº’æ–¥é”åªæœ‰ä¸€ä¸ªäººèƒ½æ‹¿åˆ°ï¼Œæ‰€ä»¥å†™é”åªæœ‰ä¸€ä¸ªäººèƒ½æ‹¿åˆ°ã€‚ ç„¶åŽé‡ç‚¹æ¥äº†ï¼Œè¿™é‡Œçš„è¿™ä¸ªæ“ä½œç»†ç»†ä½“ä¼šä¸€ä¸‹ï¼Œatomic.AddInt32(&amp;rw.readerCount, -rwmutexMaxReaders)æ˜¯å°†å½“å‰çš„readerCountå‡åŽ»ä¸€ä¸ªéžå¸¸å¤§çš„å€¼rwmutexMaxReadersä¸º1 &lt;&lt; 30å¤§æ¦‚æ˜¯1073741823è¿™ä¹ˆå¤§å§ æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä»Žæºç ä¸­çœ‹å‡ºï¼ŒreaderCountç”±äºŽæ¯æœ‰ä¸€ä¸ªåç¨‹èŽ·å–è¯»é”å°±+1ï¼Œä¸€ç›´éƒ½æ˜¯æ­£æ•°ï¼Œè€Œå½“æœ‰å†™é”è¿‡æ¥çš„æ—¶å€™ï¼Œå°±çž¬é—´å‡ä¸ºå¾ˆå¤§çš„è´Ÿæ•°ã€‚ç„¶åŽåšå®Œä¸Šé¢çš„æ“ä½œä»¥åŽçš„rå…¶å®žå°±æ˜¯åŽŸæ¥çš„readerCountã€‚åŽé¢è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æžœåŽŸæ¥çš„readerCountä¸ä¸º0ï¼ˆåŽŸæ¥æœ‰åç¨‹å·²ç»èŽ·å–åˆ°äº†è¯»é”ï¼‰å¹¶ä¸”å°†readerWaitåŠ ä¸ŠreaderCountï¼ˆè¡¨ç¤ºéœ€è¦ç­‰å¾…readerCountè¿™ä¹ˆå¤šä¸ªè¯»é”è¿›è¡Œè§£é”ï¼‰ï¼Œå¦‚æžœæ»¡è¶³ä¸Šè¿°æ¡ä»¶è¯æ˜ŽåŽŸæ¥æœ‰è¯»é”ï¼Œæ‰€ä»¥æš‚æ—¶æ²¡æœ‰åŠžæ³•èŽ·å–åˆ°å†™é”ï¼Œæ‰€ä»¥è°ƒç”¨runtime_Semacquireè¿›è¡Œç­‰å¾…ï¼Œç­‰å¾…çš„ä¿¡å·é‡ä¸ºwriterSem RUnlockï¼ˆé‡Šæ”¾è¯»é”ï¼‰å¦‚æžœæ˜¯æˆ‘ä»¬æ¥å†™çš„è¯ï¼Œå¯èƒ½å°±æ˜¯å°†ä¹‹å‰+1çš„readerCountï¼Œ-1å°±å®Œäº‹äº†ï¼Œä½†æ˜¯å…¶å®žè¿˜æœ‰ä¸€äº›æ“ä½œéœ€è¦æ³¨æ„ã€‚å¦‚æžœ-1ä¹‹åŽ+1==0æ˜¯å•¥æƒ…å†µï¼Ÿæ²¡é”™å°±æ˜¯æˆ‘ä»¬å¸¸è§çš„ï¼Œæ–°æ‰‹ç¨‹åºå‘˜ï¼Œæ²¡æœ‰èŽ·å–è¯»é”å°±æƒ³åŽ»é‡Šæ”¾è¯»é”ï¼ŒäºŽæ˜¯å¼‚å¸¸äº†ã€‚å½“ç„¶+1ä¹‹åŽåˆšå¥½æ˜¯rwmutexMaxReadersï¼Œå°±è¯èŽ·å–äº†å†™é”è€ŒåŽ»é‡Šæ”¾äº†è¯»é”ï¼Œå¯¼è‡´å¼‚å¸¸ã€‚é™¤åŽ»å¼‚å¸¸æƒ…å†µï¼Œå‰©ä¸‹çš„å°±æ˜¯rè¿˜æ˜¯&lt;0çš„æƒ…å†µï¼Œé‚£ä¹ˆè¯æ˜Žç¡®å®žæœ‰åç¨‹æ­£åœ¨æƒ³è¦èŽ·å–å†™é”ï¼Œé‚£ä¹ˆå°±éœ€è¦æ“ä½œæˆ‘ä»¬å‰é¢çœ‹åˆ°çš„readerWaitï¼Œå½“readerWaitå‡åˆ°0çš„æ—¶å€™å°±è¯æ˜Žæ²¡æœ‰äººæ­£åœ¨æŒæœ‰å†™é”äº†ï¼Œå°±é€šè¿‡ä¿¡å·é‡writerSemçš„å˜åŒ–å‘ŠçŸ¥åˆšæ‰ç­‰å¾…çš„åç¨‹ï¼ˆæƒ³è¦èŽ·å–å†™é”çš„åç¨‹ï¼‰ï¼šä½ å¯ä»¥è¿›è¡ŒèŽ·å–äº†ã€‚ åˆ°è¿™é‡Œä½ å¯ä»¥æŠŠæ€è·¯å¤§è‡´ä¸²èµ·æ¥äº†ï¼Œç„¶åŽæ‡‚äº†å†å¾€ä¸‹çœ‹ã€‚ Unlockï¼ˆé‡Šæ”¾å†™é”ï¼‰å†™é”é‡Šæ”¾éœ€è¦æ¢å¤readerCountï¼Œè¿˜è®°å¾—ä¸Šé”çš„æ—¶å€™å‡äº†ä¸€ä¸ªå¾ˆå¤§çš„æ•°ï¼Œè¿™ä¸ªæ—¶å€™è¦åŠ å›žæ¥äº†ã€‚å½“ç„¶åŠ å®Œä¹‹åŽå¦‚æžœ&gt;=rwmutexMaxReadersæœ¬èº«ï¼Œé‚£ä¹ˆè¿˜æ˜¯æ–°æ‰‹ç¨‹åºå‘˜çš„é—®é¢˜ï¼Œå½“æ²¡æœ‰èŽ·å–å†™é”çš„æ—¶å€™å°±å¼€å§‹æƒ³ç€é‡Šæ”¾å†™é”äº†ã€‚ç„¶åŽforå¾ªçŽ¯å°±æ˜¯ä¸ºäº†é€šçŸ¥æ‰€æœ‰åœ¨æˆ‘ä»¬RLockæ–¹æ³•ä¸­çœ‹åˆ°çš„ï¼Œå½“æœ‰å› ä¸ºæŒæœ‰å†™é”æ‰€ä»¥ç­‰å¾…çš„é‚£äº›åç¨‹ï¼Œé€šè¿‡ä¿¡å·é‡readerSemå‘Šè¯‰ä»–ä»¬å¯ä»¥åŠ¨äº†ã€‚æœ€åŽåˆ«å¿˜è®°è¿˜æœ‰ä¸€ä¸ªäº’æ–¥é”éœ€è¦é‡Šæ”¾ï¼Œè®©åˆ«çš„åç¨‹ä¹Ÿå¯ä»¥å¼€å§‹æŠ¢å†™é”äº†ã€‚ è‡³æ­¤ï¼Œè¯»å†™é”çš„åˆ†æžåŸºæœ¬ä¸Šå‘Šä¸€æ®µè½äº†ã€‚é’ˆå¯¹äºŽå…¶ä¸­å…³äºŽç«žæ€åˆ†æžçš„ä»£ç ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥åŽ»äº†è§£ä¸€ä¸‹ã€‚ äº’æ–¥é”Mutexäº’æ–¥é”æ¯”è¯»å†™é”å¤æ‚ï¼Œä½†æ˜¯å¥½åœ¨golangç»™çš„æ³¨é‡Šå¾ˆè¯¦ç»†ï¼Œæ‰€ä»¥ä¹Ÿä¸å›°éš¾ï¼ˆæ³¨é‡ŠçœŸçš„å¾ˆé‡è¦ï¼‰ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹é‡Œé¢çš„ä¸€æ®µæ³¨é‡Šï¼šå¾ˆé•¿çš„ä¸€æ®µè‹±æ–‡ï¼Œæˆ‘ç”¨è‹±è¯­å››çº§çš„ç¿»è¯‘èƒ½åŠ›ç»™ä½ ç¿»è¯‘ä¸€ä¸‹ï¼Œå¯ä»¥å°†å°±çœ‹çœ‹ï¼Œå¦‚æžœå¯ä»¥å»ºè®®ä½ ä»”ç»†çœ‹è‹±æ–‡çœ‹æ‡‚å®ƒï¼Œå› ä¸ºè¿™å¯¹äºŽåŽé¢çš„æºç é˜…è¯»éžå¸¸é‡è¦ã€‚///è¿™ä¸ªäº’æ–¥é”æ˜¯å…¬å¹³é” äº’æ–¥é”æœ‰ä¸¤ç§æ“ä½œæ¨¡å¼ï¼šæ­£å¸¸æ¨¡å¼å’Œé¥¥é¥¿æ¨¡å¼ã€‚åœ¨æ­£å¸¸æ¨¡å¼ä¸‹ç­‰å¾…èŽ·å–é”çš„goroutineä¼šä»¥ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„æ–¹å¼è¿›è¡ŒæŽ’é˜Ÿï¼Œä½†æ˜¯è¢«å”¤é†’çš„ç­‰å¾…è€…å¹¶ä¸èƒ½ä»£è¡¨å®ƒå·²ç»æ‹¥æœ‰äº†è¿™ä¸ªmutexé”ï¼Œå®ƒéœ€è¦ä¸Žæ–°åˆ°è¾¾çš„goroutineäº‰å¤ºmutexé”ã€‚æ–°æ¥çš„goroutineæœ‰ä¸€ä¸ªä¼˜åŠ¿ â€”â€” ä»–ä»¬å·²ç»åœ¨CPUä¸Šè¿è¡Œäº†å¹¶ä¸”ä»–ä»¬ï¼Œæ‰€ä»¥æŠ¢åˆ°çš„å¯èƒ½æ€§å¤§ä¸€äº›ï¼Œæ‰€ä»¥ä¸€ä¸ªè¢«å”¤é†’çš„ç­‰å¾…è€…æœ‰å¾ˆå¤§å¯èƒ½æŠ¢ä¸è¿‡ã€‚åœ¨è¿™æ ·çš„æƒ…å†µä¸‹ï¼Œè¢«å”¤é†’çš„ç­‰å¾…è€…åœ¨é˜Ÿåˆ—çš„å¤´éƒ¨ã€‚å¦‚æžœä¸€ä¸ªç­‰å¾…è€…æŠ¢é”è¶…è¿‡1mså¤±è´¥äº†ï¼Œå°±ä¼šåˆ‡æ¢ä¸ºé¥¥é¥¿æ¨¡å¼ã€‚ åœ¨é¥¥é¥¿æ¨¡å¼ä¸‹ï¼Œmutexé”ä¼šç›´æŽ¥ç”±è§£é”çš„goroutineäº¤ç»™é˜Ÿåˆ—å¤´éƒ¨çš„ç­‰å¾…è€…ã€‚æ–°æ¥çš„goroutineä¸èƒ½å°è¯•åŽ»èŽ·å–é”ï¼Œå³ä½¿å¯èƒ½æ ¹æœ¬å°±æ²¡goroutineåœ¨æŒæœ‰é”ï¼Œå¹¶ä¸”ä¸èƒ½å°è¯•è‡ªæ—‹ã€‚å–è€Œä»£ä¹‹çš„æ˜¯ä»–ä»¬åªèƒ½æŽ’åˆ°é˜Ÿä¼å°¾å·´ä¸Šä¹–ä¹–ç­‰ç€ã€‚ å¦‚æžœä¸€ä¸ªç­‰å¾…è€…èŽ·å–åˆ°äº†é”ï¼Œå¹¶ä¸”é‡åˆ°äº†ä¸‹é¢ä¸¤ç§æƒ…å†µä¹‹ä¸€ï¼Œå°±æ¢å¤æˆæ­£å¸¸å·¥ä½œæ¨¡å¼ã€‚æƒ…å†µ1ï¼šå®ƒæ˜¯æœ€åŽä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„ç­‰å¾…è€…ã€‚æƒ…å†µ2ï¼šå®ƒç­‰å¾…çš„æ—¶é—´å°äºŽ1ms æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œå³ä½¿æœ‰å¾ˆå¤šé˜»å¡žçš„ç­‰å¾…è€…ï¼Œæœ‰æ›´å¥½çš„è¡¨çŽ°ï¼Œå› ä¸ºä¸€è½®èƒ½å¤šæ¬¡èŽ·å¾—é”çš„æœºä¼šã€‚é¥¥é¥¿æ¨¡å¼æ˜¯ä¸ºäº†é¿å…é‚£äº›ä¸€ç›´åœ¨é˜Ÿå°¾çš„å€’éœ‰è›‹ã€‚/// æˆ‘çš„è¯ç®€å•æ€»ç»“å°±æ˜¯ï¼Œäº’æ–¥é”æœ‰ä¸¤ç§å·¥ä½œæ¨¡å¼ï¼Œç«žäº‰æ¨¡å¼å’Œé˜Ÿåˆ—æ¨¡å¼ï¼Œç«žäº‰å°±æ˜¯å¤§å®¶ä¸€èµ·æŠ¢ï¼Œé˜Ÿåˆ—å°±æ˜¯è€è€å®žå®žæŽ’é˜Ÿï¼Œè¿™ä¸¤ç§å·¥ä½œæ¨¡å¼ä¼šé€šè¿‡ä¸€äº›æƒ…å†µè¿›è¡Œåˆ‡æ¢ã€‚ é¦–å…ˆè¿˜æ˜¯æ¥çœ‹çœ‹å¤§ä½“ç»“æž„å¯ä»¥çœ‹åˆ°ï¼Œç›¸å¯¹è¯»å†™é”ï¼Œç»“æž„ä¸Šé¢å¾ˆç®€å•ï¼Œåªæœ‰ä¸¤ä¸ªå€¼ï¼Œä½†æ˜¯åƒä¸‡ä¸è¦å°çž§å®ƒï¼Œå‡å°‘äº†å­—æ®µå°±å¢žåŠ äº†ç†è§£éš¾åº¦ã€‚stateï¼šå°†ä¸€ä¸ª32ä½æ•´æ•°æ‹†åˆ†ä¸ºï¼šå½“å‰é˜»å¡žçš„goroutineæ•°(29ä½)é¥¥é¥¿çŠ¶æ€(1ä½ï¼Œ0ä¸ºæ­£å¸¸æ¨¡å¼ï¼›1ä¸ºé¥¥é¥¿æ¨¡å¼)å”¤é†’çŠ¶æ€(1ä½ï¼Œ0æœªå”¤é†’ï¼›1å·²å”¤é†’)é”çŠ¶æ€(1ä½ï¼Œ0å¯ç”¨ï¼›1å ç”¨) semaï¼šä¿¡å·é‡ æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯Lockå’ŒUnlockä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªä¸Šé”ï¼Œä¸€ä¸ªè§£é”ï¼Œæ²¡å•¥å¥½è¯´çš„ã€‚ ä¸€ä¸ªæ–¹æ³•æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªçš„è¦ç”¨åˆ°çš„æ–¹æ³• func CompareAndSwapInt32(addr *int32, old, new int32) (swapped bool)è¿™ä¸ªå‡½æ•°ï¼Œä¼šå…ˆåˆ¤æ–­å‚æ•°addræŒ‡å‘çš„è¢«æ“ä½œå€¼ä¸Žå‚æ•°oldçš„å€¼æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æžœç›¸ç­‰ä¼šå°†å‚æ•°newæ›¿æ¢å‚æ•°addræ‰€æŒ‡å‘çš„å€¼ï¼Œä¸ç„¶çš„è¯å°±å•¥ä¹Ÿä¸åšã€‚éœ€è¦ç‰¹åˆ«è¯´æ˜Žçš„æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•å¹¶ä¸ä¼šé˜»å¡žã€‚ å‡ ä¸ªå¸¸é‡è¿™æ˜¯å®šä¹‰çš„å‡ ä¸ªå¸¸é‡ï¼Œæˆ‘ä»¬åœ¨ä¸€å¼€å§‹çš„æ³¨é‡Šå‘¨å›´å¯ä»¥çœ‹åˆ°ï¼ŒåŽé¢éœ€è¦ç”¨åˆ°ï¼Œæš‚æ—¶è®°ä½å®ƒä»¬çš„åˆå§‹å€¼å°±å¥½ã€‚ mutexLocked = 1 &lt;&lt; iota // 1å·¦ç§»0ä½ï¼Œæ˜¯1ï¼ŒäºŒè¿›åˆ¶æ˜¯1ï¼Œï¼ˆ1è¡¨ç¤ºå·²ç»ä¸Šé”ï¼‰mutexWoken // 1å·¦ç§»1ä½ï¼Œæ˜¯2ï¼ŒäºŒè¿›åˆ¶æ˜¯10mutexStarving // 1å·¦ç§»2ä½ï¼Œæ˜¯4ï¼ŒäºŒè¿›åˆ¶æ˜¯100mutexWaiterShift = iota // å°±æ˜¯3ï¼Œ äºŒè¿›åˆ¶æ˜¯11 starvationThresholdNs = 1e6 // è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬ä¸€å¼€å§‹åœ¨æ³¨é‡Šé‡Œé¢çœ‹åˆ°çš„1msï¼Œä¸€å®šè¶…è¿‡è¿™ä¸ªé—¨é™å€¼å°±ä¼šæ›´æ¢æ¨¡å¼ LockèŽ·å–é”å› ä¸ºLockæ–¹æ³•æ¯”è¾ƒé•¿ï¼Œæ‰€ä»¥æˆ‘åˆ‡åˆ†ä¸€æ®µæ®µçœ‹ï¼Œéœ€è¦å®Œæ•´çš„è¯·è‡ªå·±ç¿»çœ‹æºç ã€‚è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œä¸€å®šè¦æ—¶åˆ»è®°ä½ï¼ŒLockæ–¹æ³•æ˜¯åšä»€ä¹ˆçš„ï¼Œå¾ˆç®€å•ï¼Œå°±æ˜¯è¦æŠ¢é”ã€‚çœ‹ä¸æ‡‚çš„æ—¶å€™æƒ³æƒ³è¿™ä¸ªç›®æ ‡ã€‚ç¬¬ä¸€æ­¥ï¼Œåˆ¤æ–­stateçŠ¶æ€æ˜¯å¦ä¸º0ï¼Œå¦‚æžœä¸º0ï¼Œè¯æ˜Žæ²¡æœ‰åç¨‹æŒæœ‰é”ï¼Œé‚£ä¹ˆå°±å¾ˆç®€å•äº†ï¼Œç›´æŽ¥èŽ·å–åˆ°é”ï¼Œå°†mutexLockedï¼ˆä¸º1ï¼‰èµ‹å€¼åˆ°stateå°±å¯ä»¥äº†ã€‚ çœ‹åŽé¢çš„æ–¹æ³•æ—¶ï¼Œå‘Šè¯‰éœ€è¦å‘Šè¯‰ä½ ä»¬ä¸€ä¸ªå°æŠ€å·§ï¼Œå½“é‡åˆ°è¿™ç§ä½æ“ä½œå¾ˆå¤šçš„æƒ…å†µï¼Œæœ‰ä¸¤ä¸ªæ–¹æ³•æŒºå¥½ç”¨ï¼Œå¯¹äºŽä½ çœ‹æºç ä¼šæœ‰å¸®åŠ©ï¼šç¬¬ä¸€ä¸ªæ˜¯å°†æ‰€æœ‰å®šå€¼å…ˆè®¡ç®—ï¼Œç„¶åŽåˆ¤æ–­éžå®šå€¼çš„æƒ…å†µï¼›ç¬¬äºŒä¸ªæ˜¯å°†æ‰€æœ‰çš„è®¡ç®—å†™ä¸‹æ¥ï¼Œè‡ªå·±ç”¨ç¬”åŽ»è®¡ç®—ï¼Œä¸è¦æ‰§ç€äºŽæ‰“å­—ã€‚ ç„¶åŽæˆ‘ä»¬ä»¥ä¸‹é¢è¿™ä¸ªæ®µä¸¾ä¾‹ï¼šé¦–å…ˆï¼Œçœ‹æ³¨é‡Šåº”è¯¥èƒ½æ˜Žç™½è¿™ä¸€æ®µå¤§è‡´æ„æ€æ˜¯ï¼Œå¦‚æžœä¸æ˜¯é¥¥é¥¿æ¨¡å¼ï¼Œå°±ä¼šè¿›è¡Œè‡ªæ—‹æ“ä½œï¼Œç„¶åŽä¸æ–­å¾ªçŽ¯ã€‚ ç„¶åŽæ ¹æ®ä¸Šé¢çš„æŠ€å·§ï¼Œold&amp;(mutexLocked|mutexStarving) == mutexLockedï¼ˆä¸‹é¢å‡ä¸ºäºŒè¿›åˆ¶ï¼‰mutexLocked = 1mutexStarving = 11mutexLocked = 1è¿™ä¸‰ä¸ªæ˜¯å®šå€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬å®¹æ˜“å¾—åˆ°ï¼Œæ»¡è¶³æƒ…å†µçš„ç»“æžœä¸ºï¼Œå½“oldä¸ºxxxx0xxï¼ˆäºŒè¿›åˆ¶ç¬¬ä¸‰ä½ä¸º0ï¼‰ç­‰å¼æˆç«‹ã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸€å¼€å§‹è¯´çš„ï¼Œstateçš„ç¬¬ä¸‰ä½æ˜¯è¡¨ç¤ºè¿™ä¸ªé”å½“å‰çš„æ¨¡å¼ï¼Œ0ä¸ºæ­£å¸¸æ¨¡å¼ï¼Œ1ä¸ºé¥¥é¥¿æ¨¡å¼ã€‚ é‚£ä¹ˆç¬¬ä¸€ä¸ªifå°±è¡¨ç¤ºï¼Œå¦‚æžœå½“å‰æ¨¡å¼ä¸ºæ­£å¸¸æ¨¡å¼ï¼Œä¸”å¯ä»¥è‡ªæ—‹ï¼Œå°±è¿›å…¥ifæ¡ä»¶å†…éƒ¨ã€‚if !awoke &amp;&amp; old&amp;mutexWoken == 0 &amp;&amp; old&gt;&gt;mutexWaiterShift != 0 &amp;&amp; åŒæ ·çš„åˆ†æžï¼Œawokeè¡¨ç¤ºæ˜¯å¦å”¤é†’ï¼Œold&amp;mutexWokenæ˜¯å–ç¬¬äºŒä½ï¼Œ0è¡¨ç¤ºå½“å‰åç¨‹æœªè¢«å”¤é†’ï¼Œold&gt;&gt;mutexWaiterShiftè¡¨ç¤ºå³ç§»3ä½ï¼Œä¹Ÿå°±æ˜¯å‰29ä½ï¼Œä¸ä¸º0è¯æ˜Žæœ‰åç¨‹åœ¨ç­‰å¾…ï¼Œå¹¶ä¸”å°è¯•åŽ»å¯¹æ¯”å½“å‰m.stateä¸Žå–å‡ºæ—¶çš„oldçŠ¶æ€ï¼Œå°è¯•åŽ»å”¤é†’è‡ªå·±ã€‚ç„¶åŽè‡ªæ—‹ï¼Œå¹¶ä¸”å¢žåŠ è‡ªæ—‹æ¬¡æ•°è¡¨ç¤ºiterï¼Œç„¶åŽé‡æ–°èµ‹å€¼oldã€‚å†å¾ªçŽ¯ä¸‹ä¸€æ¬¡ã€‚ ï¼ˆä½ è‡ªå·±ç†ä¸€ç†ï¼Œç¡®å®žæœ‰ç‚¹ç»•ï¼Œä»”ç»†æƒ³æƒ³å°±æƒ³é€šäº†å°±å¯¹äº†ã€‚ï¼‰ ä»¥ä¸Šæ˜¯ä½¿ç”¨è‡ªæ—‹çš„æƒ…å†µï¼Œå°±æ˜¯canSpinçš„ã€‚ ç„¶åŽè¿›è¡Œåˆ¤æ–­old&amp;mutexStarving == 0å°±æ˜¯ç¬¬ä¸‰ä½ä¸º0çš„æƒ…å†µï¼Œè¿˜æ˜¯æ‰€è¯´çš„æ­£å¸¸æ¨¡å¼ã€‚newå°±é©¬ä¸Šæ‹¿åˆ°é”äº†ï¼Œnew |= mutexLockedï¼Œè¡¨ç¤ºæˆ–1ï¼Œå°±æ˜¯ç¬¬ä¸€ä½æ— è®ºæ˜¯å•¥éƒ½èµ‹å€¼ä¸º1 old&amp;(mutexLocked|mutexStarving)ï¼Œä¹Ÿå°±æ˜¯old &amp; 0101å¿…é¡»å½“oldçš„1å’Œ3ä¸¤ä¸ªä½ç½®ä¸º1çš„æ—¶å€™æ‰æ˜¯trueï¼Œä¹Ÿå°±æ˜¯è¯´å½“å‰å¤„äºŽé¥¥é¥¿æ¨¡å¼ï¼Œå¹¶ä¸”é”å·²ç»è¢«å ç”¨çš„æƒ…å†µï¼Œé‚£ä¹ˆå°±éœ€è¦æŽ’é˜ŸåŽ»ã€‚æŽ’é˜Ÿä¹Ÿå¾ˆç²¾å¦™ï¼Œnew += 1 &lt;&lt; mutexWaiterShiftè¿™è¾¹æ³¨æ„æ˜¯å…ˆè®¡ç®—1 &lt;&lt; mutexWaiterShiftä¹Ÿå°±æ˜¯å°†newçš„å‰29ä½+1ï¼Œå°±æ˜¯è¡¨ç¤ºæœ‰ä¸€ä¸ªåç¨‹åœ¨ç­‰å¾…äº†ã€‚ å¥½äº†åˆ°è¿™é‡Œä½ çš„ä½æ“ä½œåº”è¯¥å°±ä¹ æƒ¯çš„å·®ä¸å¤šäº†ï¼Œä¹‹åŽæˆ‘å°±ç›´æŽ¥è¯´ç»“è®ºï¼Œä¸ä»”ç»†çš„å¸®ä½ 01è¡¨ç¤ºäº†ï¼Œä½ å·²ç»é•¿å¤§äº†ï¼Œè¦å­¦ä¼šè‡ªå·±åŠ¨æ‰‹äº†ã€‚ å¦‚æžœå½“å‰å·²ç»æ ‡è®°ä¸ºé¥¥é¥¿æ¨¡å¼ï¼Œå¹¶ä¸”æ²¡æœ‰é”ä½ï¼Œé‚£ä¹ˆè®¾ç½®newä¸ºé¥¥é¥¿æ¨¡å¼if starving &amp;&amp; old&amp;mutexLocked != 0 { new |= mutexStarving} å¦‚æžœå”¤é†’ï¼Œéœ€è¦åœ¨ä¸¤ç§æƒ…å†µä¸‹é‡è®¾æ ‡å¿—if awoke { å¦‚æžœå”¤é†’æ ‡å¿—ä¸ºä¸Žawokeä¸ç›¸åè°ƒå°±panic if new&amp;mutexWoken == 0 { throw(â€œsync: inconsistent mutex stateâ€) } è®¾ç½®å”¤é†’çŠ¶æ€ä½0,è¢«å”¤é†’ new &amp;^= mutexWoken} å¦‚æžœèŽ·å–é”æˆåŠŸ old&amp;(mutexLocked|mutexStarving) == 0æˆç«‹è¡¨ç¤ºå·²ç»èŽ·å–é”ï¼Œå°±ç›´æŽ¥é€€å‡ºCAS ä¸­é—´è¿™ä¸€æ®µæˆ‘å°±ä¸å¤šè§£é‡Šäº†ï¼Œå°±æ˜¯æœ€å‰é¢æ³¨é‡Šè¯´çš„ï¼Œæ»¡è¶³ä»€ä¹ˆæ¡ä»¶è½¬æ¢ä»€ä¹ˆæ¨¡å¼ï¼Œä¸å¤šè¯´äº†ã€‚ç„¶åŽä»Žé˜Ÿåˆ—ä¸­ï¼Œä¹Ÿå°±æ˜¯å‰29ä½-1ã€‚éœ€è¦æ³¨æ„å…¶ä¸­æœ‰ä¸€ä¸ªruntime_SemacquireMutexå’Œä¹‹å‰çœ‹çš„çš„runtime_Semacquireæ˜¯ä¸€ä¸ªæ„æ€ï¼Œåªæ˜¯å¤šäº†ä¸€ä¸ªå‚æ•°ã€‚è¿™ä¸ªå°±æ˜¯è¿™ä¸ªæ–¹æ³•çš„æ³¨é‡Šã€‚å¯ä»¥çœ‹åˆ°ï¼Œå°±æ˜¯å¤šäº†ä¸ªé˜Ÿåˆ—åŽ»æŽ’é˜Ÿã€‚ å¦‚æžœèŽ·å–é”å¤±è´¥ï¼Œoldåˆ·æ–°çŠ¶æ€å†æ¬¡å¾ªçŽ¯ï¼Œç»§ç»­cas UnLocké‡Šæ”¾é” Unlockå°±ç›¸å¯¹ç®€å•ä¸€äº›ï¼Œç«žæ€åˆ†æžä¸çœ‹ã€‚å…¶å®žæˆ‘ä»¬è‡ªå·±æƒ³ä¹Ÿèƒ½æƒ³åˆ°ï¼Œunlockå°±æ˜¯å°†æ ‡è¯†ä½æ”¹å›žæ¥å˜›ã€‚ç„¶åŽå› ä¸ºæˆ‘ä»¬å·²ç»çœ‹è¿‡è¯»å†™é”äº†ï¼Œä¹Ÿæ˜¯åŒæ ·çš„é“ç†ï¼Œå¦‚æžœæ²¡æœ‰ä¸Šé”å°±ç›´æŽ¥è§£é”ï¼Œé‚£è‚¯å®šæŠ¥é”™å˜›ã€‚ ç„¶åŽå¦‚æžœæ˜¯æ­£å¸¸æ¨¡å¼ï¼Œå¦‚æžœæ²¡æœ‰ç­‰å¾…çš„goroutineæˆ–goroutineå·²ç»è§£é”å®Œæˆçš„æƒ…å†µå°±ç›´æŽ¥è¿”å›žäº†ã€‚å¦‚æžœæœ‰ç­‰å¾…çš„goroutineé‚£å°±é€šè¿‡ä¿¡å·é‡åŽ»å”¤é†’runtime_Semreleaseï¼ˆæ³¨æ„è¿™é‡Œæ˜¯falseï¼‰ï¼ŒåŒæ—¶æ“ä½œä¸€ä¸‹é˜Ÿåˆ—-1 å¦‚æžœæ˜¯é¥¥é¥¿æ¨¡å¼å°±ç›´æŽ¥å”¤é†’ï¼ˆæ³¨æ„è¿™é‡Œæ˜¯trueï¼‰ï¼Œåæ­£æœ‰é˜Ÿåˆ—å˜›ã€‚ äº’æ–¥é”æ€»ç»“å…¶å®žè¯è¯´å›žæ¥ï¼Œæˆ‘ä»¬å…¶å®žçœ‹èµ·æ¥ä¹Ÿç®€å•ï¼Œæ²¡æœ‰å†²çªçš„æƒ…å†µä¸‹ï¼Œèƒ½æ‹¿å°±æ‹¿å‘—ï¼Œå¦‚æžœå‡ºçŽ°å†²çªäº†å°±å°è¯•è‡ªæ—‹è§£å†³ï¼ˆè‡ªæ—‹ä¸€èˆ¬éƒ½èƒ½è§£å†³ï¼‰å¦‚æžœè§£å†³ä¸äº†å°±é€šè¿‡ä¿¡å·é‡è§£å†³ï¼ŒåŒæ—¶å¦‚æžœæ­£å¸¸æ¨¡å¼å°±æ˜¯æˆ‘ä»¬è¯´çš„æŠ¢å å¼ï¼Œéžå…¬å¹³ï¼Œå¦‚æžœæ˜¯é¥¥é¥¿æ¨¡å¼ï¼Œå°±æ˜¯æˆ‘ä»¬è¯´çš„æŽ’é˜Ÿï¼Œå…¬å¹³ï¼Œé˜²æ­¢æœ‰ä¸€äº›å€’éœ‰è›‹ä¸€ç›´æŠ¢ä¸åˆ°ã€‚ æ•´ä½“æ€»ç»“ä¸€ä¸‹ï¼Œçœ‹å®Œæºç æˆ‘ä»¬å‘çŽ°ï¼Œå…¶å®žé”çš„è®¾è®¡å¹¶ä¸å¤æ‚ï¼Œä¸»è¦è®¾è®¡æˆ‘ä»¬è¦å­¦åˆ°caså’Œå¤„ç†è¯»å†™çŠ¶æ€çš„ä¿¡å·é‡é€šçŸ¥ï¼Œå¯¹äºŽé‚£äº›ä½æ“ä½œï¼Œèƒ½çœ‹æ‡‚ï¼Œå­¦å¯èƒ½ä¸€æ—¶åŠä¼šå­¦ä¸ä¼šï¼Œå› ä¸ºå¾ˆéš¾åœ¨ä¸€å¼€å§‹å°±è®¾è®¡çš„é‚£ä¹ˆå·§å¦™ï¼Œä½ ä¹Ÿä½“ä¼šåˆ°äº†åªç”¨ä¸€ä¸ªå˜é‡å°±ç»´æŠ¤äº†æ•´ä¸ªä½“ç³»æ˜¯ä¸€ç§è‰ºæœ¯ã€‚]]></content>
      <categories>
        <category>golangæºç è§£æž</category>
      </categories>
      <tags>
        <tag>RWMutex</tag>
        <tag>Mutex</tag>
      </tags>
  </entry>
</search>
