<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[Golangä¹‹context]]></title>
    <url>%2F2019%2F06%2F27%2Fgolang%2Fsource-code%2Fcontext-code-view%2F</url>
    <content type="text"><![CDATA[å½“æˆ‘ä»¬ä½¿ç”¨ä¸€äº›golangæ¡†æ¶çš„æ—¶å€™ï¼Œæ€»èƒ½åœ¨æ¡†æ¶ä¸­å‘ç°æœ‰ä¸ªå«åšcontextçš„ä¸œè¥¿ã€‚å¦‚æœä½ ä¹‹å‰äº†è§£è¿‡javaçš„springï¼Œé‚£ä¹ˆä½ è‚¯å®šä¹Ÿå¬è¯´è¿‡å…¶ä¸­æœ‰ä¸ªç‰›é€¼çš„ApplicationContextã€‚Contextè¿™ä¸ªä¸œè¥¿å¥½åƒéšæ—¶éšåœ°éƒ½åœ¨å‡ºç°ï¼Œåœ¨golangä¸­ä¹Ÿæ˜¯éå¸¸é‡è¦çš„å­˜åœ¨ã€‚ä»Šå¤©æˆ‘ä»¬å°±æ¥çœ‹çœ‹è¿™ä¸ªç¥å¥‡çš„Contextã€‚ å®šä¹‰ é¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“ä»€ä¹ˆæ˜¯contextï¼Ÿ å¾ˆå¤šäººæŠŠå®ƒç¿»è¯‘æˆä¸Šä¸‹æ–‡ï¼Œå…¶å®è¿™ä¸ªæ˜¯ä¸€ä¸ªå¾ˆéš¾æè¿°å¾ˆå®šä¹‰çš„ä¸œè¥¿ï¼Œå¯¹äºè¿™ç§ä¸œè¥¿ï¼Œæˆ‘ä¹ æƒ¯ç”¨åŠŸèƒ½å»å®šä¹‰å®ƒã€‚æˆ‘çš„å®šä¹‰æ˜¯ï¼šcontextæ˜¯ç”¨äºåœ¨å¤šä¸ªgoroutinesä¹‹é—´ä¼ é€’ä¿¡æ¯çš„åª’ä»‹ã€‚å®˜æ–¹å®šä¹‰ï¼šAt Google, we developed a context package that makes it easy to pass request-scoped values, cancelation signals, and deadlines across API boundaries to all the goroutines involved in handling a request. ç”¨æ³•åŒæ ·çš„æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å®ƒçš„ä¸€äº›åŸºæœ¬ç”¨æ³•ï¼Œå¤§è‡´äº†è§£å®ƒçš„ä½¿ç”¨ã€‚ ä¼ é€’ä¿¡æ¯123456func main() &#123; ctx := context.Background() ctx = context.WithValue(ctx, "xxx", "123") value := ctx.Value("xxx") fmt.Println(value)&#125; å…¶å®ä¼ é€’æ¶ˆæ¯å¾ˆç®€å•ï¼Œåªéœ€è¦é€šè¿‡context.WithValueæ–¹æ³•è®¾ç½®ï¼Œkey-valueç„¶åé€šè¿‡ctx.Valueæ–¹æ³•å–å€¼å°±å¯ä»¥äº†ã€‚ æš‚æ—¶ä¸ç”¨å…³å¿ƒcontext.Background()åªè¦çŸ¥é“contextæœ‰ä¼ é€’å€¼çš„åŠŸèƒ½å°±å¯ä»¥äº†ã€‚ å…³é—­goroutineåœ¨æˆ‘ä»¬å†™golangçš„æ—¶å€™goroutineæ˜¯ä¸€ä¸ªéå¸¸å¸¸ç”¨çš„ä¸œè¥¿ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šå¼€ä¸€ä¸ªgoroutineå»å¤„ç†å¯¹åº”çš„ä»»åŠ¡ï¼Œç‰¹åˆ«æ˜¯ä¸€äº›å¾ªç¯ä¸€ç›´å¤„ç†çš„æƒ…å†µï¼Œè¿™äº›goroutineéœ€è¦çŸ¥é“è‡ªå·±ä»€ä¹ˆæ—¶å€™è¦åœæ­¢ã€‚æˆ‘ä»¬å¸¸è§çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ä¸€ä¸ªchannelå»æ¥æ”¶ä¸€ä¸ªå…³é—­çš„ä¿¡å·ï¼Œæ”¶åˆ°ä¿¡å·ä¹‹åå…³é—­ï¼Œæˆ–è€…è¯´ï¼Œéœ€è¦ä¸€ä¸ªæ ‡è¯†ç¬¦ï¼Œæ¯ä¸ªgoroutineå»åˆ¤æ–­è¿™ä¸ªæ ‡è¯†ç¬¦çš„å˜æ›´ä»è€Œå¾—çŸ¥ä»€ä¹ˆæ—¶å€™å…³é—­ã€‚é‚£ä¹ˆç”¨contextå¦‚ä½•å®ç°å‘¢ï¼Ÿ 12345678910111213141516171819202122232425262728293031323334func main() &#123; ctx, _ := context.WithTimeout(context.Background(), time.Second * 3) go func() &#123; go1(ctx) &#125;() go func() &#123; go2(ctx) &#125;() time.Sleep(time.Second * 5)&#125;func go1(ctx context.Context) &#123; for &#123; fmt.Println("1 æ­£åœ¨å·¥ä½œ") select &#123; case &lt;-ctx.Done(): fmt.Println("1 åœæ­¢å·¥ä½œ") return case &lt;-time.After(time.Second): &#125; &#125;&#125;func go2(ctx context.Context) &#123; for &#123; fmt.Println("2 æ­£åœ¨å·¥ä½œ") select &#123; case &lt;-ctx.Done(): fmt.Println("2 åœæ­¢å·¥ä½œ") return case &lt;-time.After(time.Second): &#125; &#125;&#125; é€šè¿‡context.WithTimeoutæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª3ç§’åè‡ªåŠ¨å–æ¶ˆçš„contextï¼›æ‰€æœ‰å·¥ä½œgoroutineç›‘å¬ctx.Done()çš„ä¿¡å·ï¼›æ”¶åˆ°ä¿¡å·å°±è¯æ˜éœ€è¦å–æ¶ˆä»»åŠ¡ï¼› å…¶å®ä½¿ç”¨èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹å†…éƒ¨çš„åŸç†ã€‚ æºç è§£æåˆ›å»ºcontext.TODO()è¿™ä¸ªå°±æ˜¯åˆ›å»ºä¸€ä¸ªå ä½ç”¨çš„contextï¼Œå¯èƒ½åœ¨å†™ç¨‹åºçš„è¿‡ç¨‹ä¸­è¿˜ä¸èƒ½ç¡®å®šåæœŸè¿™ä¸ªcontextçš„ä½œç”¨ï¼Œæ‰€ä»¥æš‚æ—¶ç”¨è¿™ä¸ªå ä½ context.Background()è¿™ä¸ªæ˜¯æœ€å¤§çš„contextï¼Œä¹Ÿå°±æ˜¯æ ¹contextï¼Œè¿™é‡Œå°±æœ‰å¿…è¦è¯´ä¸€ä¸‹contextçš„æ•´ä¸ªæ„æˆäº†ï¼Œcontextå…¶å®æ„æˆçš„æ˜¯ä¸€æ£µæ ‘ï¼ŒBackgroundä¸ºæ ¹èŠ‚ç‚¹ï¼Œæ¯æ¬¡åˆ›å»ºä¸€ä¸ªæ–°çš„contextå°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„èŠ‚ç‚¹åŠ å…¥è¿™æ£µæ ‘ã€‚ context.WithTimeout()æ¯”å¦‚è¿™ä¸ªæ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ªè‡ªåŠ¨è¿‡æœŸçš„context12345678910111213// WithTimeout returns WithDeadline(parent, time.Now().Add(timeout)).//// Canceling this context releases resources associated with it, so code should// call cancel as soon as the operations running in this Context complete://// func slowOperationWithTimeout(ctx context.Context) (Result, error) &#123;// ctx, cancel := context.WithTimeout(ctx, 100*time.Millisecond)// defer cancel() // releases resources if slowOperation completes before timeout elapses// return slowOperation(ctx)// &#125;func WithTimeout(parent Context, timeout time.Duration) (Context, CancelFunc) &#123; return WithDeadline(parent, time.Now().Add(timeout))&#125; å¯ä»¥çœ‹åˆ°éœ€è¦ä¼ å…¥ä¸€ä¸ªparentï¼Œå’Œè¿‡æœŸæ—¶é—´ï¼Œæ–°åˆ›å»ºçš„contextå°±æ˜¯parentçš„å­èŠ‚ç‚¹ã€‚123456789101112131415161718192021222324func WithDeadline(parent Context, d time.Time) (Context, CancelFunc) &#123; if cur, ok := parent.Deadline(); ok &amp;&amp; cur.Before(d) &#123; // The current deadline is already sooner than the new one. return WithCancel(parent) &#125; c := &amp;timerCtx&#123; cancelCtx: newCancelCtx(parent), deadline: d, &#125; propagateCancel(parent, c) dur := time.Until(d) if dur &lt;= 0 &#123; c.cancel(true, DeadlineExceeded) // deadline has already passed return c, func() &#123; c.cancel(true, Canceled) &#125; &#125; c.mu.Lock() defer c.mu.Unlock() if c.err == nil &#123; c.timer = time.AfterFunc(dur, func() &#123; c.cancel(true, DeadlineExceeded) &#125;) &#125; return c, func() &#123; c.cancel(true, Canceled) &#125;&#125; æ³¨æ„å…¶ä¸­cancelCtx: newCancelCtx(parent),å…¶å®æ˜¯åˆ›å»ºäº†ä¸€ä¸ªå¯ä»¥å–æ¶ˆçš„ctxï¼Œç„¶ååˆ©ç”¨time.AfterFuncæ¥å®ç°å®šæ—¶è‡ªåŠ¨è¿‡æœŸã€‚ è¿˜æœ‰ä¸€ä¸ªç»†èŠ‚c.mu.Lock()defer c.mu.Unlock()è¿™ä¸ªmuæ¥è‡ªï¼š12345678type cancelCtx struct &#123; Context mu sync.Mutex // protects following fields done chan struct&#123;&#125; // created lazily, closed by first cancel call children map[canceler]struct&#123;&#125; // set to nil by the first cancel call err error // set to non-nil by the first cancel call&#125; è¿™ä¸ªcontextå› ä¸ºæœ‰äº†é”ï¼Œæ‰€ä»¥æ˜¯å¹¶å‘å®‰å…¨çš„ã€‚ å–æ¶ˆ12345678910111213141516171819202122232425262728// cancel closes c.done, cancels each of c's children, and, if// removeFromParent is true, removes c from its parent's children.func (c *cancelCtx) cancel(removeFromParent bool, err error) &#123; if err == nil &#123; panic("context: internal error: missing cancel error") &#125; c.mu.Lock() if c.err != nil &#123; c.mu.Unlock() return // already canceled &#125; c.err = err if c.done == nil &#123; c.done = closedchan &#125; else &#123; close(c.done) &#125; for child := range c.children &#123; // NOTE: acquiring the child's lock while holding parent's lock. child.cancel(false, err) &#125; c.children = nil c.mu.Unlock() if removeFromParent &#123; removeChild(c.Context, c) &#125;&#125; å½“è¾¾åˆ°è¿‡æœŸæ—¶é—´æˆ–è€…è°ƒç”¨cancelFuncçš„æ—¶å€™å°±ä¼šè§¦å‘contextçš„å–æ¶ˆï¼Œç„¶åçœ‹åˆ°ä¸Šé¢çš„æºç ä½ å°±æ˜ç™½äº†ï¼Œå–æ¶ˆçš„æ—¶å€™æœ‰ä¸€ä¸ªä¸‰ä¸ªæ“ä½œï¼š c.mu.Lock() åŠ é”ä¿è¯å®‰å…¨ close(c.done) å°†doneä¿¡é“å…³é—­ï¼Œä»è€Œæ‰€æœ‰åœ¨è§‚å¯Ÿdoneä¿¡é“çš„goroutineéƒ½çŸ¥é“è¦å…³é—­äº† for child := range c.children å¾ªç¯æ¯ä¸ªå­èŠ‚ç‚¹ï¼Œå…³é—­æ¯ä¸ªå­èŠ‚ç‚¹ã€‚æˆ‘ä»¬çŸ¥é“contextçš„ç»“æ„æ˜¯æ ‘çŠ¶çš„ï¼Œæ‰€ä»¥åŒæ—¶æˆ‘ä»¬è¦æ³¨æ„çˆ¶èŠ‚ç‚¹å¦‚æœå…³é—­ä¼šå…³é—­å­èŠ‚ç‚¹çš„contextã€‚ WithValueå’ŒValue1234type valueCtx struct &#123; Context key, val interface&#123;&#125;&#125; é¦–å…ˆvalueCtxçš„ç»“æ„å¦‚ä¸Šæ‰€ç¤ºï¼ŒåŒ…å«ä¸€ä¸ªContextå’Œkey-val 123456789func WithValue(parent Context, key, val interface&#123;&#125;) Context &#123; if key == nil &#123; panic("nil key") &#125; if !reflect.TypeOf(key).Comparable() &#123; panic("key is not comparable") &#125; return &amp;valueCtx&#123;parent, key, val&#125;&#125; å…¶å®è¿™ä¸ªæ–¹æ³•å¾ˆç®€å•ï¼Œå°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ªparentçš„æ‹·è´ï¼Œå¹¶ä¸”å°†å¯¹åº”çš„keyå’Œvalæ”¾è¿›å»ã€‚ 123456func (c *valueCtx) Value(key interface&#123;&#125;) interface&#123;&#125; &#123; if c.key == key &#123; return c.val &#125; return c.Context.Value(key)&#125; Valueæ–¹æ³•å°±æ›´ç®€å•äº†ï¼Œå°±æ˜¯åˆ¤æ–­å½“å‰keyæ˜¯å¦åŒ¹é…ï¼Œå¦‚æœä¸åŒ¹é…å°±å»å­èŠ‚ç‚¹å¯»æ‰¾ã€‚ æ¡ˆä¾‹æœ€åæˆ‘ä»¬æ¥çœ‹çœ‹åœ¨å®é™…çš„ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åœ¨å“ªé‡Œä½¿ç”¨åˆ°äº†contextï¼Œæˆ‘ä¸¾ä¸¤ä¸ªå®é™…ä¸­å¸¸ç”¨çš„æ¡†æ¶ginå’Œetcd ginginæ˜¯ä¸€ä¸ªwebæ¡†æ¶ï¼Œåœ¨webå¼€å‘çš„æ—¶å€™éå¸¸å®ç”¨ã€‚1234567891011121314func main() &#123; router := gin.Default() router.POST("/post", func(c *gin.Context) &#123; id := c.Query("id") page := c.DefaultQuery("page", "0") name := c.PostForm("name") message := c.PostForm("message") fmt.Printf("id: %s; page: %s; name: %s; message: %s", id, page, name, message) &#125;) router.Run(":8080")&#125; å…¶å®å¾ˆå¤šwebæ¡†æ¶éƒ½æœ‰Contextï¼Œä»–ä»¬éƒ½è‡ªå·±å°è£…äº†ä¸€ä¸ªContextï¼Œåˆ©ç”¨è¿™ä¸ªContextå¯ä»¥åšåˆ°ä¸€ä¸ªrequest-scopeä¸­çš„å‚æ•°ä¼ é€’å’Œè¿”å›ï¼Œè¿˜æœ‰å¾ˆå¤šæ“ä½œé€šé€šéƒ½å¯ä»¥ç”¨Contextæ¥å®Œæˆã€‚ etcdå¦‚æœä½ æ²¡æœ‰äº†è§£è¿‡etcdä½ å°±å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆredisï¼Œå®ƒå…¶å®æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„k-væ•°æ®å­˜å‚¨æˆ‘ä»¬åœ¨ä½¿ç”¨etcdè¿›è¡Œæ“ä½œï¼ˆputæˆ–delç­‰ï¼‰çš„æ—¶å€™ï¼Œéœ€è¦ä¼ å…¥contextå‚æ•°12345678timeoutCtx, cancel := context.WithTimeout(context.Background(), 2 * time.Second)defer cancel()putResponse, err := client.Put(timeoutCtx, "aaa", "xxx")if err != nil &#123; fmt.Println(err) return&#125;fmt.Println(putResponse.Header.String()) è¿™é‡Œä¼ å…¥çš„contextæ˜¯ä¸€ä¸ªè¶…æ—¶è‡ªåŠ¨å–æ¶ˆçš„contextï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“putæ“ä½œè¶…è¿‡ä¸¤ç§’åè¿˜æ²¡æœ‰æ‰§è¡ŒæˆåŠŸçš„è¯ï¼Œcontextå°±ä¼šè‡ªåŠ¨doneï¼ŒåŒæ—¶è¿™ä¸ªæ“ä½œä¹Ÿå°†è¢«å–æ¶ˆã€‚ å› ä¸ºæˆ‘ä»¬åœ¨ä½¿ç”¨etcdçš„æ—¶å€™ï¼Œå¦‚æœå½“å‰ç½‘ç»œå‡ºç°å¼‚å¸¸ï¼Œæ— æ³•è¿æ¥åˆ°èŠ‚ç‚¹ï¼Œæˆ–è€…æ˜¯èŠ‚ç‚¹æ•°é‡ä¸è¶³çš„æ—¶å€™ï¼Œéƒ½ä¼šå‡ºç°æ“ä½œè¢«hangä½ï¼Œå¦‚æœæ²¡æœ‰å®šæ—¶å–æ¶ˆçš„æœºåˆ¶ï¼Œæˆ–è€…æ‰‹åŠ¨å–æ¶ˆï¼Œé‚£ä¹ˆå½“å‰goroutineä¼šè¢«ä¸€ç›´å ç”¨ã€‚æ‰€ä»¥å°±åˆ©ç”¨contextæ¥å®Œæˆè¿™ä¸ªæ“ä½œã€‚ æ€»ç»“ contextåœ¨webå¼€å‘ä¸­ï¼Œä½ å¯ä»¥ç±»æ¯”javaä¸­çš„ThreadLocalï¼Œåˆ©ç”¨å®ƒæ¥å®Œæˆä¸€ä¸ªrequest-scopeä¸­å‚æ•°çš„ä¼ é€’ contextå¯ä»¥ç”¨äºå¤šä¸ªgoroutineä¹‹é—´çš„å‚æ•°ä¼ é€’ contextè¿˜å¯ä»¥ä½œä¸ºå®Œæˆä¿¡å·çš„é€šçŸ¥ contextå¹¶å‘å®‰å…¨ å…¶å®ï¼Œæˆ‘ä»¬ä¸ä»…è¦å­¦åˆ°contextçš„ä½¿ç”¨ï¼Œè¿˜å¯ä»¥å­¦åˆ°è¿™æ ·è®¾è®¡ä¸€ä¸ªç³»ç»Ÿçš„ä¼˜ç‚¹ï¼Œå¦‚æœä»¥åè‡ªå·±åœ¨è®¾è®¡ä¸€äº›æ¡†æ¶å’Œç³»ç»Ÿçš„æ—¶å€™å¯ä»¥æœ‰æ›´å¤šçš„æƒ³æ³•ã€‚]]></content>
      <categories>
        <category>golangæºç è§£æ</category>
      </categories>
      <tags>
        <tag>context</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Golangä¹‹reflect]]></title>
    <url>%2F2019%2F06%2F25%2Fgolang%2Fsource-code%2Freflect-code-view%2F</url>
    <content type="text"><![CDATA[åå°„ â€”â€” å¦‚æœä½ ä¹‹å‰å­¦è¿‡ä¸€äº›åˆ«çš„è¯­è¨€ï¼Œæ¯”å¦‚javaå¯èƒ½å°±ä¼šäº†è§£ï¼Œåå°„æ˜¯ä¸€ä¸ªä¼ è¯´ä¸­å¾ˆå‰å®³çš„æ“ä½œï¼Œç®—æ˜¯ä¸€ä¸ªé«˜çº§ç”¨æ³•ã€‚è€ŒåŒæ—¶ï¼Œå¾ˆå¤šäººä¹Ÿä¼šå‘Šè¯‰ä½ ï¼Œåå°„æ˜¯ä¸€ä¸ªå±é™©çš„æ“ä½œï¼Œé‚£ä¹ˆåœ¨golangä¸­ï¼Œåå°„åˆæ˜¯æ€ä¹ˆæ“ä½œçš„å‘¢ï¼Ÿä»Šå¤©å°±æ¥è¯´è¯´golangä¸­çš„åå°„reflectã€‚ åå°„çš„å®šä¹‰é¦–å…ˆé—®é—®è‡ªå·±ï¼Œä½ çŸ¥é“ä»€ä¹ˆæ˜¯åå°„å—ï¼Ÿå¦‚æœä½ æœ‰ä¸€ä¸ªæ¸…æ¥šçš„å®šä¹‰ï¼Œè¯æ˜ä½ å·²ç»å¯¹åå°„éå¸¸ç†Ÿæ‚‰äº†ã€‚å®˜æ–¹çš„å®šä¹‰å¾ˆå®˜æ–¹ï¼Œæˆ‘å°±è¯´è¯´æˆ‘çš„ï¼šåå°„ï¼Œåå°„ï¼Œä»å­—é¢ç†è§£å°±æ˜¯é€šè¿‡é•œå­ï¼ˆæˆ–ç±»ä¼¼çš„ä¸œè¥¿ï¼‰çœ‹åˆ°è‡ªå·±ã€‚è€Œåœ¨ç¼–ç¨‹ä¸­ï¼Œåå°„æŒ‡çš„æ˜¯åœ¨è¿è¡Œçš„è¿‡ç¨‹ä¸­çœ‹åˆ°è‡ªå·±ã€‚åœ¨å®é™…çš„ç¼–ç¨‹è¿‡ç¨‹ä¸­æˆ‘ä»¬çŸ¥é“ï¼Œåˆ›å»ºçš„è¿™ä¸ªå˜é‡æˆ–è€…å¯¹è±¡æ˜¯ä»€ä¹ˆç±»å‹æˆ–è€…æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼ŒåŒæ—¶å¾ˆå®¹æ˜“èƒ½å¯¹å®ƒè¿›è¡Œæ“ä½œã€‚è€Œåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œç¨‹åºæ²¡æœ‰æˆ‘ä»¬çš„çœ¼ç›ï¼Œå®ƒå¹¶ä¸çŸ¥é“è¿™ä¸ªä¸œè¥¿æ˜¯æ€ä¹ˆæ ·çš„ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦è¿ç”¨åˆ°åå°„ã€‚é€šè¿‡åå°„æˆ‘å¯ä»¥çŸ¥é“è‡ªå·±é•¿ä»€ä¹ˆæ ·å­ã€‚ åå°„çš„ä½¿ç”¨reflect.TypeOfå¦‚æœä½ å¯¹åå°„è¿˜æ˜¯æœ‰äº›æ¨¡ç³Šï¼Œé‚£ä¹ˆçœ‹ä¸‹é¢è¿™ä¸ªæœ€ç®€å•çš„ä¾‹å­1234func main() &#123; a := 1.3 fmt.Println("açš„ç±»å‹æ˜¯", reflect.TypeOf(a))&#125; è¾“å‡º1açš„ç±»å‹æ˜¯ float64 æ˜¯ä¸æ˜¯ç¬é—´æ˜ç™½äº†ï¼Œæ²¡é”™ï¼Œåå°„æ²¡æœ‰é‚£ä¹ˆå¤æ‚ã€‚ä½ æƒ³æƒ³ï¼Œä½œä¸ºç¨‹åºè‡ªå·±ï¼Œæˆ‘è¿è¡Œä¸­ï¼Œæˆ‘æ€ä¹ˆçŸ¥é“aæ˜¯ä»€ä¹ˆç±»å‹ï¼Œåªèƒ½é€šè¿‡ç…§é•œå­ï¼ˆåå°„ï¼‰å¾—åˆ°ã€‚ ä¸‹é¢å†è¯´è¯´ä¸€äº›æ›´é«˜çº§çš„ç”¨æ³•ã€‚ reflect.ValueOf1234567func main() &#123; type MyInt int var x MyInt = 7 v := reflect.ValueOf(x) fmt.Println(v.Type()) fmt.Println(v.Kind())&#125; è¾“å‡º12main.MyIntint è¿™é‡Œæˆ‘ä»¬é€šè¿‡reflect.ValueOfæ–¹æ³•æ‹¿åˆ°çš„vï¼Œå…¶ä¸­v.Type()æ‹¿åˆ°çš„æ˜¯å®ƒå½“å‰çš„ç±»å‹ï¼Œè€Œv.Kind()å¯ä»¥æ‹¿åˆ°å®ƒæœ€åŸºæœ¬çš„ç±»å‹ã€‚ Elem()1234567func main() &#123; a := 1.3 v := reflect.ValueOf(&amp;a) elem := v.Elem() elem.SetFloat(0.2) fmt.Println(a)&#125; è¾“å‡º10.2 è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡åå°„æ‹¿åˆ°vä½¿ç”¨v.Elem()æ–¹æ³•å¯ä»¥æ‹¿åˆ°å¯¹åº”æŒ‡é’ˆè¿›è¡Œæ“ä½œèµ‹å€¼ Field()1234567891011121314151617type MyData struct &#123; A int b float32&#125; func main() &#123; myData := MyData&#123; A: 1, b: 1.1, &#125; myDataV := reflect.ValueOf(&amp;myData).Elem() fmt.Println("å­—æ®µa:", myDataV.Field(0)) fmt.Println("å­—æ®µb:", myDataV.Field(1)) fmt.Println(myDataV) myDataV.Field(0).SetInt(2) fmt.Println(myDataV)&#125; è¾“å‡º1234å­—æ®µa: 1å­—æ®µb: 1.1&#123;1 1.1&#125;&#123;2 1.1&#125; è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬å³ä½¿ä¸çŸ¥é“ä¸€ä¸ªç»“æ„ä½“é‡Œé¢çš„æƒ…å†µï¼Œæˆ‘ä»¬ä¾æ—§å¯ä»¥é€šè¿‡Fieldæ–¹æ³•è·å¾—å…¶ä¸­çš„å€¼ï¼Œå¹¶ä¸”å¦‚æœè¿™ä¸ªå˜é‡å¯ä»¥è¢«å¤–ç•Œè®¿é—®é‚£ä¹ˆè¿˜å¯ä»¥ä¿®æ”¹ã€‚ Interface()123456func main() &#123; a := 1.3 v := reflect.ValueOf(a) a1 := v.Interface().(float64) fmt.Println(a1)&#125; 1.31açš„ç±»å‹æ˜¯ float64 åå°„ä¹‹åçš„å¯¹è±¡é€šè¿‡Interfaceè¿˜å¯ä»¥è½¬æ¢å›æ¥ åå°„çš„æ³•åˆ™ä¸Šé¢å°±æ˜¯ä¸€äº›åå°„çš„åŸºæœ¬ç”¨æ³•ï¼Œå¸¸ç”¨çš„å°±æ˜¯è·å–ä¸€ä¸ªå¯¹è±¡åœ¨è¿è¡Œä¸­çš„ä¸€ä¸ªçŠ¶æ€ï¼Œæˆ–è€…æ˜¯é’ˆå¯¹è¿è¡Œä¸­çš„ä¸€ä¸ªä¸ç¡®å®šçš„å¯¹è±¡è¿›è¡Œä¿®æ”¹ã€‚ä¸‹é¢è¦è¯´çš„æ˜¯åå°„çš„æ³•åˆ™ã€‚å¦‚æœä½ è‹±æ–‡å¤Ÿå¥½ï¼Œå¹¶ä¸”ç½‘ç»œè‡ªç”±ï¼Œå¯ä»¥çœ‹çœ‹golangå®˜æ–¹çš„åšå®¢ï¼šhttps://blog.golang.org/laws-of-reflectioné‡Œé¢è¯¦ç»†æè¿°äº†åå°„çš„ä¸‰ä¸ªæ³•åˆ™ï¼Œå¦‚æœä½ çœ‹ä¸åˆ°ï¼Œé‚£å°±åªèƒ½å¬æˆ‘ä¸‹é¢å¹ä¸€å¹äº†ã€‚ Reflection goes from interface value to reflection object. Reflection goes from reflection object to interface value. To modify a reflection object, the value must be settable. è¿™ä¸‰ä¸ªå°±æ˜¯å®˜æ–¹ç»™å‡ºçš„æ³•åˆ™ï¼Œæˆ‘åˆ†åˆ«ç”¨è‡ªå·±çš„è¯è§£é‡Šä¸€ä¸‹ã€‚ åå°„å°±æ˜¯å°†ä»»æ„å€¼è½¬æ¢ä¸ºåå°„å¯¹è±¡åœ¨golangä¸­æˆ‘ä»¬çŸ¥é“interfaceå°±å’Œjavaä¸­çš„Objectç±»ä¼¼ï¼ˆåªæ˜¯ç±»ä¼¼è€Œå·²ï¼‰ï¼Œä»£è¡¨äº†æ‰€æœ‰ç±»å‹ï¼ŒreflectåŒ…æ­£æ˜¯å¸®æˆ‘ä»¬å°†ä»»æ„çš„ä¸€ä¸ªç±»å‹è½¬æ¢æˆäº†æˆ‘ä»¬ä¸Šé¢ä¾‹å­ä¸­çœ‹åˆ°çš„ä¸€ä¸ªvï¼Œè¿™ä¸ªvå°±æ˜¯åå°„å¯¹è±¡ã€‚é€šè¿‡è¿™ä¸ªåå°„å¯¹è±¡ä¸­çš„ä¸€äº›æ–¹æ³•æˆ‘ä»¬æ‰èƒ½çœ‹è§åŸæ¥çš„å¯¹è±¡æ˜¯ä»€ä¹ˆæ ·å­ã€‚ åå°„å¯¹è±¡å¯ä»¥è½¬æ¢ä¸ºä»»æ„å¯¹è±¡è¿™ä¸ªæ­£å¥½ä¸ç¬¬ä¸€ä¸ªç›¸åï¼Œå°±åƒæœ€åä¸€ä¸ªä¾‹å­ä¸­ç»™å‡ºçš„ï¼Œåå°„è·å¾—çš„åå°„å¯¹è±¡å¯ä»¥é€šè¿‡Interfaceæ–¹æ³•è½¬æ¢ä¸ºåŸæ¥çš„å¯¹è±¡ã€‚ å¦‚æœä½ è¦ä¿®æ”¹åå°„å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å¿…é¡»è¦å¯ä»¥è¢«ä¿®æ”¹ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå°±å¦‚åŒè¿™ä¸ªæ¡ˆä¾‹ä¸­1234567func main() &#123; a := 1.3 v := reflect.ValueOf(&amp;a) elem := v.Elem() elem.SetFloat(0.2) fmt.Println(a)&#125; å¦‚æœæˆ‘ä»¬ä¼ é€’çš„å¹¶éaçš„åœ°å€å¹¶ä¸”ç›´æ¥ä½¿ç”¨v.SetFloaté‚£ä¹ˆå°±ä¼šæŠ¥é”™ï¼Œå› ä¸ºæˆ‘ä»¬æ— æ³•å¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼Œåå°„ä¼šå¸®æˆ‘ä»¬copyä¸€ä¸ªï¼Œæ‰€ä»¥æ— æ³•ä¿®æ”¹ï¼Œåªæœ‰å½“æˆ‘ä»¬ä½¿ç”¨æŒ‡é’ˆçš„æ—¶å€™æ‰èƒ½ä¿®æ”¹ã€‚ åŒæ ·çš„ï¼Œå’Œæ¡ˆä¾‹ä¸­çš„ç»“æ„ä½“æ“ä½œä¸€æ ·ï¼Œå¦‚æœä¸€ä¸ªç»“æ„ä½“çš„å˜é‡æ˜¯å°å†™çš„è€Œä¸æ˜¯å¤§å†™çš„ï¼Œè¯æ˜å¤–ç•Œæ²¡æœ‰åŠæ³•è®¿é—®åˆ°ï¼Œæ‰€ä»¥ä¹Ÿæ²¡æœ‰åŠæ³•ä¿®æ”¹ï¼Œä¹Ÿä¼šå‡ºç°å¼‚å¸¸ã€‚ åå°„çš„åŸç†ä¸‹é¢å°±éœ€è¦çœ‹çœ‹åœ¨æºç ä¸­ï¼Œåå°„åˆ°åº•æ˜¯æ€ä¹ˆå®ç°çš„äº†ã€‚æˆ‘ä»¬ç€é‡çœ‹ä¸¤ä¸ªæ–¹æ³•TypeOfå’ŒValueOf TypeOf123456// TypeOf returns the reflection Type that represents the dynamic type of i.// If i is a nil interface value, TypeOf returns nil.func TypeOf(i interface&#123;&#125;) Type &#123; eface := *(*emptyInterface)(unsafe.Pointer(&amp;i)) return toType(eface.typ)&#125; æˆ‘ä»¬å…ˆæ¥çœ‹è¿™ä¸ªç®€å•çš„TypeOfçœ‹åˆ°æºç ä¸­å¾ˆç®€å•ï¼Œé€šè¿‡unsafe.Pointerè·å¾—æŒ‡é’ˆè½¬æ¢æˆemptyInterfaceç±»å‹12345// emptyInterface is the header for an interface&#123;&#125; value.type emptyInterface struct &#123; typ *rtype word unsafe.Pointer&#125; ç„¶åé€šè¿‡toTypeæ–¹æ³•å¾—åˆ°å…·ä½“ç±»å‹123456func toType(t *rtype) Type &#123; if t == nil &#123; return nil &#125; return t&#125; å…¶ä¸­Typeå°±åŒ…å«äº†æ‰€æœ‰çš„ä¿¡æ¯ï¼Œç„¶åè¿”å›å‡ºå»å°±å®Œæˆäº†ã€‚ ValueOf123456789101112131415// ValueOf returns a new Value initialized to the concrete value// stored in the interface i. ValueOf(nil) returns the zero Value.func ValueOf(i interface&#123;&#125;) Value &#123; if i == nil &#123; return Value&#123;&#125; &#125; // TODO: Maybe allow contents of a Value to live on the stack. // For now we make the contents always escape to the heap. It // makes life easier in a few places (see chanrecv/mapassign // comment below). escapes(i) return unpackEface(i)&#125; ä¸Šé¢nilå°±ä¸è¯´äº†ï¼Œä¸»è¦æ–¹æ³•æ˜¯ä¸‹é¢unpackEface1234567891011121314// unpackEface converts the empty interface i to a Value.func unpackEface(i interface&#123;&#125;) Value &#123; e := (*emptyInterface)(unsafe.Pointer(&amp;i)) // NOTE: don't read e.word until we know whether it is really a pointer or not. t := e.typ if t == nil &#123; return Value&#123;&#125; &#125; f := flag(t.Kind()) if ifaceIndir(t) &#123; f |= flagIndir &#125; return Value&#123;t, e.word, f&#125;&#125; æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¶å®ä¸TypeOfä¸€æ ·ï¼Œåªä¸è¿‡å¤šå°è£…äº†ä¸€å±‚Valueï¼Œå…¶ä¸­çš„wordå°±æ˜¯å½“å‰å¯¹è±¡çš„æŒ‡é’ˆï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“é€šè¿‡TypeOfå¾—åˆ°çš„Valueå¯ä»¥ç”¨å¾ˆå¤šæ“ä½œã€‚12345// emptyInterface is the header for an interface&#123;&#125; value.type emptyInterface struct &#123; typ *rtype word unsafe.Pointer&#125; åå°„çš„æ„ä¹‰è¯´äº†è¿™ä¹ˆå¤šï¼Œé‚£ä¹ˆåå°„å­˜åœ¨çš„æ„ä¹‰åˆ°åº•åœ¨å“ªï¼Ÿè¯´ç™½äº†ï¼Œæˆ‘ä»¬åœ¨å†™ä»£ç çš„æ—¶å€™ä»€ä¹ˆæ—¶å€™èƒ½ç”¨ä¸Šå®ƒï¼Ÿè¿˜æ˜¯ä¸¾ä¸ªä¾‹å­ä½ å°±æ˜ç™½äº†ã€‚ json.Marshalæ¡ˆä¾‹json.Marshalè¿™ä¸ªæ–¹æ³•ç”¨è¿‡å§ï¼Œæ˜¯å°†ä»»æ„å¯¹è±¡è½¬æ¢æˆjsonï¼Œè¿™ä¸ªæ¡ˆä¾‹å°±è¶³ä»¥è¯´æ˜åå°„çš„å‰å®³äº†ã€‚æˆ‘ä»¬å…ˆè‡ªå·±æƒ³ä¸€ä¸‹ï¼Œå¦‚æœè¦å°†ä¸€ä¸ªå¯¹è±¡è½¬æ¢æˆjsonï¼š æˆ‘ä»¬è¿è¡Œä¹‹å‰å…¶å®æ˜¯ä¸çŸ¥é“ä¼ å…¥å¯¹è±¡çš„ç±»å‹ï¼Œè€Œä¸”ä¼ å…¥çš„å¯¹è±¡ä¸åŒï¼Œé‚£ä¹ˆè§£ææ–¹å¼è‚¯å®šä¸åŒï¼Œå¦‚æœä¼ å…¥çš„æ˜¯mapæˆ–è€…ä¼ å…¥çš„æ˜¯structè‚¯å®šè§£ææ–¹å¼ä¸åŒï¼Œæ‰€ä»¥æ–¹æ³•å†…éƒ¨éœ€è¦åŠ¨æ€çš„åˆ¤æ–­ä¼ å…¥ç±»å‹ä»è€Œåšæ“ä½œã€‚ è¿˜æœ‰æˆ‘ä»¬ä¸çŸ¥é“ä¼ å…¥çš„structå†…éƒ¨çš„å±æ€§é•¿ä»€ä¹ˆæ ·å­ã€‚ è¿™ä¸ªæ—¶å€™åå°„å°±èƒ½è§£å†³è¿™æ ·çš„é—®é¢˜ï¼Œé€šè¿‡åå°„å¯ä»¥çŸ¥é“ä¼ å…¥å¯¹è±¡çš„ç±»å‹ï¼Œæ ¹æ®ä¸åŒçš„ç±»å‹åšæ“ä½œï¼ŒåŒæ—¶å¯ä»¥è·å–åˆ°å¦‚structè¿™æ ·ç±»å‹å†…éƒ¨çš„å­—æ®µå±æ€§å’Œå€¼åˆ†åˆ«æ˜¯å¤šå°‘ã€‚ json.Marshalæºç åˆ†æå› ä¸ºæ‰€æœ‰æºç å¤ªå¤šï¼Œæˆ‘ç»™å‡ºæŸ¥çœ‹è·¯çº¿ï¼Œç„¶åç»™å‡ºä¸Šé¢æ‰€è¿°çš„ä¸¤å¤„é‡ç‚¹ã€‚json.Marshal -&gt; e.marshal -&gt; e.reflectValue -&gt; valueEncoder -&gt; typeEncoder -&gt; newTypeEncoder -&gt; newStructEncoder -&gt; se.encode è¦ç‚¹1 - newTypeEncoder12345678910111213141516171819202122232425262728293031323334// newTypeEncoder constructs an encoderFunc for a type.// The returned encoder only checks CanAddr when allowAddr is true.func newTypeEncoder(t reflect.Type, allowAddr bool) encoderFunc &#123; ........... switch t.Kind() &#123; case reflect.Bool: return boolEncoder case reflect.Int, reflect.Int8, reflect.Int16, reflect.Int32, reflect.Int64: return intEncoder case reflect.Uint, reflect.Uint8, reflect.Uint16, reflect.Uint32, reflect.Uint64, reflect.Uintptr: return uintEncoder case reflect.Float32: return float32Encoder case reflect.Float64: return float64Encoder case reflect.String: return stringEncoder case reflect.Interface: return interfaceEncoder case reflect.Struct: return newStructEncoder(t) case reflect.Map: return newMapEncoder(t) case reflect.Slice: return newSliceEncoder(t) case reflect.Array: return newArrayEncoder(t) case reflect.Ptr: return newPtrEncoder(t) default: return unsupportedTypeEncoder &#125;&#125; é€šè¿‡åå°„è·å¾—ä¼ å…¥å¯¹è±¡çš„ç±»å‹ï¼Œåˆ¤æ–­é€‰æ‹©å…·ä½“çš„ç¼–ç å™¨è¿›è¡Œç¼–ç ï¼Œå¦‚æœä¼ å…¥çš„æ˜¯mapé‚£å°±â€¦å¦‚æœä¼ å…¥çš„æ˜¯structé‚£å°±â€¦ è¦ç‚¹2 - se.encode1234567891011121314151617181920func (se *structEncoder) encode(e *encodeState, v reflect.Value, opts encOpts) &#123; e.WriteByte('&#123;') first := true for i, f := range se.fields &#123; fv := fieldByIndex(v, f.index) if !fv.IsValid() || f.omitEmpty &amp;&amp; isEmptyValue(fv) &#123; continue &#125; if first &#123; first = false &#125; else &#123; e.WriteByte(',') &#125; e.string(f.name, opts.escapeHTML) e.WriteByte(':') opts.quoted = f.quoted se.fieldEncs[i](e, fv, opts) &#125; e.WriteByte('&#125;')&#125; 123456789101112func fieldByIndex(v reflect.Value, index []int) reflect.Value &#123; for _, i := range index &#123; if v.Kind() == reflect.Ptr &#123; if v.IsNil() &#123; return reflect.Value&#123;&#125; &#125; v = v.Elem() &#125; v = v.Field(i) &#125; return v&#125; encodeè¿™ä¸ªæ–¹æ³•æ˜¯è§£æç»“æ„ä½“çš„ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ¥šçš„çœ‹çš„ä»ç»“æ„ä½“ä¸­é€šè¿‡v.Fieldå°†é‡Œé¢çš„å‚æ•°æ‹¿å‡ºæ¥ã€‚å…¶ä»–ç»†èŠ‚è¿™é‡Œå°±ä¸åšè¯´æ˜äº†ï¼Œä¸»è¦çš„ç›®çš„æ˜¯è¦è¡¨ç¤ºåå°„åœ¨å…¶ä¸­èµ·åˆ°çš„é‡è¦ä½œç”¨ã€‚ æ€»ç»“å’Œæé†’çœ‹å®Œä½ å°±åº”è¯¥æ¸…æ¥šåå°„åˆ°åº•æ˜¯åšä»€ä¹ˆç”¨çš„ï¼Œå…·ä½“æˆ‘ä»¬ä»€ä¹ˆæ—¶å€™ä¼šç”¨åˆ°å®ƒã€‚æœ€åè¿˜è¦æé†’ä¸€ä¸‹ï¼Œåå°„ä¹Ÿå­˜åœ¨ä¸¤ä¸ªå¿…ç„¶çš„é—®é¢˜ï¼š ç¬¬ä¸€ä¸ªæ˜¯ä¸å®‰å…¨ï¼Œå› ä¸ºåå°„çš„ç±»å‹åœ¨è½¬æ¢ä¸­ææ˜“å‡ºç°é—®é¢˜ï¼Œæ‰€ä»¥ä½¿ç”¨éœ€è°¨æ…ã€‚ ç¬¬äºŒä¸ªæ˜¯é€Ÿåº¦æ…¢ï¼Œä¹‹æ‰€ä»¥æœ‰äººæŠ¨å‡»golangçš„jsonè§£æåº“æ…¢ï¼Œä¸€éƒ¨åˆ†åŸå› å°±æ˜¯å› ä¸ºå…¶ä¸­æ¶‰åŠåˆ°äº†åå°„ï¼Œæ‰€ä»¥å¦‚æœå¯¹æ•ˆç‡æœ‰è¦æ±‚çš„åœ°æ–¹å°±è¦æ–Ÿé…Œä½¿ç”¨äº†ã€‚]]></content>
      <categories>
        <category>golangæºç è§£æ</category>
      </categories>
      <tags>
        <tag>reflect</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Golangçš„strings.goæºç è§£æ - Rabin-Karpäº†è§£ä¸€ä¸‹ï¼Ÿ]]></title>
    <url>%2F2019%2F06%2F20%2Fgolang%2Fsource-code%2Fstrings-go-source-code%2F</url>
    <content type="text"><![CDATA[stringsåŒ…æ˜¯æˆ‘ä»¬ç»å¸¸åœ¨å¤„ç†å­—ç¬¦ä¸²çš„æ—¶å€™è¦ç”¨çš„ï¼Œè¿™æ¬¡æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒå…¶ä¸­çš„ä¸€äº›æ–¹æ³•å…·ä½“æ˜¯å¦‚ä½•å®ç°çš„ã€‚æˆ‘å°±æ‰¾åˆ°å…¶ä¸­å¸¸ç”¨çš„å‡ ä¸ªæ–¹æ³•ï¼Œç„¶åé’ˆå¯¹å…¶ä¸­æ¯”è¾ƒéš¾çš„éƒ¨åˆ†è¿˜æœ‰åº”ç”¨åˆ°ä¸€äº›ç‰¹åˆ«ç®—æ³•çš„éƒ¨åˆ†è¿›è¡Œåˆ†æã€‚ ToUpperå…ˆæ¥çœ‹ä¸ªç®€å•çš„ToUpperï¼Œå°†æ‰€æœ‰å­—ç¬¦è½¬æ¢æˆå¤§å†™ã€‚è¿™ä¸ªå¦‚æœè®©æˆ‘ä»¬è‡ªå·±å®ç°ä¹Ÿæ²¡æœ‰ä»€ä¹ˆéš¾åº¦ï¼Œå°±æ˜¯éå†æ¯ä¸ªå­—ç¬¦è½¬æ¢æˆå¤§å†™å°±å¯ä»¥ã€‚ 12345678910111213141516171819202122232425262728// ToUpper returns a copy of the string s with all Unicode letters mapped to their upper case.func ToUpper(s string) string &#123; isASCII, hasLower := true, false for i := 0; i &lt; len(s); i++ &#123; c := s[i] if c &gt;= utf8.RuneSelf &#123; isASCII = false break &#125; hasLower = hasLower || (c &gt;= 'a' &amp;&amp; c &lt;= 'z') &#125; if isASCII &#123; // optimize for ASCII-only strings. if !hasLower &#123; return s &#125; b := make([]byte, len(s)) for i := 0; i &lt; len(s); i++ &#123; c := s[i] if c &gt;= 'a' &amp;&amp; c &lt;= 'z' &#123; c -= 'a' - 'A' &#125; b[i] = c &#125; return string(b) &#125; return Map(unicode.ToUpper, s)&#125; å¯ä»¥çœ‹åˆ°ï¼Œæºç ä¸­è€ƒè™‘çš„æ¯”è¾ƒå‘¨å…¨ï¼Œåˆ¤æ–­äº†ä¸€ä¸‹å­—ç¬¦é›†çš„é—®é¢˜ã€‚ å°æŠ€å·§c -= â€˜aâ€™ - â€˜Aâ€™æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªè½¬æ¢å¤§å†™çš„æŠ€å·§ï¼Œå­¦ä¹ ä¸€ä¸‹ã€‚å¦‚æœè½¬æ¢æˆå°å†™ï¼Œåªè¦æ”¹æˆ+å°±å¯ä»¥äº†ã€‚ Replaceç„¶åçœ‹ä¸€ä¸ªç¨å¾®å¤æ‚ä¸€äº›çš„ï¼ŒReplaceï¼Œè¿™ä¸ªå‡½æ•°çš„ç›®æ ‡æ˜¯æ›¿æ¢sä¸­oldçš„å­—ç¬¦ï¼Œæ›¿æ¢å‰nä¸ªï¼Œå¦‚æœnä¸ºè´Ÿæ•°åˆ™å…¨éƒ¨æ›¿æ¢ã€‚ä½œä¸ºå®ç°ä¹Ÿå…¶å®ä¸éš¾ï¼Œå°±æ˜¯æ‰¾åˆ°å¯¹åº”å­—ç¬¦æ›¿æ¢å°±å¯ä»¥ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839// Replace returns a copy of the string s with the first n// non-overlapping instances of old replaced by new.// If old is empty, it matches at the beginning of the string// and after each UTF-8 sequence, yielding up to k+1 replacements// for a k-rune string.// If n &lt; 0, there is no limit on the number of replacements.func Replace(s, old, new string, n int) string &#123; if old == new || n == 0 &#123; return s // avoid allocation &#125; // Compute number of replacements. if m := Count(s, old); m == 0 &#123; return s // avoid allocation &#125; else if n &lt; 0 || m &lt; n &#123; n = m &#125; // Apply replacements to buffer. t := make([]byte, len(s)+n*(len(new)-len(old))) w := 0 start := 0 for i := 0; i &lt; n; i++ &#123; j := start if len(old) == 0 &#123; if i &gt; 0 &#123; _, wid := utf8.DecodeRuneInString(s[start:]) j += wid &#125; &#125; else &#123; j += Index(s[start:], old) &#125; w += copy(t[w:], s[start:j]) w += copy(t[w:], new) start = j + len(old) &#125; w += copy(t[w:], s[start:]) return string(t[0:w])&#125; å…¶å®æ ¸å¿ƒå°±æ˜¯ä¸‹é¢ä¸‰å¥w += copy(t[w:], s[start:j])w += copy(t[w:], new)start = j + len(old)åˆ©ç”¨ä¸€ä¸ªstartå»æ ‡è®°ä»æ—§å­—ç¬¦ä¸²çš„é‚£ä¸ªä½ç½®å¼€å§‹å¤åˆ¶ï¼Œåˆ°ç›®æ ‡å­—ç¬¦å¤„ï¼Œç„¶åå¤åˆ¶éœ€è¦æ›¿æ¢çš„å­—ç¬¦è¿›å»å°±å¯ä»¥äº†ï¼Œæœ€åç§»åŠ¨startä¸ºäº†ä¸‹ä¸€æ¬¡å‡†å¤‡å°±å¯ä»¥äº†ã€‚ å°æŠ€å·§t := make([]byte, len(s)+n*(len(new)-len(old)))è¿™ä¸ªåœ¨æºç ä¸­å¾ˆæ˜¯å¸¸è§ï¼Œå‘Šè¯‰æˆ‘ä»¬ä¸€ä¸ªé“ç†ï¼Œåœ¨åˆ›å»ºsliceçš„æ—¶å€™ï¼Œå°½å¯èƒ½çš„å»æŒ‡å®šå¥½ä½ éœ€è¦çš„é•¿åº¦æ¥é¿å…æ‰©å®¹ã€‚ Indexå¥½äº†ï¼Œçƒ­èº«å·®ä¸å¤šäº†ï¼Œæ¥çœ‹æˆ‘ä»¬è¿™æ¬¡çš„é‡å¤´æˆï¼Œindexã€‚æˆ‘ä»¬ç»å¸¸éœ€è¦ç¡®å®šä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯å¦å­˜åœ¨äºå¦ä¸€ä¸ªå­—ç¬¦ä¸²å†…ï¼Œå¹¶ä¸”è¦çŸ¥é“å®ƒçš„ä½ç½®ï¼Œæ‰€ä»¥éœ€è¦indexæ–¹æ³•ã€‚å…¶å®è¯´åˆ°åº•å°±æ˜¯å­—ç¬¦ä¸²åŒ¹é…å˜›ã€‚ è‡ªå·±æ€è€ƒä¸€èˆ¬çœ‹æºç æˆ‘éƒ½ä¹ æƒ¯å…ˆè‡ªå·±æƒ³æƒ³æ€ä¹ˆå»å®ç°ï¼Œè¿™ä¸ªæ–¹æ³•å¯¹äºæˆ‘æ¥è¯´å¾ˆç†Ÿæ‚‰ï¼Œåœ¨javaä¸­å…¶å®å¾ˆæš´åŠ›ï¼Œå°±æ˜¯ä¸¤å±‚foræå®šï¼Œå…ˆæ‰¾åˆ°ç¬¬ä¸€ä¸ªä¸€æ ·çš„å­—ç¬¦ï¼Œç„¶ååŒ¹é…å‰©ä¸‹çš„ã€‚ç„¶åæˆ‘ä¹ŸçŸ¥é“ï¼Œå­—ç¬¦ä¸²åŒ¹é…åœ¨ç®—æ³•ä¸­æœ‰è‘—åçš„KMPç®—æ³•ï¼Œä½†æ˜¯ç†è§£éš¾åº¦å¾ˆå¤§ã€‚ä¸çŸ¥é“golangä¼šæ€ä¹ˆå®ç°ï¼Œäºæ˜¯æˆ‘çœ‹åˆ°äº†ä¸€ä¸ªæ–°çš„ç®—æ³•RabinKarpï¼ˆæˆ‘ä¹‹å‰ä¸äº†è§£ï¼‰ æºç 1234567891011121314151617181920212223func indexRabinKarp(s, substr string) int &#123; // Rabin-Karp search hashss, pow := hashStr(substr) n := len(substr) var h uint32 for i := 0; i &lt; n; i++ &#123; h = h*primeRK + uint32(s[i]) &#125; if h == hashss &amp;&amp; s[:n] == substr &#123; return 0 &#125; for i := n; i &lt; len(s); &#123; h *= primeRK h += uint32(s[i]) h -= pow * uint32(s[i-n]) i++ if h == hashss &amp;&amp; s[i-n:i] == substr &#123; return i - n &#125; &#125; return -1&#125; ä½ å…ˆè‡ªå·±å°è¯•çœ‹çœ‹æ˜¯å¦èƒ½çœ‹å‡ºä»€ä¹ˆé—¨é“ï¼Ÿ çŒœæµ‹æ˜¯ä¸æ˜¯ä¹çœ‹ä¹‹ä¸‹è¿™ä¸ªæ–¹æ³•å¾ˆå¤æ‚ï¼Œå„ç§æ“ä½œçœ¼èŠ±ç¼­ä¹±ï¼Œå¦‚æœä½ æ˜¯ç¬¬ä¸€æ¬¡çœ‹æºç å¯èƒ½æ˜¯è¿™æ ·çš„ï¼Œçœ‹å¤šäº†ä½ åº”è¯¥æœ‰å’Œæˆ‘ä¸€æ ·çš„ç›´è§‰å’Œç»éªŒï¼ˆåæ­£æˆ‘æ˜¯æœ‰æ„Ÿè§‰ï¼‰æˆ‘çœ‹æºç çš„ç¬¬äºŒä¸ªæ­¥éª¤å°±æ˜¯å¤§è‡´çœ‹ä¸€çœ¼ï¼Œç„¶ååœ¨ä¸çœ‹ä»»ä½•æ–‡ç« è§£æçš„æƒ…å†µä¸‹çŒœæµ‹å®ƒçš„å®ç°ã€‚åœ¨æˆ‘çœ‹å®Œä¸Šé¢ä¹‹åç•™ä¸ªæˆ‘ä¸‰ä¸ªé‡ç‚¹ hashss, pow := hashStr(substr) h += uint32(s[i]) h -= pow * uint32(s[i-n]) if h == hashss &amp;&amp; s[i-n:i] == substr { å®ƒè·å–äº†å¯¹åº”çš„hashå€¼ï¼Œè¿™ä¸ªç®—æ³•å’Œhashæœ‰å…³ å®ƒå¯¹å“ˆå¸Œå€¼è¿›è¡Œäº†å¢å‡æ“ä½œ å®ƒæ¯”è¾ƒå“ˆå¸Œå€¼å’Œå­—ç¬¦ä¸²ä»è€Œç¡®å®šä½ç½® åˆ°è¿™é‡Œï¼Œæˆ‘å·²ç»æœ‰äº†ä¸€ä¸ªå¤§æ¦‚çš„æ€è·¯ï¼Œè¿™ä¸ªç®—æ³•åº”è¯¥æ˜¯é€šè¿‡å“ˆå¸Œå€¼å¿«é€Ÿç¡®å®šå­ä¸²æ˜¯å¦å¯èƒ½å­˜åœ¨ï¼Œåœ¨å“ˆå¸Œå€¼ç›¸åŒçš„æƒ…å†µä¸‹å†å»æ¯”è¾ƒçœŸå®çš„å­—ç¬¦æ˜¯å¦ä¸€è‡´ï¼ŒåŒæ—¶åœ¨è®¡ç®—å“ˆå¸Œå€¼çš„æ—¶å€™é‡‡ç”¨ç‰¹æ®Šçš„æœºåˆ¶æ¥å®ç°äº†å¢åŠ å°±å¯ä»¥å®Œæˆå“ˆå¸Œçš„æ”¹å˜ã€‚å…¶å®å¦‚æœä½ æœ‰ç›¸åŒçš„æƒ³æ³•ï¼Œæ­å–œä½ ï¼Œå·²ç»å…«ä¹ä¸ç¦»åäº†ã€‚ åˆ†ææˆ‘ä»¬ä¸¾ä¸ªå®é™…çš„ä¾‹å­æ¥è¯´æ˜ä¸Šé¢çš„äº‹æƒ…åŸæœ¬çš„å­—ç¬¦ä¸²ä¸ºï¼šâ€ABCDEâ€ï¼Œå­ä¸²ä¸ºâ€BCDâ€é¦–å…ˆè®¡ç®—å‡ºâ€BCDâ€çš„hashä¸º100ï¼ˆä¸¾ä¸ªä¾‹å­ï¼‰ç„¶åå¾ªç¯åŸæœ¬çš„å­—ç¬¦ä¸²å–å‡ºâ€ABCâ€è®¡ç®—hashä¸º200 != 100æ‰€ä»¥ä¸€å®šä¸æ˜¯å–å‡ºå­—ç¬¦DåŸæ¥çš„hashåŠ Då‡å»Aè®¡ç®—hashä¸º100 == 100ï¼ˆè¿™é‡Œæ³¨æ„ï¼Œä¸æ˜¯é‡æ–°è®¡ç®—ï¼Œè€Œæ˜¯åœ¨åŸæœ‰çš„åŸºç¡€ä¸Šè¿›è¡Œçš„è®¡ç®—ï¼‰æœ€åè¿˜æ˜¯è¦æ¯”è¾ƒä¸€éæ˜¯å¦æ­£ç¡®ï¼Œå› ä¸ºhashä¸€è‡´ä¸ä¸€å®šåŸå€¼ä¸€è‡´ã€‚ å‡è®¾å¾…åŒ¹é…å­—ç¬¦ä¸²çš„é•¿åº¦ä¸ºMï¼Œç›®æ ‡å­—ç¬¦ä¸²çš„é•¿åº¦ä¸ºNï¼Œé‚£ä¹ˆä¸€å…±æ¯”è¾ƒN-M+1å°±å¯ä»¥äº† hashé‚£ä¹ˆå…¶å®ä½ åº”è¯¥æ³¨æ„åˆ°äº†ï¼Œæœ€ç¥å¥‡çš„å°±æ˜¯è¿™ä¸ªhashå€¼ï¼Œä¸ºä»€ä¹ˆå¯ä»¥è¿™æ ·æ“ä½œï¼Œå¦‚æœæ˜¯md5è¿™ç§å¿…é¡»é‡æ–°è®¡ç®—ï¼Œæ˜¯ä¸å¯èƒ½å®Œæˆè¿™æ ·çš„æ“ä½œçš„ã€‚ 12345678910111213141516171819// primeRK is the prime base used in Rabin-Karp algorithm.const primeRK = 16777619// hashStr returns the hash and the appropriate multiplicative// factor for use in Rabin-Karp algorithm.func hashStr(sep string) (uint32, uint32) &#123; hash := uint32(0) for i := 0; i &lt; len(sep); i++ &#123; hash = hash*primeRK + uint32(sep[i]) &#125; var pow, sq uint32 = 1, primeRK for i := len(sep); i &gt; 0; i &gt;&gt;= 1 &#123; if i&amp;1 != 0 &#123; pow *= sq &#125; sq *= sq &#125; return hash, pow&#125; è¿™ä¸ªå°±æ˜¯hashç®—æ³•ï¼Œå…¶å®å®ƒæ¯æ¬¡å®Œæˆçš„å°±æ˜¯ *primeRK åŠ ä¸Šæ–°çš„å­—ç¬¦ï¼Œé‚£ä¹ˆpowæ˜¯ä»€ä¹ˆå‘¢ï¼ŸåŠ å‡ç©¶ç«Ÿæ˜¯å¦‚ä½•å®Œæˆçš„å‘¢ï¼Ÿæˆ‘ä¸¾ä¸ªä¾‹å­ä½ å°±æ˜ç™½äº†ã€‚ è¿˜æ˜¯åˆšæ‰çš„ABCDEå’ŒBCDï¼Œæˆ‘ä»¬ç”¨qè¡¨ç¤ºå¸¸æ•°primeRKé‚£ä¹ˆBCDçš„hashè®¡ç®—å‡ºæ¥åº”è¯¥æ˜¯B q^2 + C q + Dè€ŒABCçš„hashåº”è¯¥æ˜¯A q^2 + B q + Cé‚£å½“Dæ¥çš„æ—¶å€™å¦‚ä½•æ“ä½œçš„å‘¢ï¼Ÿå›çœ‹ä¸€ä¸‹indexRabinKarpå°±æ˜ç™½äº†ã€‚[A q^2 + B q + C] q + D - A pow= A q^3 - A pow + B q^2 + C q + Dæ˜ç™½äº†å§ï¼Œè¿™ä¸ªpowå…¶å®å°±æ˜¯è®¡ç®—hashå€¼æ—¶çš„æœ€é«˜æŒ‡æ•°ï¼Œé€šè¿‡æ¯æ¬¡å‡å»å¸¸æ•°çš„æœ€é«˜æŒ‡æ•°é¡¹å°±èƒ½å®Œæˆä¹‹å‰çš„æ“ä½œã€‚ èªæ˜ã€‚ä¸ç”±å¾—ä½©æœèƒ½æƒ³å‡ºè¿™æ ·ç®—æ³•çš„äºº~ å…¶ä»–ä¸€äº›æ–¹æ³•çœ‹å®Œæœ€å¤æ‚çš„indexå®ç°ï¼Œå†è¯´è¯´å‡ ä¸ªç”±å®ƒå¼•ç”³å‡ºæ¥çš„æ–¹æ³•ã€‚ genSplitå…¶å®å°±æ˜¯åˆ†ç»„å­—ç¬¦ä¸²ï¼Œé€šè¿‡æŸäº›å­ä¸²å»åˆ†å‰²æˆä¸€ä¸ªä¸ªéƒ¨åˆ†ï¼Œå…¶å®å®ç°å°±æ˜¯æ¯æ¬¡Indexæ‰¾åˆ°ä½ç½®ç„¶åè¿›è¡Œå­˜å‚¨åˆ°æ–°çš„åœ°æ–¹å°±å¯ä»¥äº†ã€‚123456789for i &lt; n &#123; m := Index(s, sep) if m &lt; 0 &#123; break &#125; a[i] = s[:m+sepSave] s = s[m+len(sep):] i++&#125; countGenericè®¡æ•°ï¼Œç»Ÿè®¡å­—ç¬¦ä¸²ä¸­å­ä¸²å‡ºç°çš„æ•°ç›®ï¼Œä¹Ÿæ˜¯é€šè¿‡indexå®Œæˆï¼Œç»Ÿè®¡ä¸€ä¸‹è€Œå·²12345678for &#123; i := Index(s, substr) if i == -1 &#123; return n &#125; n++ s = s[i+len(substr):]&#125; æ€»ç»“å…¶å®å¾ˆå¤šæºç ä¸­çš„å®ç°ä¸å¤æ‚ï¼Œå¤šçœ‹çœ‹ï¼Œä¸ä»…èƒ½ç†Ÿç»ƒä½¿ç”¨apiè¿˜èƒ½å­¦åˆ°ä¸€äº›éªšæ“ä½œï¼Œä½•ä¹è€Œä¸ä¸ºå‘¢ï¼Ÿä¸å¾—ä¸ä½©æœä¸€äº›ç‰›é€¼çš„ç®—æ³•å®ç°ï¼ŒçœŸçš„å‰å®³~]]></content>
      <categories>
        <category>golangæºç è§£æ</category>
      </categories>
      <tags>
        <tag>strings</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Golangçš„slice]]></title>
    <url>%2F2019%2F06%2F18%2Fgolang%2Fsource-code%2Fslice-source-code-review%2F</url>
    <content type="text"><![CDATA[ä»Šå¤©æ¥è¯´ä¸ªç®€å•çš„ï¼Œä¹Ÿä¸ç®€å•çš„ä¸œè¥¿ï¼Œé‚£å°±æ˜¯åˆ‡ç‰‡ã€‚sliceå¯¹äºgolangæ¥è¯´é‚£çœŸçš„æ˜¯ä¸€ä¸ªéå¸¸å¸¸ç”¨çš„ä¸œè¥¿äº†ï¼Œå¾ˆå¤šåœ°æ–¹éƒ½ä¼šç”¨åˆ°å®ƒï¼Œä»Šå¤©å°±æ¥è¯´è¯´ï¼Œsliceåº•å±‚æ˜¯å¦‚ä½•å®ç°çš„ï¼Œåˆæœ‰å“ªäº›å‘æ˜¯éœ€è¦æå‰æ³¨æ„çš„ã€‚ sliceç»“æ„å¾ˆå¤šç¬¬ä¸€æ¬¡æ¥è§¦golangçš„åŒå­¦éƒ½ä¼šè®¤ä¸ºï¼Œæ•°ç»„å’Œåˆ‡ç‰‡æ˜¯å·®ä¸å¤šçš„ä¸œè¥¿ï¼Œå…¶å®ä¸æ˜¯çš„ï¼Œåˆ‡ç‰‡æ˜¯æ•°ç»„çš„å°è£…ã€‚12345type slice struct &#123; array unsafe.Pointer len int cap int&#125; ä¸Šé¢è¿™ä¸ªå°±æ˜¯sliceçš„ç»“æ„ï¼Œé¡ºä¾¿è¯´ä¸€ä¸‹ï¼šsliceçš„æºç ä½ç½®æ˜¯ï¼šgo/src/runtime/slice.go å…¶ä¸­arrayæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘åº•å±‚çš„æ•°ç»„ lenä»£è¡¨sliceçš„é•¿åº¦ capä»£è¡¨sliceçš„å®¹é‡ ä¸ºä»€ä¹ˆä¼šæœ‰é•¿åº¦å’Œå®¹é‡è¿™ä¸ªåŒºåˆ†å‘¢ï¼Œè¿™ä¸¤ä¸ªä¸œè¥¿æ˜¯ç”¨æ¥å¹²ä»€ä¹ˆçš„å‘¢ï¼Ÿæˆ‘ä»¬å¾€ä¸‹çœ‹ã€‚ sliceçš„é•¿åº¦å’Œå®¹é‡æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªæœ€ç®€å•çš„æ¡ˆä¾‹1234sli := make([]int, 2)fmt.Printf("len=%d cap=%d\n", len(sli), cap(sli))sli = append(sli, 1)fmt.Printf("len=%d cap=%d\n", len(sli), cap(sli)) æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º2çš„sliceç„¶åæ‰“å°ä¸€ä¸‹å®ƒçš„lenå’Œcapã€‚ç„¶åæ·»åŠ ä¸€ä¸ªå…ƒç´ ï¼Œå†æ¬¡æ‰“å°æœ€åç»“æœä¸ºï¼šlen=2 cap=2len=3 cap=4 ä»ä¸­æˆ‘ä»¬å¯ä»¥çŸ¥é“lenå’Œcapæ˜¯ä¸åŒçš„ä¸œè¥¿ï¼Œæ˜æ˜¾å˜›ã€‚ä½†æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ å…¶å®åŸå› å¾ˆç®€å•ï¼Œå› ä¸ºæ•°ç»„åœ¨åˆ›å»ºçš„æ—¶å€™åªèƒ½åˆ›å»ºå›ºå®šå¤§å°çš„æ•°ç»„ï¼Œè€Œå½“sliceåœ¨ä¸æ–­å¾€å…¶ä¸­æ·»åŠ å…ƒç´ çš„æ—¶å€™ï¼ŒåŠ¿å¿…ä¼šé‡åˆ°å¤§å°ä¸å¤Ÿçš„æƒ…å†µï¼Œå¦‚æœæ¯æ¬¡æ·»åŠ éƒ½ä¸å¤Ÿï¼Œé‚£ä¹ˆæ¯æ¬¡éƒ½è¦åˆ›å»ºæ–°çš„æ•°ç»„ï¼Œé‚£ä¼šç›¸å½“æµªè´¹æ—¶é—´å’Œèµ„æºï¼Œæ‰€ä»¥å½“ä¸å¤Ÿçš„æ—¶å€™ç´¢æ€§ä¸€æ¬¡å°±åˆ›å»ºå¤§ä¸€äº›ï¼Œæ‰€ä»¥capå…¶å®å°±ä»£è¡¨äº†æ•´ä½“çš„ä¸€ä¸ªå®¹é‡ï¼Œè€Œlenä»£è¡¨å½“å‰ç”¨åˆ°äº†ç¬¬å‡ ä¸ªã€‚ sliceçš„æ‰©å®¹åˆšæ‰æåˆ°çš„æ•´ä¸ªè¿‡ç¨‹å°±æ˜¯æ‰©å®¹çš„åŸå› ï¼Œé‚£ä¹ˆsliceç©¶ç«Ÿæ˜¯å¦‚ä½•è¿›è¡Œæ‰©å®¹çš„å‘¢ï¼Ÿç½‘ä¸Šæˆ‘çœ‹è§è¿‡ä¸¤ä¸ªè¯´æ³•ï¼š æ¯æ¬¡2å€ å½“len&lt;1024çš„æ—¶å€™æ¯æ¬¡2å€ï¼Œå½“len&gt;1024çš„æ—¶å€™æ¯æ¬¡1.25å€ æˆ‘æœ€åå¾—åˆ°çš„ç»“è®ºæ˜¯å…¶å®ä¸¤ä¸ªéƒ½ä¸å®Œå…¨æ­£ç¡®ã€‚æ­£ç¡®çš„åº”è¯¥çœ‹çœ‹æºç ä¸­æ˜¯æ€ä¹ˆè¯´çš„ã€‚123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051func growslice(et *_type, old slice, cap int) slice &#123; ..... newcap := old.cap doublecap := newcap + newcap if cap &gt; doublecap &#123; newcap = cap &#125; else &#123; if old.len &lt; 1024 &#123; newcap = doublecap &#125; else &#123; // Check 0 &lt; newcap to detect overflow // and prevent an infinite loop. for 0 &lt; newcap &amp;&amp; newcap &lt; cap &#123; newcap += newcap / 4 &#125; // Set newcap to the requested cap when // the newcap calculation overflowed. if newcap &lt;= 0 &#123; newcap = cap &#125; &#125; &#125; var overflow bool var lenmem, newlenmem, capmem uintptr const ptrSize = unsafe.Sizeof((*byte)(nil)) switch et.size &#123; case 1: lenmem = uintptr(old.len) newlenmem = uintptr(cap) capmem = roundupsize(uintptr(newcap)) overflow = uintptr(newcap) &gt; _MaxMem newcap = int(capmem) case ptrSize: lenmem = uintptr(old.len) * ptrSize newlenmem = uintptr(cap) * ptrSize capmem = roundupsize(uintptr(newcap) * ptrSize) overflow = uintptr(newcap) &gt; _MaxMem/ptrSize newcap = int(capmem / ptrSize) default: lenmem = uintptr(old.len) * et.size newlenmem = uintptr(cap) * et.size capmem = roundupsize(uintptr(newcap) * et.size) overflow = uintptr(newcap) &gt; maxSliceCap(et.size) newcap = int(capmem / et.size) &#125; ...... return slice&#123;p, old.len, newcap&#125;&#125; æˆ‘ä»¬çœç•¥å…¶ä¸­éƒ¨åˆ†ä»£ç çœ‹å…³é”®éƒ¨åˆ†ï¼Œé¦–å…ˆè¯´æ˜ä¸€ä¸‹growsliceè¿™ä¸ªæ–¹æ³•æ˜¯æ‰©å®¹çš„æ–¹æ³•ï¼Œå…¶ä¸­çš„å…¥å‚et *_type, old slice, cap intåˆ†åˆ«æ˜¯å…ƒç´ çš„ç±»å‹ï¼Œè€çš„sliceï¼Œæ–°sliceè¦æ±‚çš„æœ€å°å®¹é‡é’ˆå¯¹æœ€åè¿™ä¸ªå‚æ•°ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œå½“å‰å¦‚æœæ˜¯len=2ï¼Œcap=2çš„ä¸€ä¸ªsliceæ·»åŠ ä¸€ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆè¿™ä¸ªå‚æ•°ä¼ å…¥çš„å°±æ˜¯3ï¼Œå› ä¸ºæœ€å°éœ€è¦å®¹é‡ä¸º3ã€‚ å…¶å®ä»å‰åŠéƒ¨åˆ†æ¥çœ‹ï¼Œç¬¬äºŒç§è¯´æ³•æ˜¯æ­£ç¡®çš„ï¼Œå½“len&lt;1024ç¡®å®å°±æ˜¯ä¸¤å€ï¼Œè€Œå½“len&gt;1024çš„æ—¶å€™ï¼Œæ¯æ¬¡ä»¥åŸæ¥çš„25%å¢åŠ ç›´åˆ°æ»¡è¶³è¦æ±‚ã€‚ ä½†æ˜¯å…¶å®ä½ çœ‹åé¢éƒ¨åˆ†ï¼Œæœ‰ä¸€ä¸ªroundupsizeçš„æ–¹æ³•ï¼Œå¹¶ä¸”åˆå¯¹newcapè¿›è¡Œèµ‹å€¼ï¼Œæ‰€ä»¥è‚¯å®šä¿®æ”¹äº†capçš„å€¼ï¼Œæ‰€ä»¥å…¶å®æ‰©å®¹å¹¶æ²¡æœ‰æè¿°çš„é‚£ä¹ˆç®€å•ï¼Œå®é™…ä¸­ä¼šè¿›è¡Œå†…å­˜å¯¹é½ï¼Œå…·ä½“ä»€ä¹ˆäº‹å†…å­˜å¯¹é½å‘¢ï¼Ÿç®€å•çš„æè¿°æ˜¯ï¼Œå†…å­˜ä¸­è‚¯å®šä¸æ˜¯ä½ æƒ³æ€ä¹ˆæ”¾å°±æ€ä¹ˆæ”¾çš„è‚¯å®šè¦æ»¡è¶³ä¸€ä¸ªè§„åˆ™ï¼Œæœ‰çš„åœ°æ–¹è™½ç„¶ä½ åªè¦è¿™ä¹ˆç‚¹åœ°æ–¹ï¼Œä½†æ˜¯ç”±äºç¾è§‚çš„è¦æ±‚ï¼Œä¼šå¤šç»™ä½ ä¸€ç‚¹ï¼Œå‡‘ä¸ªæ•´ï¼Œä¿æŒç»Ÿä¸€æ•´é½ï¼Œè¿™å°±æ˜¯å†…å­˜å¯¹é½ã€‚ï¼ˆæ˜¯ä¸æ˜¯èŠ±é‡Œèƒ¡å“¨çš„ï¼Œæˆ‘å°½å¯èƒ½å·²ç»ç™½è¯äº†ï¼Œå…·ä½“è¿˜æ˜¯è¦çœ‹https://blog.csdn.net/u011957758/article/details/85059117ï¼‰æ€»ä¹‹ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œsliceçš„æ‰©å®¹å¹¶ä¸æ˜¯é‚£ä¹ˆç®€å•çš„ã€‚æœ€åé™„ä¸Šä¸€ä¸ªä¾‹å­ä½œä¸ºéªŒè¯ï¼š123456789101112func main() &#123; sli := make([]int, 2) preCap := cap(sli) for i := 0; i &lt;= 2048; i++ &#123; sli = append(sli, i) if cap(sli) != preCap &#123; fmt.Printf("len=%4d \t cap=%d\n", len(sli)-1, cap(sli)) preCap = cap(sli) &#125; &#125;&#125; è¾“å‡º123456789101112len= 2 cap=4len= 4 cap=8len= 8 cap=16len= 16 cap=32len= 32 cap=64len= 64 cap=128len= 128 cap=256len= 256 cap=512len= 512 cap=1024len=1024 cap=1280len=1280 cap=1696len=1696 cap=2304 1280 = 1024 1.251696 = 1280 1.325 sliceçš„æ“ä½œæ™®é€šçš„åˆ›å»ºæ·»åŠ å…ƒç´ æˆ‘å°±ä¸å¤šè¯´äº†ï¼Œä½ è‚¯å®šçŸ¥é“ï¼Œä½ è¦æ˜¯ä¸çŸ¥é“å°±ä¸ä¼šæ¥çœ‹æˆ‘çš„åšå®¢äº†ã€‚è¯´ä¸€äº›çœ‹èµ·æ¥é«˜ç«¯çš„å¾®æ“ã€‚ åˆ›å»ºslicemake([]int, 10, 32)makeçš„æ—¶å€™å¯ä»¥æŒ‡å®šç¬¬ä¸‰ä¸ªå‚æ•°ä¹Ÿå°±æ˜¯åˆå§‹çš„cap sliceåˆ é™¤ä¸€ä¸ªå…ƒç´ sli = append(sli[:3], sli[4:]â€¦)å› ä¸ºåº•å±‚æ˜¯æ•°ç»„ï¼Œæ‰€ä»¥åˆ é™¤ä¸€ä¸ªå…ƒç´ çœ‹èµ·æ¥ä¼šæ¯”è¾ƒéº»çƒ¦ reslice123456789101112func main() &#123; sli := make([]int, 0) for i := 1; i &lt;= 10; i++ &#123; sli = append(sli, i) &#125; fmt.Println(sli) sli = sli[1:3:5] fmt.Println(sli) fmt.Println(len(sli), cap(sli))&#125; sli = sli[1:3:5]resliceçš„æ—¶å€™ä¹Ÿå¯ä»¥æŒ‡å®šcapï¼Œä½†æ˜¯æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªæ—¶å€™å¹¶ä¸æ˜¯æŒ‡å®šçš„æ•´ä½“å®¹é‡ä¸º5ï¼Œè€Œæ˜¯å®¹é‡ä¸ºåŸæ¥sliceä¸‹æ ‡ä¸º5çš„åœ°æ–¹ã€‚å¦‚æœåŸæ¥æ˜¯[1 2 3 4 5 6 7 8 9 10]æŒ‰ç…§ä¸Šé¢çš„æ“ä½œï¼ŒæŒ‰ç…§æˆ‘è‡ªå·±çš„å¹³å¸¸è¯´çš„å°±æ˜¯åˆ‡ä¸¤åˆ€ï¼Œç¬¬ä¸€åˆ€æ˜¯åˆ‡åˆ°3ï¼Œç¬¬äºŒåˆ€æ˜¯åˆ‡åˆ°5sliceæ˜¯[2,3]ï¼Œä½†æ˜¯å®é™…åº•å±‚è¿˜æœ‰[4,5] capåº”è¯¥æ˜¯4ï¼Œæ‰€ä»¥è¾“å‡ºåº”è¯¥æ˜¯ï¼š 123[1 2 3 4 5 6 7 8 9 10][2 3]2 4 sliceçš„å‘ç‚¹sliceçš„å‘å…¶å®ä¸»è¦åœ¨äºä½¿ç”¨è€…éœ€è¦æ¸…æ¥šå€¼ä¼ é€’å¼•ç”¨ä¼ é€’çš„å…³ç³»ã€‚é¦–å…ˆåœ¨golangä¸­åªæœ‰å€¼ä¼ é€’ï¼Œæ²¡æœ‰å¼•ç”¨ä¼ é€’ã€‚ resliceçš„æ—¶å€™è¦æ³¨æ„ï¼Œå¦‚æœåªæ˜¯resliceé‚£ä¹ˆåç»­æ“ä½œæ˜¯ä¼šå¯¹åŸæ¥çš„sliceé€ æˆå½±å“çš„ã€‚ ä½†æ˜¯å¦‚æœç»è¿‡appendä¹‹åï¼Œé‚£ä¹ˆç”±äºæ‰©å®¹çš„æ—¶å€™å›é‡æ–°åˆ†é…å†…å­˜ï¼Œå¦‚æœæ¶‰åŠæ‰©å®¹ä¹‹åï¼Œé‚£ä¹ˆå°±ä¸ä¼šå¯¹åŸæ¥çš„sliceé€ æˆå½±å“ã€‚ å¦‚æœä½œä¸ºå‡½æ•°çš„å‚æ•°ä¼ é€’çš„æ˜¯æ•°ç»„ï¼Œå› ä¸ºæ˜¯å€¼ä¼ é€’ï¼Œæ‰€ä»¥å‡½æ•°å†…éƒ¨çš„ä¿®æ”¹ä¸ä¼šå¯¹å¤–éƒ¨çš„å˜é‡äº§ç”Ÿå½±å“ï¼Œä½†æ˜¯å¦‚æœæ˜¯sliceä¼ é€’ï¼Œé‚£ä¹ˆå› ä¸ºä¼ é€’çš„æ˜¯æŒ‡é’ˆï¼Œæ‰€ä»¥ä¼šä¿®æ”¹å¤–éƒ¨çš„å˜é‡ã€‚ åŒæ—¶å› ä¸ºæ˜¯å€¼ä¼ é€’ï¼Œå½¢å‚çš„é‡æ–°èµ‹å€¼æ˜¯ä¸ä¼šå¯¹å¤–éƒ¨çš„å˜é‡é€ æˆå½±å“çš„ã€‚ ä¸‹é¢çš„ä»£ç è¯´æ˜äº†ä»¥ä¸Šå¯èƒ½å‡ºç°çš„å‘ç‚¹1234567891011121314151617181920212223242526272829303132333435363738package mainimport "fmt"func main() &#123; a := [3]int&#123;1, 1, 1&#125; s := []int&#123;1, 1, 1&#125; modifyArray(a) fmt.Println(a) modifySlice(s) fmt.Println(s) reslice(s) fmt.Println(s) s1 := make([]int, 2, 3) s2 := append(s1, 1) s2[0] = 3 fmt.Println(s1) s3 := append(s1, 1, 1) s3[0] = 4 fmt.Println(s1)&#125;func modifyArray(a [3]int) &#123; a[0] = 2&#125;func modifySlice(s []int) &#123; s[0] = 2&#125;func reslice(s []int) &#123; s = s[:2]&#125; æ€»ç»“æ€»ç»“ä¸€ä¸‹ï¼Œåˆ›å»ºsliceçš„æ—¶å€™å¦‚æœå¯ä»¥çš„è¯å°½å¯èƒ½åˆå§‹åŒ–å¥½è¦ç”¨å®¹é‡ï¼Œä»¥å…ç»å¸¸æ‰©å®¹ã€‚sliceä½œä¸ºå‚æ•°è¿›è¡Œä¼ é€’çš„æ—¶å€™ï¼Œè¿˜æœ‰sliceè¿›è¡Œappendçš„æ—¶å€™æ³¨æ„ä¸€ä¸‹ï¼Œåˆ«çš„åº”è¯¥æ²¡æœ‰é—®é¢˜ã€‚æ€»çš„æ¥è¯´sliceçš„å®ç°è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ã€‚]]></content>
      <categories>
        <category>golangæºç è§£æ</category>
      </categories>
      <tags>
        <tag>slice</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æµ…å…¥æ·±å‡ºETCDä¹‹ã€é›†ç¾¤éƒ¨ç½²ä¸golangå®¢æˆ·ç«¯ä½¿ç”¨ã€‘]]></title>
    <url>%2F2019%2F06%2F14%2Fgolang%2Fopen-source-component%2Fetcd-cluster-client%2F</url>
    <content type="text"><![CDATA[ä¹‹å‰è¯´äº†etcdçš„ç®€ä»‹ï¼Œå‘½ä»¤è¡Œä½¿ç”¨ï¼Œä¸€äº›åŸºæœ¬åŸç†ã€‚è¿™æ¬¡æ¥è¯´è¯´ç°å®ä¸€ç‚¹çš„é›†ç¾¤éƒ¨ç½²å’Œgolangç‰ˆæœ¬çš„å®¢æˆ·ç«¯ä½¿ç”¨ã€‚å› ä¸ºåœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œetcdçš„èŠ‚ç‚¹è‚¯å®šæ˜¯éœ€è¦2N+1ä¸ªè¿›è¡Œéƒ¨ç½²çš„ï¼Œæ‰€ä»¥æœ‰å¿…è¦è¯´æ˜ä¸€ä¸‹é›†ç¾¤çš„éƒ¨ç½²ã€‚ é›†ç¾¤éƒ¨ç½²ç½‘ä¸Šæœ‰å¾ˆå¤šé›†ç¾¤éƒ¨ç½²çš„æ•™ç¨‹ï¼Œæœ‰çš„å¾ˆå¤æ‚ï¼Œå…¶å®å¯¹äºæˆ‘ä»¬å®é™…ä½¿ç”¨æ¥è¯´ï¼Œå…¶å®é…ç½®å¹¶ä¸å¤æ‚ï¼Œä¸‹é¢ä¸¾ä¾‹ä¸€ç§æœ€ç®€å•çš„é›†ç¾¤é…ç½®ã€‚ï¼ˆç®€å•åˆ°ä½ æƒ³ä¸åˆ°~ï¼‰ ä¸‹è½½https://github.com/etcd-io/etcd/releasesè¿˜æ˜¯åœ¨githubä¸Šé¢æ‰¾åˆ°éœ€è¦ä¸‹è½½çš„ç‰ˆæœ¬æˆ‘ä½¿ç”¨çš„æ˜¯etcd-v3.3.13-linux-amd64.tar.gzä½¿ç”¨wgetä¸‹è½½åˆ°linuxä½ å–œæ¬¢çš„ç›®å½•ï¼Œæˆ–è€…æœ¬åœ°ä¸‹è½½å®Œæˆä¹‹åä¸Šä¼ å‡å¯ã€‚ éƒ¨ç½²é¦–å…ˆæˆ‘æ‰¾äº†ä¸‰å°æœºå™¨ï¼Œå¯¹åº”ipä¸º192.168.4.224192.168.4.225192.168.4.226PSï¼šæé†’ä¸€ä¸‹è®°å¾—å¼€å‘å¯¹åº”é˜²ç«å¢™çš„ç«¯å£ ç„¶åå°†ä¸‹è½½çš„æ–‡ä»¶è§£å‹ï¼Œä¹‹åè¿›å…¥è§£å‹åçš„ç›®å½•ï¼Œåˆ†åˆ«ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å¯åŠ¨ã€‚(æ³¨æ„ä¸‹é¢çš„å‘½ä»¤å¯¹åº”çš„æ˜¯ä¸‰å°ä¸åŒçš„æœºå™¨ï¼Œä½ éœ€è¦ä¿®æ”¹å¯¹åº”ä¸ºä½ è‡ªå·±çš„ip) 1234567891011121314151617181920212223$ ./etcd --name infra0 --initial-advertise-peer-urls http://192.168.4.224:2380 \--listen-peer-urls http://192.168.4.224:2380 \--listen-client-urls http://192.168.4.224:2379,http://127.0.0.1:2379 \--advertise-client-urls http://192.168.4.224:2379 \--initial-cluster-token etcd-cluster-1 \--initial-cluster infra0=http://192.168.4.224:2380,infra1=http://192.168.4.225:2380,infra2=http://192.168.4.226:2380 \--initial-cluster-state new$ ./etcd --name infra1 --initial-advertise-peer-urls http://192.168.4.225:2380 \--listen-peer-urls http://192.168.4.225:2380 \--listen-client-urls http://192.168.4.225:2379,http://127.0.0.1:2379 \--advertise-client-urls http://192.168.4.225:2379 \--initial-cluster-token etcd-cluster-1 \--initial-cluster infra0=http://192.168.4.224:2380,infra1=http://192.168.4.225:2380,infra2=http://192.168.4.226:2380 \--initial-cluster-state new$ ./etcd --name infra2 --initial-advertise-peer-urls http://192.168.4.226:2380 \--listen-peer-urls http://192.168.4.226:2380 \--listen-client-urls http://192.168.4.226:2379,http://127.0.0.1:2379 \--advertise-client-urls http://192.168.4.226:2379 \--initial-cluster-token etcd-cluster-1 \--initial-cluster infra0=http://192.168.4.224:2380,infra1=http://192.168.4.225:2380,infra2=http://192.168.4.226:2380 \--initial-cluster-state new è‡³æ­¤ï¼Œä¸‰ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤éƒ¨ç½²å®Œæˆã€‚ğŸ˜‚ğŸ˜‚ğŸ˜‚æ²¡é”™å°±æ˜¯è¿™ä¹ˆeasyï¼Œæ²¡æœ‰ç½‘ä¸Šè¯´çš„é‚£ä¹ˆå¤æ‚ã€‚ é…ç½®æ–‡ä»¶å¦‚æœä½ å«Œå¼ƒæ¯æ¬¡ä½¿ç”¨è¿™ä¹ˆé•¿çš„å‘½ä»¤è¿›è¡Œå¯åŠ¨ï¼Œä½ å¯ä»¥å°†å®ƒå†™ä¸ºé…ç½®æ–‡ä»¶ï¼š12345678910111213141516171819202122# å½“å‰èŠ‚ç‚¹åç§°name: infra1# etcdæ•°æ®ä¿å­˜ç›®å½•data-dir: /usr/local/etcd# ä¾›å¤–éƒ¨å®¢æˆ·ç«¯ä½¿ç”¨çš„urllisten-client-urls: http://192.168.4.225:2379,http://127.0.0.1:2379# å¹¿æ’­ç»™å¤–éƒ¨å®¢æˆ·ç«¯ä½¿ç”¨çš„urladvertise-client-urls: http://192.168.4.225:2379# é›†ç¾¤å†…éƒ¨é€šä¿¡ä½¿ç”¨çš„URLlisten-peer-urls: http://192.168.4.225:2380# å¹¿æ’­ç»™é›†ç¾¤å†…å…¶ä»–æˆå‘˜è®¿é—®çš„URLinitial-advertise-peer-urls: http://192.168.4.225:2380# é›†ç¾¤çš„åç§°initial-cluster-token: etcd-cluster-1# åˆå§‹é›†ç¾¤æˆå‘˜åˆ—è¡¨initial-cluster: infra0=http://192.168.4.224:2380,infra1=http://192.168.4.225:2380,infra2=http://192.168.4.226:2380#åˆå§‹é›†ç¾¤çŠ¶æ€initial-cluster-state: new ç„¶åæŒ‡å®šé…ç½®æ–‡ä»¶çš„è·¯å¾„è¿›è¡Œå¯åŠ¨å°±å¯ä»¥äº†1./etcd --config-file=conf.yml å…¶ä»–éƒ¨ç½²ç­–ç•¥ä»¥ä¸Šçš„éƒ¨ç½²ä¸€æ–¹é¢ï¼Œæˆ‘ä¸ªäººéƒ¨ç½²æ—¶ä½¿ç”¨çš„æœ€ç®€å•æ–¹å¼ï¼Œæ›´ç®€å•çš„å¯èƒ½æ˜¯ä½¿ç”¨yumè¿›è¡Œetcdçš„ä¸‹è½½ã€‚å½“ç„¶ä¸Šè¿°æ–¹å¼ä¹Ÿå­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œç°åœ¨çš„etcdç›¸å½“äºè£¸å¥”çš„æƒ…å†µï¼š æ²¡æœ‰é‰´æƒå°±æƒ³åˆ°äºä»»ä½•äººçŸ¥é“ipå’Œç«¯å£å°±å¯ä»¥è¿æ¥ä¸Šä½ çš„etcdï¼Œæ‰€ä»¥å½“å‰å¯èƒ½åªé€‚ç”¨äºå†…ç½‘ä½¿ç”¨ï¼ŒæœåŠ¡é€šè¿‡å†…ç½‘ipè¿›è¡Œè®¿é—®ï¼ˆè¿™ä¸ªå¯ä»¥é€šè¿‡æ·»åŠ æƒé™å’Œç”¨æˆ·æ¥å®Œæˆï¼‰ å½“å‰é€šä¿¡æ˜¯æ²¡æœ‰åŠ å¯†çš„ å½“å‰etcdæ˜¯åˆ©ç”¨é™æ€ipæ¥è¿›è¡Œé…ç½®çš„ï¼Œæˆ‘è®¤ä¸ºè¿™ä¹Ÿæ˜¯å®é™…ä¸­ç”¨åˆ°æœ€æ™®é€šçš„æƒ…å†µï¼Œä½†æ˜¯etcdè¿˜æä¾›å‘ç°æœºåˆ¶æ¥è¿›è¡Œéƒ¨ç½²å’Œé…ç½®ï¼Œæ›´åŠ çµæ´» ç­‰ç­‰ï¼Œè¿™äº›éƒ¨ç½²ç­–ç•¥æ›´å¤šé’ˆå¯¹äºçº¿ä¸Šï¼Œå› ä¸ºå®˜æ–¹å†™çš„éå¸¸è¯¦ç»†äº†ï¼Œæˆ‘æ„Ÿè§‰å†å†™ä¹Ÿå°±ç­é—¨å¼„æ–§äº†ã€‚https://doczhcn.gitbook.io/etcd/index/index-1/clustering Golangå®¢æˆ·ç«¯ä½¿ç”¨è¿™é‡Œæ¥å®é™…ç”¨ä»£ç æ“ä½œä¸€ä¸‹etcdï¼Œè¿˜æ˜¯å’Œä¹‹å‰ä½¿ç”¨å‘½ä»¤è¡Œä¸€æ ·ï¼Œget/put/del/watch/leaseç”¨ä¸€ä¸‹è¿™äº›æ“ä½œï¼Œå…¶ä»–æ“ä½œè¯·æŸ¥çœ‹dochttps://godoc.org/github.com/coreos/etcd/clientv3 å®¢æˆ·ç«¯ä¸‹è½½è¿™é‡Œä¸å»ºè®®ä½¿ç”¨go getè¿›è¡Œä¸‹è½½ï¼ŒçœŸçš„å¤ªæ…¢äº†ï¼Œå¯ä»¥ç›´æ¥ä»githubä¸Šé¢ä¸‹è½½ä¹‹åæ”¾åˆ°å¯¹åº”ç›®å½•å¿«ä¸€äº›ã€‚https://github.com/etcd-io/etcdä¸‹è½½è§£å‹ä¹‹åæ”¾åˆ°gopathä¸‹å¯¹åº”ï¼šgo/src/go.etcd.io/etcd ä»£ç 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980package mainimport ( "context" "fmt" "go.etcd.io/etcd/clientv3" "go.etcd.io/etcd/mvcc/mvccpb" "time")func main() &#123; // é…ç½®å®¢æˆ·ç«¯è¿æ¥ client, err := clientv3.New(clientv3.Config&#123; // Endpoints: []string&#123;"127.0.0.1:2379"&#125;, Endpoints: []string&#123;"192.168.4.224:2379", "192.168.4.225:2379", "192.168.4.226:2379"&#125;, DialTimeout: 5 * time.Second, &#125;) if err != nil &#123; panic(err) &#125; defer client.Close() // å¯åŠ¨watchç›‘å¬ watch := client.Watch(context.TODO(), "aaa") go func() &#123; for &#123; watchResponse := &lt;- watch for _, ev := range watchResponse.Events &#123; switch ev.Type &#123; case mvccpb.DELETE: fmt.Printf("ç›‘å¬åˆ°delï¼š%s\n", ev.Kv.Key) case mvccpb.PUT: fmt.Printf("ç›‘å¬åˆ°putï¼š%s, %s\n", ev.Kv.Key, ev.Kv.Value) &#125; &#125; &#125; &#125;() // æ–°å¢ putResponse, err := client.Put(context.TODO(), "aaa", "xxx") if err != nil &#123; fmt.Println(err) return &#125; fmt.Println(putResponse.Header.String()) // æŸ¥è¯¢ getResponse, err := client.Get(context.TODO(), "aaa") if err != nil &#123; fmt.Println(err) return &#125; fmt.Println(getResponse.Kvs) // åˆ é™¤ deleteResponse, err := client.Delete(context.TODO(), "aaa") if err != nil &#123; fmt.Println(err) return &#125; fmt.Println(deleteResponse.Header.String()) // ç”³è¯·ç§Ÿçº¦ grantResponse, err := client.Grant(context.TODO(), 10) if err != nil &#123; fmt.Println(err) return &#125; // ä½¿ç”¨ç§Ÿçº¦ response, err := client.Put(context.TODO(), "aaa", "xxx", clientv3.WithLease(grantResponse.ID)) if err != nil &#123; fmt.Println(err) return &#125; fmt.Println(response.Header.String()) // ç­‰å¾…ç§Ÿçº¦è‡ªåŠ¨è¿‡æœŸ time.Sleep(time.Second * 20)&#125; å¤§è‡´èƒ½å¾—åˆ°ä»¥ä¸‹è¾“å‡º ç›‘å¬åˆ°putï¼šaaa, xxxcluster_id:14841639068965178418 member_id:10276657743932975437 revision:53 raft_term:4[key:â€aaaâ€ create_revision:53 mod_revision:53 version:1 value:â€xxxâ€ ]ç›‘å¬åˆ°delï¼šaaacluster_id:14841639068965178418 member_id:10276657743932975437 revision:54 raft_term:4ç›‘å¬åˆ°putï¼šaaa, xxxcluster_id:14841639068965178418 member_id:10276657743932975437 revision:55 raft_term:4ç›‘å¬åˆ°delï¼šaaa å…¶å®ä½¿ç”¨èµ·æ¥è¿˜æ˜¯éå¸¸ç®€å•ï¼Œæˆ‘å°±ä¸è¿‡å¤šèµ˜è¿°äº†ã€‚]]></content>
      <categories>
        <category>etcd</category>
      </categories>
      <tags>
        <tag>etcd</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æµ…å…¥æ·±å‡ºETCDä¹‹ã€raftåŸç†ã€‘]]></title>
    <url>%2F2019%2F06%2F12%2Fgolang%2Fopen-source-component%2Fetcd-raft%2F</url>
    <content type="text"><![CDATA[è¿™æ¬¡æˆ‘ä»¬æ¥è¯´è¯´ï¼Œæœ‰å…³äºetcdåŸç†çš„ä¸€äº›äº‹æƒ…ã€‚ä¹‹å‰æˆ‘ä»¬å·²ç»äº†è§£åˆ°äº†etcdæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„k-vå­˜å‚¨ï¼Œé‚£ä¹ˆå®ƒç©¶ç«Ÿæ˜¯å¦‚ä½•ä¿è¯æ•°æ®æ˜¯å¦‚ä½•å¤åˆ¶åˆ°æ¯ä¸ªèŠ‚ç‚¹ä¸Šé¢å»çš„å‘¢ï¼Ÿåˆæ˜¯å¦‚ä½•ä¿è¯åœ¨ç½‘ç»œåˆ†åŒºçš„æƒ…å†µä¸‹èƒ½æ­£å¸¸å·¥ä½œä¸‹å»ï¼Ÿraftåè®®åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿå¸¦ç€è¿™äº›é—®é¢˜æˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ã€‚ rafté€‰ä¸¾ç­–ç•¥æˆ‘ä»¬çŸ¥é“etcdä½¿ç”¨raftåè®®æ¥ä¿è¯æ•´ä¸ªåˆ†å¸ƒå¼çš„èŠ‚ç‚¹ç½‘ç»œèƒ½æ­£å¸¸çš„è¿è½¬å¹¶ä¸”èƒ½æ­£ç¡®çš„å°†æ•°æ®å¤åˆ¶åˆ°æ¯ä¸ªèŠ‚ç‚¹ä¸Šé¢å»ã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯raftåè®®å˜ï¼Ÿ é¦–å…ˆæˆ‘ä»¬æœ‰è¿™æ ·ä¸€ä¸ªèƒŒæ™¯ï¼šraftæ˜¯æƒ³ç»´æŠ¤æ•´ä¸€ä¸ªç½‘ç»œï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªé¢†å¯¼äººï¼Œè¿™ä¸ªé¢†å¯¼äººè´Ÿè´£å°†æ”¶åˆ°çš„ä¿¡æ¯åŒæ­¥ç»™ç½‘ç»œä¸­çš„å…¶ä»–æ‰€æœ‰èŠ‚ç‚¹ï¼Œä»è€Œä¿è¯æ•´ä¸ªç½‘ç»œæ•°æ®ä¸€è‡´ã€‚ å¦‚æœä½ æœ‰ä¸€å®šçš„è‹±æ–‡åŸºç¡€ï¼Œæˆ‘å»ºè®®ç›´æ¥æŸ¥çœ‹ä¸‹é¢è¿™ä¸ªç½‘ç«™ï¼Œå®ƒç”¨åŠ¨ç”»éå¸¸æ¸…æ¥šçš„æè¿°äº†rafté€‰ä¸¾çš„æ•´ä¸ªè¿‡ç¨‹ï¼šhttp://thesecretlivesofdata.com/raft/ è¿™ä¸ªå…¶å®å·²ç»è¯´æ˜çš„è¶…çº§æ£’äº†ï¼Œå¦‚æœä½ è¿˜çœ‹ä¸æ‡‚ï¼Œæˆ‘ä¸‹é¢ä¼šç”¨æœ€ç®€å•çš„å‡ ä¸ªè¦ç‚¹æ¥è¿›è¡Œæœ€ç®€å•çš„è¯´æ˜ã€‚ å¤§å¤šæ•°ç†è®ºé¦–å…ˆè¯´æ˜ä¸€ä¸ªç†è®ºï¼Œå«åšå¤§å¤šæ•°ç†è®ºï¼Œå¾ˆç®€å•ï¼Œä¸¾ä¸ªæ —å­ï¼š æœ‰10ä¸ªäººï¼Œå¦‚æœä½ å°†è‹¹æœç»™å…¶ä¸­çš„6ä¸ªäººï¼ˆå¤§å¤šæ•°ï¼‰ï¼Œé‚£ä¹ˆä½ éšæœºé€‰æ‹©5ä¸ªäººï¼Œä¸€å®šæœ‰ä¸€ä¸ªäººä¼šæœ‰è‹¹æœã€‚ åœ¨etcdä¸­çš„åº”ç”¨ï¼š é€‰ä¸¾ä¸­åªè¦æœ‰å¤§å¤šæ•°ï¼ˆè¶…è¿‡åŠæ•°çš„äººç»™ä½ æŠ•ç¥¨ï¼‰ä½ è‚¯å®šå°±æ˜¯ç¥¨æ•°æœ€å¤šçš„äº†ï¼Œä¸å¯èƒ½æœ‰äººæ¯”ä½ æ›´å¤šã€‚ åªéœ€è¦å°†æ—¥å¿—å¤åˆ¶ç»™å¤§å¤šæ•°çš„èŠ‚ç‚¹ï¼Œé‚£ä¹ˆåªè¦æœ‰ä¸€åŠçš„èŠ‚ç‚¹æ­£å¸¸å·¥ä½œå°±èƒ½ä¿è¯æ•°æ®æœ€æ–° é€‰ä¸¾çŠ¶æ€ä¸‹é¢æ˜¯ä¸€äº›é€‰ä¸¾è¿‡ç¨‹ä¸­èŠ‚ç‚¹çš„çŠ¶æ€leader è¡¨ç¤ºé€‰ä¸¾æœ€ç»ˆäº§ç”Ÿçš„é¢†å¯¼äººcandidate å€™é€‰çŠ¶æ€ï¼Œè¡¨ç¤ºå½“å‰æ­£åœ¨å‚ä¸é€‰ä¸¾follower è¡¨ç¤ºé€‰ä¸¾æœ€ç»ˆè‡ªå·±ä¸æ˜¯é¢†å¯¼äººï¼Œé‚£è‡ªå·±å°±æ˜¯ä»å±èŠ‚ç‚¹ é€‰ä¸¾è¿‡ç¨‹ä¸è¦ç‚¹ æ‰€æœ‰èŠ‚ç‚¹ä¸€å¼€å§‹éƒ½æ˜¯followerçŠ¶æ€ å½“èŠ‚ç‚¹å¤„äºfollowerçŠ¶æ€æ—¶ï¼Œæ¯ä¸ªèŠ‚ç‚¹éšæœºç»è¿‡ä¸€æ®µæ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰æ”¶åˆ°leaderçš„æ¶ˆæ¯å°±ä¼šè¿›å…¥candidateçŠ¶æ€ï¼ˆè¯æ˜å½“å‰æ²¡æœ‰leaderèŠ‚ç‚¹éœ€è¦é‡æ–°è¿›è¡Œé€‰ä¸¾ï¼‰ï¼Œå¦‚æœæ”¶åˆ°ä¿¡æ¯å°±ä¼šç»§ç»­ä¿æŒfollowerçŠ¶æ€ å½“èŠ‚ç‚¹å¤„äºcandidateå°±ä¼šè¦æ±‚åˆ«äººç»™è‡ªå·±æŠ•ç¥¨ï¼Œæ”¶åˆ°å¤§å¤šæ•°çš„èŠ‚ç‚¹çš„æŠ•ç¥¨é‚£å°±è½¬å˜ä¸ºleaderçŠ¶æ€ï¼Œå¦åˆ™è¦ä¹ˆæ˜¯åˆ«çš„èŠ‚ç‚¹æˆä¸ºäº†leaderï¼Œè¦ä¹ˆå°±æ˜¯å› ä¸ºç‰¹æ®Šæƒ…å†µå¯¼è‡´è¿™æ¬¡é€‰ä¸¾å¤±è´¥é‡æ–°è¿›è¡Œé€‰ä¸¾ æ¯æ¬¡é€‰ä¸¾ä¸¾åŠçš„æ—¶å€™æœ‰ä¸€ä¸ªtermï¼Œåœ¨æ¯ä¸€ä¸ªtermä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹åªèƒ½æŠ•ç¥¨ä¸€æ¬¡ æŠ•ç¥¨çš„æ—¶å€™å¿…é¡»æŠ•ç»™å½“å‰æ•°æ®è‡³å°‘å’Œè‡ªå·±ä¸€æ ·çš„èŠ‚ç‚¹ï¼Œå¹¶ä¸”termå¤§çš„ä¼˜å…ˆ æ—¥å¿—å¤åˆ¶è§„åˆ™etcdæ˜¯é€šè¿‡æ—¥å¿—å¤åˆ¶æ¥å®ç°æ•°æ®åŒæ­¥çš„è¿™ä¸ªå›¾ç½‘ä¸Šä¹Ÿå¾ˆå¤šï¼Œè¯´æ˜çš„æ˜¯æ—¥å¿—å¤åˆ¶çš„è§„åˆ™æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä»½è‡ªå·±çš„æ—¥å¿—ï¼Œæœ‰çš„èŠ‚ç‚¹å¤šï¼Œæœ‰çš„èŠ‚ç‚¹å°‘ï¼Œæ—¥å¿—æœ€å¤šçš„è‚¯å®šæ˜¯leaderã€‚ä¸Šå›¾è¿˜æœ‰å‡ ä¸ªè¦ç‚¹ï¼Œæˆ‘çœ‹åˆ«äººæ²¡æåˆ°ï¼Œæˆ‘å°±æä¸€ä¸‹ï¼š é¢œè‰²ä»£è¡¨term ç¬¬å››è¡Œè¡¨ç¤ºçš„è¿™ä¸ªèŠ‚ç‚¹ï¼Œç¬¬ä¸€termä¸‹å¤åˆ¶äº†ä¸¤ä¸ªæ—¥å¿—å°±å¼‚å¸¸æŒ‚æ‰äº† æœ€ç»ˆåªæœ‰ç¬¬ä¸‰è¡Œè¿™ä¸ªfollowerå’Œç¬¬ä¸€è¡Œçš„leaderä¿æŒäº†åŒæ­¥ å¼‚å¸¸æƒ…å†µraftä¹‹æ‰€ä»¥å‰å®³å› ä¸ºå³ä½¿å‡ºç°ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼Œæ•´ä¸ªç½‘ç»œåœ¨ä¸€å®šçš„æ—¶é—´ä¹‹åä¹Ÿèƒ½è‡ªåŠ¨æ¢å¤å¹¶æ­£å¸¸å·¥ä½œã€‚ ä¸€ä¸ªèŠ‚ç‚¹çš„å¼‚å¸¸é¦–å…ˆæœ€å¸¸è§çš„æƒ…å†µå°±æ˜¯ä¸€ä¸ªèŠ‚ç‚¹å‡ºç°å¼‚å¸¸ï¼Œæœ‰å¯èƒ½æ˜¯è¿™ä¸ªèŠ‚ç‚¹çš„æœåŠ¡å™¨æŒ‚äº†ï¼Œæˆ–è€…åˆ«çš„ä»€ä¹ˆåŸå› ã€‚ å¦‚æœå‡ºç°é—®é¢˜çš„è¿™ä¸ªèŠ‚ç‚¹æ˜¯followerï¼Œé‚£ä¹ˆæ²¡æœ‰å…³ç³»ï¼Œæ•´ä¸ªç½‘ç»œä¾æ—§èƒ½æ­£å¸¸è¿è¡Œï¼Œå½“è¿™ä¸ªèŠ‚ç‚¹å†æ¬¡åŠ å…¥ç½‘ç»œçš„æ—¶å€™ä¹Ÿåªéœ€è¦åŒæ­¥åé¢çš„æ•°æ®å³å¯ã€‚ å¦‚æœå‡ºç°é—®é¢˜çš„æ˜¯leaderï¼Œæœ‰ä¸€ç‚¹éº»çƒ¦ï¼Œå› ä¸ºç½‘ç»œä¸­æ²¡æœ‰leaderèŠ‚ç‚¹äº†ï¼Œé‚£ä¹ˆå°±ä¼šé‡æ–°è¿›è¡Œé€‰ä¸¾ï¼Œé‡æ–°æ‰¾ä¸€ä¸ªleaderï¼Œå½“è¿™ä¸ªå¼‚å¸¸èŠ‚ç‚¹æ¢å¤ä¹‹åå‘ç°å½“å‰ç½‘ç»œä¸­æœ‰leaderäº†ï¼Œè€Œä¸”termè¿˜æ¯”è‡ªå·±å¤§ï¼Œé‚£ä¹ˆè‡ªå·±å°±é€€ä½ç§°ä¸ºfollowerã€‚ ç½‘ç»œåˆ†åŒºè¿˜æœ‰ä¸€ç§å¼‚å¸¸æƒ…å†µæ˜¯ç”±äºç½‘ç»œå¯¼è‡´çš„ï¼Œç½‘ç»œå‡ºç°å¼‚å¸¸ï¼Œå¯¼è‡´èŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡å­˜åœ¨å¼‚å¸¸ï¼Œä¸€éƒ¨åˆ†èŠ‚ç‚¹ä¸å¦ä¸€éƒ¨åˆ†ä¹‹é—´æ²¡æœ‰åŠæ³•è®¿é—®äº†ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ä¸Šé¢ä¸‰ä¸ªfolloweræ²¡æœ‰åŠæ³•ä¸ä¸‹é¢çš„èŠ‚ç‚¹è¿›è¡Œé€šä¿¡ã€‚ å½“å®¢æˆ·ç«¯å†æ¬¡è¯·æ±‚leaderå‘é€æ•°æ®çš„æ—¶å€™ï¼Œleaderå‘ç°æ²¡æœ‰åŠæ³•å°†æ•°æ®åŒæ­¥ç»™ç»™å¤§å¤šæ•°èŠ‚ç‚¹ï¼Œå®ƒåªèƒ½ç»™è‡ªå·±å’Œæ—è¾¹çš„ä¸€ä¸ªï¼Œæ­¤æ—¶leaderæ²¡æœ‰åŠæ³•ç»™å®¢æˆ·ç«¯åé¦ˆã€‚ ä¸Šé¢ä¸‰ä¸ªèŠ‚ç‚¹ç”±äºæ”¶ä¸åˆ°leaderçš„æ¶ˆæ¯ï¼Œé‚£ä¹ˆä¼šè®¤ä¸ºç½‘ç»œä¸­æ²¡æœ‰leaderå­˜åœ¨ï¼Œä¼šé‡æ–°è¿›è¡Œé€‰ä¸¾æ“ä½œï¼Œå› ä¸ºå½“å‰ä¸Šé¢æœ‰ä¸‰ä¸ªèŠ‚ç‚¹å­˜åœ¨ï¼ˆåªè¦æœ‰è¶…è¿‡åŠæ•°çš„èŠ‚ç‚¹å‚ä¸é€‰ä¸¾å°±è¡Œï¼‰ï¼Œæ‰€ä»¥å¯ä»¥é‡æ–°é€‰ä¸¾æˆåŠŸï¼Œé€‰å‡ºæ–°çš„leaderå‘Šè¯‰å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å°±ä¼šé‡æ–°å‘é€æ•°æ®åˆ°æ–°çš„leaderã€‚ å½“ç½‘ç»œæ¢å¤ä¹‹ååˆä¼šæ‰¾åˆ°æœ€æ–°çš„leaderä»è€Œå°†æ•°æ®åŒæ­¥è‡³æœ€æ–°çš„çŠ¶æ€ã€‚ æ€»ç»“æ€»çš„æ¥è¯´ï¼Œåªè¦æ•´ä¸ªç½‘ç»œä¸­å­˜åœ¨å¤§å¤šæ•°èŠ‚ç‚¹æ­£å¸¸è¿è¡Œï¼Œé‚£ä¹ˆetcdå°±æ˜¯å¯ç”¨çš„ï¼Œå¹¶ä¸”èƒ½å¤Ÿä¿è¯æ•°æ®æ­£ç¡®ã€‚å½“ç½‘ç»œæ¢å¤ä¹‹åä¹Ÿèƒ½å°†æ•°æ®è°ƒæ•´åˆ°æœ€æ–°çš„çŠ¶æ€ã€‚raftå¼ºå¤§çš„åœ°æ–¹åœ¨äºå®ƒèƒ½è‡ªåŠ¨çš„è¿›è¡ŒçŠ¶æ€çš„å˜åŒ–ï¼Œè‡ªåŠ¨è¿›è¡Œé€‰ä¸¾ï¼Œå¹¶ä¸”é€‰ä¸¾éµå¾ªä¸€å®šçš„ç­–ç•¥ï¼Œè¿›è€Œä¿è¯æ•´ä¸ªç½‘ç»œçš„æ­£å¸¸è¿è½¬ã€‚åŒæ—¶ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚äº†è§£etcdçš„è¿™ä¸ªåŸç†æœ‰åŠ©äºæˆ‘ä»¬åç»­çš„ä½¿ç”¨ä»¥åŠæºç çš„é˜…è¯»ã€‚]]></content>
      <categories>
        <category>etcd</category>
      </categories>
      <tags>
        <tag>etcd</tag>
        <tag>raft</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æµ…å…¥æ·±å‡ºETCDä¹‹ã€ç®€ä»‹ä¸å‘½ä»¤è¡Œä½¿ç”¨ã€‘]]></title>
    <url>%2F2019%2F06%2F10%2Fgolang%2Fopen-source-component%2Fetcd-brief%2F</url>
    <content type="text"><![CDATA[ä½ çŸ¥é“etcdå—ï¼Ÿéšç€k8sçš„ä½¿ç”¨å¹¿æ³›ä¹‹åï¼Œetcdè¢«éå¸¸å¤šçš„äººæ‰€çŸ¥é“ï¼ŒåŒæ—¶åˆå› ä¸ºå®ƒå¯é çš„åˆ†å¸ƒå¼ç‰¹æ€§è¢«å¾ˆå¤šäººå–œæ¬¢ã€‚æ‰€ä»¥ï¼Œæˆ‘å‡†å¤‡æœ‰å‡ ç¯‡åšæ–‡æ¥è®°å½•ä¸€ä¸‹ï¼Œä»åŸºæœ¬ä½¿ç”¨åˆ°çº¿ä¸Šéƒ¨ç½²å†åˆ°åŸç†åˆ†æï¼Œåšä¸€ä¸ªç³»åˆ—ã€‚é‚£ä¹ˆï¼Œä»Šå¤©å…ˆæ¥è¯´è¯´å®ƒçš„ç®€ä»‹ä¸å‘½ä»¤è¡Œçš„ä½¿ç”¨ã€‚ ç®€ä»‹ETCDæ˜¯ä»€ä¹ˆæˆ‘ä¸ªäººæ€»ç»“ä¸ºä¸‹é¢ç”¨å‡ ä¸ªè¦ç‚¹ï¼š é«˜å¯ç”¨K-Vå­˜å‚¨ï¼Œå°±ç±»ä¼¼äºredisä¸€æ ·çš„é”®å€¼å¯¹å­˜å‚¨ã€‚ å…è®¸åº”ç”¨å®æ—¶ç›‘å¬å­˜å‚¨ä¸­çš„K-Vå˜åŒ–ã€‚ èƒ½å¤Ÿå®¹å¿å•ç‚¹æ•…éšœï¼Œèƒ½å¤Ÿåº”å¯¹ç½‘ç»œåˆ†åŒºã€‚ etcdåˆ©ç”¨raftåœ¨é›†ç¾¤ä¸­åŒæ­¥K-Vä¿¡æ¯ï¼Œraftæ˜¯å¼ºä¸€è‡´çš„é›†ç¾¤æ—¥å¿—åŒæ­¥ç®—æ³•ã€‚ æ€»ç»“ï¼šetcdæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼é«˜å¯ç”¨k-vå­˜å‚¨ï¼Œé€šè¿‡å¤åˆ¶è¾¾åˆ°æ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨çš„ä¿¡æ¯ä¸€è‡´ï¼Œä»è€Œä¿è¯é«˜å¯ç”¨ã€‚ æ•°æ®å¤åˆ¶è¿™é‡Œç®€å•è¯´ä¸€ä¸‹å¤åˆ¶çš„å…·ä½“æµç¨‹ï¼š ï¼ˆclientä¸ºæˆ‘ä»¬çš„å®¢æˆ·ç«¯ï¼Œç”¨æ¥å‘å‡ºå­˜å‚¨è¯·æ±‚ï¼Œleaderå’Œfolloweréƒ½æ˜¯etcdçš„èŠ‚ç‚¹ï¼‰å°±å¦‚å›¾ä¸Šæ‰€çœ‹åˆ°çš„ï¼Œæˆ‘å«å®ƒä¸¤æ®µå¼æäº¤ï¼š å®¢æˆ·ç«¯è¯·æ±‚leaderå‘é€å­˜å‚¨çš„æ•°æ®ï¼Œç„¶åleaderèŠ‚ç‚¹è¦å°†ä¿¡æ¯é€šè¿‡æ—¥å¿—å¤åˆ¶ç»™å¤§å¤šæ•°çš„followerèŠ‚ç‚¹ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåªéœ€è¦å¤åˆ¶ç»™ä¸¤ä¸ªï¼ˆåŠ ä¸Šå®ƒè‡ªå·±æ˜¯ä¸‰ä¸ªï¼‰é‚£ä¹ˆå°±æ˜¯å¤§å¤šæ•°èŠ‚ç‚¹ã€‚ leaderå½“å¤åˆ¶å®Œæˆä¹‹åæ‰ä¼šæœ¬åœ°æäº¤ï¼Œç„¶åè¿”å›ç»™å®¢æˆ·ç«¯æˆåŠŸï¼Œï¼ˆå¦‚æœæ²¡æœ‰æˆ–è€…ä¸èƒ½å¤åˆ¶ç»™å¤§å¤šæ•°èŠ‚ç‚¹ï¼Œé‚£ä¹ˆåˆ™å­˜å‚¨å¤±è´¥ï¼‰æ­¤æ—¶å†åŒæ—¶å…¶ä»–followerå»ä»–ä»¬è‡ªå·±æœ¬åœ°æäº¤ã€‚æ˜¯ä¸æ˜¯æœ‰ä¸€ç§åˆ†å¸ƒå¼äº‹åŠ¡çš„æ„Ÿè§‰ï¼Ÿåˆ†å¸ƒå¼çš„è§£å†³é€šå¸¸éƒ½æ˜¯è¿™ç§æ„Ÿè§‰ã€‚ æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œetcdé€šè¿‡å…ˆå°†æ•°æ®å­˜æ”¾åœ¨å¤§å¤šæ•°èŠ‚ç‚¹ä¸Šé¢ä»è€Œä¿è¯æ•°æ®ä¸ä¼šå‡ºé”™å¹¶ä¸”æ•ˆç‡è¾ƒé«˜ï¼Œæœ€ç»ˆæ‰€æœ‰èŠ‚ç‚¹æ•°æ®è¿˜æ˜¯ä¼šåŒæ­¥ä¸€è‡´çš„ã€‚ å®˜æ–¹ç»™å‡ºå†™å…¥çš„æ€§èƒ½ï¼š1000/s PS:è¿™é‡Œå› ä¸ºæ˜¯ç®€ä»‹ï¼Œæ‰€ä»¥å°±ç®€å•æä¸€ä¸‹ï¼Œæœ‰å…³å¦‚ä½•é€‰ä¸¾å‡ºleaderè¿˜æœ‰raftåè®®çš„ä¸€äº›å…·ä½“ç»†èŠ‚ï¼Œä»¥åŠå½“å‡ºç°ç½‘ç»œåˆ†åŒºæˆ–è€…èŠ‚ç‚¹å¼‚å¸¸é—®é¢˜çš„æ¢å¤ä¼šåœ¨ä¹‹åçš„åšå®¢ä¸­ç»™å‡ºã€‚ å­˜å‚¨ç»“æ„åº•å±‚å­˜å‚¨keyæ˜¯æœ‰åºæ’åˆ—çš„â€˜keyâ€™ -&gt; â€˜valueâ€™ aaa/bbb -&gt; 111aaa/bbc -&gt; 3333bbb/aaa -&gt; 1321ccc -&gt; 24å°±æ˜¯æŒ‰ç…§keyçš„é¡ºåºä¾æ¬¡æ’åˆ—ï¼Œç›¸åŒå‰ç¼€çš„keyä¼šè¢«æ”¾åœ¨ä¸€èµ·ï¼Œè¿™æ ·åˆ°å­˜å‚¨ç»“æ„ï¼Œå½“æŸ¥è¯¢æ—¶å¯ä»¥é€šè¿‡keyçš„å‰ç¼€å°†ä¸€ç³»åˆ—çš„valueéƒ½å–å‡ºæ¥ watchæœºåˆ¶å’Œleaseç§Ÿçº¦etcdæœ‰ä¸€ä¸ªå¾ˆæ£’çš„æœºåˆ¶è¦å•ç‹¬æä¸€å¥ï¼Œå°±æ˜¯watchï¼Œå®ƒå…è®¸ä½ å»ç›‘æ§ä¸€ä¸ªkeyçš„å˜åŒ–ã€‚å½“ä½ ç›‘æ§äº†ä¹‹åï¼Œè¿™ä¸ªkeyçš„æ·»åŠ ä¿®æ”¹åˆ é™¤éƒ½ä¼šè¢«ç›‘æ§åˆ°ã€‚leaseç§Ÿçº¦ï¼Œè¿™ä¸ªæœºåˆ¶å’Œredisä¸­çš„keyè¿‡æœŸæœºåˆ¶ä¸€æ ·ï¼Œå¯ä»¥ç”³è¯·ä¸€ä¸ªç§Ÿçº¦ï¼Œè¿™ä¸ªç§Ÿçº¦æœ‰ä¸€ä¸ªæ—¶é—´é™åˆ¶ï¼Œæ¯”å¦‚60ç§’ï¼Œä½ å¯ä»¥å°†è¿™ä¸ªç§Ÿçº¦è®¾ç½®åˆ°ä¸€ä¸ªkeyä¸Šï¼Œé‚£ä¹ˆè¿™ä¸ªkeyè¿‡60ç§’å°±ä¼šè¢«è‡ªåŠ¨åˆ é™¤ã€‚å½“ç„¶ä¹Ÿå¯ä»¥è¿›è¡Œç»­ç§Ÿã€‚ å…·ä½“ä½¿ç”¨æƒ…å†µï¼Œå¯ä»¥ä»åé¢çš„å‘½ä»¤è¡Œæ“ä½œä¸­çœ‹åˆ°ã€‚ è¿˜æœ‰ä¸€äº›å°ç‚¹ etcdä½¿ç”¨grpcï¼Œæ‰€ä»¥ç½‘ç»œæ€§èƒ½ä¼šé«˜ éƒ¨ç½²èŠ‚ç‚¹æ•°é‡è¦æ±‚æ˜¯2N+1ä¸ª é€‰ä¸¾leaderéœ€è¦åŠæ•°ä»¥ä¸Šçš„èŠ‚ç‚¹å‚ä¸ etcdæ˜¯æ”¯æŒäº‹åŠ¡æ“ä½œçš„ï¼Œå¯ä»¥ifç¬¬ä¸€æ¬¡aæäº¤æ­£å¸¸ï¼Œthenæäº¤bï¼Œelseä¸æäº¤b æœ¬åœ°å•èŠ‚ç‚¹éƒ¨ç½²æˆ‘ä»¬ä¸€å¼€å§‹å­¦ä¹ å’Œæµ‹è¯•çš„æ—¶å€™åªéœ€è¦åœ¨æœ¬åœ°éƒ¨ç½²ä¸€ä¸ªå•èŠ‚ç‚¹å°±å¯ä»¥äº†ï¼Œå•èŠ‚ç‚¹çš„éƒ¨ç½²æ¯”è¾ƒæ–¹ä¾¿è¿™è¾¹ç®€å•è¯´æ˜ä¸€ä¸‹ã€‚é¦–å…ˆä¸‹è½½å¯¹åº”çš„ç‰ˆæœ¬ï¼šhttps://github.com/etcd-io/etcd/releasesæˆ‘è¿™è¾¹ä½¿ç”¨çš„macå¯¹åº”çš„darwin-amd64çš„ç‰ˆæœ¬ï¼Œå…¶ä»–ç‰ˆæœ¬åº”è¯¥ç±»ä¼¼ã€‚ä¸‹è½½è§£å‹ä¹‹åæœ‰ä¸¤ä¸ªæ–‡ä»¶æ¯”è¾ƒé‡è¦ï¼š etcd è¿™ä¸ªæ˜¯èŠ‚ç‚¹ etcdctl è¿™ä¸ªæ˜¯å®¢æˆ·ç«¯è¿›å…¥æ‰€åœ¨ç›®å½•ä½¿ç”¨å‘½ä»¤è¿›è¡Œå¯åŠ¨å’Œä½¿ç”¨ ä½¿ç”¨èŠ‚ç‚¹å‘½ä»¤1âœ ./etcd ä½¿ç”¨å®¢æˆ·ç«¯å‘½ä»¤1234567âœ ./etcdctlNAME: etcdctl - A simple command line client for etcd.WARNING: Environment variable ETCDCTL_API is not set; defaults to etcdctl v2. Set environment variable ETCDCTL_API=3 to use v3 API or ETCDCTL_API=2 to use v2 API. ä¹‹åä¼šå‡ºç°ä¸Šè¿°ç±»ä¼¼è­¦å‘Šï¼Œå‘Šè¯‰ä½ ï¼Œé»˜è®¤ä½¿ç”¨çš„æ˜¯v2ç‰ˆæœ¬çš„APIï¼Œä½ éœ€è¦è®¾ç½®ç¯å¢ƒå˜é‡ETCDCTL_API=3å°±èƒ½ä½¿ç”¨v3ç‰ˆæœ¬çš„APIäº†ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨å‘½ä»¤export ETCDCTL_API=3 æˆ–è€…ä½ å¯ä»¥æ‰‹åŠ¨ä¿®æ”¹ç¯å¢ƒå˜é‡æ·»åŠ export ETCDCTL_API=3å°±å¯ä»¥äº†ï¼Œå½“ä¸å‡ºç°è­¦å‘Šçš„æ—¶å€™è¯æ˜ç¯å¢ƒå˜é‡è®¾ç½®æ­£ç¡®ã€‚ ç®€å•å‘½ä»¤è¡Œæ“ä½œä¸‹é¢ä»‹ç»å‡ ä¸ªæœ€åŸºæœ¬çš„etcdçš„æ“ä½œï¼Œå…¶å®éå¸¸ç®€å•ã€‚ä¸»è¦ä¸redisä¸åŒçš„æ˜¯æ‹¥æœ‰ç‹¬ç‰¹çš„watchæœºåˆ¶ï¼Œè¿™ä¸ªæœºåˆ¶éå¸¸æ£’ã€‚ put1234âœ ./etcdctl put /aaa/a 1OKâœ ./etcdctl put /aaa/b 2OK get12345678âœ ./etcdctl get /aaa/a/aaa/a1âœ ./etcdctl get --prefix /aaa/aaa/a1/aaa/b2 â€“prefixæ„æ€æ˜¯å–å‡ºæ‰€æœ‰å‰ç¼€ä¸º/aaaçš„key watchæ–°å¼€ä¸€ä¸ªçª—å£ä½¿ç”¨å‘½ä»¤watchè¿›è¡Œç›‘å¬1âœ ./etcdctl watch /aaa/a ç„¶åå¯¹/aaa/aè¿™ä¸ªkeyçš„æ“ä½œå…¨éƒ¨éƒ½ä¼šè¢«ç›‘å¬åˆ°1234âœ ./etcdctl put /aaa/a 123OKâœ ./etcdctl del /aaa/a1 123456âœ ./etcdctl watch /aaa/aPUT/aaa/a123DELETE/aaa/a leaseåˆ›å»ºä¸€ä¸ª60sçš„ç§Ÿçº¦12âœ ./etcdctl lease grant 60lease 694d6b2b7d7e6a0c granted with TTL(60s) 12âœ ./etcdctl put /aaa/a 123 --lease=694d6b2b7d7e6a0cOK putçš„æ—¶å€™ä½¿ç”¨ç§Ÿçº¦æ³¨æ„ï¼Œè¿™é‡Œéœ€è¦è¾“å…¥ä¸Šé¢ç§Ÿçº¦çš„16è¿›åˆ¶æ ‡è¯†ç¬¦ç„¶åç›‘å¬çš„åœ°æ–¹ä¼šå‘ç°ï¼Œ60ç§’åï¼Œ/aaa/aè¿™ä¸ªkeyè¢«è‡ªåŠ¨åˆ é™¤äº† å½“ç„¶ä½ å¯ä»¥ä½¿ç”¨keep-aliveè¿›è¡Œç»­ç§Ÿï¼Œå¦‚ï¼š1âœ ./etcdctl lease keep-alive 694d6b2ac4a35625 æ€»ç»“ä»¥ä¸Šç®€å•è¯´æ˜äº†etcdçš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼Œå•èŠ‚ç‚¹éƒ¨ç½²ï¼Œä»¥åŠä¸€äº›åŸºæœ¬ç”¨æ³•ï¼Œä»ä¸Šè¿°ä¿¡æ¯æˆ‘ä»¬æ€»ç»“å¯çŸ¥ï¼š etcdæ˜¯åˆ†å¸ƒå¼çš„ï¼Œèƒ½ä¿è¯åœ¨å•ç‚¹æ•…éšœä¸‹ä¹Ÿèƒ½æ­£å¸¸ä½¿ç”¨ åˆ†å¸ƒå¼ä¹Ÿä¼šå¯¼è‡´é—®é¢˜ï¼Œetcdå†™å…¥æ€§èƒ½ç›¸è¾ƒredisè‚¯å®šæœ‰æ‰€ä¸åŠ etcdç‹¬ç‰¹çš„watchæœºåˆ¶å¯ä»¥ç”¨äºå¾ˆå¤šåœºæ™¯ï¼Œå¦‚é…ç½®æ›´æ–°åˆ†å‘ç­‰ é‚£è¿™é‡Œå°±è¯´è¿™ä¹ˆå¤šï¼Œçœ‹å®Œä½ å°±åº”è¯¥å¤§è‡´çŸ¥é“etcdæ˜¯ä¸ªå•¥ç©æ„äº†ï¼Œä»ç°åœ¨çœ‹æ¥ä½ å¯èƒ½è¿˜æ²¡æœ‰æ„Ÿè§‰å®ƒæœ‰ä»€ä¹ˆå‰å®³çš„åœ°æ–¹ï¼Œåé¢æˆ‘ä»¬ç»“åˆå®é™…çš„åœºæ™¯ä½¿ç”¨å°±èƒ½æ›´åŠ æ˜ç™½äº†ã€‚]]></content>
      <categories>
        <category>etcd</category>
      </categories>
      <tags>
        <tag>etcd</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[GolangæŒ‡é’ˆä¸unsafe]]></title>
    <url>%2F2019%2F06%2F06%2Fgolang%2Fsource-code%2Fpoint-unsafe%2F</url>
    <content type="text"><![CDATA[æˆ‘ä»¬çŸ¥é“åœ¨golangä¸­æ˜¯å­˜åœ¨æŒ‡é’ˆè¿™ä¸ªæ¦‚å¿µçš„ã€‚å¯¹äºæŒ‡é’ˆå¾ˆå¤šäººæœ‰ç‚¹å¿Œæƒ®ï¼ˆå¯èƒ½æ˜¯å› ä¸ºä¹‹å‰å­¦ä¹ è¿‡Cè¯­è¨€ï¼‰ï¼Œå› ä¸ºå®ƒä¼šå¯¼è‡´å¾ˆå¤šå¼‚å¸¸çš„é—®é¢˜ã€‚ä½†æ˜¯å¾ˆå¤šäººå­¦ä¹ ä¹‹åå‘ç°ï¼Œgolangä¸­çš„æŒ‡é’ˆå¾ˆç®€å•ï¼Œæ²¡æœ‰Cé‚£ä¹ˆå¤æ‚ã€‚æ‰€ä»¥ä»Šå¤©å°±è¯¦ç»†æ¥è¯´è¯´æŒ‡é’ˆã€‚ æŒ‡é’ˆçš„ä½¿ç”¨123a := 1p := &amp;afmt.Println(p) è¾“å‡ºï¼š0xc42001c070 å¯ä»¥çœ‹åˆ°på°±æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯açš„åœ°å€ã€‚ 1234a := 1var p *intp = &amp;afmt.Println(p) æˆ–è€…ä¹Ÿå¯ä»¥å†™æˆè¿™æ ·ï¼Œå› ä¸ºæˆ‘çŸ¥é“ï¼Œåœ¨å¾ˆå¤šäººçœ‹æ¥ï¼Œçœ‹åˆ°*å·æ‰æ˜¯æŒ‡é’ˆï¼ˆæ‰‹åŠ¨æ»‘ç¨½ï¼‰ 123a := 1p := &amp;afmt.Println(*p) è¾“å‡ºï¼š1 ç„¶åä½¿ç”¨å°±ç›´æ¥é€šè¿‡*å·å°±èƒ½å»åˆ°å¯¹åº”çš„å€¼äº†ï¼Œå°±è¿™ä¹ˆç®€å• æŒ‡é’ˆçš„é™åˆ¶Golangä¸­æŒ‡é’ˆä¹‹æ‰€ä»¥çœ‹èµ·æ¥å¾ˆç®€å•ï¼Œæ˜¯å› ä¸ºæŒ‡é’ˆçš„åŠŸèƒ½ä¸å¤šã€‚æˆ‘ä»¬èƒ½çœ‹åˆ°çš„åŠŸèƒ½å°±æ˜¯æŒ‡é’ˆçš„æŒ‡å‘ä¸€ä¸ªåœ°å€è€Œå·²ï¼Œç„¶åå¯¹äºè¿™ä¸ªåœ°å€ä¹Ÿåªèƒ½è¿›è¡Œä¼ é€’ï¼Œæˆ–è€…é€šè¿‡è¿™ä¸ªçš„åœ°å€å»è®¿é—®å€¼ã€‚ ä¸èƒ½åƒCè¯­è¨€ä¸­ä¸€æ ·p++ï¼Œè¿™æ ·ç§»åŠ¨æ“ä½œæŒ‡é’ˆï¼Œå› ä¸ºå…¶å®è¿™æ ·æ“ä½œç¡®å®ä¸å®‰å…¨ï¼Œå¾ˆå®¹æ˜“è®¿é—®åˆ°å¥‡æ€ªçš„åŒºåŸŸã€‚ ä¸åŒç±»å‹çš„æŒ‡é’ˆä¸èƒ½ç›¸äº’èµ‹å€¼ã€è½¬æ¢ã€æ¯”è¾ƒã€‚ä¼šå‡ºç°cannot use &amp;a (type int) as type float32 in assignmentç±»ä¼¼è¿™æ ·çš„é”™è¯¯ å¦‚æœåªæ˜¯å•çº¯è¯´goä¸­æŒ‡é’ˆçš„åŠŸèƒ½ï¼Œä¸Šé¢å°±å·²ç»è¯´å®Œäº†ï¼Œæ²¡å¿…è¦å†™åšå®¢ï¼Œä½†æ˜¯å…¶å®goä¸­è¿˜æœ‰ä¸€ä¸ªåŒ…å«unsafeï¼Œæœ‰äº†å®ƒï¼ŒæŒ‡é’ˆå°±å¯ä»¥åƒCä¸€æ ·æƒ³å¹²å˜›å¹²å˜›äº†ã€‚ unsafeä¸‰ä¸ªç±»å‹å…¶å®æŒ‡é’ˆæœ‰ä¸‰ç§ï¼šä¸€ç§æ˜¯æˆ‘ä»¬å¸¸è§çš„*ï¼Œç”¨*å»è¡¨ç¤ºçš„æŒ‡é’ˆï¼›ä¸€ç§æ˜¯unsafe.Pointerï¼ŒPointeræ˜¯unsafeåŒ…ä¸‹çš„ä¸€ä¸ªç±»å‹ï¼›æœ€åä¸€ç§æ˜¯uintptrï¼Œuintptrå°±å‰å®³äº†ï¼Œè¿™ç©æ„æ˜¯å¯ä»¥è¿›è¡Œè¿ç®—çš„ä¹Ÿå°±æ˜¯å¯ä»¥++â€“ï¼› ä»–ä»¬ä¹‹é—´æœ‰è¿™æ ·çš„è½¬æ¢å…³ç³»ï¼š* &lt;=&gt; unsafe.Pointer &lt;=&gt; uintptr æœ‰ä¸€ç‚¹è¦æ³¨æ„çš„æ˜¯ï¼Œuintptr å¹¶æ²¡æœ‰æŒ‡é’ˆçš„è¯­ä¹‰ï¼Œæ„æ€å°±æ˜¯ uintptr æ‰€æŒ‡å‘çš„å¯¹è±¡ä¼šè¢« gc æ— æƒ…åœ°å›æ”¶ã€‚è€Œ unsafe.Pointer æœ‰æŒ‡é’ˆè¯­ä¹‰ï¼Œå¯ä»¥ä¿æŠ¤å®ƒæ‰€æŒ‡å‘çš„å¯¹è±¡åœ¨â€œæœ‰ç”¨â€çš„æ—¶å€™ä¸ä¼šè¢«åƒåœ¾å›æ”¶ã€‚ ä»è¿™æ ·çš„å…³ç³»ä½ å¤§æ¦‚å°±å¯ä»¥çŒœåˆ°ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æŒ‡é’ˆ*pè½¬æ¢æˆPointerç„¶åè½¬æ¢uintptrè¿›è¡Œè¿ç®—ä¹‹åå†åŸè·¯è¿”å›ï¼Œç†è®ºä¸Šå°±èƒ½ç­‰åŒäºè¿›è¡Œäº†æŒ‡é’ˆçš„è¿ç®—ã€‚æˆ‘ä»¬ä¸‹é¢å°±æ¥å®è·µä¸€ä¸‹ã€‚ unsafeæ“ä½œslice12345678910111213func main() &#123; s := make([]int, 10) s[1] = 2 p := &amp;s[0] fmt.Println(*p) up := uintptr(unsafe.Pointer(p)) up += unsafe.Sizeof(int(0)) // è¿™é‡Œå¯ä¸æ˜¯up++å“¦ p2 := (*int)(unsafe.Pointer(up)) fmt.Println(*p2)&#125; è¾“å‡ºï¼š02 ä»ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬é¦–å…ˆå°†æŒ‡é’ˆæŒ‡å‘åˆ‡ç‰‡çš„ç¬¬ä¸€ä¸ªä½ç½®ï¼Œç„¶åé€šè¿‡è½¬æ¢å¾—åˆ°uintptrï¼Œæ“ä½œuintptr + ä¸Š8ä½ï¼ˆæ³¨æ„è¿™é‡Œä¸èƒ½++å› ä¸ºå­˜æ”¾çš„æ˜¯intï¼Œä¸‹ä¸€ä¸ªå…ƒç´ ä½ç½®ç›¸éš”ä¸¾ä¾‹intä¸ªå­—èŠ‚ï¼‰ï¼Œæœ€åè½¬æ¢å›æ¥å¾—åˆ°æŒ‡é’ˆï¼Œå–å€¼ï¼Œå°±èƒ½å–åˆ°åˆ‡ç‰‡çš„ç¬¬äºŒä¸ªä½ç½®äº†ã€‚ unsafeæ“ä½œstructå½“ç„¶æœ‰äººè‚¯å®šè¦è¯´äº†ï¼Œä¸Šé¢é‚£ä¸ªä¸€é¡¿æ“ä½œçŒ›å¦‚è™ï¼Œä¸å°±æ˜¯è®¿é—®ä¸‹ä¸€ä¸ªä½ç½®å˜›ï¼Œæˆ‘ç›´æ¥è®¿é—®å°±è¡Œäº†ã€‚é‚£ä¸‹é¢å°±æ˜¯å‰å®³çš„æ¥äº†ï¼Œæˆ‘ä»¬çŸ¥é“å¦‚æœä¸€ä¸ªç»“æ„ä½“é‡Œé¢å®šä¹‰çš„å±æ€§æ˜¯ç§æœ‰çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªå±æ€§æ˜¯ä¸èƒ½è¢«å¤–ç•Œè®¿é—®åˆ°çš„ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ä¸‹é¢è¿™ä¸ªæ“ä½œï¼š 123456package basictype User struct &#123; age int name string&#125; 12345678910111213141516package mainfunc main() &#123; user := &amp;basic.User&#123;&#125; fmt.Println(user) s := (*int)(unsafe.Pointer(user)) *s = 10 up := uintptr(unsafe.Pointer(user)) + unsafe.Sizeof(int(0)) namep := (*string)(unsafe.Pointer(up)) *namep = "xxx" fmt.Println(user)&#125; Useræ˜¯å¦å¤–ä¸€ä¸ªbasicåŒ…ä¸­çš„ç»“æ„ä½“ï¼Œå…¶ä¸­çš„ageæ˜¯å°å†™å¼€å¤´çš„ï¼Œç†è®ºä¸Šæ¥è¯´ï¼Œæˆ‘ä»¬åœ¨å¤–éƒ¨æ²¡æœ‰åŠæ³•ä¿®æ”¹ageçš„å€¼ï¼Œä½†æ˜¯ç»è¿‡ä¸Šé¢è¿™æ³¢æ“ä½œä¹‹åï¼Œè¾“å‡ºä¿¡æ¯æ˜¯ï¼š&amp;{0 }&amp;{10 xxx}ä¹Ÿå°±æ˜¯è¯´æˆåŠŸæ“ä½œåˆ°äº†ç»“æ„ä½“çš„ç§æœ‰å±æ€§ã€‚ é¡ºä¾¿æä¸€å¥ï¼šåˆ›å»ºç»“æ„ä½“ä¼šè¢«åˆ†é…ä¸€å—è¿ç»­çš„å†…å­˜ï¼Œç»“æ„ä½“çš„åœ°å€ä¹Ÿä»£è¡¨äº†ç¬¬ä¸€ä¸ªæˆå‘˜çš„åœ°å€ã€‚ ä¸‹é¢æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹ä½ æ˜¯å¦å·²ç»å­¦ä¼šäº†unsafeçš„æ“ä½œï¼Œå°è¯•ä¸çœ‹ä¸€ä¸ªå°ç»“ï¼Œè‡ªå·±å°è¯•ä¸€ä¸‹ï¼šå¦‚ä½•å®Œæˆå­—ç¬¦ä¸²åˆ°[]byteçš„è½¬æ¢ï¼Œå¹¶ä¸”ä¸å¼€è¾Ÿæ–°çš„ç©ºé—´ï¼Ÿ å­—ç¬¦ä¸²å’Œbyteæ•°ç»„è½¬æ¢inplaceæˆ‘ä»¬çŸ¥é“å¦‚æœå°†å­—ç¬¦ä¸²è½¬æ¢æˆ[]byteéå¸¸æ–¹ä¾¿12s := "123"a := []byte(s) ä½†æ˜¯è¿™æ ·éœ€è¦å¼€è¾Ÿé¢å¤–çš„ç©ºé—´ï¼Œé‚£ä¹ˆå¦‚ä½•å®ç°åŸåœ°çš„ï¼Œä¸éœ€è¦æ‹·è´æ•°æ®çš„è½¬æ¢å‘¢ï¼Ÿæˆ‘ä»¬æƒ³ä¸€ä¸‹ï¼Œå…¶å®ä»åº•å±‚çš„å­˜å‚¨è§’åº¦æ¥è¯´ï¼Œstringçš„å­˜å‚¨è§„åˆ™å’Œ[]byteæ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå…¶å®æŒ‡é’ˆéƒ½æ˜¯ä»æŸä¸ªä½ç½®å¼€å§‹åˆ°ä¸€æ®µç©ºé—´ï¼Œä¸­é—´ä¸€æ ¼ä¸€æ ¼ã€‚æ‰€ä»¥åˆ©ç”¨unsafeå°±å¯ä»¥åšåˆ°ã€‚ 123456789101112func main() &#123; s := "123" a := []byte(s) print("s = " , &amp;s, "\n") print("a = " , &amp;a, "\n") a2 := (*[]byte)(unsafe.Pointer(&amp;s)) print("a2 = " , a2, "\n") fmt.Println(*a2)&#125; è¾“å‡ºç»“æœï¼šs = 0xc420055f40a = 0xc420055f60a2 = 0xc420055f40[49 50 51] æˆ‘ä»¬å¯ä»¥çœ‹åˆ°så’Œaçš„åœ°å€æ˜¯ä¸ä¸€æ ·çš„ï¼Œä½†æ˜¯så’Œa2çš„åœ°å€æ˜¯ä¸€æ ·çš„ï¼Œå¹¶ä¸”a2å·²ç»æ˜¯ä¸€ä¸ª[]byteäº†ã€‚å˜¿å˜¿å˜¿~ä½ ä»¥ä¸ºè¿™æ ·å°±ç»“æŸäº†ï¼Ÿï¼Ÿï¼Ÿ å­˜åœ¨çš„é—®é¢˜å…¶å®è¿™ä¸ªè½¬æ¢æ˜¯å­˜åœ¨é—®é¢˜çš„ï¼Œé—®é¢˜å°±åœ¨æ–°çš„[]byteçš„Capæ²¡æœ‰æ­£ç¡®çš„åˆå§‹åŒ–ã€‚æˆ‘ä»¬æ‰“å°ä¸€ä¸‹capçœ‹ä¸€ä¸‹fmt.Println(â€œcap a =â€, cap(a))fmt.Println(â€œcap a2 =â€, cap(*a2))ç»“æœæ˜¯ï¼šcap a = 32cap a2 = 17418400è¿™ä¹ˆå¤§çš„å®¹é‡æ˜¯è¦ä¸Šå¤©å‘¢ï¼Ÿï¼Ÿï¼Ÿ é—®é¢˜çš„åŸå› åœ¨src/reflect/value.goä¸‹çœ‹12345678910type StringHeader struct &#123; Data uintptr Len int&#125;type SliceHeader struct &#123; Data uintptr Len int Cap int&#125; çœ‹åˆ°å…¶å®stringæ²¡æœ‰capè€Œ[]byteæœ‰ï¼Œæ‰€ä»¥å¯¼è‡´é—®é¢˜å‡ºç°ï¼Œä¹Ÿå®¹æ˜“ç†è§£ï¼Œstringæ˜¯æ²¡æœ‰å®¹é‡æ‰©å®¹è¿™ä¸ªè¯´æ³•çš„ï¼Œæ‰€ä»¥æ–°çš„[]byteæ²¡æœ‰èµ‹å€¼capæ‰€ä»¥ä½¿ç”¨äº†é»˜è®¤å€¼ã€‚ é—®é¢˜è§£å†³123456789stringHeader := (*reflect.StringHeader)(unsafe.Pointer(&amp;s))bh := reflect.SliceHeader&#123; Data: stringHeader.Data, Len: stringHeader.Len, Cap: stringHeader.Len,&#125;return *(*[]byte)(unsafe.Pointer(&amp;bh)) é€šè¿‡é‡æ–°è®¾ç½®SliceHeaderå°±å¯ä»¥å®Œæˆ æ€»ç»“ä»¥ä¸Šå°±æ˜¯æ‰€æœ‰golangæŒ‡é’ˆå’Œunsafeçš„ç›¸å…³ç»†èŠ‚å’Œä½¿ç”¨ã€‚é‚£ä¹ˆè‚¯å®šæœ‰äººä¼šé—®è¿™ä¸ªæœ‰ä»€ä¹ˆç”¨äº†ï¼Ÿ 1ã€æ²¡å•¥äº‹ä½ å°±åˆ«ä¹±ç”¨äº†ï¼Œåˆ«äººéƒ½è¯´unsafeä¸å®‰å…¨äº†ã€‚ 2ã€æºç ä¸­å¾ˆå¤šå¤§é‡çš„ä½¿ç”¨äº†æŒ‡é’ˆç§»åŠ¨çš„æ“ä½œã€‚ å¦‚mapä¸­é€šè¿‡keyè·å–valueçš„æ—¶å€™ï¼š v := add(unsafe.Pointer(b), dataOffset+bucketCnt uintptr(t.keysize)+i uintptr(t.valuesize)) é€šè¿‡æ¡¶çš„æŒ‡é’ˆçš„åç§»æ‹¿åˆ°å€¼ï¼Œå…·ä½“æˆ‘å°±ä¸å¤šä»‹ç»äº†ã€‚æ€»ä¹‹å¯¹äºä½ çœ‹golangæºç çš„æ—¶å€™ä¼šæœ‰å¾ˆå¤§å¸®åŠ©çš„ã€‚å¯èƒ½å¿…è¦çš„æ—¶å€™ä½ ä¹Ÿèƒ½ç”¨åˆ°å®ƒï¼Œè¿˜æ˜¯é‚£å¥è¯ï¼Œé™¤éä½ çŸ¥é“å®ƒåœ¨å¹²ä»€ä¹ˆï¼Œå¦åˆ™ä¸è¦ç”¨ã€‚]]></content>
      <categories>
        <category>golangæºç è§£æ</category>
      </categories>
      <tags>
        <tag>unsafe</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å¤§è¯å›¾è§£golang mapæºç è¯¦è§£]]></title>
    <url>%2F2019%2F06%2F03%2Fgolang%2Fsource-code%2Fgraphic-golang-map%2F</url>
    <content type="text"><![CDATA[ç½‘ä¸Šåˆ†ægolangä¸­mapçš„æºç çš„åšå®¢å·²ç»éå¸¸å¤šäº†ï¼Œéšä¾¿ä¸€æœå°±æœ‰ï¼Œè€Œä¸”ä¹Ÿéå¸¸è¯¦ç»†ï¼Œæ‰€ä»¥å¦‚æœæˆ‘å†æ¥å†™å°±æœ‰ç‚¹ç”»è›‡æ·»è¶³äº†ï¼ˆè€Œä¸”æˆ‘ä¹Ÿå†™ä¸å¥½ï¼Œæ‰‹åŠ¨æ»‘ç¨½ï¼‰ã€‚ä½†æ˜¯æˆ‘è¿˜æ˜¯è¦å†™ï¼Œç•¥ç•¥ç•¥ï¼Œè¿™ç¯‡åšå®¢çš„æ„ä¹‰åœ¨äºèƒ½ä»å‡ å¼ å›¾ç‰‡ï¼Œç„¶åç”¨æˆ‘æœ€é€šä¿—çš„æ–‡å­—ï¼Œè®©æ²¡çœ‹è¿‡æºç çš„äººæœ€å¿«ç¨‹åº¦ä¸Šäº†è§£golangä¸­mapæ˜¯æ€ä¹ˆæ ·çš„ã€‚ å½“ç„¶ï¼Œå› ä¸ºç®€å•ï¼Œæ‰€ä»¥ä¸å®Œç¾ã€‚æœ‰å¾ˆå¤šåœ°æ–¹çœç•¥äº†ç»†èŠ‚é—®é¢˜ï¼Œå¦‚æœä½ è§‰å¾—æ²¡çœ‹å¤Ÿï¼Œæˆ–è€…æœ¬æ¥å°±æƒ³äº†è§£è¯¦ç»†æƒ…å†µçš„è¯åœ¨æ–‡æœ«ç»™å‡ºäº†ä¸€äº›éå¸¸ä¸é”™çš„åšå®¢ï¼Œå½“ç„¶æœ‰èƒ½åŠ›è¿˜æ˜¯è‡ªå·±å»é˜…è¯»æºç æ¯”è¾ƒé è°±ã€‚ é‚£ä¹ˆä¸‹é¢æˆ‘å°†ä»è¿™å‡ ä¸ªæ–¹é¢æ¥è¯´æ˜ï¼Œä½ å…ˆè®°ä½æœ‰ä¸‹é¢å‡ ä¸ªæ–¹å‘ï¼Œè¿™æ ·å¯ä»¥æœ‰ä¸€ä¸ªå¤§è‡´çš„æ€è·¯ï¼š åŸºç¡€ç»“æ„ï¼šgolangä¸­çš„mapæ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œæ˜¯ç”±ä»€ä¹ˆæ•°æ®ç»“æ„ç»„æˆçš„ï¼Ÿ åˆå§‹åŒ–ï¼šåˆå§‹åŒ–ä¹‹åmapæ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ getï¼šå¦‚ä½•è·å–ä¸€ä¸ªå…ƒç´ ï¼Ÿ putï¼šå¦‚ä½•å­˜æ”¾ä¸€ä¸ªå…ƒç´ ï¼Ÿ æ‰©å®¹ï¼šå½“å­˜æ”¾ç©ºé—´ä¸å¤Ÿçš„æ—¶å€™æ‰©å®¹æ˜¯æ€ä¹ˆæ‰©çš„ï¼Ÿ åŸºç¡€ç»“æ„å›¾è§£è¿™ä¸ªå°±æ˜¯golangä¸­mapçš„ç»“æ„ï¼Œå…¶å®çœŸçš„ä¸å¤æ‚ï¼Œæˆ‘çœç•¥äº†å…¶ä¸­ä¸€äº›å’Œç»“æ„å…³ç³»ä¸å¤§çš„å­—æ®µï¼Œå°±åªå‰©ä¸‹è¿™äº›äº†ã€‚ å¤§è¯å¤§è¯æ¥æè¿°ä¸€äº›è¦ç‚¹ï¼š æœ€å¤–é¢æ˜¯hmapç»“æ„ä½“ï¼Œç”¨bucketså­˜æ”¾ä¸€äº›åå­—å«bmapçš„æ¡¶ï¼ˆæ•°é‡ä¸å®šï¼Œæ˜¯2çš„æŒ‡æ•°å€ï¼‰ bmapæ˜¯ä¸€ç§æœ‰8ä¸ªæ ¼å­çš„æ¡¶ï¼ˆä¸€å®šåªæœ‰8ä¸ªæ ¼å­ï¼‰ï¼Œæ¯ä¸ªæ ¼å­å­˜æ”¾ä¸€å¯¹key-value bmapæœ‰ä¸€ä¸ªoverflowï¼Œç”¨äºè¿æ¥ä¸‹ä¸€ä¸ªbmapï¼ˆæº¢å‡ºæ¡¶ï¼‰ hmapè¿˜æœ‰oldbucketsï¼Œç”¨äºå­˜æ”¾è€æ•°æ®ï¼ˆç”¨äºæ‰©å®¹æ—¶ï¼‰ mapextraç”¨äºå­˜æ”¾éæŒ‡é’ˆæ•°æ®ï¼ˆç”¨äºä¼˜åŒ–å­˜å‚¨å’Œè®¿é—®ï¼‰ï¼Œå†…éƒ¨çš„overflowå’Œoldoverflowå®é™…è¿˜æ˜¯bmapçš„æ•°ç»„ã€‚ è¿™å°±æ˜¯mapçš„ç»“æ„ï¼Œç„¶åæˆ‘ä»¬ç¨å¾®å¯¹æ¯”æ€»ç»“ä¸€ä¸‹ã€‚ æˆ‘ä»¬å¸¸è§çš„mapå¦‚javaä¸­çš„mapæ˜¯ç›´æ¥æ‹¿æ•°ç»„ï¼Œæ•°ç»„ä¸­ç›´æ¥å¯¹åº”å‡ºäº†key-valueï¼Œè€Œåœ¨golangä¸­ï¼Œåšäº†å¤šåŠ ä¸­é—´ä¸€å±‚ï¼Œbucketsï¼›javaä¸­å¦‚æœkeyçš„å“ˆå¸Œç›¸åŒä¼šé‡‡ç”¨é“¾è¡¨çš„æ–¹å¼è¿æ¥ä¸‹å»ï¼Œå½“è¾¾åˆ°ä¸€å®šç¨‹åº¦ä¼šè½¬æ¢çº¢é»‘æ ‘ï¼Œgolangä¸­ç›´æ¥ç±»ä¼¼é“¾è¡¨è¿æ¥ä¸‹å»ï¼Œåªä¸è¿‡è¿æ¥ä¸‹å»çš„æ˜¯bucketsã€‚ æºç ä¸€ç¥ ä¸‹é¢é™„ä¸Šæºç ä¸­å®ƒä»¬çš„æ ·å­ï¼Œæ–¹ä¾¿ä¹‹åä½ è‡ªå·±é˜…è¯»çš„æ—¶å€™æœ‰ä¸ªå°è±¡ï¼ˆæ³¨æ„æºç ä¸­çš„æ ·å­å’Œç¼–è¯‘ä¹‹åæ˜¯ä¸åŒçš„å“Ÿï¼Œgolangä¼šæ ¹æ®mapå­˜æ”¾çš„ç±»å‹ä¸åŒæ¥æå®šå®ƒä»¬å®é™…çš„æ ·å­ï¼‰ é‚£ä¹ˆçœ‹å®Œç»“æ„ä½ è‚¯å®šä¼šæœ‰ç–‘é—®ï¼Ÿä¸ºä»€ä¹ˆè¦å¤šä¸€å±‚8ä¸ªæ ¼å­çš„bucketå‘¢ï¼Ÿæˆ‘ä»¬æ€ä¹ˆç¡®å®šæ”¾åœ¨8ä¸ªæ ¼å­å…¶ä¸­çš„å“ªä¸ªå‘¢ï¼Ÿå¸¦ç€é—®é¢˜å¾€ä¸‹çœ‹ã€‚ åˆå§‹åŒ–æºç ä¸€ç¥åˆå§‹åŒ–å°±ä¸éœ€è¦å›¾å»è¯´æ˜äº†ï¼Œå› ä¸ºåˆå§‹åŒ–ä¹‹åå°±æ˜¯äº§ç”ŸåŸºç¡€çš„ä¸€ä¸ªç»“æ„ï¼Œæ ¹æ®mapä¸­å­˜æ”¾çš„ç±»å‹ä¸åŒã€‚è¿™é‡Œä¸»è¦è¯´æ˜ä¸€ä¸‹ï¼Œåˆå§‹åŒ–çš„ä»£ç æ”¾åœ¨ä»€ä¹ˆä½ç½®ã€‚æˆ‘ä¹Ÿåˆ é™¤äº†å…¶ä¸­ä¸€äº›ä»£ç ï¼Œå¤§è‡´çœ‹çœ‹å°±å¥½ã€‚ 123456789101112131415161718192021222324252627282930313233// makehmap_small implements Go map creation for make(map[k]v) and// make(map[k]v, hint) when hint is known to be at most bucketCnt// at compile time and the map needs to be allocated on the heap.func makemap_small() *hmap &#123; h := new(hmap) h.hash0 = fastrand() return h&#125;// makemap implements Go map creation for make(map[k]v, hint).// If the compiler has determined that the map or the first bucket// can be created on the stack, h and/or bucket may be non-nil.// If h != nil, the map can be created directly in h.// If h.buckets != nil, bucket pointed to can be used as the first bucket.func makemap(t *maptype, hint int, h *hmap) *hmap &#123; ..... // initialize Hmap if h == nil &#123; h = (*hmap)(newobject(t.hmap)) &#125; h.hash0 = fastrand() // find size parameter which will hold the requested # of elements B := uint8(0) for overLoadFactor(hint, B) &#123; B++ &#125; h.B = B ...... return h&#125; å…¶ä¸­éœ€è¦æ³¨æ„ä¸€ä¸ªç‚¹ï¼šâ€œBâ€ï¼Œè¿˜è®°å¾—åˆšæ‰è¯´åå­—å«bmapçš„æ¡¶æ•°é‡æ˜¯ä¸ç¡®å®šçš„å—ï¼Ÿè¿™ä¸ªBä¸€å®šç¨‹åº¦ä¸Šè¡¨ç¤ºçš„å°±æ˜¯æ¡¶çš„æ•°é‡ï¼Œå½“ç„¶ä¸æ˜¯è¯´Bæ˜¯3æ¡¶çš„æ•°é‡å°±æ˜¯3ï¼Œè€Œæ˜¯2çš„3æ¬¡æ–¹ï¼Œä¹Ÿå°±æ˜¯8ï¼›å½“Bä¸º5ï¼Œæ¡¶çš„æ•°é‡å°±æ˜¯32ï¼›è®°ä½è¿™ä¸ªBï¼Œåé¢ä¼šç”¨åˆ°å®ƒã€‚ å…¶å®ä½ æƒ³å˜›ï¼Œåˆå§‹åŒ–è¿˜èƒ½å¹²ä»€ä¹ˆï¼Œæœ€é‡è¦çš„è‚¯å®šå°±æ˜¯ç¡®å®šä¸€å¼€å§‹è¦æœ‰å¤šå°‘ä¸ªæ¡¶ï¼Œåˆå§‹çš„å¤§å°è¿˜æ˜¯å¾ˆé‡è¦çš„ï¼Œè¿˜æœ‰ä¸€äº›åˆ«çš„åˆå§‹åŒ–å“ˆå¸Œç§å­ç­‰ç­‰ï¼Œé—®é¢˜ä¸å¤§ã€‚æˆ‘ä»¬çš„é‡ç‚¹è¿˜æ˜¯è¦æ”¾åœ¨å­˜/å–ä¸Šé¢ã€‚ GETå›¾è§£å…¶å®ä»ç»“æ„ä¸Šé¢æ¥çœ‹ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥æ‘¸åˆ°ä¸€äº›é—¨é“äº†ã€‚å…ˆè‡ªå·±æƒ³ä¸€ä¸‹ï¼Œè¦ä»ä¸€ä¸ªhashmapä¸­è·å–ä¸€ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆä¸€å®šæ˜¯é€šè¿‡keyçš„å“ˆå¸Œå€¼å»å®šä½åˆ°è¿™ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆæƒ³ç€è¿™ä¸ªå¤§è‡´æ–¹å‘ï¼Œçœ‹ä¸‹é¢ä¸€å¼ æµç¨‹å›¾æ¥è¯¦ç»†ç†è§£golangä¸­æ˜¯å¦‚ä½•å®ç°çš„ã€‚ å¤§è¯ä¸‹é¢è¯´æ˜è¦ç‚¹ï¼š è®¡ç®—å‡ºkeyçš„hash ç”¨æœ€åçš„â€œBâ€ä½æ¥ç¡®å®šåœ¨å“ªä¸ªæ¡¶ï¼ˆâ€œBâ€å°±æ˜¯å‰é¢è¯´çš„é‚£ä¸ªï¼ŒBä¸º4ï¼Œå°±æœ‰16ä¸ªæ¡¶ï¼Œ0101ç”¨åè¿›åˆ¶è¡¨ç¤ºä¸º5ï¼Œæ‰€ä»¥åœ¨5å·æ¡¶ï¼‰ æ ¹æ®keyçš„å‰8ä½å¿«é€Ÿç¡®å®šæ˜¯åœ¨å“ªä¸ªæ ¼å­ï¼ˆé¢å¤–è¯´æ˜ä¸€ä¸‹ï¼Œåœ¨bmapä¸­å­˜æ”¾äº†æ¯ä¸ªkeyå¯¹åº”çš„tophashï¼Œæ˜¯keyçš„å‰8ä½ï¼‰ æœ€ç»ˆè¿˜æ˜¯éœ€è¦æ¯”å¯¹keyå®Œæ•´çš„hashæ˜¯å¦åŒ¹é…ï¼Œå¦‚æœåŒ¹é…åˆ™è·å–å¯¹åº”value å¦‚æœéƒ½æ²¡æœ‰æ‰¾åˆ°ï¼Œå°±å»ä¸‹ä¸€ä¸ªoverflowæ‰¾ æ€»ç»“ä¸€ä¸‹ï¼šé€šè¿‡åBä½ç¡®å®šæ¡¶ï¼Œé€šè¿‡å‰8ä½ç¡®å®šæ ¼å­ï¼Œå¾ªç¯éå†è¿ç€çš„æ‰€æœ‰æ¡¶å…¨éƒ¨æ‰¾å®Œä¸ºæ­¢ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆè¦æœ‰è¿™ä¸ªtophashå‘¢ï¼Ÿå› ä¸ºtophashå¯ä»¥å¿«é€Ÿç¡®å®škeyæ˜¯å¦æ­£ç¡®ï¼Œä½ å¯ä»¥æŠŠå®ƒç†è§£æˆä¸€ç§ç¼“å­˜æªæ–½ï¼Œå¦‚æœå‰8ä½éƒ½ä¸å¯¹äº†ï¼Œåé¢å°±æ²¡æœ‰å¿…è¦æ¯”è¾ƒäº†ã€‚ æºç ä¸€ç¥å…¶ä¸­çº¢è‰²çš„å­—æ ‡å‡ºçš„åœ°æ–¹è¯´æ˜äº†ä¸Šé¢çš„å…³é”®ç‚¹ï¼Œæœ€åæœ‰å…³keyå’Œvalueå…·ä½“çš„å­˜æ”¾æ–¹å¼å’Œå–å‡ºçš„å®šä½ä¸åšæ·±ç©¶ï¼Œæœ‰å…´è¶£å¯ä»¥çœ‹æœ€åçš„å‚è€ƒåšå®¢ã€‚ PUTå…¶å®å½“ä½ çŸ¥é“äº†å¦‚ä½•GETï¼Œé‚£ä¹ˆPUTå°±æ²¡æœ‰ä»€ä¹ˆéš¾åº¦äº†ï¼Œå› ä¸ºæœ¬è´¨æ˜¯ä¸€æ ·çš„ã€‚PUTçš„æ—¶å€™ä¸€æ ·çš„æ–¹å¼å»å®šä½keyçš„ä½ç½®ï¼š é€šè¿‡keyçš„åâ€œBâ€ä½ç¡®å®šæ˜¯å“ªä¸€ä¸ªæ¡¶ é€šè¿‡keyçš„å‰8ä½å¿«é€Ÿç¡®å®šæ˜¯å¦å·²ç»å­˜åœ¨ æœ€ç»ˆç¡®å®šå­˜æ”¾ä½ç½®ï¼Œå¦‚æœ8ä¸ªæ ¼å­å·²ç»æ»¡äº†ï¼Œæ²¡åœ°æ–¹æ”¾äº†ï¼Œé‚£ä¹ˆå°±é‡æ–°åˆ›å»ºä¸€ä¸ªbmapä½œä¸ºæº¢å‡ºæ¡¶è¿æ¥åœ¨overflow å›¾è§£è¿™é‡Œä¸»è¦å›¾è§£è¯´æ˜ä¸€ä¸‹ï¼Œå¦‚æœæ–°æ¥çš„keyå‘ç°å‰é¢æœ‰ä¸€ä¸ªæ ¼å­ç©ºç€ï¼ˆè¿™ä¸ªæƒ…å†µæ˜¯åˆ é™¤é€ æˆçš„ï¼‰ï¼Œå°±ä¼šè®°å½•è¿™ä¸ªä½ç½®ï¼Œå½“å…¨éƒ¨æ‰«æå®Œæˆä¹‹åå‘ç°è‡ªå·±ç¡®å®æ˜¯æ–°æ¥çš„ï¼Œé‚£ä¹ˆå°±ä¼šæ”¾å‰é¢é‚£ä¸ªç©ºç€çš„ï¼Œè€Œä¸ä¼šæ”¾æœ€åï¼ˆæˆ‘æŠŠè¿™ä¸ªç§°ä¸ºç´§å‡‘åŸåˆ™ï¼Œå°½å¯èƒ½ä¿è¯æ•°æ®å­˜æ”¾ç´§å‡‘ï¼Œè¿™æ ·ä¸‹æ¬¡æ‰«æä¼šå¿«ï¼‰ ä»£ç ä½ç½®go/src/runtime/hashmap.goçš„mapassignå‡½æ•°å°±æ˜¯mapçš„putæ–¹æ³•ï¼Œå› ä¸ºä»£ç å¾ˆé•¿è¿™é‡Œå°±ä¸å¤šèµ˜è¿°äº†ã€‚ æ‰©å®¹è¿™ä¸ªå°±æ˜¯æœ€å¤æ‚çš„åœ°æ–¹äº†ï¼Œä½†æ˜¯å‘¢ï¼ŸDonâ€™t worryæˆ‘è¿™é‡Œè¿˜æ˜¯ä¼šçœç•¥å…¶ä¸­æŸäº›éƒ¨åˆ†ï¼Œå°†æœ€é‡è¦çš„åœ°æ–¹æ‹å‡ºæ¥ã€‚ æ‰©å®¹çš„æ–¹å¼ ç›¸åŒå®¹é‡æ‰©å®¹ 2å€å®¹é‡æ‰©å®¹å•¥æ„æ€å‘¢ï¼Ÿç¬¬ä¸€ç§å‡ºç°çš„æƒ…å†µæ˜¯ï¼šå› ä¸ºmapä¸æ–­çš„putå’Œdeleteï¼Œå‡ºç°äº†å¾ˆå¤šç©ºæ ¼ï¼Œè¿™äº›ç©ºæ ¼ä¼šå¯¼è‡´bmapå¾ˆé•¿ï¼Œä½†æ˜¯ä¸­é—´æœ‰å¾ˆå¤šç©ºçš„åœ°æ–¹ï¼Œæ‰«ææ—¶é—´å˜é•¿ã€‚æ‰€ä»¥ç¬¬ä¸€ç§æ‰©å®¹å®é™…æ˜¯ä¸€ç§æ•´ç†ï¼Œå°†æ•°æ®æ•´ç†åˆ°å‰é¢ä¸€èµ·ã€‚ç¬¬äºŒç§å‘¢ï¼šå°±æ˜¯çœŸçš„ä¸å¤Ÿç”¨äº†ï¼Œæ‰©å®¹ä¸¤å€ã€‚ æ‰©å®¹çš„æ¡ä»¶è£…è½½å› å­å¦‚æœä½ çœ‹è¿‡Javaçš„HashMapå®ç°ï¼Œå°±çŸ¥é“æœ‰ä¸ªè£…è½½å› å­ï¼ŒåŒæ ·çš„åœ¨golangä¸­ä¹Ÿæœ‰ï¼Œä½†æ˜¯ä¸ä¸€æ ·å“¦ã€‚è£…è½½å› å­çš„å®šä¹‰æ˜¯è¿™ä¸ªæ ·å­ï¼šloadFactor := count / (2^B)å…¶ä¸­countä¸ºmapä¸­å…ƒç´ çš„ä¸ªæ•°ï¼ŒBå°±æ˜¯ä¹‹å‰ä¸ªé‚£ä¸ªâ€œBâ€ç¿»è¯‘ä¸€ä¸‹å°±æ˜¯è£…è½½å› å­ = ï¼ˆmapä¸­å…ƒç´ çš„ä¸ªæ•°ï¼‰/ï¼ˆmapå½“å‰æ¡¶çš„ä¸ªæ•°ï¼‰ æ‰©å®¹æ¡ä»¶1è£…è½½å› å­ &gt; 6.5ï¼ˆè¿™ä¸ªå€¼æ˜¯æºç ä¸­å†™çš„ï¼‰å…¶å®æ„æ€å°±æ˜¯ï¼Œæ¡¶åªæœ‰é‚£ä¹ˆå‡ ä¸ªï¼Œä½†æ˜¯å…ƒç´ å¾ˆå¤šï¼Œè¯æ˜æœ‰å¾ˆå¤šæº¢å‡ºæ¡¶çš„å­˜åœ¨ï¼ˆå¯ä»¥æƒ³æˆé“¾è¡¨æ‹‰çš„å¤ªé•¿äº†ï¼‰ï¼Œé‚£ä¹ˆæ‰«æé€Ÿåº¦ä¼šå¾ˆæ…¢ï¼Œå°±è¦æ‰©å®¹ã€‚ æ‰©å®¹æ¡ä»¶2overflow çš„ bucket æ•°é‡è¿‡å¤šï¼šå½“ B å°äº 15ï¼Œå¦‚æœ overflow çš„ bucket æ•°é‡è¶…è¿‡ 2^B ï¼›å½“ B &gt;= 15ï¼Œå¦‚æœ overflow çš„ bucket æ•°é‡è¶…è¿‡ 2^15 ã€‚å…¶å®æ„æ€å°±æ˜¯ï¼Œå¯èƒ½æœ‰ä¸€ä¸ªå•ç‹¬çš„ä¸€æ¡é“¾æ‹‰çš„å¾ˆé•¿ï¼Œæº¢å‡ºæ¡¶å¤ªå¤šäº†ï¼Œè¯´ç™½äº†å°±æ˜¯ï¼ŒåŠ å…¥çš„keyä¸å·§ï¼ŒåBä½éƒ½ä¸€æ ·ï¼Œä¸€ç›´è½åœ¨åŒä¸€ä¸ªæ¡¶é‡Œé¢ï¼Œè¿™ä¸ªæ¡¶ä¸€ç›´æ”¾ï¼Œè™½ç„¶è£…è½½å› å­ä¸é«˜ï¼Œä½†æ˜¯æ‰«æé€Ÿåº¦å°±å¾ˆæ…¢ã€‚ æ‰©å®¹æ¡ä»¶3å½“å‰ä¸èƒ½æ­£åœ¨æ‰©å®¹ å›¾è§£è¿™å¼ å›¾è¡¨ç¤ºçš„å°±æ˜¯ç›¸åŒå®¹é‡çš„æ‰©å®¹ï¼Œå®é™…ä¸Šå°±æ˜¯ä¸€ç§æ•´ç†ï¼Œå°†åˆ†æ•£çš„æ•°æ®é›†åˆåˆ°ä¸€èµ·ï¼Œæé«˜æ‰«ææ•ˆç‡ã€‚ï¼ˆä¸Šé¢è¡¨ç¤ºæ‰©å®¹ä¹‹å‰ï¼Œä¸‹é¢è¡¨ç¤ºæ‰©å®¹ä¹‹åï¼‰ è¿™å¼ å›¾è¡¨ç¤ºçš„æ˜¯å°±æ˜¯2å€çš„æ‰©å®¹ï¼ˆä¸Šé¢è¡¨ç¤ºæ‰©å®¹ä¹‹å‰ï¼Œä¸‹é¢è¡¨ç¤ºæ‰©å®¹ä¹‹åï¼‰ï¼Œå¦‚æœæœ‰ä¸¤ä¸ªkeyåä¸‰ä½åˆ†åˆ«æ˜¯001å’Œ101ï¼Œå½“B=2æ—¶ï¼Œåªæœ‰4ä¸ªæ¡¶ï¼Œåªçœ‹æœ€åä¸¤ä½ï¼Œè¿™ä¸¤ä¸ªkeyåä¸¤ä½éƒ½æ˜¯01æ‰€ä»¥åœ¨ä¸€ä¸ªæ¡¶é‡Œé¢ï¼›æ‰©å®¹ä¹‹åB=3ï¼Œå°±ä¼šæœ‰8ä¸ªæ¡¶ï¼Œçœ‹åé¢ä¸‰ä½ï¼Œäºæ˜¯å®ƒä»¬å°±åˆ†åˆ°äº†ä¸åŒçš„æ¡¶é‡Œé¢ã€‚ å¤§è¯ä¸‹é¢è¯´ä¸€äº›æ‰©å®¹æ—¶çš„ç»†èŠ‚ï¼š æ‰©å®¹ä¸æ˜¯ä¸€æ¬¡æ€§å®Œæˆçš„ï¼Œè¿˜è®°çš„æˆ‘ä»¬hmapä¸€å¼€å§‹æœ‰ä¸€ä¸ªoldbucketså—ï¼Ÿæ˜¯å…ˆå°†è€æ•°æ®å­˜åˆ°è¿™ä¸ªé‡Œé¢ æ¯æ¬¡æ¬è¿1åˆ°2ä¸ªbucketï¼Œå½“æ’å…¥æˆ–ä¿®æ”¹ã€åˆ é™¤keyè§¦å‘ æ‰©å®¹ä¹‹åè‚¯å®šä¼šå½±å“åˆ°getå’Œputï¼Œéå†çš„æ—¶å€™è‚¯å®šä¼šå…ˆä»oldbucketsæ‹¿ï¼Œputè‚¯å®šä¹Ÿè¦è€ƒè™‘æ˜¯å¦è¦æ”¾åˆ°æ–°äº§ç”Ÿçš„æ¡¶é‡Œé¢å» æºç ä¸€ç¥æ‰©å®¹çš„ä¸‰ä¸ªæ¡ä»¶ï¼Œçœ‹åˆ°äº†å—ï¼Ÿè¿™ä¸ªåœ°æ–¹åœ¨mapassignæ–¹æ³•ä¸­ã€‚ è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œæ³¨é‡Šä¹Ÿå†™çš„å¾ˆæ¸…æ¥šï¼Œå¦‚æœæ˜¯åŠ è½½å› å­è¶…å‡ºäº†ï¼Œé‚£ä¹ˆå°±2å€æ‰©å®¹ï¼Œå¦‚æœä¸æ˜¯é‚£ä¹ˆå°±æ˜¯å› ä¸ºå¤ªå¤šæº¢å‡ºæ¡¶äº†ï¼ŒsameSizeGrowè¡¨ç¤ºå°±æ˜¯ç›¸åŒå®¹é‡æ‰©å®¹ evacuateæ˜¯æ¬è¿æ–¹æ³•ï¼Œè¿™è¾¹å¯ä»¥çœ‹åˆ°ï¼Œæ¯æ¬¡æ¬è¿æ˜¯1åˆ°2ä¸ª evacuateå®åœ¨æ˜¯å¤ªé•¿äº†ï¼Œä¹Ÿéå¸¸å¤æ‚ï¼Œä½†æ˜¯æƒ…å†µå°±æ˜¯å›¾ä¸Šæè¿°çš„é‚£æ ·ï¼Œæœ‰å…´è¶£çš„å¯ä»¥è¯¦ç»†å»çœ‹ï¼Œè¿™é‡Œä¸æˆªå›¾è¯´æ˜äº†ã€‚ æ€»ç»“å’Œå°é—®é¢˜è‡³æ­¤ä½ åº”è¯¥å¯¹äºgolangä¸­çš„mapæœ‰ä¸€ä¸ªåŸºæœ¬çš„è®¤è¯†äº†ï¼Œä½ è¿˜å¯ä»¥å»çœ‹çœ‹åˆ é™¤ï¼Œä½ è¿˜å¯ä»¥å»çœ‹çœ‹éå†ç­‰ç­‰ï¼Œç›¸ä¿¡æœ‰äº†ä¸Šé¢çš„åŸºæœ¬è®¤è¯†é‚£ä¹ˆåº”è¯¥ä¸ä¼šéš¾åˆ°ä½ ã€‚ä¸‹é¢æœ‰å‡ ä¸ªå°é—®é¢˜ï¼š æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿå¦ï¼Œè€Œä¸”å¹¶å‘æ“ä½œä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ æºç ä½ç½®ï¼šsrc/runtime/hashmap.go æ¯æ¬¡éå†mapé¡ºåºæ˜¯å¦ä¸€è‡´ï¼Ÿä¸ä¸€è‡´ï¼Œæ¯æ¬¡éå†ä¼šéšæœºä¸ªæ•°ï¼Œé€šè¿‡éšæœºæ•°æ¥å†³å®šä»å“ªä¸ªå…ƒç´ å¼€å§‹ã€‚ å†™çš„ä»“ä¿ƒï¼Œéš¾å…ç–æ¼ï¼Œæœ‰é—®é¢˜çš„åœ°æ–¹è¿˜è¯·æ‰¹è¯„æŒ‡æ­£ã€‚ å‚è€ƒèµ„æ–™å¦‚æœä½ å¸Œæœ›çœ‹åˆ°æºç çš„å„ç§ç»†èŠ‚è®²è§£ï¼Œä¸‹é¢è¿™å‡ ç¯‡æ˜¯æˆ‘å­¦ä¹ çš„æ—¶å€™çœ‹çš„ï¼Œä¾›ä½ å‚è€ƒï¼Œå¸Œæœ›å¯¹ä½ æœ‰å¸®åŠ©https://github.com/qcrao/Go-Questions/tree/master/maphttps://github.com/cch123/golang-notes/blob/master/map.mdhttps://draveness.me/golang-hashmaphttps://lukechampine.com/hackmap.html]]></content>
      <categories>
        <category>golangæºç è§£æ</category>
      </categories>
      <tags>
        <tag>hashmap</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Golang è¯»å†™é”RWMutex äº’æ–¥é”Mutex æºç è¯¦è§£]]></title>
    <url>%2F2019%2F06%2F01%2Fgolang%2Fsource-code%2Frwmutex-mutex-source-code-review%2F</url>
    <content type="text"><![CDATA[Golangä¸­æœ‰ä¸¤ç§ç±»å‹çš„é”ï¼ŒMutex ï¼ˆäº’æ–¥é”ï¼‰å’ŒRWMutexï¼ˆè¯»å†™é”ï¼‰å¯¹äºè¿™ä¸¤ç§é”çš„ä½¿ç”¨è¿™é‡Œå°±ä¸å¤šè¯´äº†ï¼Œæœ¬æ–‡ä¸»è¦ä¾§é‡äºä»æºç çš„è§’åº¦åˆ†æè¿™ä¸¤ç§é”çš„å…·ä½“å®ç°ã€‚ å¼•å­é—®é¢˜æˆ‘ä¸€èˆ¬å–œæ¬¢å¸¦ç€é—®é¢˜å»çœ‹æºç ã€‚é‚£ä¹ˆå¯¹äºè¯»å†™é”ï¼Œä½ æ˜¯å¦æœ‰è¿™æ ·çš„é—®é¢˜ï¼Œä¸ºä»€ä¹ˆå¯ä»¥æœ‰å¤šä¸ªè¯»é”ï¼Ÿæœ‰æ²¡æœ‰å¯èƒ½å‡ºç°æœ‰åç¨‹ä¸€ç›´æ— æ³•è·å–åˆ°å†™é”çš„æƒ…å†µï¼Ÿå¸¦ç€ä½ çš„ç–‘é—®æ¥å¾€ä¸‹çœ‹çœ‹ï¼Œå…·ä½“è¿™ä¸ªé”æ˜¯å¦‚ä½•å®ç°çš„ã€‚ å¦‚æœä½ è‡ªå·±æƒ³çœ‹ï¼Œæˆ‘ç»™å‡ºé˜…è¯»çš„ä¸€ä¸ªæ€è·¯ï¼Œå¯ä»¥å…ˆçœ‹è¯»å†™é”ï¼Œå› ä¸ºè¯»å†™é”çš„å®ç°ä¾èµ–äºäº’æ–¥é”ï¼Œå¹¶ä¸”è¯»å†™é”æ¯”è¾ƒç®€å•ä¸€äº›ï¼Œç„¶åæ•´ç†æ€è·¯ä¹‹åå†å»æƒ³ä¸€ä¸‹å®é™…çš„åº”ç”¨åœºæ™¯ï¼Œç„¶åå†å»çœ‹äº’æ–¥é”ã€‚ ä¸‹é¢æˆ‘å°±ä¼šæŒ‰ç…§è¿™ä¸ªæ€è·¯ä¸€æ­¥æ­¥å¾€ä¸‹èµ°ã€‚ åŸºç¡€çŸ¥è¯†ç‚¹ çŸ¥è¯†ç‚¹1ï¼šä¿¡å·é‡ä¿¡å·é‡æ˜¯ Edsger Dijkstra å‘æ˜çš„æ•°æ®ç»“æ„ï¼ˆæ²¡é”™å°±æ˜¯é‚£ä¸ªæœ€çŸ­è·¯å¾„ç®—æ³•é‚£ä¸ªç‰›äººï¼‰ï¼Œåœ¨è§£å†³å¤šç§åŒæ­¥é—®é¢˜æ—¶å¾ˆæœ‰ç”¨ã€‚å…¶æœ¬è´¨æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œå¹¶å…³è”ä¸¤ä¸ªæ“ä½œï¼š ç”³è¯·acquireï¼ˆä¹Ÿç§°ä¸º waitã€decrement æˆ– P æ“ä½œï¼‰é‡Šæ”¾releaseï¼ˆä¹Ÿç§° signalã€increment æˆ– V æ“ä½œï¼‰ acquireæ“ä½œå°†ä¿¡å·é‡å‡ 1ï¼Œå¦‚æœç»“æœå€¼ä¸ºè´Ÿåˆ™çº¿ç¨‹é˜»å¡ï¼Œä¸”ç›´åˆ°å…¶ä»–çº¿ç¨‹è¿›è¡Œäº†ä¿¡å·é‡ç´¯åŠ ä¸ºæ­£æ•°æ‰èƒ½æ¢å¤ã€‚å¦‚ç»“æœä¸ºæ­£æ•°ï¼Œçº¿ç¨‹åˆ™ç»§ç»­æ‰§è¡Œã€‚releaseæ“ä½œå°†ä¿¡å·é‡åŠ  1ï¼Œå¦‚å­˜åœ¨è¢«é˜»å¡çš„çº¿ç¨‹ï¼Œæ­¤æ—¶ä»–ä»¬ä¸­çš„ä¸€ä¸ªçº¿ç¨‹å°†è§£é™¤é˜»å¡ã€‚ çŸ¥è¯†ç‚¹2ï¼šé”çš„å®šä¹‰åœ¨goalngä¸­å¦‚æœå®ç°äº†Lockå’ŒUnlockæ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒå°±å¯ä»¥è¢«ç§°ä¸ºé”ã€‚ çŸ¥è¯†ç‚¹3ï¼šé”çš„è‡ªæ—‹ï¼šï¼ˆè¯¦è§ç™¾åº¦ï¼‰ çŸ¥è¯†ç‚¹4ï¼šcasç®—æ³•ï¼šï¼ˆæœ€å¥½æœ‰æ‰€äº†è§£ï¼Œä¸çŸ¥é“é—®é¢˜ä¹Ÿä¸å¤§ï¼‰ è¯»å†™é”RWMutexé¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹RWMutexå¤§ä½“ç»“æ„çœ‹åˆ°ç»“æ„å‘ç°è¯»å†™é”å†…éƒ¨åŒ…å«äº†ä¸€ä¸ªw Mutexäº’æ–¥é”æ³¨é‡Šä¹Ÿå¾ˆæ˜ç¡®ï¼Œè¿™ä¸ªé”çš„ç›®çš„å°±æ˜¯æ§åˆ¶å¤šä¸ªå†™å…¥æ“ä½œçš„å¹¶å‘æ‰§è¡ŒwriterSemæ˜¯å†™å…¥æ“ä½œçš„ä¿¡å·é‡readerSemæ˜¯è¯»æ“ä½œçš„ä¿¡å·é‡readerCountæ˜¯å½“å‰è¯»æ“ä½œçš„ä¸ªæ•°readerWaitå½“å‰å†™å…¥æ“ä½œéœ€è¦ç­‰å¾…è¯»æ“ä½œè§£é”çš„ä¸ªæ•°è¿™å‡ ä¸ªç°åœ¨çœ‹ä¸æ‡‚æ²¡å…³ç³»ï¼Œåé¢ç­‰ç”¨åˆ°äº†ä½ å†å›æ¥çœ‹å°±å¥½äº†ã€‚ ç„¶åæˆ‘ä»¬çœ‹çœ‹æ–¹æ³•ä¸€å…±æœ‰5ä¸ªæ–¹æ³•ï¼Œçœ‹èµ·æ¥å°±ä¸å¤æ‚ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸ªæ¥çœ‹ã€‚ è¿™ä¸ªæœ€ç®€å•ï¼Œå°±æ˜¯è¿”å›ä¸€ä¸ªlockerå¯¹è±¡æ²¡å•¥å¥½è¯´çš„ é—®é¢˜çš„å…³é”®å°±åœ¨äºé”å’Œè§£é”çš„å‡ ä¸ªæ–¹æ³•ï¼Œå› ä¸ºæˆ‘å·²ç»çœ‹è¿‡ï¼Œæ‰€ä»¥æ¨èè¿™å‡ ä¸ªæ–¹æ³•çš„é˜…è¯»é¡ºåºæ˜¯RLock Lock RUnlock Unlock RLockï¼ˆè·å–è¯»é”ï¼‰å…ˆä¸çœ‹ç«æ€æ£€æµ‹çš„éƒ¨åˆ†ï¼Œå…ˆé‡ç‚¹çœ‹çº¢è‰²æ¡†ä¸­çš„éƒ¨åˆ†å¯ä»¥çœ‹åˆ°ï¼Œå…¶å®å¾ˆç®€å•ï¼Œæ¯å½“æœ‰åç¨‹éœ€è¦è·å–è¯»é”çš„æ—¶å€™ï¼Œå°±å°†readerCount + 1ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªæ¡ä»¶ï¼Œå½“readerCount + 1ä¹‹åçš„å€¼ &lt; 0çš„æ—¶å€™ï¼Œé‚£ä¹ˆå°†ä¼šè°ƒç”¨runtime_Semacquireæ–¹æ³•è¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªruntimeçš„æ–¹æ³•ï¼Œä¼šä¸€ç›´ç­‰å¾…ä¼ å…¥çš„så‡ºç°&gt;0çš„æ—¶å€™ç„¶åæˆ‘ä»¬å¯ä»¥è®°å¾—ï¼Œè¿™é‡Œæœ‰è¿™æ ·ä¸€ä¸ªæƒ…å†µï¼Œå½“å‡ºå…ˆreaderCount + 1ä¸ºè´Ÿæ•°çš„æƒ…å†µé‚£ä¹ˆå°±ä¼šè¢«ç­‰å¾…ï¼Œçœ‹æ³¨é‡Šæˆ‘ä»¬å¯ä»¥çŒœåˆ°ï¼Œæ˜¯å½“æœ‰å†™å…¥æ“ä½œå‡ºç°çš„æ—¶å€™ï¼Œé‚£ä¹ˆè¯»æ“ä½œå°±ä¼šè¢«ç­‰å¾…ã€‚ Lockï¼ˆè·å–å†™é”ï¼‰å†™é”ç¨å¾®å¤æ‚ä¸€äº›ï¼Œä½†æ˜¯æ ·å­ä¹Ÿå·®ä¸å¤šï¼Œæˆ‘ä»¬è¿˜æ˜¯å…ˆæ¥çœ‹çº¢è‰²æ¡†ä¸­çš„éƒ¨åˆ†ã€‚é¦–å…ˆæ“ä½œæœ€å‰é¢è¯´çš„äº’æ–¥é”ï¼Œç›®çš„å°±æ˜¯å¤„ç†å¤šä¸ªå†™é”å¹¶å‘çš„æƒ…å†µï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“å†™é”åªæœ‰ä¸€æŠŠã€‚è¿™é‡Œä¸éœ€è¦æ·±å…¥äº’æ–¥é”ï¼Œåªéœ€è¦çŸ¥é“ï¼Œäº’æ–¥é”åªæœ‰ä¸€ä¸ªäººèƒ½æ‹¿åˆ°ï¼Œæ‰€ä»¥å†™é”åªæœ‰ä¸€ä¸ªäººèƒ½æ‹¿åˆ°ã€‚ ç„¶åé‡ç‚¹æ¥äº†ï¼Œè¿™é‡Œçš„è¿™ä¸ªæ“ä½œç»†ç»†ä½“ä¼šä¸€ä¸‹ï¼Œatomic.AddInt32(&amp;rw.readerCount, -rwmutexMaxReaders)æ˜¯å°†å½“å‰çš„readerCountå‡å»ä¸€ä¸ªéå¸¸å¤§çš„å€¼rwmutexMaxReadersä¸º1 &lt;&lt; 30å¤§æ¦‚æ˜¯1073741823è¿™ä¹ˆå¤§å§ æ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä»æºç ä¸­çœ‹å‡ºï¼ŒreaderCountç”±äºæ¯æœ‰ä¸€ä¸ªåç¨‹è·å–è¯»é”å°±+1ï¼Œä¸€ç›´éƒ½æ˜¯æ­£æ•°ï¼Œè€Œå½“æœ‰å†™é”è¿‡æ¥çš„æ—¶å€™ï¼Œå°±ç¬é—´å‡ä¸ºå¾ˆå¤§çš„è´Ÿæ•°ã€‚ç„¶ååšå®Œä¸Šé¢çš„æ“ä½œä»¥åçš„rå…¶å®å°±æ˜¯åŸæ¥çš„readerCountã€‚åé¢è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœåŸæ¥çš„readerCountä¸ä¸º0ï¼ˆåŸæ¥æœ‰åç¨‹å·²ç»è·å–åˆ°äº†è¯»é”ï¼‰å¹¶ä¸”å°†readerWaitåŠ ä¸ŠreaderCountï¼ˆè¡¨ç¤ºéœ€è¦ç­‰å¾…readerCountè¿™ä¹ˆå¤šä¸ªè¯»é”è¿›è¡Œè§£é”ï¼‰ï¼Œå¦‚æœæ»¡è¶³ä¸Šè¿°æ¡ä»¶è¯æ˜åŸæ¥æœ‰è¯»é”ï¼Œæ‰€ä»¥æš‚æ—¶æ²¡æœ‰åŠæ³•è·å–åˆ°å†™é”ï¼Œæ‰€ä»¥è°ƒç”¨runtime_Semacquireè¿›è¡Œç­‰å¾…ï¼Œç­‰å¾…çš„ä¿¡å·é‡ä¸ºwriterSem RUnlockï¼ˆé‡Šæ”¾è¯»é”ï¼‰å¦‚æœæ˜¯æˆ‘ä»¬æ¥å†™çš„è¯ï¼Œå¯èƒ½å°±æ˜¯å°†ä¹‹å‰+1çš„readerCountï¼Œ-1å°±å®Œäº‹äº†ï¼Œä½†æ˜¯å…¶å®è¿˜æœ‰ä¸€äº›æ“ä½œéœ€è¦æ³¨æ„ã€‚å¦‚æœ-1ä¹‹å+1==0æ˜¯å•¥æƒ…å†µï¼Ÿæ²¡é”™å°±æ˜¯æˆ‘ä»¬å¸¸è§çš„ï¼Œæ–°æ‰‹ç¨‹åºå‘˜ï¼Œæ²¡æœ‰è·å–è¯»é”å°±æƒ³å»é‡Šæ”¾è¯»é”ï¼Œäºæ˜¯å¼‚å¸¸äº†ã€‚å½“ç„¶+1ä¹‹ååˆšå¥½æ˜¯rwmutexMaxReadersï¼Œå°±è¯è·å–äº†å†™é”è€Œå»é‡Šæ”¾äº†è¯»é”ï¼Œå¯¼è‡´å¼‚å¸¸ã€‚é™¤å»å¼‚å¸¸æƒ…å†µï¼Œå‰©ä¸‹çš„å°±æ˜¯rè¿˜æ˜¯&lt;0çš„æƒ…å†µï¼Œé‚£ä¹ˆè¯æ˜ç¡®å®æœ‰åç¨‹æ­£åœ¨æƒ³è¦è·å–å†™é”ï¼Œé‚£ä¹ˆå°±éœ€è¦æ“ä½œæˆ‘ä»¬å‰é¢çœ‹åˆ°çš„readerWaitï¼Œå½“readerWaitå‡åˆ°0çš„æ—¶å€™å°±è¯æ˜æ²¡æœ‰äººæ­£åœ¨æŒæœ‰å†™é”äº†ï¼Œå°±é€šè¿‡ä¿¡å·é‡writerSemçš„å˜åŒ–å‘ŠçŸ¥åˆšæ‰ç­‰å¾…çš„åç¨‹ï¼ˆæƒ³è¦è·å–å†™é”çš„åç¨‹ï¼‰ï¼šä½ å¯ä»¥è¿›è¡Œè·å–äº†ã€‚ åˆ°è¿™é‡Œä½ å¯ä»¥æŠŠæ€è·¯å¤§è‡´ä¸²èµ·æ¥äº†ï¼Œç„¶åæ‡‚äº†å†å¾€ä¸‹çœ‹ã€‚ Unlockï¼ˆé‡Šæ”¾å†™é”ï¼‰å†™é”é‡Šæ”¾éœ€è¦æ¢å¤readerCountï¼Œè¿˜è®°å¾—ä¸Šé”çš„æ—¶å€™å‡äº†ä¸€ä¸ªå¾ˆå¤§çš„æ•°ï¼Œè¿™ä¸ªæ—¶å€™è¦åŠ å›æ¥äº†ã€‚å½“ç„¶åŠ å®Œä¹‹åå¦‚æœ&gt;=rwmutexMaxReadersæœ¬èº«ï¼Œé‚£ä¹ˆè¿˜æ˜¯æ–°æ‰‹ç¨‹åºå‘˜çš„é—®é¢˜ï¼Œå½“æ²¡æœ‰è·å–å†™é”çš„æ—¶å€™å°±å¼€å§‹æƒ³ç€é‡Šæ”¾å†™é”äº†ã€‚ç„¶åforå¾ªç¯å°±æ˜¯ä¸ºäº†é€šçŸ¥æ‰€æœ‰åœ¨æˆ‘ä»¬RLockæ–¹æ³•ä¸­çœ‹åˆ°çš„ï¼Œå½“æœ‰å› ä¸ºæŒæœ‰å†™é”æ‰€ä»¥ç­‰å¾…çš„é‚£äº›åç¨‹ï¼Œé€šè¿‡ä¿¡å·é‡readerSemå‘Šè¯‰ä»–ä»¬å¯ä»¥åŠ¨äº†ã€‚æœ€ååˆ«å¿˜è®°è¿˜æœ‰ä¸€ä¸ªäº’æ–¥é”éœ€è¦é‡Šæ”¾ï¼Œè®©åˆ«çš„åç¨‹ä¹Ÿå¯ä»¥å¼€å§‹æŠ¢å†™é”äº†ã€‚ è‡³æ­¤ï¼Œè¯»å†™é”çš„åˆ†æåŸºæœ¬ä¸Šå‘Šä¸€æ®µè½äº†ã€‚é’ˆå¯¹äºå…¶ä¸­å…³äºç«æ€åˆ†æçš„ä»£ç ï¼Œæœ‰å…´è¶£çš„å°ä¼™ä¼´å¯ä»¥å»äº†è§£ä¸€ä¸‹ã€‚ äº’æ–¥é”Mutexäº’æ–¥é”æ¯”è¯»å†™é”å¤æ‚ï¼Œä½†æ˜¯å¥½åœ¨golangç»™çš„æ³¨é‡Šå¾ˆè¯¦ç»†ï¼Œæ‰€ä»¥ä¹Ÿä¸å›°éš¾ï¼ˆæ³¨é‡ŠçœŸçš„å¾ˆé‡è¦ï¼‰ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹é‡Œé¢çš„ä¸€æ®µæ³¨é‡Šï¼šå¾ˆé•¿çš„ä¸€æ®µè‹±æ–‡ï¼Œæˆ‘ç”¨è‹±è¯­å››çº§çš„ç¿»è¯‘èƒ½åŠ›ç»™ä½ ç¿»è¯‘ä¸€ä¸‹ï¼Œå¯ä»¥å°†å°±çœ‹çœ‹ï¼Œå¦‚æœå¯ä»¥å»ºè®®ä½ ä»”ç»†çœ‹è‹±æ–‡çœ‹æ‡‚å®ƒï¼Œå› ä¸ºè¿™å¯¹äºåé¢çš„æºç é˜…è¯»éå¸¸é‡è¦ã€‚///è¿™ä¸ªäº’æ–¥é”æ˜¯å…¬å¹³é” äº’æ–¥é”æœ‰ä¸¤ç§æ“ä½œæ¨¡å¼ï¼šæ­£å¸¸æ¨¡å¼å’Œé¥¥é¥¿æ¨¡å¼ã€‚åœ¨æ­£å¸¸æ¨¡å¼ä¸‹ç­‰å¾…è·å–é”çš„goroutineä¼šä»¥ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„æ–¹å¼è¿›è¡Œæ’é˜Ÿï¼Œä½†æ˜¯è¢«å”¤é†’çš„ç­‰å¾…è€…å¹¶ä¸èƒ½ä»£è¡¨å®ƒå·²ç»æ‹¥æœ‰äº†è¿™ä¸ªmutexé”ï¼Œå®ƒéœ€è¦ä¸æ–°åˆ°è¾¾çš„goroutineäº‰å¤ºmutexé”ã€‚æ–°æ¥çš„goroutineæœ‰ä¸€ä¸ªä¼˜åŠ¿ â€”â€” ä»–ä»¬å·²ç»åœ¨CPUä¸Šè¿è¡Œäº†å¹¶ä¸”ä»–ä»¬ï¼Œæ‰€ä»¥æŠ¢åˆ°çš„å¯èƒ½æ€§å¤§ä¸€äº›ï¼Œæ‰€ä»¥ä¸€ä¸ªè¢«å”¤é†’çš„ç­‰å¾…è€…æœ‰å¾ˆå¤§å¯èƒ½æŠ¢ä¸è¿‡ã€‚åœ¨è¿™æ ·çš„æƒ…å†µä¸‹ï¼Œè¢«å”¤é†’çš„ç­‰å¾…è€…åœ¨é˜Ÿåˆ—çš„å¤´éƒ¨ã€‚å¦‚æœä¸€ä¸ªç­‰å¾…è€…æŠ¢é”è¶…è¿‡1mså¤±è´¥äº†ï¼Œå°±ä¼šåˆ‡æ¢ä¸ºé¥¥é¥¿æ¨¡å¼ã€‚ åœ¨é¥¥é¥¿æ¨¡å¼ä¸‹ï¼Œmutexé”ä¼šç›´æ¥ç”±è§£é”çš„goroutineäº¤ç»™é˜Ÿåˆ—å¤´éƒ¨çš„ç­‰å¾…è€…ã€‚æ–°æ¥çš„goroutineä¸èƒ½å°è¯•å»è·å–é”ï¼Œå³ä½¿å¯èƒ½æ ¹æœ¬å°±æ²¡goroutineåœ¨æŒæœ‰é”ï¼Œå¹¶ä¸”ä¸èƒ½å°è¯•è‡ªæ—‹ã€‚å–è€Œä»£ä¹‹çš„æ˜¯ä»–ä»¬åªèƒ½æ’åˆ°é˜Ÿä¼å°¾å·´ä¸Šä¹–ä¹–ç­‰ç€ã€‚ å¦‚æœä¸€ä¸ªç­‰å¾…è€…è·å–åˆ°äº†é”ï¼Œå¹¶ä¸”é‡åˆ°äº†ä¸‹é¢ä¸¤ç§æƒ…å†µä¹‹ä¸€ï¼Œå°±æ¢å¤æˆæ­£å¸¸å·¥ä½œæ¨¡å¼ã€‚æƒ…å†µ1ï¼šå®ƒæ˜¯æœ€åä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„ç­‰å¾…è€…ã€‚æƒ…å†µ2ï¼šå®ƒç­‰å¾…çš„æ—¶é—´å°äº1ms æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œå³ä½¿æœ‰å¾ˆå¤šé˜»å¡çš„ç­‰å¾…è€…ï¼Œæœ‰æ›´å¥½çš„è¡¨ç°ï¼Œå› ä¸ºä¸€è½®èƒ½å¤šæ¬¡è·å¾—é”çš„æœºä¼šã€‚é¥¥é¥¿æ¨¡å¼æ˜¯ä¸ºäº†é¿å…é‚£äº›ä¸€ç›´åœ¨é˜Ÿå°¾çš„å€’éœ‰è›‹ã€‚/// æˆ‘çš„è¯ç®€å•æ€»ç»“å°±æ˜¯ï¼Œäº’æ–¥é”æœ‰ä¸¤ç§å·¥ä½œæ¨¡å¼ï¼Œç«äº‰æ¨¡å¼å’Œé˜Ÿåˆ—æ¨¡å¼ï¼Œç«äº‰å°±æ˜¯å¤§å®¶ä¸€èµ·æŠ¢ï¼Œé˜Ÿåˆ—å°±æ˜¯è€è€å®å®æ’é˜Ÿï¼Œè¿™ä¸¤ç§å·¥ä½œæ¨¡å¼ä¼šé€šè¿‡ä¸€äº›æƒ…å†µè¿›è¡Œåˆ‡æ¢ã€‚ é¦–å…ˆè¿˜æ˜¯æ¥çœ‹çœ‹å¤§ä½“ç»“æ„å¯ä»¥çœ‹åˆ°ï¼Œç›¸å¯¹è¯»å†™é”ï¼Œç»“æ„ä¸Šé¢å¾ˆç®€å•ï¼Œåªæœ‰ä¸¤ä¸ªå€¼ï¼Œä½†æ˜¯åƒä¸‡ä¸è¦å°ç§å®ƒï¼Œå‡å°‘äº†å­—æ®µå°±å¢åŠ äº†ç†è§£éš¾åº¦ã€‚stateï¼šå°†ä¸€ä¸ª32ä½æ•´æ•°æ‹†åˆ†ä¸ºï¼šå½“å‰é˜»å¡çš„goroutineæ•°(29ä½)é¥¥é¥¿çŠ¶æ€(1ä½ï¼Œ0ä¸ºæ­£å¸¸æ¨¡å¼ï¼›1ä¸ºé¥¥é¥¿æ¨¡å¼)å”¤é†’çŠ¶æ€(1ä½ï¼Œ0æœªå”¤é†’ï¼›1å·²å”¤é†’)é”çŠ¶æ€(1ä½ï¼Œ0å¯ç”¨ï¼›1å ç”¨) semaï¼šä¿¡å·é‡ æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯Lockå’ŒUnlockä¸¤ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªä¸Šé”ï¼Œä¸€ä¸ªè§£é”ï¼Œæ²¡å•¥å¥½è¯´çš„ã€‚ ä¸€ä¸ªæ–¹æ³•æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ªçš„è¦ç”¨åˆ°çš„æ–¹æ³• func CompareAndSwapInt32(addr *int32, old, new int32) (swapped bool)è¿™ä¸ªå‡½æ•°ï¼Œä¼šå…ˆåˆ¤æ–­å‚æ•°addræŒ‡å‘çš„è¢«æ“ä½œå€¼ä¸å‚æ•°oldçš„å€¼æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰ä¼šå°†å‚æ•°newæ›¿æ¢å‚æ•°addræ‰€æŒ‡å‘çš„å€¼ï¼Œä¸ç„¶çš„è¯å°±å•¥ä¹Ÿä¸åšã€‚éœ€è¦ç‰¹åˆ«è¯´æ˜çš„æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•å¹¶ä¸ä¼šé˜»å¡ã€‚ å‡ ä¸ªå¸¸é‡è¿™æ˜¯å®šä¹‰çš„å‡ ä¸ªå¸¸é‡ï¼Œæˆ‘ä»¬åœ¨ä¸€å¼€å§‹çš„æ³¨é‡Šå‘¨å›´å¯ä»¥çœ‹åˆ°ï¼Œåé¢éœ€è¦ç”¨åˆ°ï¼Œæš‚æ—¶è®°ä½å®ƒä»¬çš„åˆå§‹å€¼å°±å¥½ã€‚ mutexLocked = 1 &lt;&lt; iota // 1å·¦ç§»0ä½ï¼Œæ˜¯1ï¼ŒäºŒè¿›åˆ¶æ˜¯1ï¼Œï¼ˆ1è¡¨ç¤ºå·²ç»ä¸Šé”ï¼‰mutexWoken // 1å·¦ç§»1ä½ï¼Œæ˜¯2ï¼ŒäºŒè¿›åˆ¶æ˜¯10mutexStarving // 1å·¦ç§»2ä½ï¼Œæ˜¯4ï¼ŒäºŒè¿›åˆ¶æ˜¯100mutexWaiterShift = iota // å°±æ˜¯3ï¼Œ äºŒè¿›åˆ¶æ˜¯11 starvationThresholdNs = 1e6 // è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬ä¸€å¼€å§‹åœ¨æ³¨é‡Šé‡Œé¢çœ‹åˆ°çš„1msï¼Œä¸€å®šè¶…è¿‡è¿™ä¸ªé—¨é™å€¼å°±ä¼šæ›´æ¢æ¨¡å¼ Lockè·å–é”å› ä¸ºLockæ–¹æ³•æ¯”è¾ƒé•¿ï¼Œæ‰€ä»¥æˆ‘åˆ‡åˆ†ä¸€æ®µæ®µçœ‹ï¼Œéœ€è¦å®Œæ•´çš„è¯·è‡ªå·±ç¿»çœ‹æºç ã€‚è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œä¸€å®šè¦æ—¶åˆ»è®°ä½ï¼ŒLockæ–¹æ³•æ˜¯åšä»€ä¹ˆçš„ï¼Œå¾ˆç®€å•ï¼Œå°±æ˜¯è¦æŠ¢é”ã€‚çœ‹ä¸æ‡‚çš„æ—¶å€™æƒ³æƒ³è¿™ä¸ªç›®æ ‡ã€‚ç¬¬ä¸€æ­¥ï¼Œåˆ¤æ–­stateçŠ¶æ€æ˜¯å¦ä¸º0ï¼Œå¦‚æœä¸º0ï¼Œè¯æ˜æ²¡æœ‰åç¨‹æŒæœ‰é”ï¼Œé‚£ä¹ˆå°±å¾ˆç®€å•äº†ï¼Œç›´æ¥è·å–åˆ°é”ï¼Œå°†mutexLockedï¼ˆä¸º1ï¼‰èµ‹å€¼åˆ°stateå°±å¯ä»¥äº†ã€‚ çœ‹åé¢çš„æ–¹æ³•æ—¶ï¼Œå‘Šè¯‰éœ€è¦å‘Šè¯‰ä½ ä»¬ä¸€ä¸ªå°æŠ€å·§ï¼Œå½“é‡åˆ°è¿™ç§ä½æ“ä½œå¾ˆå¤šçš„æƒ…å†µï¼Œæœ‰ä¸¤ä¸ªæ–¹æ³•æŒºå¥½ç”¨ï¼Œå¯¹äºä½ çœ‹æºç ä¼šæœ‰å¸®åŠ©ï¼šç¬¬ä¸€ä¸ªæ˜¯å°†æ‰€æœ‰å®šå€¼å…ˆè®¡ç®—ï¼Œç„¶ååˆ¤æ–­éå®šå€¼çš„æƒ…å†µï¼›ç¬¬äºŒä¸ªæ˜¯å°†æ‰€æœ‰çš„è®¡ç®—å†™ä¸‹æ¥ï¼Œè‡ªå·±ç”¨ç¬”å»è®¡ç®—ï¼Œä¸è¦æ‰§ç€äºæ‰“å­—ã€‚ ç„¶åæˆ‘ä»¬ä»¥ä¸‹é¢è¿™ä¸ªæ®µä¸¾ä¾‹ï¼šé¦–å…ˆï¼Œçœ‹æ³¨é‡Šåº”è¯¥èƒ½æ˜ç™½è¿™ä¸€æ®µå¤§è‡´æ„æ€æ˜¯ï¼Œå¦‚æœä¸æ˜¯é¥¥é¥¿æ¨¡å¼ï¼Œå°±ä¼šè¿›è¡Œè‡ªæ—‹æ“ä½œï¼Œç„¶åä¸æ–­å¾ªç¯ã€‚ ç„¶åæ ¹æ®ä¸Šé¢çš„æŠ€å·§ï¼Œold&amp;(mutexLocked|mutexStarving) == mutexLockedï¼ˆä¸‹é¢å‡ä¸ºäºŒè¿›åˆ¶ï¼‰mutexLocked = 1mutexStarving = 11mutexLocked = 1è¿™ä¸‰ä¸ªæ˜¯å®šå€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬å®¹æ˜“å¾—åˆ°ï¼Œæ»¡è¶³æƒ…å†µçš„ç»“æœä¸ºï¼Œå½“oldä¸ºxxxx0xxï¼ˆäºŒè¿›åˆ¶ç¬¬ä¸‰ä½ä¸º0ï¼‰ç­‰å¼æˆç«‹ã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸€å¼€å§‹è¯´çš„ï¼Œstateçš„ç¬¬ä¸‰ä½æ˜¯è¡¨ç¤ºè¿™ä¸ªé”å½“å‰çš„æ¨¡å¼ï¼Œ0ä¸ºæ­£å¸¸æ¨¡å¼ï¼Œ1ä¸ºé¥¥é¥¿æ¨¡å¼ã€‚ é‚£ä¹ˆç¬¬ä¸€ä¸ªifå°±è¡¨ç¤ºï¼Œå¦‚æœå½“å‰æ¨¡å¼ä¸ºæ­£å¸¸æ¨¡å¼ï¼Œä¸”å¯ä»¥è‡ªæ—‹ï¼Œå°±è¿›å…¥ifæ¡ä»¶å†…éƒ¨ã€‚if !awoke &amp;&amp; old&amp;mutexWoken == 0 &amp;&amp; old&gt;&gt;mutexWaiterShift != 0 &amp;&amp; åŒæ ·çš„åˆ†æï¼Œawokeè¡¨ç¤ºæ˜¯å¦å”¤é†’ï¼Œold&amp;mutexWokenæ˜¯å–ç¬¬äºŒä½ï¼Œ0è¡¨ç¤ºå½“å‰åç¨‹æœªè¢«å”¤é†’ï¼Œold&gt;&gt;mutexWaiterShiftè¡¨ç¤ºå³ç§»3ä½ï¼Œä¹Ÿå°±æ˜¯å‰29ä½ï¼Œä¸ä¸º0è¯æ˜æœ‰åç¨‹åœ¨ç­‰å¾…ï¼Œå¹¶ä¸”å°è¯•å»å¯¹æ¯”å½“å‰m.stateä¸å–å‡ºæ—¶çš„oldçŠ¶æ€ï¼Œå°è¯•å»å”¤é†’è‡ªå·±ã€‚ç„¶åè‡ªæ—‹ï¼Œå¹¶ä¸”å¢åŠ è‡ªæ—‹æ¬¡æ•°è¡¨ç¤ºiterï¼Œç„¶åé‡æ–°èµ‹å€¼oldã€‚å†å¾ªç¯ä¸‹ä¸€æ¬¡ã€‚ ï¼ˆä½ è‡ªå·±ç†ä¸€ç†ï¼Œç¡®å®æœ‰ç‚¹ç»•ï¼Œä»”ç»†æƒ³æƒ³å°±æƒ³é€šäº†å°±å¯¹äº†ã€‚ï¼‰ ä»¥ä¸Šæ˜¯ä½¿ç”¨è‡ªæ—‹çš„æƒ…å†µï¼Œå°±æ˜¯canSpinçš„ã€‚ ç„¶åè¿›è¡Œåˆ¤æ–­old&amp;mutexStarving == 0å°±æ˜¯ç¬¬ä¸‰ä½ä¸º0çš„æƒ…å†µï¼Œè¿˜æ˜¯æ‰€è¯´çš„æ­£å¸¸æ¨¡å¼ã€‚newå°±é©¬ä¸Šæ‹¿åˆ°é”äº†ï¼Œnew |= mutexLockedï¼Œè¡¨ç¤ºæˆ–1ï¼Œå°±æ˜¯ç¬¬ä¸€ä½æ— è®ºæ˜¯å•¥éƒ½èµ‹å€¼ä¸º1 old&amp;(mutexLocked|mutexStarving)ï¼Œä¹Ÿå°±æ˜¯old &amp; 0101å¿…é¡»å½“oldçš„1å’Œ3ä¸¤ä¸ªä½ç½®ä¸º1çš„æ—¶å€™æ‰æ˜¯trueï¼Œä¹Ÿå°±æ˜¯è¯´å½“å‰å¤„äºé¥¥é¥¿æ¨¡å¼ï¼Œå¹¶ä¸”é”å·²ç»è¢«å ç”¨çš„æƒ…å†µï¼Œé‚£ä¹ˆå°±éœ€è¦æ’é˜Ÿå»ã€‚æ’é˜Ÿä¹Ÿå¾ˆç²¾å¦™ï¼Œnew += 1 &lt;&lt; mutexWaiterShiftè¿™è¾¹æ³¨æ„æ˜¯å…ˆè®¡ç®—1 &lt;&lt; mutexWaiterShiftä¹Ÿå°±æ˜¯å°†newçš„å‰29ä½+1ï¼Œå°±æ˜¯è¡¨ç¤ºæœ‰ä¸€ä¸ªåç¨‹åœ¨ç­‰å¾…äº†ã€‚ å¥½äº†åˆ°è¿™é‡Œä½ çš„ä½æ“ä½œåº”è¯¥å°±ä¹ æƒ¯çš„å·®ä¸å¤šäº†ï¼Œä¹‹åæˆ‘å°±ç›´æ¥è¯´ç»“è®ºï¼Œä¸ä»”ç»†çš„å¸®ä½ 01è¡¨ç¤ºäº†ï¼Œä½ å·²ç»é•¿å¤§äº†ï¼Œè¦å­¦ä¼šè‡ªå·±åŠ¨æ‰‹äº†ã€‚ å¦‚æœå½“å‰å·²ç»æ ‡è®°ä¸ºé¥¥é¥¿æ¨¡å¼ï¼Œå¹¶ä¸”æ²¡æœ‰é”ä½ï¼Œé‚£ä¹ˆè®¾ç½®newä¸ºé¥¥é¥¿æ¨¡å¼if starving &amp;&amp; old&amp;mutexLocked != 0 { new |= mutexStarving} å¦‚æœå”¤é†’ï¼Œéœ€è¦åœ¨ä¸¤ç§æƒ…å†µä¸‹é‡è®¾æ ‡å¿—if awoke { å¦‚æœå”¤é†’æ ‡å¿—ä¸ºä¸awokeä¸ç›¸åè°ƒå°±panic if new&amp;mutexWoken == 0 { throw(â€œsync: inconsistent mutex stateâ€) } è®¾ç½®å”¤é†’çŠ¶æ€ä½0,è¢«å”¤é†’ new &amp;^= mutexWoken} å¦‚æœè·å–é”æˆåŠŸ old&amp;(mutexLocked|mutexStarving) == 0æˆç«‹è¡¨ç¤ºå·²ç»è·å–é”ï¼Œå°±ç›´æ¥é€€å‡ºCAS ä¸­é—´è¿™ä¸€æ®µæˆ‘å°±ä¸å¤šè§£é‡Šäº†ï¼Œå°±æ˜¯æœ€å‰é¢æ³¨é‡Šè¯´çš„ï¼Œæ»¡è¶³ä»€ä¹ˆæ¡ä»¶è½¬æ¢ä»€ä¹ˆæ¨¡å¼ï¼Œä¸å¤šè¯´äº†ã€‚ç„¶åä»é˜Ÿåˆ—ä¸­ï¼Œä¹Ÿå°±æ˜¯å‰29ä½-1ã€‚éœ€è¦æ³¨æ„å…¶ä¸­æœ‰ä¸€ä¸ªruntime_SemacquireMutexå’Œä¹‹å‰çœ‹çš„çš„runtime_Semacquireæ˜¯ä¸€ä¸ªæ„æ€ï¼Œåªæ˜¯å¤šäº†ä¸€ä¸ªå‚æ•°ã€‚è¿™ä¸ªå°±æ˜¯è¿™ä¸ªæ–¹æ³•çš„æ³¨é‡Šã€‚å¯ä»¥çœ‹åˆ°ï¼Œå°±æ˜¯å¤šäº†ä¸ªé˜Ÿåˆ—å»æ’é˜Ÿã€‚ å¦‚æœè·å–é”å¤±è´¥ï¼Œoldåˆ·æ–°çŠ¶æ€å†æ¬¡å¾ªç¯ï¼Œç»§ç»­cas UnLocké‡Šæ”¾é” Unlockå°±ç›¸å¯¹ç®€å•ä¸€äº›ï¼Œç«æ€åˆ†æä¸çœ‹ã€‚å…¶å®æˆ‘ä»¬è‡ªå·±æƒ³ä¹Ÿèƒ½æƒ³åˆ°ï¼Œunlockå°±æ˜¯å°†æ ‡è¯†ä½æ”¹å›æ¥å˜›ã€‚ç„¶åå› ä¸ºæˆ‘ä»¬å·²ç»çœ‹è¿‡è¯»å†™é”äº†ï¼Œä¹Ÿæ˜¯åŒæ ·çš„é“ç†ï¼Œå¦‚æœæ²¡æœ‰ä¸Šé”å°±ç›´æ¥è§£é”ï¼Œé‚£è‚¯å®šæŠ¥é”™å˜›ã€‚ ç„¶åå¦‚æœæ˜¯æ­£å¸¸æ¨¡å¼ï¼Œå¦‚æœæ²¡æœ‰ç­‰å¾…çš„goroutineæˆ–goroutineå·²ç»è§£é”å®Œæˆçš„æƒ…å†µå°±ç›´æ¥è¿”å›äº†ã€‚å¦‚æœæœ‰ç­‰å¾…çš„goroutineé‚£å°±é€šè¿‡ä¿¡å·é‡å»å”¤é†’runtime_Semreleaseï¼ˆæ³¨æ„è¿™é‡Œæ˜¯falseï¼‰ï¼ŒåŒæ—¶æ“ä½œä¸€ä¸‹é˜Ÿåˆ—-1 å¦‚æœæ˜¯é¥¥é¥¿æ¨¡å¼å°±ç›´æ¥å”¤é†’ï¼ˆæ³¨æ„è¿™é‡Œæ˜¯trueï¼‰ï¼Œåæ­£æœ‰é˜Ÿåˆ—å˜›ã€‚ äº’æ–¥é”æ€»ç»“å…¶å®è¯è¯´å›æ¥ï¼Œæˆ‘ä»¬å…¶å®çœ‹èµ·æ¥ä¹Ÿç®€å•ï¼Œæ²¡æœ‰å†²çªçš„æƒ…å†µä¸‹ï¼Œèƒ½æ‹¿å°±æ‹¿å‘—ï¼Œå¦‚æœå‡ºç°å†²çªäº†å°±å°è¯•è‡ªæ—‹è§£å†³ï¼ˆè‡ªæ—‹ä¸€èˆ¬éƒ½èƒ½è§£å†³ï¼‰å¦‚æœè§£å†³ä¸äº†å°±é€šè¿‡ä¿¡å·é‡è§£å†³ï¼ŒåŒæ—¶å¦‚æœæ­£å¸¸æ¨¡å¼å°±æ˜¯æˆ‘ä»¬è¯´çš„æŠ¢å å¼ï¼Œéå…¬å¹³ï¼Œå¦‚æœæ˜¯é¥¥é¥¿æ¨¡å¼ï¼Œå°±æ˜¯æˆ‘ä»¬è¯´çš„æ’é˜Ÿï¼Œå…¬å¹³ï¼Œé˜²æ­¢æœ‰ä¸€äº›å€’éœ‰è›‹ä¸€ç›´æŠ¢ä¸åˆ°ã€‚ æ•´ä½“æ€»ç»“ä¸€ä¸‹ï¼Œçœ‹å®Œæºç æˆ‘ä»¬å‘ç°ï¼Œå…¶å®é”çš„è®¾è®¡å¹¶ä¸å¤æ‚ï¼Œä¸»è¦è®¾è®¡æˆ‘ä»¬è¦å­¦åˆ°caså’Œå¤„ç†è¯»å†™çŠ¶æ€çš„ä¿¡å·é‡é€šçŸ¥ï¼Œå¯¹äºé‚£äº›ä½æ“ä½œï¼Œèƒ½çœ‹æ‡‚ï¼Œå­¦å¯èƒ½ä¸€æ—¶åŠä¼šå­¦ä¸ä¼šï¼Œå› ä¸ºå¾ˆéš¾åœ¨ä¸€å¼€å§‹å°±è®¾è®¡çš„é‚£ä¹ˆå·§å¦™ï¼Œä½ ä¹Ÿä½“ä¼šåˆ°äº†åªç”¨ä¸€ä¸ªå˜é‡å°±ç»´æŠ¤äº†æ•´ä¸ªä½“ç³»æ˜¯ä¸€ç§è‰ºæœ¯ã€‚]]></content>
      <categories>
        <category>golangæºç è§£æ</category>
      </categories>
      <tags>
        <tag>RWMutex</tag>
        <tag>Mutex</tag>
      </tags>
  </entry>
</search>
